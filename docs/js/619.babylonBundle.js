"use strict";(self.webpackChunkbabylonjs_typescript_webpack_template=self.webpackChunkbabylonjs_typescript_webpack_template||[]).push([[619],{66133:(e,t,i)=>{var s,n,r,a,o,h,l;i.d(t,{$i:()=>h,D_:()=>l,FP:()=>r,Fz:()=>n,V7:()=>a,Yi:()=>s,s2:()=>o}),function(e){e[e.Generic=0]="Generic",e[e.Keyboard=1]="Keyboard",e[e.Mouse=2]="Mouse",e[e.Touch=3]="Touch",e[e.DualShock=4]="DualShock",e[e.Xbox=5]="Xbox",e[e.Switch=6]="Switch",e[e.DualSense=7]="DualSense"}(s||(s={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.Move=12]="Move"}(n||(n={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.DeltaHorizontal=10]="DeltaHorizontal",e[e.DeltaVertical=11]="DeltaVertical"}(r||(r={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(a||(a={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Create=8]="Create",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(o||(o={})),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.LT=6]="LT",e[e.RT=7]="RT",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.LStickXAxis=17]="LStickXAxis",e[e.LStickYAxis=18]="LStickYAxis",e[e.RStickXAxis=19]="RStickXAxis",e[e.RStickYAxis=20]="RStickYAxis"}(h||(h={})),function(e){e[e.B=0]="B",e[e.A=1]="A",e[e.Y=2]="Y",e[e.X=3]="X",e[e.L=4]="L",e[e.R=5]="R",e[e.ZL=6]="ZL",e[e.ZR=7]="ZR",e[e.Minus=8]="Minus",e[e.Plus=9]="Plus",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.Capture=17]="Capture",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(l||(l={}))},84316:(e,t,i)=>{i.d(t,{W:()=>d});var s=i(66133),n=i(96485);class r{static CreateDeviceEvent(e,t,i,n,r,a,o){switch(e){case s.Yi.Keyboard:return this._CreateKeyboardEvent(i,n,r,a);case s.Yi.Mouse:if(i===s.Fz.MouseWheelX||i===s.Fz.MouseWheelY||i===s.Fz.MouseWheelZ)return this._CreateWheelEvent(e,t,i,n,r,a);case s.Yi.Touch:return this._CreatePointerEvent(e,t,i,n,r,a,o);default:throw`Unable to generate event for device ${s.Yi[e]}`}}static _CreatePointerEvent(e,t,i,n,r,a,o){const h=this._CreateMouseEvent(e,t,i,n,r,a);e===s.Yi.Mouse?(h.deviceType=s.Yi.Mouse,h.pointerId=1,h.pointerType="mouse"):(h.deviceType=s.Yi.Touch,h.pointerId=null!=o?o:t,h.pointerType="touch");let l=0;return l+=r.pollInput(e,t,s.Fz.LeftClick),l+=2*r.pollInput(e,t,s.Fz.RightClick),l+=4*r.pollInput(e,t,s.Fz.MiddleClick),h.buttons=l,i===s.Fz.Move?h.type="pointermove":i>=s.Fz.LeftClick&&i<=s.Fz.RightClick&&(h.type=1===n?"pointerdown":"pointerup",h.button=i-2),h}static _CreateWheelEvent(e,t,i,r,a,o){const h=this._CreateMouseEvent(e,t,i,r,a,o);switch(h.pointerId=1,h.type="wheel",h.deltaMode=n.G.DOM_DELTA_PIXEL,h.deltaX=0,h.deltaY=0,h.deltaZ=0,i){case s.Fz.MouseWheelX:h.deltaX=r;break;case s.Fz.MouseWheelY:h.deltaY=r;break;case s.Fz.MouseWheelZ:h.deltaZ=r}return h}static _CreateMouseEvent(e,t,i,n,r,a){const o=this._CreateEvent(a),h=r.pollInput(e,t,s.Fz.Horizontal),l=r.pollInput(e,t,s.Fz.Vertical);return a?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-a.getBoundingClientRect().x,o.offsetY=o.movementY-a.getBoundingClientRect().y):(o.movementX=r.pollInput(e,t,s.FP.DeltaHorizontal),o.movementY=r.pollInput(e,t,s.FP.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,r),o.clientX=h,o.clientY=l,o.x=h,o.y=l,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,n){const r=this._CreateEvent(n);return this._CheckNonCharacterKeys(r,i),r.deviceType=s.Yi.Keyboard,r.deviceSlot=0,r.inputIndex=e,r.type=1===t?"keydown":"keyup",r.key=String.fromCharCode(e),r.keyCode=e,r}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(s.Yi.Keyboard),n=i&&1===t.pollInput(s.Yi.Keyboard,0,18),r=i&&1===t.pollInput(s.Yi.Keyboard,0,17),a=i&&(1===t.pollInput(s.Yi.Keyboard,0,91)||1===t.pollInput(s.Yi.Keyboard,0,92)||1===t.pollInput(s.Yi.Keyboard,0,93)),o=i&&1===t.pollInput(s.Yi.Keyboard,0,16);e.altKey=n,e.ctrlKey=r,e.metaKey=a,e.shiftKey=o}static _CreateEvent(e){const t={preventDefault:()=>{}};return t.target=e,t}}class a{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,((e,t,s,n)=>{const a=r.CreateDeviceEvent(e,t,s,n,this);i(e,t,a)})):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===s.Yi.Mouse||e===s.Yi.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}var o=i(60103),h=i(14651);const l=Object.keys(s.Fz).length/2;class u{constructor(e,t,i,s){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=h.w1.IsSafari(),this._usingMacOS=(0,o.up)()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=e=>{},this._keyboardUpEvent=e=>{},this._keyboardBlurEvent=e=>{},this._pointerMoveEvent=e=>{},this._pointerDownEvent=e=>{},this._pointerUpEvent=e=>{},this._pointerCancelEvent=e=>{},this._pointerWheelEvent=e=>{},this._pointerBlurEvent=e=>{},this._pointerMacOSChromeOutEvent=e=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=(0,o.up)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._isUsingChromium=(0,o.up)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Chrome"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=e=>{},this._gamepadDisconnectedEvent=e=>{},this._eventPrefix=h.w1.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=s,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const n=this._inputs[e][t];if(!n)throw`Unable to find device ${s.Yi[e]}`;e>=s.Yi.DualShock&&e<=s.Yi.DualSense&&this._updateDevice(e,t,i);const r=n[i];if(void 0===r)throw`Unable to find input ${i} for device ${s.Yi[e]} in slot ${t}`;return i===s.Fz.Move&&h.w1.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),r}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=null==this?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(const e of this._inputs)if(e)for(const t in e){const i=e[+t];if(i)for(let e=0;e<i.length;e++)i[e]=0}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOS&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(s.Yi.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,s){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,l);const n=this._inputs[e][t];n[0]=i,n[1]=s}_registerDevice(e,t,i){if(void 0===t)throw`Unable to register device ${s.Yi[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const s=new Array(i);s.fill(0),this._inputs[e][t]=s,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(s.Yi.Keyboard,0,255));const t=this._inputs[s.Yi.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&"Meta"!==e.key&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(s.Yi.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(s.Yi.Keyboard,0,255));const t=this._inputs[s.Yi.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&"Meta"===e.key&&this._metaKeys.length>0){for(const e of this._metaKeys){const i=r.CreateDeviceEvent(s.Yi.Keyboard,0,e,0,this,this._elementToAttachTo);t[e]=0,this._onInputChanged(s.Yi.Keyboard,0,i)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(s.Yi.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[s.Yi.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;const i=r.CreateDeviceEvent(s.Yi.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(s.Yi.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=(0,o.up)()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let e=0;e<this._maxTouchPoints;e++)this._activeTouchIds[e]=-1;this._pointerMoveEvent=e=>{const t=this._getPointerType(e);let i=t===s.Yi.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===s.Yi.Touch&&-1===i){const s=this._activeTouchIds.indexOf(-1);if(!(s>=0))return void h.w1.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=s,this._activeTouchIds[s]=e.pointerId,this._onDeviceConnected(t,i)}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]||this._addPointerDevice(t,i,e.clientX,e.clientY);const n=this._inputs[t][i];if(n){const r=e;r.inputIndex=s.Fz.Move,n[s.Fz.Horizontal]=e.clientX,n[s.Fz.Vertical]=e.clientY,t===s.Yi.Touch&&0===n[s.Fz.LeftClick]&&(n[s.Fz.LeftClick]=1),void 0===e.pointerId&&(e.pointerId=this._mouseId),this._onInputChanged(t,i,r),this._usingSafari||-1===e.button||(r.inputIndex=e.button+2,n[e.button+2]=n[e.button+2]?0:1,this._onInputChanged(t,i,r))}},this._pointerDownEvent=e=>{const t=this._getPointerType(e);let i=t===s.Yi.Mouse?0:e.pointerId;if(t===s.Yi.Touch){const t=this._activeTouchIds.indexOf(-1);if(!(t>=0))return void h.w1.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=t,this._activeTouchIds[t]=e.pointerId}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]?t===s.Yi.Touch&&this._onDeviceConnected(t,i):this._addPointerDevice(t,i,e.clientX,e.clientY);const n=this._inputs[t][i];if(n){const r=n[s.Fz.Horizontal],a=n[s.Fz.Vertical];if(t===s.Yi.Mouse){if(void 0===e.pointerId&&(e.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch(e){}}else if(e.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(e.pointerId)}catch(e){}n[s.Fz.Horizontal]=e.clientX,n[s.Fz.Vertical]=e.clientY,n[e.button+2]=1;const o=e;o.inputIndex=e.button+2,this._onInputChanged(t,i,o),r===e.clientX&&a===e.clientY||(o.inputIndex=s.Fz.Move,this._onInputChanged(t,i,o))}},this._pointerUpEvent=e=>{var t,i,n,r,a;const o=this._getPointerType(e),h=o===s.Yi.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(o===s.Yi.Touch){if(-1===h)return;this._activeTouchIds[h]=-1}const l=null===(t=this._inputs[o])||void 0===t?void 0:t[h];if(l&&0!==l[e.button+2]){const t=l[s.Fz.Horizontal],u=l[s.Fz.Vertical];l[s.Fz.Horizontal]=e.clientX,l[s.Fz.Vertical]=e.clientY,l[e.button+2]=0;const c=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),t===e.clientX&&u===e.clientY||(c.inputIndex=s.Fz.Move,this._onInputChanged(o,h,c)),c.inputIndex=e.button+2,o===s.Yi.Mouse&&this._mouseId>=0&&(null===(n=(i=this._elementToAttachTo).hasPointerCapture)||void 0===n?void 0:n.call(i,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):e.pointerId&&(null===(a=(r=this._elementToAttachTo).hasPointerCapture)||void 0===a?void 0:a.call(r,e.pointerId))&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._onInputChanged(o,h,c),o===s.Yi.Touch&&this._onDeviceDisconnected(o,h)}},this._pointerCancelEvent=e=>{var t,i,n,a;if("mouse"===e.pointerType){const e=this._inputs[s.Yi.Mouse][0];this._mouseId>=0&&(null===(i=(t=this._elementToAttachTo).hasPointerCapture)||void 0===i?void 0:i.call(t,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=s.Fz.LeftClick;t<=s.Fz.BrowserForward;t++)if(1===e[t]){e[t]=0;const i=r.CreateDeviceEvent(s.Yi.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(s.Yi.Mouse,0,i)}}else{const t=this._activeTouchIds.indexOf(e.pointerId);if(-1===t)return;(null===(a=(n=this._elementToAttachTo).hasPointerCapture)||void 0===a?void 0:a.call(n,e.pointerId))&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._inputs[s.Yi.Touch][t][s.Fz.LeftClick]=0;const i=r.CreateDeviceEvent(s.Yi.Touch,t,s.Fz.LeftClick,0,this,this._elementToAttachTo,e.pointerId);this._onInputChanged(s.Yi.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(s.Yi.Touch,t)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch(e){}this._pointerBlurEvent=()=>{var e,t,i,n,a;if(this.isDeviceAvailable(s.Yi.Mouse)){const i=this._inputs[s.Yi.Mouse][0];this._mouseId>=0&&(null===(t=(e=this._elementToAttachTo).hasPointerCapture)||void 0===t?void 0:t.call(e,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let e=s.Fz.LeftClick;e<=s.Fz.BrowserForward;e++)if(1===i[e]){i[e]=0;const t=r.CreateDeviceEvent(s.Yi.Mouse,0,e,0,this,this._elementToAttachTo);this._onInputChanged(s.Yi.Mouse,0,t)}}if(this.isDeviceAvailable(s.Yi.Touch)){const e=this._inputs[s.Yi.Touch];for(let t=0;t<this._activeTouchIds.length;t++){const o=this._activeTouchIds[t];if((null===(n=(i=this._elementToAttachTo).hasPointerCapture)||void 0===n?void 0:n.call(i,o))&&this._elementToAttachTo.releasePointerCapture(o),-1!==o&&1===(null===(a=e[t])||void 0===a?void 0:a[s.Fz.LeftClick])){e[t][s.Fz.LeftClick]=0;const i=r.CreateDeviceEvent(s.Yi.Touch,t,s.Fz.LeftClick,0,this,this._elementToAttachTo,o);this._onInputChanged(s.Yi.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(s.Yi.Touch,t)}}}},this._pointerWheelEvent=e=>{const t=s.Yi.Mouse;this._inputs[t]||(this._inputs[t]=[]),this._inputs[t][0]||(this._pointerActive=!0,this._registerDevice(t,0,l));const i=this._inputs[t][0];if(i){i[s.Fz.MouseWheelX]=e.deltaX||0,i[s.Fz.MouseWheelY]=e.deltaY||e.wheelDelta||0,i[s.Fz.MouseWheelZ]=e.deltaZ||0;const n=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),0!==i[s.Fz.MouseWheelX]&&(n.inputIndex=s.Fz.MouseWheelX,this._onInputChanged(t,0,n)),0!==i[s.Fz.MouseWheelY]&&(n.inputIndex=s.Fz.MouseWheelY,this._onInputChanged(t,0,n)),0!==i[s.Fz.MouseWheelZ]&&(n.inputIndex=s.Fz.MouseWheelZ,this._onInputChanged(t,0,n))}},this._usingMacOS&&this._isUsingChromium&&(this._pointerMacOSChromeOutEvent=e=>{e.buttons>1&&this._pointerCancelEvent(e)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add((()=>{if(this.isDeviceAvailable(s.Yi.Mouse)){const e=this._inputs[s.Yi.Mouse][0];e[s.Fz.MouseWheelX]=0,e[s.Fz.MouseWheelY]=0,e[s.Fz.MouseWheelZ]=0}}))}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const s=navigator.getGamepads()[t];if(s&&e===this._gamepads[t]){const n=this._inputs[e][t];i>=s.buttons.length?n[i]=s.axes[i-s.buttons.length].valueOf():n[i]=s.buttons[i].value}}_getGamepadDeviceType(e){return-1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?s.Yi.DualSense:s.Yi.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?s.Yi.Xbox:-1!==e.indexOf("057e")?s.Yi.Switch:s.Yi.Generic}_getPointerType(e){let t=s.Yi.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=s.Yi.Touch),t}}var c=i(8158);class d{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=e=>{for(let t=0;t<this._devices.length;t++){const i=this._devices[t];for(const s in i){const i=+s;e._addDevice(new c.p(this._deviceInputSystem,t,i))}}this._registeredManagers.push(e)},this.unregisterManager=e=>{const t=this._registeredManagers.indexOf(e);t>-1&&this._registeredManagers.splice(t,1)};const t=Object.keys(s.Yi).length/2;this._devices=new Array(t);const i=(e,t)=>{this._devices[e]||(this._devices[e]=new Array),this._devices[e][t]||(this._devices[e][t]=t);for(const i of this._registeredManagers){const s=new c.p(this._deviceInputSystem,e,t);i._addDevice(s)}},n=(e,t)=>{var i;(null===(i=this._devices[e])||void 0===i?void 0:i[t])&&delete this._devices[e][t];for(const i of this._registeredManagers)i._removeDevice(e,t)},r=(e,t,i)=>{if(i)for(const s of this._registeredManagers)s._onInputChanged(e,t,i)};"undefined"!=typeof _native?this._deviceInputSystem=new a(i,n,r):this._deviceInputSystem=new u(e,i,n,r)}dispose(){this._deviceInputSystem.dispose()}}},96485:(e,t,i)=>{var s;i.d(t,{G:()=>n,g:()=>s}),function(e){e[e.PointerMove=0]="PointerMove",e[e.PointerDown=1]="PointerDown",e[e.PointerUp=2]="PointerUp"}(s||(s={}));class n{}n.DOM_DELTA_PIXEL=0,n.DOM_DELTA_LINE=1,n.DOM_DELTA_PAGE=2},50147:(e,t,i)=>{i.d(t,{CU:()=>r,FV:()=>a,R5:()=>o,kD:()=>n});var s=i(90972);class n{}n.POINTERDOWN=1,n.POINTERUP=2,n.POINTERMOVE=4,n.POINTERWHEEL=8,n.POINTERPICK=16,n.POINTERTAP=32,n.POINTERDOUBLETAP=64;class r{constructor(e,t){this.type=e,this.event=t}}class a extends r{constructor(e,t,i,n){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new s.FM(i,n)}}class o extends r{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,s=null){super(e,t),this._pickInfo=i,this._inputManager=s}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}},47192:(e,t,i)=>{i.d(t,{G:()=>u,p:()=>c});var s=i(13555),n=i(79061),r=i(96786),a=i(53243),o=i(96721),h=i(63478),l=i(66794);class u extends h.H{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class c extends l.n{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DetailMap",140,new u,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=n.F.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&a.k.DetailTextureEnabled&&!this._texture.isReady())}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&a.k.DetailTextureEnabled&&this._isEnabled?(o.G.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||this._texture&&a.k.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),o.G.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&a.k.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&(null===(t=this._texture)||void 0===t||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}(0,s.gn)([(0,r.oU)("detailTexture"),(0,r.wz)("_markAllSubMeshesAsTexturesDirty")],c.prototype,"texture",void 0),(0,s.gn)([(0,r.qC)()],c.prototype,"diffuseBlendLevel",void 0),(0,s.gn)([(0,r.qC)()],c.prototype,"roughnessBlendLevel",void 0),(0,s.gn)([(0,r.qC)()],c.prototype,"bumpLevel",void 0),(0,s.gn)([(0,r.qC)(),(0,r.wz)("_markAllSubMeshesAsTexturesDirty")],c.prototype,"normalBlendMethod",void 0),(0,s.gn)([(0,r.qC)(),(0,r.wz)("_markAllSubMeshesAsTexturesDirty")],c.prototype,"isEnabled",void 0)},29894:(e,t,i)=>{i.d(t,{BK:()=>u,Dh:()=>g,jD:()=>p,rs:()=>_});var s=i(79061),n=i(36261),r=i(40078),a=i(3860),o=i(24293),h=i(43127);const l=new RegExp("^([gimus]+)!");class u{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e.name)return!1;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const t=e.getClassName();u._MaterialPluginClassToMainDefine[t]||(u._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++u._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(e),this._plugins.sort(((e,t)=>e.priority-t.priority)),this._codeInjectionPoints={};const i={};i[u._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const e of this._plugins)e.collectDefines(i),this._collectPointNames("vertex",e.getCustomCode("vertex")),this._collectPointNames("fragment",e.getCustomCode("fragment"));return this._defineNamesFromPlugins=i,!0}_activatePlugin(e){-1===this._activePlugins.indexOf(e)&&(this._activePlugins.push(e),this._activePlugins.sort(((e,t)=>e.priority-t.priority)),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort(((e,t)=>e.priority-t.priority)),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const e of this._activePluginsForExtraEvents)if(t=e.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){var i;switch(e){case n.S.GetActiveTextures:{const e=t;for(const t of this._activePlugins)t.getActiveTextures(e.activeTextures);break}case n.S.GetAnimatables:{const e=t;for(const t of this._activePlugins)t.getAnimatables(e.animatables);break}case n.S.HasTexture:{const e=t;let i=!1;for(const t of this._activePlugins)if(i=t.hasTexture(e.texture),i)break;e.hasTexture=i;break}case n.S.Disposed:{const e=t;for(const t of this._plugins)t.dispose(e.forceDisposeTextures);break}case n.S.GetDefineNames:t.defineNames=this._defineNamesFromPlugins;break;case n.S.PrepareEffect:{const e=t;for(const t of this._activePlugins)e.fallbackRank=t.addFallbacks(e.defines,e.fallbacks,e.fallbackRank),t.getAttributes(e.attributes,this._scene,e.mesh);this._uniformList.length>0&&e.uniforms.push(...this._uniformList),this._samplerList.length>0&&e.samplers.push(...this._samplerList),this._uboList.length>0&&e.uniformBuffersNames.push(...this._uboList),e.customCode=this._injectCustomCode(e,e.customCode);break}case n.S.PrepareUniformBuffer:{const e=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(const t of this._plugins){const s=t.getUniforms();if(s){if(s.ubo)for(const t of s.ubo){if(t.size&&t.type){const s=null!==(i=t.arraySize)&&void 0!==i?i:0;e.ubo.addUniform(t.name,t.size,s),this._uboDeclaration+=`${t.type} ${t.name}${s>0?`[${s}]`:""};\n`}this._uniformList.push(t.name)}s.vertex&&(this._vertexDeclaration+=s.vertex+"\n"),s.fragment&&(this._fragmentDeclaration+=s.fragment+"\n")}t.getSamplers(this._samplerList),t.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e,t){return(i,s)=>{var n,r;t&&(s=t(i,s)),this._uboDeclaration&&(s=s.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(s=s.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(s=s.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const u=null===(n=this._codeInjectionPoints)||void 0===n?void 0:n[i];if(!u)return s;let c=null;for(let t in u){let n="";for(const s of this._activePlugins){let l=null===(r=s.getCustomCode(i))||void 0===r?void 0:r[t];if(l){if(s.resolveIncludes){if(null===c){const t=o.x.GLSL;c={defines:[],indexParameters:e.indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:h.v.GetShadersRepository(t),includesShadersStore:h.v.GetIncludesShadersStore(t),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0}}c.isFragment="fragment"===i,a.L._ProcessIncludes(l,c,(e=>l=e))}n+=l+"\n"}}if(n.length>0)if("!"===t.charAt(0)){t=t.substring(1);let e="g";if("!"===t.charAt(0))e="",t=t.substring(1);else{const i=l.exec(t);i&&i.length>=2&&(e=i[1],t=t.substring(e.length+1))}e.indexOf("g")<0&&(e+="g");const i=s,r=new RegExp(t,e);let a=r.exec(i);for(;null!==a;){let e=n;for(let t=0;t<a.length;++t)e=e.replace("$"+t,a[t]);s=s.replace(a[0],e),a=r.exec(i)}}else{const e="#define "+t;s=s.replace(e,"\n"+n+"\n"+e)}}return s}}}u._MaterialPluginClassToMainDefine={},u._MaterialPluginCounter=0,r.l.OnEnginesDisposedObservable.add((()=>{g()}));const c=[];let d=!1,f=null;function _(e,t){d||(f=s.F.OnEventObservable.add((e=>{for(const[,t]of c)t(e)}),n.S.Created),d=!0);const i=c.filter((([t,i])=>t===e));i.length>0?i[0][1]=t:c.push([e,t])}function p(e){for(let t=0;t<c.length;++t)if(c[t][0]===e)return c.splice(t,1),0===c.length&&g(),!0;return!1}function g(){c.length=0,d=!1,s.F.OnEventObservable.remove(f),f=null}},39268:(e,t,i)=>{i.d(t,{K:()=>A,R:()=>b});var s=i(13555),n=i(96786),r=i(42091),a=i(8714),o=i(90972),h=i(89859),l=i(37959),u=i(47922),c=i(97863),d=i(79061),f=i(36261),_=i(63478),p=i(80569),g=i(96721),m=i(84684),v=i(9827),I=i(53243),T=(i(98020),i(88595),i(43092)),M=i(47192),x=i(28981);const E={effect:null,subMesh:null};class b extends _.H{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class A extends p.a{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new h.Wo(0,0,0),this.diffuseColor=new h.Wo(1,1,1),this.specularColor=new h.Wo(1,1,1),this.emissiveColor=new h.Wo(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._renderTargets=new r.t(16),this._worldViewProjectionMatrix=o.y3.Zero(),this._globalAmbientColor=new h.Wo(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new M.p(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new u.o,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),A.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),A.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return!!(A.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||!!(A.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled)}needAlphaTesting(){return!!this._forceAlphaTest||this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===d.F.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==d.F.MATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(f.S.GetDefineNames,this._eventInfo),t.materialDefines=new b(this._eventInfo.defineNames));const s=this.getScene(),n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const r=s.getEngine();n._needNormals=g.G.PrepareDefinesForLights(s,e,n,!0,this._maxSimultaneousLights,this._disableLighting),g.G.PrepareDefinesForMultiview(s,n);const a=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(g.G.PrepareDefinesForPrePass(s,n,this.canRenderToMRT&&!a),g.G.PrepareDefinesForOIT(s,n,a),n._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,n._needUVs=!1;for(let e=1;e<=6;++e)n["MAINUV"+e]=!1;if(s.texturesEnabled){if(n.DIFFUSEDIRECTUV=0,n.BUMPDIRECTUV=0,n.AMBIENTDIRECTUV=0,n.OPACITYDIRECTUV=0,n.EMISSIVEDIRECTUV=0,n.SPECULARDIRECTUV=0,n.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&A.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;g.G.PrepareDefinesForMergedUV(this._diffuseTexture,n,"DIFFUSE")}else n.DIFFUSE=!1;if(this._ambientTexture&&A.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking())return!1;g.G.PrepareDefinesForMergedUV(this._ambientTexture,n,"AMBIENT")}else n.AMBIENT=!1;if(this._opacityTexture&&A.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking())return!1;g.G.PrepareDefinesForMergedUV(this._opacityTexture,n,"OPACITY"),n.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else n.OPACITY=!1;if(this._reflectionTexture&&A.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking())return!1;switch(n._needNormals=!0,n.REFLECTION=!0,n.ROUGHNESS=this._roughness>0,n.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,n.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===m.x.INVCUBIC_MODE,n.REFLECTIONMAP_3D=this._reflectionTexture.isCube,n.REFLECTIONMAP_OPPOSITEZ=n.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,n.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case m.x.EXPLICIT_MODE:n.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case m.x.PLANAR_MODE:n.setReflectionMode("REFLECTIONMAP_PLANAR");break;case m.x.PROJECTION_MODE:n.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case m.x.SKYBOX_MODE:n.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case m.x.SPHERICAL_MODE:n.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case m.x.EQUIRECTANGULAR_MODE:n.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case m.x.FIXED_EQUIRECTANGULAR_MODE:n.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case m.x.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:n.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case m.x.CUBIC_MODE:case m.x.INVCUBIC_MODE:default:n.setReflectionMode("REFLECTIONMAP_CUBIC")}n.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else n.REFLECTION=!1,n.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&A.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking())return!1;g.G.PrepareDefinesForMergedUV(this._emissiveTexture,n,"EMISSIVE")}else n.EMISSIVE=!1;if(this._lightmapTexture&&A.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking())return!1;g.G.PrepareDefinesForMergedUV(this._lightmapTexture,n,"LIGHTMAP"),n.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,n.RGBDLIGHTMAP=this._lightmapTexture.isRGBD}else n.LIGHTMAP=!1;if(this._specularTexture&&A.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking())return!1;g.G.PrepareDefinesForMergedUV(this._specularTexture,n,"SPECULAR"),n.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}else n.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&A.BumpTextureEnabled){if(!this._bumpTexture.isReady())return!1;g.G.PrepareDefinesForMergedUV(this._bumpTexture,n,"BUMP"),n.PARALLAX=this._useParallax,n.PARALLAXOCCLUSION=this._useParallaxOcclusion,n.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else n.BUMP=!1,n.PARALLAX=!1,n.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&A.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking())return!1;n._needUVs=!0,n.REFRACTION=!0,n.REFRACTIONMAP_3D=this._refractionTexture.isCube,n.RGBDREFRACTION=this._refractionTexture.isRGBD,n.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize}else n.REFRACTION=!1;n.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else n.DIFFUSE=!1,n.AMBIENT=!1,n.OPACITY=!1,n.REFLECTION=!1,n.EMISSIVE=!1,n.LIGHTMAP=!1,n.BUMP=!1,n.REFRACTION=!1;n.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),n.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,n.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,n.SPECULAROVERALPHA=this._useSpecularOverAlpha,n.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,n.ALPHATEST_AFTERALLALPHACOMPUTATIONS=null!==this.transparencyMode,n.ALPHABLEND=null===this.transparencyMode||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(n._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(n),n.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,n.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}n._areFresnelDirty&&(A.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(n.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,n.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,n.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,n.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,n.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,n.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,n._needNormals=!0,n.FRESNEL=!0):n.FRESNEL=!1),g.G.PrepareDefinesForMisc(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,n,this._applyDecalMapAfterDetailMap),g.G.PrepareDefinesForFrameBoundValues(s,r,this,n,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=n,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),g.G.PrepareDefinesForAttributes(e,n,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let o=!1;if(n.isDirty){const i=n._areLightsDisposed;n.markAsProcessed();const a=new T.L;n.REFLECTION&&a.addFallback(0,"REFLECTION"),n.SPECULAR&&a.addFallback(0,"SPECULAR"),n.BUMP&&a.addFallback(0,"BUMP"),n.PARALLAX&&a.addFallback(1,"PARALLAX"),n.PARALLAXOCCLUSION&&a.addFallback(0,"PARALLAXOCCLUSION"),n.SPECULAROVERALPHA&&a.addFallback(0,"SPECULAROVERALPHA"),n.FOG&&a.addFallback(1,"FOG"),n.POINTSIZE&&a.addFallback(0,"POINTSIZE"),n.LOGARITHMICDEPTH&&a.addFallback(0,"LOGARITHMICDEPTH"),g.G.HandleFallbacksForShadows(n,a,this._maxSimultaneousLights),n.SPECULARTERM&&a.addFallback(0,"SPECULARTERM"),n.DIFFUSEFRESNEL&&a.addFallback(1,"DIFFUSEFRESNEL"),n.OPACITYFRESNEL&&a.addFallback(2,"OPACITYFRESNEL"),n.REFLECTIONFRESNEL&&a.addFallback(3,"REFLECTIONFRESNEL"),n.EMISSIVEFRESNEL&&a.addFallback(4,"EMISSIVEFRESNEL"),n.FRESNEL&&a.addFallback(4,"FRESNEL"),n.MULTIVIEW&&a.addFallback(0,"MULTIVIEW");const h=[l.o.PositionKind];n.NORMAL&&h.push(l.o.NormalKind),n.TANGENT&&h.push(l.o.TangentKind);for(let e=1;e<=6;++e)n["UV"+e]&&h.push(`uv${1===e?"":e}`);n.VERTEXCOLOR&&h.push(l.o.ColorKind),g.G.PrepareAttributesForBones(h,e,n,a),g.G.PrepareAttributesForInstances(h,n),g.G.PrepareAttributesForMorphTargets(h,e,n),g.G.PrepareAttributesForBakedVertexAnimation(h,e,n);let d="default";const _=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],p=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],m=["Material","Scene","Mesh"],v={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=a,this._eventInfo.fallbackRank=0,this._eventInfo.defines=n,this._eventInfo.uniforms=_,this._eventInfo.attributes=h,this._eventInfo.samplers=p,this._eventInfo.uniformBuffersNames=m,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=v,this._callbackPluginEventGeneric(f.S.PrepareEffect,this._eventInfo),u.o.AddUniforms(_),u.o.AddSamplers(p),c.$&&(c.$.PrepareUniforms(_,n),c.$.PrepareSamplers(p,n)),g.G.PrepareUniformsAndSamplersList({uniformsNames:_,uniformBuffersNames:m,samplers:p,defines:n,maxSimultaneousLights:this._maxSimultaneousLights}),(0,x.qx)(_);const I={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,_,m,p,n,h,I));const M=n.toString(),b=t.effect;let A=s.getEngine().createEffect(d,{attributes:h,uniformsNames:_,uniformBuffersNames:m,samplers:p,defines:M,fallbacks:a,onCompiled:this.onCompiled,onError:this.onError,indexParameters:v,processFinalCode:I.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:n.PREPASS},r);if(this._eventInfo.customCode=void 0,A)if(this._onEffectCreatedObservable&&(E.effect=A,E.subMesh=t,this._onEffectCreatedObservable.notifyObservers(E)),this.allowShaderHotSwapping&&b&&!A.isReady()){if(A=b,n.markAsUnprocessed(),o=this.isFrozen,i)return n._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(A,n,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(n._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!o,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var s;const n=this.getScene(),r=i.materialDefines;if(!r)return;const o=i.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,n,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),r.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const l=o._forceRebindOnNextCall||this._mustRebind(n,o,t.visibility);g.G.BindBonesParameters(t,o);const u=this._uniformBuffer;if(l){if(this.bindViewProjection(o),!u.useUbo||!this.isFrozen||!u.isSync||o._forceRebindOnNextCall){if(A.FresnelEnabled&&r.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(u.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),u.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&u.updateColor4("opacityParts",new h.Wo(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(u.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),u.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(u.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),u.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(u.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),u.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),n.texturesEnabled){if(this._diffuseTexture&&A.DiffuseTextureEnabled&&(u.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),g.G.BindTextureMatrix(this._diffuseTexture,u,"diffuse")),this._ambientTexture&&A.AmbientTextureEnabled&&(u.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),g.G.BindTextureMatrix(this._ambientTexture,u,"ambient")),this._opacityTexture&&A.OpacityTextureEnabled&&(u.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),g.G.BindTextureMatrix(this._opacityTexture,u,"opacity")),this._hasAlphaChannel()&&u.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&A.ReflectionTextureEnabled&&(u.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),u.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const e=this._reflectionTexture;u.updateVector3("vReflectionPosition",e.boundingBoxPosition),u.updateVector3("vReflectionSize",e.boundingBoxSize)}if(this._emissiveTexture&&A.EmissiveTextureEnabled&&(u.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),g.G.BindTextureMatrix(this._emissiveTexture,u,"emissive")),this._lightmapTexture&&A.LightmapTextureEnabled&&(u.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),g.G.BindTextureMatrix(this._lightmapTexture,u,"lightmap")),this._specularTexture&&A.SpecularTextureEnabled&&(u.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),g.G.BindTextureMatrix(this._specularTexture,u,"specular")),this._bumpTexture&&n.getEngine().getCaps().standardDerivatives&&A.BumpTextureEnabled&&(u.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),g.G.BindTextureMatrix(this._bumpTexture,u,"bump"),n._mirroredCameraPosition?u.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):u.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&A.RefractionTextureEnabled){let e=1;if(this._refractionTexture.isCube||(u.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(e=this._refractionTexture.depth)),u.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,e,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const e=this._refractionTexture;u.updateVector3("vRefractionPosition",e.boundingBoxPosition),u.updateVector3("vRefractionSize",e.boundingBoxSize)}}}this.pointsCloud&&u.updateFloat("pointSize",this.pointSize),r.SPECULARTERM&&u.updateColor4("vSpecularColor",this.specularColor,this.specularPower),u.updateColor3("vEmissiveColor",A.EmissiveTextureEnabled?this.emissiveColor:h.Wo.BlackReadOnly),u.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),n.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),u.updateColor3("vAmbientColor",this._globalAmbientColor)}n.texturesEnabled&&(this._diffuseTexture&&A.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&A.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&A.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&A.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?o.setTexture("reflectionCubeSampler",this._reflectionTexture):o.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&A.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&A.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&A.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&n.getEngine().getCaps().standardDerivatives&&A.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&A.RefractionTextureEnabled&&(this._refractionTexture.isCube?o.setTexture("refractionCubeSampler",this._refractionTexture):o.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),(0,x.an)(o,this,n),this.bindEyePosition(o)}else n.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);!l&&this.isFrozen||(n.lightsEnabled&&!this._disableLighting&&g.G.BindLights(n,t,o,r,this._maxSimultaneousLights),(n.fogEnabled&&t.applyFog&&n.fogMode!==a.x.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||r.PREPASS)&&this.bindView(o),g.G.BindFogParameters(n,t,o),r.NUM_MORPH_INFLUENCERS&&g.G.BindMorphTargetParameters(t,o),r.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(s=t.bakedVertexAnimationManager)||void 0===s||s.bind(o,r.INSTANCES)),this.useLogarithmicDepth&&g.G.BindLogDepth(r,o,n),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),u.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e}dispose(e,t){var i,s,n,r,a,o,h,l,u;t&&(null===(i=this._diffuseTexture)||void 0===i||i.dispose(),null===(s=this._ambientTexture)||void 0===s||s.dispose(),null===(n=this._opacityTexture)||void 0===n||n.dispose(),null===(r=this._reflectionTexture)||void 0===r||r.dispose(),null===(a=this._emissiveTexture)||void 0===a||a.dispose(),null===(o=this._specularTexture)||void 0===o||o.dispose(),null===(h=this._bumpTexture)||void 0===h||h.dispose(),null===(l=this._lightmapTexture)||void 0===l||l.dispose(),null===(u=this._refractionTexture)||void 0===u||u.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){const s=n.p4.Clone((()=>new A(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return s.name=e,s.id=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}static Parse(e,t,i){const s=n.p4.Parse((()=>new A(e.name,t)),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),d.F._parsePlugins(e,s,t,i),s}static get DiffuseTextureEnabled(){return I.k.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){I.k.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return I.k.DetailTextureEnabled}static set DetailTextureEnabled(e){I.k.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return I.k.AmbientTextureEnabled}static set AmbientTextureEnabled(e){I.k.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return I.k.OpacityTextureEnabled}static set OpacityTextureEnabled(e){I.k.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return I.k.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){I.k.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return I.k.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){I.k.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return I.k.SpecularTextureEnabled}static set SpecularTextureEnabled(e){I.k.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return I.k.BumpTextureEnabled}static set BumpTextureEnabled(e){I.k.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return I.k.LightmapTextureEnabled}static set LightmapTextureEnabled(e){I.k.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return I.k.RefractionTextureEnabled}static set RefractionTextureEnabled(e){I.k.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return I.k.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){I.k.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return I.k.FresnelEnabled}static set FresnelEnabled(e){I.k.FresnelEnabled=e}}(0,s.gn)([(0,n.oU)("diffuseTexture")],A.prototype,"_diffuseTexture",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesAndMiscDirty")],A.prototype,"diffuseTexture",void 0),(0,s.gn)([(0,n.oU)("ambientTexture")],A.prototype,"_ambientTexture",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"ambientTexture",void 0),(0,s.gn)([(0,n.oU)("opacityTexture")],A.prototype,"_opacityTexture",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesAndMiscDirty")],A.prototype,"opacityTexture",void 0),(0,s.gn)([(0,n.oU)("reflectionTexture")],A.prototype,"_reflectionTexture",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"reflectionTexture",void 0),(0,s.gn)([(0,n.oU)("emissiveTexture")],A.prototype,"_emissiveTexture",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"emissiveTexture",void 0),(0,s.gn)([(0,n.oU)("specularTexture")],A.prototype,"_specularTexture",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"specularTexture",void 0),(0,s.gn)([(0,n.oU)("bumpTexture")],A.prototype,"_bumpTexture",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"bumpTexture",void 0),(0,s.gn)([(0,n.oU)("lightmapTexture")],A.prototype,"_lightmapTexture",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"lightmapTexture",void 0),(0,s.gn)([(0,n.oU)("refractionTexture")],A.prototype,"_refractionTexture",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"refractionTexture",void 0),(0,s.gn)([(0,n.n9)("ambient")],A.prototype,"ambientColor",void 0),(0,s.gn)([(0,n.n9)("diffuse")],A.prototype,"diffuseColor",void 0),(0,s.gn)([(0,n.n9)("specular")],A.prototype,"specularColor",void 0),(0,s.gn)([(0,n.n9)("emissive")],A.prototype,"emissiveColor",void 0),(0,s.gn)([(0,n.qC)()],A.prototype,"specularPower",void 0),(0,s.gn)([(0,n.qC)("useAlphaFromDiffuseTexture")],A.prototype,"_useAlphaFromDiffuseTexture",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesAndMiscDirty")],A.prototype,"useAlphaFromDiffuseTexture",void 0),(0,s.gn)([(0,n.qC)("useEmissiveAsIllumination")],A.prototype,"_useEmissiveAsIllumination",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"useEmissiveAsIllumination",void 0),(0,s.gn)([(0,n.qC)("linkEmissiveWithDiffuse")],A.prototype,"_linkEmissiveWithDiffuse",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"linkEmissiveWithDiffuse",void 0),(0,s.gn)([(0,n.qC)("useSpecularOverAlpha")],A.prototype,"_useSpecularOverAlpha",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"useSpecularOverAlpha",void 0),(0,s.gn)([(0,n.qC)("useReflectionOverAlpha")],A.prototype,"_useReflectionOverAlpha",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"useReflectionOverAlpha",void 0),(0,s.gn)([(0,n.qC)("disableLighting")],A.prototype,"_disableLighting",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsLightsDirty")],A.prototype,"disableLighting",void 0),(0,s.gn)([(0,n.qC)("useObjectSpaceNormalMap")],A.prototype,"_useObjectSpaceNormalMap",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"useObjectSpaceNormalMap",void 0),(0,s.gn)([(0,n.qC)("useParallax")],A.prototype,"_useParallax",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"useParallax",void 0),(0,s.gn)([(0,n.qC)("useParallaxOcclusion")],A.prototype,"_useParallaxOcclusion",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"useParallaxOcclusion",void 0),(0,s.gn)([(0,n.qC)()],A.prototype,"parallaxScaleBias",void 0),(0,s.gn)([(0,n.qC)("roughness")],A.prototype,"_roughness",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"roughness",void 0),(0,s.gn)([(0,n.qC)()],A.prototype,"indexOfRefraction",void 0),(0,s.gn)([(0,n.qC)()],A.prototype,"invertRefractionY",void 0),(0,s.gn)([(0,n.qC)()],A.prototype,"alphaCutOff",void 0),(0,s.gn)([(0,n.qC)("useLightmapAsShadowmap")],A.prototype,"_useLightmapAsShadowmap",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"useLightmapAsShadowmap",void 0),(0,s.gn)([(0,n.qQ)("diffuseFresnelParameters")],A.prototype,"_diffuseFresnelParameters",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsFresnelDirty")],A.prototype,"diffuseFresnelParameters",void 0),(0,s.gn)([(0,n.qQ)("opacityFresnelParameters")],A.prototype,"_opacityFresnelParameters",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsFresnelAndMiscDirty")],A.prototype,"opacityFresnelParameters",void 0),(0,s.gn)([(0,n.qQ)("reflectionFresnelParameters")],A.prototype,"_reflectionFresnelParameters",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsFresnelDirty")],A.prototype,"reflectionFresnelParameters",void 0),(0,s.gn)([(0,n.qQ)("refractionFresnelParameters")],A.prototype,"_refractionFresnelParameters",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsFresnelDirty")],A.prototype,"refractionFresnelParameters",void 0),(0,s.gn)([(0,n.qQ)("emissiveFresnelParameters")],A.prototype,"_emissiveFresnelParameters",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsFresnelDirty")],A.prototype,"emissiveFresnelParameters",void 0),(0,s.gn)([(0,n.qC)("useReflectionFresnelFromSpecular")],A.prototype,"_useReflectionFresnelFromSpecular",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsFresnelDirty")],A.prototype,"useReflectionFresnelFromSpecular",void 0),(0,s.gn)([(0,n.qC)("useGlossinessFromSpecularMapAlpha")],A.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"useGlossinessFromSpecularMapAlpha",void 0),(0,s.gn)([(0,n.qC)("maxSimultaneousLights")],A.prototype,"_maxSimultaneousLights",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsLightsDirty")],A.prototype,"maxSimultaneousLights",void 0),(0,s.gn)([(0,n.qC)("invertNormalMapX")],A.prototype,"_invertNormalMapX",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"invertNormalMapX",void 0),(0,s.gn)([(0,n.qC)("invertNormalMapY")],A.prototype,"_invertNormalMapY",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"invertNormalMapY",void 0),(0,s.gn)([(0,n.qC)("twoSidedLighting")],A.prototype,"_twoSidedLighting",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsTexturesDirty")],A.prototype,"twoSidedLighting",void 0),(0,s.gn)([(0,n.qC)("applyDecalMapAfterDetailMap")],A.prototype,"_applyDecalMapAfterDetailMap",void 0),(0,s.gn)([(0,n.wz)("_markAllSubMeshesAsMiscDirty")],A.prototype,"applyDecalMapAfterDetailMap",void 0),(0,s.gn)([(0,n.qC)()],A.prototype,"useLogarithmicDepth",null),(0,v.H)("BABYLON.StandardMaterial",A),a.x.DefaultMaterialFactory=e=>new A("default material",e)},30307:(e,t,i)=>{i.d(t,{$6:()=>p,DG:()=>g,Es:()=>f,Qq:()=>_,W:()=>m,kt:()=>d,vU:()=>v});var s=i(90972),n=i(89859),r=i(33632),a=i(74517),o=i(36994),h=i(14651),l=i(40078),u=i(7786),c=i(53027);function d(e){const t=[],i=[],n=[],r=[];let o,h;const l=e.width||1,u=e.height||1,d=0|(e.subdivisionsX||e.subdivisions||1),f=0|(e.subdivisionsY||e.subdivisions||1);for(o=0;o<=f;o++)for(h=0;h<=d;h++){const e=new s.P(h*l/d-l/2,0,(f-o)*u/f-u/2),t=new s.P(0,1,0);i.push(e.x,e.y,e.z),n.push(t.x,t.y,t.z),r.push(h/d,c.e.UseOpenGLOrientationForUV?o/f:1-o/f)}for(o=0;o<f;o++)for(h=0;h<d;h++)t.push(h+1+(o+1)*(d+1)),t.push(h+1+o*(d+1)),t.push(h+o*(d+1)),t.push(h+(o+1)*(d+1)),t.push(h+1+(o+1)*(d+1)),t.push(h+o*(d+1));const _=new a.x;return _.indices=t,_.positions=i,_.normals=n,_.uvs=r,_}function f(e){const t=void 0!==e.xmin&&null!==e.xmin?e.xmin:-1,i=void 0!==e.zmin&&null!==e.zmin?e.zmin:-1,n=void 0!==e.xmax&&null!==e.xmax?e.xmax:1,r=void 0!==e.zmax&&null!==e.zmax?e.zmax:1,o=e.subdivisions||{w:1,h:1},h=e.precision||{w:1,h:1},l=new Array,u=new Array,c=new Array,d=new Array;let f,_,p,g;o.h=o.h<1?1:o.h,o.w=o.w<1?1:o.w,h.w=h.w<1?1:h.w,h.h=h.h<1?1:h.h;const m=(n-t)/o.w,v=(r-i)/o.h;function I(e,t,i,n){const r=u.length/3,a=h.w+1;for(f=0;f<h.h;f++)for(_=0;_<h.w;_++){const e=[r+_+f*a,r+(_+1)+f*a,r+(_+1)+(f+1)*a,r+_+(f+1)*a];l.push(e[1]),l.push(e[2]),l.push(e[3]),l.push(e[0]),l.push(e[1]),l.push(e[3])}const o=s.P.Zero(),p=new s.P(0,1,0);for(f=0;f<=h.h;f++)for(o.z=f*(n-t)/h.h+t,_=0;_<=h.w;_++)o.x=_*(i-e)/h.w+e,o.y=0,u.push(o.x,o.y,o.z),c.push(p.x,p.y,p.z),d.push(_/h.w,f/h.h)}for(p=0;p<o.h;p++)for(g=0;g<o.w;g++)I(t+g*m,i+p*v,t+(g+1)*m,i+(p+1)*v);const T=new a.x;return T.indices=l,T.positions=u,T.normals=c,T.uvs=d,T}function _(e){const t=[],i=[],r=[],o=[];let h,l;const c=e.colorFilter||new n.Wo(.3,.59,.11),d=e.alphaFilter||0;let f=!1;if(e.minHeight>e.maxHeight){f=!0;const t=e.maxHeight;e.maxHeight=e.minHeight,e.minHeight=t}for(h=0;h<=e.subdivisions;h++)for(l=0;l<=e.subdivisions;l++){const t=new s.P(l*e.width/e.subdivisions-e.width/2,0,(e.subdivisions-h)*e.height/e.subdivisions-e.height/2),n=4*(((t.x+e.width/2)/e.width*(e.bufferWidth-1)|0)+((1-(t.z+e.height/2)/e.height)*(e.bufferHeight-1)|0)*e.bufferWidth);let a=e.buffer[n]/255,_=e.buffer[n+1]/255,p=e.buffer[n+2]/255;const g=e.buffer[n+3]/255;f&&(a=1-a,_=1-_,p=1-p);const m=a*c.r+_*c.g+p*c.b;t.y=g>=d?e.minHeight+(e.maxHeight-e.minHeight)*m:e.minHeight-u.kn,i.push(t.x,t.y,t.z),r.push(0,0,0),o.push(l/e.subdivisions,1-h/e.subdivisions)}for(h=0;h<e.subdivisions;h++)for(l=0;l<e.subdivisions;l++){const s=l+1+(h+1)*(e.subdivisions+1),n=l+1+h*(e.subdivisions+1),r=l+h*(e.subdivisions+1),a=l+(h+1)*(e.subdivisions+1),o=i[3*s+1]>=e.minHeight,u=i[3*n+1]>=e.minHeight,c=i[3*r+1]>=e.minHeight;o&&u&&c&&(t.push(s),t.push(n),t.push(r)),i[3*a+1]>=e.minHeight&&o&&c&&(t.push(a),t.push(s),t.push(r))}a.x.ComputeNormals(i,t,r);const _=new a.x;return _.indices=t,_.positions=i,_.normals=r,_.uvs=o,_}function p(e,t={},i){const s=new o.E(e,i);return s._setReady(!1),s._subdivisionsX=t.subdivisionsX||t.subdivisions||1,s._subdivisionsY=t.subdivisionsY||t.subdivisions||1,s._width=t.width||1,s._height=t.height||1,s._maxX=s._width/2,s._maxZ=s._height/2,s._minX=-s._maxX,s._minZ=-s._maxZ,d(t).applyToMesh(s,t.updatable),s._setReady(!0),s}function g(e,t,i=null){const s=new r.Kj(e,i);return f(t).applyToMesh(s,t.updatable),s}function m(e,t,i={},s=null){const r=i.width||10,a=i.height||10,u=i.subdivisions||1,c=i.minHeight||0,d=i.maxHeight||1,f=i.colorFilter||new n.Wo(.3,.59,.11),p=i.alphaFilter||0,g=i.updatable,m=i.onReady;s=s||l.l.LastCreatedScene;const v=new o.E(e,s);return v._subdivisionsX=u,v._subdivisionsY=u,v._width=r,v._height=a,v._maxX=v._width/2,v._maxZ=v._height/2,v._minX=-v._maxX,v._minZ=-v._maxZ,v._setReady(!1),h.w1.LoadImage(t,(e=>{const t=e.width,i=e.height;if(s.isDisposed)return;const n=null==s?void 0:s.getEngine().resizeImageBitmap(e,t,i);_({width:r,height:a,subdivisions:u,minHeight:c,maxHeight:d,colorFilter:f,buffer:n,bufferWidth:t,bufferHeight:i,alphaFilter:p}).applyToMesh(v,g),m&&m(v),v._setReady(!0)}),(()=>{}),s.offlineProvider),v}const v={CreateGround:p,CreateGroundFromHeightMap:m,CreateTiledGround:g};a.x.CreateGround=d,a.x.CreateTiledGround=f,a.x.CreateGroundFromHeightMap=_,r.Kj.CreateGround=(e,t,i,s,n,r)=>p(e,{width:t,height:i,subdivisions:s,updatable:r},n),r.Kj.CreateTiledGround=(e,t,i,s,n,r,a,o,h)=>g(e,{xmin:t,zmin:i,xmax:s,zmax:n,subdivisions:r,precision:a,updatable:h},o),r.Kj.CreateGroundFromHeightMap=(e,t,i,s,n,r,a,o,h,l,u)=>m(e,t,{width:i,height:s,subdivisions:n,minHeight:r,maxHeight:a,updatable:h,onReady:l,alphaFilter:u},o)},33632:(e,t,i)=>{i.d(t,{Kj:()=>F,Wv:()=>y,gW:()=>D});var s=i(64673),n=i(14651),r=i(21369),a=i(29026),o=i(51902),h=i(95593),l=i(8714),u=i(90972),c=i(89859),d=i(62528),f=i(37959),_=i(74517),p=i(42254),g=i(87257),m=i(48777),v=i(79061),I=i(34428),T=i(17590),M=i(96786),x=i(59288),E=i(9827),b=i(49938),A=i(84686),P=i(68623);class D{}class S{constructor(){this.visibleInstances={},this.batchCache=new y,this.batchCacheReplacementModeInFrozenMode=new y,this.instancesBufferSize=2048}}class y{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}}class C{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class R{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}class F extends g.x{static _GetDefaultSideOrientation(e){return e||F.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(f.o.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(f.o.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new s.y$),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new s.y$),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new s.y$),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new s.y$),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new s.y$),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){var e;return(null!==(e=this._thinInstanceDataStorage.instancesCount)&&void 0!==e?e:0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(e,t=null,i=null,n=null,o,h=!0){if(super(e,t),this._internalMeshDataInfo=new R,this.delayLoadState=0,this.instances=new Array,this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new S,this._thinInstanceDataStorage=new C,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=F.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._onBeforeDraw=(e,t,i)=>{e&&i&&(this._uniformBuffer?this.transferToEffect(t):i.bindOnlyWorldMatrix(t))},n){if(n._geometry&&n._geometry.applyToMesh(this),r.j.DeepCopy(n,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=n,t.useClonedMeshMap&&(n._internalMeshDataInfo.meshMap||(n._internalMeshDataInfo.meshMap={}),n._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=n._originalBuilderSideOrientation,this._creationDataStorage=n._creationDataStorage,n._ranges){const e=n._ranges;for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&e[t]&&this.createAnimationRange(t,e[t].from,e[t].to)}if(n.metadata&&n.metadata.clone?this.metadata=n.metadata.clone():this.metadata=n.metadata,this._internalMetadata=n._internalMetadata,a.$&&a.$.HasTags(n)&&a.$.AddTagsTo(this,a.$.GetTags(n,!0)),this.setEnabled(n.isEnabled(!1)),this.parent=n.parent,this.setPivotMatrix(n.getPivotMatrix()),this.id=e+"."+n.id,this.material=n.material,!o){const t=n.getDescendants(!0);for(let i=0;i<t.length;i++){const s=t[i];s.clone&&s.clone(e+"."+s.name,this)}}if(n.morphTargetManager&&(this.morphTargetManager=n.morphTargetManager),t.getPhysicsEngine){const e=t.getPhysicsEngine();if(h&&e)if(1===e.getPluginVersion()){const t=e.getImpostorForPhysicsObject(n);t&&(this.physicsImpostor=t.clone(this))}else 2===e.getPluginVersion()&&n.physicsBody&&n.physicsBody.clone(this)}for(let e=0;e<t.particleSystems.length;e++){const i=t.particleSystems[e];i.emitter===n&&i.clone(i.name,this)}this.skeleton=n.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}null!==i&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=e=>{e.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add((()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))})))},this.onMeshReadyObservable=new s.y$(this._internalMeshDataInfo._onMeshReadyObserverAdded),n&&n.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const s=0===this.getTotalVertices()||t&&t.doNotInstantiate&&(!0===t.doNotInstantiate||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));s.parent=e||this.parent,s.position=this.position.clone(),s.scaling=this.scaling.clone(),this.rotationQuaternion?s.rotationQuaternion=this.rotationQuaternion.clone():s.rotation=this.rotation.clone(),i&&i(this,s);for(const e of this.getChildTransformNodes(!0))"InstancedMesh"===e.getClassName()&&"Mesh"===s.getClassName()&&e.sourceMesh===this?e.instantiateHierarchy(s,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:s},i):e.instantiateHierarchy(s,t,i);return s}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const e=this.getIndices(),i=this.getVerticesData(f.o.PositionKind);i&&e&&(t+=", flat shading: "+(i.length/3===e.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort(((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0))}addLODLevel(e,t){if(t&&t._masterMesh)return x.Y.Warn("You cannot use a mesh as LOD level twice"),this;const i=new P.g(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const s=t._LODLevels[i];if(s.distanceOrScreenCoverage===e)return s.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||0===i._LODLevels.length)return this;const s=t||this.getBoundingInfo().boundingSphere,n=e.mode===h.V.ORTHOGRAPHIC_CAMERA?e.minZ:s.centerWorld.subtract(e.globalPosition).length();let r=n,a=1;if(i._useLODScreenCoverage){const t=e.screenArea;let i=s.radiusWorld*e.minZ/n;i=i*i*Math.PI,r=i/t,a=-1}if(a*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>a*r)return this.onLODLevelSelection&&this.onLODLevelSelection(r,this,this),this;for(let e=0;e<i._LODLevels.length;e++){const t=i._LODLevels[e];if(a*t.distanceOrScreenCoverage<a*r){if(t.mesh){if(4===t.mesh.delayLoadState)return t.mesh._checkDelayState(),this;if(2===t.mesh.delayLoadState)return this;t.mesh._preActivate(),t.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(r,this,t.mesh),t.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(r,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return null===this._geometry||void 0===this._geometry?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,s){var n,r;if(!this._geometry)return null;let a=s||null===(r=null===(n=this._userInstancedBuffersStorage)||void 0===n?void 0:n.vertexBuffers[e])||void 0===r?void 0:r.getFloatData(this.instances.length+1,i||t&&1!==this._geometry.meshes.length);return a||(a=this._geometry.getVerticesData(e,t,i)),a}getVertexBuffer(e,t){var i,s;return this._geometry?null!==(s=t||null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])&&void 0!==s?s:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){var i;return this._geometry?!t&&void 0!==(null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])||this._geometry.isVerticesDataPresent(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}isVertexBufferUpdatable(e,t){var i;if(!this._geometry)return!!this._delayInfo&&-1!==this._delayInfo.indexOf(e);if(!t){const t=null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e];if(t)return t.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const e=new Array;return this._delayInfo&&this._delayInfo.forEach((function(t){e.push(t)})),e}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const e in this._userInstancedBuffersStorage.vertexBuffers)-1===t.indexOf(e)&&t.push(e);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return null!==this._masterMesh&&void 0!==this._masterMesh}isReady(e=!1,t=!1){var i,s,n,r,a,o,h;if(2===this.delayLoadState)return!1;if(!super.isReady(e))return!1;if(!this.subMeshes||0===this.subMeshes.length)return!0;if(!e)return!0;const l=this.getEngine(),u=this.getScene(),c=t||l.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const d=this.material||u.defaultMaterial;if(d)if(d._storeEffectOnSubMeshes)for(const e of this.subMeshes){const t=e.getMaterial();if(t)if(t._storeEffectOnSubMeshes){if(!t.isReadyForSubMesh(this,e,c))return!1}else if(!t.isReady(this,c))return!1}else if(!d.isReady(this,c))return!1;const f=l.currentRenderPassId;for(const e of this.lightSources){const t=e.getShadowGenerators();if(!t)continue;const u=t.values();for(let e=u.next();!0!==e.done;e=u.next()){const t=e.value;if(t&&(!(null===(i=t.getShadowMap())||void 0===i?void 0:i.renderList)||(null===(s=t.getShadowMap())||void 0===s?void 0:s.renderList)&&-1!==(null===(r=null===(n=t.getShadowMap())||void 0===n?void 0:n.renderList)||void 0===r?void 0:r.indexOf(this)))){const e=null!==(a=t.getShadowMap().renderPassIds)&&void 0!==a?a:[l.currentRenderPassId];for(let i=0;i<e.length;++i){l.currentRenderPassId=e[i];for(const e of this.subMeshes)if(!t.isReady(e,c,null!==(h=null===(o=e.getMaterial())||void 0===o?void 0:o.needAlphaBlendingForMesh(this))&&void 0!==h&&h))return l.currentRenderPassId=f,!1}l.currentRenderPassId=f}}}for(const e of this._internalMeshDataInfo._LODLevels)if(e.mesh&&!e.mesh.isReady(c))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t||(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null),this}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(void 0!==this._instanceDataStorage.previousRenderId&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const s=i.length;let n=!1;if(e)n=!0;else for(const e of this.subMeshes){if(e.indexStart+e.indexCount>s){n=!0;break}if(e.verticesStart+e.verticesCount>t){n=!0;break}}if(!n)return this.subMeshes[0]}return this.releaseSubMeshes(),new m.P(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,s=0;for(;i%3!=0;)i++;this.releaseSubMeshes();for(let n=0;n<e&&!(s>=t);n++)m.P.CreateFromIndices(0,s,n===e-1?t-s:i,this,void 0,!1),s+=i;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,i=!1,s){if(this._geometry)this._geometry.setVerticesData(e,t,i,s);else{const s=new _.x;s.set(t,e);const n=this.getScene();new p.Z(p.Z.RandomId(),n,s,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);i&&i.isUpdatable()!==t&&this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=p.Z.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,s){return this._geometry?(s?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(f.o.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(f.o.PositionKind,i,!1,!1),t){const e=this.getIndices(),t=this.getVerticesData(f.o.NormalKind);if(!t)return this;_.x.ComputeNormals(i,e,t),this.updateVerticesData(f.o.NormalKind,t,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(1===this._geometry.meshes.length)return this;const e=this._geometry,t=this._geometry.copy(p.Z.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndices(e,t=null,i=!1){if(this._geometry)this._geometry.setIndices(e,t,i);else{const t=new _.x;t.indices=e;const s=this.getScene();new p.Z(p.Z.RandomId(),s,t,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,s=!0){if(!this._geometry)return this;const n=this.getScene().getEngine();let r;if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t),this._unIndexed)r=null;else switch(this._getRenderingFillMode(i)){case v.F.PointFillMode:r=null;break;case v.F.WireFrameFillMode:r=e._getLinesIndexBuffer(this.getIndices(),n);break;default:case v.F.TriangleFillMode:r=this._geometry.getIndexBuffer()}return s&&this._userInstancedBuffersStorage&&!this.hasThinInstances?this._geometry._bind(t,r,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(t,r),this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const s=this.getScene().getEngine();return this._unIndexed||t==v.F.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==v.F.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),s=i._isInIntermediateRendering(),n=s?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,r=this._instanceDataStorage.batchCache;if(r.mustReturn=!1,r.renderSelf[e]=t||!n&&this.isEnabled()&&this.isVisible,r.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const t=this._instanceDataStorage.visibleInstances,n=i.getRenderId(),a=s?t.intermediateDefaultRenderId:t.defaultRenderId;r.visibleInstances[e]=t[n],!r.visibleInstances[e]&&a&&(r.visibleInstances[e]=t[a])}return r.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&null!==r.visibleInstances[e]&&void 0!==r.visibleInstances[e],this._instanceDataStorage.previousBatch=r,r}_renderWithInstances(e,t,i,s,n){var r;const a=i.visibleInstances[e._id],o=a?a.length:0,h=this._instanceDataStorage,l=h.instancesBufferSize;let c=h.instancesBuffer,d=h.instancesPreviousBuffer;const _=16*(o+1)*4;for(;h.instancesBufferSize<_;)h.instancesBufferSize*=2;h.instancesData&&l==h.instancesBufferSize||(h.instancesData=new Float32Array(h.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!h.instancesPreviousData||l!=h.instancesBufferSize)&&(h.instancesPreviousData=new Float32Array(h.instancesBufferSize/4));let p=0,g=0;const m=i.renderSelf[e._id],v=!c||l!==h.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!h.instancesPreviousBuffer;if(this._instanceDataStorage.manualUpdate||h.isFrozen&&!v)g=(m?1:0)+o;else{const t=this.getWorldMatrix();if(m&&(this._scene.needsPreviousWorldMatrices&&(h.masterMeshPreviousWorldMatrix?(h.masterMeshPreviousWorldMatrix.copyToArray(h.instancesPreviousData,p),h.masterMeshPreviousWorldMatrix.copyFrom(t)):(h.masterMeshPreviousWorldMatrix=t.clone(),h.masterMeshPreviousWorldMatrix.copyToArray(h.instancesPreviousData,p))),t.copyToArray(h.instancesData,p),p+=16,g++),a){if(F.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&(null===(r=e.getMaterial())||void 0===r?void 0:r.needAlphaBlendingForMesh(e.getRenderingMesh()))){const e=this._scene.activeCamera.globalPosition;for(let t=0;t<a.length;t++){const i=a[t];i._distanceToCamera=u.P.Distance(i.getBoundingInfo().boundingSphere.centerWorld,e)}a.sort(((e,t)=>e._distanceToCamera>t._distanceToCamera?-1:e._distanceToCamera<t._distanceToCamera?1:0))}for(let e=0;e<a.length;e++){const t=a[e],i=t.getWorldMatrix();i.copyToArray(h.instancesData,p),this._scene.needsPreviousWorldMatrices&&(t._previousWorldMatrix?(t._previousWorldMatrix.copyToArray(h.instancesPreviousData,p),t._previousWorldMatrix.copyFrom(i)):(t._previousWorldMatrix=i.clone(),t._previousWorldMatrix.copyToArray(h.instancesPreviousData,p))),p+=16,g++}}}return v?(c&&c.dispose(),d&&d.dispose(),c=new f.l(n,h.instancesData,!0,16,!1,!0),h.instancesBuffer=c,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=c.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=c.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=c.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=c.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new f.l(n,h.instancesPreviousData,!0,16,!1,!0),h.instancesPreviousBuffer=d,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||(c.updateDirectly(h.instancesData,0,g),!this._scene.needsPreviousWorldMatrices||this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.previousManualUpdate||d.updateDirectly(h.instancesPreviousData,0,g)),this._processInstancedBuffers(a,m),this.getScene()._activeIndices.addCount(e.indexCount*g,!1),n._currentDrawContext&&(n._currentDrawContext.useInstancing=!0),this._bind(e,s,t),this._draw(e,t,g),!this._scene.needsPreviousWorldMatrices||v||!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||this._instanceDataStorage.previousManualUpdate||d.updateDirectly(h.instancesData,0,g),n.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,s){var n,r;const a=null!==(r=null===(n=this._thinInstanceDataStorage)||void 0===n?void 0:n.instancesCount)&&void 0!==r?r:0;this.getScene()._activeIndices.addCount(e.indexCount*a,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,a),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,a):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),s.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,s,n,r,a,o){const h=this.getScene(),l=h.getEngine();if(s=this._getRenderingFillMode(s),r&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,s,i,l),this;if(r)this._renderWithInstances(t,s,n,i,l);else{l._currentDrawContext&&(l._currentDrawContext.useInstancing=!1);let i=0;n.renderSelf[t._id]&&(a&&a(!1,e.getWorldMatrix(),o),i++,this._draw(t,s,this._instanceDataStorage.overridenInstanceCount));const r=n.visibleInstances[t._id];if(r){const e=r.length;i+=e;for(let i=0;i<e;i++){const e=r[i].getWorldMatrix();a&&a(!0,e,o),this._draw(t,s)}}h._activeIndices.addCount(t.indexCount*i,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}render(e,t,i){var s,n,r;const a=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const o=this._getInstancesRenderList(e._id,!!i);if(o.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const h=a.getEngine();let u=0,c=null;this.ignoreCameraMaxZ&&a.activeCamera&&!a._isInIntermediateRendering()&&(u=a.activeCamera.maxZ,c=a.activeCamera,a.activeCamera.maxZ=0,a.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const d=e.getRenderingMesh(),f=o.hardwareInstancedRendering[e._id]||d.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,_=this._instanceDataStorage,p=e.getMaterial();if(!p)return c&&(c.maxZ=u,a.updateTransformMatrix(!0)),this;if(_.isFrozen&&this._internalMeshDataInfo._effectiveMaterial&&this._internalMeshDataInfo._effectiveMaterial===p){if(p._storeEffectOnSubMeshes&&!(null===(s=e.effect)||void 0===s?void 0:s._wasPreviouslyReady)||!p._storeEffectOnSubMeshes&&!(null===(n=p.getEffect())||void 0===n?void 0:n._wasPreviouslyReady))return c&&(c.maxZ=u,a.updateTransformMatrix(!0)),this}else{if(p._storeEffectOnSubMeshes){if(!p.isReadyForSubMesh(this,e,f))return c&&(c.maxZ=u,a.updateTransformMatrix(!0)),this}else if(!p.isReady(this,f))return c&&(c.maxZ=u,a.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=p}let g;t&&h.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode),g=this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?e._drawWrapper:this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const m=null!==(r=null==g?void 0:g.effect)&&void 0!==r?r:null;for(const t of a._beforeRenderingMeshStage)t.action(this,e,o,m);if(!g||!m)return c&&(c.maxZ=u,a.updateTransformMatrix(!0)),this;const I=i||this;let T;if(_.isFrozen||!this._internalMeshDataInfo._effectiveMaterial.backFaceCulling&&null===this.overrideMaterialSideOrientation)T=_.sideOrientation;else{const e=I._getWorldMatrixDeterminant();T=this.overrideMaterialSideOrientation,null==T&&(T=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),e<0&&(T=T===v.F.ClockWiseSideOrientation?v.F.CounterClockWiseSideOrientation:v.F.ClockWiseSideOrientation),_.sideOrientation=T}const M=this._internalMeshDataInfo._effectiveMaterial._preBind(g,T);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&h.setDepthWrite(!0);const x=this._internalMeshDataInfo._effectiveMaterial,E=x.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(e,m,E,!1);const b=I.getWorldMatrix();x._storeEffectOnSubMeshes?x.bindForSubMesh(b,this,e):x.bind(b,this),!x.backFaceCulling&&x.separateCullingPass&&(h.setState(!0,x.zOffset,!1,!M,x.cullBackFaces,x.stencil,x.zOffsetUnits),this._processRendering(this,e,m,E,o,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),h.setState(!0,x.zOffset,!1,M,x.cullBackFaces,x.stencil,x.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,m,E,o,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const t of a._afterRenderingMeshStage)t.action(this,e,o,m);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),c&&(c.maxZ=u,a.updateTransformMatrix(!0)),a.performancePriority!==l.a.Aggressive||_.isFrozen||this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(f.o.MatricesWeightsKind)&&(this.isVerticesDataPresent(f.o.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(f.o.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const t=e[i]+e[i+1]+e[i+2]+e[i+3];if(0===t)e[i]=1;else{const s=1/t;e[i]*=s,e[i+1]*=s,e[i+2]*=s,e[i+3]*=s}}this.setVerticesData(f.o.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(f.o.MatricesWeightsExtraKind),t=this.getVerticesData(f.o.MatricesWeightsKind),i=t.length;for(let s=0;s<i;s+=4){let i=t[s]+t[s+1]+t[s+2]+t[s+3];if(i+=e[s]+e[s+1]+e[s+2]+e[s+3],0===i)t[s]=1;else{const n=1/i;t[s]*=n,t[s+1]*=n,t[s+2]*=n,t[s+3]*=n,e[s]*=n,e[s+1]*=n,e[s+2]*=n,e[s+3]*=n}}this.setVerticesData(f.o.MatricesWeightsKind,t),this.setVerticesData(f.o.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(f.o.MatricesWeightsExtraKind),t=this.getVerticesData(f.o.MatricesWeightsKind);if(null===t||null==this.skeleton)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let s=0,n=0,r=0,a=0;const o=null===e?4:8,h=new Array;for(let e=0;e<=o;e++)h[e]=0;for(let l=0;l<i;l+=4){let i=t[l],u=i,c=0===u?0:1;for(let n=1;n<o;n++){const r=n<4?t[l+n]:e[l+n-4];r>i&&s++,0!==r&&c++,u+=r,i=r}if(h[c]++,c>r&&(r=c),0===u)n++;else{const i=1/u;let s=0;for(let n=0;n<o;n++)s+=n<4?Math.abs(t[l+n]-t[l+n]*i):Math.abs(e[l+n-4]-e[l+n-4]*i);s>.001&&a++}}const l=this.skeleton.bones.length,u=this.getVerticesData(f.o.MatricesIndicesKind),c=this.getVerticesData(f.o.MatricesIndicesExtraKind);let d=0;for(let e=0;e<i;e+=4)for(let t=0;t<o;t++){const i=t<4?u[e+t]:c[e+t-4];(i>=l||i<0)&&d++}return{skinned:!0,valid:0===n&&0===a&&0===d,report:"Number of Weights = "+i/4+"\nMaximum influences = "+r+"\nMissing Weights = "+n+"\nNot Sorted = "+s+"\nNot Normalized = "+a+"\nWeightCounts = ["+h+"]\nNumber of bones = "+l+"\nBad Bone Indices = "+d}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):4===this.delayLoadState&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return n.w1.LoadFile(this.delayLoadingFile,(t=>{t instanceof ArrayBuffer?this._delayLoadingFunction(t,this):this._delayLoadingFunction(JSON.parse(t),this),this.instances.forEach((e=>{e.refreshBoundingInfo(),e._syncSubMeshes()})),this.delayLoadState=1,e.removePendingData(this)}),(()=>{}),e.offlineProvider,t),this}isInFrustum(e){return 2!==this.delayLoadState&&!!super.isInFrustum(e)&&(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const s=this.getScene().multiMaterials;for(i=s.length-1;i>-1;i--)if(s[i].id===e)return this.material=s[i],this;return this}getAnimatables(){const e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(f.o.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(f.o.PositionKind);const s=u.P.Zero();let n;for(n=0;n<i.length;n+=3)u.P.TransformCoordinatesFromFloatsToRef(i[n],i[n+1],i[n+2],e,s).toArray(i,n);if(this.setVerticesData(f.o.PositionKind,i,this.getVertexBuffer(f.o.PositionKind).isUpdatable()),this.isVerticesDataPresent(f.o.NormalKind)){for(i=this.getVerticesData(f.o.NormalKind),n=0;n<i.length;n+=3)u.P.TransformNormalFromFloatsToRef(i[n],i[n+1],i[n+2],e,s).normalize().toArray(i,n);this.setVerticesData(f.o.NormalKind,i,this.getVertexBuffer(f.o.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return!!this._geometry&&this._geometry._generatePointsArray()}clone(e="",t=null,i,s=!0){return new F(e,this.getScene(),t,this,i,s)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const e in i.meshMap){const t=i.meshMap[e];t&&(t._internalMeshDataInfo._source=null,i.meshMap[e]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const e=this.getScene().meshes;for(const t of e){const e=t;e._internalMeshDataInfo&&e._internalMeshDataInfo._source&&e._internalMeshDataInfo._source===this&&(e._internalMeshDataInfo._source=null)}}i._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,s,r,a,o=!1){const h=this.getScene();return n.w1.LoadImage(e,(e=>{const n=e.width,h=e.height,l=this.getEngine().createCanvas(n,h).getContext("2d");l.drawImage(e,0,0);const u=l.getImageData(0,0,n,h).data;this.applyDisplacementMapFromBuffer(u,n,h,t,i,r,a,o),s&&s(this)}),(()=>{}),h.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,s,n,r,a,o=!1){if(!this.isVerticesDataPresent(f.o.PositionKind)||!this.isVerticesDataPresent(f.o.NormalKind)||!this.isVerticesDataPresent(f.o.UVKind))return x.Y.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const h=this.getVerticesData(f.o.PositionKind,!0,!0),l=this.getVerticesData(f.o.NormalKind),c=this.getVerticesData(f.o.UVKind);let d=u.P.Zero();const p=u.P.Zero(),g=u.FM.Zero();r=r||u.FM.Zero(),a=a||new u.FM(1,1);for(let o=0;o<h.length;o+=3){u.P.FromArrayToRef(h,o,d),u.P.FromArrayToRef(l,o,p),u.FM.FromArrayToRef(c,o/3*2,g);const f=4*((Math.abs(g.x*a.x+r.x%1)*(t-1)%t|0)+(Math.abs(g.y*a.y+r.y%1)*(i-1)%i|0)*t),_=e[f]/255*.3+e[f+1]/255*.59+e[f+2]/255*.11;p.normalize(),p.scaleInPlace(s+(n-s)*_),d=d.add(p),d.toArray(h,o)}return _.x.ComputeNormals(h,this.getIndices(),l),o?(this.setVerticesData(f.o.PositionKind,h),this.setVerticesData(f.o.NormalKind,l),this.setVerticesData(f.o.UVKind,c)):(this.updateVerticesData(f.o.PositionKind,h),this.updateVerticesData(f.o.NormalKind,l)),this}_getFlattenedNormals(e,t){const i=new Float32Array(3*e.length);let s=0;const n=this.overrideMaterialSideOrientation===(this._scene.useRightHandedSystem?1:0);for(let r=0;r<e.length;r+=3){const a=u.P.FromArray(t,3*e[r]),o=u.P.FromArray(t,3*e[r+1]),h=u.P.FromArray(t,3*e[r+2]),l=a.subtract(o),c=h.subtract(o),d=u.P.Normalize(u.P.Cross(l,c));n&&d.scaleInPlace(-1);for(let e=0;e<3;e++)i[s++]=d.x,i[s++]=d.y,i[s++]=d.z}return i}_convertToUnIndexedMesh(e=!1){const t=this.getVerticesDataKinds(),i=this.getIndices(),s={},n=(e,t)=>{const s=new Float32Array(i.length*t);let n=0;for(let r=0;r<i.length;r++)for(let a=0;a<t;a++)s[n++]=e[i[r]*t+a];return s},r=this.geometry?this.subMeshes.slice(0):[];for(const e of t)s[e]=this.getVerticesData(e);for(const r of t){const t=this.getVertexBuffer(r),a=t.getStrideSize();if(e&&r===f.o.NormalKind){const e=this._getFlattenedNormals(i,s[f.o.PositionKind]);this.setVerticesData(f.o.NormalKind,e,t.isUpdatable(),a)}else this.setVerticesData(r,n(s[r],a),t.isUpdatable(),a)}if(this.morphTargetManager){for(let t=0;t<this.morphTargetManager.numTargets;t++){const s=this.morphTargetManager.getTarget(t),r=s.getPositions();s.setPositions(n(r,3));const a=s.getNormals();a&&s.setNormals(e?this._getFlattenedNormals(i,r):n(a,3));const o=s.getTangents();o&&s.setTangents(n(o,3));const h=s.getUVs();h&&s.setUVs(n(h,2))}this.morphTargetManager.synchronize()}for(let e=0;e<i.length;e++)i[e]=e;this.setIndices(i),this._unIndexed=!0,this.releaseSubMeshes();for(const e of r)m.P.AddToMesh(e.materialIndex,e.indexStart,e.indexCount,e.indexStart,e.indexCount,this);return this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){const t=_.x.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(f.o.NormalKind)&&t.normals)for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;if(t.indices){let e;for(i=0;i<t.indices.length;i+=3)e=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=e}return t.applyToMesh(this,this.isVertexBufferUpdatable(f.o.PositionKind)),this}increaseVertices(e=1){const t=_.x.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,s=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,n=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,r=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(i&&s){t.indices=i,t.positions=s,n&&(t.uvs=n),r&&(t.normals=r);const a=e+1,o=new Array;for(let e=0;e<a+1;e++)o[e]=new Array;let h,l;const c=new u.P(0,0,0),d=new u.P(0,0,0),_=new u.FM(0,0),p=new Array,g=new Array,m=new Array;let v,I,T,M=s.length;n&&(I=n.length),r&&(T=r.length);for(let e=0;e<i.length;e+=3){g[0]=i[e],g[1]=i[e+1],g[2]=i[e+2];for(let e=0;e<3;e++)if(h=g[e],l=g[(e+1)%3],void 0===m[h]&&void 0===m[l]?(m[h]=new Array,m[l]=new Array):(void 0===m[h]&&(m[h]=new Array),void 0===m[l]&&(m[l]=new Array)),void 0===m[h][l]&&void 0===m[l][h]){m[h][l]=[],c.x=(s[3*l]-s[3*h])/a,c.y=(s[3*l+1]-s[3*h+1])/a,c.z=(s[3*l+2]-s[3*h+2])/a,r&&(d.x=(r[3*l]-r[3*h])/a,d.y=(r[3*l+1]-r[3*h+1])/a,d.z=(r[3*l+2]-r[3*h+2])/a),n&&(_.x=(n[2*l]-n[2*h])/a,_.y=(n[2*l+1]-n[2*h+1])/a),m[h][l].push(h);for(let e=1;e<a;e++)m[h][l].push(s.length/3),s[M++]=s[3*h]+e*c.x,s[M++]=s[3*h+1]+e*c.y,s[M++]=s[3*h+2]+e*c.z,r&&(r[T++]=r[3*h]+e*d.x,r[T++]=r[3*h+1]+e*d.y,r[T++]=r[3*h+2]+e*d.z),n&&(n[I++]=n[2*h]+e*_.x,n[I++]=n[2*h+1]+e*_.y);m[h][l].push(l),m[l][h]=new Array,v=m[h][l].length;for(let e=0;e<v;e++)m[l][h][e]=m[h][l][v-1-e]}o[0][0]=i[e],o[1][0]=m[i[e]][i[e+1]][1],o[1][1]=m[i[e]][i[e+2]][1];for(let t=2;t<a;t++){o[t][0]=m[i[e]][i[e+1]][t],o[t][t]=m[i[e]][i[e+2]][t],c.x=(s[3*o[t][t]]-s[3*o[t][0]])/t,c.y=(s[3*o[t][t]+1]-s[3*o[t][0]+1])/t,c.z=(s[3*o[t][t]+2]-s[3*o[t][0]+2])/t,r&&(d.x=(r[3*o[t][t]]-r[3*o[t][0]])/t,d.y=(r[3*o[t][t]+1]-r[3*o[t][0]+1])/t,d.z=(r[3*o[t][t]+2]-r[3*o[t][0]+2])/t),n&&(_.x=(n[2*o[t][t]]-n[2*o[t][0]])/t,_.y=(n[2*o[t][t]+1]-n[2*o[t][0]+1])/t);for(let e=1;e<t;e++)o[t][e]=s.length/3,s[M++]=s[3*o[t][0]]+e*c.x,s[M++]=s[3*o[t][0]+1]+e*c.y,s[M++]=s[3*o[t][0]+2]+e*c.z,r&&(r[T++]=r[3*o[t][0]]+e*d.x,r[T++]=r[3*o[t][0]+1]+e*d.y,r[T++]=r[3*o[t][0]+2]+e*d.z),n&&(n[I++]=n[2*o[t][0]]+e*_.x,n[I++]=n[2*o[t][0]+1]+e*_.y)}o[a]=m[i[e+1]][i[e+2]],p.push(o[0][0],o[1][0],o[1][1]);for(let e=1;e<a;e++){let t;for(t=0;t<e;t++)p.push(o[e][t],o[e+1][t],o[e+1][t+1]),p.push(o[e][t],o[e+1][t+1],o[e][t+1]);p.push(o[e][t],o[e+1][t],o[e+1][t+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(f.o.PositionKind))}else x.Y.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions")}forceSharedVertices(){const e=_.x.ExtractFromMesh(this),t=e.uvs,i=e.indices,s=e.positions,n=e.colors,r=e.matricesIndices,a=e.matricesWeights,o=e.matricesIndicesExtra,h=e.matricesWeightsExtra;if(void 0===i||void 0===s||null===i||null===s)x.Y.Warn("VertexData contains empty entries");else{const l=new Array,u=new Array,c=new Array,d=new Array,p=new Array,g=new Array,m=new Array,v=new Array;let I=new Array,T=0;const M={};let x,E;for(let e=0;e<i.length;e+=3){E=[i[e],i[e+1],i[e+2]],I=new Array;for(let e=0;e<3;e++){I[e]="";for(let t=0;t<3;t++)Math.abs(s[3*E[e]+t])<1e-8&&(s[3*E[e]+t]=0),I[e]+=s[3*E[e]+t]+"|"}if(I[0]!=I[1]&&I[0]!=I[2]&&I[1]!=I[2])for(let e=0;e<3;e++){if(x=M[I[e]],void 0===x){M[I[e]]=T,x=T++;for(let t=0;t<3;t++)l.push(s[3*E[e]+t]);if(null!=n)for(let t=0;t<4;t++)d.push(n[4*E[e]+t]);if(null!=t)for(let i=0;i<2;i++)c.push(t[2*E[e]+i]);if(null!=r)for(let t=0;t<4;t++)p.push(r[4*E[e]+t]);if(null!=a)for(let t=0;t<4;t++)g.push(a[4*E[e]+t]);if(null!=o)for(let t=0;t<4;t++)m.push(o[4*E[e]+t]);if(null!=h)for(let t=0;t<4;t++)v.push(h[4*E[e]+t])}u.push(x)}}const b=new Array;_.x.ComputeNormals(l,u,b),e.positions=l,e.indices=u,e.normals=b,null!=t&&(e.uvs=c),null!=n&&(e.colors=d),null!=r&&(e.matricesIndices=p),null!=a&&(e.matricesWeights=g),null!=o&&(e.matricesIndicesExtra=m),null!=a&&(e.matricesWeightsExtra=v),e.applyToMesh(this,this.isVertexBufferUpdatable(f.o.PositionKind))}}static _instancedMeshFactory(e,t){throw(0,b.S)("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw(0,b.S)("PhysicsImpostor")}createInstance(e){return F._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(f.o.PositionKind);if(!i||!t)return this;const s=new Array;for(let e=0;e<i.length;e+=3)s.push(u.P.FromArray(i,e));const r=new Array;return n.$g.SyncAsyncForLoop(s.length,40,(e=>{const t=s.length-1-e,i=s[t];for(let e=0;e<t;++e){const n=s[e];if(i.equals(n)){r[t]=e;break}}}),(()=>{for(let e=0;e<t.length;++e)t[e]=r[t[e]]||t[e];const i=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=i,e&&e(this)})),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),a.$&&a.$.HasTags(this)&&(e.tags=a.$.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let t=0;t<this.subMeshes.length;t++){const i=this.subMeshes[t];e.subMeshes.push({materialIndex:i.materialIndex,verticesStart:i.verticesStart,verticesCount:i.verticesCount,indexStart:i.indexStart,indexCount:i.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(A.l.NAME_PHYSICSENGINE)){const t=this.getPhysicsImpostor();t&&(e.physicsMass=t.getParam("mass"),e.physicsFriction=t.getParam("friction"),e.physicsRestitution=t.getParam("mass"),e.physicsImpostor=t.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let t=0;t<this.instances.length;t++){const i=this.instances[t];if(i.doNotSerialize)continue;const s={name:i.name,id:i.id,isEnabled:i.isEnabled(!1),isVisible:i.isVisible,isPickable:i.isPickable,checkCollisions:i.checkCollisions,position:i.position.asArray(),scaling:i.scaling.asArray()};if(i.parent&&i.parent._serializeAsParent(s),i.rotationQuaternion?s.rotationQuaternion=i.rotationQuaternion.asArray():i.rotation&&(s.rotation=i.rotation.asArray()),this.getScene()._getComponent(A.l.NAME_PHYSICSENGINE)){const e=i.getPhysicsImpostor();e&&(s.physicsMass=e.getParam("mass"),s.physicsFriction=e.getParam("friction"),s.physicsRestitution=e.getParam("mass"),s.physicsImpostor=e.type)}i.metadata&&(s.metadata=i.metadata),i.actionManager&&(s.actions=i.actionManager.serialize(i.name)),e.instances.push(s),M.p4.AppendSerializedAnimations(i,s),s.ranges=i.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const t={data:{},sizes:{},strides:{}};for(const e in this._userThinInstanceBuffersStorage.data)t.data[e]=Array.from(this._userThinInstanceBuffersStorage.data[e]),t.sizes[e]=this._userThinInstanceBuffersStorage.sizes[e],t.strides[e]=this._userThinInstanceBuffersStorage.strides[e];e.thinInstances.userThinInstance=t}return M.p4.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices())return x.Y.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),s=i.getPositions();if(!s)return void x.Y.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(f.o.PositionKind+t,s,!1,3);const n=i.getNormals();n&&this.geometry.setVerticesData(f.o.NormalKind+t,n,!1,3);const r=i.getTangents();r&&this.geometry.setVerticesData(f.o.TangentKind+t,r,!1,3);const a=i.getUVs();a&&this.geometry.setVerticesData(f.o.UVKind+"_"+t,a,!1,2)}}else{let e=0;for(;this.geometry.isVerticesDataPresent(f.o.PositionKind+e);)this.geometry.removeVerticesData(f.o.PositionKind+e),this.geometry.isVerticesDataPresent(f.o.NormalKind+e)&&this.geometry.removeVerticesData(f.o.NormalKind+e),this.geometry.isVerticesDataPresent(f.o.TangentKind+e)&&this.geometry.removeVerticesData(f.o.TangentKind+e),this.geometry.isVerticesDataPresent(f.o.UVKind+e)&&this.geometry.removeVerticesData(f.o.UVKind+"_"+e),e++}}static Parse(e,t,i){let s;if(s=e.type&&"LinesMesh"===e.type?F._LinesMeshParser(e,t):e.type&&"GroundMesh"===e.type?F._GroundMeshParser(e,t):e.type&&"GoldbergMesh"===e.type?F._GoldbergMeshParser(e,t):e.type&&"GreasedLineMesh"===e.type?F._GreasedLineMeshParser(e,t):e.type&&"TrailMesh"===e.type?F._TrailMeshParser(e,t):new F(e.name,t),s.id=e.id,s._waitingParsedUniqueId=e.uniqueId,a.$&&a.$.AddTagsTo(s,e.tags),s.position=u.P.FromArray(e.position),void 0!==e.metadata&&(s.metadata=e.metadata),e.rotationQuaternion?s.rotationQuaternion=u._f.FromArray(e.rotationQuaternion):e.rotation&&(s.rotation=u.P.FromArray(e.rotation)),s.scaling=u.P.FromArray(e.scaling),e.localMatrix?s.setPreTransformMatrix(u.y3.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(u.y3.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s.isVisible=e.isVisible,s.infiniteDistance=e.infiniteDistance,s.showBoundingBox=e.showBoundingBox,s.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(s.applyFog=e.applyFog),void 0!==e.pickable&&(s.isPickable=e.pickable),void 0!==e.alphaIndex&&(s.alphaIndex=e.alphaIndex),s.receiveShadows=e.receiveShadows,void 0!==e.billboardMode&&(s.billboardMode=e.billboardMode),void 0!==e.visibility&&(s.visibility=e.visibility),s.checkCollisions=e.checkCollisions,s.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,void 0!==e.isBlocker&&(s.isBlocker=e.isBlocker),s._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(s._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.actions&&(s._waitingData.actions=e.actions),void 0!==e.overlayAlpha&&(s.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(s.overlayColor=c.Wo.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(s.renderOverlay=e.renderOverlay),s.isUnIndexed=!!e.isUnIndexed,s.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s.buildBoundingInfo(u.P.FromArray(e.boundingBoxMinimum),u.P.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(s._binaryInfo=e._binaryInfo),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(f.o.UVKind),e.hasUVs2&&s._delayInfo.push(f.o.UV2Kind),e.hasUVs3&&s._delayInfo.push(f.o.UV3Kind),e.hasUVs4&&s._delayInfo.push(f.o.UV4Kind),e.hasUVs5&&s._delayInfo.push(f.o.UV5Kind),e.hasUVs6&&s._delayInfo.push(f.o.UV6Kind),e.hasColors&&s._delayInfo.push(f.o.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(f.o.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(f.o.MatricesWeightsKind),s._delayLoadingFunction=p.Z._ImportGeometry,T.Z.ForceFullSceneLoadingForIncremental&&s._checkDelayState()):p.Z._ImportGeometry(e,s),e.materialUniqueId?s._waitingMaterialId=e.materialUniqueId:e.materialId&&(s._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(s.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),void 0!==e.skeletonId&&null!==e.skeletonId&&(s.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(s.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],n=(0,E.q)("BABYLON.Animation");n&&s.animations.push(n.Parse(i))}d.N.ParseAnimationRanges(s,e,t)}if(e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?s.layerMask=Math.abs(parseInt(e.layerMask)):s.layerMask=268435455,e.physicsImpostor&&F._PhysicsImpostorParser(t,s,e),e.lodMeshIds&&(s._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let i=0;i<e.instances.length;i++){const n=e.instances[i],r=s.createInstance(n.name);if(n.id&&(r.id=n.id),a.$&&(n.tags?a.$.AddTagsTo(r,n.tags):a.$.AddTagsTo(r,e.tags)),r.position=u.P.FromArray(n.position),void 0!==n.metadata&&(r.metadata=n.metadata),void 0!==n.parentId&&(r._waitingParentId=n.parentId),void 0!==n.parentInstanceIndex&&(r._waitingParentInstanceIndex=n.parentInstanceIndex),void 0!==n.isEnabled&&null!==n.isEnabled&&r.setEnabled(n.isEnabled),void 0!==n.isVisible&&null!==n.isVisible&&(r.isVisible=n.isVisible),void 0!==n.isPickable&&null!==n.isPickable&&(r.isPickable=n.isPickable),n.rotationQuaternion?r.rotationQuaternion=u._f.FromArray(n.rotationQuaternion):n.rotation&&(r.rotation=u.P.FromArray(n.rotation)),r.scaling=u.P.FromArray(n.scaling),null!=n.checkCollisions&&null!=n.checkCollisions&&(r.checkCollisions=n.checkCollisions),null!=n.pickable&&null!=n.pickable&&(r.isPickable=n.pickable),null!=n.showBoundingBox&&null!=n.showBoundingBox&&(r.showBoundingBox=n.showBoundingBox),null!=n.showSubMeshesBoundingBox&&null!=n.showSubMeshesBoundingBox&&(r.showSubMeshesBoundingBox=n.showSubMeshesBoundingBox),null!=n.alphaIndex&&null!=n.showSubMeshesBoundingBox&&(r.alphaIndex=n.alphaIndex),n.physicsImpostor&&F._PhysicsImpostorParser(t,r,n),void 0!==n.actions&&(r._waitingData.actions=n.actions),n.animations){for(let e=0;e<n.animations.length;e++){const t=n.animations[e],i=(0,E.q)("BABYLON.Animation");i&&r.animations.push(i.Parse(t))}d.N.ParseAnimationRanges(r,n,t),n.autoAnimate&&t.beginAnimation(r,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1)}}if(e.thinInstances){const t=e.thinInstances;if(s.thinInstanceEnablePicking=!!t.enablePicking,t.matrixData?(s.thinInstanceSetBuffer("matrix",new Float32Array(t.matrixData),16,!1),s._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,s._thinInstanceDataStorage.instancesCount=t.instancesCount):s._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,e.thinInstances.userThinInstance){const t=e.thinInstances.userThinInstance;for(const e in t.data)s.thinInstanceSetBuffer(e,new Float32Array(t.data[e]),t.strides[e],!1),s._userThinInstanceBuffersStorage.sizes[e]=t.sizes[e]}}return s}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(f.o.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(f.o.PositionKind)||this.setVerticesData(f.o.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(f.o.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(f.o.NormalKind)||this.setVerticesData(f.o.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(f.o.PositionKind))return this;if(!this.isVerticesDataPresent(f.o.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(f.o.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(f.o.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(f.o.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let n=this.getVerticesData(f.o.NormalKind);if(t){if(!n)return this;n instanceof Float32Array||(n=new Float32Array(n))}const r=this.getVerticesData(f.o.MatricesIndicesKind),a=this.getVerticesData(f.o.MatricesWeightsKind);if(!a||!r)return this;const o=this.numBoneInfluencers>4,h=o?this.getVerticesData(f.o.MatricesIndicesExtraKind):null,l=o?this.getVerticesData(f.o.MatricesWeightsExtraKind):null,c=e.getTransformMatrices(this),d=u.P.Zero(),_=new u.y3,p=new u.y3;let g,m=0;for(let e=0;e<s.length;e+=3,m+=4){let f;for(g=0;g<4;g++)f=a[m+g],f>0&&(u.y3.FromFloat32ArrayToRefScaled(c,Math.floor(16*r[m+g]),f,p),_.addToSelf(p));if(o)for(g=0;g<4;g++)f=l[m+g],f>0&&(u.y3.FromFloat32ArrayToRefScaled(c,Math.floor(16*h[m+g]),f,p),_.addToSelf(p));u.P.TransformCoordinatesFromFloatsToRef(i._sourcePositions[e],i._sourcePositions[e+1],i._sourcePositions[e+2],_,d),d.toArray(s,e),t&&(u.P.TransformNormalFromFloatsToRef(i._sourceNormals[e],i._sourceNormals[e+1],i._sourceNormals[e+2],_,d),d.toArray(n,e)),_.reset()}return this.updateVerticesData(f.o.PositionKind,s),t&&this.updateVerticesData(f.o.NormalKind,n),this}static MinMax(e){let t=null,i=null;return e.forEach((function(e){const s=e.getBoundingInfo().boundingBox;t&&i?(t.minimizeInPlace(s.minimumWorld),i.maximizeInPlace(s.maximumWorld)):(t=s.minimumWorld,i=s.maximumWorld)})),t&&i?{min:t,max:i}:{min:u.P.Zero(),max:u.P.Zero()}}static Center(e){const t=e instanceof Array?F.MinMax(e):e;return u.P.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,s,n,r){return(0,o.s3)(F._MergeMeshesCoroutine(e,t,i,s,n,r,!1))}static MergeMeshesAsync(e,t=!0,i,s,n,r){return(0,o.sM)(F._MergeMeshesCoroutine(e,t,i,s,n,r,!0),(0,o.KO)())}static*_MergeMeshesCoroutine(e,t=!0,i,s,n,r,a){if(0===(e=e.filter(Boolean)).length)return null;let o;if(!i){let t=0;for(o=0;o<e.length;o++)if(t+=e[o].getTotalVertices(),t>=65536)return x.Y.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}r&&(n=!1);const h=new Array,l=new Array,u=new Array,c=e[0].overrideMaterialSideOrientation;for(o=0;o<e.length;o++){const t=e[o];if(t.isAnInstance)return x.Y.Warn("Cannot merge instance meshes."),null;if(c!==t.overrideMaterialSideOrientation)return x.Y.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(n&&u.push(t.getTotalIndices()),r)if(t.material){const e=t.material;if(e instanceof I.G){for(let t=0;t<e.subMaterials.length;t++)h.indexOf(e.subMaterials[t])<0&&h.push(e.subMaterials[t]);for(let i=0;i<t.subMeshes.length;i++)l.push(h.indexOf(e.subMaterials[t.subMeshes[i].materialIndex])),u.push(t.subMeshes[i].indexCount)}else{h.indexOf(e)<0&&h.push(e);for(let i=0;i<t.subMeshes.length;i++)l.push(h.indexOf(e)),u.push(t.subMeshes[i].indexCount)}}else for(let e=0;e<t.subMeshes.length;e++)l.push(0),u.push(t.subMeshes[e].indexCount)}const d=e[0],f=e=>{const t=e.computeWorldMatrix(!0);return{vertexData:_.x.ExtractFromMesh(e,!1,!1),transform:t}},{vertexData:p,transform:g}=f(d);a&&(yield);const v=new Array(e.length-1);for(let t=1;t<e.length;t++)v[t-1]=f(e[t]),a&&(yield);const T=p._mergeCoroutine(g,v,i,a,!t);let M=T.next();for(;!M.done;)a&&(yield),M=T.next();const E=M.value;s||(s=new F(d.name+"_merged",d.getScene()));const b=E._applyToCoroutine(s,void 0,a);let A=b.next();for(;!A.done;)a&&(yield),A=b.next();if(s.checkCollisions=d.checkCollisions,s.overrideMaterialSideOrientation=d.overrideMaterialSideOrientation,t)for(o=0;o<e.length;o++)e[o].dispose();if(n||r){s.releaseSubMeshes(),o=0;let e=0;for(;o<u.length;)m.P.CreateFromIndices(0,e,u[o],s,void 0,!1),e+=u[o],o++;for(const e of s.subMeshes)e.refreshBoundingInfo();s.computeWorldMatrix(!0)}if(r){const e=new I.G(d.name+"_merged",d.getScene());e.subMaterials=h;for(let e=0;e<s.subMeshes.length;e++)s.subMeshes[e].materialIndex=l[e];s.material=e}else s.material=d.material;return s}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(-1!=t){if(t!==this.instances.length-1){const e=this.instances[this.instances.length-1];this.instances[t]=e,e._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===v.F.CounterClockWiseSideOrientation}_getRenderingFillMode(e){var t;const i=this.getScene();return i.forcePointsCloud?v.F.PointFillMode:i.forceWireframe?v.F.WireFrameFillMode:null!==(t=this.overrideRenderingFillMode)&&void 0!==t?t:e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,s,n,r,a,o,h){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,s,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,s,n){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,s,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,s){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,s,n,r,a,o,h){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,s,n,r,a){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,s,n,r,a,o,h,l){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,s,n){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,s,n,r,a,o){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,s,n,r,a){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,s,n,r,a,o){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,s,n,r,a,o,h,l){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,s,n,r,a,o,h,l,u,c){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,s,n,r,a){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,s,n){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,s,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,s,n,r,a,o,h){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,s,n,r,a,o,h,l,u){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,s,n,r,a,o,h,l){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,s,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}}F.FRONTSIDE=_.x.FRONTSIDE,F.BACKSIDE=_.x.BACKSIDE,F.DOUBLESIDE=_.x.DOUBLESIDE,F.DEFAULTSIDE=_.x.DEFAULTSIDE,F.NO_CAP=0,F.CAP_START=1,F.CAP_END=2,F.CAP_ALL=3,F.NO_FLIP=0,F.FLIP_TILE=1,F.ROTATE_TILE=2,F.FLIP_ROW=3,F.ROTATE_ROW=4,F.FLIP_N_ROTATE_TILE=5,F.FLIP_N_ROTATE_ROW=6,F.CENTER=0,F.LEFT=1,F.RIGHT=2,F.TOP=3,F.BOTTOM=4,F.INSTANCEDMESH_SORT_TRANSPARENT=!1,F._GroundMeshParser=(e,t)=>{throw(0,b.S)("GroundMesh")},F._GoldbergMeshParser=(e,t)=>{throw(0,b.S)("GoldbergMesh")},F._LinesMeshParser=(e,t)=>{throw(0,b.S)("LinesMesh")},F._GreasedLineMeshParser=(e,t)=>{throw(0,b.S)("GreasedLineMesh")},F._TrailMeshParser=(e,t)=>{throw(0,b.S)("TrailMesh")},(0,E.H)("BABYLON.Mesh",F)},51902:(e,t,i)=>{function s(e,t,i){try{const s=e.next();s.done?t(s):s.value?s.value.then((()=>{s.value=void 0,t(s)}),i):t(s)}catch(e){i(e)}}function n(e=25){let t;return(i,n,r)=>{const a=performance.now();void 0===t||a-t>e?(t=a,setTimeout((()=>{s(i,n,r)}),0)):s(i,n,r)}}function r(e,t,i,s,n){const r=()=>{let a;const o=e=>{e.done?i(e.value):void 0===a?a=!0:r()};do{a=void 0,n&&n.aborted?s(new Error("Aborted")):t(e,o,s),void 0===a&&(a=!1)}while(a)};r()}function a(e,t){let i;return r(e,s,(e=>i=e),(e=>{throw e}),t),i}function o(e,t,i){return new Promise(((s,n)=>{r(e,t,s,n,i)}))}function h(e,t){return(...i)=>a(e(...i),t)}function l(e,t,i){return(...s)=>o(e(...s),t,i)}i.d(t,{KO:()=>n,U3:()=>l,WP:()=>s,d_:()=>r,s3:()=>a,sM:()=>o,vp:()=>h})}}]);
//# sourceMappingURL=619.babylonBundle.js.map