"use strict";(self.webpackChunkbabylonjs_typescript_webpack_template=self.webpackChunkbabylonjs_typescript_webpack_template||[]).push([[354,568],{8840:(e,t,i)=>{i.d(t,{Uf:()=>o,bq:()=>h,cw:()=>a,gP:()=>n});var s=i(80190),r=i(9827);class n{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}class o extends n{static get IsEqual(){return o._IsEqual}static get IsDifferent(){return o._IsDifferent}static get IsGreater(){return o._IsGreater}static get IsLesser(){return o._IsLesser}constructor(e,t,i,s,r=o.IsEqual){super(e),this.propertyPath=i,this.value=s,this.operator=r,this._target=t,this._effectiveTarget=this._getEffectiveTarget(t,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case o.IsGreater:return this._effectiveTarget[this._property]>this.value;case o.IsLesser:return this._effectiveTarget[this._property]<this.value;case o.IsEqual:case o.IsDifferent:{let e;return e=this.value.equals?this.value.equals(this._effectiveTarget[this._property]):this.value===this._effectiveTarget[this._property],this.operator===o.IsEqual?e:!e}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[s.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:s.a._SerializeValueAsString(this.value)},{name:"operator",value:o.GetOperatorName(this.operator)}]})}static GetOperatorName(e){switch(e){case o._IsEqual:return"IsEqual";case o._IsDifferent:return"IsDifferent";case o._IsGreater:return"IsGreater";case o._IsLesser:return"IsLesser";default:return""}}}o._IsEqual=0,o._IsDifferent=1,o._IsGreater=2,o._IsLesser=3;class a extends n{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}class h extends n{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[s.a._GetTargetProperty(this._target),{name:"value",value:this.value}]})}}(0,r.H)("BABYLON.ValueCondition",o),(0,r.H)("BABYLON.PredicateCondition",a),(0,r.H)("BABYLON.StateCondition",h)},56403:(e,t,i)=>{i.d(t,{BB:()=>d,Ct:()=>m,IA:()=>_,TC:()=>p,TI:()=>h,YF:()=>u,_2:()=>l,fQ:()=>g,sn:()=>c,zh:()=>a});var s=i(59288),r=i(90972),n=i(80190),o=i(9827);class a extends n.a{constructor(e,t,i,s){super(e,s),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[n.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}}class h extends n.a{constructor(e,t,i,s){super(e,s),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[n.a._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}class l extends n.a{constructor(e,t,i,s,r){super(e,r),this.propertyPath=i,this.value=s,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[n.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:n.a._SerializeValueAsString(this.value)}]},e)}}class c extends n.a{constructor(e,t,i,s,r){super(e,r),this.propertyPath=i,this.value=s,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),"number"!=typeof this._effectiveTarget[this._property]&&s.Y.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[n.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:n.a._SerializeValueAsString(this.value)}]},e)}}class u extends n.a{constructor(e,t,i,s,r,n){super(e,n),this.from=i,this.to=s,this.loop=r,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[n.a._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:n.a._SerializeValueAsString(this.loop)||!1}]},e)}}class d extends n.a{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[n.a._GetTargetProperty(this._target)]},e)}}class p extends n.a{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class _ extends n.a{constructor(e,t,i,s=!0){super(e,i),this.children=t,this.enableChildrenConditions=s}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(const t of this.children)this.enableChildrenConditions&&!t._evaluateConditionForCurrentFrame()||t.execute(e)}serialize(e){const t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let e=0;e<this.children.length;e++)t.combine.push(this.children[e].serialize(null));return t}}class g extends n.a{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}class m extends n.a{constructor(e,t,i,s){super(e,s),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;const e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=r.P.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[n.a._GetTargetProperty(this._target),n.a._GetTargetProperty(this._parent)]},e)}}(0,o.H)("BABYLON.SetParentAction",m),(0,o.H)("BABYLON.ExecuteCodeAction",g),(0,o.H)("BABYLON.DoNothingAction",p),(0,o.H)("BABYLON.StopAnimationAction",d),(0,o.H)("BABYLON.PlayAnimationAction",u),(0,o.H)("BABYLON.IncrementValueAction",c),(0,o.H)("BABYLON.SetValueAction",l),(0,o.H)("BABYLON.SetStateAction",h),(0,o.H)("BABYLON.SetParentAction",m),(0,o.H)("BABYLON.SwitchBooleanAction",a),(0,o.H)("BABYLON.CombineAction",_)},19779:(e,t,i)=>{i.d(t,{H:()=>c});var s=i(83427),r=i(13176),n=i(64673),o=i(8714),a=i(90972),h=i(46461),l=i(56614);class c{get syncRoot(){return this._syncRoot}get masterFrame(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){this._weight=-1!==e?Math.min(Math.max(e,0),1):-1}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,null!==this._goToFrame&&this.goToFrame(this._goToFrame)}constructor(e,t,i=0,s=100,r=!1,o=1,a,h,l,c=!1,u=0){this.target=t,this.fromFrame=i,this.toFrame=s,this.loopAnimation=r,this.onAnimationEnd=a,this.onAnimationLoop=l,this.isAdditive=c,this.playOrder=u,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new n.y$,this.onAnimationLoopObservable=new n.y$,this._scene=e,h&&this.appendAnimations(t,h),this._speedRatio=o,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const e=this._scene._activeAnimatables.indexOf(this);e>-1&&(this._scene._activeAnimatables.splice(e,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const s=t[i],n=new r.o(e,s,this._scene,this);n._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(n)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){var t;const i=this._runtimeAnimations;if(i[0]){const s=i[0].animation.framePerSecond;this._frameToSyncFromJump=null!==(t=this._frameToSyncFromJump)&&void 0!==t?t:i[0].currentFrame;const r=0===this.speedRatio?0:(e-this._frameToSyncFromJump)/s*1e3/this.speedRatio;this._manualJumpDelay=-r}for(let t=0;t<i.length;t++)i[t].goToFrame(e);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1){if(e||t){const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){const r=this._runtimeAnimations;for(let i=r.length-1;i>=0;i--){const s=r[i];e&&s.animation.name!=e||t&&!t(s.target)||(s.dispose(),r.splice(i,1))}0==r.length&&(i||this._scene._activeAnimatables.splice(s,1),this._raiseOnAnimationEnd())}}else{const e=this._scene._activeAnimatables.indexOf(this);if(e>-1){i||this._scene._activeAnimatables.splice(e,1);const t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].dispose();this._runtimeAnimations.length=0,this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise((e=>{this.onAnimationEndObservable.add((()=>{e(this)}),void 0,void 0,this,!0)}))}_animate(e){if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=e),!0;if(null===this._localDelayOffset?(this._localDelayOffset=e,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),null!==this._manualJumpDelay&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,0===this._weight)return!0;let t=!1;const i=this._runtimeAnimations;let s;for(s=0;s<i.length;s++){const r=i[s].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||r}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(s=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(s,1),s=0;s<i.length;s++)i[s].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}o.x.prototype._animate=function(){if(!this.animationsEnabled)return;const e=h.F.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=e}this.deltaTime=this.useConstantAnimationDeltaTime?16:(e-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=e;const t=this._activeAnimatables;if(0===t.length)return;this._animationTime+=this.deltaTime;const i=this._animationTime;for(let e=0;e<t.length;e++){const s=t[e];!s._animate(i)&&s.disposeOnEnd&&e--}this._processLateAnimationBindings()},o.x.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort(((e,t)=>e.playOrder-t.playOrder))},o.x.prototype.beginWeightedAnimation=function(e,t,i,s=1,r,n=1,o,a,h,l,c=!1){const u=this.beginAnimation(e,t,i,r,n,o,a,!1,h,l,c);return u.weight=s,u},o.x.prototype.beginAnimation=function(e,t,i,s,r=1,n,o,a=!0,h,l,u=!1){t>i&&r>0&&(r*=-1),a&&this.stopAnimation(e,void 0,h),o||(o=new c(this,e,t,i,s,r,n,void 0,l,u));const d=!h||h(e);if(e.animations&&d&&o.appendAnimations(e,e.animations),e.getAnimatables){const c=e.getAnimatables();for(let e=0;e<c.length;e++)this.beginAnimation(c[e],t,i,s,r,n,o,a,h,l)}return o.reset(),o},o.x.prototype.beginHierarchyAnimation=function(e,t,i,s,r,n=1,o,a,h=!0,l,c,u=!1){const d=e.getDescendants(t),p=[];p.push(this.beginAnimation(e,i,s,r,n,o,a,h,l,void 0,u));for(const e of d)p.push(this.beginAnimation(e,i,s,r,n,o,a,h,l,void 0,u));return p},o.x.prototype.beginDirectAnimation=function(e,t,i,s,r,n,o,a,h=!1){if(void 0===n&&(n=1),i>s&&n>0)n*=-1;else if(s>i&&n<0){const e=s;s=i,i=e}return new c(this,e,i,s,r,n,o,t,a,h)},o.x.prototype.beginDirectHierarchyAnimation=function(e,t,i,s,r,n,o,a,h,l=!1){const c=e.getDescendants(t),u=[];u.push(this.beginDirectAnimation(e,i,s,r,n,o,a,h,l));for(const e of c)u.push(this.beginDirectAnimation(e,i,s,r,n,o,a,h,l));return u},o.x.prototype.getAnimatableByTarget=function(e){for(let t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return this._activeAnimatables[t];return null},o.x.prototype.getAllAnimatablesByTarget=function(e){const t=[];for(let i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i].target===e&&t.push(this._activeAnimatables[i]);return t},o.x.prototype.stopAnimation=function(e,t,i){const s=this.getAllAnimatablesByTarget(e);for(const e of s)e.stop(t,i)},o.x.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const e of this.animationGroups)e.stop()},o.x.prototype._registerTargetForLateAnimationBinding=function(e,t){const i=e.target;this._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[e.targetPath]||(i._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:t}),e.isAdditive?(i._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),i._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(i._lateAnimationHolders[e.targetPath].animations.push(e),i._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)},o.x.prototype._processLateAnimationBindingsForMatrices=function(e){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return e.originalValue;let t=1;const i=a.jp.Vector3[0],s=a.jp.Vector3[1],r=a.jp.Quaternion[0];let n=0;const o=e.animations[0],h=e.originalValue;let l=1,c=!1;if(e.totalWeight<1)l=1-e.totalWeight,h.decompose(s,r,i);else{if(n=1,t=e.totalWeight,l=o.weight/t,1==l){if(!e.totalAdditiveWeight)return o.currentValue;c=!0}o.currentValue.decompose(s,r,i)}if(!c){s.scaleInPlace(l),i.scaleInPlace(l),r.scaleInPlace(l);for(let o=n;o<e.animations.length;o++){const n=e.animations[o];if(0===n.weight)continue;l=n.weight/t;const h=a.jp.Vector3[2],c=a.jp.Vector3[3],u=a.jp.Quaternion[1];n.currentValue.decompose(c,u,h),c.scaleAndAddToRef(l,s),u.scaleAndAddToRef(a._f.Dot(r,u)>0?l:-l,r),h.scaleAndAddToRef(l,i)}r.normalize()}for(let t=0;t<e.additiveAnimations.length;t++){const n=e.additiveAnimations[t];if(0===n.weight)continue;const o=a.jp.Vector3[2],h=a.jp.Vector3[3],l=a.jp.Quaternion[1];n.currentValue.decompose(h,l,o),h.multiplyToRef(s,h),a.P.LerpToRef(s,h,n.weight,s),r.multiplyToRef(l,l),a._f.SlerpToRef(r,l,n.weight,r),o.scaleAndAddToRef(n.weight,i)}const u=o?o._animationState.workValue:a.jp.Matrix[0].clone();return a.y3.ComposeToRef(s,r,i,u),u},o.x.prototype._processLateAnimationBindingsForQuaternions=function(e,t){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return t;const i=e.animations[0],s=e.originalValue;let r=t;if(0===e.totalWeight&&e.totalAdditiveWeight>0)r.copyFrom(s);else if(1===e.animations.length){if(a._f.SlerpToRef(s,i.currentValue,Math.min(1,e.totalWeight),r),0===e.totalAdditiveWeight)return r}else if(e.animations.length>1){let i,n,o=1;if(e.totalWeight<1){const t=1-e.totalWeight;i=[],n=[],i.push(s),n.push(t)}else{if(2===e.animations.length&&(a._f.SlerpToRef(e.animations[0].currentValue,e.animations[1].currentValue,e.animations[1].weight/e.totalWeight,t),0===e.totalAdditiveWeight))return t;i=[],n=[],o=e.totalWeight}for(let t=0;t<e.animations.length;t++){const s=e.animations[t];i.push(s.currentValue),n.push(s.weight/o)}let h=0;for(let e=0;e<i.length;)e?(h+=n[e],a._f.SlerpToRef(r,i[e],n[e]/h,r),e++):(a._f.SlerpToRef(i[e],i[e+1],n[e+1]/(n[e]+n[e+1]),t),r=t,h=n[e]+n[e+1],e+=2)}for(let t=0;t<e.additiveAnimations.length;t++){const i=e.additiveAnimations[t];0!==i.weight&&(r.multiplyToRef(i.currentValue,a.jp.Quaternion[0]),a._f.SlerpToRef(r,a.jp.Quaternion[0],i.weight,r))}return r},o.x.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(let e=0;e<this._registeredForLateAnimationBindings.length;e++){const t=this._registeredForLateAnimationBindings.data[e];for(const e in t._lateAnimationHolders){const i=t._lateAnimationHolders[e],r=i.animations[0],n=i.originalValue;if(null==n)continue;const o=s.f.AllowMatrixDecomposeForInterpolation&&n.m;let h=t[e];if(o)h=this._processLateAnimationBindingsForMatrices(i);else if(void 0!==n.w)h=this._processLateAnimationBindingsForQuaternions(i,h||a._f.Identity());else{let e=0,t=1;if(i.totalWeight<1)h=r&&n.scale?n.scale(1-i.totalWeight):r?n*(1-i.totalWeight):n.clone?n.clone():n;else if(r){t=i.totalWeight;const s=r.weight/t;h=1!==s?r.currentValue.scale?r.currentValue.scale(s):r.currentValue*s:r.currentValue,e=1}for(let s=e;s<i.animations.length;s++){const e=i.animations[s],r=e.weight/t;r&&(e.currentValue.scaleAndAddToRef?e.currentValue.scaleAndAddToRef(r,h):h+=e.currentValue*r)}for(let e=0;e<i.additiveAnimations.length;e++){const t=i.additiveAnimations[e],s=t.weight;s&&(t.currentValue.scaleAndAddToRef?t.currentValue.scaleAndAddToRef(s,h):h+=t.currentValue*s)}}t[e]=h}t._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}},l.N.prototype.copyAnimationRange=function(e,t,i,r=!1,n=null){0===this.animations.length&&(this.animations.push(new s.f(this.name,"_matrix",e.animations[0].framePerSecond,s.f.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const o=e.animations[0].getRange(t);if(!o)return!1;const a=o.from,h=o.to,l=e.animations[0].getKeys(),c=e.length,u=e.getParent(),d=this.getParent(),p=r&&u&&c&&this.length&&c!==this.length,_=p&&d&&u?d.length/u.length:1,g=r&&!d&&n&&(1!==n.x||1!==n.y||1!==n.z),m=this.animations[0].getKeys();let f,b,v;for(let e=0,t=l.length;e<t;e++)f=l[e],f.frame>=a&&f.frame<=h&&(r?(v=f.value.clone(),p?(b=v.getTranslation(),v.setTranslation(b.scaleInPlace(_))):g&&n?(b=v.getTranslation(),v.setTranslation(b.multiplyInPlace(n))):v=f.value):v=f.value,m.push({frame:f.frame+i,value:v}));return this.animations[0].createRange(t,a+i,h+i),!0}},73730:(e,t,i)=>{i.d(t,{N:()=>l});var s=i(87257),r=i(8714),n=i(50147),o=i(90972),a=i(64673),h=i(95593);class l{constructor(){this._attachedToElement=!1,this._virtualMeshesInfo={},this._tmpVector=new o.P,this._tmpQuaternion=new o._f,this._dragType={NONE:0,DRAG:1,DRAG_WITH_CONTROLLER:2,NEAR_DRAG:3},this._moving=!1,this._dragging=this._dragType.NONE,this.draggableMeshes=null,this.zDragFactor=3,this.currentDraggingPointerIds=[],this.detachCameraControls=!0,this.onDragStartObservable=new a.y$,this.onDragObservable=new a.y$,this.onDragEndObservable=new a.y$,this.allowMultiPointer=!0}get currentDraggingPointerId(){return void 0!==this.currentDraggingPointerIds[0]?this.currentDraggingPointerIds[0]:-1}set currentDraggingPointerId(e){this.currentDraggingPointerIds[0]=e}get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}get name(){return"BaseSixDofDrag"}get isMoving(){return this._moving}init(){}get _pointerCamera(){return this._scene.cameraToUseForPointers?this._scene.cameraToUseForPointers:this._scene.activeCamera}_createVirtualMeshInfo(){const e=new s.x("",l._virtualScene);e.rotationQuaternion=new o._f;const t=new s.x("",l._virtualScene);t.rotationQuaternion=new o._f;const i=new s.x("",l._virtualScene);return i.rotationQuaternion=new o._f,{dragging:!1,moving:!1,dragMesh:e,originMesh:t,pivotMesh:i,startingPivotPosition:new o.P,startingPivotOrientation:new o._f,startingPosition:new o.P,startingOrientation:new o._f,lastOriginPosition:new o.P,lastDragPosition:new o.P}}_resetVirtualMeshesPosition(){for(let e=0;e<this.currentDraggingPointerIds.length;e++)this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.rotationQuaternion)}_pointerUpdate2D(e,t,i){!this._pointerCamera||this._pointerCamera.cameraRigMode!=h.V.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||(e.origin.copyFrom(this._pointerCamera.globalPosition),i=0);const s=this._virtualMeshesInfo[t],r=o.jp.Vector3[0];e.origin.subtractToRef(s.lastOriginPosition,r),s.lastOriginPosition.copyFrom(e.origin);const n=-o.P.Dot(r,e.direction);s.originMesh.addChild(s.dragMesh),s.originMesh.addChild(s.pivotMesh),this._applyZOffset(s.dragMesh,n,i),this._applyZOffset(s.pivotMesh,n,i),s.originMesh.position.copyFrom(e.origin);const a=o.jp.Vector3[0];e.origin.addToRef(e.direction,a),s.originMesh.lookAt(a),s.originMesh.removeChild(s.dragMesh),s.originMesh.removeChild(s.pivotMesh)}_pointerUpdateXR(e,t,i,s){const r=this._virtualMeshesInfo[i];if(r.originMesh.position.copyFrom(e.position),this._dragging===this._dragType.NEAR_DRAG&&t?r.originMesh.rotationQuaternion.copyFrom(t.rotationQuaternion):r.originMesh.rotationQuaternion.copyFrom(e.rotationQuaternion),r.pivotMesh.computeWorldMatrix(!0),r.dragMesh.computeWorldMatrix(!0),0!==s){const e=o.jp.Vector3[0],t=o.jp.Vector3[1];e.copyFrom(this._pointerCamera.getForwardRay().direction),r.originMesh.position.subtractToRef(r.lastOriginPosition,t),r.lastOriginPosition.copyFrom(r.originMesh.position);const i=t.length();t.normalize();const n=o.jp.Vector3[2],a=o.jp.Vector3[3];r.dragMesh.absolutePosition.subtractToRef(this._pointerCamera.globalPosition,n),r.dragMesh.absolutePosition.subtractToRef(r.originMesh.position,a);const h=a.length();n.normalize(),a.normalize();let l=Math.abs(o.P.Dot(t,a))*o.P.Dot(t,e)*s*i*h;const c=.01;l<0&&c-h>l&&(l=Math.min(c-h,0)),a.scaleInPlace(l),a.addToRef(r.pivotMesh.absolutePosition,this._tmpVector),r.pivotMesh.setAbsolutePosition(this._tmpVector),a.addToRef(r.dragMesh.absolutePosition,this._tmpVector),r.dragMesh.setAbsolutePosition(this._tmpVector)}}attach(e){this._ownerNode=e,this._scene=this._ownerNode.getScene(),l._virtualScene||(l._virtualScene=new r.x(this._scene.getEngine(),{virtual:!0}),l._virtualScene.detachControl());const t=e=>this._ownerNode===e||e.isDescendantOf(this._ownerNode)&&(!this.draggableMeshes||-1!==this.draggableMeshes.indexOf(e));this._pointerObserver=this._scene.onPointerObservable.add((e=>{const i=e.event.pointerId;this._virtualMeshesInfo[i]||(this._virtualMeshesInfo[i]=this._createVirtualMeshInfo());const s=this._virtualMeshesInfo[i],r="xr-near"===e.event.pointerType;if(e.type==n.kD.POINTERDOWN){if(!s.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&(!r||e.pickInfo.aimTransform)&&t(e.pickInfo.pickedMesh)){if(!this.allowMultiPointer&&this.currentDraggingPointerIds.length>0)return;!this._pointerCamera||this._pointerCamera.cameraRigMode!==h.V.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||e.pickInfo.ray.origin.copyFrom(this._pointerCamera.globalPosition),this._ownerNode.computeWorldMatrix(!0);const t=this._virtualMeshesInfo[i];r?(this._dragging=e.pickInfo.originMesh?this._dragType.NEAR_DRAG:this._dragType.DRAG_WITH_CONTROLLER,t.originMesh.position.copyFrom(e.pickInfo.aimTransform.position),this._dragging===this._dragType.NEAR_DRAG&&e.pickInfo.gripTransform?t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.gripTransform.rotationQuaternion):t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.aimTransform.rotationQuaternion)):(this._dragging=this._dragType.DRAG,t.originMesh.position.copyFrom(e.pickInfo.ray.origin)),t.lastOriginPosition.copyFrom(t.originMesh.position),t.dragMesh.position.copyFrom(e.pickInfo.pickedPoint),t.lastDragPosition.copyFrom(e.pickInfo.pickedPoint),t.pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),t.pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.absoluteRotationQuaternion),t.startingPosition.copyFrom(t.dragMesh.position),t.startingPivotPosition.copyFrom(t.pivotMesh.position),t.startingOrientation.copyFrom(t.dragMesh.rotationQuaternion),t.startingPivotOrientation.copyFrom(t.pivotMesh.rotationQuaternion),r?(t.originMesh.addChild(t.dragMesh),t.originMesh.addChild(t.pivotMesh)):t.originMesh.lookAt(t.dragMesh.position),t.dragging=!0,-1===this.currentDraggingPointerIds.indexOf(i)&&this.currentDraggingPointerIds.push(i),this.detachCameraControls&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._pointerCamera.inputs&&this._pointerCamera.inputs.attachedToElement?(this._pointerCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1),this._targetDragStart(t.pivotMesh.position,t.pivotMesh.rotationQuaternion,i),this.onDragStartObservable.notifyObservers({position:t.pivotMesh.position})}}else if(e.type==n.kD.POINTERUP||e.type==n.kD.POINTERDOUBLETAP){const e=this.currentDraggingPointerIds.indexOf(i);s.dragging=!1,-1!==e&&(this.currentDraggingPointerIds.splice(e,1),0===this.currentDraggingPointerIds.length&&(this._moving=!1,this._dragging=this._dragType.NONE,this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1)),s.originMesh.removeChild(s.dragMesh),s.originMesh.removeChild(s.pivotMesh),this._targetDragEnd(i),this.onDragEndObservable.notifyObservers({}))}else if(e.type==n.kD.POINTERMOVE&&-1!==this.currentDraggingPointerIds.indexOf(i)&&s.dragging&&e.pickInfo&&(e.pickInfo.ray||e.pickInfo.aimTransform)){let t=this.zDragFactor;(this.currentDraggingPointerIds.length>1||e.pickInfo.originMesh)&&(t=0),this._ownerNode.computeWorldMatrix(!0),r?this._pointerUpdateXR(e.pickInfo.aimTransform,e.pickInfo.gripTransform,i,t):this._pointerUpdate2D(e.pickInfo.ray,i,t),this._tmpQuaternion.copyFrom(s.startingPivotOrientation),this._tmpQuaternion.x=-this._tmpQuaternion.x,this._tmpQuaternion.y=-this._tmpQuaternion.y,this._tmpQuaternion.z=-this._tmpQuaternion.z,s.pivotMesh.absoluteRotationQuaternion.multiplyToRef(this._tmpQuaternion,this._tmpQuaternion),s.pivotMesh.absolutePosition.subtractToRef(s.startingPivotPosition,this._tmpVector),this.onDragObservable.notifyObservers({delta:this._tmpVector,position:s.pivotMesh.position,pickInfo:e.pickInfo}),this._targetDrag(this._tmpVector,this._tmpQuaternion,i),s.lastDragPosition.copyFrom(s.dragMesh.absolutePosition),this._moving=!0}}))}_applyZOffset(e,t,i){e.position.z-=e.position.z<1?t*i:t*i*e.position.z,e.position.z<0&&(e.position.z=0)}_targetDragStart(e,t,i){}_targetDrag(e,t,i){}_targetDragEnd(e){}_reattachCameraControls(){if(this._pointerCamera)if("ArcRotateCamera"===this._pointerCamera.getClassName()){const e=this._pointerCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._pointerCamera.attachControl(!this._pointerCamera.inputs||this._pointerCamera.inputs.noPreventDefault)}detach(){this._scene&&(this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1),this._scene.onPointerObservable.remove(this._pointerObserver));for(const e in this._virtualMeshesInfo)this._virtualMeshesInfo[e].originMesh.dispose(),this._virtualMeshesInfo[e].dragMesh.dispose();this.onDragEndObservable.clear(),this.onDragObservable.clear(),this.onDragStartObservable.clear()}}},17358:(e,t,i)=>{i.d(t,{Y:()=>s});class s{get delay(){return this.fadeInDelay}set delay(e){this.fadeInDelay=e,this.fadeOutDelay=e}constructor(){this.fadeInDelay=0,this.fadeOutDelay=0,this.fadeInTime=300,this.fadeOutTime=300,this._millisecondsPerFrame=1e3/60,this._hovered=!1,this._hoverValue=0,this._ownerNode=null,this._delay=0,this._time=300,this._update=()=>{if(this._ownerNode){if(this._hoverValue+=this._hovered?this._millisecondsPerFrame:-this._millisecondsPerFrame,this._setAllVisibility(this._ownerNode,(this._hoverValue-this._delay)/this._time),this._ownerNode.visibility>1){if(this._setAllVisibility(this._ownerNode,1),this._hoverValue>this._time)return this._hoverValue=this._time,void this._detachObserver()}else if(this._ownerNode.visibility<0&&(this._setAllVisibility(this._ownerNode,0),this._hoverValue<0))return this._hoverValue=0,void this._detachObserver();this._attachObserver()}}}get name(){return"FadeInOut"}init(){}attach(e){this._ownerNode=e,this._setAllVisibility(this._ownerNode,0)}detach(){this._ownerNode=null}fadeIn(e=!0){this._delay=e?this.fadeInDelay:this.fadeOutDelay,this._time=e?this.fadeInTime:this.fadeOutTime,this._detachObserver(),this._ownerNode&&(e&&this._ownerNode.visibility>=1||!e&&this._ownerNode.visibility<=0)||(this._hovered=e,this._hovered||(this._delay*=-1),this._ownerNode.visibility>=1?this._hoverValue=this._time:this._ownerNode.visibility<=0&&(this._hoverValue=0),this._update())}fadeOut(){this.fadeIn(!1)}_setAllVisibility(e,t){e.visibility=t,e.getChildMeshes().forEach((e=>{this._setAllVisibility(e,t)}))}_attachObserver(){var e;this._onBeforeRenderObserver||(this._onBeforeRenderObserver=null===(e=this._ownerNode)||void 0===e?void 0:e.getScene().onBeforeRenderObservable.add(this._update))}_detachObserver(){var e;this._onBeforeRenderObserver&&(null===(e=this._ownerNode)||void 0===e||e.getScene().onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=null)}}},12727:(e,t,i)=>{i.d(t,{j:()=>o});var s=i(90972),r=i(31865),n=i(7786);class o{constructor(){this._tmpQuaternion=new s._f,this._tmpVectors=[new s.P,new s.P,new s.P,new s.P,new s.P,new s.P,new s.P],this._tmpMatrix=new s.y3,this._tmpInvertView=new s.y3,this._tmpForward=new s.P,this._tmpNodeForward=new s.P,this._tmpPosition=new s.P,this._workingPosition=new s.P,this._workingQuaternion=new s._f,this._lastTick=-1,this._recenterNextUpdate=!0,this.interpolatePose=!0,this.lerpTime=500,this.ignoreCameraPitchAndRoll=!1,this.pitchOffset=15,this.maxViewVerticalDegrees=30,this.maxViewHorizontalDegrees=30,this.orientToCameraDeadzoneDegrees=60,this.ignoreDistanceClamp=!1,this.ignoreAngleClamp=!1,this.verticalMaxDistance=0,this.defaultDistance=.8,this.maximumDistance=2,this.minimumDistance=.3,this.useFixedVerticalOffset=!1,this.fixedVerticalOffset=0,this._enabled=!0}get followedCamera(){return this._followedCamera||this._scene.activeCamera}set followedCamera(e){this._followedCamera=e}get name(){return"Follow"}init(){}attach(e,t){this._scene=e.getScene(),this.attachedNode=e,t&&(this.followedCamera=t),this._addObservables()}detach(){this.attachedNode=null,this._removeObservables()}recenter(){this._recenterNextUpdate=!0}_angleBetweenVectorAndPlane(e,t){return this._tmpVectors[0].copyFrom(e),e=this._tmpVectors[0],this._tmpVectors[1].copyFrom(t),t=this._tmpVectors[1],e.normalize(),t.normalize(),Math.PI/2-Math.acos(s.P.Dot(e,t))}_length2D(e){return Math.sqrt(e.x*e.x+e.z*e.z)}_distanceClamp(e,t=!1){let i=this.minimumDistance,s=this.maximumDistance;const n=this.defaultDistance,o=this._tmpVectors[0];o.copyFrom(e);let a=o.length();if(o.normalizeFromLength(a),this.ignoreCameraPitchAndRoll){i=this._length2D(o)*i,s=this._length2D(o)*s;const t=this._length2D(e);o.scaleInPlace(a/t),a=t}let h=a;return h=t?n:r.R.Clamp(a,i,s),e.copyFrom(o).scaleInPlace(h),a!==h}_applyVerticalClamp(e){0!==this.verticalMaxDistance&&(e.y=r.R.Clamp(e.y,-this.verticalMaxDistance,this.verticalMaxDistance))}_toOrientationQuatToRef(e,t){s._f.RotationYawPitchRollToRef(Math.atan2(e.x,e.z),Math.atan2(e.y,Math.sqrt(e.z*e.z+e.x*e.x)),0,t)}_applyPitchOffset(e){const t=this._tmpVectors[0],i=this._tmpVectors[1];t.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),i.copyFromFloats(1,0,0),s.P.TransformNormalToRef(t,e,t),t.y=0,t.normalize(),s.P.TransformNormalToRef(i,e,i),s._f.RotationAxisToRef(i,this.pitchOffset*Math.PI/180,this._tmpQuaternion),t.rotateByQuaternionToRef(this._tmpQuaternion,t),this._toOrientationQuatToRef(t,this._tmpQuaternion),this._tmpQuaternion.toRotationMatrix(this._tmpMatrix),e.copyFrom(this._tmpMatrix)}_angularClamp(e,t){const i=this._tmpVectors[5];i.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1);const r=this._tmpVectors[6];r.copyFromFloats(1,0,0),s.P.TransformNormalToRef(i,e,i),s.P.TransformNormalToRef(r,e,r);const o=s.P.UpReadOnly;if(t.length()<n.kn)return!1;let a=!1;const h=this._tmpQuaternion;if(this.ignoreCameraPitchAndRoll){const e=s.P.GetAngleBetweenVectorsOnPlane(t,i,r);s._f.RotationAxisToRef(r,e,h),t.rotateByQuaternionToRef(h,t)}else{const e=-s.P.GetAngleBetweenVectorsOnPlane(t,i,r),n=this.maxViewVerticalDegrees*Math.PI/180*.5;e<-n?(s._f.RotationAxisToRef(r,-e-n,h),t.rotateByQuaternionToRef(h,t),a=!0):e>n&&(s._f.RotationAxisToRef(r,-e+n,h),t.rotateByQuaternionToRef(h,t),a=!0)}const l=this._angleBetweenVectorAndPlane(t,r)*(this._scene.useRightHandedSystem?-1:1),c=this.maxViewHorizontalDegrees*Math.PI/180*.5;return l<-c?(s._f.RotationAxisToRef(o,-l-c,h),t.rotateByQuaternionToRef(h,t),a=!0):l>c&&(s._f.RotationAxisToRef(o,-l+c,h),t.rotateByQuaternionToRef(h,t),a=!0),a}_orientationClamp(e,t){var i;const r=this._tmpVectors[0];r.copyFrom(e).scaleInPlace(-1).normalize();const o=this._tmpVectors[1],a=this._tmpVectors[2];o.copyFromFloats(0,1,0),s.P.CrossToRef(r,o,a);const h=a.length();h<n.kn||(a.normalizeFromLength(h),s.P.CrossToRef(a,r,o),(null===(i=this.attachedNode)||void 0===i?void 0:i.getScene().useRightHandedSystem)?s._f.FromLookDirectionRHToRef(r,o,t):s._f.FromLookDirectionLHToRef(r,o,t))}_passedOrientationDeadzone(e,t){const i=this._tmpVectors[5];return i.copyFrom(e),i.normalize(),180*Math.abs(s.P.GetAngleBetweenVectorsOnPlane(t,i,s.P.UpReadOnly))/Math.PI>this.orientToCameraDeadzoneDegrees}_updateLeashing(e){if(this.attachedNode&&this._enabled){const t=this.attachedNode.parent;this.attachedNode.setParent(null);const i=this.attachedNode.getWorldMatrix(),r=this._workingPosition,n=this._workingQuaternion,o=this.attachedNode.getPivotPoint(),a=this._tmpInvertView;a.copyFrom(e.getViewMatrix()),a.invert(),s.P.TransformCoordinatesToRef(o,i,r);const h=this._tmpPosition;h.copyFromFloats(0,0,0),s.P.TransformCoordinatesToRef(h,i,h),h.scaleInPlace(-1).subtractInPlace(o),r.subtractInPlace(e.globalPosition),this.ignoreCameraPitchAndRoll&&this._applyPitchOffset(a);let l=!1;const c=this._tmpForward;c.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),s.P.TransformNormalToRef(c,a,c);const u=this._tmpNodeForward;if(u.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),s.P.TransformNormalToRef(u,i,u),this._recenterNextUpdate)r.copyFrom(c).scaleInPlace(this.defaultDistance);else if(this.ignoreAngleClamp){const e=r.length();r.copyFrom(c).scaleInPlace(e)}else l=this._angularClamp(a,r);let d=!1;this.ignoreDistanceClamp||(d=this._distanceClamp(r,l),this._applyVerticalClamp(r)),this.useFixedVerticalOffset&&(r.y=h.y-e.globalPosition.y+this.fixedVerticalOffset),(l||d||this._passedOrientationDeadzone(r,u)||this._recenterNextUpdate)&&this._orientationClamp(r,n),this._workingPosition.subtractInPlace(o),this._recenterNextUpdate=!1,this.attachedNode.setParent(t)}}_updateTransformToGoal(e){if(!this.attachedNode||!this.followedCamera||!this._enabled)return;this.attachedNode.rotationQuaternion||(this.attachedNode.rotationQuaternion=s._f.Identity());const t=this.attachedNode.parent;if(this.attachedNode.setParent(null),!this.interpolatePose)return this.attachedNode.position.copyFrom(this.followedCamera.globalPosition).addInPlace(this._workingPosition),void this.attachedNode.rotationQuaternion.copyFrom(this._workingQuaternion);const i=new s.P;i.copyFrom(this.attachedNode.position).subtractInPlace(this.followedCamera.globalPosition),s.P.SmoothToRef(i,this._workingPosition,e,this.lerpTime,i),i.addInPlace(this.followedCamera.globalPosition),this.attachedNode.position.copyFrom(i);const r=new s._f;r.copyFrom(this.attachedNode.rotationQuaternion),s._f.SmoothToRef(r,this._workingQuaternion,e,this.lerpTime,this.attachedNode.rotationQuaternion),this.attachedNode.setParent(t)}_addObservables(){this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add((()=>{if(!this.followedCamera)return;const e=Date.now();this._updateLeashing(this.followedCamera),this._updateTransformToGoal(e-this._lastTick),this._lastTick=e}))}_removeObservables(){this._onBeforeRender&&this._scene.onBeforeRenderObservable.remove(this._onBeforeRender)}}},68954:(e,t,i)=>{i.d(t,{$6:()=>s,bH:()=>n,q_:()=>c,rX:()=>r});var s,r,n,o=i(17249),a=i(96985),h=i(90972),l=i(14651);!function(e){e[e.ABOVE_FINGER_TIPS=0]="ABOVE_FINGER_TIPS",e[e.RADIAL_SIDE=1]="RADIAL_SIDE",e[e.ULNAR_SIDE=2]="ULNAR_SIDE",e[e.BELOW_WRIST=3]="BELOW_WRIST"}(s||(s={})),function(e){e[e.LOOK_AT_CAMERA=0]="LOOK_AT_CAMERA",e[e.HAND_ROTATION=1]="HAND_ROTATION"}(r||(r={})),function(e){e[e.ALWAYS_VISIBLE=0]="ALWAYS_VISIBLE",e[e.PALM_UP=1]="PALM_UP",e[e.GAZE_FOCUS=2]="GAZE_FOCUS",e[e.PALM_AND_GAZE=3]="PALM_AND_GAZE"}(n||(n={}));class c{constructor(){this._sceneRenderObserver=null,this._zoneAxis={},this.handConstraintVisibility=n.PALM_AND_GAZE,this.palmUpStrictness=.95,this.gazeProximityRadius=.15,this.targetOffset=.1,this.targetZone=s.ULNAR_SIDE,this.zoneOrientationMode=r.HAND_ROTATION,this.nodeOrientationMode=r.HAND_ROTATION,this.handedness="none",this.lerpTime=100,this._zoneAxis[s.ABOVE_FINGER_TIPS]=new h.P(0,1,0),this._zoneAxis[s.RADIAL_SIDE]=new h.P(-1,0,0),this._zoneAxis[s.ULNAR_SIDE]=new h.P(1,0,0),this._zoneAxis[s.BELOW_WRIST]=new h.P(0,-1,0)}get name(){return"HandConstraint"}enable(){this._node.setEnabled(!0)}disable(){this._node.setEnabled(!1)}_getHandPose(){if(!this._handTracking)return null;let e;if(e="none"===this.handedness?this._handTracking.getHandByHandedness("left")||this._handTracking.getHandByHandedness("right"):this._handTracking.getHandByHandedness(this.handedness),e){const t=e.getJointMesh(a.fL.PINKY_FINGER_METACARPAL),i=e.getJointMesh(a.fL.MIDDLE_FINGER_METACARPAL),s=e.getJointMesh(a.fL.WRIST);if(s&&i&&t){const r={position:i.absolutePosition,quaternion:new h._f,id:e.xrController.uniqueId},n=h.jp.Vector3[0],o=h.jp.Vector3[1],a=h.jp.Vector3[2];return n.copyFrom(i.absolutePosition).subtractInPlace(s.absolutePosition).normalize(),o.copyFrom(t.absolutePosition).subtractInPlace(i.absolutePosition).normalize(),h.P.CrossToRef(n,o,o),h.P.CrossToRef(o,n,a),h._f.FromLookDirectionLHToRef(o,n,r.quaternion),r}}return null}init(){}attach(e){this._node=e,this._scene=e.getScene(),this._node.rotationQuaternion||(this._node.rotationQuaternion=h._f.RotationYawPitchRoll(this._node.rotation.y,this._node.rotation.x,this._node.rotation.z));let t=Date.now();this._sceneRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{const e=this._getHandPose();if(this._node.reservedDataStore=this._node.reservedDataStore||{},this._node.reservedDataStore.nearInteraction=this._node.reservedDataStore.nearInteraction||{},this._node.reservedDataStore.nearInteraction.excludedControllerId=null,e){const i=h.jp.Vector3[0],s=this._scene.activeCamera;i.copyFrom(this._zoneAxis[this.targetZone]);const n=h.jp.Quaternion[0];if(s&&(this.zoneOrientationMode===r.LOOK_AT_CAMERA||this.nodeOrientationMode===r.LOOK_AT_CAMERA)){const t=h.jp.Vector3[1];t.copyFrom(s.position).subtractInPlace(e.position).normalize(),this._scene.useRightHandedSystem?h._f.FromLookDirectionRHToRef(t,h.P.UpReadOnly,n):h._f.FromLookDirectionLHToRef(t,h.P.UpReadOnly,n)}this.zoneOrientationMode===r.HAND_ROTATION?e.quaternion.toRotationMatrix(h.jp.Matrix[0]):n.toRotationMatrix(h.jp.Matrix[0]),h.P.TransformNormalToRef(i,h.jp.Matrix[0],i),i.scaleInPlace(this.targetOffset);const o=h.jp.Vector3[2],a=h.jp.Quaternion[1];o.copyFrom(e.position).addInPlace(i),this.nodeOrientationMode===r.HAND_ROTATION?a.copyFrom(e.quaternion):a.copyFrom(n);const l=Date.now()-t;h.P.SmoothToRef(this._node.position,o,l,this.lerpTime,this._node.position),h._f.SmoothToRef(this._node.rotationQuaternion,a,l,this.lerpTime,this._node.rotationQuaternion),this._node.reservedDataStore.nearInteraction.excludedControllerId=e.id}this._setVisibility(e),t=Date.now()}))}_setVisibility(e){let t=!0,i=!0;const s=this._scene.activeCamera;if(s){const r=s.getForwardRay();if(this.handConstraintVisibility===n.GAZE_FOCUS||this.handConstraintVisibility===n.PALM_AND_GAZE){let t;i=!1,this._eyeTracking&&(t=this._eyeTracking.getEyeGaze()),t=t||r;const s=h.jp.Vector3[0];e?e.position.subtractToRef(t.origin,s):this._node.getAbsolutePosition().subtractToRef(t.origin,s);const n=h.P.Dot(s,t.direction),o=n*n;n>0&&s.lengthSquared()-o<this.gazeProximityRadius*this.gazeProximityRadius&&(i=!0)}if((this.handConstraintVisibility===n.PALM_UP||this.handConstraintVisibility===n.PALM_AND_GAZE)&&(t=!1,e)){const i=h.jp.Vector3[0];h.P.LeftHandedForwardReadOnly.rotateByQuaternionToRef(e.quaternion,i),h.P.Dot(i,r.direction)>2*this.palmUpStrictness-1&&(t=!0)}}this._node.setEnabled(t&&i)}detach(){this._scene.onBeforeRenderObservable.remove(this._sceneRenderObserver)}linkToXRExperience(e){const t=e.featuresManager?e.featuresManager:e;if(t){try{this._eyeTracking=t.getEnabledFeature(o.b.EYE_TRACKING)}catch(e){}try{this._handTracking=t.getEnabledFeature(o.b.HAND_TRACKING)}catch(e){l.w1.Error("Hand tracking must be enabled for the Hand Menu to work")}}else l.w1.Error("XR features manager must be available or provided directly for the Hand Menu to work")}}},5377:(e,t,i)=>{i.d(t,{K:()=>h});var s=i(90972),r=i(64673),n=i(73730),o=i(44482),a=i(730);class h extends n.N{constructor(){super(...arguments),this._sceneRenderObserver=null,this._targetPosition=new s.P(0,0,0),this._targetOrientation=new s._f,this._targetScaling=new s.P(1,1,1),this._startingPosition=new s.P(0,0,0),this._startingOrientation=new s._f,this._startingScaling=new s.P(1,1,1),this.onPositionChangedObservable=new r.y$,this.dragDeltaRatio=.2,this.rotateDraggedObject=!0,this.rotateAroundYOnly=!1,this.rotateWithMotionController=!0,this.disableMovement=!1,this.faceCameraOnDragStart=!1}get name(){return"SixDofDrag"}attach(e){super.attach(e),e.isNearGrabbable=!0,this._virtualTransformNode=new o.Y("virtual_sixDof",n.N._virtualScene),this._virtualTransformNode.rotationQuaternion=s._f.Identity(),this._sceneRenderObserver=e.getScene().onBeforeRenderObservable.add((()=>{if(1===this.currentDraggingPointerIds.length&&this._moving&&!this.disableMovement){const t=e.parent;e.setParent(null),e.position.addInPlace(this._targetPosition.subtract(e.position).scale(this.dragDeltaRatio)),this.onPositionChangedObservable.notifyObservers({position:e.absolutePosition}),(!t||t.scaling&&!t.scaling.isNonUniformWithinEpsilon(.001))&&s._f.SlerpToRef(e.rotationQuaternion,this._targetOrientation,this.dragDeltaRatio,e.rotationQuaternion),e.setParent(t)}}))}_getPositionOffsetAround(e,t,i){const r=s.jp.Matrix[0],n=s.jp.Matrix[1],o=s.jp.Matrix[2],a=s.jp.Matrix[3],h=s.jp.Matrix[4];return s.y3.TranslationToRef(e.x,e.y,e.z,r),s.y3.TranslationToRef(-e.x,-e.y,-e.z,n),s.y3.FromQuaternionToRef(i,o),s.y3.ScalingToRef(t,t,t,a),n.multiplyToRef(o,h),h.multiplyToRef(a,h),h.multiplyToRef(r,h),h.getTranslation()}_onePointerPositionUpdated(e,t){s.jp.Vector3[0].setAll(0),this._dragging===this._dragType.DRAG?this.rotateDraggedObject&&(this.rotateAroundYOnly?s._f.RotationYawPitchRollToRef(t.toEulerAngles().y,0,0,s.jp.Quaternion[0]):s.jp.Quaternion[0].copyFrom(t),s.jp.Quaternion[0].multiplyToRef(this._startingOrientation,this._targetOrientation)):(this._dragging===this._dragType.NEAR_DRAG||this._dragging===this._dragType.DRAG_WITH_CONTROLLER&&this.rotateWithMotionController)&&t.multiplyToRef(this._startingOrientation,this._targetOrientation),this._targetPosition.copyFrom(this._startingPosition).addInPlace(e)}_twoPointersPositionUpdated(){const e=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].startingPosition,t=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].startingPosition,i=s.jp.Vector3[0];e.addToRef(t,i),i.scaleInPlace(.5);const r=s.jp.Vector3[1];t.subtractToRef(e,r);const n=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].dragMesh.absolutePosition,o=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].dragMesh.absolutePosition,a=s.jp.Vector3[2];n.addToRef(o,a),a.scaleInPlace(.5);const h=s.jp.Vector3[3];o.subtractToRef(n,h);const l=h.length()/r.length(),c=a.subtract(i),u=s._f.FromEulerAngles(0,s.P.GetAngleBetweenVectorsOnPlane(r.normalize(),h.normalize(),s.P.UpReadOnly),0),d=this._ownerNode.parent;this._ownerNode.setParent(null);const p=this._getPositionOffsetAround(i.subtract(this._virtualTransformNode.getAbsolutePivotPoint()),l,u);this._virtualTransformNode.rotationQuaternion.multiplyToRef(u,this._ownerNode.rotationQuaternion),this._virtualTransformNode.scaling.scaleToRef(l,this._ownerNode.scaling),this._virtualTransformNode.position.addToRef(c.addInPlace(p),this._ownerNode.position),this.onPositionChangedObservable.notifyObservers({position:this._ownerNode.position}),this._ownerNode.setParent(d)}_targetDragStart(){const e=this.currentDraggingPointerIds.length,t=this._ownerNode.parent;this._ownerNode.rotationQuaternion||(this._ownerNode.rotationQuaternion=s._f.RotationYawPitchRoll(this._ownerNode.rotation.y,this._ownerNode.rotation.x,this._ownerNode.rotation.z));const i=this._ownerNode.getAbsolutePivotPoint();if(this._ownerNode.setParent(null),1===e){if(this._targetPosition.copyFrom(this._ownerNode.position),this._targetOrientation.copyFrom(this._ownerNode.rotationQuaternion),this._targetScaling.copyFrom(this._ownerNode.scaling),this.faceCameraOnDragStart&&this._scene.activeCamera){const e=s.jp.Vector3[0];this._scene.activeCamera.position.subtractToRef(i,e),e.normalize();const t=s.jp.Quaternion[0];this._scene.useRightHandedSystem?s._f.FromLookDirectionRHToRef(e,new s.P(0,1,0),t):s._f.FromLookDirectionLHToRef(e,new s.P(0,1,0),t),t.normalize(),s._f.RotationYawPitchRollToRef(t.toEulerAngles().y,0,0,s.jp.Quaternion[0]),this._targetOrientation.copyFrom(s.jp.Quaternion[0])}this._startingPosition.copyFrom(this._targetPosition),this._startingOrientation.copyFrom(this._targetOrientation),this._startingScaling.copyFrom(this._targetScaling)}else 2===e&&(this._virtualTransformNode.setPivotPoint(new s.P(0,0,0),a.T.LOCAL),this._virtualTransformNode.position.copyFrom(this._ownerNode.position),this._virtualTransformNode.scaling.copyFrom(this._ownerNode.scaling),this._virtualTransformNode.rotationQuaternion.copyFrom(this._ownerNode.rotationQuaternion),this._virtualTransformNode.setPivotPoint(i,a.T.WORLD),this._resetVirtualMeshesPosition());this._ownerNode.setParent(t)}_targetDrag(e,t){1===this.currentDraggingPointerIds.length?this._onePointerPositionUpdated(e,t):2===this.currentDraggingPointerIds.length&&this._twoPointersPositionUpdated()}_targetDragEnd(){if(1===this.currentDraggingPointerIds.length){this._resetVirtualMeshesPosition();const e=this.faceCameraOnDragStart;this.faceCameraOnDragStart=!1,this._targetDragStart(),this.faceCameraOnDragStart=e}}detach(){super.detach(),this._ownerNode&&(this._ownerNode.isNearGrabbable=!1,this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver)),this._virtualTransformNode&&this._virtualTransformNode.dispose()}}},87541:(e,t,i)=>{i.d(t,{p:()=>n});var s=i(50147),r=i(90972);class n{constructor(){this._attachPointLocalOffset=new r.P,this._workingPosition=new r.P,this._workingQuaternion=new r._f,this._lastTick=-1,this._hit=!1,this.hitNormalOffset=.05,this.meshes=[],this.interpolatePose=!0,this.lerpTime=250,this.keepOrientationVertical=!0,this.enabled=!0,this.maxStickingDistance=.8}get name(){return"SurfaceMagnetism"}init(){}attach(e,t){this._attachedMesh=e,this._scene=t||e.getScene(),this._attachedMesh.rotationQuaternion||(this._attachedMesh.rotationQuaternion=r._f.RotationYawPitchRoll(this._attachedMesh.rotation.y,this._attachedMesh.rotation.x,this._attachedMesh.rotation.z)),this.updateAttachPoint(),this._workingPosition.copyFrom(this._attachedMesh.position),this._workingQuaternion.copyFrom(this._attachedMesh.rotationQuaternion),this._addObservables()}detach(){this._attachedMesh=null,this._removeObservables()}_getTargetPose(e){if(!this._attachedMesh)return null;if(e&&e.hit){const t=e.getNormal(!0,!0),i=e.pickedPoint;if(!t||!i)return null;t.normalize();const s=r.jp.Vector3[0];return s.copyFrom(t),s.scaleInPlace(this.hitNormalOffset),s.addInPlace(i),this._attachedMesh.parent&&(r.jp.Matrix[0].copyFrom(this._attachedMesh.parent.getWorldMatrix()).invert(),r.P.TransformNormalToRef(s,r.jp.Matrix[0],s)),{position:s,quaternion:r._f.RotationYawPitchRoll(-Math.atan2(t.x,-t.z),this.keepOrientationVertical?0:Math.atan2(t.y,Math.sqrt(t.z*t.z+t.x*t.x)),0)}}return null}updateAttachPoint(){this._getAttachPointOffsetToRef(this._attachPointLocalOffset)}findAndUpdateTarget(e){if(this._hit=!1,!e.ray)return!1;const t=e.ray.intersectsMeshes(this.meshes)[0];if(this._attachedMesh&&t&&t.hit&&t.pickedMesh){const e=this._getTargetPose(t);e&&r.P.Distance(this._attachedMesh.position,e.position)<this.maxStickingDistance&&(this._workingPosition.copyFrom(e.position),this._workingQuaternion.copyFrom(e.quaternion),this._hit=!0)}return this._hit}_getAttachPointOffsetToRef(e){if(!this._attachedMesh)return void e.setAll(0);const t=r.jp.Quaternion[0];t.copyFrom(this._attachedMesh.rotationQuaternion),this._attachedMesh.rotationQuaternion.copyFromFloats(0,0,0,1),this._attachedMesh.computeWorldMatrix();const i=this._attachedMesh.getHierarchyBoundingVectors(),s=r.jp.Vector3[0];i.max.addToRef(i.min,s),s.scaleInPlace(.5),s.z=i.max.z;const n=r.jp.Matrix[0];this._attachedMesh.getWorldMatrix().invertToRef(n),r.P.TransformCoordinatesToRef(s,n,e),this._attachedMesh.rotationQuaternion.copyFrom(t)}_updateTransformToGoal(e){if(!this._attachedMesh||!this._hit)return;const t=this._attachedMesh.parent;this._attachedMesh.setParent(null);const i=r.jp.Vector3[0];if(r.P.TransformNormalToRef(this._attachPointLocalOffset,this._attachedMesh.getWorldMatrix(),i),!this.interpolatePose)return this._attachedMesh.position.copyFrom(this._workingPosition).subtractInPlace(i),void this._attachedMesh.rotationQuaternion.copyFrom(this._workingQuaternion);const s=new r.P;r.P.SmoothToRef(this._attachedMesh.position,this._workingPosition,e,this.lerpTime,s),this._attachedMesh.position.copyFrom(s);const n=new r._f;n.copyFrom(this._attachedMesh.rotationQuaternion),r._f.SmoothToRef(n,this._workingQuaternion,e,this.lerpTime,this._attachedMesh.rotationQuaternion),this._attachedMesh.setParent(t)}_addObservables(){this._pointerObserver=this._scene.onPointerObservable.add((e=>{this.enabled&&e.type==s.kD.POINTERMOVE&&e.pickInfo&&this.findAndUpdateTarget(e.pickInfo)})),this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add((()=>{const e=Date.now();this._updateTransformToGoal(e-this._lastTick),this._lastTick=e}))}_removeObservables(){this._scene.onPointerObservable.remove(this._pointerObserver),this._scene.onBeforeRenderObservable.remove(this._onBeforeRender),this._pointerObserver=null,this._onBeforeRender=null}}},87385:(e,t,i)=>{i.d(t,{V:()=>h});var s=i(4442),r=i(90972),n=i(14651),o=i(4639),a=i(64673);o.a.prototype.addDeviceOrientation=function(e){return this._deviceOrientationInput||(this._deviceOrientationInput=new h,e&&(this._deviceOrientationInput.smoothFactor=e),this.add(this._deviceOrientationInput)),this};class h{static WaitForOrientationChangeAsync(e){return new Promise(((t,i)=>{let s=!1;const r=()=>{window.removeEventListener("deviceorientation",r),s=!0,t()};e&&setTimeout((()=>{s||(window.removeEventListener("deviceorientation",r),i("WaitForOrientationChangeAsync timed out"))}),e),"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"==e?window.addEventListener("deviceorientation",r):n.w1.Warn("Permission not granted.")})).catch((e=>{n.w1.Error(e)})):window.addEventListener("deviceorientation",r)}))}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new r._f,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new a.y$,this._orientationChanged=()=>{this._screenOrientationAngle=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-n.w1.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=null!==e.alpha?n.w1.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=null!==e.beta?n.w1.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=null!==e.gamma?n.w1.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=null!==e.alpha?e.alpha:0,this._beta=null!==e.beta?e.beta:0,this._gamma=null!==e.gamma?e.gamma:0),null!==e.alpha&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTranform=new r._f(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,null==this._camera||this._camera.rotationQuaternion||(this._camera.rotationQuaternion=new r._f),this._camera&&this._camera.onDisposeObservable.add((()=>{this._onDeviceOrientationChangedObservable.clear()}))}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e?t():n.w1.Warn("Permission not granted.")})).catch((e=>{n.w1.Error(e)})):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(r._f.RotationYawPitchRollToRef(n.w1.ToRadians(this._alpha),n.w1.ToRadians(this._beta),-n.w1.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}s.u.FreeCameraDeviceOrientationInput=h},31568:(e,t,i)=>{i.r(t),i.d(t,{DebugLayer:()=>l,DebugLayerTab:()=>s});var s,r=i(14651),n=i(64673),o=i(8714),a=i(47469),h=i(40078);Object.defineProperty(o.x.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new l(this)),this._debugLayer},enumerable:!0,configurable:!0}),function(e){e[e.Properties=0]="Properties",e[e.Debug=1]="Debug",e[e.Statistics=2]="Statistics",e[e.Tools=3]="Tools",e[e.Settings=4]="Settings"}(s||(s={}));class l{get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new n.y$),this._onPropertyChangedObservable)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new n.y$),this._onSelectionChangedObservable)}constructor(e){this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||h.l.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add((()=>{this._scene._debugLayer&&this._scene._debugLayer.hide()}))}_createInspector(e){if(this.isVisible())return;if(this._onPropertyChangedObservable){for(const e of this._onPropertyChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(e);this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(const e of this._onSelectionChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(e);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}const t=Object.assign({overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0},e);this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,t)}select(e,t){this.BJSINSPECTOR&&(t&&("[object String]"==Object.prototype.toString.call(t)?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))}_getGlobalInspector(){return"undefined"!=typeof INSPECTOR?INSPECTOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.Inspector?BABYLON:void 0}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)}show(e){return new Promise((t=>{if(void 0===this.BJSINSPECTOR){const i=e&&e.inspectorURL?e.inspectorURL:l.InspectorURL;r.w1.LoadScript(i,(()=>{this._createInspector(e),t(this)}))}else this._createInspector(e),t(this)}))}}l.InspectorURL=`https://unpkg.com/babylonjs-inspector@${a.D.Version}/babylon.inspector.bundle.js`},67602:(e,t,i)=>{i.d(t,{Q:()=>r});var s=i(47469),r=!0;s.D.prototype.createTransformFeedback=function(){const e=this._gl.createTransformFeedback();if(!e)throw new Error("Unable to create Transform Feedback");return e},s.D.prototype.deleteTransformFeedback=function(e){this._gl.deleteTransformFeedback(e)},s.D.prototype.bindTransformFeedback=function(e){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,e)},s.D.prototype.beginTransformFeedback=function(e=!0){this._gl.beginTransformFeedback(e?this._gl.POINTS:this._gl.TRIANGLES)},s.D.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},s.D.prototype.setTranformFeedbackVaryings=function(e,t){this._gl.transformFeedbackVaryings(e,t,this._gl.INTERLEAVED_ATTRIBS)},s.D.prototype.bindTransformFeedbackBuffer=function(e){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e?e.underlyingResource:null)}},48635:(e,t,i)=>{i.d(t,{o:()=>r,p:()=>s});class s{}s.COPY=1,s.CUT=2,s.PASTE=3;class r{constructor(e,t){this.type=e,this.event=t}static GetTypeFromCharacter(e){switch(e){case 67:return s.COPY;case 86:return s.PASTE;case 88:return s.CUT;default:return-1}}}},98350:(e,t,i)=>{i.d(t,{K4:()=>r,NF:()=>s,Xq:()=>a});var s,r,n=i(64673),o=i(21983);!function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(s||(s={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(r||(r={}));class a extends o.nJ{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new n.y$,this.onButtonUpObservable=new n.y$,this.onPadDownObservable=new n.y$,this.onPadUpObservable=new n.y$,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=o.nJ.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,s.Cross)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,s.Circle)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,s.Square)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,s.Triangle)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,s.Options)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,s.Share)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,s.L1)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,s.R1)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,s.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,s.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,r.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,r.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,r.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,r.Right)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}},21983:(e,t,i)=>{i.d(t,{If:()=>o,nJ:()=>n,zD:()=>r});var s=i(64673);class r{constructor(e,t){this.x=e,this.y=t}}class n{get isConnected(){return this._isConnected}constructor(e,t,i,s=0,r=1,o=2,a=3){this.id=e,this.index=t,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=n.GAMEPAD,this._leftStickAxisX=s,this._leftStickAxisY=r,this._rightStickAxisX=o,this._rightStickAxisY=a,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){!this._onleftstickchanged||this._leftStick.x===e.x&&this._leftStick.y===e.y||this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){!this._onrightstickchanged||this._rightStick.x===e.x&&this._rightStick.y===e.y||this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}n.GAMEPAD=0,n.GENERIC=1,n.XBOX=2,n.POSE_ENABLED=3,n.DUALSHOCK=4;class o extends n{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new s.y$,this.onButtonUpObservable=new s.y$,this.type=n.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}},12098:(e,t,i)=>{i.d(t,{j:()=>c});var s=i(8714),r=i(84686),n=i(54098),o=i(4639),a=i(79922),h=i(54946),l=i(30282);Object.defineProperty(s.x.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new n.v(this);let e=this._getComponent(r.l.NAME_GAMEPAD);e||(e=new c(this),this._addComponent(e))}return this._gamepadManager},enumerable:!0,configurable:!0}),o.a.prototype.addGamepad=function(){return this.add(new a.c),this},h.$.prototype.addGamepad=function(){return this.add(new l.R),this};class c{constructor(e){this.name=r.l.NAME_GAMEPAD,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(r.l.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}_beforeCameraUpdate(){const e=this.scene._gamepadManager;e&&e._isMonitoring&&e._checkGamepadsStatus()}}},43801:(e,t,i)=>{i.d(t,{FI:()=>a,_Q:()=>r,nR:()=>s});var s,r,n=i(64673),o=i(21983);!function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(s||(s={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(r||(r={}));class a extends o.nJ{constructor(e,t,i,s=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new n.y$,this.onButtonUpObservable=new n.y$,this.onPadDownObservable=new n.y$,this.onPadUpObservable=new n.y$,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=o.nJ.XBOX,this._isXboxOnePad=s}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,s.A)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,s.B)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,s.X)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,s.Y)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,s.Start)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,s.Back)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,s.LB)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,s.RB)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,s.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,s.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,r.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,r.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,r.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,r.Right)}update(){super.update(),this._isXboxOnePad,this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}},48147:(e,t,i)=>{i.d(t,{Cc:()=>s,tb:()=>u,wF:()=>r});var s,r,n=i(90972),o=i(33632),a=i(95593),h=i(52753),l=i(50147),c=i(85046);!function(e){e[e.Origin=0]="Origin",e[e.Pivot=1]="Pivot"}(s||(s={})),function(e){e[e.World=0]="World",e[e.Local=1]="Local"}(r||(r={}));class u{set scaleRatio(e){this._scaleRatio=e}get scaleRatio(){return this._scaleRatio}get isHovered(){return this._isHovered}get attachedMesh(){return this._attachedMesh}set attachedMesh(e){this._attachedMesh=e,e&&(this._attachedNode=e),this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}get attachedNode(){return this._attachedNode}set attachedNode(e){this._attachedNode=e,this._attachedMesh=null,this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}setCustomMesh(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach((e=>{e.dispose()})),e.parent=this._rootMesh,this._customMeshSet=!0}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){this._coordinatesMode=e;const t=e==r.Local;this.updateGizmoRotationToMatchAttachedMesh=t,this.updateGizmoPositionToMatchAttachedMesh=t}get coordinatesMode(){return this._coordinatesMode}set updateScale(e){this._updateScale=e}get updateScale(){return this._updateScale}_attachedNodeChanged(e){}constructor(e=h.x.DefaultUtilityLayer){this.gizmoLayer=e,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this._updateGizmoPositionToMatchAttachedMesh=!0,this._anchorPoint=s.Origin,this._updateScale=!0,this._coordinatesMode=r.Local,this._interactionsEnabled=!0,this._rightHandtoLeftHandMatrix=n.y3.RotationY(Math.PI),this._rootMesh=new o.Kj("gizmoRootNode",e.utilityLayerScene),this._rootMesh.rotationQuaternion=n._f.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add((()=>{this._update()}))}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e}_update(){if(this.attachedNode){let e=this.attachedNode;if(this.attachedMesh&&(e=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh)if(this.anchorPoint==s.Pivot&&e.getAbsolutePivotPoint){const t=e.getAbsolutePivotPoint();this._rootMesh.position.copyFrom(t)}else{const t=e.getWorldMatrix().getRow(3),i=t?t.toVector3():new n.P(0,0,0);this._rootMesh.position.copyFrom(i)}if(this.updateGizmoRotationToMatchAttachedMesh){const t=e._isMesh||"AbstractMesh"===e.getClassName()||"TransformNode"===e.getClassName()||"InstancedMesh"===e.getClassName()?e:void 0;e.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion,void 0,u.PreserveScaling?t:void 0)}else this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1);if(this.updateScale){const t=this.gizmoLayer.utilityLayerScene.activeCamera;let i=t.globalPosition;t.devicePosition&&(i=t.devicePosition),this._rootMesh.position.subtractToRef(i,n.jp.Vector3[0]);let s=this.scaleRatio;if(t.mode==a.V.ORTHOGRAPHIC_CAMERA)t.orthoTop&&t.orthoBottom&&(s*=t.orthoTop-t.orthoBottom);else{const e=t.getScene().useRightHandedSystem?n.P.RightHandedForwardReadOnly:n.P.LeftHandedForwardReadOnly,i=t.getDirection(e);s*=n.P.Dot(n.jp.Vector3[0],i)}this._rootMesh.scaling.setAll(s),e._getWorldMatrixDeterminant()<0&&!u.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}}_handlePivot(){const e=this._attachedNode;e.isUsingPivotMatrix&&e.isUsingPivotMatrix()&&e.position&&e.getWorldMatrix().setTranslation(e.position)}_matrixChanged(){if(this._attachedNode)if(this._attachedNode._isCamera){const e=this._attachedNode;let t,i;if(e.parent){const i=n.jp.Matrix[1];e.parent._worldMatrix.invertToRef(i),this._attachedNode._worldMatrix.multiplyToRef(i,n.jp.Matrix[0]),t=n.jp.Matrix[0]}else t=this._attachedNode._worldMatrix;if(e.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(t,n.jp.Matrix[1]),i=n.jp.Matrix[1]):i=t,i.decompose(n.jp.Vector3[1],n.jp.Quaternion[0],n.jp.Vector3[0]),"FreeCamera"===this._attachedNode.getClassName()||"FlyCamera"===this._attachedNode.getClassName()||"ArcFollowCamera"===this._attachedNode.getClassName()||"TargetCamera"===this._attachedNode.getClassName()||"TouchCamera"===this._attachedNode.getClassName()||"UniversalCamera"===this._attachedNode.getClassName()){const e=this._attachedNode;e.rotation=n.jp.Quaternion[0].toEulerAngles(),e.rotationQuaternion&&(e.rotationQuaternion.copyFrom(n.jp.Quaternion[0]),e.rotationQuaternion.normalize())}e.position.copyFrom(n.jp.Vector3[0])}else if(this._attachedNode._isMesh||"AbstractMesh"===this._attachedNode.getClassName()||"TransformNode"===this._attachedNode.getClassName()||"InstancedMesh"===this._attachedNode.getClassName()){const e=this._attachedNode;if(e.parent){const t=n.jp.Matrix[0],i=n.jp.Matrix[1];e.parent.getWorldMatrix().invertToRef(t),this._attachedNode.getWorldMatrix().multiplyToRef(t,i),i.decompose(n.jp.Vector3[0],n.jp.Quaternion[0],e.position,u.PreserveScaling?e:void 0)}else this._attachedNode._worldMatrix.decompose(n.jp.Vector3[0],n.jp.Quaternion[0],e.position,u.PreserveScaling?e:void 0);n.jp.Vector3[0].scaleInPlace(1/e.scalingDeterminant),e.scaling.copyFrom(n.jp.Vector3[0]),e.billboardMode||(e.rotationQuaternion?(e.rotationQuaternion.copyFrom(n.jp.Quaternion[0]),e.rotationQuaternion.normalize()):e.rotation=n.jp.Quaternion[0].toEulerAngles())}else if("Bone"===this._attachedNode.getClassName()){const e=this._attachedNode,t=e.getParent();if(t){const i=n.jp.Matrix[0],s=n.jp.Matrix[1];t.getFinalMatrix().invertToRef(i),e.getFinalMatrix().multiplyToRef(i,s),e.getLocalMatrix().copyFrom(s)}else e.getLocalMatrix().copyFrom(e.getFinalMatrix());e.markAsDirty()}else{const e=this._attachedNode;if(e.getTypeID){const t=e.getTypeID();if(t===c._.LIGHTTYPEID_DIRECTIONALLIGHT||t===c._.LIGHTTYPEID_SPOTLIGHT||t===c._.LIGHTTYPEID_POINTLIGHT){const t=e.parent;if(t){const i=n.jp.Matrix[0],s=n.jp.Matrix[1];t.getWorldMatrix().invertToRef(i),e.getWorldMatrix().multiplyToRef(i,s),s.decompose(void 0,n.jp.Quaternion[0],n.jp.Vector3[0])}else this._attachedNode._worldMatrix.decompose(void 0,n.jp.Quaternion[0],n.jp.Vector3[0]);e.position=new n.P(n.jp.Vector3[0].x,n.jp.Vector3[0].y,n.jp.Vector3[0].z),e.direction&&(e.direction=new n.P(e.direction.x,e.direction.y,e.direction.z))}}}}_setGizmoMeshMaterial(e,t){e&&e.forEach((e=>{e.material=t,e.color&&(e.color=t.diffuseColor)}))}static GizmoAxisPointerObserver(e,t){let i=!1;return e.utilityLayerScene.onPointerObservable.add((e=>{var s,r;if(e.pickInfo){if(e.type===l.kD.POINTERMOVE){if(i)return;t.forEach((t=>{var i,s;if(t.colliderMeshes&&t.gizmoMeshes){const r=-1!=(null===(i=t.colliderMeshes)||void 0===i?void 0:i.indexOf(null===(s=null==e?void 0:e.pickInfo)||void 0===s?void 0:s.pickedMesh)),n=t.dragBehavior.enabled?r||t.active?t.hoverMaterial:t.material:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=n,e.color&&(e.color=n.diffuseColor)}))}}))}e.type===l.kD.POINTERDOWN&&t.has(null===(s=e.pickInfo.pickedMesh)||void 0===s?void 0:s.parent)&&(i=!0,t.get(null===(r=e.pickInfo.pickedMesh)||void 0===r?void 0:r.parent).active=!0,t.forEach((t=>{var i,s;const r=(-1!=(null===(i=t.colliderMeshes)||void 0===i?void 0:i.indexOf(null===(s=null==e?void 0:e.pickInfo)||void 0===s?void 0:s.pickedMesh))||t.active)&&t.dragBehavior.enabled?t.hoverMaterial:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=r,e.color&&(e.color=r.diffuseColor)}))}))),e.type===l.kD.POINTERUP&&t.forEach((e=>{e.active=!1,i=!1,e.gizmoMeshes.forEach((t=>{t.material=e.dragBehavior.enabled?e.material:e.disableMaterial,t.color&&(t.color=e.material.diffuseColor)}))}))}}))}dispose(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)}}u.PreserveScaling=!1},90315:(e,t,i)=>{i.d(t,{p:()=>h});var s=i(95593),r=i(84686),n=i(29246),o=i(64863),a=i(40078);o.p.AddParser(r.l.NAME_EFFECTLAYER,((e,t,i,s)=>{if(e.effectLayers){i.effectLayers||(i.effectLayers=new Array);for(let r=0;r<e.effectLayers.length;r++){const o=n.w.Parse(e.effectLayers[r],t,s);i.effectLayers.push(o)}}})),o.p.prototype.removeEffectLayer=function(e){const t=this.effectLayers.indexOf(e);return-1!==t&&this.effectLayers.splice(t,1),t},o.p.prototype.addEffectLayer=function(e){this.effectLayers.push(e)};class h{constructor(e){this.name=r.l.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||a.l.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.effectLayers=new Array)}register(){this.scene._isReadyForMeshStage.registerStep(r.l.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(r.l.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(r.l.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(r.l.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(r.l.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(r.l.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){const e=this.scene.effectLayers;for(const t of e)t._rebuild()}serialize(e){e.effectLayers=[];const t=this.scene.effectLayers;for(const i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.addEffectLayer(e)}))}removeFromContainer(e,t){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.removeEffectLayer(e),t&&e.dispose()}))}dispose(){const e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){const i=this._engine.currentRenderPassId,s=this.scene.effectLayers;for(const r of s){if(!r.hasMesh(e))continue;const s=r._mainTexture;this._engine.currentRenderPassId=s.renderPassId;for(const s of e.subMeshes)if(!r.isReady(s,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1;const i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(const r of i)if(r.shouldRender()&&(!r.camera||r.camera.cameraRigMode===s.V.RIG_MODE_NONE&&e===r.camera||r.camera.cameraRigMode!==s.V.RIG_MODE_NONE&&r.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||r.needStencil();const e=r._mainTexture;e._shouldRender()&&(this.scene.incrementRenderId(),e.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);const t=this.scene.effectLayers;for(let i=0;i<t.length;i++){const s=t[i];s.renderingGroupId===e&&s.shouldRender()&&s.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}n.w._SceneComponentInitialization=e=>{let t=e._getComponent(r.l.NAME_EFFECTLAYER);t||(t=new h(e),e._addComponent(t))}},61415:(e,t,i)=>{i.d(t,{m:()=>p});var s=i(64673),r=i(90972),n=i(89859),o=i(40078),a=i(37959),h=i(79061),l=i(84684),c=i(84686),u=i(52669),d=i(62813);i(33394),i(45008);class p{set applyPostProcess(e){this._applyPostProcess=e}get applyPostProcess(){return this.isBackground||this._applyPostProcess}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}constructor(e,t,i,h,p){this.name=e,this._applyPostProcess=!0,this.scale=new r.FM(1,1),this.offset=new r.FM(0,0),this.alphaBlendingMode=2,this.layerMask=268435455,this.renderTargetTextures=[],this.renderOnlyInRenderTargetTextures=!1,this.isEnabled=!0,this._vertexBuffers={},this.onDisposeObservable=new s.y$,this.onBeforeRenderObservable=new s.y$,this.onAfterRenderObservable=new s.y$,this.texture=t?new l.x(t,i,!0):null,this.isBackground=void 0===h||h,this.color=void 0===p?new n.HE(1,1,1,1):p,this._scene=i||o.l.LastCreatedScene;let _=this._scene._getComponent(c.l.NAME_LAYER);_||(_=new u.N(this._scene),this._scene._addComponent(_)),this._scene.layers.push(this);const g=this._scene.getEngine();this._drawWrapper=new d.q(g);const m=[];m.push(1,1),m.push(-1,1),m.push(-1,-1),m.push(1,-1);const f=new a.o(g,m,a.o.PositionKind,!1,!1,2);this._vertexBuffers[a.o.PositionKind]=f,this._createIndexBuffer()}_createIndexBuffer(){const e=this._scene.getEngine(),t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[a.o.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}isReady(){var e;const t=this._scene.getEngine();let i="";this.alphaTest&&(i="#define ALPHATEST"),this.texture&&!this.texture.gammaSpace&&(i+="\n#define LINEAR"),this._previousDefines!==i&&(this._previousDefines=i,this._drawWrapper.effect=t.createEffect("layer",[a.o.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],i));const s=this._drawWrapper.effect;return(null==s?void 0:s.isReady())&&(null===(e=this.texture)||void 0===e?void 0:e.isReady())}render(){if(!this.isEnabled)return;const e=this._scene.getEngine();if(!this.isReady())return;const t=this._drawWrapper.effect;this.onBeforeRenderObservable.notifyObservers(this),e.enableEffect(this._drawWrapper),e.setState(!1),t.setTexture("textureSampler",this.texture),t.setMatrix("textureMatrix",this.texture.getTextureMatrix()),t.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),t.setVector2("offset",this.offset),t.setVector2("scale",this.scale),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t),this.alphaTest?e.drawElementsType(h.F.TriangleFillMode,0,6):(e.setAlphaMode(this.alphaBlendingMode),e.drawElementsType(h.F.TriangleFillMode,0,6),e.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this)}dispose(){const e=this._vertexBuffers[a.o.PositionKind];e&&(e.dispose(),this._vertexBuffers[a.o.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this.renderTargetTextures=[];const t=this._scene.layers.indexOf(this);this._scene.layers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()}}},52669:(e,t,i)=>{i.d(t,{N:()=>n});var s=i(84686),r=i(40078);class n{constructor(e){this.name=s.l.NAME_LAYER,this.scene=e||r.l.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.layers=new Array)}register(){this.scene._beforeCameraDrawStage.registerStep(s.l.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground),this.scene._afterCameraDrawStage.registerStep(s.l.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForegroundWithPostProcessing),this.scene._afterCameraPostProcessStage.registerStep(s.l.STEP_AFTERCAMERAPOSTPROCESS_LAYER,this,this._drawCameraForegroundWithoutPostProcessing),this.scene._beforeRenderTargetDrawStage.registerStep(s.l.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground),this.scene._afterRenderTargetDrawStage.registerStep(s.l.STEP_AFTERRENDERTARGETDRAW_LAYER,this,this._drawRenderTargetForegroundWithPostProcessing),this.scene._afterRenderTargetPostProcessStage.registerStep(s.l.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER,this,this._drawRenderTargetForegroundWithoutPostProcessing)}rebuild(){const e=this.scene.layers;for(const t of e)t._rebuild()}dispose(){const e=this.scene.layers;for(;e.length;)e[0].dispose()}_draw(e){const t=this.scene.layers;if(t.length){this._engine.setDepthBuffer(!1);for(const i of t)e(i)&&i.render();this._engine.setDepthBuffer(!0)}}_drawCameraPredicate(e,t,i,s){return!e.renderOnlyInRenderTargetTextures&&e.isBackground===t&&e.applyPostProcess===i&&0!=(e.layerMask&s)}_drawCameraBackground(e){this._draw((t=>this._drawCameraPredicate(t,!0,!0,e.layerMask)))}_drawCameraForegroundWithPostProcessing(e){this._draw((t=>this._drawCameraPredicate(t,!1,!0,e.layerMask)))}_drawCameraForegroundWithoutPostProcessing(e){this._draw((t=>this._drawCameraPredicate(t,!1,!1,e.layerMask)))}_drawRenderTargetPredicate(e,t,i,s,r){return e.renderTargetTextures.length>0&&e.isBackground===t&&e.applyPostProcess===i&&e.renderTargetTextures.indexOf(r)>-1&&0!=(e.layerMask&s)}_drawRenderTargetBackground(e){this._draw((t=>this._drawRenderTargetPredicate(t,!0,!0,this.scene.activeCamera.layerMask,e)))}_drawRenderTargetForegroundWithPostProcessing(e){this._draw((t=>this._drawRenderTargetPredicate(t,!1,!0,this.scene.activeCamera.layerMask,e)))}_drawRenderTargetForegroundWithoutPostProcessing(e){this._draw((t=>this._drawRenderTargetPredicate(t,!1,!1,this.scene.activeCamera.layerMask,e)))}addFromContainer(e){e.layers&&e.layers.forEach((e=>{this.scene.layers.push(e)}))}removeFromContainer(e,t=!1){e.layers&&e.layers.forEach((e=>{const i=this.scene.layers.indexOf(e);-1!==i&&this.scene.layers.splice(i,1),t&&e.dispose()}))}}},93871:(e,t,i)=>{i.d(t,{O:()=>$,n:()=>j});var s=i(13555),r=i(80569),n=i(87257),o=i(90972),a=i(89859),h=i(47469),l=i(9416),c=i(73212),u=i(64673),d=i(99527),p=i(63742),_=i(63478),g=i(37959),m=i(14651),f=i(20289),b=i(17026),v=i(65063),y=i(86251),x=i(9827),P=i(96786),C=i(13013),T=i(23758),S=i(79190),E=i(99240),R=i(43092),M=i(22059),A=i(31932),I=i(75943),O=i(3356),w=i(6919),D=i(98671),B=i(84684),N=i(62508),F=i(4123),L=i(40436),V=i(45751),k=i(59899),z=i(25707),G=i(52502),U=i(40078),W=i(96721);const H={effect:null,subMesh:null};class j extends _.H{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){void 0===this[e]&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class $ extends r.a{static _BlockIsTextureBlock(e){return"TextureBlock"===e.getClassName()||"ReflectionTextureBaseBlock"===e.getClassName()||"RefractionBlock"===e.getClassName()||"CurrentScreenBlock"===e.getClassName()||"ParticleTextureBlock"===e.getClassName()||"ImageSourceBlock"===e.getClassName()||"TriPlanarBlock"===e.getClassName()||"BiPlanarBlock"===e.getClassName()||"PrePassTextureBlock"===e.getClassName()}_getGlobalNodeMaterialEditor(){return"undefined"!=typeof NODEEDITOR?NODEEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeEditor?BABYLON:void 0}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){super(e,t||U.l.LastCreatedScene),this._buildId=$._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new o.y3,this._cachedWorldViewProjectionMatrix=new o.y3,this._optimizers=new Array,this._animationFrame=-1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new u.y$,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=new Array,this._mode=D.a.Material,this.forceAlphaBlending=!1,this._options=Object.assign({emitComments:!1},i),this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return m.w1.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(-1!==t)return this._optimizers.splice(t,1),this}addOutputNode(e){if(null===e.target)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return 0!=(e.target&d.u.Vertex)&&this._addVertexOutputNode(e),0!=(e.target&d.u.Fragment)&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return null===e.target||(0!=(e.target&d.u.Vertex)&&this._removeVertexOutputNode(e),0!=(e.target&d.u.Fragment)&&this._removeFragmentOutputNode(e)),this}_addVertexOutputNode(e){if(-1===this._vertexOutputNodes.indexOf(e))return e.target=d.u.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(-1!==t)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(-1===this._fragmentOutputNodes.indexOf(e))return e.target=d.u.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(-1!==t)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return!this.ignoreAlpha&&(this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending)}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,s=!0){(e.target===d.u.VertexAndFragment||t.target===d.u.Fragment&&e.target===d.u.Vertex&&e._preparationId!==this._buildId)&&i.push(e),this._initializeBlock(e,t,i,s)}_initializeBlock(e,t,i,s=!0){if(e.initialize(t),s&&e.autoConfigure(this),e._preparationId=this._buildId,-1===this.attachedBlocks.indexOf(e)){if(e.isUnique){const t=e.getClassName();for(const e of this.attachedBlocks)if(e.getClassName()===t)throw`Cannot have multiple blocks of type ${t} in the same NodeMaterial`}this.attachedBlocks.push(e)}for(const r of e.inputs){r.associatedVariableName="";const n=r.connectedPoint;if(n){const r=n.ownerBlock;r!==e&&this._processInitializeOnLink(r,t,i,s)}}if(e.isTeleportOut){const r=e;r.entryPoint&&this._processInitializeOnLink(r.entryPoint,t,i,s)}for(const t of e.outputs)t.associatedVariableName=""}_resetDualBlocks(e,t){e.target===d.u.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const s=i.connectedPoint;if(s){const i=s.ownerBlock;i!==e&&this._resetDualBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._resetDualBlocks(i.entryPoint,t)}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){this._vertexCompilationState||i||(i=!0),this._buildWasSuccessful=!1;const s=this.getScene().getEngine(),r=this._mode===D.a.Particle;if(0===this._vertexOutputNodes.length&&!r)throw"You must define at least one vertexOutputNode";if(0===this._fragmentOutputNodes.length)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new l.u,this._vertexCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._vertexCompilationState.target=d.u.Vertex,this._fragmentCompilationState=new l.u,this._fragmentCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._fragmentCompilationState.target=d.u.Fragment,this._sharedData=new p.U,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=r;const n=[],o=[];for(const e of this._vertexOutputNodes)n.push(e),this._initializeBlock(e,this._vertexCompilationState,o,i);for(const e of this._fragmentOutputNodes)o.push(e),this._initializeBlock(e,this._fragmentCompilationState,n,i);this.optimize();for(const e of n)e.build(this._vertexCompilationState,n);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const e of o)this._resetDualBlocks(e,this._buildId-1);for(const e of o)e.build(this._fragmentCompilationState,o);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=$._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);const a=this.getScene().meshes;for(const e of a)if(e.subMeshes)for(const t of e.subMeshes){if(t.getMaterial()!==this)continue;if(!t.materialDefines)continue;const e=t.materialDefines;e.markAllAsDirty(),e.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();const h=this.getScene().prePassRenderer;h&&h.markAsDirty()}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,s=t.TANGENT,r=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(g.o.NormalKind),t.TANGENT=e.isVerticesDataPresent(g.o.TangentKind);const n=e.useVertexColors&&e.isVerticesDataPresent(g.o.ColorKind);t.VERTEXCOLOR_NME=n;let o=!1;for(let i=1;i<=6;++i){const s=t["UV"+i];t["UV"+i]=e.isVerticesDataPresent(`uv${1===i?"":i}`),o=o||t["UV"+i]!==s}const a=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;W.G.PrepareDefinesForPrePass(this.getScene(),t,!a),(i!==t.NORMAL||s!==t.TANGENT||r!==t.VERTEXCOLOR_NME||o)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){const e=this.getBlockByPredicate((e=>"PrePassOutputBlock"===e.getClassName())),t=[4];return e?(this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.viewNormal.isConnected&&t.push(6),e.worldPosition.isConnected&&t.push(1)),t):t}get prePassTextureInputs(){const e=this.getAllTextureBlocks().filter((e=>"PrePassTextureBlock"===e.getClassName())),t=[];for(const i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.normal.isConnected&&!t.includes(6)&&t.push(6);return t}setPrePassRenderer(e){const t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(const e of t)i.texturesRequired.includes(e)||i.texturesRequired.push(e);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,s,r,n=0,o=5){return this.mode!==D.a.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,s,r,n,o)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,s=1,r,o,a=0,h=5){let l=this.name+this._buildId;const u=new j,d=new n.x(l+"PostProcess",this.getScene());let p=this._buildId;return this._processDefines(d,u),c.Q.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l):e=new A.D(this.name+"PostProcess",l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,s,r,o,u.toString(),a,l,{maxSimultaneousLights:this.maxSimultaneousLights},!1,h),e.nodeMaterialSource=this,e.onApplyObservable.add((t=>{p!==this._buildId&&(delete c.Q.ShadersStore[l+"VertexShader"],delete c.Q.ShadersStore[l+"PixelShader"],l=this.name+this._buildId,u.markAllAsDirty(),p=this._buildId),this._processDefines(d,u)&&(c.Q.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),L.Q.SetImmediate((()=>e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l)))),this._checkInternals(t)})),e}createProceduralTexture(e,t){if(this.mode!==D.a.ProceduralTexture)return console.log("Incompatible material mode"),null;let i=this.name+this._buildId;const s=new V.g(i,e,null,t),r=new n.x(i+"Procedural",this.getScene());r.reservedDataStore={hidden:!0};const o=new j,a=this._processDefines(r,o);c.Q.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);let h=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[g.o.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString(),null==a?void 0:a.fallbacks,void 0);s.nodeMaterialSource=this,s._setEffect(h);let l=this._buildId;return s.onBeforeGenerationObservable.add((()=>{l!==this._buildId&&(delete c.Q.ShadersStore[i+"VertexShader"],delete c.Q.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,o.markAllAsDirty(),l=this._buildId);const e=this._processDefines(r,o);e&&(c.Q.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),L.Q.SetImmediate((()=>{h=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[g.o.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString(),null==e?void 0:e.fallbacks,void 0),s._setEffect(h)}))),this._checkInternals(h)})),s}_createEffectForParticles(e,t,i,s,r,o,a,h=""){let l=this.name+this._buildId+"_"+t;o||(o=new j),a||(a=this.getScene().getMeshByName(this.name+"Particle"))||((a=new n.x(this.name+"Particle",this.getScene())).reservedDataStore={hidden:!0});let u=this._buildId;const d=[];let p=h;if(!r){const n=this._processDefines(a,o);c.Q.RegisterShader(l,this._fragmentCompilationState._builtCompilationString),e.fillDefines(d,t),p=d.join("\n"),r=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString()+"\n"+p,null==n?void 0:n.fallbacks,i,s,e),e.setCustomEffect(r,t)}r.onBindObservable.add((r=>{u!==this._buildId&&(delete c.Q.ShadersStore[l+"PixelShader"],l=this.name+this._buildId+"_"+t,o.markAllAsDirty(),u=this._buildId),d.length=0,e.fillDefines(d,t);const n=d.join("\n");n!==p&&(o.markAllAsDirty(),p=n);const _=this._processDefines(a,o);if(_)return c.Q.RegisterShader(l,this._fragmentCompilationState._builtCompilationString),r=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString()+"\n"+p,null==_?void 0:_.fallbacks,i,s,e),e.setCustomEffect(r,t),void this._createEffectForParticles(e,t,i,s,r,o,a,h);this._checkInternals(r)}))}_checkInternals(e){if(this._sharedData.animatedInputs){const e=this.getScene(),t=e.getFrameId();if(this._animationFrame!==t){for(const t of this._sharedData.animatedInputs)t.animate(e);this._animationFrame=t}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){this.mode===D.a.Particle?(this._createEffectForParticles(e,N.U.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,N.U.BLENDMODE_MULTIPLY,t,i)):console.log("Incompatible material mode")}createAsShadowDepthWrapper(e){this.mode===D.a.Material?e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene()):console.log("Incompatible material mode")}_processDefines(e,t,i=!1,s){let r=null;const n=this.getScene();if(W.G.PrepareDefinesForCamera(n,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach((s=>{s.initializeDefines(e,this,t,i)})),this._sharedData.blocksWithDefines.forEach((r=>{r.prepareDefines(e,this,t,i,s)})),t.isDirty){const i=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach((i=>{i.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)}));const s=[];this._sharedData.dynamicUniformBlocks.forEach((e=>{e.updateUniformsAndSamples(this._vertexCompilationState,this,t,s)}));const n=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach((e=>{-1===n.indexOf(e)&&n.push(e)}));const o=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach((e=>{-1===o.indexOf(e)&&o.push(e)}));const a=new R.L;this._sharedData.blocksWithFallbacks.forEach((t=>{t.provideFallbacks(e,a)})),r={lightDisposed:i,uniformBuffers:s,mergedUniforms:n,mergedSamplers:o,fallbacks:a}}return r}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const s=this.getScene();if(this._sharedData.animatedInputs){const e=s.getFrameId();if(this._animationFrame!==e){for(const e of this._sharedData.animatedInputs)e.animate(s);this._animationFrame=e}}if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new j);const r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(this._prepareDefinesForAttributes(e,r),this._sharedData.blockingBlocks.some((t=>!t.isReady(e,this,r,i))))return!1;const o=this._processDefines(e,r,i,t);if(o){const e=t.effect,i=r.toString();let a=n.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:o.mergedUniforms,uniformBuffersNames:o.uniformBuffers,samplers:o.mergedSamplers,defines:i,fallbacks:o.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:r.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:r.NUM_MORPH_INFLUENCERS}},n);if(a)if(this._onEffectCreatedObservable&&(H.effect=a,H.subMesh=t,this._onEffectCreatedObservable.notifyObservers(H)),this.allowShaderHotSwapping&&e&&!a.isReady()){if(a=e,r.markAsUnprocessed(),o.lightDisposed)return r._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(a,r,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}get compiledShaders(){return`// Vertex shader\n${this._vertexCompilationState.compilationString}\n\n// Fragment shader\n${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const t of this._sharedData.inputBlocks)t._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.effect;if(!r)return;this._activeEffect=r,this.bindOnlyWorldMatrix(e);const n=this._mustRebind(s,r,t.visibility),o=this._sharedData;if(n){for(const e of o.bindableBlocks)e.bind(r,this,t,i);for(const e of o.forcedBindableBlocks)e.bind(r,this,t,i);for(const e of o.inputBlocks)e._transmit(r,s,this)}else if(!this.isFrozen)for(const e of o.forcedBindableBlocks)e.bind(r,this,t,i);this._afterBind(t,this._activeEffect)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter((e=>e.texture)).map((e=>e.texture))),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)$._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const e of this.getTextureBlocks().filter((e=>e.texture)).map((e=>e.texture)))e.dispose();for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){const t=Object.assign({nodeMaterial:this},e);this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return new Promise((t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),void 0===this.BJSNODEMATERIALEDITOR){const i=e&&e.editorURL?e.editorURL:$.EditorURL;m.w1.LoadScript(i,(()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(null==e?void 0:e.nodeEditorConfig),t()}))}else this._createNodeEditor(null==e?void 0:e.nodeEditorConfig),t()}))}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;const e=new y.S("Position");e.setAsAttribute("position");const t=new y.S("World");t.setAsSystemValue(G.$.World);const i=new f.m("WorldPos");e.connectTo(i),t.connectTo(i);const s=new y.S("ViewProjection");s.setAsSystemValue(G.$.ViewProjection);const r=new f.m("WorldPos * ViewProjectionTransform");i.connectTo(r),s.connectTo(r);const n=new b.t("VertexOutput");r.connectTo(n);const o=new y.S("color");o.value=new a.HE(.8,.8,.8,1);const h=new v.g("FragmentOutput");o.connectTo(h),this.addOutputNode(n),this.addOutputNode(h),this._mode=D.a.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new y.S("Position");e.setAsAttribute("position2d");const t=new y.S("Constant1");t.isConstant=!0,t.value=1;const i=new I.t("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new b.t("VertexOutput");i.connectTo(s);const r=new y.S("Scale");r.visibleInInspector=!0,r.value=new o.FM(1,1);const n=new O.w("uv0");e.connectTo(n);const a=new w.U("UV scale");n.connectTo(a),r.connectTo(a);const h=new C.K("CurrentScreen");a.connectTo(h),h.texture=new B.x("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const l=new v.g("FragmentOutput");h.connectTo(l,{output:"rgba"}),this.addOutputNode(s),this.addOutputNode(l),this._mode=D.a.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new y.S("Position");e.setAsAttribute("position2d");const t=new y.S("Constant1");t.isConstant=!0,t.value=1;const i=new I.t("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new b.t("VertexOutput");i.connectTo(s);const r=new y.S("Time");r.value=0,r.min=0,r.max=0,r.isBoolean=!1,r.matrixMode=0,r.animationType=k.c.Time,r.isConstant=!1;const n=new y.S("Color3");n.value=new a.Wo(1,1,1),n.isConstant=!1;const o=new v.g("FragmentOutput"),h=new I.t("VectorMerger");h.visibleInInspector=!1;const l=new z.S("Cos");l.operation=z.p.Cos,e.connectTo(h),r.output.connectTo(l.input),l.output.connectTo(h.z),h.xyzOut.connectTo(o.rgb),this.addOutputNode(s),this.addOutputNode(o),this._mode=D.a.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new y.S("uv");e.setAsAttribute("particle_uv");const t=new T.P("ParticleTexture");e.connectTo(t);const i=new y.S("Color");i.setAsAttribute("particle_color");const s=new w.U("Texture * Color");t.connectTo(s),i.connectTo(s);const r=new S.p("ParticleRampGradient");s.connectTo(r);const n=new F.v("ColorSplitter");i.connectTo(n);const o=new E.D("ParticleBlendMultiply");r.connectTo(o),t.connectTo(o,{output:"a"}),n.connectTo(o,{output:"a"});const a=new v.g("FragmentOutput");o.connectTo(a),this.addOutputNode(a),this._mode=D.a.Particle}async loadAsync(e,t=""){return $.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const s=i.connectedPoint;if(s){const i=s.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,t);const s=[];for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,s);let r=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\n`;r+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${D.a[this.mode]};\n`;for(const s of t)s.isInput&&-1===e.indexOf(s)&&(r+=s._dumpCode(i,e));for(const t of s)t.isInput&&-1===e.indexOf(t)&&(r+=t._dumpCode(i,e));e=[],r+="\n// Connections\n";for(const t of this._vertexOutputNodes)r+=t._dumpCodeForOutputConnections(e);for(const t of this._fragmentOutputNodes)r+=t._dumpCodeForOutputConnections(e);r+="\n// Output nodes\n";for(const e of this._vertexOutputNodes)r+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;for(const e of this._fragmentOutputNodes)r+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;return r+="nodeMaterial.build();\n",r}serialize(e){const t=e?{}:P.p4.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,i),t.outputNodes.push(e.uniqueId);for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,i),-1===t.outputNodes.indexOf(e.uniqueId)&&t.outputNodes.push(e.uniqueId)}t.blocks=[];for(const e of i)t.blocks.push(e.serialize());if(!e)for(const e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t}_restoreConnections(e,t,i){for(const s of e.outputs)for(const r of t.blocks){const n=i[r.id];if(n)for(const o of r.inputs)if(i[o.targetBlockId]!==e||o.targetConnectionName!==s.name);else{const e=n.getInputByName(o.inputName);if(!e||e.isConnected)continue;s.connectTo(e,!0),this._restoreConnections(n,t,i)}}}parseSerializedObject(e,t="",i=!1){var s;i||this.clear();const r={};for(const i of e.blocks){const e=(0,x.q)(i.customType);if(e){const s=new e;s._deserialize(i,this.getScene(),t),r[i.id]=s,this.attachedBlocks.push(s)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,i=t._tempEntryPointUniqueId;i&&r[i].attachToEndpoint(t)}for(let t=0;t<e.blocks.length;t++){const s=r[e.blocks[t].id];s&&(s.inputs.length&&!i||this._restoreConnections(s,e,r))}if(e.outputNodes)for(const t of e.outputNodes)this.addOutputNode(r[t]);if(e.locations||e.editorData&&e.editorData.locations){const t=e.locations||e.editorData.locations;for(const e of t)r[e.blockId]&&(e.blockId=r[e.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&t.concat(this.editorData.locations),e.locations?this.editorData={locations:t}:(this.editorData=e.editorData,this.editorData.locations=t);const s=[];for(const e in r)s[e]=r[e].uniqueId;this.editorData.map=s}this.comment=e.comment,void 0!==e.forceAlphaBlending&&(this.forceAlphaBlending=e.forceAlphaBlending),i||(this._mode=null!==(s=e.mode)&&void 0!==s?s:D.a.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),s=P.p4.Clone((()=>new $(e,this.getScene(),this.options)),this);return s.id=e,s.name=e,s.parseSerializedObject(i),s._buildId=this._buildId,s.build(!1,!t),s}static Parse(e,t,i=""){const s=P.p4.Parse((()=>new $(e.name,t)),e,t,i);return s.parseSerializedObject(e,i),s.build(),s}static async ParseFromFileAsync(e,t,i,s="",r=!1,n){const o=null!=n?n:new $(e,i),a=await i._loadFileAsync(t),h=JSON.parse(a);return o.parseSerializedObject(h,s),r||o.build(),o}static ParseFromSnippetAsync(e,t=U.l.LastCreatedScene,i="",s,r=!1){return"_BLANK"===e?Promise.resolve($.CreateDefault("blank",t)):new Promise(((n,o)=>{const a=new M.g;a.addEventListener("readystatechange",(()=>{if(4==a.readyState)if(200==a.status){const h=JSON.parse(JSON.parse(a.responseText).jsonPayload),l=JSON.parse(h.nodeMaterial);s||((s=P.p4.Parse((()=>new $(e,t)),l,t,i)).uniqueId=t.getUniqueId()),s.parseSerializedObject(l),s.snippetId=e;try{r||s.build(),n(s)}catch(e){o(e)}}else o("Unable to load the snippet "+e)})),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()}))}static CreateDefault(e,t){const i=new $(e,t);return i.setToDefault(),i.build(),i}}$._BuildIdGenerator=0,$.EditorURL=`https://unpkg.com/babylonjs-node-editor@${h.D.Version}/babylon.nodeEditor.js`,$.SnippetUrl="https://snippet.babylonjs.com",$.IgnoreTexturesAtLoadTime=!1,(0,s.gn)([(0,P.qC)()],$.prototype,"ignoreAlpha",void 0),(0,s.gn)([(0,P.qC)()],$.prototype,"maxSimultaneousLights",void 0),(0,s.gn)([(0,P.qC)("mode")],$.prototype,"_mode",void 0),(0,s.gn)([(0,P.qC)("comment")],$.prototype,"comment",void 0),(0,s.gn)([(0,P.qC)()],$.prototype,"forceAlphaBlending",void 0),(0,x.H)("BABYLON.NodeMaterial",$)},47409:(e,t,i)=>{i.d(t,{RP:()=>p,VL:()=>r,Vw:()=>s,mZ:()=>_,qG:()=>n});var s,r,n,o=i(47469),a=i(76305),h=i(66794),l=i(90972),c=i(89859),u=i(63478),d=i(9827);!function(e){e[e.MATERIAL_TYPE_STANDARD=0]="MATERIAL_TYPE_STANDARD",e[e.MATERIAL_TYPE_PBR=1]="MATERIAL_TYPE_PBR",e[e.MATERIAL_TYPE_SIMPLE=2]="MATERIAL_TYPE_SIMPLE"}(s||(s={})),function(e){e[e.COLOR_MODE_SET=0]="COLOR_MODE_SET",e[e.COLOR_MODE_ADD=1]="COLOR_MODE_ADD",e[e.COLOR_MODE_MULTIPLY=2]="COLOR_MODE_MULTIPLY"}(r||(r={})),function(e){e[e.COLOR_DISTRIBUTION_TYPE_SEGMENT=0]="COLOR_DISTRIBUTION_TYPE_SEGMENT",e[e.COLOR_DISTRIBUTION_TYPE_LINE=1]="COLOR_DISTRIBUTION_TYPE_LINE"}(n||(n={}));class p extends u.H{constructor(){super(...arguments),this.GREASED_LINE_HAS_COLOR=!1,this.GREASED_LINE_SIZE_ATTENUATION=!1,this.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=!1,this.GREASED_LNE_RIGHT_HANDED_COORDINATE_SYSTEM=!1}}class _ extends h.n{constructor(e,t,i){var s,o,h,c,u,d,g,m,f,b,v,y,x,P,C;i=i||{color:_.DEFAULT_COLOR};const T=new p;T.GREASED_LINE_HAS_COLOR=!!i.color,T.GREASED_LINE_SIZE_ATTENUATION=null!==(s=i.sizeAttenuation)&&void 0!==s&&s,T.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=i.colorDistributionType===n.COLOR_DISTRIBUTION_TYPE_LINE,T.GREASED_LNE_RIGHT_HANDED_COORDINATE_SYSTEM=(null!=t?t:e.getScene()).useRightHandedSystem,super(e,_.GREASED_LINE_MATERIAL_NAME,200,T),this._scene=null!=t?t:e.getScene(),this._engine=this._scene.getEngine(),this.visibility=null!==(o=i.visibility)&&void 0!==o?o:1,this.useDash=null!==(h=i.useDash)&&void 0!==h&&h,this.dashRatio=null!==(c=i.dashRatio)&&void 0!==c?c:.5,this.dashOffset=null!==(u=i.dashOffset)&&void 0!==u?u:0,this.width=i.width?i.width:i.sizeAttenuation?_.DEFAULT_WIDTH_ATTENUATED:_.DEFAULT_WIDTH,this._sizeAttenuation=null!==(d=i.sizeAttenuation)&&void 0!==d&&d,this.colorMode=null!==(g=i.colorMode)&&void 0!==g?g:r.COLOR_MODE_SET,this._color=null!==(m=i.color)&&void 0!==m?m:null,this.useColors=null!==(f=i.useColors)&&void 0!==f&&f,this._colorsDistributionType=null!==(b=i.colorDistributionType)&&void 0!==b?b:n.COLOR_DISTRIBUTION_TYPE_SEGMENT,this.colorsSampling=null!==(v=i.colorsSampling)&&void 0!==v?v:a.l.NEAREST_NEAREST,this._colors=null!==(y=i.colors)&&void 0!==y?y:null,this.dashCount=null!==(x=i.dashCount)&&void 0!==x?x:1,this.resolution=null!==(P=i.resolution)&&void 0!==P?P:new l.FM(this._engine.getRenderWidth(),this._engine.getRenderHeight()),this._colors?this._createColorsTexture(`${e.name}-colors-texture`,this._colors):(this._color=null!==(C=this._color)&&void 0!==C?C:_.DEFAULT_COLOR,_._PrepareEmptyColorsTexture(this._scene)),this._engine.onDisposeObservable.add((()=>{var e;null===(e=_._EmptyColorsTexture)||void 0===e||e.dispose(),_._EmptyColorsTexture=null})),this._enable(!0)}getAttributes(e){e.push("grl_offsets"),e.push("grl_previousAndSide"),e.push("grl_nextAndCounters"),e.push("grl_widths"),e.push("grl_colorPointers")}getSamplers(e){e.push("grl_colors")}getActiveTextures(e){this._colorsTexture&&e.push(this._colorsTexture)}getUniforms(){return{ubo:[{name:"grl_projection",size:16,type:"mat4"},{name:"grl_singleColor",size:3,type:"vec3"},{name:"grl_aspect_resolution_lineWidth",size:4,type:"vec4"},{name:"grl_dashOptions",size:4,type:"vec4"},{name:"grl_colorMode_visibility_colorsWidth_useColors",size:4,type:"vec4"}],vertex:"\n                uniform vec4 grl_aspect_resolution_lineWidth;\n                uniform mat4 grl_projection;\n                ",fragment:"\n                uniform vec4 grl_dashOptions;\n                uniform vec4 grl_colorMode_visibility_colorsWidth_useColors;\n                uniform vec3 grl_singleColor;\n                "}}get isEnabled(){return!0}bindForSubMesh(e){var t;const i=this._scene.activeCamera;if(!i)throw Error("GreasedLinePluginMaterial requires an active camera.");{const t=i.getProjectionMatrix();e.updateMatrix("grl_projection",t)}const s=l.jp.Vector4[0];s.x=this._aspect,s.y=this._resolution.x,s.z=this._resolution.y,s.w=this.width,e.updateVector4("grl_aspect_resolution_lineWidth",s);const r=l.jp.Vector4[0];r.x=_._BooleanToNumber(this.useDash),r.y=this._dashArray,r.z=this.dashOffset,r.w=this.dashRatio,e.updateVector4("grl_dashOptions",r);const n=l.jp.Vector4[1];n.x=this.colorMode,n.y=this.visibility,n.z=this._colorsTexture?this._colorsTexture.getSize().width:0,n.w=_._BooleanToNumber(this.useColors),e.updateVector4("grl_colorMode_visibility_colorsWidth_useColors",n),this._color&&e.updateColor3("grl_singleColor",this._color),e.setTexture("grl_colors",null!==(t=this._colorsTexture)&&void 0!==t?t:_._EmptyColorsTexture)}prepareDefines(e,t,i){var s;e.GREASED_LINE_HAS_COLOR=!!this._color,e.GREASED_LINE_SIZE_ATTENUATION=null!==(s=this._sizeAttenuation)&&void 0!==s&&s,e.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=this._colorsDistributionType===n.COLOR_DISTRIBUTION_TYPE_LINE,e.GREASED_LNE_RIGHT_HANDED_COORDINATE_SYSTEM=t.useRightHandedSystem}getClassName(){return _.GREASED_LINE_MATERIAL_NAME}getCustomCode(e){return"vertex"===e?{CUSTOM_VERTEX_DEFINITIONS:"\n                    attribute vec4 grl_previousAndSide;\n                    attribute vec4 grl_nextAndCounters;\n                    attribute float grl_widths;\n                    attribute vec3 grl_offsets;\n                    attribute float grl_colorPointers;\n\n                    varying float grlCounters;\n                    varying float grlColorPointer;\n\n                    vec2 grlFix( vec4 i, float aspect ) {\n                        vec2 res = i.xy / i.w;\n                        res.x *= aspect;\n                        return res;\n                    }\n                ",CUSTOM_VERTEX_UPDATE_POSITION:"\n                    vec3 grlPositionOffset = grl_offsets;\n                    positionUpdated += grlPositionOffset;\n                ",CUSTOM_VERTEX_MAIN_END:"\n\n                    float grlAspect = grl_aspect_resolution_lineWidth.x;\n                    float grlBaseWidth = grl_aspect_resolution_lineWidth.w;\n\n                    grlColorPointer = grl_colorPointers;\n\n                    vec3 grlPrevious = grl_previousAndSide.xyz;\n                    float grlSide = grl_previousAndSide.w;\n\n                    vec3 grlNext = grl_nextAndCounters.xyz;\n                    grlCounters = grl_nextAndCounters.w;\n\n\n                    mat4 grlMatrix = viewProjection * world;\n                    vec4 grlFinalPosition = grlMatrix * vec4( positionUpdated , 1.0 );\n                    vec4 grlPrevPos = grlMatrix * vec4( grlPrevious + grlPositionOffset, 1.0 );\n                    vec4 grlNextPos = grlMatrix * vec4( grlNext + grlPositionOffset, 1.0 );\n\n                    vec2 grlCurrentP = grlFix( grlFinalPosition, grlAspect );\n                    vec2 grlPrevP = grlFix( grlPrevPos, grlAspect );\n                    vec2 grlNextP = grlFix( grlNextPos, grlAspect );\n\n                    float grlWidth = grlBaseWidth * grl_widths;\n\n                    vec2 grlDir;\n                    if( grlNextP == grlCurrentP ) grlDir = normalize( grlCurrentP - grlPrevP );\n                    else if( grlPrevP == grlCurrentP ) grlDir = normalize( grlNextP - grlCurrentP );\n                    else {\n                        vec2 grlDir1 = normalize( grlCurrentP - grlPrevP );\n                        vec2 grlDir2 = normalize( grlNextP - grlCurrentP );\n                        grlDir = normalize( grlDir1 + grlDir2 );\n                    }\n                    vec4 grlNormal = vec4( -grlDir.y, grlDir.x, 0., 1. );\n                    #ifdef GREASED_LNE_RIGHT_HANDED_COORDINATE_SYSTEM\n                        grlNormal.xy *= -.5 * grlWidth;\n                    #else\n                        grlNormal.xy *= .5 * grlWidth;\n                    #endif\n                    grlNormal *= grl_projection;\n                    #ifdef GREASED_LINE_SIZE_ATTENUATION\n                        grlNormal.xy *= grlFinalPosition.w;\n                        grlNormal.xy /= ( vec4( grl_aspect_resolution_lineWidth.yz, 0., 1. ) * grl_projection ).xy;\n                    #endif\n                    grlFinalPosition.xy += grlNormal.xy * grlSide;\n                    gl_Position = grlFinalPosition;\n\n                    vPositionW = vec3(grlFinalPosition);\n\n                ","!gl_Position\\=viewProjection\\*worldPos;":"//"}:"fragment"===e?{CUSTOM_FRAGMENT_DEFINITIONS:"\n                    varying float grlCounters;\n                    varying float grlColorPointer;\n                    uniform sampler2D grl_colors;\n                ",CUSTOM_FRAGMENT_MAIN_END:`\n                    float grlColorMode = grl_colorMode_visibility_colorsWidth_useColors.x;\n                    float grlVisibility = grl_colorMode_visibility_colorsWidth_useColors.y;\n                    float grlColorsWidth = grl_colorMode_visibility_colorsWidth_useColors.z;\n                    float grlUseColors = grl_colorMode_visibility_colorsWidth_useColors.w;\n\n                    float grlUseDash = grl_dashOptions.x;\n                    float grlDashArray = grl_dashOptions.y;\n                    float grlDashOffset = grl_dashOptions.z;\n                    float grlDashRatio = grl_dashOptions.w;\n\n                    gl_FragColor.a *= step(grlCounters, grlVisibility);\n                    if( gl_FragColor.a == 0. ) discard;\n\n                    if(grlUseDash == 1.){\n                        gl_FragColor.a *= ceil(mod(grlCounters + grlDashOffset, grlDashArray) - (grlDashArray * grlDashRatio));\n                        if (gl_FragColor.a == 0.) discard;\n                    }\n\n                    #ifdef GREASED_LINE_HAS_COLOR\n                        if (grlColorMode == ${r.COLOR_MODE_SET}.) {\n                            gl_FragColor.rgb = grl_singleColor;\n                        } else if (grlColorMode == ${r.COLOR_MODE_ADD}.) {\n                            gl_FragColor.rgb += grl_singleColor;\n                        } else if (grlColorMode == ${r.COLOR_MODE_MULTIPLY}.) {\n                            gl_FragColor.rgb *= grl_singleColor;\n                        }\n                    #else\n                        if (grlUseColors == 1.) {\n                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE\n                                vec4 grlColor = texture2D(grl_colors, vec2(grlCounters, 0.), 0.);\n                            #else\n                                vec4 grlColor = texture2D(grl_colors, vec2(grlColorPointer/grlColorsWidth, 0.), 0.);\n                            #endif\n                            if (grlColorMode == ${r.COLOR_MODE_SET}.) {\n                                gl_FragColor = grlColor;\n                            } else if (grlColorMode == ${r.COLOR_MODE_ADD}.) {\n                                gl_FragColor += grlColor;\n                            } else if (grlColorMode == ${r.COLOR_MODE_MULTIPLY}.) {\n                                gl_FragColor *= grlColor;\n                            }\n                        }\n                    #endif\n                `}:null}static _BooleanToNumber(e){return e?1:0}static _Color3toRGBAUint8(e){const t=new Uint8Array(4*e.length);for(let i=0,s=0;i<e.length;i++)t[s++]=255*e[i].r,t[s++]=255*e[i].g,t[s++]=255*e[i].b,t[s++]=255;return t}_createColorsTexture(e,t){const i=_._Color3toRGBAUint8(t);this._colorsTexture=new a.l(i,t.length,1,o.D.TEXTUREFORMAT_RGBA,this._scene,!1,!0,this.colorsSampling),this._colorsTexture.name=e}dispose(){var e;null===(e=this._colorsTexture)||void 0===e||e.dispose(),super.dispose()}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){var s,r,n,o;const a=null!==(r=null===(s=this._colors)||void 0===s?void 0:s.length)&&void 0!==r?r:0;if(this._colors=e,null!==e&&0!==e.length){if(!t||i)if(this._colorsTexture&&a===e.length&&!i){const t=_._Color3toRGBAUint8(e);this._colorsTexture.update(t)}else null===(o=this._colorsTexture)||void 0===o||o.dispose(),this._createColorsTexture(`${this._material.name}-colors-texture`,e)}else null===(n=this._colorsTexture)||void 0===n||n.dispose()}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.markAllDefinesAsDirty()}get color(){return this._color}set color(e){this.setColor(e)}setColor(e,t=!1){null===this._color&&null!==e||null!==this._color&&null===e?(this._color=e,!t&&this.markAllDefinesAsDirty()):this._color=e}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this.markAllDefinesAsDirty()}get resolution(){return this._resolution}set resolution(e){this._aspect=e.x/e.y,this._resolution=e}serialize(){const e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this.colorsSampling,colorMode:this.colorMode,dashCount:this._dashCount,dashOffset:this.dashOffset,dashRatio:this.dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this.useColors,useDash:this.useDash,visibility:this.visibility,width:this.width};return this._colors&&(t.colors=this._colors),this._color&&(t.color=this._color),e.greasedLineMaterialOptions=t,e}parse(e,t,i){var s;super.parse(e,t,i);const r=e.greasedLineMaterialOptions;null===(s=this._colorsTexture)||void 0===s||s.dispose(),r.colors?this._createColorsTexture(`${this._material.name}-colors-texture`,r.colors):_._PrepareEmptyColorsTexture(t),r.color&&this.setColor(r.color,!0),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),this.markAllDefinesAsDirty()}copyTo(e){var t;const i=e;null===(t=i._colorsTexture)||void 0===t||t.dispose(),this._colors&&i._createColorsTexture(`${i._material.name}-colors-texture`,this._colors),i.setColor(this.color,!0),i.colorsDistributionType=this.colorsDistributionType,i.colorsSampling=this.colorsSampling,i.colorMode=this.colorMode,i.useColors=this.useColors,i.visibility=this.visibility,i.useDash=this.useDash,i.dashCount=this.dashCount,i.dashRatio=this.dashRatio,i.dashOffset=this.dashOffset,i.width=this.width,i.sizeAttenuation=this.sizeAttenuation,i.resolution=this.resolution,i.markAllDefinesAsDirty()}static _PrepareEmptyColorsTexture(e){if(!this._EmptyColorsTexture){const t=new Uint8Array(4);_._EmptyColorsTexture=new a.l(t,1,1,o.D.TEXTUREFORMAT_RGBA,e,!1,!1,a.l.NEAREST_NEAREST),_._EmptyColorsTexture.name="grlEmptyColorsTexture"}}}_.GREASED_LINE_MATERIAL_NAME="GreasedLinePluginMaterial",_.DEFAULT_COLOR=c.Wo.White(),_.DEFAULT_WIDTH_ATTENUATED=1,_.DEFAULT_WIDTH=.1,(0,d.H)(`BABYLON.${_.GREASED_LINE_MATERIAL_NAME}`,_)},46867:(e,t,i)=>{i.d(t,{A:()=>c,E:()=>u});var s=i(13555),r=i(96786),n=i(63478),o=i(66794),a=i(53243),h=i(96721),l=i(9827);class c extends n.H{constructor(){super(...arguments),this.DECAL=!1,this.DECALDIRECTUV=0,this.DECAL_SMOOTHALPHA=!1,this.GAMMADECAL=!1}}class u extends o.n{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DecalMap",150,new c,t),this._isEnabled=!1,this.isEnabled=!1,this._smoothAlpha=!1,this.smoothAlpha=!1,this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i,s){const r=s.getMesh().decalMap;return!(this._isEnabled&&(null==r?void 0:r.texture)&&a.k.DecalMapEnabled&&t.texturesEnabled)||r.isReady()}prepareDefines(e,t,i){const s=i.decalMap;this._isEnabled&&(null==s?void 0:s.texture)&&a.k.DecalMapEnabled&&t.texturesEnabled?((!e.DECAL||e.GAMMADECAL!==s.texture.gammaSpace)&&e.markAsTexturesDirty(),e.DECAL=!0,e.GAMMADECAL=s.texture.gammaSpace,e.DECAL_SMOOTHALPHA=this._smoothAlpha,h.G.PrepareDefinesForMergedUV(s.texture,e,"DECAL")):(e.DECAL&&e.markAsTexturesDirty(),e.DECAL=!1)}hardBindForSubMesh(e,t,i,s){const r=s.getMesh().decalMap;if(!(this._isEnabled&&(null==r?void 0:r.texture)&&a.k.DecalMapEnabled&&t.texturesEnabled))return;const n=this._material.isFrozen,o=r.texture;e.useUbo&&n&&e.isSync||(e.updateFloat4("vDecalInfos",o.coordinatesIndex,0,0,0),h.G.BindTextureMatrix(o,e,"decal")),e.setTexture("decalSampler",o)}getClassName(){return"DecalMapConfiguration"}getSamplers(e){e.push("decalSampler")}getUniforms(){return{ubo:[{name:"vDecalInfos",size:4,type:"vec4"},{name:"decalMatrix",size:16,type:"mat4"}]}}}(0,s.gn)([(0,r.qC)(),(0,r.wz)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"isEnabled",void 0),(0,s.gn)([(0,r.qC)(),(0,r.wz)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"smoothAlpha",void 0),(0,l.H)("BABYLON.DecalMapConfiguration",u)},97330:(e,t,i)=>{i.d(t,{AY:()=>s,KD:()=>a,rX:()=>r});var s,r,n=i(64673),o=i(99258);!function(e){e[e.Compatible=0]="Compatible",e[e.TypeIncompatible=1]="TypeIncompatible",e[e.HierarchyIssue=2]="HierarchyIssue"}(s||(s={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(r||(r={}));class a{get direction(){return this._direction}get type(){if(this._type===o.g.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===o.g.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map((e=>e.ownerBlock))}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}getConnectedValue(e){var t,i,s;return this.isConnected?(null===(t=this._connectedPoint)||void 0===t?void 0:t._storedFunction)?null===(i=this._connectedPoint)||void 0===i?void 0:i._storedFunction(e):null===(s=this._connectedPoint)||void 0===s?void 0:s._storedValue:this.value}constructor(e,t,i){this._connectedPoint=null,this._storedValue=null,this._storedFunction=null,this._acceptedConnectionPointType=null,this._endpoints=new Array,this._type=o.g.Geometry,this._linkedConnectionSource=null,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new n.y$,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this.defaultValue=null,this.value=null,this.valueMin=null,this.valueMax=null,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeGeometryConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===s.Compatible}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==o.g.AutoDetect)return e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)?s.Compatible:s.TypeIncompatible;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return s.TypeIncompatible;let n=i,a=t;return this.direction===r.Input&&(n=t,a=i),n.isAnAncestorOf(a)?s.HierarchyIssue:s.Compatible}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<o.g.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,void 0!==this.value&&null!==this.value&&(this.value.asArray?(t.valueType="BABYLON."+this.value.getClassName(),t.value=this.value.asArray()):(t.valueType="number",t.value=this.value)),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name),t}dispose(){this.onConnectionObservable.clear()}}},13295:(e,t,i)=>{i.d(t,{Q:()=>s,p:()=>n});var s,r=i(7084);i(3685),function(e){e[e.None=0]="None",e[e.ToLinearSpace=1]="ToLinearSpace",e[e.ToGammaSpace=2]="ToGammaSpace"}(s||(s={}));class n{_textureIsInternal(e){return void 0===e.getInternalTexture}constructor(e,t=!1){this._engine=e,this._isDepthTexture=t,this._renderer=new r.I(e),this._effectWrapper=new r.H({engine:e,name:"CopyTextureToTexture",fragmentShader:"copyTextureToTexture",useShaderStore:!0,uniformNames:["conversion"],samplerNames:["textureSampler"],defines:t?["#define DEPTH_TEXTURE"]:[]}),this._effectWrapper.onApplyObservable.add((()=>{t&&(e.setState(!1),e.setDepthBuffer(!0),e.depthCullingState.depthMask=!0,e.depthCullingState.depthFunc=519),this._textureIsInternal(this._source)?this._effectWrapper.effect._bindTexture("textureSampler",this._source):this._effectWrapper.effect.setTexture("textureSampler",this._source),this._effectWrapper.effect.setFloat("conversion",this._conversion)}))}isReady(){return this._effectWrapper.effect.isReady()}copy(e,t,i=s.None){if(!this.isReady())return!1;this._source=e,this._conversion=i;const r=this._engine.depthCullingState.depthFunc;return this._renderer.render(this._effectWrapper,t),this._isDepthTexture&&r&&(this._engine.depthCullingState.depthFunc=r),!0}dispose(){this._effectWrapper.dispose(),this._renderer.dispose()}}},60689:(e,t,i)=>{i.d(t,{g_:()=>n,vs:()=>s,xb:()=>o});var s,r=i(64673);function n(e){var t;let i=0;const s=Date.now();e.observableParameters=null!==(t=e.observableParameters)&&void 0!==t?t:{};const r=e.contextObservable.add((t=>{const n=Date.now();i=n-s;const o={startTime:s,currentTime:n,deltaTime:i,completeRate:i/e.timeout,payload:t};e.onTick&&e.onTick(o),e.breakCondition&&e.breakCondition()&&(e.contextObservable.remove(r),e.onAborted&&e.onAborted(o)),i>=e.timeout&&(e.contextObservable.remove(r),e.onEnded&&e.onEnded(o))}),e.observableParameters.mask,e.observableParameters.insertFirst,e.observableParameters.scope);return r}!function(e){e[e.INIT=0]="INIT",e[e.STARTED=1]="STARTED",e[e.ENDED=2]="ENDED"}(s||(s={}));class o{constructor(e){var t,i;this.onEachCountObservable=new r.y$,this.onTimerAbortedObservable=new r.y$,this.onTimerEndedObservable=new r.y$,this.onStateChangedObservable=new r.y$,this._observer=null,this._breakOnNextTick=!1,this._tick=e=>{const t=Date.now();this._timer=t-this._startTime;const i={startTime:this._startTime,currentTime:t,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:e},s=this._breakOnNextTick||this._breakCondition(i);s||this._timer>=this._timeToEnd?this._stop(i,s):this.onEachCountObservable.notifyObservers(i)},this._setState(s.INIT),this._contextObservable=e.contextObservable,this._observableParameters=null!==(t=e.observableParameters)&&void 0!==t?t:{},this._breakCondition=null!==(i=e.breakCondition)&&void 0!==i?i:()=>!1,this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(this._state===s.STARTED)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(s.STARTED)}stop(){this._state===s.STARTED&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,t=!1){this._contextObservable.remove(this._observer),this._setState(s.ENDED),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}}},3003:(e,t,i)=>{i.d(t,{Ai:()=>h.A,E0:()=>l.E,F3:()=>c.F,LV:()=>r.L,S3:()=>s.S,VD:()=>o.V,cE:()=>h.c,cl:()=>a.c,kT:()=>n.k,z:()=>n.z});var s=i(10231),r=i(13726),n=i(31591),o=i(99220),a=(i(98294),i(42860)),h=i(37506),l=i(38813),c=i(88855)},64200:(e,t,i)=>{i.d(t,{J:()=>o,i:()=>n});var s=i(90972),r=i(31932);i(86049);class n extends r.D{getClassName(){return"StereoscopicInterlacePostProcessI"}constructor(e,t,i,r,n,o,a){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],n,o,a,r?"#define IS_STEREOSCOPIC_INTERLACED 1":i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new s.FM(1/this.width,1/this.height),this.onSizeChangedObservable.add((()=>{this._stepSize=new s.FM(1/this.width,1/this.height)})),this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("camASampler",this._passedProcess),e.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)}))}}class o extends r.D{getClassName(){return"StereoscopicInterlacePostProcess"}constructor(e,t,i,r,n,o){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],r,n,o,i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new s.FM(1/this.width,1/this.height),this.onSizeChangedObservable.add((()=>{this._stepSize=new s.FM(1/this.width,1/this.height)})),this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("camASampler",this._passedProcess),e.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)}))}}},78091:(e,t,i)=>{i.d(t,{b:()=>o});var s=i(8714),r=i(84686),n=i(90065);Object.defineProperty(s.x.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(e){e&&e.isSupported&&(this._geometryBufferRenderer=e)},enumerable:!0,configurable:!0}),s.x.prototype.enableGeometryBufferRenderer=function(e=1,t=15){return this._geometryBufferRenderer||(this._geometryBufferRenderer=new n.m(this,e,t),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null)),this._geometryBufferRenderer},s.x.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class o{constructor(e){this.name=r.l.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(r.l.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}n.m._SceneComponentInitialization=e=>{let t=e._getComponent(r.l.NAME_GEOMETRYBUFFERRENDERER);t||(t=new o(e),e._addComponent(t))}},96985:(e,t,i)=>{i.d(t,{OF:()=>s,e0:()=>y,en:()=>x,fL:()=>r});var s,r,n=i(36210),o=i(17249),a=i(90972),h=i(83262),l=i(64673),c=i(86409),u=i(89859),d=i(93871),p=i(79061),_=i(66377),g=i(44482),m=i(730),f=i(40078);!function(e){e.WRIST="wrist",e.THUMB="thumb",e.INDEX="index",e.MIDDLE="middle",e.RING="ring",e.LITTLE="little"}(s||(s={})),function(e){e.WRIST="wrist",e.THUMB_METACARPAL="thumb-metacarpal",e.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",e.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",e.THUMB_TIP="thumb-tip",e.INDEX_FINGER_METACARPAL="index-finger-metacarpal",e.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",e.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",e.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",e.INDEX_FINGER_TIP="index-finger-tip",e.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",e.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",e.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",e.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",e.MIDDLE_FINGER_TIP="middle-finger-tip",e.RING_FINGER_METACARPAL="ring-finger-metacarpal",e.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",e.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",e.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",e.RING_FINGER_TIP="ring-finger-tip",e.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",e.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",e.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",e.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",e.PINKY_FINGER_TIP="pinky-finger-tip"}(r||(r={}));const b=[r.WRIST,r.THUMB_METACARPAL,r.THUMB_PHALANX_PROXIMAL,r.THUMB_PHALANX_DISTAL,r.THUMB_TIP,r.INDEX_FINGER_METACARPAL,r.INDEX_FINGER_PHALANX_PROXIMAL,r.INDEX_FINGER_PHALANX_INTERMEDIATE,r.INDEX_FINGER_PHALANX_DISTAL,r.INDEX_FINGER_TIP,r.MIDDLE_FINGER_METACARPAL,r.MIDDLE_FINGER_PHALANX_PROXIMAL,r.MIDDLE_FINGER_PHALANX_INTERMEDIATE,r.MIDDLE_FINGER_PHALANX_DISTAL,r.MIDDLE_FINGER_TIP,r.RING_FINGER_METACARPAL,r.RING_FINGER_PHALANX_PROXIMAL,r.RING_FINGER_PHALANX_INTERMEDIATE,r.RING_FINGER_PHALANX_DISTAL,r.RING_FINGER_TIP,r.PINKY_FINGER_METACARPAL,r.PINKY_FINGER_PHALANX_PROXIMAL,r.PINKY_FINGER_PHALANX_INTERMEDIATE,r.PINKY_FINGER_PHALANX_DISTAL,r.PINKY_FINGER_TIP],v={[s.WRIST]:[r.WRIST],[s.THUMB]:[r.THUMB_METACARPAL,r.THUMB_PHALANX_PROXIMAL,r.THUMB_PHALANX_DISTAL,r.THUMB_TIP],[s.INDEX]:[r.INDEX_FINGER_METACARPAL,r.INDEX_FINGER_PHALANX_PROXIMAL,r.INDEX_FINGER_PHALANX_INTERMEDIATE,r.INDEX_FINGER_PHALANX_DISTAL,r.INDEX_FINGER_TIP],[s.MIDDLE]:[r.MIDDLE_FINGER_METACARPAL,r.MIDDLE_FINGER_PHALANX_PROXIMAL,r.MIDDLE_FINGER_PHALANX_INTERMEDIATE,r.MIDDLE_FINGER_PHALANX_DISTAL,r.MIDDLE_FINGER_TIP],[s.RING]:[r.RING_FINGER_METACARPAL,r.RING_FINGER_PHALANX_PROXIMAL,r.RING_FINGER_PHALANX_INTERMEDIATE,r.RING_FINGER_PHALANX_DISTAL,r.RING_FINGER_TIP],[s.LITTLE]:[r.PINKY_FINGER_METACARPAL,r.PINKY_FINGER_PHALANX_PROXIMAL,r.PINKY_FINGER_PHALANX_INTERMEDIATE,r.PINKY_FINGER_PHALANX_DISTAL,r.PINKY_FINGER_TIP]};class y{get handMesh(){return this._handMesh}getHandPartMeshes(e){return v[e].map((e=>this._jointMeshes[b.indexOf(e)]))}getJointMesh(e){return this._jointMeshes[b.indexOf(e)]}constructor(e,t,i,s,r=!1,n=!1,o=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=s,this._leftHandedMeshes=r,this._jointsInvisible=n,this._jointScaleFactor=o,this._jointTransforms=new Array(b.length),this._jointTransformMatrices=new Float32Array(16*b.length),this._tempJointMatrix=new a.y3,this._jointRadii=new Float32Array(b.length),this._scene=t[0].getScene();for(let e=0;e<this._jointTransforms.length;e++)(this._jointTransforms[e]=new g.Y(b[e],this._scene)).rotationQuaternion=new a._f,t[e].rotationQuaternion=new a._f;i&&this.setHandMesh(i,s),this.xrController.motionController&&(this.xrController.motionController.rootMesh?this.xrController.motionController.rootMesh.setEnabled(!1):this.xrController.motionController.onModelLoadedObservable.add((e=>{e.rootMesh&&e.rootMesh.setEnabled(!1)}))),this.xrController.onMotionControllerInitObservable.add((e=>{e.onModelLoadedObservable.add((e=>{e.rootMesh&&e.rootMesh.setEnabled(!1)})),e.rootMesh&&e.rootMesh.setEnabled(!1)}))}setHandMesh(e,t){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach((e=>e.alwaysSelectAsActiveMesh=!0)),this._handMesh.skeleton){const e=this._handMesh.skeleton;b.forEach(((i,s)=>{const r=e.getBoneIndexByName(t?t[i]:i);-1!==r&&e.bones[r].linkTransformNode(this._jointTransforms[s])}))}}updateFromXRFrame(e,t){const i=this.xrController.inputSource.hand;if(!i)return;const s=i,r=b.map((e=>s[e]||i.get(e)));let n=!1;if(e.fillPoses&&e.fillJointRadii)n=e.fillPoses(r,t,this._jointTransformMatrices)&&e.fillJointRadii(r,this._jointRadii);else if(e.getJointPose){n=!0;for(let i=0;i<r.length;i++){const s=e.getJointPose(r[i],t);if(!s){n=!1;break}this._jointTransformMatrices.set(s.transform.matrix,16*i),this._jointRadii[i]=s.radius||.008}}n&&(b.forEach(((e,t)=>{const i=this._jointTransforms[t];a.y3.FromArrayToRef(this._jointTransformMatrices,16*t,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,i.rotationQuaternion,i.position);const s=this._jointRadii[t]*this._jointScaleFactor,r=this._jointMeshes[t];r.isVisible=!this._handMesh&&!this._jointsInvisible,r.position.copyFrom(i.position),r.rotationQuaternion.copyFrom(i.rotationQuaternion),r.scaling.setAll(s),this._scene.useRightHandedSystem||(r.position.z*=-1,r.rotationQuaternion.z*=-1,r.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(i.position.z*=-1,i.rotationQuaternion.z*=-1,i.rotationQuaternion.w*=-1))})),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(){this._handMesh&&(this._handMesh.isVisible=!1)}}class x extends n.F{static _GenerateTrackedJointMeshes(e){const t={};return["left","right"].map((i=>{var s,r,n,o,l;const c=[],u=(null===(s=e.jointMeshes)||void 0===s?void 0:s.sourceMesh)||(0,_.Au)("jointParent",x._ICOSPHERE_PARAMS);u.isVisible=!!(null===(r=e.jointMeshes)||void 0===r?void 0:r.keepOriginalVisible);for(let t=0;t<b.length;++t){let s=u.createInstance(`${i}-handJoint-${t}`);if(null===(n=e.jointMeshes)||void 0===n?void 0:n.onHandJointMeshGenerated){const r=e.jointMeshes.onHandJointMeshGenerated(s,t,i);r&&r!==s&&(s.dispose(),s=r)}if(s.isPickable=!1,null===(o=e.jointMeshes)||void 0===o?void 0:o.enablePhysics){const t=(null===(l=e.jointMeshes)||void 0===l?void 0:l.physicsProps)||{};s.scaling.setAll(.02);const i=void 0!==t.impostorType?t.impostorType:h.Q.SphereImpostor;s.physicsImpostor=new h.Q(s,i,Object.assign({mass:0},t))}s.rotationQuaternion=new a._f,s.isVisible=!1,c.push(s)}t[i]=c})),{left:t.left,right:t.right}}static _GenerateDefaultHandMeshesAsync(e,t){return new Promise((async i=>{var s,r,n,o,a;const h={};(null===(r=null===(s=x._RightHandGLB)||void 0===s?void 0:s.meshes[1])||void 0===r?void 0:r.isDisposed())&&(x._RightHandGLB=null),(null===(o=null===(n=x._LeftHandGLB)||void 0===n?void 0:n.meshes[1])||void 0===o?void 0:o.isDisposed())&&(x._LeftHandGLB=null);const l=!(!x._RightHandGLB||!x._LeftHandGLB),_=await Promise.all([x._RightHandGLB||c.n.ImportMeshAsync("",x.DEFAULT_HAND_MODEL_BASE_URL,x.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),x._LeftHandGLB||c.n.ImportMeshAsync("",x.DEFAULT_HAND_MODEL_BASE_URL,x.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);x._RightHandGLB=_[0],x._LeftHandGLB=_[1];const g=new d.O("handShader",e,{emitComments:!1});await g.loadAsync(x.DEFAULT_HAND_MODEL_SHADER_URL),g.needDepthPrePass=!0,g.transparencyMode=p.F.MATERIAL_ALPHABLEND,g.alphaMode=2,g.build(!1);const f=Object.assign({base:u.Wo.FromInts(116,63,203),fresnel:u.Wo.FromInts(149,102,229),fingerColor:u.Wo.FromInts(177,130,255),tipFresnel:u.Wo.FromInts(220,200,255)},null===(a=null==t?void 0:t.handMeshes)||void 0===a?void 0:a.customColors),b={base:g.getBlockByName("baseColor"),fresnel:g.getBlockByName("fresnelColor"),fingerColor:g.getBlockByName("fingerColor"),tipFresnel:g.getBlockByName("tipFresnelColor")};b.base.value=f.base,b.fresnel.value=f.fresnel,b.fingerColor.value=f.fingerColor,b.tipFresnel.value=f.tipFresnel,["left","right"].forEach((t=>{const i="left"==t?x._LeftHandGLB:x._RightHandGLB;if(!i)throw new Error("Could not load hand model");const s=i.meshes[1];s._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,s.material=g.clone(`${t}HandShaderClone`,!0),s.isVisible=!1,h[t]=s,l||e.useRightHandedSystem||i.meshes[1].rotate(m.RD.Y,Math.PI)})),g.dispose(),i({left:h.left,right:h.right})}))}static _GenerateDefaultHandMeshRigMapping(e){const t="right"==e?"R":"L";return{[r.WRIST]:`wrist_${t}`,[r.THUMB_METACARPAL]:`thumb_metacarpal_${t}`,[r.THUMB_PHALANX_PROXIMAL]:`thumb_proxPhalanx_${t}`,[r.THUMB_PHALANX_DISTAL]:`thumb_distPhalanx_${t}`,[r.THUMB_TIP]:`thumb_tip_${t}`,[r.INDEX_FINGER_METACARPAL]:`index_metacarpal_${t}`,[r.INDEX_FINGER_PHALANX_PROXIMAL]:`index_proxPhalanx_${t}`,[r.INDEX_FINGER_PHALANX_INTERMEDIATE]:`index_intPhalanx_${t}`,[r.INDEX_FINGER_PHALANX_DISTAL]:`index_distPhalanx_${t}`,[r.INDEX_FINGER_TIP]:`index_tip_${t}`,[r.MIDDLE_FINGER_METACARPAL]:`middle_metacarpal_${t}`,[r.MIDDLE_FINGER_PHALANX_PROXIMAL]:`middle_proxPhalanx_${t}`,[r.MIDDLE_FINGER_PHALANX_INTERMEDIATE]:`middle_intPhalanx_${t}`,[r.MIDDLE_FINGER_PHALANX_DISTAL]:`middle_distPhalanx_${t}`,[r.MIDDLE_FINGER_TIP]:`middle_tip_${t}`,[r.RING_FINGER_METACARPAL]:`ring_metacarpal_${t}`,[r.RING_FINGER_PHALANX_PROXIMAL]:`ring_proxPhalanx_${t}`,[r.RING_FINGER_PHALANX_INTERMEDIATE]:`ring_intPhalanx_${t}`,[r.RING_FINGER_PHALANX_DISTAL]:`ring_distPhalanx_${t}`,[r.RING_FINGER_TIP]:`ring_tip_${t}`,[r.PINKY_FINGER_METACARPAL]:`little_metacarpal_${t}`,[r.PINKY_FINGER_PHALANX_PROXIMAL]:`little_proxPhalanx_${t}`,[r.PINKY_FINGER_PHALANX_INTERMEDIATE]:`little_intPhalanx_${t}`,[r.PINKY_FINGER_PHALANX_DISTAL]:`little_distPhalanx_${t}`,[r.PINKY_FINGER_TIP]:`little_tip_${t}`}}isCompatible(){return"undefined"!=typeof XRHand}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return"none"==e?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this.onHandAddedObservable=new l.y$,this.onHandRemovedObservable=new l.y$,this._attachHand=e=>{var t,i,s;if(!e.inputSource.hand||"none"==e.inputSource.handedness||!this._handResources.jointMeshes)return;const r=e.inputSource.handedness,n=new y(e,this._handResources.jointMeshes[r],this._handResources.handMeshes&&this._handResources.handMeshes[r],this._handResources.rigMappings&&this._handResources.rigMappings[r],null===(t=this.options.handMeshes)||void 0===t?void 0:t.meshesUseLeftHandedCoordinates,null===(i=this.options.jointMeshes)||void 0===i?void 0:i.invisible,null===(s=this.options.jointMeshes)||void 0===s?void 0:s.scaleFactor);this._attachedHands[e.uniqueId]=n,this._trackingHands[r]=n,this.onHandAddedObservable.notifyObservers(n)},this._detachHand=e=>{this._detachHandById(e.uniqueId)},this.xrNativeFeatureName="hand-tracking";const i=t.jointMeshes;if(i&&(void 0!==i.disableDefaultHandMesh&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=i.disableDefaultHandMesh),void 0!==i.handMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=i.handMeshes),void 0!==i.leftHandedSystemMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=i.leftHandedSystemMeshes),void 0!==i.rigMapping)){t.handMeshes=t.handMeshes||{};const e={},s={};[[i.rigMapping.left,e],[i.rigMapping.right,s]].forEach((e=>{const t=e[0],i=e[1];t.forEach(((e,t)=>{i[b[t]]=e}))})),t.handMeshes.customRigMappings={left:e,right:s}}}attach(){var e,t,i,s;return!!super.attach()&&(this._handResources={jointMeshes:x._GenerateTrackedJointMeshes(this.options),handMeshes:(null===(e=this.options.handMeshes)||void 0===e?void 0:e.customMeshes)||null,rigMappings:(null===(t=this.options.handMeshes)||void 0===t?void 0:t.customRigMappings)||null},(null===(i=this.options.handMeshes)||void 0===i?void 0:i.customMeshes)||(null===(s=this.options.handMeshes)||void 0===s?void 0:s.disableDefaultMeshes)||x._GenerateDefaultHandMeshesAsync(f.l.LastCreatedScene,this.options).then((e=>{var t,i;this._handResources.handMeshes=e,this._handResources.rigMappings={left:x._GenerateDefaultHandMeshRigMapping("left"),right:x._GenerateDefaultHandMeshRigMapping("right")},null===(t=this._trackingHands.left)||void 0===t||t.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left),null===(i=this._trackingHands.right)||void 0===i||i.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right)})),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0)}_onXRFrame(e){var t,i;null===(t=this._trackingHands.left)||void 0===t||t.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),null===(i=this._trackingHands.right)||void 0===i||i.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e){var t;const i=this.getHandByControllerId(e);if(i){const s="left"==i.xrController.inputSource.handedness?"left":"right";(null===(t=this._trackingHands[s])||void 0===t?void 0:t.xrController.uniqueId)===e&&(this._trackingHands[s]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(),delete this._attachedHands[e]}}detach(){return!!super.detach()&&(Object.keys(this._attachedHands).forEach((e=>this._detachHandById(e))),!0)}dispose(){var e;super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!(null===(e=this.options.handMeshes)||void 0===e?void 0:e.customMeshes)&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),x._RightHandGLB=null,x._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach((e=>e.dispose())),this._handResources.jointMeshes.right.forEach((e=>e.dispose())))}}x.Name=o.b.HAND_TRACKING,x.Version=1,x.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/meshes/HandMeshes/",x.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb",x.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb",x.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json",x._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2},x._RightHandGLB=null,x._LeftHandGLB=null,o.d.AddWebXRFeature(x.Name,((e,t)=>()=>new x(e,t)),x.Version,!1)},53608:(e,t,i)=>{i.d(t,{HK:()=>a,ur:()=>o,z5:()=>n});var s=i(33330),r=i(79259);class n extends s.s{constructor(e){super((()=>e.framebufferWidth),(()=>e.framebufferHeight),e,"XRWebGLLayer",(e=>new o(e,this))),this.layer=e}}class o extends r.y{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class a{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}},73354:(e,t,i)=>{i.r(t),i.d(t,{AbstractActionManager:()=>r.O,AbstractAssetTask:()=>d_,AbstractMesh:()=>si.x,AbstractScene:()=>s.p,AcquireNativeObjectAsync:()=>ts,Action:()=>n.a,ActionEvent:()=>o.V,ActionManager:()=>a.k,AddBlock:()=>Ha,AddressMode:()=>ls.OB,AdvancedTimer:()=>vg.xb,AlignBlock:()=>Tu,AlphaState:()=>a_.Q,AmmoJSPlugin:()=>_n.b,AnaglyphArcRotateCamera:()=>it,AnaglyphFreeCamera:()=>st,AnaglyphGamepadCamera:()=>rt,AnaglyphPostProcess:()=>Ld.k,AnaglyphUniversalCamera:()=>ot,Analyser:()=>B,AndOrNotEvaluator:()=>u_.q,Angle:()=>Zs.RZ,Animatable:()=>v.H,AnimatedInputBlockTypes:()=>ka.c,Animation:()=>f.f,AnimationAssetTask:()=>m_,AnimationEvent:()=>T.O,AnimationGroup:()=>S.O,AnimationGroupMask:()=>A,AnimationGroupMaskMode:()=>x,AnimationKeyInterpolation:()=>E.N,AnimationPropertiesOverride:()=>y,AnimationRange:()=>R.X,AnisotropyBlock:()=>Lh.p,ApplyPostProcess:()=>Y_.$0,Arc2:()=>Zs.Q,ArcFollowCamera:()=>Je,ArcRotateCamera:()=>$e.Y,ArcRotateCameraGamepadInput:()=>xe.R,ArcRotateCameraInputsManager:()=>Ee.$,ArcRotateCameraKeyboardMoveInput:()=>Pe.v,ArcRotateCameraMouseWheelInput:()=>Ce.F,ArcRotateCameraPointersInput:()=>Te.H,ArcRotateCameraVRDeviceOrientationInput:()=>Re,ArcTan2Block:()=>vh,AssetContainer:()=>I.TJ,AssetTaskState:()=>o_,AssetsManager:()=>T_,AssetsProgressEvent:()=>p_,AsyncLoop:()=>w.$g,AttachToBoxBehavior:()=>te,AudioEngine:()=>F,AudioSceneComponent:()=>U,AutoLayoutMode:()=>ls.fu,AutoReleaseWorkerPool:()=>dr.v,AutoRotationBehavior:()=>K.o,AxesViewer:()=>hi,Axis:()=>Zs.RD,AxisDragGizmo:()=>ai,AxisScaleGizmo:()=>Ds,BRDFTextureTools:()=>Fh.D,BabylonFileLoaderConfiguration:()=>fn,BackEase:()=>P.ud,BackgroundMaterial:()=>Mn.I,BakedVertexAnimationManager:()=>$,BallAndSocketConstraint:()=>gd,BaseCameraMouseWheelInput:()=>ve.Y,BaseCameraPointersInput:()=>ye.O,BaseError:()=>qi.GU,BaseParticleSystem:()=>ku.U,BaseSixDofDragBehavior:()=>ae.N,BaseTexture:()=>Xn.V,BasisTools:()=>wo,BasisToolsOptions:()=>To,BasisTranscodeConfiguration:()=>Co,BezierCurve:()=>Zs.hr,BezierCurveEase:()=>P.sj,BiPlanarBlock:()=>rl,BinaryFileAssetTask:()=>b_,BlackAndWhitePostProcess:()=>Vd,BlendFactor:()=>ls.zi,BlendOperation:()=>ls.db,BloomEffect:()=>kd.r,BloomMergePostProcess:()=>zd.G,BlurPostProcess:()=>jr.i,Bone:()=>ce.N,BoneAxesViewer:()=>li,BoneIKController:()=>de,BoneLookController:()=>_e,BonesBlock:()=>ca,BounceEase:()=>P.R$,BouncingBehavior:()=>Z.r,BoundingBox:()=>Zt.k,BoundingBoxGizmo:()=>Fs,BoundingBoxRenderer:()=>Ip,BoundingInfo:()=>Jt.j,BoundingSphere:()=>ei.K,BoxBlock:()=>Dc.l,BoxBuilder:()=>ui.kg,BoxParticleEmitter:()=>zu.S3,Buffer:()=>me.l,BufferBindingType:()=>ls.Rs,BufferMapState:()=>ls.nA,BufferUsage:()=>ls.FB,CSG:()=>Wl,Camera:()=>Ue.V,CameraGizmo:()=>Js,CameraInputTypes:()=>Se.u,CameraInputsManager:()=>Se.p,CannonJSPlugin:()=>dn.s,CanvasAlphaMode:()=>ls.Zu,CapsuleBlock:()=>Zc,CapsuleBuilder:()=>_i.KY,CascadedShadowGenerator:()=>sn.R,ChromaticAberrationPostProcess:()=>Gd.n,CircleEase:()=>P.qP,CircleOfConfusionPostProcess:()=>Ud.N,ClampBlock:()=>$a,ClearCoatBlock:()=>kh.N,ClipPlanesBlock:()=>Va,ClipboardEventTypes:()=>ys.p,ClipboardInfo:()=>ys.o,CloudBlock:()=>Zh,CloudPoint:()=>id,Collider:()=>jt.Y,Color3:()=>Zs.Wo,Color3Gradient:()=>ag.cw,Color4:()=>Zs.HE,ColorCorrectionPostProcess:()=>Wd,ColorCurves:()=>An.U,ColorGradient:()=>ag.bK,ColorGradingTexture:()=>Qn,ColorMergerBlock:()=>eh,ColorSplitterBlock:()=>ih.v,ColorWriteFlags:()=>ls.Ie,CombineAction:()=>l.IA,CompareFunction:()=>ls.wb,CompatibilityOptions:()=>Dm.e,CompilationMessageType:()=>ls.mj,CompleteGreasedLineColorTable:()=>Mc,CompleteGreasedLineWidthTable:()=>Rc,ComputeBindingType:()=>ji.t,ComputeEffect:()=>qt.n,ComputeNormalsBlock:()=>_u,ComputePassTimestampLocation:()=>ls.HR,ComputeShader:()=>Kt.U,ComputeShaderParticleSystem:()=>Hu,Condition:()=>h.gP,ConditionBlock:()=>hu,ConditionBlockTests:()=>Gc,ConditionalBlock:()=>Kh,ConditionalBlockConditions:()=>Hh,ConeParticleEmitter:()=>zu.LV,Constants:()=>Ai.g,ContainerAssetTask:()=>__,ConversionMode:()=>Mg.Q,ConvolutionPostProcess:()=>Hd,Coordinate:()=>Zs.c7,CopyTextureToTexture:()=>Mg.p,CopyTools:()=>yg.r1,CreateBox:()=>ui.NR,CreateBoxVertexData:()=>ui.aR,CreateCapsule:()=>_i.iz,CreateCapsuleVertexData:()=>_i.VF,CreateCylinder:()=>Ft.wf,CreateCylinderVertexData:()=>Ft.zD,CreateDashedLines:()=>bi.Gz,CreateDashedLinesVertexData:()=>bi.BH,CreateDecal:()=>vc.t,CreateDisc:()=>Ys.uH,CreateDiscVertexData:()=>Ys.vM,CreateEnvTextureAsync:()=>Yi.p6,CreateGeodesic:()=>fc.M,CreateGoldberg:()=>bc._,CreateGoldbergVertexData:()=>bc.w,CreateGreasedLine:()=>Ec,CreateGreasedLineMaterial:()=>Sc,CreateGround:()=>Vt.$6,CreateGroundFromHeightMap:()=>Vt.W,CreateGroundFromHeightMapVertexData:()=>Vt.Qq,CreateGroundVertexData:()=>Vt.kt,CreateHemisphere:()=>Xs,CreateIcoSphere:()=>yc.Au,CreateIcoSphereVertexData:()=>yc.GQ,CreateImageDataArrayBufferViews:()=>Yi.Do,CreateLathe:()=>_c.O,CreateLineSystem:()=>bi.xW,CreateLineSystemVertexData:()=>bi.eW,CreateLines:()=>bi.nL,CreatePlane:()=>Ls.pT,CreatePlaneVertexData:()=>Ls.Hq,CreatePolygon:()=>pc.a4,CreatePolygonVertexData:()=>pc.gl,CreatePolyhedron:()=>Us.sh,CreatePolyhedronVertexData:()=>Us.Qy,CreateResizedCopy:()=>Y_.cW,CreateRibbon:()=>uc.LY,CreateRibbonVertexData:()=>uc.jM,CreateScreenshot:()=>K_,CreateScreenshotAsync:()=>Z_,CreateScreenshotUsingRenderTarget:()=>eg,CreateScreenshotUsingRenderTargetAsync:()=>tg,CreateScreenshotWithResizeAsync:()=>J_,CreateSegmentedBoxVertexData:()=>ui.ZU,CreateSphere:()=>di.Qk,CreateSphereVertexData:()=>di.jY,CreateText:()=>xc.p,CreateTextShapePaths:()=>xc.v,CreateTiledBox:()=>cc.cQ,CreateTiledBoxVertexData:()=>cc.qS,CreateTiledGround:()=>Vt.DG,CreateTiledGroundVertexData:()=>Vt.Es,CreateTiledPlane:()=>gc.KA,CreateTiledPlaneVertexData:()=>gc.mm,CreateTorus:()=>Lt.eu,CreateTorusKnot:()=>dc.eB,CreateTorusKnotVertexData:()=>dc.i9,CreateTorusVertexData:()=>Lt.h5,CreateTube:()=>mc._,CrossBlock:()=>Ya,CubeMapToSphericalPolynomialTools:()=>A_.$,CubeTexture:()=>ln.B,CubeTextureAssetTask:()=>x_,CubicEase:()=>P.o0,CullMode:()=>ls.Wf,CurrentScreenBlock:()=>Fa.K,Curve3:()=>Zs.j_,CurveBlock:()=>hl,CurveBlockTypes:()=>il,CustomBlock:()=>Xa,CustomOptimization:()=>V_,CustomParticleEmitter:()=>zu.E0,CustomProceduralTexture:()=>Go,CylinderBlock:()=>Kc,CylinderBuilder:()=>Ft.H6,CylinderDirectedParticleEmitter:()=>zu.z,CylinderParticleEmitter:()=>zu.kT,DDSTools:()=>nr.N,DataBuffer:()=>fe.h,DataReader:()=>lg.d,DataStorage:()=>dg,Database:()=>Vu,DaydreamController:()=>Cs,DebugBlock:()=>Ou,DebugLayer:()=>ci.DebugLayer,DebugLayerTab:()=>ci.DebugLayerTab,DecalBuilder:()=>vc.l,DecalMapConfiguration:()=>bl.E,DecalMapDefines:()=>bl.A,Decode:()=>Q.fJ,DecodeBase64ToBinary:()=>Q.HQ,DecodeBase64ToString:()=>Q.rP,DecodeBase64UrlToBinary:()=>Kn.$K,DecodeBase64UrlToString:()=>Kn.A2,DeepCopier:()=>On.j,DefaultCollisionCoordinator:()=>$t,DefaultKTX2DecoderOptions:()=>gr,DefaultLoadingScreen:()=>on.N,DefaultRenderingPipeline:()=>hp,Deferred:()=>S_.B,DepthCullingState:()=>h_.k,DepthOfFieldBlurPostProcess:()=>jd.T,DepthOfFieldEffect:()=>$d.J,DepthOfFieldEffectBlurLevel:()=>$d.z,DepthOfFieldMergePostProcess:()=>Yd.f,DepthPeelingRenderer:()=>wp.P,DepthPeelingSceneComponent:()=>Dp,DepthReducer:()=>ug.j,DepthRenderer:()=>fp.g,DepthRendererSceneComponent:()=>Op,DepthSortedParticle:()=>Ju,DerivativeBlock:()=>xa,DesaturateBlock:()=>Bh,DetailMapConfiguration:()=>fl.p,DeviceInputEventType:()=>xs.g,DeviceLostReason:()=>ls.wS,DeviceOrientationCamera:()=>Ye.n,DeviceSource:()=>Ri.p,DeviceSourceManager:()=>Mi.U,DeviceType:()=>Ei.Yi,DirectionalLight:()=>$s.O,DirectionalLightFrustumViewer:()=>Si,DiscBlock:()=>Jc,DiscBuilder:()=>Ys.tX,DiscardBlock:()=>va,DisplayPassPostProcess:()=>Xd,DistanceBlock:()=>_h,DistanceConstraint:()=>md,DistanceJoint:()=>ad.mN,DivideBlock:()=>nh,DoNothingAction:()=>l.TC,DomManagement:()=>N.MZ,DotBlock:()=>Qa,DracoCompression:()=>Nl.J,DrawWrapper:()=>Di.q,DualSenseInput:()=>Ei.s2,DualShockButton:()=>ws.NF,DualShockDpad:()=>ws.K4,DualShockInput:()=>Ei.V7,DualShockPad:()=>ws.Xq,DumpTools:()=>Q_.B,DynamicFloat32Array:()=>Eg.s,DynamicTexture:()=>wt.c,EasingFunction:()=>P.Kp,EdgesRenderer:()=>Np,Effect:()=>Pi.Q,EffectFallbacks:()=>In.L,EffectLayer:()=>kr.w,EffectLayerSceneComponent:()=>zr.p,EffectRenderer:()=>cl.I,EffectWrapper:()=>cl.H,ElasticEase:()=>P.$A,ElbowBlock:()=>el,EncodeArrayBufferToBase64:()=>Q.Gh,EndsWith:()=>Q.gi,Engine:()=>O.D,EngineFactory:()=>fs,EngineFormat:()=>lr,EngineInstrumentation:()=>Lr,EngineStore:()=>D.l,EngineView:()=>Gi,EnvironmentHelper:()=>er.g,EnvironmentTextureTools:()=>Yi.qh,Epsilon:()=>Zs.kn,EquiRectangularCubeTexture:()=>Zn,EquiRectangularCubeTextureAssetTask:()=>C_,ErrorCodes:()=>qi.SM,ErrorFilter:()=>ls.lx,EventConstants:()=>xs.G,EventState:()=>_.he,ExecuteCodeAction:()=>l.fQ,ExponentialEase:()=>P.EI,ExternalTexture:()=>Jn.x,ExtractHighlightsPostProcess:()=>Qd.m,ExtrudePolygon:()=>pc.Yo,ExtrudeShape:()=>Ci.Gc,ExtrudeShapeCustom:()=>Ci.bC,FactorGradient:()=>ag.b3,FadeInOutBehavior:()=>ie.Y,FeatureName:()=>ls.eS,FileTools:()=>Kn.e0,FileToolsOptions:()=>Kn.rN,FilesInput:()=>M_,FilesInputStore:()=>R_.X,FilterMode:()=>ls.X9,FilterPostProcess:()=>qd,FlowGraph:()=>Gm,FlowGraphAddNumberBlock:()=>jm,FlowGraphBlock:()=>Fm,FlowGraphEventBlock:()=>zm,FlowGraphExecutionBlock:()=>Vm,FlowGraphForLoopBlock:()=>Um,FlowGraphLogBlock:()=>Wm,FlowGraphMeshPickEventBlock:()=>$m,FlowGraphSceneReadyEventBlock:()=>Ym,FlowGraphSignalConnection:()=>Lm,FluidRenderer:()=>Zp,FluidRendererSceneComponent:()=>Kp,FluidRenderingDebug:()=>Up,FluidRenderingObject:()=>Jp.t,FluidRenderingObjectCustomParticles:()=>Xp.H,FluidRenderingObjectParticleSystem:()=>jp.F,FluidRenderingTargetRenderer:()=>Yp,FlyCamera:()=>Qe,FlyCameraInputsManager:()=>Xe.w,FlyCameraKeyboardInput:()=>Me.H,FlyCameraMouseInput:()=>Ae.g,FogBlock:()=>Ia,FollowBehavior:()=>he.j,FollowCamera:()=>Ze,FollowCameraInputsManager:()=>Ke.b,FollowCameraKeyboardMoveInput:()=>Ie.I,FollowCameraMouseWheelInput:()=>Oe.o,FollowCameraPointersInput:()=>we.S,FragCoordBlock:()=>Pa,FragDepthBlock:()=>Ra,FragmentOutputBlock:()=>_a.g,FramingBehavior:()=>J.d,FreeCamera:()=>He.c,FreeCameraDeviceOrientationInput:()=>De.V,FreeCameraGamepadInput:()=>Be.c,FreeCameraInputsManager:()=>ze.a,FreeCameraKeyboardMoveInput:()=>Ne.Y,FreeCameraMouseInput:()=>Fe.A,FreeCameraMouseWheelInput:()=>Le.A,FreeCameraTouchInput:()=>Ve.y,FreeCameraVirtualJoystickInput:()=>Ge,FresnelBlock:()=>uh,FresnelParameters:()=>wn,FromHalfFloat:()=>Y_.qZ,FrontFace:()=>ls.zX,FrontFacingBlock:()=>ya,Frustum:()=>Zs.iW,FxaaPostProcess:()=>Kd.P,GPUParticleSystem:()=>$u.h,GUID:()=>ul.x,Gamepad:()=>Tt.nJ,GamepadCamera:()=>et.i,GamepadManager:()=>Os.v,GamepadSystemSceneComponent:()=>yt.j,GearVRController:()=>Ts,GenerateBase64StringFromPixelData:()=>yg.xj,GenerateBase64StringFromTexture:()=>yg._u,GenerateBase64StringFromTextureAsync:()=>yg.Jj,GenericController:()=>Ss.M,GenericPad:()=>Tt.If,GeodesicData:()=>hc.zz,Geometry:()=>an.Z,GeometryBufferRenderer:()=>mp.m,GeometryBufferRendererSceneComponent:()=>Rp.b,GeometryCollectionBlock:()=>du,GeometryElbowBlock:()=>pu,GeometryInfoBlock:()=>wu,GeometryInputBlock:()=>Hc.p,GeometryOptimizeBlock:()=>kc,GeometryOutputBlock:()=>Oc.O,GeometryTransformBlock:()=>vu,GeometryTrigonometryBlock:()=>bu,GeometryTrigonometryBlockOperations:()=>Uc,GetClass:()=>c.q,GetDOMTextContent:()=>N.v,GetEnvInfo:()=>Yi.qJ,GetEnvironmentBRDFTexture:()=>Fh.$,GetInternalFormatFromBasisFormat:()=>So,GetTGAHeader:()=>go,Gizmo:()=>ni.tb,GizmoAnchorPoint:()=>ni.Cc,GizmoCoordinatesMode:()=>ni.wF,GizmoManager:()=>Hs,GlowLayer:()=>Gr.c,GoldbergMesh:()=>$l.R,GradientBlock:()=>Eh,GradientBlockColorStep:()=>Sh,GradientHelper:()=>ag.fR,GrainPostProcess:()=>Zd.p,GreasedLineMesh:()=>Tc,GreasedLineMeshColorDistribution:()=>nc,GreasedLineMeshColorDistributionType:()=>Rl.qG,GreasedLineMeshColorMode:()=>Rl.VL,GreasedLineMeshMaterialType:()=>Rl.Vw,GreasedLineMeshWidthDistribution:()=>oc,GreasedLinePluginMaterial:()=>Rl.mZ,GreasedLineTools:()=>Pc.u,GridBlock:()=>Qc,GroundBuilder:()=>Vt.vU,GroundMesh:()=>jl.E,HDRCubeTexture:()=>cn.e,HDRCubeTextureAssetTask:()=>P_,HDRFiltering:()=>eo.u,HDRTools:()=>vo.s,HandConstraintBehavior:()=>le.q_,HandConstraintOrientation:()=>le.rX,HandConstraintVisibility:()=>le.bH,HandConstraintZone:()=>le.$6,HandPart:()=>Ug.OF,HardwareScalingOptimization:()=>B_,HavokPlugin:()=>Ed.a,HeightToNormalBlock:()=>Ea,HemisphereBuilder:()=>Qs,HemisphericLight:()=>js.e,HemisphericParticleEmitter:()=>zu.VD,HighlightLayer:()=>Yr,HighlightsPostProcess:()=>Jd,Hinge2Joint:()=>ad.OT,HingeConstraint:()=>fd,HingeJoint:()=>ad.yr,HtmlElementTexture:()=>to,IWebXRControllerPhysicsOptions:()=>Vg,IcoSphereBlock:()=>Yc,IcoSphereBuilder:()=>yc.GM,ImageAssetTask:()=>v_,ImageProcessingBlock:()=>ma,ImageProcessingConfiguration:()=>It.$,ImageProcessingConfigurationDefines:()=>It.b,ImageProcessingPostProcess:()=>Dt.z,ImageSourceBlock:()=>wa.S,IncrementValueAction:()=>l.sn,IndexFormat:()=>ls.iD,InputBlock:()=>la.S,InputStepMode:()=>ls.V,InspectableType:()=>rg,InstancedLinesMesh:()=>ql.E,InstancedMesh:()=>Ql.S,InstancesBlock:()=>ua,InstantiateBlock:()=>Au,InstantiateOnFacesBlock:()=>Ru,InstantiateOnVerticesBlock:()=>Eu,InstantiateOnVolumeBlock:()=>Mu,InstantiatedEntries:()=>I.ve,IntFloatConverterBlock:()=>Iu,InternalTexture:()=>Oi.l,InternalTextureSource:()=>Oi.S,InterpolateValueAction:()=>b,IntersectionInfo:()=>Xt.c,IsBase64DataUrl:()=>Kn.VL,IsDocumentAvailable:()=>N.n5,IsFileURL:()=>Kn.Uh,IsNavigatorAvailable:()=>N.up,IsWindowObjectExist:()=>N.CG,JoystickAxis:()=>ke.h,KeepAssets:()=>I.fD,KeyboardEventTypes:()=>vs.OG,KeyboardInfo:()=>vs.NG,KeyboardInfoPre:()=>vs.WZ,KhronosTextureContainer:()=>ur.k,KhronosTextureContainer2:()=>mr,LatheBuilder:()=>_c.a,Layer:()=>Xr.m,LayerSceneComponent:()=>Qr.N,LengthBlock:()=>gh,LensFlare:()=>qr.E,LensFlareSystem:()=>Kr.u,LensFlareSystemSceneComponent:()=>Zr,LensFlaresOptimization:()=>L_,LensRenderingPipeline:()=>lp,LerpBlock:()=>rh,Light:()=>Jr._,LightBlock:()=>Oa,LightGizmo:()=>Ks,LightInformationBlock:()=>pa,LineEdgesRenderer:()=>Fp,LinesBuilder:()=>bi.RN,LinesMesh:()=>ql._,LoadFile:()=>Kn.vP,LoadFileError:()=>Kn.eh,LoadImage:()=>Kn.r6,LoadOp:()=>ls.Ws,LoadTextureFromTranscodeResult:()=>Oo,LockConstraint:()=>vd,Logger:()=>p.Y,MapMode:()=>ls.gc,MapRangeBlock:()=>au,MappingBlock:()=>Du,MappingTypes:()=>Wc,Material:()=>yi.F,MaterialAnisotropicDefines:()=>Ln.i,MaterialClearCoatDefines:()=>zn.d,MaterialDefines:()=>Dn.H,MaterialDetailMapDefines:()=>fl.G,MaterialFlags:()=>Jo.k,MaterialGreasedLineDefines:()=>Rl.RP,MaterialHelper:()=>Nn.G,MaterialIridescenceDefines:()=>Gn.f,MaterialPluginBase:()=>_l.n,MaterialPluginEvent:()=>ml.S,MaterialPluginManager:()=>gl.BK,MaterialSheenDefines:()=>Hn.A,MaterialSubSurfaceDefines:()=>jn.H,MathBlock:()=>ou,MathBlockOperations:()=>zc,Matrix:()=>Zs.y3,MatrixBuilderBlock:()=>qh,MatrixDeterminantBlock:()=>nl,MatrixTransposeBlock:()=>ol,MaxBlock:()=>dh,MergeGeometryBlock:()=>uu,MergeMeshesOptimization:()=>G_,Mesh:()=>Mt.Kj,MeshAssetTask:()=>g_,MeshAttributeExistsBlock:()=>al,MeshAttributeExistsBlockTypes:()=>tl,MeshBlock:()=>$c,MeshBuilder:()=>mi.V,MeshDebugMode:()=>Al,MeshDebugPluginMaterial:()=>Ol,MeshExploder:()=>E_,MeshLODLevel:()=>lc.g,MeshParticleEmitter:()=>zu.F3,MeshUVSpaceRenderer:()=>Hl,MeshoptCompression:()=>Fl.K,MinBlock:()=>ph,MinMaxReducer:()=>cg.d,MipmapFilterMode:()=>ls.f$,MirrorTexture:()=>No.h,ModBlock:()=>Qh,ModelShape:()=>Zu,MorphTarget:()=>Fu.Y,MorphTargetManager:()=>un.O,MorphTargetsBlock:()=>da.U,MotionBlurPostProcess:()=>ep.b,MotorEnabledJoint:()=>ad.$Q,MultiMaterial:()=>hn.G,MultiObserver:()=>I_,MultiPointerScaleBehavior:()=>re,MultiRenderTarget:()=>Fo.K,MultiplyBlock:()=>Wa.U,NLerpBlock:()=>Rh,NativeDataStream:()=>$i.e,NativeEngine:()=>ns,NativePointerInput:()=>Ei.FP,NativeXRFrame:()=>Om,NativeXRLayerRenderTargetTextureProvider:()=>Im.ur,NativeXRLayerWrapper:()=>Im.z5,NativeXRRenderTarget:()=>Im.HK,NegateBlock:()=>mh,Node:()=>qe.N,NodeGeometry:()=>Bc,NodeGeometryBlock:()=>Nc.s,NodeGeometryBlockConnectionPointTypes:()=>Lc.g,NodeGeometryBuildState:()=>wc.f,NodeGeometryConnectionPoint:()=>Fc.KD,NodeGeometryConnectionPointCompatibilityStates:()=>Fc.AY,NodeGeometryConnectionPointDirection:()=>Fc.rX,NodeGeometryContextualSources:()=>Vc.a,NodeMaterial:()=>Er.O,NodeMaterialBlock:()=>aa.k,NodeMaterialBlockConnectionPointMode:()=>ia.M,NodeMaterialBlockConnectionPointTypes:()=>ta.E,NodeMaterialBlockTargets:()=>ea.u,NodeMaterialConnectionPoint:()=>oa.VT,NodeMaterialConnectionPointCompatibilityStates:()=>oa.WS,NodeMaterialConnectionPointCustomObject:()=>na.C,NodeMaterialConnectionPointDirection:()=>oa.Ab,NodeMaterialDefines:()=>Er.n,NodeMaterialModes:()=>ra.a,NodeMaterialOptimizer:()=>ll,NodeMaterialSystemValues:()=>sa.$,NodeMaterialTeleportInBlock:()=>Ga,NodeMaterialTeleportOutBlock:()=>Ua,NoiseBlock:()=>cu,NoiseProceduralTexture:()=>Uo,NormalBlendBlock:()=>Ih,NormalizeBlock:()=>Za,NormalizeVectorBlock:()=>mu,NullBlock:()=>eu,NullEngine:()=>Fi,NullEngineOptions:()=>Ni,Observable:()=>_.y$,Observer:()=>_.Qj,OcclusionMaterial:()=>Fn,Octree:()=>ti.V,OctreeBlock:()=>ii.b,OctreeSceneComponent:()=>ri,OculusTouchController:()=>Es,OimoJSPlugin:()=>pn.A,OnAfterEnteringVRObservableEvent:()=>Ut,OneMinusBlock:()=>hh,Orientation:()=>Zs.i5,OutlineRenderer:()=>Gp,PBRAnisotropicConfiguration:()=>Ln.u,PBRBaseMaterial:()=>Vn.m,PBRBaseSimpleMaterial:()=>kn.P,PBRClearCoatConfiguration:()=>zn.Y,PBRIridescenceConfiguration:()=>Gn.B,PBRMaterial:()=>sr.Y,PBRMaterialDefines:()=>Vn.r,PBRMetallicRoughnessBlock:()=>Wh,PBRMetallicRoughnessMaterial:()=>Un,PBRSheenConfiguration:()=>Hn.B,PBRSpecularGlossinessMaterial:()=>Wn,PBRSubSurfaceConfiguration:()=>jn.u,PHI:()=>Zs.Q_,PadNumber:()=>Q.zA,PanoramaToCubeMapTools:()=>qn.B,Particle:()=>Yu.h,ParticleBlendMultiplyBlock:()=>Xh.D,ParticleHelper:()=>qu,ParticleRampGradientBlock:()=>Yh.p,ParticleSystem:()=>Qu.p,ParticleSystemSet:()=>Xu.D,ParticleTextureBlock:()=>$h.P,ParticlesOptimization:()=>k_,PassCubePostProcess:()=>Hr.Z,PassPostProcess:()=>Hr.Q,Path2:()=>Zs.ZZ,Path3D:()=>Zs.$B,PathCursor:()=>M,PerfCollectionStrategy:()=>Sg,PerfCounter:()=>Vi.z,PerformanceConfigurator:()=>wi.Z,PerformanceMonitor:()=>O_.A,PerformanceViewerCollector:()=>Cg.P,PerturbNormalBlock:()=>ba,PhotoDome:()=>ir,Physics6DoFConstraint:()=>_d,Physics6DoFLimit:()=>pd,PhysicsAggregate:()=>Cd,PhysicsBody:()=>ld.Q,PhysicsConstraint:()=>dd,PhysicsConstraintAxis:()=>ud.cK,PhysicsConstraintAxisLimitMode:()=>ud.gw,PhysicsConstraintMotorType:()=>ud.Rm,PhysicsConstraintType:()=>ud.hd,PhysicsEngine:()=>od.T,PhysicsEngineV2:()=>hd.T,PhysicsEventType:()=>ud.Uj,PhysicsHelper:()=>Md,PhysicsImpostor:()=>pi.Q,PhysicsJoint:()=>ad.q7,PhysicsMaterialCombineMode:()=>Pd.z,PhysicsMotionType:()=>ud.c4,PhysicsRadialExplosionEventOptions:()=>Dd,PhysicsRadialImpulseFalloff:()=>Td,PhysicsRaycastResult:()=>Fd.d,PhysicsShape:()=>cd.$n,PhysicsShapeBox:()=>cd.y2,PhysicsShapeCapsule:()=>cd.oz,PhysicsShapeContainer:()=>cd.vJ,PhysicsShapeConvexHull:()=>cd.A1,PhysicsShapeCylinder:()=>cd.Tk,PhysicsShapeMesh:()=>cd.gA,PhysicsShapeSphere:()=>cd.V_,PhysicsShapeType:()=>ud.Bq,PhysicsUpdraftEventOptions:()=>Bd,PhysicsUpdraftMode:()=>Sd,PhysicsViewer:()=>fi,PhysicsVortexEventOptions:()=>Nd,PickingInfo:()=>Yt.p,PipelineErrorReason:()=>ls.sM,PivotTools:()=>Bs.m,Plane:()=>Zs.JO,PlaneBlock:()=>jc,PlaneBuilder:()=>Ls.mx,PlaneDragGizmo:()=>zs,PlaneRotationGizmo:()=>Vs,PlayAnimationAction:()=>l.YF,PlaySoundAction:()=>u,PointColor:()=>ju,PointLight:()=>nn.c,PointParticleEmitter:()=>zu.cl,PointerDragBehavior:()=>se.M,PointerEventTypes:()=>Ct.kD,PointerInfo:()=>Ct.R5,PointerInfoBase:()=>Ct.CU,PointerInfoPre:()=>Ct.FV,PointerInput:()=>Ei.Fz,PointsCloudSystem:()=>rd,PointsGroup:()=>sd,Polar:()=>Dl,Polygon:()=>ac.m,PolygonBuilder:()=>pc.Pk,PolygonMeshBuilder:()=>ac.z,PolyhedronBuilder:()=>Us.ox,PolyhedronData:()=>hc.lD,PoseEnabledController:()=>St.K4,PoseEnabledControllerHelper:()=>St.zn,PoseEnabledControllerType:()=>St.wc,PositionGizmo:()=>Gs,PositionNormalTextureVertex:()=>Zs.eN,PositionNormalVertex:()=>Zs.$S,PostProcess:()=>Wr.D,PostProcessManager:()=>tp.O,PostProcessRenderEffect:()=>np.L,PostProcessRenderPipeline:()=>rp.$,PostProcessRenderPipelineManager:()=>op.a,PostProcessRenderPipelineManagerSceneComponent:()=>ap,PostProcessesOptimization:()=>F_,PosterizeBlock:()=>Ch,PowBlock:()=>fh,PowerEase:()=>P.Pu,PowerPreference:()=>ls.cM,PrePassOutputBlock:()=>Aa,PrePassRenderer:()=>Lp.F,PrePassRendererSceneComponent:()=>Vp,PrePassTextureBlock:()=>za,PrecisionDate:()=>G.F,PredicateCondition:()=>h.cw,PressureObserverWrapper:()=>Pg,PrimitiveTopology:()=>ls.YV,PrismaticConstraint:()=>yd,ProceduralTexture:()=>ko.g,ProceduralTextureSceneComponent:()=>Wo.O,PropertyTypeForEdition:()=>ga.U,PushMaterial:()=>$n.a,QuadraticEase:()=>P.v,QuadraticErrorSimplification:()=>sc,QuarticEase:()=>P.TO,Quaternion:()=>Zs._f,QueryType:()=>ls.xL,QuinticEase:()=>P.m2,RGBDTextureTools:()=>og.r,RandomBlock:()=>lu,RandomGUID:()=>ul.f,RandomNumberBlock:()=>bh,RawCubeTexture:()=>Ho.N,RawTexture:()=>Y.l,RawTexture2DArray:()=>jo.e,RawTexture3D:()=>$o,Ray:()=>At.z,RayHelper:()=>vi,ReadFile:()=>Kn.Ip,ReadFileError:()=>Kn.RC,RecastJSCrowd:()=>Lu.n,RecastJSPlugin:()=>Lu.P,ReciprocalBlock:()=>xh,ReflectBlock:()=>wh,ReflectionBlock:()=>Vh.J,ReflectionProbe:()=>gn.x,ReflectionTextureBlock:()=>Na,Reflector:()=>xg,RefractBlock:()=>Dh,RefractionBlock:()=>jh.b,RefractionPostProcess:()=>ip,RefractionTexture:()=>Xo,RegisterClass:()=>c.H,RegisterMaterialPlugin:()=>gl.rs,RegisterNativeTypeAsync:()=>is,RemapBlock:()=>Ka.w,RenderPassTimestampLocation:()=>ls.au,RenderTargetTexture:()=>Ur._,RenderTargetWrapper:()=>Bi.r,RenderTargetsOptimization:()=>z_,RenderingGroup:()=>Wp.S,RenderingGroupInfo:()=>Hp.t,RenderingManager:()=>Hp.$,ReplaceColorBlock:()=>Ph,RequestFile:()=>Kn.FV,RequestFileError:()=>Kn.kK,RetryStrategy:()=>hg.b,RibbonBuilder:()=>uc.Ub,RollingAverage:()=>O_.Z,Rotate2dBlock:()=>Oh,RotationGizmo:()=>ks,RotationXBlock:()=>yu,RotationYBlock:()=>xu,RotationZBlock:()=>Pu,RuntimeAnimation:()=>C.o,RuntimeError:()=>qi.LH,SSAO2RenderingPipeline:()=>up,SSAORenderingPipeline:()=>dp,SSRRenderingPipeline:()=>yp,SamplerBindingType:()=>ls.dV,Scalar:()=>Po.R,ScaleBlock:()=>ja,ScaleGizmo:()=>Ws,ScalingBlock:()=>Cu,Scene:()=>z.x,SceneComponentConstants:()=>k.l,SceneDepthBlock:()=>La,SceneInstrumentation:()=>Vr,SceneLoader:()=>Ps.n,SceneLoaderAnimationGroupLoadingMode:()=>Ps.O,SceneLoaderFlags:()=>Rn.Z,SceneOptimization:()=>w_,SceneOptimizer:()=>W_,SceneOptimizerOptions:()=>U_,ScenePerformancePriority:()=>z.a,SceneRecorder:()=>pg,SceneSerializer:()=>H_.K,ScreenSizeBlock:()=>Ca,ScreenSpaceBlock:()=>Ta,ScreenSpaceCurvaturePostProcess:()=>Mp,ScreenSpaceReflectionPostProcess:()=>pp.G,ScreenshotTools:()=>sg,SerializationHelper:()=>j.p4,SetColorsBlock:()=>ru,SetCorsBehavior:()=>Kn.$M,SetMaterialIDBlock:()=>fu,SetNormalsBlock:()=>iu,SetParentAction:()=>l.Ct,SetPositionsBlock:()=>tu,SetStateAction:()=>l.TI,SetTangentsBlock:()=>nu,SetUVsBlock:()=>su,SetValueAction:()=>l._2,ShaderCodeInliner:()=>Xi.Z,ShaderLanguage:()=>Yn.x,ShaderMaterial:()=>xi.j,ShaderStage:()=>ls.$X,ShaderStore:()=>bs.v,ShadowDepthWrapper:()=>pl,ShadowGenerator:()=>tn.u,ShadowGeneratorSceneComponent:()=>rn.w,ShadowLight:()=>en.O,ShadowMapBlock:()=>Ma,ShadowsOptimization:()=>N_,ShapeBuilder:()=>Ci.Oy,SharpenPostProcess:()=>sp.V,SheenBlock:()=>Nh.g,SimplexPerlin3DBlock:()=>Ah,SimplicationQueueSceneComponent:()=>rc,SimplificationQueue:()=>Zl,SimplificationSettings:()=>Kl,SimplificationType:()=>Xl,SineEase:()=>P.bi,SixDofDragBehavior:()=>ne.K,Size:()=>Zs.$u,Skeleton:()=>ge.O,SkeletonViewer:()=>Ti,SliderConstraint:()=>bd,SmartArray:()=>Ap.t,SmartArrayNoDuplicate:()=>Ap.f,SmoothStepBlock:()=>yh,SolidParticle:()=>Ku,SolidParticleSystem:()=>td,SolidParticleVertex:()=>ed,Sound:()=>L.$,SoundTrack:()=>V.t,SourceTextureFormat:()=>ar,Space:()=>Zs.T,SphereBlock:()=>Xc,SphereBuilder:()=>di.A1,SphereDirectedParticleEmitter:()=>zu.cE,SphereParticleEmitter:()=>zu.Ai,Spherical:()=>Bl,SphericalHarmonics:()=>rr._,SphericalPolynomial:()=>rr.i,SpotLight:()=>qs.P,SpringConstraint:()=>xd,Sprite:()=>e_.j,SpriteManager:()=>s_,SpriteMap:()=>r_,SpritePackedManager:()=>n_,SpriteSceneComponent:()=>t_.O,Stage:()=>k.H,StandardMaterial:()=>Ot.K,StandardMaterialDefines:()=>Ot.R,StandardRenderingPipeline:()=>_p,StartsWith:()=>Q.Ri,StateCondition:()=>h.bq,StencilOperation:()=>ls.xS,StencilState:()=>l_.s,StencilStateComposer:()=>c_.C,StepBlock:()=>ah,StereoscopicArcRotateCamera:()=>ht,StereoscopicFreeCamera:()=>lt,StereoscopicGamepadCamera:()=>ct,StereoscopicInterlacePostProcess:()=>Pp.J,StereoscopicInterlacePostProcessI:()=>Pp.i,StereoscopicScreenUniversalCamera:()=>_t,StereoscopicUniversalCamera:()=>ut,StickValues:()=>Tt.zD,StopAnimationAction:()=>l.BB,StopSoundAction:()=>d,StorageBuffer:()=>be.N,StorageTextureAccess:()=>ls.Gt,StoreOp:()=>ls.EG,StringDictionary:()=>j_.x,StringTools:()=>Q.Ml,SubEmitter:()=>nd.H,SubEmitterType:()=>nd.l,SubMesh:()=>Ll.P,SubSurfaceBlock:()=>Gh.l,SubSurfaceSceneComponent:()=>zp,SubtractBlock:()=>oh,SurfaceMagnetismBehavior:()=>oe.p,SwitchBooleanAction:()=>l.zh,SwitchInput:()=>Ei.D_,TBNBlock:()=>fa.v,TGATools:()=>fo,Tags:()=>$_.$,TargetCamera:()=>We.C,TargetedAnimation:()=>S.U,TeleportInBlock:()=>Bu,TeleportOutBlock:()=>Nu,TestBase64DataUrl:()=>Kn.qC,TextFileAssetTask:()=>f_,Texture:()=>X.x,TextureAspect:()=>ls.H7,TextureAssetTask:()=>y_,TextureBlock:()=>Da,TextureDimension:()=>ls.kd,TextureFormat:()=>ls.EV,TextureOptimization:()=>D_,TexturePacker:()=>Vo,TexturePackerFrame:()=>Lo.p,TextureSampleType:()=>ls.oD,TextureSampler:()=>Qo.a,TextureTools:()=>Y_.Oi,TextureUsage:()=>ls.v2,TextureViewDimension:()=>ls.p_,ThinEngine:()=>Ii.B,ThinRenderTargetTexture:()=>Ko,ThinTexture:()=>qo.g,TiledBoxBuilder:()=>cc.Sc,TiledPlaneBuilder:()=>gc.P8,TimerState:()=>vg.vs,TmpColors:()=>Zs.zZ,TmpVectors:()=>Zs.jp,ToGammaSpace:()=>Zs.zp,ToHalfFloat:()=>Y_.ay,ToLinearSpace:()=>Zs.Nn,TonemapPostProcess:()=>Cp,TonemappingOperator:()=>xp,Tools:()=>w.w1,TorusBlock:()=>qc,TorusBuilder:()=>Lt.t3,TorusKnotBuilder:()=>dc.SN,TouchCamera:()=>je.H,TrailMesh:()=>Yl,Trajectory:()=>_g,TrajectoryClassifier:()=>bg,TranscodeAsync:()=>Ao,TranscodeTarget:()=>hr,TransformBlock:()=>qa.m,TransformNode:()=>dt.Y,TranslationBlock:()=>Su,TriPlanarBlock:()=>sl.H,TrigonometryBlock:()=>Ja.S,TrigonometryBlockOperations:()=>Ja.p,TubeBuilder:()=>mc.F,TwirlBlock:()=>Sa,UniformBuffer:()=>Zo.M,UniversalCamera:()=>nt.x,UnregisterAllMaterialPlugins:()=>gl.Dh,UnregisterMaterialPlugin:()=>gl.jD,UploadContent:()=>mo,UploadEnvLevelsAsync:()=>Yi.Ro,UploadEnvSpherical:()=>Yi.qC,UploadLevelsAsync:()=>Yi.qZ,UtilityLayerRenderer:()=>oi.x,VRCameraMetrics:()=>mt.X,VRDeviceOrientationArcRotateCamera:()=>bt,VRDeviceOrientationFreeCamera:()=>vt.i,VRDeviceOrientationGamepadCamera:()=>xt,VRDistortionCorrectionPostProcess:()=>Sp.T,VRExperienceHelper:()=>Wt,VRMultiviewToSingleviewPostProcess:()=>Ep.E,ValidatedNativeDataStream:()=>os,ValueCondition:()=>h.Uf,Vector2:()=>Zs.FM,Vector3:()=>Zs.P,Vector4:()=>Zs.Lt,VectorConverterBlock:()=>gu,VectorMergerBlock:()=>th.t,VectorSplitterBlock:()=>sh,VertexAnimationBaker:()=>q,VertexBuffer:()=>me.o,VertexData:()=>gi.x,VertexDataMaterialInfo:()=>gi.D,VertexFormat:()=>ls.gB,VertexOutputBlock:()=>ha.t,VideoDome:()=>Fr,VideoRecorder:()=>X_,VideoTexture:()=>Nr.f,ViewDirectionBlock:()=>ch.d,Viewport:()=>Zs.l_,VirtualJoystick:()=>ke.N,VirtualJoysticksCamera:()=>gt,ViveController:()=>Rs,VolumetricLightScatteringPostProcess:()=>Tp,VoronoiNoiseBlock:()=>Jh,WaveBlock:()=>Th,WaveBlockKind:()=>lh,WebGL2ParticleSystem:()=>Wu,WebGL2ShaderProcessor:()=>Qi.C,WebGLDataBuffer:()=>Ac.M,WebGLHardwareTexture:()=>hs.B,WebGLPipelineContext:()=>as.y,WebGPUCacheBindGroups:()=>ps.C,WebGPUCacheRenderPipeline:()=>us.O,WebGPUCacheRenderPipelineTree:()=>ds.H,WebGPUCacheSampler:()=>_s.W,WebGPUDataBuffer:()=>Ic.C,WebGPUDrawContext:()=>gs.g,WebGPUEngine:()=>cs.f,WebGPUTintWASM:()=>ms.S,WebRequest:()=>zo.g,WebVRController:()=>Et.T,WebVRFreeCamera:()=>Pt.$,WebXRAbstractFeature:()=>Sr.F,WebXRAbstractMotionController:()=>bm.d,WebXRAnchorSystem:()=>Bg,WebXRBackgroundRemover:()=>Lg,WebXRCamera:()=>Ag.o,WebXRCompositionLayerWrapper:()=>am,WebXRControllerComponent:()=>Xg.n,WebXRControllerMovement:()=>Qg,WebXRControllerPhysics:()=>kg,WebXRControllerPointerSelection:()=>Cr.S,WebXRDefaultExperience:()=>Dr,WebXRDefaultExperienceOptions:()=>wr,WebXRDepthSensing:()=>_m,WebXRDomOverlay:()=>Yg,WebXREnterExitUI:()=>Ir,WebXREnterExitUIButton:()=>Mr,WebXREnterExitUIOptions:()=>Ar,WebXRExperienceHelper:()=>xr.M,WebXREyeTracking:()=>Zg,WebXRFeatureName:()=>Tr.b,WebXRFeaturePointSystem:()=>Gg,WebXRFeaturesManager:()=>Tr.d,WebXRGenericHandController:()=>ym,WebXRGenericTriggerMotionController:()=>Pm.z,WebXRHTCViveMotionController:()=>Rm,WebXRHand:()=>Ug.e0,WebXRHandJoint:()=>Ug.fL,WebXRHandTracking:()=>Ug.en,WebXRHitTest:()=>zg,WebXRHitTestLegacy:()=>wg,WebXRImageTracking:()=>$g,WebXRInput:()=>Pr.t,WebXRInputSource:()=>Ig.e,WebXRLayers:()=>pm,WebXRLightEstimation:()=>Kg,WebXRManagedOutputCanvas:()=>Og.n,WebXRManagedOutputCanvasOptions:()=>Og._,WebXRMeshDetector:()=>Hg,WebXRMicrosoftMixedRealityController:()=>Cm,WebXRMotionControllerManager:()=>vm.V,WebXRMotionControllerTeleportation:()=>Or.z,WebXRNearControllerMode:()=>yr,WebXRNearInteraction:()=>Rr,WebXROculusTouchMotionController:()=>Sm,WebXRPlaneDetector:()=>Fg,WebXRProfiledMotionController:()=>Am.t,WebXRProjectionLayerWrapper:()=>lm,WebXRSessionManager:()=>Bt.g,WebXRSpaceWarp:()=>fm,WebXRSpaceWarpRenderTargetTextureProvider:()=>mm,WebXRState:()=>Nt.k,WebXRTrackingState:()=>Nt.j,WebXRWalkingLocomotion:()=>sm,WeightedSound:()=>W.s,WindowsMotionController:()=>As,WorkerPool:()=>dr.h,WorleyNoise3DBlock:()=>Mh,XRSpaceWarpRenderTarget:()=>gm,XRWindowsMotionController:()=>Is,Xbox360Button:()=>Rt.nR,Xbox360Dpad:()=>Rt._Q,Xbox360Pad:()=>Rt.FI,XboxInput:()=>Ei.$i,_BabylonLoaderRegistered:()=>mn,_BasisTextureLoader:()=>Bo,_CreationDataStorage:()=>Mt.gW,_DDSTextureLoader:()=>or,_ENVTextureLoader:()=>cr.v,_HDRTextureLoader:()=>yo,_IAnimationState:()=>f.u,_InstancesBatch:()=>Mt.Wv,_KTXTextureLoader:()=>br,_MeshCollisionData:()=>Qt.a,_OcclusionDataStorage:()=>ki,_PrimaryIsoTriangle:()=>hc.Bn,_TGATextureLoader:()=>bo,_TimeToken:()=>Li.W,_UpdateRGBDAsync:()=>Yi.Lf,_forceSceneHelpersToBundle:()=>Br,_forceTransformFeedbackToBundle:()=>zi.Q,_injectLTSFileTools:()=>Kn.W5,addClipPlaneUniforms:()=>Bn.qx,allocateAndCopyTypedBuffer:()=>Hi.A,bindClipPlane:()=>Bn.an,className:()=>w.ok,createDetailMapPlugin:()=>El,createPBRAnisotropicPlugin:()=>yl,createPBRBRDFPlugin:()=>xl,createPBRClearCoatPlugin:()=>Pl,createPBRIridescencePlugin:()=>Cl,createPBRSheenPlugin:()=>Tl,createPBRSubSurfacePlugin:()=>Sl,createYieldingScheduler:()=>Rg.KO,editableInPropertyPage:()=>ga.p,expandToProperty:()=>j.wz,extractMinAndMax:()=>wl.k,extractMinAndMaxIndexed:()=>wl.y,inlineScheduler:()=>Rg.WP,makeAsyncFunction:()=>Rg.U3,makeSyncFunction:()=>Rg.vp,nativeOverride:()=>j.G6,normalizeEnvInfo:()=>Yi.QH,prepareDefinesForClipPlanes:()=>Bn.AN,prepareStringDefinesForClipPlanes:()=>Bn.lK,runCoroutine:()=>Rg.d_,runCoroutineAsync:()=>Rg.sM,runCoroutineSync:()=>Rg.s3,serialize:()=>j.qC,serializeAsCameraReference:()=>j.VE,serializeAsColor3:()=>j.n9,serializeAsColor4:()=>j.XX,serializeAsColorCurves:()=>j.N$,serializeAsFresnelParameters:()=>j.qQ,serializeAsImageProcessingConfiguration:()=>j.rX,serializeAsMatrix:()=>j.oQ,serializeAsMeshReference:()=>j.RR,serializeAsQuaternion:()=>j.mv,serializeAsTexture:()=>j.oU,serializeAsVector2:()=>j.QC,serializeAsVector3:()=>j.hd,setAndStartTimer:()=>vg.g_,setStereoscopicAnaglyphRigMode:()=>tt.i,setStereoscopicRigMode:()=>at.k,setVRRigMode:()=>ft.S,setWebVRRigMode:()=>Ht.j});var s=i(64863),r=i(99363),n=i(80190),o=i(14485),a=i(52024),h=i(8840),l=i(56403),c=i(9827);class u extends n.a{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.play()}serialize(e){return super._serialize({name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}class d extends n.a{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.stop()}serialize(e){return super._serialize({name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}(0,c.H)("BABYLON.PlaySoundAction",u),(0,c.H)("BABYLON.StopSoundAction",d);var p=i(59288),_=i(64673),g=i(89859),m=i(90972),f=i(83427);class b extends n.a{constructor(e,t,i,s,r=1e3,n,o,a){super(e,n),this.duration=1e3,this.onInterpolationDoneObservable=new _.y$,this.propertyPath=i,this.value=s,this.duration=r,this.stopOtherAnimations=o,this.onInterpolationDone=a,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){const e=this._actionManager.getScene(),t=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];let i;if("number"==typeof this.value)i=f.f.ANIMATIONTYPE_FLOAT;else if(this.value instanceof g.Wo)i=f.f.ANIMATIONTYPE_COLOR3;else if(this.value instanceof m.P)i=f.f.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof m.y3)i=f.f.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof m._f))return void p.Y.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");i=f.f.ANIMATIONTYPE_QUATERNION}const s=new f.f("InterpolateValueAction",this._property,1e3/this.duration*100,i,f.f.ANIMATIONLOOPMODE_CONSTANT);s.setKeys(t),this.stopOtherAnimations&&e.stopAnimation(this._effectiveTarget),e.beginDirectAnimation(this._effectiveTarget,[s],0,100,!1,1,(()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()}))}serialize(e){return super._serialize({name:"InterpolateValueAction",properties:[n.a._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:n.a._SerializeValueAsString(this.value)},{name:"duration",value:n.a._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:n.a._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)}}(0,c.H)("BABYLON.InterpolateValueAction",b);var v=i(19779);class y{constructor(){this.enableBlending=!1,this.blendingSpeed=.01,this.loopMode=f.f.ANIMATIONLOOPMODE_CYCLE}}var x,P=i(49011),C=i(13176),T=i(84867),S=i(55726),E=i(34629),R=i(49556);i(63421);class M{constructor(e){this._path=e,this._onchange=new Array,this.value=0,this.animations=new Array}getPoint(){const e=this._path.getPointAtLengthPosition(this.value);return new m.P(e.x,0,e.y)}moveAhead(e=.002){return this.move(e),this}moveBack(e=.002){return this.move(-e),this}move(e){if(Math.abs(e)>1)throw"step size should be less than 1.";return this.value+=e,this._ensureLimits(),this._raiseOnChange(),this}_ensureLimits(){for(;this.value>1;)this.value-=1;for(;this.value<0;)this.value+=1;return this}_raiseOnChange(){return this._onchange.forEach((e=>e(this))),this}onchange(e){return this._onchange.push(e),this}}!function(e){e[e.Include=0]="Include",e[e.Exclude=1]="Exclude"}(x||(x={}));class A{constructor(e,t=x.Include){this.mode=t,this._targetNames=new Set,e&&this.addTargetName(e)}addTargetName(e){if(Array.isArray(e))for(const t of e)this._targetNames.add(t);else this._targetNames.add(e)}removeTargetName(e){if(Array.isArray(e))for(const t of e)this._targetNames.delete(t);else this._targetNames.delete(e)}hasTarget(e){return this._targetNames.has(e)}retainsTarget(e){return this._targetNames.has(e)===(this.mode===x.Include)}}var I=i(85702),O=(i(50738),i(37650),i(47469)),w=i(14651),D=i(40078);class B{constructor(e){this.SMOOTHING=.75,this.FFT_SIZE=512,this.BARGRAPHAMPLITUDE=256,this.DEBUGCANVASPOS={x:20,y:20},this.DEBUGCANVASSIZE={width:320,height:200},(e=e||D.l.LastCreatedScene)&&(this._scene=e,O.D.audioEngine?(this._audioEngine=O.D.audioEngine,this._audioEngine.canUseWebAudio&&this._audioEngine.audioContext&&(this._webAudioAnalyser=this._audioEngine.audioContext.createAnalyser(),this._webAudioAnalyser.minDecibels=-140,this._webAudioAnalyser.maxDecibels=0,this._byteFreqs=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._byteTime=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._floatFreqs=new Float32Array(this._webAudioAnalyser.frequencyBinCount))):w.w1.Warn("No audio engine initialized, failed to create an audio analyser"))}getFrequencyBinCount(){return this._audioEngine.canUseWebAudio?this._webAudioAnalyser.frequencyBinCount:0}getByteFrequencyData(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteFrequencyData(this._byteFreqs)),this._byteFreqs}getByteTimeDomainData(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteTimeDomainData(this._byteTime)),this._byteTime}getFloatFrequencyData(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getFloatFrequencyData(this._floatFreqs)),this._floatFreqs}drawDebugCanvas(){if(this._audioEngine.canUseWebAudio&&(this._debugCanvas||(this._debugCanvas=document.createElement("canvas"),this._debugCanvas.width=this.DEBUGCANVASSIZE.width,this._debugCanvas.height=this.DEBUGCANVASSIZE.height,this._debugCanvas.style.position="absolute",this._debugCanvas.style.top=this.DEBUGCANVASPOS.y+"px",this._debugCanvas.style.left=this.DEBUGCANVASPOS.x+"px",this._debugCanvasContext=this._debugCanvas.getContext("2d"),document.body.appendChild(this._debugCanvas),this._registerFunc=()=>{this.drawDebugCanvas()},this._scene.registerBeforeRender(this._registerFunc)),this._registerFunc&&this._debugCanvasContext)){const e=this.getByteFrequencyData();this._debugCanvasContext.fillStyle="rgb(0, 0, 0)",this._debugCanvasContext.fillRect(0,0,this.DEBUGCANVASSIZE.width,this.DEBUGCANVASSIZE.height);for(let t=0;t<this.getFrequencyBinCount();t++){const i=e[t]/this.BARGRAPHAMPLITUDE,s=this.DEBUGCANVASSIZE.height*i,r=this.DEBUGCANVASSIZE.height-s-1,n=this.DEBUGCANVASSIZE.width/this.getFrequencyBinCount(),o=t/this.getFrequencyBinCount()*360;this._debugCanvasContext.fillStyle="hsl("+o+", 100%, 50%)",this._debugCanvasContext.fillRect(t*n,r,n,s)}}}stopDebugCanvas(){this._debugCanvas&&(this._registerFunc&&(this._scene.unregisterBeforeRender(this._registerFunc),this._registerFunc=null),document.body.removeChild(this._debugCanvas),this._debugCanvas=null,this._debugCanvasContext=null)}connectAudioNodes(e,t){this._audioEngine.canUseWebAudio&&(e.connect(this._webAudioAnalyser),this._webAudioAnalyser.connect(t))}dispose(){this._audioEngine.canUseWebAudio&&this._webAudioAnalyser.disconnect()}}var N=i(60103);O.D.AudioEngineFactory=(e,t,i)=>new F(e,t,i);class F{get audioContext(){return this._audioContextInitialized||this._initializeAudioContext(),this._audioContext}constructor(e=null,t=null,i=null){if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new _.y$,this.onAudioLockedObservable=new _.y$,this._tryToRun=!1,this._onResize=()=>{this._moveButtonToTopLeft()},!(0,N.CG)())return;void 0!==window.AudioContext&&(this.canUseWebAudio=!0);const s=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=i;try{s&&s.canPlayType&&(s.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||s.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch(e){}try{s&&s.canPlayType&&s.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch(e){}}lock(){this._triggerSuspendedState()}unlock(){var e,t;"running"!==(null===(e=this._audioContext)||void 0===e?void 0:e.state)?this._tryToRun?null===(t=this._audioContext)||void 0===t||t.suspend().then((()=>{this._tryToRun=!1,this._triggerRunningState()})):this._triggerRunningState():this._hideMuteButton()}_resumeAudioContext(){var e;return(null===(e=this._audioContext)||void 0===e?void 0:e.resume)?this._audioContext.resume():Promise.resolve()}_initializeAudioContext(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,"running"===this._audioContext.state&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,p.Y.Error("Web Audio: "+e.message)}}_triggerRunningState(){this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then((()=>{this._tryToRun=!1,this._muteButton&&this._hideMuteButton(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)})).catch((()=>{this._tryToRun=!1,this.unlocked=!1})))}_triggerSuspendedState(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()}_displayMuteButton(){if(this.useCustomUnlockedButton||this._muteButton)return;this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";const e=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png")+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",(()=>{this._triggerRunningState()}),!0),this._muteButton.addEventListener("click",(()=>{this.unlock()}),!0),window.addEventListener("resize",this._onResize)}_moveButtonToTopLeft(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")}_hideMuteButton(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)}dispose(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1}setGlobalVolume(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))}}var L=i(70749),V=i(63218),k=i(84686),z=i(8714),G=i(46461);s.p.AddParser(k.l.NAME_AUDIO,((e,t,i,s)=>{var r;let n,o=[];if(i.sounds=i.sounds||[],void 0!==e.sounds&&null!==e.sounds)for(let a=0,h=e.sounds.length;a<h;a++){const h=e.sounds[a];(null===(r=O.D.audioEngine)||void 0===r?void 0:r.canUseWebAudio)?(h.url||(h.url=h.name),o[h.url]?i.sounds.push(L.$.Parse(h,t,s,o[h.url])):(n=L.$.Parse(h,t,s),o[h.url]=n,i.sounds.push(n))):i.sounds.push(new L.$(h.name,null,t))}o=[]})),Object.defineProperty(z.x.prototype,"mainSoundTrack",{get:function(){let e=this._getComponent(k.l.NAME_AUDIO);return e||(e=new U(this),this._addComponent(e)),this._mainSoundTrack||(this._mainSoundTrack=new V.t(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),z.x.prototype.getSoundByName=function(e){let t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===e)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks)for(let i=0;i<this.soundTracks.length;i++)for(t=0;t<this.soundTracks[i].soundCollection.length;t++)if(this.soundTracks[i].soundCollection[t].name===e)return this.soundTracks[i].soundCollection[t];return null},Object.defineProperty(z.x.prototype,"audioEnabled",{get:function(){let e=this._getComponent(k.l.NAME_AUDIO);return e||(e=new U(this),this._addComponent(e)),e.audioEnabled},set:function(e){let t=this._getComponent(k.l.NAME_AUDIO);t||(t=new U(this),this._addComponent(t)),e?t.enableAudio():t.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(z.x.prototype,"headphone",{get:function(){let e=this._getComponent(k.l.NAME_AUDIO);return e||(e=new U(this),this._addComponent(e)),e.headphone},set:function(e){let t=this._getComponent(k.l.NAME_AUDIO);t||(t=new U(this),this._addComponent(t)),e?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(z.x.prototype,"audioListenerPositionProvider",{get:function(){let e=this._getComponent(k.l.NAME_AUDIO);return e||(e=new U(this),this._addComponent(e)),e.audioListenerPositionProvider},set:function(e){let t=this._getComponent(k.l.NAME_AUDIO);if(t||(t=new U(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(z.x.prototype,"audioListenerRotationProvider",{get:function(){let e=this._getComponent(k.l.NAME_AUDIO);return e||(e=new U(this),this._addComponent(e)),e.audioListenerRotationProvider},set:function(e){let t=this._getComponent(k.l.NAME_AUDIO);if(t||(t=new U(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");t.audioListenerRotationProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(z.x.prototype,"audioPositioningRefreshRate",{get:function(){let e=this._getComponent(k.l.NAME_AUDIO);return e||(e=new U(this),this._addComponent(e)),e.audioPositioningRefreshRate},set:function(e){let t=this._getComponent(k.l.NAME_AUDIO);t||(t=new U(this),this._addComponent(t)),t.audioPositioningRefreshRate=e},enumerable:!0,configurable:!0});class U{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=k.l.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new m.P,this._cachedCameraPosition=new m.P,this._lastCheck=0,this._invertMatrixTemp=new m.y3,this._cameraDirectionTemp=new m.P,(e=e||D.l.LastCreatedScene)&&(this.scene=e,e.soundTracks=new Array,e.sounds=new Array)}register(){this.scene._afterRenderStage.registerStep(k.l.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const i=this.scene.soundTracks[t];for(let t=0;t<i.soundCollection.length;t++)e.sounds.push(i.soundCollection[t].serialize())}}addFromContainer(e){e.sounds&&e.sounds.forEach((e=>{e.play(),e.autoplay=!0,this.scene.mainSoundTrack.addSound(e)}))}removeFromContainer(e,t=!1){e.sounds&&e.sounds.forEach((e=>{e.stop(),e.autoplay=!1,this.scene.mainSoundTrack.removeSound(e),t&&e.dispose()}))}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;let t;for(this._audioEnabled=!1,O.D.audioEngine&&O.D.audioEngine.audioContext&&O.D.audioEngine.audioContext.suspend(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){const e=this.scene;let t;for(this._audioEnabled=!0,O.D.audioEngine&&O.D.audioEngine.audioContext&&O.D.audioEngine.audioContext.resume(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=G.F.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||0===t._mainSoundTrack.soundCollection.length&&1===t.soundTracks.length)return;const i=O.D.audioEngine;if(i&&i.audioContext){let e,s=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(s=t.activeCameras[0]),this.audioListenerPositionProvider){const e=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(e.x||0,e.y||0,e.z||0)}else s?this._cachedCameraPosition.equals(s.globalPosition)||(this._cachedCameraPosition.copyFrom(s.globalPosition),i.audioContext.listener.setPosition(s.globalPosition.x,s.globalPosition.y,s.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const e=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(e.x||0,e.y||0,e.z||0,0,1,0)}else s?(s.rigCameras&&s.rigCameras.length>0&&(s=s.rigCameras[0]),s.getViewMatrix().invertToRef(this._invertMatrixTemp),m.P.TransformNormalToRef(U._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),isNaN(this._cameraDirectionTemp.x)||isNaN(this._cameraDirectionTemp.y)||isNaN(this._cameraDirectionTemp.z)||this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);for(e=0;e<t.mainSoundTrack.soundCollection.length;e++){const i=t.mainSoundTrack.soundCollection[e];i.useCustomAttenuation&&i.updateDistanceFromListener()}if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let i=0;i<t.soundTracks[e].soundCollection.length;i++){const s=t.soundTracks[e].soundCollection[i];s.useCustomAttenuation&&s.updateDistanceFromListener()}}}}U._CameraDirection=new m.P(0,0,-1),L.$._SceneComponentInitialization=e=>{let t=e._getComponent(k.l.NAME_AUDIO);t||(t=new U(e),e._addComponent(t))};var W=i(3357),H=i(13555),j=i(96786);class ${constructor(e){this._texture=null,this._isEnabled=!0,this.isEnabled=!0,this.time=0,(e=e||D.l.LastCreatedScene)&&(this._scene=e,this.animationParameters=new m.Lt(0,0,0,30))}_markSubMeshesAsAttributesDirty(){for(const e of this._scene.meshes)e.bakedVertexAnimationManager===this&&e._markSubMeshesAsAttributesDirty()}bind(e,t=!1){if(!this._texture||!this._isEnabled)return;const i=this._texture.getSize();e.setFloat2("bakedVertexAnimationTextureSizeInverted",1/i.width,1/i.height),e.setFloat("bakedVertexAnimationTime",this.time),t||e.setVector4("bakedVertexAnimationSettings",this.animationParameters),e.setTexture("bakedVertexAnimationTexture",this._texture)}clone(){const e=new $(this._scene);return this.copyTo(e),e}setAnimationParameters(e,t,i=0,s=30){this.animationParameters=new m.Lt(e,t,i,s)}dispose(e){var t;e&&(null===(t=this._texture)||void 0===t||t.dispose())}getClassName(){return"BakedVertexAnimationManager"}copyTo(e){j.p4.Clone((()=>e),this)}serialize(){return j.p4.Serialize(this)}parse(e,t,i){j.p4.Parse((()=>this),e,t,i)}}(0,H.gn)([(0,j.oU)(),(0,j.wz)("_markSubMeshesAsAttributesDirty")],$.prototype,"texture",void 0),(0,H.gn)([(0,j.qC)(),(0,j.wz)("_markSubMeshesAsAttributesDirty")],$.prototype,"isEnabled",void 0),(0,H.gn)([(0,j.qC)()],$.prototype,"animationParameters",void 0),(0,H.gn)([(0,j.qC)()],$.prototype,"time",void 0);var Y=i(76305),X=i(84684),Q=i(99309);class q{constructor(e,t){this._scene=e,this._mesh=t}async bakeVertexData(e){if(!this._mesh.skeleton)throw new Error("No skeleton in this mesh.");const t=this._mesh.skeleton.bones.length,i=e.reduce(((e,t)=>e+t.to-t.from+1),0);if(isNaN(i))throw new Error("Invalid animation ranges.");let s=0;const r=new Float32Array(4*(t+1)*4*i);this._scene.stopAnimation(this._mesh),this._mesh.skeleton.returnToRest();for(const t of e)for(let e=t.from;e<=t.to;e++)await this._executeAnimationFrame(r,e,s++);return r}async _executeAnimationFrame(e,t,i){return new Promise(((s,r)=>{this._scene.beginAnimation(this._mesh.skeleton,t,t,!1,1,(()=>{const t=this._mesh.skeleton.getTransformMatrices(this._mesh);e.set(t,i*t.length),s()}))}))}textureFromBakedVertexData(e){if(!this._mesh.skeleton)throw new Error("No skeleton in this mesh.");const t=this._mesh.skeleton.bones.length,i=Y.l.CreateRGBATexture(e,4*(t+1),e.length/(4*(t+1)*4),this._scene,!1,!1,X.x.NEAREST_NEAREST,1);return i.name="VAT"+this._mesh.skeleton.name,i}serializeBakedVertexDataToObject(e){if(!this._mesh.skeleton)throw new Error("No skeleton in this mesh.");const t=this._mesh.skeleton.bones.length,i=4*(t+1),s=e.length/(4*(t+1)*4);return{vertexData:(0,Q.Gh)(e),width:i,height:s}}loadBakedVertexDataFromObject(e){return new Float32Array((0,Q.HQ)(e.vertexData))}serializeBakedVertexDataToJSON(e){return JSON.stringify(this.serializeBakedVertexDataToObject(e))}loadBakedVertexDataFromJSON(e){return this.loadBakedVertexDataFromObject(JSON.parse(e))}}i(10987);var K=i(21480),Z=i(63425),J=i(11193);class ee{constructor(e,t=new m.P,i=0,s=!1){this.direction=e,this.rotatedDirection=t,this.diff=i,this.ignore=s}}class te{constructor(e){this._ui=e,this.name="AttachToBoxBehavior",this.distanceAwayFromFace=.15,this.distanceAwayFromBottomOfFace=.15,this._faceVectors=[new ee(m.P.Up()),new ee(m.P.Down()),new ee(m.P.Left()),new ee(m.P.Right()),new ee(m.P.Forward()),new ee(m.P.Forward().scaleInPlace(-1))],this._tmpMatrix=new m.y3,this._tmpVector=new m.P,this._zeroVector=m.P.Zero(),this._lookAtTmpMatrix=new m.y3}init(){}_closestFace(e){return this._faceVectors.forEach((t=>{this._target.rotationQuaternion||(this._target.rotationQuaternion=m._f.RotationYawPitchRoll(this._target.rotation.y,this._target.rotation.x,this._target.rotation.z)),this._target.rotationQuaternion.toRotationMatrix(this._tmpMatrix),m.P.TransformCoordinatesToRef(t.direction,this._tmpMatrix,t.rotatedDirection),t.diff=m.P.GetAngleBetweenVectors(t.rotatedDirection,e,m.P.Cross(t.rotatedDirection,e))})),this._faceVectors.reduce(((e,t)=>e.ignore?t:t.ignore||e.diff<t.diff?e:t),this._faceVectors[0])}_lookAtToRef(e,t=new m.P(0,1,0),i){m.y3.LookAtLHToRef(this._zeroVector,e,t,this._lookAtTmpMatrix),this._lookAtTmpMatrix.invert(),m._f.FromRotationMatrixToRef(this._lookAtTmpMatrix,i)}attach(e){this._target=e,this._scene=this._target.getScene(),this._onRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{if(!this._scene.activeCamera)return;let t=this._scene.activeCamera.position;this._scene.activeCamera.devicePosition&&(t=this._scene.activeCamera.devicePosition);const i=this._closestFace(t.subtract(e.position));this._scene.activeCamera.leftCamera?this._scene.activeCamera.leftCamera.computeWorldMatrix().getRotationMatrixToRef(this._tmpMatrix):this._scene.activeCamera.computeWorldMatrix().getRotationMatrixToRef(this._tmpMatrix),m.P.TransformCoordinatesToRef(m.P.Up(),this._tmpMatrix,this._tmpVector),this._faceVectors.forEach((e=>{i.direction.x&&e.direction.x&&(e.ignore=!0),i.direction.y&&e.direction.y&&(e.ignore=!0),i.direction.z&&e.direction.z&&(e.ignore=!0)}));const s=this._closestFace(this._tmpVector);this._faceVectors.forEach((e=>{e.ignore=!1})),this._ui.position.copyFrom(e.position),i.direction.x&&(i.rotatedDirection.scaleToRef(e.scaling.x/2+this.distanceAwayFromFace,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)),i.direction.y&&(i.rotatedDirection.scaleToRef(e.scaling.y/2+this.distanceAwayFromFace,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)),i.direction.z&&(i.rotatedDirection.scaleToRef(e.scaling.z/2+this.distanceAwayFromFace,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)),this._ui.rotationQuaternion||(this._ui.rotationQuaternion=m._f.RotationYawPitchRoll(this._ui.rotation.y,this._ui.rotation.x,this._ui.rotation.z)),i.rotatedDirection.scaleToRef(-1,this._tmpVector),this._lookAtToRef(this._tmpVector,s.rotatedDirection,this._ui.rotationQuaternion),s.direction.x&&this._ui.up.scaleToRef(this.distanceAwayFromBottomOfFace-e.scaling.x/2,this._tmpVector),s.direction.y&&this._ui.up.scaleToRef(this.distanceAwayFromBottomOfFace-e.scaling.y/2,this._tmpVector),s.direction.z&&this._ui.up.scaleToRef(this.distanceAwayFromBottomOfFace-e.scaling.z/2,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)}))}detach(){this._scene.onBeforeRenderObservable.remove(this._onRenderObserver)}}var ie=i(17358),se=i(47324);class re{constructor(){this._startDistance=0,this._initialScale=new m.P(0,0,0),this._targetScale=new m.P(0,0,0),this._sceneRenderObserver=null,this._dragBehaviorA=new se.M({}),this._dragBehaviorA.moveAttached=!1,this._dragBehaviorB=new se.M({}),this._dragBehaviorB.moveAttached=!1}get name(){return"MultiPointerScale"}init(){}_getCurrentDistance(){return this._dragBehaviorA.lastDragPosition.subtract(this._dragBehaviorB.lastDragPosition).length()}attach(e){this._ownerNode=e,this._dragBehaviorA.onDragStartObservable.add((()=>{this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging&&(this._dragBehaviorA.currentDraggingPointerId==this._dragBehaviorB.currentDraggingPointerId?this._dragBehaviorA.releaseDrag():(this._initialScale.copyFrom(e.scaling),this._startDistance=this._getCurrentDistance()))})),this._dragBehaviorB.onDragStartObservable.add((()=>{this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging&&(this._dragBehaviorA.currentDraggingPointerId==this._dragBehaviorB.currentDraggingPointerId?this._dragBehaviorB.releaseDrag():(this._initialScale.copyFrom(e.scaling),this._startDistance=this._getCurrentDistance()))})),[this._dragBehaviorA,this._dragBehaviorB].forEach((e=>{e.onDragObservable.add((()=>{if(this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging){const e=this._getCurrentDistance()/this._startDistance;this._initialScale.scaleToRef(e,this._targetScale)}}))})),e.addBehavior(this._dragBehaviorA),e.addBehavior(this._dragBehaviorB),this._sceneRenderObserver=e.getScene().onBeforeRenderObservable.add((()=>{if(this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging){const t=this._targetScale.subtract(e.scaling).scaleInPlace(.1);t.length()>.01&&e.scaling.addInPlace(t)}}))}detach(){this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver),[this._dragBehaviorA,this._dragBehaviorB].forEach((e=>{e.onDragStartObservable.clear(),e.onDragObservable.clear(),this._ownerNode.removeBehavior(e)}))}}var ne=i(5377),oe=i(87541),ae=i(73730),he=i(12727),le=i(68954),ce=i(56614),ue=i(730);class de{get maxAngle(){return this._maxAngle}set maxAngle(e){this._setMaxAngle(e)}constructor(e,t,i){this.targetPosition=m.P.Zero(),this.poleTargetPosition=m.P.Zero(),this.poleTargetLocalOffset=m.P.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=m._f.Identity(),this._bone1Mat=m.y3.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._rightHandedSystem=!1,this._bendAxis=m.P.Right(),this._slerping=!1,this._adjustRoll=0,this._notEnoughInformation=!1,this._bone2=t;const s=t.getParent();if(!s)return this._notEnoughInformation=!0,void p.Y.Error("BoneIKController: bone must have a parent for IK to work.");if(this._bone1=s,0===this._bone2.children.length&&!this._bone2.length)return this._notEnoughInformation=!0,void p.Y.Error("BoneIKController: bone must not be a leaf or it should have a length for IK to work.");this.mesh=e,t.getSkeleton().computeAbsoluteMatrices();const r=t.getPosition();if(t.getAbsoluteMatrix().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=-1,r.x>r.y&&r.x>r.z&&(this._adjustRoll=.5*Math.PI,this._bendAxis.z=1)),this._bone1.length&&this._bone2.length){const e=this._bone1.getScale(),t=this._bone2.getScale();this._bone1Length=this._bone1.length*e.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*t.y*this.mesh.scaling.y}else if(this._bone2.children[0]){e.computeWorldMatrix(!0);const t=this._bone2.children[0].getAbsolutePosition(e),i=this._bone2.getAbsolutePosition(e),s=this._bone1.getAbsolutePosition(e);this._bone2Length=m.P.Distance(t,i),this._bone1Length=m.P.Distance(i,s)}else{e.computeWorldMatrix(!0);const t=this._bone2.getScale();this._bone2Length=this._bone2.length*t.y*this.mesh.scaling.y;const i=this._bone2.getAbsolutePosition(e),s=this._bone1.getAbsolutePosition(e);this._bone1Length=m.P.Distance(i,s)}this._bone1.getRotationMatrixToRef(ue.T.WORLD,e,this._bone1Mat),this.maxAngle=Math.PI,i&&(i.targetMesh&&(this.targetMesh=i.targetMesh,this.targetMesh.computeWorldMatrix(!0)),i.poleTargetMesh?(this.poleTargetMesh=i.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):i.poleTargetBone?this.poleTargetBone=i.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),i.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(i.poleTargetLocalOffset),i.poleAngle&&(this.poleAngle=i.poleAngle),i.bendAxis&&this._bendAxis.copyFrom(i.bendAxis),i.maxAngle&&(this.maxAngle=i.maxAngle),i.slerpAmount&&(this.slerpAmount=i.slerpAmount))}_setMaxAngle(e){e<0&&(e=0),(e>Math.PI||null==e)&&(e=Math.PI),this._maxAngle=e;const t=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(t*t+i*i-2*t*i*Math.cos(e))}update(){if(this._notEnoughInformation)return;const e=this.targetPosition,t=this.poleTargetPosition,i=de._TmpMats[0],s=de._TmpMats[1];this.targetMesh&&e.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,t):this.poleTargetMesh&&m.P.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),t);const r=de._TmpVecs[0],n=de._TmpVecs[1],o=de._TmpVecs[2],a=de._TmpVecs[3],h=de._TmpVecs[4],l=de._TmpQuat;this._bone1.getAbsolutePositionToRef(this.mesh,r),t.subtractToRef(r,h),0==h.x&&0==h.y&&0==h.z?h.y=1:h.normalize(),e.subtractToRef(r,a),a.normalize(),m.P.CrossToRef(a,h,n),n.normalize(),m.P.CrossToRef(a,n,o),o.normalize(),m.y3.FromXYZAxesToRef(o,a,n,i);const c=this._bone1Length,u=this._bone2Length;let d=m.P.Distance(r,e);this._maxReach>0&&(d=Math.min(this._maxReach,d));let p=(u*u+d*d-c*c)/(2*u*d),_=(d*d+c*c-u*u)/(2*d*c);p>1&&(p=1),_>1&&(_=1),p<-1&&(p=-1),_<-1&&(_=-1);const g=Math.acos(p),f=Math.acos(_);let b=-g-f;if(this._rightHandedSystem)m.y3.RotationYawPitchRollToRef(0,0,this._adjustRoll,s),s.multiplyToRef(i,i),m.y3.RotationAxisToRef(this._bendAxis,f,s),s.multiplyToRef(i,i);else{const e=de._TmpVecs[5];e.copyFrom(this._bendAxis),e.x*=-1,m.y3.RotationAxisToRef(e,-f,s),s.multiplyToRef(i,i)}this.poleAngle&&(m.y3.RotationAxisToRef(a,this.poleAngle,s),i.multiplyToRef(s,i)),this._bone1&&(this.slerpAmount<1?(this._slerping||m._f.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),m._f.FromRotationMatrixToRef(i,l),m._f.SlerpToRef(this._bone1Quat,l,this.slerpAmount,this._bone1Quat),b=this._bone2Ang*(1-this.slerpAmount)+b*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,ue.T.WORLD,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(i,ue.T.WORLD,this.mesh),this._bone1Mat.copyFrom(i),this._slerping=!1),this._updateLinkedTransformRotation(this._bone1)),this._bone2.setAxisAngle(this._bendAxis,b,ue.T.LOCAL),this._updateLinkedTransformRotation(this._bone2),this._bone2Ang=b}_updateLinkedTransformRotation(e){e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new m._f),e.getRotationQuaternionToRef(ue.T.LOCAL,null,e._linkedTransformNode.rotationQuaternion))}}de._TmpVecs=[m.P.Zero(),m.P.Zero(),m.P.Zero(),m.P.Zero(),m.P.Zero(),m.P.Zero()],de._TmpQuat=m._f.Identity(),de._TmpMats=[m.y3.Identity(),m.y3.Identity()];var pe=i(32085);class _e{get minYaw(){return this._minYaw}set minYaw(e){this._minYaw=e,this._minYawSin=Math.sin(e),this._minYawCos=Math.cos(e),null!=this._maxYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get maxYaw(){return this._maxYaw}set maxYaw(e){this._maxYaw=e,this._maxYawSin=Math.sin(e),this._maxYawCos=Math.cos(e),null!=this._minYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch=e,this._minPitchTan=Math.tan(e)}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch=e,this._maxPitchTan=Math.tan(e)}constructor(e,t,i,s){if(this.upAxis=m.P.Up(),this.upAxisSpace=ue.T.LOCAL,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this._boneQuat=m._f.Identity(),this._slerping=!1,this._firstFrameSkipped=!1,this._fowardAxis=m.P.Forward(),this.useAbsoluteValueForYaw=!1,this.mesh=e,this.bone=t,this.target=i,s){if(s.adjustYaw&&(this.adjustYaw=s.adjustYaw),s.adjustPitch&&(this.adjustPitch=s.adjustPitch),s.adjustRoll&&(this.adjustRoll=s.adjustRoll),null!=s.maxYaw?this.maxYaw=s.maxYaw:this.maxYaw=Math.PI,null!=s.minYaw?this.minYaw=s.minYaw:this.minYaw=-Math.PI,null!=s.maxPitch?this.maxPitch=s.maxPitch:this.maxPitch=Math.PI,null!=s.minPitch?this.minPitch=s.minPitch:this.minPitch=-Math.PI,null!=s.slerpAmount&&(this.slerpAmount=s.slerpAmount),null!=s.upAxis&&(this.upAxis=s.upAxis),null!=s.upAxisSpace&&(this.upAxisSpace=s.upAxisSpace),null!=s.yawAxis||null!=s.pitchAxis){let e=ue.RD.Y,t=ue.RD.X;null!=s.yawAxis&&(e=s.yawAxis.clone(),e.normalize()),null!=s.pitchAxis&&(t=s.pitchAxis.clone(),t.normalize());const i=m.P.Cross(t,e);this._transformYawPitch=m.y3.Identity(),m.y3.FromXYZAxesToRef(t,e,i,this._transformYawPitch),this._transformYawPitchInv=this._transformYawPitch.clone(),this._transformYawPitch.invert()}void 0!==s.useAbsoluteValueForYaw&&(this.useAbsoluteValueForYaw=s.useAbsoluteValueForYaw)}t.getParent()||this.upAxisSpace!=ue.T.BONE||(this.upAxisSpace=ue.T.LOCAL)}update(){if(this.slerpAmount<1&&!this._firstFrameSkipped)return void(this._firstFrameSkipped=!0);const e=this.bone,t=_e._TmpVecs[0];e.getAbsolutePositionToRef(this.mesh,t);let i=this.target;const s=_e._TmpMats[0],r=_e._TmpMats[1],n=this.mesh,o=e.getParent(),a=_e._TmpVecs[1];a.copyFrom(this.upAxis),this.upAxisSpace==ue.T.BONE&&o?(this._transformYawPitch&&m.P.TransformCoordinatesToRef(a,this._transformYawPitchInv,a),o.getDirectionToRef(a,this.mesh,a)):this.upAxisSpace==ue.T.LOCAL&&(n.getDirectionToRef(a,a),1==n.scaling.x&&1==n.scaling.y&&1==n.scaling.z||a.normalize());let h=!1,l=!1;if(this._maxYaw==Math.PI&&this._minYaw==-Math.PI||(h=!0),this._maxPitch==Math.PI&&this._minPitch==-Math.PI||(l=!0),h||l){const e=_e._TmpMats[2],s=_e._TmpMats[3];if(this.upAxisSpace==ue.T.BONE&&1==a.y&&o)o.getRotationMatrixToRef(ue.T.WORLD,this.mesh,e);else if(this.upAxisSpace!=ue.T.LOCAL||1!=a.y||o){let t=_e._TmpVecs[2];t.copyFrom(this._fowardAxis),this._transformYawPitch&&m.P.TransformCoordinatesToRef(t,this._transformYawPitchInv,t),o?o.getDirectionToRef(t,this.mesh,t):n.getDirectionToRef(t,t);const i=m.P.Cross(a,t);i.normalize(),t=m.P.Cross(i,a),m.y3.FromXYZAxesToRef(i,a,t,e)}else e.copyFrom(n.getWorldMatrix());e.invertToRef(s);let r=null;if(l){const n=_e._TmpVecs[3];i.subtractToRef(t,n),m.P.TransformCoordinatesToRef(n,s,n),r=Math.sqrt(n.x*n.x+n.z*n.z);const o=Math.atan2(n.y,r);let a=o;o>this._maxPitch?(n.y=this._maxPitchTan*r,a=this._maxPitch):o<this._minPitch&&(n.y=this._minPitchTan*r,a=this._minPitch),o!=a&&(m.P.TransformCoordinatesToRef(n,e,n),n.addInPlace(t),i=n)}if(h){const n=_e._TmpVecs[4];i.subtractToRef(t,n),m.P.TransformCoordinatesToRef(n,s,n);const o=Math.atan2(n.x,n.z),a=this.useAbsoluteValueForYaw?Math.abs(o):o;let h=o;if((a>this._maxYaw||a<this._minYaw)&&(null==r&&(r=Math.sqrt(n.x*n.x+n.z*n.z)),this._yawRange>Math.PI?this._isAngleBetween(o,this._maxYaw,this._midYawConstraint)?(n.z=this._maxYawCos*r,n.x=this._maxYawSin*r,h=this._maxYaw):this._isAngleBetween(o,this._midYawConstraint,this._minYaw)&&(n.z=this._minYawCos*r,n.x=this._minYawSin*r,h=this._minYaw):a>this._maxYaw?(n.z=this._maxYawCos*r,n.x=this._maxYawSin*r,o<0&&this.useAbsoluteValueForYaw&&(n.x*=-1),h=this._maxYaw):a<this._minYaw&&(n.z=this._minYawCos*r,n.x=this._minYawSin*r,o<0&&this.useAbsoluteValueForYaw&&(n.x*=-1),h=this._minYaw)),this._slerping&&this._yawRange>Math.PI){const e=_e._TmpVecs[8];e.copyFrom(ue.RD.Z),this._transformYawPitch&&m.P.TransformCoordinatesToRef(e,this._transformYawPitchInv,e);const t=_e._TmpMats[4];this._boneQuat.toRotationMatrix(t),this.mesh.getWorldMatrix().multiplyToRef(t,t),m.P.TransformCoordinatesToRef(e,t,e),m.P.TransformCoordinatesToRef(e,s,e);const i=Math.atan2(e.x,e.z);if(this._getAngleBetween(i,o)>this._getAngleBetween(i,this._midYawConstraint)){null==r&&(r=Math.sqrt(n.x*n.x+n.z*n.z));const e=this._getAngleBetween(i,this._maxYaw);this._getAngleBetween(i,this._minYaw)<e?(h=i+.75*Math.PI,n.z=Math.cos(h)*r,n.x=Math.sin(h)*r):(h=i-.75*Math.PI,n.z=Math.cos(h)*r,n.x=Math.sin(h)*r)}}o!=h&&(m.P.TransformCoordinatesToRef(n,e,n),n.addInPlace(t),i=n)}}const c=_e._TmpVecs[5],u=_e._TmpVecs[6],d=_e._TmpVecs[7],p=_e._TmpQuat;i.subtractToRef(t,c),c.normalize(),m.P.CrossToRef(a,c,u),u.normalize(),m.P.CrossToRef(c,u,d),d.normalize(),m.y3.FromXYZAxesToRef(u,d,c,s),0===u.x&&0===u.y&&0===u.z||0===d.x&&0===d.y&&0===d.z||0===c.x&&0===c.y&&0===c.z||((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(m.y3.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,r),r.multiplyToRef(s,s)),this.slerpAmount<1?(this._slerping||this.bone.getRotationQuaternionToRef(ue.T.WORLD,this.mesh,this._boneQuat),this._transformYawPitch&&this._transformYawPitch.multiplyToRef(s,s),m._f.FromRotationMatrixToRef(s,p),m._f.SlerpToRef(this._boneQuat,p,this.slerpAmount,this._boneQuat),this.bone.setRotationQuaternion(this._boneQuat,ue.T.WORLD,this.mesh),this._slerping=!0):(this._transformYawPitch&&this._transformYawPitch.multiplyToRef(s,s),this.bone.setRotationMatrix(s,ue.T.WORLD,this.mesh),this._slerping=!1),this._updateLinkedTransformRotation())}_getAngleDiff(e,t){let i=t-e;return i%=2*Math.PI,i>Math.PI?i-=2*Math.PI:i<-Math.PI&&(i+=2*Math.PI),i}_getAngleBetween(e,t){let i=0;return i=(e=(e%=2*Math.PI)<0?e+2*Math.PI:e)<(t=(t%=2*Math.PI)<0?t+2*Math.PI:t)?t-e:e-t,i>Math.PI&&(i=2*Math.PI-i),i}_isAngleBetween(e,t,i){if(e=(e%=2*Math.PI)<0?e+2*Math.PI:e,(t=(t%=2*Math.PI)<0?t+2*Math.PI:t)<(i=(i%=2*Math.PI)<0?i+2*Math.PI:i)){if(e>t&&e<i)return!0}else if(e>i&&e<t)return!0;return!1}_updateLinkedTransformRotation(){const e=this.bone;e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new m._f),e.getRotationQuaternionToRef(ue.T.LOCAL,null,e._linkedTransformNode.rotationQuaternion))}}_e._TmpVecs=pe.B.BuildArray(10,m.P.Zero),_e._TmpQuat=m._f.Identity(),_e._TmpMats=pe.B.BuildArray(5,m.y3.Identity);var ge=i(59061),me=i(37959),fe=i(69287),be=i(7233),ve=i(11917),ye=i(7632),xe=i(30282),Pe=i(34452),Ce=i(17366),Te=i(55630),Se=i(4442),Ee=i(54946);Ee.$.prototype.addVRDeviceOrientation=function(){return this.add(new Re),this};class Re{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}attachControl(e){e=w.w1.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);const t=this.camera.getScene().getEngine().getHostWindow();t&&("undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e?t.addEventListener("deviceorientation",this._deviceOrientationHandler):w.w1.Warn("Permission not granted.")})).catch((e=>{w.w1.Error(e)})):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){null!==e.alpha&&(this._alpha=(0|+e.alpha)*this.alphaCorrection),null!==e.gamma&&(this._gamma=(0|+e.gamma)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}Se.u.ArcRotateCameraVRDeviceOrientationInput=Re;var Me=i(98383),Ae=i(60085),Ie=i(81820),Oe=i(34701),we=i(59465),De=i(87385),Be=i(79922),Ne=i(56977),Fe=i(58708),Le=i(42463),Ve=i(53688),ke=i(27258),ze=i(4639);ze.a.prototype.addVirtualJoystick=function(){return this.add(new Ge),this};class Ge{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){const e=this.camera,t=50*e._computeLocalCameraSpeed(),i=m.y3.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),s=m.P.TransformCoordinates(new m.P(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(s),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new ke.N(!0),this._leftjoystick.setAxisForUpDown(ke.h.Z),this._leftjoystick.setAxisForLeftRight(ke.h.X),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new ke.N(!1),this._rightjoystick.setAxisForUpDown(ke.h.X),this._rightjoystick.setAxisForLeftRight(ke.h.Y),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}Se.u.FreeCameraVirtualJoystickInput=Ge;var Ue=i(95593),We=i(35753),He=i(60156),je=i(35088),$e=i(23579),Ye=i(84861),Xe=i(30570);class Qe extends We.C{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysForward(){const e=this.inputs.attached.keyboard;return e?e.keysForward:[]}set keysForward(e){const t=this.inputs.attached.keyboard;t&&(t.keysForward=e)}get keysBackward(){const e=this.inputs.attached.keyboard;return e?e.keysBackward:[]}set keysBackward(e){const t=this.inputs.attached.keyboard;t&&(t.keysBackward=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}constructor(e,t,i,s=!0){super(e,t,i,s),this.ellipsoid=new m.P(1,1,1),this.ellipsoidOffset=new m.P(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=m.P.Zero(),this._trackRoll=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this._needMoveForGravity=!1,this._oldPosition=m.P.Zero(),this._diffPosition=m.P.Zero(),this._newPosition=m.P.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,i=null)=>{(e=>{this._newPosition.copyFrom(e),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>O.D.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&i&&this.onCollide(i))})(t)},this.inputs=new Xe.w(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=w.w1.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new m.P(0,0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?m.P.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let s=e;this.applyGravity&&(s=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,s,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=m.P.Zero(),this._transformedDirection=m.P.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}restoreRoll(e){const t=this._trackRoll,i=t-this.rotation.z;Math.abs(i)>=.001&&(this.rotation.z+=i/e,Math.abs(t-this.rotation.z)<=.001&&(this.rotation.z=t))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}}(0,H.gn)([(0,j.hd)()],Qe.prototype,"ellipsoid",void 0),(0,H.gn)([(0,j.hd)()],Qe.prototype,"ellipsoidOffset",void 0),(0,H.gn)([(0,j.qC)()],Qe.prototype,"checkCollisions",void 0),(0,H.gn)([(0,j.qC)()],Qe.prototype,"applyGravity",void 0);var qe=i(62528),Ke=i(86556);qe.N.AddNodeConstructor("FollowCamera",((e,t)=>()=>new Ze(e,m.P.Zero(),t))),qe.N.AddNodeConstructor("ArcFollowCamera",((e,t)=>()=>new Je(e,0,0,1,null,t)));class Ze extends We.C{constructor(e,t,i,s=null){super(e,t,i),this.radius=12,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.rotationOffset=0,this.lowerRotationOffsetLimit=null,this.upperRotationOffsetLimit=null,this.heightOffset=4,this.lowerHeightOffsetLimit=null,this.upperHeightOffsetLimit=null,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=s,this.inputs=new Ke.b(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_follow(e){if(!e)return;const t=m.jp.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(t);const i=Math.atan2(t.m[8],t.m[10]),s=w.w1.ToRadians(this.rotationOffset)+i,r=e.getAbsolutePosition(),n=r.x+Math.sin(s)*this.radius,o=r.z+Math.cos(s)*this.radius,a=n-this.position.x,h=r.y+this.heightOffset-this.position.y,l=o-this.position.z;let c=a*this.cameraAcceleration*2,u=h*this.cameraAcceleration,d=l*this.cameraAcceleration*2;(c>this.maxCameraSpeed||c<-this.maxCameraSpeed)&&(c=c<1?-this.maxCameraSpeed:this.maxCameraSpeed),(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=u<1?-this.maxCameraSpeed:this.maxCameraSpeed),(d>this.maxCameraSpeed||d<-this.maxCameraSpeed)&&(d=d<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new m.P(this.position.x+c,this.position.y+u,this.position.z+d),this.setTarget(r)}attachControl(e,t){t=w.w1.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t),this._reset=()=>{}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){this.inputs.checkInputs(),this._checkLimits(),super._checkInputs(),this.lockedTarget&&this._follow(this.lockedTarget)}_checkLimits(){null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),null!==this.lowerHeightOffsetLimit&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),null!==this.upperHeightOffsetLimit&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),null!==this.lowerRotationOffsetLimit&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),null!==this.upperRotationOffsetLimit&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)}getClassName(){return"FollowCamera"}}(0,H.gn)([(0,j.qC)()],Ze.prototype,"radius",void 0),(0,H.gn)([(0,j.qC)()],Ze.prototype,"lowerRadiusLimit",void 0),(0,H.gn)([(0,j.qC)()],Ze.prototype,"upperRadiusLimit",void 0),(0,H.gn)([(0,j.qC)()],Ze.prototype,"rotationOffset",void 0),(0,H.gn)([(0,j.qC)()],Ze.prototype,"lowerRotationOffsetLimit",void 0),(0,H.gn)([(0,j.qC)()],Ze.prototype,"upperRotationOffsetLimit",void 0),(0,H.gn)([(0,j.qC)()],Ze.prototype,"heightOffset",void 0),(0,H.gn)([(0,j.qC)()],Ze.prototype,"lowerHeightOffsetLimit",void 0),(0,H.gn)([(0,j.qC)()],Ze.prototype,"upperHeightOffsetLimit",void 0),(0,H.gn)([(0,j.qC)()],Ze.prototype,"cameraAcceleration",void 0),(0,H.gn)([(0,j.qC)()],Ze.prototype,"maxCameraSpeed",void 0),(0,H.gn)([(0,j.RR)("lockedTargetId")],Ze.prototype,"lockedTarget",void 0);class Je extends We.C{constructor(e,t,i,s,r,n){super(e,m.P.Zero(),n),this.alpha=t,this.beta=i,this.radius=s,this._cartesianCoordinates=m.P.Zero(),this.setMeshTarget(r)}setMeshTarget(e){this._meshTarget=e,this._follow()}_follow(){if(!this._meshTarget)return;this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);const e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}_checkInputs(){super._checkInputs(),this._follow()}getClassName(){return"ArcFollowCamera"}}var et=i(52171),tt=i(2702);qe.N.AddNodeConstructor("AnaglyphArcRotateCamera",((e,t,i)=>()=>new it(e,0,0,1,m.P.Zero(),i.interaxial_distance,t)));class it extends $e.Y{constructor(e,t,i,s,r,n,o){super(e,t,i,s,r,o),this._setRigMode=tt.i.bind(null,this),this.interaxialDistance=n,this.setCameraRigMode(Ue.V.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n})}getClassName(){return"AnaglyphArcRotateCamera"}}qe.N.AddNodeConstructor("AnaglyphFreeCamera",((e,t,i)=>()=>new st(e,m.P.Zero(),i.interaxial_distance,t)));class st extends He.c{constructor(e,t,i,s){super(e,t,s),this._setRigMode=tt.i.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(Ue.V.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphFreeCamera"}}qe.N.AddNodeConstructor("AnaglyphGamepadCamera",((e,t,i)=>()=>new rt(e,m.P.Zero(),i.interaxial_distance,t)));class rt extends et.i{constructor(e,t,i,s){super(e,t,s),this._setRigMode=tt.i.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(Ue.V.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphGamepadCamera"}}var nt=i(62184);qe.N.AddNodeConstructor("AnaglyphUniversalCamera",((e,t,i)=>()=>new ot(e,m.P.Zero(),i.interaxial_distance,t)));class ot extends nt.x{constructor(e,t,i,s){super(e,t,s),this._setRigMode=tt.i.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(Ue.V.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphUniversalCamera"}}var at=i(32478);qe.N.AddNodeConstructor("StereoscopicArcRotateCamera",((e,t,i)=>()=>new ht(e,0,0,1,m.P.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class ht extends $e.Y{constructor(e,t,i,s,r,n,o,a){super(e,t,i,s,r,a),this._setRigMode=at.k.bind(null,this),this.interaxialDistance=n,this.isStereoscopicSideBySide=o,this.setCameraRigMode(o?Ue.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ue.V.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n})}getClassName(){return"StereoscopicArcRotateCamera"}}qe.N.AddNodeConstructor("StereoscopicFreeCamera",((e,t,i)=>()=>new lt(e,m.P.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class lt extends He.c{constructor(e,t,i,s,r){super(e,t,r),this._setRigMode=at.k.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?Ue.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ue.V.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicFreeCamera"}}qe.N.AddNodeConstructor("StereoscopicGamepadCamera",((e,t,i)=>()=>new ct(e,m.P.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class ct extends et.i{constructor(e,t,i,s,r){super(e,t,r),this._setRigMode=at.k.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?Ue.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ue.V.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicGamepadCamera"}}qe.N.AddNodeConstructor("StereoscopicFreeCamera",((e,t,i)=>()=>new ut(e,m.P.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class ut extends nt.x{constructor(e,t,i,s,r){super(e,t,r),this._setRigMode=at.k.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?Ue.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ue.V.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicUniversalCamera"}}var dt=i(44482),pt=i(62328);class _t extends nt.x{set distanceBetweenEyes(e){this._distanceBetweenEyes=e}get distanceBetweenEyes(){return this._distanceBetweenEyes}set distanceToProjectionPlane(e){this._distanceToProjectionPlane=e}get distanceToProjectionPlane(){return this._distanceToProjectionPlane}constructor(e,t,i,s=1,r=.065){super(e,t,i),this._distanceBetweenEyes=r,this._distanceToProjectionPlane=s,this.setCameraRigMode(Ue.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL,{stereoHalfAngle:0}),this._cameraRigParams.stereoHalfAngle=0,this._cameraRigParams.interaxialDistance=r}getClassName(){return"StereoscopicUniversalCamera"}createRigCamera(e){const t=new We.C(e,m.P.Zero(),this.getScene()),i=new dt.Y("tm_"+e,this.getScene());return t.parent=i,i.setPivotMatrix(m.y3.Identity(),!1),t.isRigCamera=!0,t.rigParent=this,t}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++){const t=this._rigCameras[e];t.minZ=this.minZ,t.maxZ=this.maxZ,t.fov=this.fov,t.upVector.copyFrom(this.upVector),t.rotationQuaternion?t.rotationQuaternion.copyFrom(this.rotationQuaternion):t.rotation.copyFrom(this.rotation),this._updateCamera(this._rigCameras[e],e)}}_updateCamera(e,t){const i=this.distanceBetweenEyes/2,s=i/this.distanceToProjectionPlane;e.position.copyFrom(this.position),e.position.addInPlaceFromFloats(0===t?-i:i,0,-this._distanceToProjectionPlane);const r=e.parent,n=r.getPivotMatrix();n.setTranslationFromFloats(0===t?i:-i,0,0),n.setRowFromFloats(2,0===t?s:-s,0,1,0),r.setPivotMatrix(n,!1)}_setRigMode(){this._rigCameras[0].viewport=new pt.l(0,0,.5,1),this._rigCameras[1].viewport=new pt.l(.5,0,.5,1);for(let e=0;e<this._rigCameras.length;e++)this._updateCamera(this._rigCameras[e],e)}}qe.N.AddNodeConstructor("VirtualJoysticksCamera",((e,t)=>()=>new gt(e,m.P.Zero(),t)));class gt extends He.c{constructor(e,t,i){super(e,t,i),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}}var mt=i(39301),ft=i(88625);qe.N.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",((e,t)=>()=>new bt(e,0,0,1,m.P.Zero(),t)));class bt extends $e.Y{constructor(e,t,i,s,r,n,o=!0,a=mt.X.GetDefault()){super(e,t,i,s,r,n),this._setRigMode=ft.S.bind(null,this),a.compensateDistortion=o,this.setCameraRigMode(Ue.V.RIG_MODE_VR,{vrCameraMetrics:a}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}}var vt=i(68981),yt=i(12098);qe.N.AddNodeConstructor("VRDeviceOrientationGamepadCamera",((e,t)=>()=>new xt(e,m.P.Zero(),t)));class xt extends vt.i{constructor(e,t,i,s=!0,r=mt.X.GetDefault()){super(e,t,i,s,r),this._setRigMode=ft.S.bind(null,this),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}}var Pt=i(25690),Ct=i(50147),Tt=i(21983),St=i(14717),Et=i(82202),Rt=i(43801),Mt=i(33632),At=i(86521),It=i(97863),Ot=i(39268),wt=i(10918),Dt=i(9259),Bt=i(79346),Nt=i(81383),Ft=i(76565),Lt=i(92005),Vt=i(30307);class kt{constructor(e,t=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=kt._IdCounter++,t)this._gazeTracker=t.clone("gazeTracker");else{this._gazeTracker=(0,Lt.eu)("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const t=new Ot.K("targetMat",e);t.specularColor=g.Wo.Black(),t.emissiveColor=new g.Wo(.7,.7,.7),t.backFaceCulling=!1,this._gazeTracker.material=t}}_getForwardRay(e){return new At.z(m.P.Zero(),new m.P(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}kt._IdCounter=0;class zt extends kt{constructor(e,t,i){super(t,i),this.webVRController=e,this._laserPointer=(0,Ft.wf)("laserPointer",{updatable:!1,height:1,diameterTop:.004,diameterBottom:2e-4,tessellation:20,subdivisions:1},t);const s=new Ot.K("laserPointerMat",t);if(s.emissiveColor=new g.Wo(.7,.7,.7),s.alpha=.6,this._laserPointer.material=s,this._laserPointer.rotation.x=Math.PI/2,this._laserPointer.position.z=-.5,this._laserPointer.isVisible=!1,this._laserPointer.isPickable=!1,!e.mesh){const i=new Mt.Kj("preloadControllerMesh",t),s=new Mt.Kj(St.K4.POINTING_POSE,t);s.rotation.x=-.7,i.addChild(s),e.attachToMesh(i)}this._setLaserPointerParent(e.mesh),this._meshAttachedObserver=e._meshAttachedObservable.add((e=>{this._setLaserPointerParent(e)}))}_getForwardRay(e){return this.webVRController.getForwardRay(e)}_activatePointer(){super._activatePointer(),this._laserPointer.isVisible=!0}_deactivatePointer(){super._deactivatePointer(),this._laserPointer.isVisible=!1}_setLaserPointerColor(e){this._laserPointer.material.emissiveColor=e}_setLaserPointerLightingDisabled(e){this._laserPointer.material.disableLighting=e}_setLaserPointerParent(e){const t=e=>{e.isPickable=!1,e.getChildMeshes().forEach((e=>{t(e)}))};t(e);const i=e.getChildren(void 0,!1);let s=e;this.webVRController._pointingPoseNode=null;for(let e=0;e<i.length;e++)if(i[e].name&&i[e].name.indexOf(St.K4.POINTING_POSE)>=0){s=i[e],this.webVRController._pointingPoseNode=s;break}this._laserPointer.parent=s}_updatePointerDistance(e=100){this._laserPointer.scaling.y=e,this._laserPointer.position.z=-e/2}dispose(){super.dispose(),this._laserPointer.dispose(),this._meshAttachedObserver&&this.webVRController._meshAttachedObservable.remove(this._meshAttachedObserver)}}class Gt extends kt{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){const t=this._getCamera();return t?t.getForwardRay(e):new At.z(m.P.Zero(),m.P.Forward())}}class Ut{}class Wt{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get onControllerMeshLoaded(){return this.onControllerMeshLoadedObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._leftController&&this._leftController._gazeTracker&&this._leftController._gazeTracker.dispose(),this._rightController&&this._rightController._gazeTracker&&this._rightController._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker",this._leftController&&(this._leftController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")),this._rightController&&(this._rightController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")))}get leftControllerGazeTrackerMesh(){return this._leftController?this._leftController._gazeTracker:null}get rightControllerGazeTrackerMesh(){return this._rightController?this._rightController._gazeTracker:null}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1))}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e,e?(this._rightController&&this._rightController._activatePointer(),this._leftController&&this._leftController._activatePointer()):(this._rightController&&(this._rightController._deactivatePointer(),this._rightController._gazeTracker.isVisible=!1),this._leftController&&(this._leftController._deactivatePointer(),this._leftController._gazeTracker.isVisible=!1))}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._webVRready?this._webVRCamera:this._scene.activeCamera}get webVRCamera(){return this._webVRCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated||null!==this._leftController&&this._leftController._teleportationRequestInitiated||null!==this._rightController&&this._rightController._teleportationRequestInitiated}constructor(e,t={}){if(this.webVROptions=t,this._webVRsupported=!1,this._webVRready=!1,this._webVRrequesting=!1,this._webVRpresenting=!1,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new _.y$,this.onAfterEnteringVRObservable=new _.y$,this.onExitingVRObservable=new _.y$,this.onControllerMeshLoadedObservable=new _.y$,this._useCustomVRButton=!1,this._teleportationRequested=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=Wt.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new m.P(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new m.P(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._leftController=null,this._rightController=null,this._gazeColor=new g.Wo(.7,.7,.7),this._laserColor=new g.Wo(.7,.7,.7),this._pickedLaserColor=new g.Wo(.2,.2,1),this._pickedGazeColor=new g.Wo(0,0,1),this.onNewMeshSelected=new _.y$,this.onMeshSelectedWithController=new _.y$,this.onNewMeshPicked=new _.y$,this.onBeforeCameraTeleport=new _.y$,this.onAfterCameraTeleport=new _.y$,this.onSelectedMeshUnselected=new _.y$,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._interactionsRequested=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight(),this._fullscreenVRpresenting&&this._webVRready&&this.exitVR()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._leftController&&this._leftController._activePointer&&this._castRayAndSelectObject(this._leftController),this._rightController&&this._rightController._activePointer&&this._castRayAndSelectObject(this._rightController),this._noControllerIsActive&&(this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock)?this._castRayAndSelectObject(this._cameraGazer):this._cameraGazer._gazeTracker.isVisible=!1},this._onNewGamepadConnected=e=>{if(e.type!==Tt.nJ.POSE_ENABLED)e.leftStick&&e.onleftstickchanged((e=>{this._teleportationInitialized&&this.teleportationEnabled&&(!this._leftController&&!this._rightController||this._leftController&&!this._leftController._activePointer&&this._rightController&&!this._rightController._activePointer)&&(this._checkTeleportWithRay(e,this._cameraGazer),this._checkTeleportBackwards(e,this._cameraGazer))})),e.rightStick&&e.onrightstickchanged((e=>{this._teleportationInitialized&&this._checkRotate(e,this._cameraGazer)})),e.type===Tt.nJ.XBOX&&(e.onbuttondown((e=>{this._interactionsEnabled&&e===Rt.nR.A&&this._cameraGazer._selectionPointerDown()})),e.onbuttonup((e=>{this._interactionsEnabled&&e===Rt.nR.A&&this._cameraGazer._selectionPointerUp()})));else{const t=e,i=new zt(t,this._scene,this._cameraGazer._gazeTracker);"right"===t.hand||this._leftController&&this._leftController.webVRController!=t?this._rightController=i:this._leftController=i,this._tryEnableInteractionOnController(i)}},this._tryEnableInteractionOnController=e=>{this._interactionsRequested&&!e._interactionsEnabled&&this._enableInteractionOnController(e),this._teleportationRequested&&!e._teleportationEnabled&&this._enableTeleportationOnController(e)},this._onNewGamepadDisconnected=e=>{e instanceof Et.T&&("left"===e.hand&&null!=this._leftController&&(this._leftController.dispose(),this._leftController=null),"right"===e.hand&&null!=this._rightController&&(this._rightController.dispose(),this._rightController=null))},this._workingVector=m.P.Zero(),this._workingQuaternion=m._f.Identity(),this._workingMatrix=m.y3.Identity(),p.Y.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement(),"getVRDisplays"in navigator||void 0!==t.useXR||(t.useXR=!0),void 0===t.createFallbackVRDeviceOrientationFreeCamera&&(t.createFallbackVRDeviceOrientationFreeCamera=!0),void 0===t.createDeviceOrientationCamera&&(t.createDeviceOrientationCamera=!0),void 0===t.laserToggle&&(t.laserToggle=!0),void 0===t.defaultHeight&&(t.defaultHeight=1.7),t.useCustomVRButton&&(this._useCustomVRButton=!0,t.customVRButton&&(this._btnVR=t.customVRButton)),t.rayLength&&(this._rayLength=t.rayLength),this._defaultHeight=t.defaultHeight,t.positionScale&&(this._rayLength*=t.positionScale,this._defaultHeight*=t.positionScale),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new m.P(0,this._defaultHeight,0),t.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new Ye.n("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof We.C&&this._scene.activeCamera.rotation)){const e=this._scene.activeCamera;e.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(e.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(m._f.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z)),this._deviceOrientationCamera.rotation=e.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?Bt.g.IsSessionSupportedAsync("immersive-vr").then((i=>{i?(p.Y.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:t.floorMeshes||[]}).then((t=>{this.xr=t,this.xrTestDone=!0,this._cameraGazer=new Gt((()=>this.xr.baseExperience.camera),e),this.xr.baseExperience.onStateChangedObservable.add((e=>{switch(e){case Nt.k.ENTERING_XR:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case Nt.k.EXITING_XR:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case Nt.k.IN_XR:this._hasEnteredVR=!0;break;case Nt.k.NOT_IN_XR:this._hasEnteredVR=!1}}))}))):this._completeVRInit(e,t)})):this._completeVRInit(e,t)}_completeVRInit(e,t){if(this.xrTestDone=!0,t.createFallbackVRDeviceOrientationFreeCamera&&(t.useMultiview&&(t.vrDeviceOrientationCameraMetrics||(t.vrDeviceOrientationCameraMetrics=mt.X.GetDefault()),t.vrDeviceOrientationCameraMetrics.multiviewEnabled=!0),this._vrDeviceOrientationCamera=new vt.i("VRDeviceOrientationVRHelper",this._position,this._scene,!0,t.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._webVRCamera=new Pt.$("WebVRHelper",this._position,this._scene,t),this._webVRCamera.useStandingMatrix(),this._cameraGazer=new Gt((()=>this.currentVRCamera),e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let e=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";e+=".babylonVRicon.vrdisplaypresenting { display: none; }";const t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",(()=>{this.isInVRMode?this._scene.getEngine().disableVR():this.enterVR()}));const i=this._scene.getEngine().getHostWindow();i&&(i.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),t.createFallbackVRDeviceOrientationFreeCamera?this._displayVRButton():this._scene.getEngine().onVRDisplayChangedObservable.add((e=>{e.vrDisplay&&this._displayVRButton()})),this._onKeyDown=e=>{27===e.keyCode&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add((()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())}),Ct.kD.POINTERDOUBLETAP,!1),this._onVRDisplayChangedBind=e=>this._onVRDisplayChanged(e),this._onVrDisplayPresentChangeBind=()=>this._onVrDisplayPresentChange(),this._onVRRequestPresentStart=()=>{this._webVRrequesting=!0,this._updateButtonVisibility()},this._onVRRequestPresentComplete=()=>{this._webVRrequesting=!1,this._updateButtonVisibility()},e.getEngine().onVRDisplayChangedObservable.add(this._onVRDisplayChangedBind),e.getEngine().onVRRequestPresentStart.add(this._onVRRequestPresentStart),e.getEngine().onVRRequestPresentComplete.add(this._onVRRequestPresentComplete),i.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),e.onDisposeObservable.add((()=>{this.dispose()})),this._webVRCamera.onControllerMeshLoadedObservable.add((e=>this._onDefaultMeshLoaded(e))),this._scene.gamepadManager.onGamepadConnectedObservable.add(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.add(this._onNewGamepadDisconnected),this._updateButtonVisibility(),this._circleEase=new P.qP,this._circleEase.setEasingMode(P.Kp.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add((t=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&"mouse"===t.event.pointerType&&(t.type===Ct.kD.POINTERDOWN?this._cameraGazer._selectionPointerDown():t.type===Ct.kD.POINTERUP&&this._cameraGazer._selectionPointerUp())})),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}_onDefaultMeshLoaded(e){this._leftController&&this._leftController.webVRController==e&&e.mesh&&this._leftController._setLaserPointerParent(e.mesh),this._rightController&&this._rightController.webVRController==e&&e.mesh&&this._rightController._setLaserPointerParent(e.mesh);try{this.onControllerMeshLoadedObservable.notifyObservers(e)}catch(e){p.Y.Warn("Error in your custom logic onControllerMeshLoaded: "+e)}}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===Nt.k.IN_XR||this._webVRpresenting||this._fullscreenVRpresenting}_onVrDisplayPresentChange(){const e=this._scene.getEngine().getVRDevice();if(e){const t=this._webVRpresenting;this._webVRpresenting=e.isPresenting,t&&!this._webVRpresenting&&this.exitVR()}else p.Y.Warn("Detected VRDisplayPresentChange on an unknown VRDisplay. Did you can enterVR on the vrExperienceHelper?");this._updateButtonVisibility()}_onVRDisplayChanged(e){this._webVRsupported=e.vrSupported,this._webVRready=!!e.vrDisplay,this._webVRpresenting=e.vrDisplay&&e.vrDisplay.isPresenting,this._updateButtonVisibility()}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){this._useCustomVRButton||this._btnVRDisplayed||!this._btnVR||(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){this._btnVR&&!this._useCustomVRButton&&(this._btnVR.className="babylonVRicon",this.isInVRMode?this._btnVR.className+=" vrdisplaypresenting":(this._webVRready&&(this._btnVR.className+=" vrdisplayready"),this._webVRsupported&&(this._btnVR.className+=" vrdisplaysupported"),this._webVRrequesting&&(this._btnVR.className+=" vrdisplayrequesting")))}enterVR(){if(this.xr)this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);else{if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){p.Y.Warn("Error in your custom logic onEnteringVR: "+e)}if(this._scene.activeCamera){if(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=m._f.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this.webVRCamera){const e=this.webVRCamera.deviceRotationQuaternion.toEulerAngles().y,t=m._f.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles().y-e,i=this.webVRCamera.rotationQuaternion.toEulerAngles().y;this.webVRCamera.rotationQuaternion=m._f.FromEulerAngles(0,i+t,0)}this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)}this._webVRrequesting||(this._webVRready?this._webVRpresenting||(this._scene.getEngine().onVRRequestPresentComplete.addOnce((e=>{this.onAfterEnteringVRObservable.notifyObservers({success:e})})),this._webVRCamera.position=this._position,this._scene.activeCamera=this._webVRCamera):this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce((()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})}))),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._displayLaserPointer&&[this._leftController,this._rightController].forEach((e=>{e&&e._activatePointer()})),this._hasEnteredVR=!0)}}exitVR(){if(this.xr)this.xr.baseExperience.exitXRAsync();else if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){p.Y.Warn("Error in your custom logic onExitingVR: "+e)}this._webVRpresenting&&this._scene.getEngine().disableVR(),this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1)),this._scene.getEngine().resize(),[this._leftController,this._rightController].forEach((e=>{e&&e._deactivatePointer()})),this._hasEnteredVR=!1;const e=this._scene.getEngine();e._onVrDisplayPresentChange&&e._onVrDisplayPresentChange()}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this._interactionsRequested=!0,this.xr)return void(this.xr.baseExperience.state===Nt.k.IN_XR&&this.xr.pointerSelection.attach());this._leftController&&this._enableInteractionOnController(this._leftController),this._rightController&&this._enableInteractionOnController(this._rightController),this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>!!(this._isTeleportationFloor(e)||-1===e.name.indexOf("gazeTracker")&&-1===e.name.indexOf("teleportationTarget")&&-1===e.name.indexOf("torusTeleportation"))&&this.raySelectionPredicate(e),this._interactionsEnabled=!0}}get _noControllerIsActive(){return!(this._leftController&&this._leftController._activePointer||this._rightController&&this._rightController._activePointer)}_isTeleportationFloor(e){for(let t=0;t<this._floorMeshesCollection.length;t++)if(this._floorMeshesCollection[t].id===e.id)return!0;return!(!this._floorMeshName||e.name!==this._floorMeshName)}addFloorMesh(e){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e))}removeFloorMesh(e){if(!this._floorMeshesCollection)return;const t=this._floorMeshesCollection.indexOf(e);-1!==t&&this._floorMeshesCollection.splice(t,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this._teleportationRequested=!0,this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){const t=e.floorMeshes||[];if(!t.length){const i=this._scene.getMeshByName(e.floorMeshName);i&&t.push(i)}if(this.xr)return t.forEach((e=>{this.xr.teleportation.addFloorMesh(e)})),void(this.xr.teleportation.attached||this.xr.teleportation.attach());if(!this.xrTestDone){const t=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(t),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};return void this._scene.registerBeforeRender(t)}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),void 0!==e.easingFunction&&(this._teleportationEasing=e.easingFunction),null!=this._leftController&&this._enableTeleportationOnController(this._leftController),null!=this._rightController&&this._enableTeleportationOnController(this._rightController);const t=new It.$;t.vignetteColor=new g.HE(0,0,0,0),t.vignetteEnabled=!0,this._postProcessMove=new Dt.z("postProcessMove",1,this._webVRCamera,void 0,void 0,void 0,void 0,t),this._webVRCamera.detachPostProcess(this._postProcessMove),this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&(this._createTeleportationCircles(),this._teleportationTarget.scaling.scaleInPlace(this._webVRCamera.deviceScaleFactor))}}_enableInteractionOnController(e){e.webVRController.mesh&&(e._interactionsEnabled=!0,this.isInVRMode&&this._displayLaserPointer&&e._activatePointer(),this.webVROptions.laserToggle&&e.webVRController.onMainButtonStateChangedObservable.add((t=>{this._displayLaserPointer&&1===t.value&&(e._activePointer?e._deactivatePointer():e._activatePointer(),this.displayGaze&&(e._gazeTracker.isVisible=e._activePointer))})),e.webVRController.onTriggerStateChangedObservable.add((t=>{let i=e;this._noControllerIsActive&&(i=this._cameraGazer),i._pointerDownOnMeshAsked?t.value<this._padSensibilityDown&&i._selectionPointerUp():t.value>this._padSensibilityUp&&i._selectionPointerDown()})))}_checkTeleportWithRay(e,t){this._teleportationRequestInitiated&&!t._teleportationRequestInitiated||(t._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),t._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&t._dpadPressed&&(t._activatePointer(),t._teleportationRequestInitiated=!0))}_checkRotate(e,t){t._teleportationRequestInitiated||(t._rotationLeftAsked?e.x>-this._padSensibilityDown&&(t._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&t._dpadPressed&&(t._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),t._rotationRightAsked?e.x<this._padSensibilityDown&&(t._rotationRightAsked=!1):e.x>this._padSensibilityUp&&t._dpadPressed&&(t._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,t){if(!t._teleportationRequestInitiated)if(e.y>this._padSensibilityUp&&t._dpadPressed){if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;let e=m._f.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),i=this.currentVRCamera.position;this.currentVRCamera.devicePosition&&this.currentVRCamera.deviceRotationQuaternion&&(e=this.currentVRCamera.deviceRotationQuaternion,i=this.currentVRCamera.devicePosition),e.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,m._f.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),m.P.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const s=new At.z(i,this._workingVector),r=this._scene.pickWithRay(s,this._raySelectionPredicate);r&&r.pickedPoint&&r.pickedMesh&&this._isTeleportationFloor(r.pickedMesh)&&r.distance<5&&this.teleportCamera(r.pickedPoint),t._teleportationBackRequestInitiated=!0}}else t._teleportationBackRequestInitiated=!1}_enableTeleportationOnController(e){e.webVRController.mesh&&(e._interactionsEnabled||this._enableInteractionOnController(e),e._interactionsEnabled=!0,e._teleportationEnabled=!0,e.webVRController.controllerType===St.wc.VIVE&&(e._dpadPressed=!1,e.webVRController.onPadStateChangedObservable.add((t=>{e._dpadPressed=t.pressed,e._dpadPressed||(e._rotationLeftAsked=!1,e._rotationRightAsked=!1,e._teleportationBackRequestInitiated=!1)}))),e.webVRController.onPadValuesChangedObservable.add((t=>{this.teleportationEnabled&&(this._checkTeleportBackwards(t,e),this._checkTeleportWithRay(t,e)),this._checkRotate(t,e)})))}_createTeleportationCircles(){this._teleportationTarget=(0,Vt.$6)("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const e=new wt.c("DynamicTexture",512,this._scene,!0);e.hasAlpha=!0;const t=e.getContext();t.beginPath(),t.arc(256,256,200,0,2*Math.PI,!1),t.fillStyle=this._teleportationFillColor,t.fill(),t.lineWidth=10,t.strokeStyle=this._teleportationBorderColor,t.stroke(),t.closePath(),e.update();const i=new Ot.K("TextPlaneMaterial",this._scene);i.diffuseTexture=e,this._teleportationTarget.material=i;const s=(0,Lt.eu)("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);s.isPickable=!1,s.parent=this._teleportationTarget;const r=new f.f("animationInnerCircle","position.y",30,f.f.ANIMATIONTYPE_FLOAT,f.f.ANIMATIONLOOPMODE_CYCLE),n=[];n.push({frame:0,value:0}),n.push({frame:30,value:.4}),n.push({frame:60,value:0}),r.setKeys(n);const o=new P.bi;o.setEasingMode(P.Kp.EASINGMODE_EASEINOUT),r.setEasingFunction(o),s.animations=[],s.animations.push(r),this._scene.beginAnimation(s,0,60,!0),this._hideTeleportationTarget()}_displayTeleportationTarget(){this._teleportActive=!0,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!0,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!0))}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof He.c))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const t=m._f.FromRotationMatrix(m.y3.RotationY(Math.PI/4*this._rotationAngle)),i=new f.f("animationRotation","rotationQuaternion",90,f.f.ANIMATIONTYPE_QUATERNION,f.f.ANIMATIONLOOPMODE_CONSTANT),s=[];s.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),s.push({frame:6,value:t}),i.setKeys(s),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];const r=new f.f("animationPP","vignetteWeight",90,f.f.ANIMATIONTYPE_FLOAT,f.f.ANIMATIONLOOPMODE_CONSTANT),n=[];n.push({frame:0,value:0}),n.push({frame:3,value:4}),n.push({frame:6,value:0}),r.setKeys(n),r.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(r);const o=new f.f("animationPP2","vignetteStretch",90,f.f.ANIMATIONTYPE_FLOAT,f.f.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:3,value:10}),a.push({frame:6,value:0}),o.setKeys(a),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,6,!1,1,(()=>{this._webVRCamera.detachPostProcess(this._postProcessMove)})),this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}_moveTeleportationSelectorTo(e,t,i){if(e.pickedPoint){t._teleportationRequestInitiated&&(this._displayTeleportationTarget(),this._haloCenter.copyFrom(e.pickedPoint),this._teleportationTarget.position.copyFrom(e.pickedPoint));const s=this._convertNormalToDirectionOfRay(e.getNormal(!0,!1),i);if(s){const e=m.P.Cross(ue.RD.Y,s),t=m.P.Cross(s,e);m.P.RotationFromAxisToRef(t,s,e,this._teleportationTarget.rotation)}this._teleportationTarget.position.y+=.1}}teleportCamera(e){if(!(this.currentVRCamera instanceof He.c))return;let t,i;if(this.webVRCamera.leftCamera?(this._workingVector.copyFrom(this.webVRCamera.leftCamera.globalPosition),this._workingVector.subtractInPlace(this.webVRCamera.position),e.subtractToRef(this._workingVector,this._workingVector)):this._workingVector.copyFrom(e),this.isInVRMode?this._workingVector.y+=this.webVRCamera.deviceDistanceToRoomGround()*this._webVRCamera.deviceScaleFactor:this._workingVector.y+=this._defaultHeight,this.onBeforeCameraTeleport.notifyObservers(this._workingVector),this._teleportationMode==Wt.TELEPORTATIONMODE_CONSTANTSPEED){i=90;const e=m.P.Distance(this.currentVRCamera.position,this._workingVector);t=this._teleportationSpeed/e}else i=Math.round(90*this._teleportationTime/1e3),t=1;this.currentVRCamera.animations=[];const s=new f.f("animationCameraTeleportation","position",90,f.f.ANIMATIONTYPE_VECTOR3,f.f.ANIMATIONLOOPMODE_CONSTANT),r=[{frame:0,value:this.currentVRCamera.position},{frame:i,value:this._workingVector}];s.setKeys(r),s.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(s),this._postProcessMove.animations=[];const n=Math.round(i/2),o=new f.f("animationPP","vignetteWeight",90,f.f.ANIMATIONTYPE_FLOAT,f.f.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:n,value:8}),a.push({frame:i,value:0}),o.setKeys(a),this._postProcessMove.animations.push(o);const h=new f.f("animationPP2","vignetteStretch",90,f.f.ANIMATIONTYPE_FLOAT,f.f.ANIMATIONLOOPMODE_CONSTANT),l=[];l.push({frame:0,value:0}),l.push({frame:n,value:10}),l.push({frame:i,value:0}),h.setKeys(l),this._postProcessMove.animations.push(h),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,i,!1,t,(()=>{this._webVRCamera.detachPostProcess(this._postProcessMove)})),this._scene.beginAnimation(this.currentVRCamera,0,i,!1,t,(()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)})),this._hideTeleportationTarget()}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(m.P.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_castRayAndSelectObject(e){if(!(this.currentVRCamera instanceof He.c))return;const t=e._getForwardRay(this._rayLength),i=this._scene.pickWithRay(t,this._raySelectionPredicate);if(i&&this._scene.simulatePointerMove(i,{pointerId:e._id}),e._currentHit=i,i&&i.pickedPoint){if(this._displayGaze){let s=1;e._gazeTracker.isVisible=!0,e._isActionableMesh&&(s=3),this.updateGazeTrackerScale&&(e._gazeTracker.scaling.x=i.distance*s,e._gazeTracker.scaling.y=i.distance*s,e._gazeTracker.scaling.z=i.distance*s);const r=this._convertNormalToDirectionOfRay(i.getNormal(),t),n=.002;if(r){const t=m.P.Cross(ue.RD.Y,r),i=m.P.Cross(r,t);m.P.RotationFromAxisToRef(i,r,t,e._gazeTracker.rotation)}e._gazeTracker.position.copyFrom(i.pickedPoint),e._gazeTracker.position.x<0?e._gazeTracker.position.x+=n:e._gazeTracker.position.x-=n,e._gazeTracker.position.y<0?e._gazeTracker.position.y+=n:e._gazeTracker.position.y-=n,e._gazeTracker.position.z<0?e._gazeTracker.position.z+=n:e._gazeTracker.position.z-=n}e._updatePointerDistance(i.distance)}else e._updatePointerDistance(),e._gazeTracker.isVisible=!1;if(i&&i.pickedMesh){if(this._teleportationInitialized&&this._isTeleportationFloor(i.pickedMesh)&&i.pickedPoint)return e._currentMeshSelected&&!this._isTeleportationFloor(e._currentMeshSelected)&&this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,void(e._teleportationRequestInitiated&&this._moveTeleportationSelectorTo(i,e,t));if(i.pickedMesh!==e._currentMeshSelected)if(this.meshSelectionPredicate(i.pickedMesh)){this.onNewMeshPicked.notifyObservers(i),e._currentMeshSelected=i.pickedMesh,i.pickedMesh.isPickable&&i.pickedMesh.actionManager?(this.changeGazeColor(this._pickedGazeColor),this.changeLaserColor(this._pickedLaserColor),e._isActionableMesh=!0):(this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor),e._isActionableMesh=!1);try{this.onNewMeshSelected.notifyObservers(i.pickedMesh);const t=e;t.webVRController&&this.onMeshSelectedWithController.notifyObservers({mesh:i.pickedMesh,controller:t.webVRController})}catch(e){p.Y.Warn("Error while raising onNewMeshSelected or onMeshSelectedWithController: "+e)}}else this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}else this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}_notifySelectedMeshUnselected(e){e&&this.onSelectedMeshUnselected.notifyObservers(e)}setLaserColor(e,t=this._pickedLaserColor){this._laserColor=e,this._pickedLaserColor=t}setLaserLightingState(e=!0){this._leftController&&this._leftController._setLaserPointerLightingDisabled(!e),this._rightController&&this._rightController._setLaserPointerLightingDisabled(!e)}setGazeColor(e,t=this._pickedGazeColor){this._gazeColor=e,this._pickedGazeColor=t}changeLaserColor(e){this.updateControllerLaserColor&&(this._leftController&&this._leftController._setLaserPointerColor(e),this._rightController&&this._rightController._setLaserPointerColor(e))}changeGazeColor(e){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=e,this._leftController&&(this._leftController._gazeTracker.material.emissiveColor=e),this._rightController&&(this._rightController._gazeTracker.material.emissiveColor=e))}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._webVRCamera&&this._webVRCamera.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._leftController&&this._leftController.dispose(),this._rightController&&this._rightController.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.getEngine().onVRDisplayChangedObservable.removeCallback(this._onVRDisplayChangedBind),this._scene.getEngine().onVRRequestPresentStart.removeCallback(this._onVRRequestPresentStart),this._scene.getEngine().onVRRequestPresentComplete.removeCallback(this._onVRRequestPresentComplete),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.removeCallback(this._onNewGamepadDisconnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}Wt.TELEPORTATIONMODE_CONSTANTTIME=0,Wt.TELEPORTATIONMODE_CONSTANTSPEED=1;var Ht=i(26991),jt=i(62379);class $t{constructor(){this._scaledPosition=m.P.Zero(),this._scaledVelocity=m.P.Zero(),this._finalPosition=m.P.Zero()}getNewPosition(e,t,i,s,r,n,o){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,s,this._finalPosition,r),this._finalPosition.multiplyInPlace(i._radius),n(o,this._finalPosition,i.collidedMesh)}createCollider(){return new jt.Y}init(e){this._scene=e}_collideWithWorld(e,t,i,s,r,n=null){const o=10*O.D.CollisionsEpsilon;if(i._retry>=s)return void r.copyFrom(e);const a=n?n.collisionMask:i.collisionMask;i._initialize(e,t,o);const h=n&&n.surroundingMeshes||this._scene.meshes;for(let e=0;e<h.length;e++){const t=h[e];t.isEnabled()&&t.checkCollisions&&t.subMeshes&&t!==n&&0!=(a&t.collisionGroup)&&t._checkCollision(i)}i.collisionFound?(0===t.x&&0===t.y&&0===t.z||i._getResponse(e,t),t.length()<=o?r.copyFrom(e):(i._retry++,this._collideWithWorld(e,t,i,s,r,n))):e.addToRef(t,r)}}z.x.CollisionCoordinatorFactory=()=>new $t;var Yt=i(43743),Xt=i(46825),Qt=i(91348),qt=i(4220),Kt=i(19190),Zt=i(19989),Jt=i(9251),ei=i(10443),ti=i(9048),ii=i(92912),si=i(87257);z.x.prototype.createOrUpdateSelectionOctree=function(e=64,t=2){let i=this._getComponent(k.l.NAME_OCTREE);i||(i=new ri(this),this._addComponent(i)),this._selectionOctree||(this._selectionOctree=new ti.V(ti.V.CreationFuncForMeshes,e,t));const s=this.getWorldExtends();return this._selectionOctree.update(s.min,s.max,this.meshes),this._selectionOctree},Object.defineProperty(z.x.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),si.x.prototype.createOrUpdateSubmeshesOctree=function(e=64,t=2){const i=this.getScene();let s=i._getComponent(k.l.NAME_OCTREE);s||(s=new ri(i),i._addComponent(s)),this._submeshesOctree||(this._submeshesOctree=new ti.V(ti.V.CreationFuncForSubMeshes,e,t)),this.computeWorldMatrix(!0);const r=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(r.minimumWorld,r.maximumWorld,this.subMeshes),this._submeshesOctree};class ri{constructor(e){this.name=k.l.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new At.z(m.P.Zero(),new m.P(1,1,1)),(e=e||D.l.LastCreatedScene)&&(this.scene=e,this.scene.getActiveMeshCandidates=this.getActiveMeshCandidates.bind(this),this.scene.getActiveSubMeshCandidates=this.getActiveSubMeshCandidates.bind(this),this.scene.getCollidingSubMeshCandidates=this.getCollidingSubMeshCandidates.bind(this),this.scene.getIntersectingSubMeshCandidates=this.getIntersectingSubMeshCandidates.bind(this))}register(){this.scene.onMeshRemovedObservable.add((e=>{const t=this.scene.selectionOctree;if(null!=t){const i=t.dynamicContent.indexOf(e);-1!==i&&t.dynamicContent.splice(i,1)}})),this.scene.onMeshImportedObservable.add((e=>{const t=this.scene.selectionOctree;null!=t&&t.addMesh(e)}))}getActiveMeshCandidates(){var e;return(null===(e=this.scene._selectionOctree)||void 0===e?void 0:e.select(this.scene.frustumPlanes))||this.scene._getDefaultMeshCandidates()}getActiveSubMeshCandidates(e){return e._submeshesOctree&&e.useOctreeForRenderingSelection?e._submeshesOctree.select(this.scene.frustumPlanes):this.scene._getDefaultSubMeshCandidates(e)}getIntersectingSubMeshCandidates(e,t){return e._submeshesOctree&&e.useOctreeForPicking?(At.z.TransformToRef(t,e.getWorldMatrix(),this._tempRay),e._submeshesOctree.intersectsRay(this._tempRay)):this.scene._getDefaultSubMeshCandidates(e)}getCollidingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){const i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z);return e._submeshesOctree.intersects(t._basePointWorld,i)}return this.scene._getDefaultSubMeshCandidates(e)}rebuild(){}dispose(){}}var ni=i(48147),oi=i(52753);class ai extends ni.tb{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}static _CreateArrow(e,t,i=1,s=!1){const r=new dt.Y("arrow",e),n=(0,Ft.wf)("cylinder",{diameterTop:0,height:.075,diameterBottom:.0375*(1+(i-1)/4),tessellation:96},e),o=(0,Ft.wf)("cylinder",{diameterTop:.005*i,height:.275,diameterBottom:.005*i,tessellation:96},e);return n.parent=r,n.material=t,n.rotation.x=Math.PI/2,n.position.z+=.3,o.parent=r,o.material=t,o.position.z+=.1375,o.rotation.x=Math.PI/2,s&&(o.visibility=0,n.visibility=0),r}static _CreateArrowInstance(e,t){const i=new dt.Y("arrow",e);for(const e of t.getChildMeshes())e.createInstance(e.name).parent=i;return i}constructor(e,t=g.Wo.Gray(),i=oi.x.DefaultUtilityLayer,s=null,r=1){var n;super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new _.y$,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._parent=s,this._coloredMaterial=new Ot.K("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new g.Wo(.1,.1,.1)),this._hoverMaterial=new Ot.K("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=g.Wo.Yellow(),this._disableMaterial=new Ot.K("",i.utilityLayerScene),this._disableMaterial.diffuseColor=g.Wo.Gray(),this._disableMaterial.alpha=.4;const o=ai._CreateArrow(i.utilityLayerScene,this._coloredMaterial,r),a=ai._CreateArrow(i.utilityLayerScene,this._coloredMaterial,r+4,!0);this._gizmoMesh=new Mt.Kj("",i.utilityLayerScene),this._gizmoMesh.addChild(o),this._gizmoMesh.addChild(a),this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let h=0;const l={snapDistance:0};this.dragBehavior=new se.M({dragAxis:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add((e=>{if(this.attachedNode){this._handlePivot();let t=!1;if(0==this.snapDistance)this.attachedNode.getWorldMatrix().getTranslationToRef(m.jp.Vector3[2]),m.jp.Vector3[2].addInPlace(e.delta),this.dragBehavior.validateDrag(m.jp.Vector3[2])&&(this.attachedNode.position&&this.attachedNode.position.addInPlaceFromFloats(e.delta.x,e.delta.y,e.delta.z),this.attachedNode.getWorldMatrix().addTranslationFromFloats(e.delta.x,e.delta.y,e.delta.z),this.attachedNode.updateCache(),t=!0);else if(h+=e.dragDistance,Math.abs(h)>this.snapDistance){const i=Math.floor(Math.abs(h)/this.snapDistance);h%=this.snapDistance,e.delta.normalizeToRef(m.jp.Vector3[1]),m.jp.Vector3[1].scaleInPlace(this.snapDistance*i),this.attachedNode.getWorldMatrix().getTranslationToRef(m.jp.Vector3[2]),m.jp.Vector3[2].addInPlace(m.jp.Vector3[1]),this.dragBehavior.validateDrag(m.jp.Vector3[2])&&(this.attachedNode.getWorldMatrix().addTranslationFromFloats(m.jp.Vector3[1].x,m.jp.Vector3[1].y,m.jp.Vector3[1].z),this.attachedNode.updateCache(),l.snapDistance=this.snapDistance*i,this.onSnapObservable.notifyObservers(l),t=!0)}t&&this._matrixChanged()}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1}));const c=i._getSharedGizmoLight();c.includedOnlyMeshes=c.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const u={gizmoMeshes:o.getChildMeshes(),colliderMeshes:a.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};null===(n=this._parent)||void 0===n||n.addToAxisCache(a,u),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{var t;if(!this._customMeshSet&&(this._isHovered=!(-1==u.colliderMeshes.indexOf(null===(t=null==e?void 0:e.pickInfo)||void 0===t?void 0:t.pickedMesh)),!this._parent)){const e=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(u.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(u.gizmoMeshes,e?u.material:u.disableMaterial)}))}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}}class hi{get xAxis(){return this._xAxis}get yAxis(){return this._yAxis}get zAxis(){return this._zAxis}constructor(e,t=1,i=2,s,r,n,o=1){if(this._scaleLinesFactor=4,this._instanced=!1,this.scene=null,this.scaleLines=1,e=e||D.l.LastCreatedScene){if(this.scaleLines=t,!s){const t=new Ot.K("xAxisMaterial",e);t.disableLighting=!0,t.emissiveColor=g.Wo.Red().scale(.5),s=ai._CreateArrow(e,t,o)}if(!r){const t=new Ot.K("yAxisMaterial",e);t.disableLighting=!0,t.emissiveColor=g.Wo.Green().scale(.5),r=ai._CreateArrow(e,t,o)}if(!n){const t=new Ot.K("zAxisMaterial",e);t.disableLighting=!0,t.emissiveColor=g.Wo.Blue().scale(.5),n=ai._CreateArrow(e,t,o)}this._xAxis=s,this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis=r,this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis=n,this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),null!=i&&(hi._SetRenderingGroupId(this._xAxis,i),hi._SetRenderingGroupId(this._yAxis,i),hi._SetRenderingGroupId(this._zAxis,i)),this.scene=e,this.update(new m.P,m.P.Right(),m.P.Up(),m.P.Forward())}}update(e,t,i,s){this._xAxis.position.copyFrom(e),this._xAxis.setDirection(t),this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis.position.copyFrom(e),this._yAxis.setDirection(i),this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis.position.copyFrom(e),this._zAxis.setDirection(s),this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor)}createInstance(){const e=ai._CreateArrowInstance(this.scene,this._xAxis),t=ai._CreateArrowInstance(this.scene,this._yAxis),i=ai._CreateArrowInstance(this.scene,this._zAxis),s=new hi(this.scene,this.scaleLines,null,e,t,i);return s._instanced=!0,s}dispose(){this._xAxis&&this._xAxis.dispose(!1,!this._instanced),this._yAxis&&this._yAxis.dispose(!1,!this._instanced),this._zAxis&&this._zAxis.dispose(!1,!this._instanced),this.scene=null}static _SetRenderingGroupId(e,t){e.getChildMeshes().forEach((e=>{e.renderingGroupId=t}))}}class li extends hi{constructor(e,t,i,s=1){super(e,s),this.pos=m.P.Zero(),this.xaxis=m.P.Zero(),this.yaxis=m.P.Zero(),this.zaxis=m.P.Zero(),this.mesh=i,this.bone=t}update(){if(!this.mesh||!this.bone)return;const e=this.bone;e.getAbsolutePositionToRef(this.mesh,this.pos),e.getDirectionToRef(ue.RD.X,this.mesh,this.xaxis),e.getDirectionToRef(ue.RD.Y,this.mesh,this.yaxis),e.getDirectionToRef(ue.RD.Z,this.mesh,this.zaxis),super.update(this.pos,this.xaxis,this.yaxis,this.zaxis)}dispose(){this.mesh&&(this.mesh=null,this.bone=null,super.dispose())}}var ci=i(31568),ui=i(48110),di=i(16765),pi=i(83262),_i=i(77966),gi=i(74517),mi=i(16721);class fi{constructor(e){if(this._impostors=[],this._meshes=[],this._bodies=[],this._inertiaBodies=[],this._bodyMeshes=[],this._inertiaMeshes=[],this._numMeshes=0,this._numBodies=0,this._numInertiaBodies=0,this._debugMeshMeshes=new Array,this._scene=e||D.l.LastCreatedScene,!this._scene)return;const t=this._scene.getPhysicsEngine();t&&(this._physicsEnginePlugin=t.getPhysicsPlugin()),this._utilityLayer=new oi.x(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0}_updateDebugMeshes(){const e=this._physicsEnginePlugin;1===(null==e?void 0:e.getPluginVersion())?this._updateDebugMeshesV1():this._updateDebugMeshesV2()}_updateDebugMeshesV1(){const e=this._physicsEnginePlugin;for(let t=0;t<this._numMeshes;t++){const i=this._impostors[t];if(i)if(i.isDisposed)this.hideImpostor(this._impostors[t--]);else{if(i.type===pi.Q.MeshImpostor)continue;const s=this._meshes[t];s&&e&&e.syncMeshWithImpostor(s,i)}}}_updateDebugMeshesV2(){const e=this._physicsEnginePlugin;for(let t=0;t<this._numBodies;t++){const i=this._bodies[t],s=this._bodyMeshes[t];i&&s&&e.syncTransform(i,s)}}_updateInertiaMeshes(){for(let e=0;e<this._numInertiaBodies;e++){const t=this._inertiaBodies[e],i=this._inertiaMeshes[e];t&&i&&this._updateDebugInertia(t,i)}}_updateDebugInertia(e,t){var i;const s=m.y3.Identity(),r=m.y3.Identity(),n=m.y3.Identity();if(e._pluginDataInstances.length){const i=t,o=i._thinInstanceDataStorage.matrixData,a=e.transformNode._thinInstanceDataStorage.matrixData;for(let t=0;t<e._pluginDataInstances.length;t++){const i=e.getMassProperties(t);this._getMeshDebugInertiaMatrixToRef(i,s),m.y3.FromArrayToRef(a,16*t,r),s.multiplyToRef(r,n),n.copyToArray(o,16*t)}i.thinInstanceBufferUpdated("matrix")}else{const n=e.getMassProperties();if(this._getMeshDebugInertiaMatrixToRef(n,s),null===(i=e.transformNode.rotationQuaternion)||void 0===i||i.toRotationMatrix(r),r.setTranslation(e.transformNode.position),e.transformNode.parent){const t=e.transformNode.parent.computeWorldMatrix(!0);r.multiplyToRef(t,r)}s.multiplyToRef(r,s),s.decomposeToTransformNode(t)}}showImpostor(e,t){if(!this._scene)return null;for(let t=0;t<this._numMeshes;t++)if(this._impostors[t]==e)return null;const i=this._getDebugMesh(e,t);return i&&(this._impostors[this._numMeshes]=e,this._meshes[this._numMeshes]=i,0===this._numMeshes&&(this._renderFunction=this._updateDebugMeshes.bind(this),this._scene.registerBeforeRender(this._renderFunction)),this._numMeshes++),i}showBody(e){if(!this._scene)return null;for(let t=0;t<this._numBodies;t++)if(this._bodies[t]==e)return null;const t=this._getDebugBodyMesh(e);return t&&(this._bodies[this._numBodies]=e,this._bodyMeshes[this._numBodies]=t,0===this._numBodies&&(this._renderFunction=this._updateDebugMeshes.bind(this),this._scene.registerBeforeRender(this._renderFunction)),this._numBodies++),t}showInertia(e){if(!this._scene)return null;for(let t=0;t<this._numInertiaBodies;t++)if(this._inertiaBodies[t]==e)return null;const t=this._getDebugInertiaMesh(e);return t&&(this._inertiaBodies[this._numInertiaBodies]=e,this._inertiaMeshes[this._numInertiaBodies]=t,0===this._numInertiaBodies&&(this._inertiaRenderFunction=this._updateInertiaMeshes.bind(this),this._scene.registerBeforeRender(this._inertiaRenderFunction)),this._numInertiaBodies++),t}hideImpostor(e){if(!e||!this._scene||!this._utilityLayer)return;let t=!1;const i=this._utilityLayer.utilityLayerScene;for(let s=0;s<this._numMeshes;s++)if(this._impostors[s]==e){const e=this._meshes[s];if(!e)continue;i.removeMesh(e),e.dispose();const r=this._debugMeshMeshes.indexOf(e);r>-1&&this._debugMeshMeshes.splice(r,1),this._numMeshes--,this._numMeshes>0?(this._meshes[s]=this._meshes[this._numMeshes],this._impostors[s]=this._impostors[this._numMeshes],this._meshes[this._numMeshes]=null,this._impostors[this._numMeshes]=null):(this._meshes[0]=null,this._impostors[0]=null),t=!0;break}t&&0===this._numMeshes&&this._scene.unregisterBeforeRender(this._renderFunction)}hideBody(e){if(!e||!this._scene||!this._utilityLayer)return;let t=!1;const i=this._utilityLayer.utilityLayerScene;for(let s=0;s<this._numBodies;s++)if(this._bodies[s]===e){const e=this._bodyMeshes[s];if(!e)continue;i.removeMesh(e),e.dispose(),this._numBodies--,this._numBodies>0?(this._bodyMeshes[s]=this._bodyMeshes[this._numBodies],this._bodies[s]=this._bodies[this._numBodies],this._bodyMeshes[this._numBodies]=null,this._bodies[this._numBodies]=null):(this._bodyMeshes[0]=null,this._bodies[0]=null),t=!0;break}t&&0===this._numBodies&&this._scene.unregisterBeforeRender(this._renderFunction)}hideInertia(e){if(!e||!this._scene||!this._utilityLayer)return;let t=!1;const i=this._utilityLayer.utilityLayerScene;for(let s=0;s<this._numInertiaBodies;s++)if(this._inertiaBodies[s]===e){const e=this._inertiaMeshes[s];if(!e)continue;i.removeMesh(e),e.dispose(),this._inertiaBodies.splice(s,1),this._inertiaMeshes.splice(s,1),this._numInertiaBodies--,t=!0;break}t&&0===this._numInertiaBodies&&this._scene.unregisterBeforeRender(this._inertiaRenderFunction)}_getDebugMaterial(e){return this._debugMaterial||(this._debugMaterial=new Ot.K("",e),this._debugMaterial.wireframe=!0,this._debugMaterial.emissiveColor=g.Wo.White(),this._debugMaterial.disableLighting=!0),this._debugMaterial}_getDebugInertiaMaterial(e){return this._debugInertiaMaterial||(this._debugInertiaMaterial=new Ot.K("",e),this._debugInertiaMaterial.disableLighting=!0,this._debugInertiaMaterial.alpha=0),this._debugInertiaMaterial}_getDebugBoxMesh(e){return this._debugBoxMesh||(this._debugBoxMesh=(0,ui.NR)("physicsBodyBoxViewMesh",{size:1},e),this._debugBoxMesh.rotationQuaternion=m._f.Identity(),this._debugBoxMesh.material=this._getDebugMaterial(e),this._debugBoxMesh.setEnabled(!1)),this._debugBoxMesh.createInstance("physicsBodyBoxViewInstance")}_getDebugSphereMesh(e){return this._debugSphereMesh||(this._debugSphereMesh=(0,di.Qk)("physicsBodySphereViewMesh",{diameter:1},e),this._debugSphereMesh.rotationQuaternion=m._f.Identity(),this._debugSphereMesh.material=this._getDebugMaterial(e),this._debugSphereMesh.setEnabled(!1)),this._debugSphereMesh.createInstance("physicsBodySphereViewInstance")}_getDebugCapsuleMesh(e){return this._debugCapsuleMesh||(this._debugCapsuleMesh=(0,_i.iz)("physicsBodyCapsuleViewMesh",{height:1},e),this._debugCapsuleMesh.rotationQuaternion=m._f.Identity(),this._debugCapsuleMesh.material=this._getDebugMaterial(e),this._debugCapsuleMesh.setEnabled(!1)),this._debugCapsuleMesh.createInstance("physicsBodyCapsuleViewInstance")}_getDebugCylinderMesh(e){return this._debugCylinderMesh||(this._debugCylinderMesh=(0,Ft.wf)("physicsBodyCylinderViewMesh",{diameterTop:1,diameterBottom:1,height:1},e),this._debugCylinderMesh.rotationQuaternion=m._f.Identity(),this._debugCylinderMesh.material=this._getDebugMaterial(e),this._debugCylinderMesh.setEnabled(!1)),this._debugCylinderMesh.createInstance("physicsBodyCylinderViewInstance")}_getDebugMeshMesh(e,t){const i=new Mt.Kj(e.name,t,null,e);return i.setParent(e),i.position=m.P.Zero(),i.material=this._getDebugMaterial(t),this._debugMeshMeshes.push(i),i}_getDebugMesh(e,t){if(!this._utilityLayer)return null;if(t&&t.parent&&t.parent.physicsImpostor)return null;let i=null;const s=this._utilityLayer.utilityLayerScene;if(!e.physicsBody)return p.Y.Warn("Unable to get physicsBody of impostor. It might be initialized later by its parent's impostor."),null;switch(e.type){case pi.Q.BoxImpostor:i=this._getDebugBoxMesh(s),e.getBoxSizeToRef(i.scaling);break;case pi.Q.SphereImpostor:{i=this._getDebugSphereMesh(s);const t=e.getRadius();i.scaling.x=2*t,i.scaling.y=2*t,i.scaling.z=2*t;break}case pi.Q.CapsuleImpostor:{i=this._getDebugCapsuleMesh(s);const t=e.object.getBoundingInfo();i.scaling.x=2*(t.boundingBox.maximum.x-t.boundingBox.minimum.x)*e.object.scaling.x,i.scaling.y=(t.boundingBox.maximum.y-t.boundingBox.minimum.y)*e.object.scaling.y,i.scaling.z=2*(t.boundingBox.maximum.z-t.boundingBox.minimum.z)*e.object.scaling.z;break}case pi.Q.MeshImpostor:t&&(i=this._getDebugMeshMesh(t,s));break;case pi.Q.NoImpostor:t?t.getChildMeshes().filter((e=>e.physicsImpostor?1:0)).forEach((e=>{if(e.physicsImpostor&&"Mesh"===e.getClassName()){const t=e.getBoundingInfo(),r=t.boundingBox.minimum,n=t.boundingBox.maximum;switch(e.physicsImpostor.type){case pi.Q.BoxImpostor:i=this._getDebugBoxMesh(s),i.position.copyFrom(r),i.position.addInPlace(n),i.position.scaleInPlace(.5);break;case pi.Q.SphereImpostor:i=this._getDebugSphereMesh(s);break;case pi.Q.CylinderImpostor:i=this._getDebugCylinderMesh(s);break;default:i=null}i&&(i.scaling.x=n.x-r.x,i.scaling.y=n.y-r.y,i.scaling.z=n.z-r.z,i.parent=e)}})):p.Y.Warn("No target mesh parameter provided for NoImpostor. Skipping."),i=null;break;case pi.Q.CylinderImpostor:{i=this._getDebugCylinderMesh(s);const t=e.object.getBoundingInfo();i.scaling.x=(t.boundingBox.maximum.x-t.boundingBox.minimum.x)*e.object.scaling.x,i.scaling.y=(t.boundingBox.maximum.y-t.boundingBox.minimum.y)*e.object.scaling.y,i.scaling.z=(t.boundingBox.maximum.z-t.boundingBox.minimum.z)*e.object.scaling.z;break}}return i}_getDebugBodyMesh(e){if(!this._utilityLayer)return null;const t=this._utilityLayer.utilityLayerScene,i=new Mt.Kj("custom",t),s=new gi.x,r=e.getGeometry();if(s.positions=r.positions,s.indices=r.indices,s.applyToMesh(i),e._pluginDataInstances){const t=new Float32Array(16*e._pluginDataInstances.length);i.thinInstanceSetBuffer("matrix",t,16)}return i.material=this._getDebugMaterial(t),i}_getMeshDebugInertiaMatrixToRef(e,t){var i,s,r;const n=null!==(i=e.inertiaOrientation)&&void 0!==i?i:m._f.Identity(),o=null!==(s=e.inertia)&&void 0!==s?s:m.P.Zero(),a=null!==(r=e.centerOfMass)&&void 0!==r?r:m.P.Zero(),h=6*(o.x-o.y+o.z),l=Math.sqrt(Math.max(h,0)),c=12*o.x-h,u=Math.sqrt(Math.max(c,0)),d=12*o.z-h,p=Math.sqrt(Math.max(d,0)),_=m.jp.Vector3[0];_.set(p,l,u);const g=m.y3.ScalingToRef(_.x,_.y,_.z,m.jp.Matrix[0]),f=n.toRotationMatrix(m.jp.Matrix[1]),b=m.y3.TranslationToRef(a.x,a.y,a.z,m.jp.Matrix[2]);return g.multiplyToRef(f,t),t.multiplyToRef(b,t),t}_getDebugInertiaMesh(e){if(!this._utilityLayer)return null;const t=this._utilityLayer.utilityLayerScene,i=mi.V.CreateBox("custom",{size:1},t),s=m.y3.Identity();if(e._pluginDataInstances.length){const t=new Float32Array(16*e._pluginDataInstances.length);for(let i=0;i<e._pluginDataInstances.length;++i){const r=e.getMassProperties(i);this._getMeshDebugInertiaMatrixToRef(r,s),s.copyToArray(t,16*i)}i.thinInstanceSetBuffer("matrix",t,16)}else{const t=e.getMassProperties();this._getMeshDebugInertiaMatrixToRef(t,s),s.decomposeToTransformNode(i)}return i.enableEdgesRendering(),i.edgesWidth=2,i.edgesColor=new g.HE(1,0,1,1),i.material=this._getDebugInertiaMaterial(t),i}dispose(){for(let e=this._numMeshes-1;e>=0;e--)this.hideImpostor(this._impostors[0]);for(let e=this._numBodies-1;e>=0;e--)this.hideBody(this._bodies[0]);for(let e=this._numInertiaBodies-1;e>=0;e--)this.hideInertia(this._inertiaBodies[0]);this._debugBoxMesh&&this._debugBoxMesh.dispose(),this._debugSphereMesh&&this._debugSphereMesh.dispose(),this._debugCylinderMesh&&this._debugCylinderMesh.dispose(),this._debugMaterial&&this._debugMaterial.dispose(),this._impostors.length=0,this._scene=null,this._physicsEnginePlugin=null,this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null)}}var bi=i(71528);class vi{static CreateAndShow(e,t,i){const s=new vi(e);return s.show(t,i),s}constructor(e){this.ray=e}show(e,t){if(!this._renderFunction&&this.ray){const t=this.ray;this._renderFunction=this._render.bind(this),this._scene=e,this._renderPoints=[t.origin,t.origin.add(t.direction.scale(t.length))],this._renderLine=(0,bi.nL)("ray",{points:this._renderPoints,updatable:!0},e),this._renderLine.isPickable=!1,this._renderFunction&&this._scene.registerBeforeRender(this._renderFunction)}t&&this._renderLine&&this._renderLine.color.copyFrom(t)}hide(){this._renderFunction&&this._scene&&(this._scene.unregisterBeforeRender(this._renderFunction),this._scene=null,this._renderFunction=null,this._renderLine&&(this._renderLine.dispose(),this._renderLine=null),this._renderPoints=[])}_render(){var e;const t=this.ray;if(!t)return;const i=this._renderPoints[1],s=Math.min(t.length,1e6);i.copyFrom(t.direction),i.scaleInPlace(s),i.addInPlace(t.origin),this._renderPoints[0].copyFrom(t.origin),(0,bi.nL)("ray",{points:this._renderPoints,updatable:!0,instance:this._renderLine},this._scene),null===(e=this._renderLine)||void 0===e||e.refreshBoundingInfo()}attachToMesh(e,t,i,s){this._attachedToMesh=e;const r=this.ray;r&&(r.direction||(r.direction=m.P.Zero()),r.origin||(r.origin=m.P.Zero()),s&&(r.length=s),i||(i=m.P.Zero()),t||(t=new m.P(0,0,-1)),this._scene||(this._scene=e.getScene()),this._meshSpaceDirection?(this._meshSpaceDirection.copyFrom(t),this._meshSpaceOrigin.copyFrom(i)):(this._meshSpaceDirection=t.clone(),this._meshSpaceOrigin=i.clone()),this._onAfterRenderObserver||(this._onAfterRenderObserver=this._scene.onBeforeRenderObservable.add((()=>this._updateToMesh())),this._onAfterStepObserver=this._scene.onAfterStepObservable.add((()=>this._updateToMesh()))),this._attachedToMesh.computeWorldMatrix(!0),this._updateToMesh())}detachFromMesh(){this._attachedToMesh&&this._scene&&(this._onAfterRenderObserver&&(this._scene.onBeforeRenderObservable.remove(this._onAfterRenderObserver),this._scene.onAfterStepObservable.remove(this._onAfterStepObserver)),this._attachedToMesh=null,this._onAfterRenderObserver=null,this._onAfterStepObserver=null,this._scene=null)}_updateToMesh(){const e=this.ray;this._attachedToMesh&&e&&(this._attachedToMesh.isDisposed()?this.detachFromMesh():(this._attachedToMesh.getDirectionToRef(this._meshSpaceDirection,e.direction),m.P.TransformCoordinatesToRef(this._meshSpaceOrigin,this._attachedToMesh.getWorldMatrix(),e.origin)))}dispose(){this.hide(),this.detachFromMesh(),this.ray=null}}var yi=i(79061),xi=i(63778),Pi=i(73212),Ci=i(69590);class Ti{static CreateBoneWeightShader(e,t){var i,s,r,n,o,a;const h=e.skeleton,l=null!==(i=e.colorBase)&&void 0!==i?i:g.Wo.Black(),c=null!==(s=e.colorZero)&&void 0!==s?s:g.Wo.Blue(),u=null!==(r=e.colorQuarter)&&void 0!==r?r:g.Wo.Green(),d=null!==(n=e.colorHalf)&&void 0!==n?n:g.Wo.Yellow(),p=null!==(o=e.colorFull)&&void 0!==o?o:g.Wo.Red(),_=null!==(a=e.targetBoneIndex)&&void 0!==a?a:0;Pi.Q.ShadersStore["boneWeights:"+h.name+"VertexShader"]="precision highp float;\n\n        attribute vec3 position;\n        attribute vec2 uv;\n\n        uniform mat4 view;\n        uniform mat4 projection;\n        uniform mat4 worldViewProjection;\n\n        #include<bonesDeclaration>\n        #if NUM_BONE_INFLUENCERS == 0\n            attribute vec4 matricesIndices;\n            attribute vec4 matricesWeights;\n        #endif\n        #include<bakedVertexAnimationDeclaration>\n\n        #include<instancesDeclaration>\n\n        varying vec3 vColor;\n\n        uniform vec3 colorBase;\n        uniform vec3 colorZero;\n        uniform vec3 colorQuarter;\n        uniform vec3 colorHalf;\n        uniform vec3 colorFull;\n\n        uniform float targetBoneIndex;\n\n        void main() {\n            vec3 positionUpdated = position;\n\n            #include<instancesVertex>\n            #include<bonesVertex>\n            #include<bakedVertexAnimation>\n\n            vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n            vec3 color = colorBase;\n            float totalWeight = 0.;\n            if(matricesIndices[0] == targetBoneIndex && matricesWeights[0] > 0.){\n                totalWeight += matricesWeights[0];\n            }\n            if(matricesIndices[1] == targetBoneIndex && matricesWeights[1] > 0.){\n                totalWeight += matricesWeights[1];\n            }\n            if(matricesIndices[2] == targetBoneIndex && matricesWeights[2] > 0.){\n                totalWeight += matricesWeights[2];\n            }\n            if(matricesIndices[3] == targetBoneIndex && matricesWeights[3] > 0.){\n                totalWeight += matricesWeights[3];\n            }\n\n            color = mix(color, colorZero, smoothstep(0., 0.25, totalWeight));\n            color = mix(color, colorQuarter, smoothstep(0.25, 0.5, totalWeight));\n            color = mix(color, colorHalf, smoothstep(0.5, 0.75, totalWeight));\n            color = mix(color, colorFull, smoothstep(0.75, 1.0, totalWeight));\n            vColor = color;\n\n        gl_Position = projection * view * worldPos;\n        }",Pi.Q.ShadersStore["boneWeights:"+h.name+"FragmentShader"]="\n            precision highp float;\n            varying vec3 vPosition;\n\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4(vColor, 1.0);\n                gl_FragColor = color;\n            }\n        ";const m=new xi.j("boneWeight:"+h.name,t,{vertex:"boneWeights:"+h.name,fragment:"boneWeights:"+h.name},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorBase","colorZero","colorQuarter","colorHalf","colorFull","targetBoneIndex"]});return m.setColor3("colorBase",l),m.setColor3("colorZero",c),m.setColor3("colorQuarter",u),m.setColor3("colorHalf",d),m.setColor3("colorFull",p),m.setFloat("targetBoneIndex",_),m.getClassName=()=>"BoneWeightShader",m.transparencyMode=yi.F.MATERIAL_OPAQUE,m}static CreateSkeletonMapShader(e,t){var i;const s=e.skeleton,r=null!==(i=e.colorMap)&&void 0!==i?i:[{color:new g.Wo(1,.38,.18),location:0},{color:new g.Wo(.59,.18,1),location:.2},{color:new g.Wo(.59,1,.18),location:.4},{color:new g.Wo(1,.87,.17),location:.6},{color:new g.Wo(1,.17,.42),location:.8},{color:new g.Wo(.17,.68,1),location:1}],n=s.bones.length+1,o=Ti._CreateBoneMapColorBuffer(n,r,t),a=new xi.j("boneWeights:"+s.name,t,{vertexSource:"precision highp float;\n\n            attribute vec3 position;\n            attribute vec2 uv;\n\n            uniform mat4 view;\n            uniform mat4 projection;\n            uniform mat4 worldViewProjection;\n            uniform float colorMap["+4*s.bones.length+"];\n\n            #include<bonesDeclaration>\n            #if NUM_BONE_INFLUENCERS == 0\n                attribute vec4 matricesIndices;\n                attribute vec4 matricesWeights;\n            #endif\n            #include<bakedVertexAnimationDeclaration>\n            #include<instancesDeclaration>\n\n            varying vec3 vColor;\n\n            void main() {\n                vec3 positionUpdated = position;\n\n                #include<instancesVertex>\n                #include<bonesVertex>\n                #include<bakedVertexAnimation>\n\n                vec3 color = vec3(0.);\n                bool first = true;\n\n                for (int i = 0; i < 4; i++) {\n                    int boneIdx = int(matricesIndices[i]);\n                    float boneWgt = matricesWeights[i];\n\n                    vec3 c = vec3(colorMap[boneIdx * 4 + 0], colorMap[boneIdx * 4 + 1], colorMap[boneIdx * 4 + 2]);\n\n                    if (boneWgt > 0.) {\n                        if (first) {\n                            first = false;\n                            color = c;\n                        } else {\n                            color = mix(color, c, boneWgt);\n                        }\n                    }\n                }\n\n                vColor = color;\n\n                vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n                gl_Position = projection * view * worldPos;\n            }",fragmentSource:"\n            precision highp float;\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4( vColor, 1.0 );\n                gl_FragColor = color;\n            }\n            "},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorMap"]});return a.setFloats("colorMap",o),a.getClassName=()=>"SkeletonMapShader",a.transparencyMode=yi.F.MATERIAL_OPAQUE,a}static _CreateBoneMapColorBuffer(e,t,i){const s=new wt.c("temp",{width:e,height:1},i,!1),r=s.getContext(),n=r.createLinearGradient(0,0,e,0);t.forEach((e=>{n.addColorStop(e.location,e.color.toHexString())})),r.fillStyle=n,r.fillRect(0,0,e,1),s.update();const o=[],a=r.getImageData(0,0,e,1).data;for(let e=0;e<a.length;e++)o.push(.00392156862745098*a[e]);return s.dispose(),o}get scene(){return this._scene}get utilityLayer(){return this._utilityLayer}get isReady(){return this._ready}set ready(e){this._ready=e}get debugMesh(){return this._debugMesh}set debugMesh(e){this._debugMesh=e}get displayMode(){return this.options.displayMode||Ti.DISPLAY_LINES}set displayMode(e){e>Ti.DISPLAY_SPHERE_AND_SPURS&&(e=Ti.DISPLAY_LINES),this.options.displayMode=e}constructor(e,t,i,s=!0,r=3,n={}){var o,a,h,l,c,u,d,p,_,m,f,b,v,y;this.skeleton=e,this.mesh=t,this.autoUpdateBonesMatrices=s,this.renderingGroupId=r,this.options=n,this.color=g.Wo.White(),this._debugLines=new Array,this._localAxes=null,this._isEnabled=!0,this._obs=null,this._scene=i,this._ready=!1,n.pauseAnimations=null===(o=n.pauseAnimations)||void 0===o||o,n.returnToRest=null!==(a=n.returnToRest)&&void 0!==a&&a,n.displayMode=null!==(h=n.displayMode)&&void 0!==h?h:Ti.DISPLAY_LINES,n.displayOptions=null!==(l=n.displayOptions)&&void 0!==l?l:{},n.displayOptions.midStep=null!==(c=n.displayOptions.midStep)&&void 0!==c?c:.235,n.displayOptions.midStepFactor=null!==(u=n.displayOptions.midStepFactor)&&void 0!==u?u:.155,n.displayOptions.sphereBaseSize=null!==(d=n.displayOptions.sphereBaseSize)&&void 0!==d?d:.15,n.displayOptions.sphereScaleUnit=null!==(p=n.displayOptions.sphereScaleUnit)&&void 0!==p?p:2,n.displayOptions.sphereFactor=null!==(_=n.displayOptions.sphereFactor)&&void 0!==_?_:.865,n.displayOptions.spurFollowsChild=null!==(m=n.displayOptions.spurFollowsChild)&&void 0!==m&&m,n.displayOptions.showLocalAxes=null!==(f=n.displayOptions.showLocalAxes)&&void 0!==f&&f,n.displayOptions.localAxesSize=null!==(b=n.displayOptions.localAxesSize)&&void 0!==b?b:.075,n.computeBonesUsingShaders=null===(v=n.computeBonesUsingShaders)||void 0===v||v,n.useAllBones=null===(y=n.useAllBones)||void 0===y||y;const x=t.getVerticesData(me.o.MatricesIndicesKind),P=t.getVerticesData(me.o.MatricesWeightsKind);if(this._boneIndices=new Set,!n.useAllBones&&x&&P)for(let e=0;e<x.length;++e){const t=x[e];0!==P[e]&&this._boneIndices.add(t)}this._utilityLayer=new oi.x(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0;let C=this.options.displayMode||0;C>Ti.DISPLAY_SPHERE_AND_SPURS&&(C=Ti.DISPLAY_LINES),this.displayMode=C,this.update(),this._bindObs()}_bindObs(){this.displayMode===Ti.DISPLAY_LINES&&(this._obs=this.scene.onBeforeRenderObservable.add((()=>{this._displayLinesUpdate()})))}update(){switch(this.displayMode){case Ti.DISPLAY_LINES:this._displayLinesUpdate();break;case Ti.DISPLAY_SPHERES:this._buildSpheresAndSpurs(!0);break;case Ti.DISPLAY_SPHERE_AND_SPURS:this._buildSpheresAndSpurs(!1)}this._buildLocalAxes()}set isEnabled(e){this.isEnabled!==e&&(this._isEnabled=e,this.debugMesh&&this.debugMesh.setEnabled(e),e&&!this._obs?this._bindObs():!e&&this._obs&&(this.scene.onBeforeRenderObservable.remove(this._obs),this._obs=null))}get isEnabled(){return this._isEnabled}_getBonePosition(e,t,i,s=0,r=0,n=0){const o=m.jp.Matrix[0],a=t.getParent();if(o.copyFrom(t.getLocalMatrix()),0!==s||0!==r||0!==n){const e=m.jp.Matrix[1];m.y3.IdentityToRef(e),e.setTranslationFromFloats(s,r,n),e.multiplyToRef(o,o)}a&&o.multiplyToRef(a.getAbsoluteMatrix(),o),o.multiplyToRef(i,o),e.x=o.m[12],e.y=o.m[13],e.z=o.m[14]}_getLinesForBonesWithLength(e,t){const i=e.length,s=this.mesh.position;let r=0;for(let n=0;n<i;n++){const i=e[n];let o=this._debugLines[r];-1!==i._index&&(this._boneIndices.has(i.getIndex())||this.options.useAllBones)&&(o||(o=[m.P.Zero(),m.P.Zero()],this._debugLines[r]=o),this._getBonePosition(o[0],i,t),this._getBonePosition(o[1],i,t,0,i.length,0),o[0].subtractInPlace(s),o[1].subtractInPlace(s),r++)}}_getLinesForBonesNoLength(e){const t=e.length;let i=0;const s=this.mesh,r=s.position;for(let n=t-1;n>=0;n--){const t=e[n],o=t.getParent();if(!o||!this._boneIndices.has(t.getIndex())&&!this.options.useAllBones)continue;let a=this._debugLines[i];a||(a=[m.P.Zero(),m.P.Zero()],this._debugLines[i]=a),t.getAbsolutePositionToRef(s,a[0]),o.getAbsolutePositionToRef(s,a[1]),a[0].subtractInPlace(r),a[1].subtractInPlace(r),i++}}_revert(e){this.options.pauseAnimations&&(this.scene.animationsEnabled=e,this.utilityLayer.utilityLayerScene.animationsEnabled=e)}_getAbsoluteBindPoseToRef(e,t){null!==e&&-1!==e._index?(this._getAbsoluteBindPoseToRef(e.getParent(),t),e.getBindMatrix().multiplyToRef(t,t)):t.copyFrom(m.y3.Identity())}_buildSpheresAndSpurs(e=!0){var t,i;this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this._ready=!1;const s=null===(t=this.utilityLayer)||void 0===t?void 0:t.utilityLayerScene,r=this.skeleton.bones,n=[],o=[],a=this.scene.animationsEnabled;try{this.options.pauseAnimations&&(this.scene.animationsEnabled=!1,s.animationsEnabled=!1),this.options.returnToRest&&this.skeleton.returnToRest(),this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteMatrices();let t=Number.NEGATIVE_INFINITY;const h=this.options.displayOptions||{};for(let i=0;i<r.length;i++){const a=r[i];if(-1===a._index||!this._boneIndices.has(a.getIndex())&&!this.options.useAllBones)continue;const l=new m.y3;this._getAbsoluteBindPoseToRef(a,l);const c=new m.P;l.decompose(void 0,void 0,c),a.children.forEach((i=>{const r=new m.y3;i.getLocalMatrix().multiplyToRef(l,r);const n=new m.P;r.decompose(void 0,void 0,n);const u=m.P.Distance(c,n);if(u>t&&(t=u),e)return;const d=n.clone().subtract(c.clone()),p=d.length(),_=d.normalize().scale(p),g=h.midStep||.165,f=h.midStepFactor||.215,b=_.scale(g),v=(0,Ci.bC)("skeletonViewer",{shape:[new m.P(1,-1,0),new m.P(1,1,0),new m.P(-1,1,0),new m.P(-1,-1,0),new m.P(1,-1,0)],path:[m.P.Zero(),b,_],scaleFunction:e=>{switch(e){case 0:case 2:return 0;case 1:return p*f}return 0},sideOrientation:Mt.Kj.DEFAULTSIDE,updatable:!1},s),y=v.getTotalVertices(),x=[],P=[];for(let e=0;e<y;e++)x.push(1,0,0,0),h.spurFollowsChild&&e>9?P.push(i.getIndex(),0,0,0):P.push(a.getIndex(),0,0,0);v.position=c.clone(),v.setVerticesData(me.o.MatricesWeightsKind,x,!1),v.setVerticesData(me.o.MatricesIndicesKind,P,!1),v.convertToFlatShadedMesh(),o.push(v)}));const u=h.sphereBaseSize||.2,d=(0,di.Qk)("skeletonViewer",{segments:6,diameter:u,updatable:!0},s),p=d.getTotalVertices(),_=[],g=[];for(let e=0;e<p;e++)_.push(1,0,0,0),g.push(a.getIndex(),0,0,0);d.setVerticesData(me.o.MatricesWeightsKind,_,!1),d.setVerticesData(me.o.MatricesIndicesKind,g,!1),d.position=c.clone(),n.push([d,a])}const l=h.sphereScaleUnit||2,c=h.sphereFactor||.85,u=[];for(let e=0;e<n.length;e++){const[i,s]=n[e],r=1/(l/t);let o=0,a=s;for(;a.getParent()&&-1!==a.getParent().getIndex();)o++,a=a.getParent();i.scaling.scaleInPlace(r*Math.pow(c,o)),u.push(i)}this.debugMesh=Mt.Kj.MergeMeshes(u.concat(o),!0,!0),this.debugMesh&&(this.debugMesh.renderingGroupId=this.renderingGroupId,this.debugMesh.skeleton=this.skeleton,this.debugMesh.parent=this.mesh,this.debugMesh.computeBonesUsingShaders=null===(i=this.options.computeBonesUsingShaders)||void 0===i||i,this.debugMesh.alwaysSelectAsActiveMesh=!0),this.utilityLayer._getSharedGizmoLight().intensity=.7,this._revert(a),this.ready=!0}catch(e){console.error(e),this._revert(a),this.dispose()}}_buildLocalAxes(){var e;this._localAxes&&this._localAxes.dispose(),this._localAxes=null;const t=this.options.displayOptions||{};if(!t.showLocalAxes)return;const i=this._utilityLayer.utilityLayerScene,s=t.localAxesSize||.075,r=[],n=[],o=new g.HE(1,0,0,1),a=new g.HE(0,1,0,1),h=new g.HE(0,0,1,1),l=[],c=[];for(const e in this.skeleton.bones){const t=this.skeleton.bones[e];if(-1===t._index||!this._boneIndices.has(t.getIndex())&&!this.options.useAllBones)continue;const i=new m.y3,u=new m.P;this._getAbsoluteBindPoseToRef(t,i),i.decompose(void 0,m.jp.Quaternion[0],u);const d=new m.y3;m.jp.Quaternion[0].toRotationMatrix(d);const p=m.P.TransformCoordinates(new m.P(0+s,0,0),d),_=m.P.TransformCoordinates(new m.P(0,0+s,0),d),g=m.P.TransformCoordinates(new m.P(0,0,0+s),d),f=[[u,u.add(p)],[u,u.add(_)],[u,u.add(g)]],b=[[o,o],[a,a],[h,h]];r.push(...f),n.push(...b);for(let e=0;e<6;e++)l.push(1,0,0,0),c.push(t.getIndex(),0,0,0)}this._localAxes=(0,bi.xW)("localAxes",{lines:r,colors:n,updatable:!0},i),this._localAxes.setVerticesData(me.o.MatricesWeightsKind,l,!1),this._localAxes.setVerticesData(me.o.MatricesIndicesKind,c,!1),this._localAxes.skeleton=this.skeleton,this._localAxes.renderingGroupId=this.renderingGroupId+1,this._localAxes.parent=this.mesh,this._localAxes.computeBonesUsingShaders=null===(e=this.options.computeBonesUsingShaders)||void 0===e||e}_displayLinesUpdate(){if(!this._utilityLayer)return;this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteMatrices(),void 0===this.skeleton.bones[0].length?this._getLinesForBonesNoLength(this.skeleton.bones):this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh.getWorldMatrix());const e=this._utilityLayer.utilityLayerScene;e&&(this._debugMesh?(0,bi.xW)("",{lines:this._debugLines,updatable:!0,instance:this._debugMesh},e):(this._debugMesh=(0,bi.xW)("",{lines:this._debugLines,updatable:!0,instance:null},e),this._debugMesh.renderingGroupId=this.renderingGroupId),this._debugMesh.position.copyFrom(this.mesh.position),this._debugMesh.color=this.color)}changeDisplayMode(e){const t=!!this.isEnabled;this.displayMode!==e&&(this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.displayMode=e,this.update(),this._bindObs(),this.isEnabled=t)}changeDisplayOptions(e,t){const i=!!this.isEnabled;this.options.displayOptions[e]=t,this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.update(),this._bindObs(),this.isEnabled=i}dispose(){this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null),this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null),this.ready=!1}}Ti.DISPLAY_LINES=0,Ti.DISPLAY_SPHERES=1,Ti.DISPLAY_SPHERE_AND_SPURS=2,i(31543);class Si{get transparency(){return this._transparency}set transparency(e){this._transparency=e;for(let t=6;t<12;++t)this._lightHelperFrustumMeshes[t].material.alpha=e}get showLines(){return this._showLines}set showLines(e){if(this._showLines!==e){this._showLines=e;for(let t=0;t<6;++t)this._lightHelperFrustumMeshes[t].setEnabled(e)}}get showPlanes(){return this._showPlanes}set showPlanes(e){if(this._showPlanes!==e){this._showPlanes=e;for(let t=6;t<12;++t)this._lightHelperFrustumMeshes[t].setEnabled(e)}}constructor(e,t){this._oldPosition=new m.P(Number.NaN,Number.NaN,Number.NaN),this._oldDirection=new m.P(Number.NaN,Number.NaN,Number.NaN),this._transparency=.3,this._showLines=!0,this._showPlanes=!0,this._scene=e.getScene(),this._light=e,this._camera=t,this._inverseViewMatrix=m.y3.Identity(),this._lightHelperFrustumMeshes=[],this._createGeometry(),this.show(),this.update()}show(){this._lightHelperFrustumMeshes.forEach(((e,t)=>{e.setEnabled(t<6&&this._showLines||t>=6&&this._showPlanes)})),this._oldPosition.set(Number.NaN,Number.NaN,Number.NaN),this._visible=!0}hide(){this._lightHelperFrustumMeshes.forEach((e=>{e.setEnabled(!1)})),this._visible=!1}update(){var e,t,i,s,r,n;if(!this._visible)return;if(this._oldPosition.equals(this._light.position)&&this._oldDirection.equals(this._light.direction)&&this._oldAutoCalc===this._light.autoCalcShadowZBounds&&this._oldMinZ===this._light.shadowMinZ&&this._oldMaxZ===this._light.shadowMaxZ)return;this._oldPosition.copyFrom(this._light.position),this._oldDirection.copyFrom(this._light.direction),this._oldAutoCalc=this._light.autoCalcShadowZBounds,this._oldMinZ=this._light.shadowMinZ,this._oldMaxZ=this._light.shadowMaxZ,m.jp.Vector3[0].set(this._light.orthoLeft,this._light.orthoBottom,void 0!==this._light.shadowMinZ?this._light.shadowMinZ:this._camera.minZ),m.jp.Vector3[1].set(this._light.orthoRight,this._light.orthoTop,void 0!==this._light.shadowMaxZ?this._light.shadowMaxZ:this._camera.maxZ);const o=this._getInvertViewMatrix();m.jp.Vector3[2].copyFromFloats(m.jp.Vector3[1].x,m.jp.Vector3[1].y,m.jp.Vector3[0].z),m.jp.Vector3[3].copyFromFloats(m.jp.Vector3[1].x,m.jp.Vector3[0].y,m.jp.Vector3[0].z),m.jp.Vector3[4].copyFromFloats(m.jp.Vector3[0].x,m.jp.Vector3[0].y,m.jp.Vector3[0].z),m.jp.Vector3[5].copyFromFloats(m.jp.Vector3[0].x,m.jp.Vector3[1].y,m.jp.Vector3[0].z),m.P.TransformCoordinatesToRef(m.jp.Vector3[2],o,m.jp.Vector3[2]),m.P.TransformCoordinatesToRef(m.jp.Vector3[3],o,m.jp.Vector3[3]),m.P.TransformCoordinatesToRef(m.jp.Vector3[4],o,m.jp.Vector3[4]),m.P.TransformCoordinatesToRef(m.jp.Vector3[5],o,m.jp.Vector3[5]),m.jp.Vector3[6].copyFromFloats(m.jp.Vector3[1].x,m.jp.Vector3[1].y,m.jp.Vector3[1].z),m.jp.Vector3[7].copyFromFloats(m.jp.Vector3[1].x,m.jp.Vector3[0].y,m.jp.Vector3[1].z),m.jp.Vector3[8].copyFromFloats(m.jp.Vector3[0].x,m.jp.Vector3[0].y,m.jp.Vector3[1].z),m.jp.Vector3[9].copyFromFloats(m.jp.Vector3[0].x,m.jp.Vector3[1].y,m.jp.Vector3[1].z),m.P.TransformCoordinatesToRef(m.jp.Vector3[6],o,m.jp.Vector3[6]),m.P.TransformCoordinatesToRef(m.jp.Vector3[7],o,m.jp.Vector3[7]),m.P.TransformCoordinatesToRef(m.jp.Vector3[8],o,m.jp.Vector3[8]),m.P.TransformCoordinatesToRef(m.jp.Vector3[9],o,m.jp.Vector3[9]),(0,bi.nL)("nearlines",{updatable:!0,points:this._nearLinesPoints,instance:this._lightHelperFrustumMeshes[0]},this._scene),(0,bi.nL)("farlines",{updatable:!0,points:this._farLinesPoints,instance:this._lightHelperFrustumMeshes[1]},this._scene),(0,bi.nL)("trlines",{updatable:!0,points:this._trLinesPoints,instance:this._lightHelperFrustumMeshes[2]},this._scene),(0,bi.nL)("brlines",{updatable:!0,points:this._brLinesPoints,instance:this._lightHelperFrustumMeshes[3]},this._scene),(0,bi.nL)("tllines",{updatable:!0,points:this._tlLinesPoints,instance:this._lightHelperFrustumMeshes[4]},this._scene),(0,bi.nL)("bllines",{updatable:!0,points:this._blLinesPoints,instance:this._lightHelperFrustumMeshes[5]},this._scene),m.jp.Vector3[2].toArray(this._nearPlaneVertices,0),m.jp.Vector3[3].toArray(this._nearPlaneVertices,3),m.jp.Vector3[4].toArray(this._nearPlaneVertices,6),m.jp.Vector3[5].toArray(this._nearPlaneVertices,9),null===(e=this._lightHelperFrustumMeshes[6].geometry)||void 0===e||e.updateVerticesDataDirectly("position",this._nearPlaneVertices,0),m.jp.Vector3[6].toArray(this._farPlaneVertices,0),m.jp.Vector3[7].toArray(this._farPlaneVertices,3),m.jp.Vector3[8].toArray(this._farPlaneVertices,6),m.jp.Vector3[9].toArray(this._farPlaneVertices,9),null===(t=this._lightHelperFrustumMeshes[7].geometry)||void 0===t||t.updateVerticesDataDirectly("position",this._farPlaneVertices,0),m.jp.Vector3[2].toArray(this._rightPlaneVertices,0),m.jp.Vector3[6].toArray(this._rightPlaneVertices,3),m.jp.Vector3[7].toArray(this._rightPlaneVertices,6),m.jp.Vector3[3].toArray(this._rightPlaneVertices,9),null===(i=this._lightHelperFrustumMeshes[8].geometry)||void 0===i||i.updateVerticesDataDirectly("position",this._rightPlaneVertices,0),m.jp.Vector3[5].toArray(this._leftPlaneVertices,0),m.jp.Vector3[9].toArray(this._leftPlaneVertices,3),m.jp.Vector3[8].toArray(this._leftPlaneVertices,6),m.jp.Vector3[4].toArray(this._leftPlaneVertices,9),null===(s=this._lightHelperFrustumMeshes[9].geometry)||void 0===s||s.updateVerticesDataDirectly("position",this._leftPlaneVertices,0),m.jp.Vector3[2].toArray(this._topPlaneVertices,0),m.jp.Vector3[6].toArray(this._topPlaneVertices,3),m.jp.Vector3[9].toArray(this._topPlaneVertices,6),m.jp.Vector3[5].toArray(this._topPlaneVertices,9),null===(r=this._lightHelperFrustumMeshes[10].geometry)||void 0===r||r.updateVerticesDataDirectly("position",this._topPlaneVertices,0),m.jp.Vector3[3].toArray(this._bottomPlaneVertices,0),m.jp.Vector3[7].toArray(this._bottomPlaneVertices,3),m.jp.Vector3[8].toArray(this._bottomPlaneVertices,6),m.jp.Vector3[4].toArray(this._bottomPlaneVertices,9),null===(n=this._lightHelperFrustumMeshes[11].geometry)||void 0===n||n.updateVerticesDataDirectly("position",this._bottomPlaneVertices,0)}dispose(){this._lightHelperFrustumMeshes.forEach((e=>{var t;null===(t=e.material)||void 0===t||t.dispose(),e.dispose()})),this._rootNode.dispose()}_createGeometry(){this._rootNode=new dt.Y("directionalLightHelperRoot_"+this._light.name,this._scene),this._rootNode.parent=this._light.parent,this._nearLinesPoints=[m.P.ZeroReadOnly,m.P.ZeroReadOnly,m.P.ZeroReadOnly,m.P.ZeroReadOnly,m.P.ZeroReadOnly];const e=(0,bi.nL)("nearlines",{updatable:!0,points:this._nearLinesPoints},this._scene);e.parent=this._rootNode,e.alwaysSelectAsActiveMesh=!0,this._farLinesPoints=[m.P.ZeroReadOnly,m.P.ZeroReadOnly,m.P.ZeroReadOnly,m.P.ZeroReadOnly,m.P.ZeroReadOnly];const t=(0,bi.nL)("farlines",{updatable:!0,points:this._farLinesPoints},this._scene);t.parent=this._rootNode,t.alwaysSelectAsActiveMesh=!0,this._trLinesPoints=[m.P.ZeroReadOnly,m.P.ZeroReadOnly];const i=(0,bi.nL)("trlines",{updatable:!0,points:this._trLinesPoints},this._scene);i.parent=this._rootNode,i.alwaysSelectAsActiveMesh=!0,this._brLinesPoints=[m.P.ZeroReadOnly,m.P.ZeroReadOnly];const s=(0,bi.nL)("brlines",{updatable:!0,points:this._brLinesPoints},this._scene);s.parent=this._rootNode,s.alwaysSelectAsActiveMesh=!0,this._tlLinesPoints=[m.P.ZeroReadOnly,m.P.ZeroReadOnly];const r=(0,bi.nL)("tllines",{updatable:!0,points:this._tlLinesPoints},this._scene);r.parent=this._rootNode,r.alwaysSelectAsActiveMesh=!0,this._blLinesPoints=[m.P.ZeroReadOnly,m.P.ZeroReadOnly];const n=(0,bi.nL)("bllines",{updatable:!0,points:this._blLinesPoints},this._scene);n.parent=this._rootNode,n.alwaysSelectAsActiveMesh=!0,this._lightHelperFrustumMeshes.push(e,t,i,s,r,n);const o=(e,t,i)=>{const s=new Mt.Kj(e+"plane",this._scene),r=new Ot.K(e+"PlaneMat",this._scene);s.material=r,s.parent=this._rootNode,s.alwaysSelectAsActiveMesh=!0,r.emissiveColor=t,r.alpha=this.transparency,r.backFaceCulling=!1,r.disableLighting=!0;const n=new gi.x;n.positions=i,n.indices=[0,1,2,0,2,3],n.applyToMesh(s,!0),this._lightHelperFrustumMeshes.push(s)};this._nearPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._farPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._rightPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._leftPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._topPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._bottomPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],o("near",new g.Wo(1,0,0),this._nearPlaneVertices),o("far",new g.Wo(.3,0,0),this._farPlaneVertices),o("right",new g.Wo(0,1,0),this._rightPlaneVertices),o("left",new g.Wo(0,.3,0),this._leftPlaneVertices),o("top",new g.Wo(0,0,1),this._topPlaneVertices),o("bottom",new g.Wo(0,0,.3),this._bottomPlaneVertices),this._nearLinesPoints[0]=m.jp.Vector3[2],this._nearLinesPoints[1]=m.jp.Vector3[3],this._nearLinesPoints[2]=m.jp.Vector3[4],this._nearLinesPoints[3]=m.jp.Vector3[5],this._nearLinesPoints[4]=m.jp.Vector3[2],this._farLinesPoints[0]=m.jp.Vector3[6],this._farLinesPoints[1]=m.jp.Vector3[7],this._farLinesPoints[2]=m.jp.Vector3[8],this._farLinesPoints[3]=m.jp.Vector3[9],this._farLinesPoints[4]=m.jp.Vector3[6],this._trLinesPoints[0]=m.jp.Vector3[2],this._trLinesPoints[1]=m.jp.Vector3[6],this._brLinesPoints[0]=m.jp.Vector3[3],this._brLinesPoints[1]=m.jp.Vector3[7],this._tlLinesPoints[0]=m.jp.Vector3[4],this._tlLinesPoints[1]=m.jp.Vector3[8],this._blLinesPoints[0]=m.jp.Vector3[5],this._blLinesPoints[1]=m.jp.Vector3[9]}_getInvertViewMatrix(){return m.y3.LookAtLHToRef(this._light.position,this._light.position.add(this._light.direction),m.P.UpReadOnly,this._inverseViewMatrix),this._inverseViewMatrix.invertToRef(this._inverseViewMatrix),this._inverseViewMatrix}}var Ei=i(66133),Ri=(i(35875),i(8158)),Mi=i(863),Ai=i(40402),Ii=(i(22762),i(93993),i(79366)),Oi=i(1801),wi=i(27360),Di=i(62813),Bi=i(92037);class Ni{constructor(){this.renderWidth=512,this.renderHeight=256,this.textureSize=512,this.deterministicLockstep=!1,this.lockstepMaxSteps=4}}class Fi extends O.D{isDeterministicLockStep(){return this._options.deterministicLockstep}getLockstepMaxSteps(){return this._options.lockstepMaxSteps}getHardwareScalingLevel(){return 1}constructor(e=new Ni){super(null),O.D.Instances.push(this),void 0===e.deterministicLockstep&&(e.deterministicLockstep=!1),void 0===e.lockstepMaxSteps&&(e.lockstepMaxSteps=4),this._options=e,wi.Z.SetMatrixPrecision(!!e.useHighPrecisionMatrix),this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:512,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!1,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:0,uintIndices:!1,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!1,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!1,instancedArrays:!1,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,maxMSAASamples:1,blendMinMax:!1,canUseGLInstanceID:!1,canUseGLVertexID:!1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:128,disableMorphTargetTexture:!1},this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,_collectUbosUpdatedInFrame:!1},p.Y.Log(`Babylon.js v${O.D.Version} - Null engine`);const t="undefined"!=typeof self?self:"undefined"!=typeof global?global:window;"undefined"==typeof URL&&(t.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),"undefined"==typeof Blob&&(t.Blob=function(){})}createVertexBuffer(e){const t=new fe.h;return t.references=1,t}createIndexBuffer(e){const t=new fe.h;return t.references=1,t}clear(e,t,i,s=!1){}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._options.renderWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._options.renderHeight}setViewport(e,t,i){this._cachedViewport=e}createShaderProgram(e,t,i,s,r){return{__SPECTOR_rebuildProgram:null}}getUniforms(e,t){return[]}getAttributes(e,t){return[]}bindSamplers(e){this._currentEffect=null}enableEffect(e){e=null!==e&&Di.q.IsWrapper(e)?e.effect:e,this._currentEffect=e,e&&(e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setState(e,t=0,i,s=!1,r,n,o=0){}setIntArray(e,t){return!0}setIntArray2(e,t){return!0}setIntArray3(e,t){return!0}setIntArray4(e,t){return!0}setFloatArray(e,t){return!0}setFloatArray2(e,t){return!0}setFloatArray3(e,t){return!0}setFloatArray4(e,t){return!0}setArray(e,t){return!0}setArray2(e,t){return!0}setArray3(e,t){return!0}setArray4(e,t){return!0}setMatrices(e,t){return!0}setMatrix3x3(e,t){return!0}setMatrix2x2(e,t){return!0}setFloat(e,t){return!0}setFloat2(e,t,i){return!0}setFloat3(e,t,i,s){return!0}setBool(e,t){return!0}setFloat4(e,t,i,s,r){return!0}setAlphaMode(e,t=!1){this._alphaMode!==e&&(this.alphaState.alphaBlend=0!==e,t||this.setDepthWrite(0===e),this._alphaMode=e)}bindBuffers(e,t,i){}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this.depthCullingState.reset(),this.alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}draw(e,t,i,s){}drawElementsType(e,t,i,s){}drawArraysType(e,t,i,s){}_createTexture(){return{}}_releaseTexture(e){}createTexture(e,t,i,s,r=3,n=null,o=null,a=null,h=null,l=null,c=null,u){const d=new Oi.l(this,Oi.S.Url),p=String(e);return d.url=p,d.generateMipMaps=!t,d.samplingMode=r,d.invertY=i,d.baseWidth=this._options.textureSize,d.baseHeight=this._options.textureSize,d.width=this._options.textureSize,d.height=this._options.textureSize,l&&(d.format=l),d.isReady=!0,n&&setTimeout((()=>{n(d)})),this._internalTexturesCache.push(d),d}_createHardwareRenderTargetWrapper(e,t,i){const s=new Bi.r(e,t,i,this);return this._renderTargetWrapperCache.push(s),s}createRenderTargetTexture(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!1,e),s={};void 0!==t&&"object"==typeof t?(s.generateMipMaps=t.generateMipMaps,s.generateDepthBuffer=void 0===t.generateDepthBuffer||t.generateDepthBuffer,s.generateStencilBuffer=s.generateDepthBuffer&&t.generateStencilBuffer,s.type=void 0===t.type?0:t.type,s.samplingMode=void 0===t.samplingMode?3:t.samplingMode):(s.generateMipMaps=t,s.generateDepthBuffer=!0,s.generateStencilBuffer=!1,s.type=0,s.samplingMode=3);const r=new Oi.l(this,Oi.S.RenderTarget),n=e.width||e,o=e.height||e;return i._generateDepthBuffer=s.generateDepthBuffer,i._generateStencilBuffer=!!s.generateStencilBuffer,r.baseWidth=n,r.baseHeight=o,r.width=n,r.height=o,r.isReady=!0,r.samples=1,r.generateMipMaps=!!s.generateMipMaps,r.samplingMode=s.samplingMode,r.type=s.type,this._internalTexturesCache.push(r),i}createRenderTargetCubeTexture(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!0,e),s=Object.assign({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},t);s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer,(1!==s.type||this._caps.textureFloatLinearFiltering)&&(2!==s.type||this._caps.textureHalfFloatLinearFiltering)||(s.samplingMode=1),i._generateDepthBuffer=s.generateDepthBuffer,i._generateStencilBuffer=!!s.generateStencilBuffer;const r=new Oi.l(this,Oi.S.RenderTarget);return r.baseWidth=e,r.baseHeight=e,r.width=e,r.height=e,r.isReady=!0,r.isCube=!0,r.samples=1,r.generateMipMaps=!!s.generateMipMaps,r.samplingMode=s.samplingMode,r.type=s.type,this._internalTexturesCache.push(r),i}updateTextureSamplingMode(e,t){t.samplingMode=e}createRawTexture(e,t,i,s,r,n,o,a=null,h=0,l=0,c=!1){const u=new Oi.l(this,Oi.S.Raw);return u.baseWidth=t,u.baseHeight=i,u.width=t,u.height=i,u.format=s,u.generateMipMaps=r,u.samplingMode=o,u.invertY=n,u._compression=a,u.type=h,u._useSRGBBuffer=c,this._doNotHandleContextLost||(u._bufferView=e),u}updateRawTexture(e,t,i,s,r=null,n=0,o=!1){e&&(e._bufferView=t,e.format=i,e.invertY=s,e._compression=r,e.type=n,e._useSRGBBuffer=o)}bindFramebuffer(e,t,i,s,r){this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._currentFramebuffer=null,this._cachedViewport&&!r&&this.setViewport(this._cachedViewport,i,s)}unBindFramebuffer(e,t=!1,i){this._currentRenderTarget=null,i&&i(),this._currentFramebuffer=null}createDynamicVertexBuffer(e){const t=new fe.h;return t.references=1,t.capacity=1,t}updateDynamicTexture(e,t,i,s=!1,r){}areAllEffectsReady(){return!0}getError(){return 0}_getUnpackAlignement(){return 1}_unpackFlipY(e){}updateDynamicIndexBuffer(e,t,i=0){}updateDynamicVertexBuffer(e,t,i,s){}_bindTextureDirectly(e,t){return this._boundTexturesCache[this._activeChannel]!==t&&(this._boundTexturesCache[this._activeChannel]=t,!0)}_bindTexture(e,t){e<0||this._bindTextureDirectly(0,t)}_deleteBuffer(e){}releaseEffects(){}displayLoadingUI(){}hideLoadingUI(){}set loadingUIText(e){}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,o=0){}_uploadDataToTextureDirectly(e,t,i=0,s=0){}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){}_uploadImageToTexture(e,t,i=0,s=0){}}i(21099),i(70430);var Li=i(21620),Vi=i(32255);class ki{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=si.x.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=si.x.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}O.D.prototype.createQuery=function(){const e=this._gl.createQuery();if(!e)throw new Error("Unable to create Occlusion Query");return e},O.D.prototype.deleteQuery=function(e){return this._gl.deleteQuery(e),this},O.D.prototype.isQueryResultAvailable=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT_AVAILABLE)},O.D.prototype.getQueryResult=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT)},O.D.prototype.beginOcclusionQuery=function(e,t){const i=this._getGlAlgorithmType(e);return this._gl.beginQuery(i,t),!0},O.D.prototype.endOcclusionQuery=function(e){const t=this._getGlAlgorithmType(e);return this._gl.endQuery(t),this},O.D.prototype._createTimeQuery=function(){const e=this.getCaps().timerQuery;return e.createQueryEXT?e.createQueryEXT():this.createQuery()},O.D.prototype._deleteTimeQuery=function(e){const t=this.getCaps().timerQuery;t.deleteQueryEXT?t.deleteQueryEXT(e):this.deleteQuery(e)},O.D.prototype._getTimeQueryResult=function(e){const t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_EXT):this.getQueryResult(e)},O.D.prototype._getTimeQueryAvailability=function(e){const t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(e)},O.D.prototype.startTimeQuery=function(){const e=this.getCaps(),t=e.timerQuery;if(!t)return null;const i=new Li.W;if(this._gl.getParameter(t.GPU_DISJOINT_EXT),e.canUseTimestampForTimerQuery)i._startTimeQuery=this._createTimeQuery(),t.queryCounterEXT(i._startTimeQuery,t.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;i._timeElapsedQuery=this._createTimeQuery(),t.beginQueryEXT?t.beginQueryEXT(t.TIME_ELAPSED_EXT,i._timeElapsedQuery):this._gl.beginQuery(t.TIME_ELAPSED_EXT,i._timeElapsedQuery),this._currentNonTimestampToken=i}return i},O.D.prototype.endTimeQuery=function(e){const t=this.getCaps(),i=t.timerQuery;if(!i||!e)return-1;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery)return-1;e._endTimeQuery||(e._endTimeQuery=this._createTimeQuery(),i.queryCounterEXT(e._endTimeQuery,i.TIMESTAMP_EXT))}else if(!e._timeElapsedQueryEnded){if(!e._timeElapsedQuery)return-1;i.endQueryEXT?i.endQueryEXT(i.TIME_ELAPSED_EXT):(this._gl.endQuery(i.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),e._timeElapsedQueryEnded=!0}const s=this._gl.getParameter(i.GPU_DISJOINT_EXT);let r=!1;if(e._endTimeQuery?r=this._getTimeQueryAvailability(e._endTimeQuery):e._timeElapsedQuery&&(r=this._getTimeQueryAvailability(e._timeElapsedQuery)),r&&!s){let i=0;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery||!e._endTimeQuery)return-1;const t=this._getTimeQueryResult(e._startTimeQuery);i=this._getTimeQueryResult(e._endTimeQuery)-t,this._deleteTimeQuery(e._startTimeQuery),this._deleteTimeQuery(e._endTimeQuery),e._startTimeQuery=null,e._endTimeQuery=null}else{if(!e._timeElapsedQuery)return-1;i=this._getTimeQueryResult(e._timeElapsedQuery),this._deleteTimeQuery(e._timeElapsedQuery),e._timeElapsedQuery=null,e._timeElapsedQueryEnded=!1}return i}return-1},O.D.prototype._captureGPUFrameTime=!1,O.D.prototype._gpuFrameTime=new Vi.z,O.D.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime},O.D.prototype.captureGPUFrameTime=function(e){e!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=e,e?(this._onBeginFrameObserver=this.onBeginFrameObservable.add((()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())})),this._onEndFrameObserver=this.onEndFrameObservable.add((()=>{if(!this._gpuFrameTimeToken)return;const e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,this._gpuFrameTime.fetchNewFrame(),this._gpuFrameTime.addCount(e,!0))}))):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))},O.D.prototype._getGlAlgorithmType=function(e){return e===si.x.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED},Object.defineProperty(si.x.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(e){this._occlusionDataStorage.isOcclusionQueryInProgress=e},enumerable:!1,configurable:!0}),Object.defineProperty(si.x.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new ki),this.__occlusionDataStorage},enumerable:!1,configurable:!0}),Object.defineProperty(si.x.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(e){this._occlusionDataStorage.isOccluded=e},enumerable:!0,configurable:!0}),Object.defineProperty(si.x.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(e){this._occlusionDataStorage.occlusionQueryAlgorithmType=e},enumerable:!0,configurable:!0}),Object.defineProperty(si.x.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(e){this._occlusionDataStorage.occlusionType=e},enumerable:!0,configurable:!0}),Object.defineProperty(si.x.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(e){this._occlusionDataStorage.occlusionRetryCount=e},enumerable:!0,configurable:!0}),Object.defineProperty(si.x.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(e){this._occlusionDataStorage.forceRenderingWhenOccluded=e},enumerable:!0,configurable:!0}),si.x.prototype._checkOcclusionQuery=function(){const e=this._occlusionDataStorage;if(e.occlusionType===si.x.OCCLUSION_TYPE_NONE)return e.isOccluded=!1,!1;const t=this.getEngine();if(!t.getCaps().supportOcclusionQuery)return e.isOccluded=!1,!1;if(!t.isQueryResultAvailable)return e.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery)if(t.isQueryResultAvailable(this._occlusionQuery)){const i=t.getQueryResult(this._occlusionQuery);e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=!(i>0)}else{if(e.occlusionInternalRetryCounter++,!(-1!==e.occlusionRetryCount&&e.occlusionInternalRetryCounter>e.occlusionRetryCount))return e.occlusionType!==si.x.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded;e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=e.occlusionType!==si.x.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded}const i=this.getScene();if(i.getBoundingBoxRenderer){const s=i.getBoundingBoxRenderer();null===this._occlusionQuery&&(this._occlusionQuery=t.createQuery()),t.beginOcclusionQuery(e.occlusionQueryAlgorithmType,this._occlusionQuery)&&(s.renderOcclusionBoundingBox(this),t.endOcclusionQuery(e.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return e.isOccluded};var zi=i(67602);i(88555),i(2533),i(15530),i(67572),i(21173),i(11585),i(86005),i(60267),i(52574),i(24005),i(54665),i(75322),i(50735);class Gi{}const Ui=new _.y$,Wi=new _.y$;Object.defineProperty(O.D.prototype,"onBeforeViewRenderObservable",{get:function(){return Ui}}),Object.defineProperty(O.D.prototype,"onAfterViewRenderObservable",{get:function(){return Wi}}),Object.defineProperty(O.D.prototype,"inputElement",{get:function(){return this._inputElement},set:function(e){var t;this._inputElement!==e&&(this._inputElement=e,null===(t=this._onEngineViewChanged)||void 0===t||t.call(this))}}),O.D.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()},O.D.prototype.registerView=function(e,t,i){this.views||(this.views=[]);for(const t of this.views)if(t.target===e)return t;const s=this.getRenderingCanvas();s&&(e.width=s.width,e.height=s.height);const r={target:e,camera:t,clearBeforeCopy:i,enabled:!0,id:(1e5*Math.random()).toFixed()};return this.views.push(r),t&&t.onDisposeObservable.add((()=>{this.unRegisterView(e)})),r},O.D.prototype.unRegisterView=function(e){if(!this.views||0===this.views.length)return this;for(const t of this.views)if(t.target===e){const e=this.views.indexOf(t);-1!==e&&this.views.splice(e,1);break}return this},O.D.prototype._renderViewStep=function(e){const t=e.target,i=t.getContext("2d");if(!i)return!0;const s=this.getRenderingCanvas();Ui.notifyObservers(e);const r=e.camera;let n=null,o=null;if(r){if(o=r.getScene(),!o||o.activeCameras&&o.activeCameras.length)return!0;this.activeView=e,n=o.activeCamera,o.activeCamera=r}if(e.customResize)e.customResize(t);else{const e=Math.floor(t.clientWidth/this._hardwareScalingLevel),i=Math.floor(t.clientHeight/this._hardwareScalingLevel),r=e!==t.width||s.width!==t.width||i!==t.height||s.height!==t.height;t.clientWidth&&t.clientHeight&&r&&(t.width=e,t.height=i,this.setSize(e,i))}return!(!s.width||!s.height||(this._renderFrame(),this.flushFramebuffer(),e.clearBeforeCopy&&i.clearRect(0,0,s.width,s.height),i.drawImage(s,0,0),n&&o&&(o.activeCamera=n),Wi.notifyObservers(e),0))},O.D.prototype._renderViews=function(){if(!this.views||0===this.views.length)return!1;if(!this.getRenderingCanvas())return!1;let e;for(const t of this.views)if(t.enabled)if(t.target!==this.inputElement){if(!this._renderViewStep(t))return!1}else e=t;return!(e&&!this._renderViewStep(e)||(this.activeView=null,0))};var Hi=i(98115),ji=i(34538),$i=(i(30458),i(34780),i(84068)),Yi=i(70902),Xi=i(47784),Qi=i(31873),qi=i(36790),Ki=i(32047),Zi=i(11624),Ji=i(24334);const es=new _.y$;if("undefined"!=typeof self&&!Object.prototype.hasOwnProperty.call(self,"_native")){let e;Object.defineProperty(self,"_native",{get:()=>e,set:t=>{e=t,e&&es.notifyObservers(e)}})}function ts(){return new Promise((e=>{"undefined"==typeof _native?es.addOnce((t=>e(t))):e(_native)}))}async function is(e,t){(await ts())[e]=t}class ss extends fe.h{}class rs{constructor(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=ns._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}}class ns extends O.D{setHardwareScalingLevel(e){super.setHardwareScalingLevel(e),this._engine.setHardwareScalingLevel(e)}constructor(e={}){if(super(null,!1,void 0,e.adaptToDeviceRatio),this._engine=new _native.Engine,this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new rs(this._engine),this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,_native.Engine.PROTOCOL_VERSION!==ns.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${ns.PROTOCOL_VERSION} (JS)`);this._webGLVersion=2,this.disableUniformBuffers=!0,this._shaderPlatformName="NATIVE",this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:16,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS,disableMorphTargetTexture:!1},this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,_collectUbosUpdatedInFrame:!1},w.w1.Log("Babylon Native (v"+O.D.Version+") launched"),w.w1.LoadScript=function(e,t,i,s){w.w1.LoadFile(e,(e=>{Function(e).apply(null),t&&t()}),void 0,void 0,!1,((e,t)=>{i&&i("LoadScript Error",t)}))},"undefined"==typeof URL&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),"undefined"==typeof Blob&&(window.Blob=function(e){return e}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function e(){const t=isNaN(arguments[0])?1:Number(arguments[0]);return t?Array.prototype.reduce.call(this,(function(i,s){return Array.isArray(s)?i.push.apply(i,e.call(s,t-1)):i.push(s),i}),[]):Array.prototype.slice.call(this)},writable:!0});const t=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=e.adaptToDeviceRatio?1/t:1,this._engine.setHardwareScalingLevel(this._hardwareScalingLevel),this._lastDevicePixelRatio=t,this.resize();const i=this.getDepthFunction();i&&this.setDepthFunction(i),this._shaderProcessor=new Qi.C,this.onNewSceneAddedObservable.add((e=>{const t=e.render;e.render=(...i)=>{this._commandBufferEncoder.beginCommandScope(),t.apply(e,i),this._commandBufferEncoder.endCommandScope()}}))}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new $i.e}_queueNewFrame(e,t){return t.requestAnimationFrame&&t!==window?t.requestAnimationFrame(e):this._engine.requestAnimationFrame(e),0}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=e)}getHostDocument(){return null}clear(e,t,i,s=!1){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(t&&e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(i?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(s?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(e,t){const i=this._normalizeIndexData(e),s=new ss;return s.references=1,s.is32Bits=4===i.BYTES_PER_ELEMENT,i.byteLength&&(s.nativeIndexBuffer=this._engine.createIndexBuffer(i.buffer,i.byteOffset,i.byteLength,s.is32Bits,null!=t&&t)),s}createVertexBuffer(e,t){const i=ArrayBuffer.isView(e)?e:new Float32Array(e),s=new ss;return s.references=1,i.byteLength&&(s.nativeVertexBuffer=this._engine.createVertexBuffer(i.buffer,i.byteOffset,i.byteLength,null!=t&&t)),s}_recordVertexArrayObject(e,t,i,s,r){i&&this._engine.recordIndexBuffer(e,i.nativeIndexBuffer);const n=s.getAttributesNames();for(let i=0;i<n.length;i++){const o=s.getAttributeLocation(i);if(o>=0){const s=n[i];let a=null;if(r&&(a=r[s]),a||(a=t[s]),a){const t=a.getBuffer();t&&t.nativeVertexBuffer&&this._engine.recordVertexBuffer(e,t.nativeVertexBuffer,o,a.byteOffset,a.byteStride,a.getSize(),this._getNativeAttribType(a.type),a.normalized,a.getInstanceDivisor())}}}}bindBuffers(e,t,i){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,e,t,i),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(e,t,i,s){const r=this._engine.createVertexArray();return this._recordVertexArrayObject(r,e,t,i,s),r}_deleteVertexArray(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(e){this._deleteVertexArray(e)}getAttributes(e,t){const i=e;return this._engine.getAttributes(i.nativeProgram,t)}drawElementsType(e,t,i,s){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand()}drawArraysType(e,t,i,s){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand()}createPipelineContext(){return new Ki.G(this)}createMaterialContext(){}createDrawContext(){}_preparePipelineContext(e,t,i,s,r,n,o,a){e.nativeProgram=s?this.createRawShaderProgram():this.createShaderProgram(e,t,i,a)}isAsync(e){return!(!e.isAsync||!this._engine.createProgramAsync)}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(!this.isAsync(e))return void t();const s=i.onCompiled;i.onCompiled=s?()=>{s(),t()}:t}createRawShaderProgram(){throw new Error("Not Supported")}createShaderProgram(e,t,i,s){const r=e;if(r.nativeProgram)throw new Error("Tried to create a second program in the same NativePipelineContext");this.onBeforeShaderCompilationObservable.notifyObservers(this);const n=new Xi.Z(t);n.processCode(),t=n.code;const o=new Xi.Z(i);o.processCode(),i=o.code,t=Ii.B._ConcatenateShader(t,s),i=Ii.B._ConcatenateShader(i,s);const a=()=>{var e;r.isCompiled=!0,null===(e=r.onCompiled)||void 0===e||e.call(r),this.onAfterShaderCompilationObservable.notifyObservers(this)};if(this.isAsync(e))return this._engine.createProgramAsync(t,i,a,(e=>{r.compilationError=e}));try{const e=r.nativeProgram=this._engine.createProgram(t,i);return a(),e}catch(e){const t=null==e?void 0:e.message;throw new Error("SHADER ERROR"+("string"==typeof t?"\n"+t:""))}}inlineShaderCode(e){const t=new Xi.Z(e);return t.debug=!1,t.processCode(),t.code}_setProgram(e){this._currentProgram!==e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=e)}_deletePipelineContext(e){const t=e;t&&t.nativeProgram&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeProgram),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(e,t){const i=e;return this._engine.getUniforms(i.nativeProgram,t)}bindUniformBlock(e,t,i){throw new Error("Not Implemented")}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.nativeProgram);const i=e.getSamplers();for(let t=0;t<i.length;t++){const s=e.getUniform(i[t]);s&&(this._boundUniforms[t]=s)}this._currentEffect=null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(e,t,i){this._cachedViewport=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.x),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.y),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.width),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.height),this._commandBufferEncoder.finishEncodingCommand()}enableScissor(e,t,i,s){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand()}disableScissor(){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.finishEncodingCommand()}setState(e,t=0,i,s=!1,r,n,o=0){var a,h;this._zOffset=t,this._zOffsetUnits=o,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(o),this._commandBufferEncoder.encodeCommandArgAsUInt32(null===(h=null!==(a=this.cullBackFaces)&&void 0!==a?a:r)||void 0===h||h?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(s?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(e){e!==this._zOffset&&(this._zOffset=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(e){e!==this._zOffsetUnits&&(this._zOffsetUnits=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(e){let t=0;switch(e){case 512:t=_native.Engine.DEPTH_TEST_NEVER;break;case 519:t=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:t=_native.Engine.DEPTH_TEST_GREATER;break;case 518:t=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:t=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:t=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:t=_native.Engine.DEPTH_TEST_LESS;break;case 515:t=_native.Engine.DEPTH_TEST_LEQUAL}this._currentDepthTest=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(e){this._depthWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(e){this._colorWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,this._getStencilOpFail(this._stencilOpStencilFail),this._getStencilDepthFail(this._stencilOpDepthFail),this._getStencilDepthPass(this._stencilOpStencilDepthPass),this._getStencilFunc(this._stencilFunc),this._stencilFuncRef)}_setStencil(e,t,i,s,r,n){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(e){this._stencilTest=e,e?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(e){this._stencilOpStencilDepthPass=e,this.applyStencil()}setStencilMask(e){this._stencilMask=e,this.applyStencil()}setStencilFunction(e){this._stencilFunc=e,this.applyStencil()}setStencilFunctionReference(e){this._stencilFuncRef=e,this.applyStencil()}setStencilFunctionMask(e){this._stencilFuncMask=e}setStencilOperationFail(e){this._stencilOpStencilFail=e,this.applyStencil()}setStencilOperationDepthFail(e){this._stencilOpDepthFail=e,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(e,t,i,s){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(e,t=!1){if(this._alphaMode===e)return;const i=this._getNativeAlphaMode(e);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t||this.setDepthWrite(0===e),this._alphaMode=e}getAlphaMode(){return this._alphaMode}setInt(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray4(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray4(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setArray(e,t){return!!e&&this.setFloatArray(e,new Float32Array(t))}setArray2(e,t){return!!e&&this.setFloatArray2(e,new Float32Array(t))}setArray3(e,t){return!!e&&this.setFloatArray3(e,new Float32Array(t))}setArray4(e,t){return!!e&&this.setFloatArray4(e,new Float32Array(t))}setMatrices(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix3x3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix2x2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat2(e,t,i){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat3(e,t,i,s){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat4(e,t,i,s,r){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand(),!0)}setColor3(e,t){return!!e&&(this.setFloat3(e,t.r,t.g,t.b),!0)}setColor4(e,t,i){return!!e&&(this.setFloat4(e,t.r,t.g,t.b,i),!0)}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(e){e&&this._engine.deleteTexture(e)}updateDynamicTexture(e,t,i,s=!1,r){if(void 0===s&&(s=!1),e&&e._hardwareTexture){const i=t.getCanvasTexture(),s=e._hardwareTexture.underlyingResource;this._engine.copyTexture(s,i),e.isReady=!0}}createDynamicTexture(e,t,i,s){return e=Math.max(e,1),t=Math.max(t,1),this.createRawTexture(new Uint8Array(e*t*4),e,t,5,!1,!1,s)}createVideoElement(e){return this._camera?this._camera.createVideo(e):null}updateVideoTexture(e,t,i){if(e&&e._hardwareTexture&&this._camera){const s=e._hardwareTexture.underlyingResource;this._camera.updateVideoTexture(s,t,i)}}createRawTexture(e,t,i,s,r,n,o,a=null,h=0,l=0,c=!1){const u=new Oi.l(this,Oi.S.Raw);if(u.format=s,u.generateMipMaps=r,u.samplingMode=o,u.invertY=n,u.baseWidth=t,u.baseHeight=i,u.width=u.baseWidth,u.height=u.baseHeight,u._compression=a,u.type=h,u._useSRGBBuffer=this._getUseSRGBBuffer(c,!r),this.updateRawTexture(u,e,s,n,a,h,u._useSRGBBuffer),u._hardwareTexture){const e=u._hardwareTexture.underlyingResource,t=this._getNativeSamplingMode(o);this._setTextureSampling(e,t)}return this._internalTexturesCache.push(u),u}createRawTexture2DArray(e,t,i,s,r,n,o,a,h=null,l=0){const c=new Oi.l(this,Oi.S.Raw2DArray);if(c.baseWidth=t,c.baseHeight=i,c.baseDepth=s,c.width=t,c.height=i,c.depth=s,c.format=r,c.type=l,c.generateMipMaps=n,c.samplingMode=a,c.is2DArray=!0,c._hardwareTexture){const h=c._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(h,e,t,i,s,this._getNativeTextureFormat(r,l),n,o);const u=this._getNativeSamplingMode(a);this._setTextureSampling(h,u)}return c.isReady=!0,this._internalTexturesCache.push(c),c}updateRawTexture(e,t,i,s,r=null,n=0,o=!1){if(e){if(t&&e._hardwareTexture){const s=e._hardwareTexture.underlyingResource;this._engine.loadRawTexture(s,t,e.width,e.height,this._getNativeTextureFormat(i,n),e.generateMipMaps,e.invertY)}e.isReady=!0}}createTexture(e,t,i,s,r=3,n=null,o=null,a=null,h=null,l=null,c=null,u,d,_,g=!1){const m="data:"===(e=e||"").substr(0,5),f=m&&-1!==e.indexOf(";base64,"),b=h||new Oi.l(this,Oi.S.Url),v=e;!this._transformTextureUrl||f||h||a||(e=this._transformTextureUrl(e));const y=e.lastIndexOf("."),x=c||(y>-1?e.substring(y).toLowerCase():"");let P=null;for(const e of O.D._TextureLoaders)if(e.canLoad(x)){P=e;break}s&&s.addPendingData(b),b.url=e,b.generateMipMaps=!t,b.samplingMode=r,b.invertY=i,b._useSRGBBuffer=this._getUseSRGBBuffer(g,t),this.doNotHandleContextLost||(b._buffer=a);let C=null;n&&!h&&(C=b.onLoadedObservable.add(n)),h||this._internalTexturesCache.push(b);const T=(i,h)=>{s&&s.removePendingData(b),e===v?(C&&b.onLoadedObservable.remove(C),D.l.UseFallbackTexture&&this.createTexture(D.l.FallbackTexture,t,b.invertY,s,r,null,o,a,b),o&&o((i||"Unknown error")+(D.l.UseFallbackTexture?" - Fallback texture was used":""),h)):(p.Y.Warn(`Failed to load ${e}, falling back to ${v}`),this.createTexture(v,t,b.invertY,s,r,n,o,a,b,l,c,u,d))};if(P)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{const n=e=>{if(!b._hardwareTexture)return void(s&&s.removePendingData(b));const n=b._hardwareTexture.underlyingResource;this._engine.loadTexture(n,e,!t,i,b._useSRGBBuffer,(()=>{b.baseWidth=this._engine.getTextureWidth(n),b.baseHeight=this._engine.getTextureHeight(n),b.width=b.baseWidth,b.height=b.baseHeight,b.isReady=!0;const e=this._getNativeSamplingMode(r);this._setTextureSampling(n,e),s&&s.removePendingData(b),b.onLoadedObservable.notifyObservers(b),b.onLoadedObservable.clear()}),(()=>{throw new Error("Could not load a native texture.")}))};if(m&&a)if(a instanceof ArrayBuffer)n(new Uint8Array(a));else if(ArrayBuffer.isView(a))n(a);else{if("string"!=typeof a)throw new Error("Unsupported buffer type");n(new Uint8Array(w.w1.DecodeBase64(a)))}else f?n(new Uint8Array(w.w1.DecodeBase64(e))):this._loadFile(e,(e=>n(new Uint8Array(e))),void 0,void 0,!0,((e,t)=>{T("Unable to load "+(e&&e.responseURL,t))}))}return b}wrapNativeTexture(e,t=!1,i=3){const s=new Ji.E(e,this._engine),r=new Oi.l(this,Oi.S.Unknown,!0);return r._hardwareTexture=s,r.isReady=!0,r.useMipMaps=t,this.updateTextureSamplingMode(i,r),r}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(e,t,i){var s,r;const n=t.generateStencil||!1,o=t.samples||1,a=i,h=new Oi.l(this,Oi.S.DepthStencil),l=null!==(s=e.width)&&void 0!==s?s:e,c=null!==(r=e.height)&&void 0!==r?r:e,u=this._engine.createFrameBuffer(h._hardwareTexture.underlyingResource,l,c,n,!0,o);return a._framebufferDepthStencil=u,h}_releaseFramebufferObjects(e){e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_createImageBitmapFromSource(e,t){const i=new Promise(((t,i)=>{const s=this.createCanvasImage();s.onload=()=>{try{const e=this._engine.createImageBitmap(s);t(e)}catch(e){i(`Error loading image ${s.src} with exception: ${e}`)}},s.onerror=e=>{i(`Error loading image ${s.src} with exception: ${e}`)},s.src=e}));return i}createImageBitmap(e,t){return new Promise(((t,i)=>{if(Array.isArray(e)){const i=e;if(i.length){const e=this._engine.createImageBitmap(i[0]);if(e)return void t(e)}}i("Unsupported data for createImageBitmap.")}))}resizeImageBitmap(e,t,i){return this._engine.resizeImageBitmap(e,t,i)}createCubeTexture(e,t,i,s,r=null,n=null,o,a=null,h=!1,l=0,c=0,u=null,d,p=!1){const _=u||new Oi.l(this,Oi.S.Cube);_.isCube=!0,_.url=e,_.generateMipMaps=!s,_._lodGenerationScale=l,_._lodGenerationOffset=c,_._useSRGBBuffer=this._getUseSRGBBuffer(p,!!s),this._doNotHandleContextLost||(_._extension=a,_._files=i);const g=e.lastIndexOf(".");if(".env"===(a||(g>-1?e.substring(g).toLowerCase():""))){const t=e=>{const t=(0,Yi.qJ)(e);_.width=t.width,_.height=t.width,(0,Yi.qC)(_,t);const i=t.specular;if(!i)throw new Error("Nothing else parsed so far");_._lodGenerationScale=i.lodGenerationScale;const s=(0,Yi.Do)(e,t);_.format=5,_.type=0,_.generateMipMaps=!0,_.getEngine().updateTextureSamplingMode(X.x.TRILINEAR_SAMPLINGMODE,_),_._isRGBD=!0,_.invertY=!0,this._engine.loadCubeTextureWithMips(_._hardwareTexture.underlyingResource,s,!1,_._useSRGBBuffer,(()=>{_.isReady=!0,r&&r()}),(()=>{throw new Error("Could not load a native cube texture.")}))};if(i&&6===i.length)throw new Error("Multi-file loading not allowed on env files.");{const i=(e,t)=>{n&&e&&n(e.status+" "+e.statusText,t)};this._loadFile(e,(e=>t(new Uint8Array(e))),void 0,void 0,!0,i)}}else{if(!i||6!==i.length)throw new Error("Cannot load cubemap because 6 files were not defined");const e=[i[0],i[3],i[1],i[4],i[2],i[5]];Promise.all(e.map((e=>w.w1.LoadFileAsync(e).then((e=>new Uint8Array(e)))))).then((e=>new Promise(((t,i)=>{this._engine.loadCubeTexture(_._hardwareTexture.underlyingResource,e,!s,!0,_._useSRGBBuffer,t,i)})))).then((()=>{_.isReady=!0,r&&r()}),(e=>{n&&n(`Failed to load cubemap: ${e.message}`,e)}))}return this._internalTexturesCache.push(_),_}_createHardwareTexture(){return new Ji.E(this._createTexture(),this._engine)}_createHardwareRenderTargetWrapper(e,t,i){const s=new Zi.o(e,t,i,this);return this._renderTargetWrapperCache.push(s),s}_createInternalTexture(e,t,i=!0,s=Oi.S.Unknown){var r,n,o;let a,h=!1,l=0,c=3,u=5,d=!1,_=1;void 0!==t&&"object"==typeof t?(h=!!t.generateMipMaps,l=void 0===t.type?0:t.type,c=void 0===t.samplingMode?3:t.samplingMode,u=void 0===t.format?5:t.format,d=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer,_=null!==(r=t.samples)&&void 0!==r?r:1,a=t.label):h=!!t,d=this._getUseSRGBBuffer(d,!h),(1!==l||this._caps.textureFloatLinearFiltering)&&(2!==l||this._caps.textureHalfFloatLinearFiltering)||(c=1),1!==l||this._caps.textureFloat||(l=0,p.Y.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const g=new Oi.l(this,s),m=null!==(n=e.width)&&void 0!==n?n:e,f=null!==(o=e.height)&&void 0!==o?o:e,b=e.layers||0;if(0!==b)throw new Error("Texture layers are not supported in Babylon Native");const v=g._hardwareTexture.underlyingResource,y=this._getNativeTextureFormat(u,l);return this._engine.initializeTexture(v,m,f,h,y,!0,d,_),this._setTextureSampling(v,this._getNativeSamplingMode(c)),g._useSRGBBuffer=d,g.baseWidth=m,g.baseHeight=f,g.width=m,g.height=f,g.depth=b,g.isReady=!0,g.samples=_,g.generateMipMaps=h,g.samplingMode=c,g.type=l,g.format=u,g.label=a,this._internalTexturesCache.push(g),g}createRenderTargetTexture(e,t){var i,s,r,n;const o=this._createHardwareRenderTargetWrapper(!1,!1,e);let a,h=!0,l=!1,c=!1,u=1;void 0!==t&&"object"==typeof t&&(h=null===(i=t.generateDepthBuffer)||void 0===i||i,l=!!t.generateStencilBuffer,c=!!t.noColorAttachment,a=t.colorAttachment,u=null!==(s=t.samples)&&void 0!==s?s:1);const d=a||(c?null:this._createInternalTexture(e,t,!0,Oi.S.RenderTarget)),p=null!==(r=e.width)&&void 0!==r?r:e,_=null!==(n=e.height)&&void 0!==n?n:e,g=this._engine.createFrameBuffer(d?d._hardwareTexture.underlyingResource:null,p,_,l,h,u);return o._framebuffer=g,o._generateDepthBuffer=h,o._generateStencilBuffer=l,o._samples=u,o.setTextures(d),o}updateRenderTargetTextureSampleCount(e,t){return p.Y.Warn("Updating render target sample count is not currently supported"),e.samples}updateTextureSamplingMode(e,t){if(t._hardwareTexture){const i=this._getNativeSamplingMode(e);this._setTextureSampling(t._hardwareTexture.underlyingResource,i)}t.samplingMode=e}bindFramebuffer(e,t,i,s,r){const n=e;if(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,t)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(i||s)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");n._framebufferDepthStencil?this._bindUnboundFramebuffer(n._framebufferDepthStencil):this._bindUnboundFramebuffer(n._framebuffer)}unBindFramebuffer(e,t=!1,i){this._currentRenderTarget=null,i&&i(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(e){return this.createVertexBuffer(e,!0)}updateDynamicIndexBuffer(e,t,i=0){const s=e,r=this._normalizeIndexData(t);s.is32Bits=4===r.BYTES_PER_ELEMENT,this._engine.updateDynamicIndexBuffer(s.nativeIndexBuffer,r.buffer,r.byteOffset,r.byteLength,i)}updateDynamicVertexBuffer(e,t,i,s){const r=e,n=ArrayBuffer.isView(t)?t:new Float32Array(t);this._engine.updateDynamicVertexBuffer(r.nativeVertexBuffer,n.buffer,n.byteOffset+(null!=i?i:0),null!=s?s:n.byteLength)}_setTexture(e,t,i=!1,s=!1){const r=this._boundUniforms[e];if(!r)return!1;if(!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._boundTexturesCache[e]=null),!1;if(t.video)this._activeChannel=e,t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;let n;return n=s?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,this._activeChannel=e,!(!n||!n._hardwareTexture||(this._setTextureWrapMode(n._hardwareTexture.underlyingResource,this._getAddressMode(t.wrapU),this._getAddressMode(t.wrapV),this._getAddressMode(t.wrapR)),this._updateAnisotropicLevel(t),this._setTextureCore(r,n._hardwareTexture.underlyingResource),0))}_setTextureSampling(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(e,t,i,s){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.finishEncodingCommand()}_setTextureCore(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}_updateAnisotropicLevel(e){const t=e.getInternalTexture(),i=e.anisotropicFilteringLevel;t&&t._hardwareTexture&&t._cachedAnisotropicFilteringLevel!==i&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(t._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t._cachedAnisotropicFilteringLevel=i)}_getAddressMode(e){switch(e){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+e+".")}}_bindTexture(e,t){const i=this._boundUniforms[e];if(i&&t&&t._hardwareTexture){const e=t._hardwareTexture.underlyingResource;this._setTextureCore(i,e)}}_deleteBuffer(e){e.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeIndexBuffer),e.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeVertexBuffer)}createCanvas(e,t){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");const i=new _native.Canvas;return i.width=e,i.height=t,i}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}updateTextureData(e,t,i,s,r,n,o=0,a=0,h=!1){throw new Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,o=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(e,t,i=0,s=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(e,t,i=0,s=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_getNativeSamplingMode(e){switch(e){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${e}.`)}}_getStencilFunc(e){switch(e){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${e}.`)}}_getStencilOpFail(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${e}.`)}}_getStencilDepthFail(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${e}.`)}}_getStencilDepthPass(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${e}.`)}}_getNativeTextureFormat(e,t){if(4==e&&0==t)return _native.Engine.TEXTURE_FORMAT_RGB8;if(5==e&&0==t)return _native.Engine.TEXTURE_FORMAT_RGBA8;if(5==e&&2==t)return _native.Engine.TEXTURE_FORMAT_RGBA16F;if(5==e&&1==t)return _native.Engine.TEXTURE_FORMAT_RGBA32F;throw new qi.LH(`Unsupported texture format or type: format ${e}, type ${t}.`,qi.SM.UnsupportedTextureError)}_getNativeAlphaMode(e){switch(e){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${e}.`)}}_getNativeAttribType(e){switch(e){case me.o.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case me.o.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case me.o.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case me.o.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case me.o.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${e}.`)}}getFontOffset(e){return{ascent:0,height:0,descent:0}}_readTexturePixels(e,t,i,s,r,n,o,a,h,l){var c,u,d,p;if(void 0!==s&&-1!==s)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${s}.`);return this._engine.readTexture(null===(c=e._hardwareTexture)||void 0===c?void 0:c.underlyingResource,null!=r?r:0,null!=h?h:0,null!=l?l:0,t,i,null!==(u=null==n?void 0:n.buffer)&&void 0!==u?u:null,null!==(d=null==n?void 0:n.byteOffset)&&void 0!==d?d:0,null!==(p=null==n?void 0:n.byteLength)&&void 0!==p?p:0).then((e=>(n||(n=new Uint8Array(e)),n)))}}ns.PROTOCOL_VERSION=8,ns._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new os:new $i.e};class os extends $i.e{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}i(15209),i(33290),i(53803);var as=i(81654),hs=i(85747),ls=i(68437),cs=i(57346),us=i(51222),ds=i(2394),ps=i(16478),_s=i(57722),gs=i(64564),ms=i(59157);i(78821);class fs{static CreateAsync(e,t){return cs.f.IsSupportedAsync.then((i=>i?cs.f.CreateAsync(e,t):O.D.IsSupported?new Promise((i=>{i(new O.D(e,void 0,t))})):new Promise((e=>{e(new Fi(t))}))))}}i(15317),i(27962);var bs=i(43127),vs=(i(62836),i(26233)),ys=i(48635),xs=i(96485),Ps=i(86409);class Cs extends Et.T{constructor(e){super(e),this.controllerType=St.wc.DAYDREAM}initControllerMesh(e,t){Ps.n.ImportMesh("",Cs.MODEL_BASE_URL,Cs.MODEL_FILENAME,e,(e=>{this._defaultModel=e[1],this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)}))}_handleButtonChange(e,t){if(0===e){const e=this.onTriggerStateChangedObservable;e&&e.notifyObservers(t)}else p.Y.Warn(`Unrecognized Daydream button index: ${e}`)}}Cs.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",Cs.MODEL_FILENAME="generic.babylon",Cs.GAMEPAD_ID_PREFIX="Daydream",St.zn._ControllerFactories.push({canCreate:e=>0===e.id.indexOf(Cs.GAMEPAD_ID_PREFIX),create:e=>new Cs(e)});class Ts extends Et.T{constructor(e){super(e),this._buttonIndexToObservableNameMap=["onPadStateChangedObservable","onTriggerStateChangedObservable"],this.controllerType=St.wc.GEAR_VR,this._calculatedPosition=new m.P("left"==this.hand?-.15:.15,-.5,.25),this._disableTrackPosition(this._calculatedPosition)}initControllerMesh(e,t){Ps.n.ImportMesh("",Ts.MODEL_BASE_URL,Ts.MODEL_FILENAME,e,(i=>{const s=new Mt.Kj("",e);i[1].parent=s,i[1].position.z=-.15,this._defaultModel=s,this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)}))}_handleButtonChange(e,t){if(e<this._buttonIndexToObservableNameMap.length){const i=this[this._buttonIndexToObservableNameMap[e]];i&&i.notifyObservers(t)}}}Ts.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/",Ts.MODEL_FILENAME="generic.babylon",Ts.GAMEPAD_ID_PREFIX="Gear VR",St.zn._ControllerFactories.push({canCreate:e=>0===e.id.indexOf(Ts.GAMEPAD_ID_PREFIX)||-1!==e.id.indexOf("Oculus Go")||-1!==e.id.indexOf("Vive Focus"),create:e=>new Ts(e)});var Ss=i(83870);class Es extends Et.T{constructor(e){super(e),this.onSecondaryTriggerStateChangedObservable=new _.y$,this.onThumbRestChangedObservable=new _.y$,this.controllerType=St.wc.OCULUS}initControllerMesh(e,t){let i;i="left"===this.hand?Es.MODEL_LEFT_FILENAME:Es.MODEL_RIGHT_FILENAME,Ps.n.ImportMesh("",Es._IsQuest?Es.QUEST_MODEL_BASE_URL:Es.MODEL_BASE_URL,i,e,(e=>{this._defaultModel=Es._IsQuest?e[0]:e[1],this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)}))}get onAButtonStateChangedObservable(){if("right"===this.hand)return this.onMainButtonStateChangedObservable;throw new Error("No A button on left hand")}get onBButtonStateChangedObservable(){if("right"===this.hand)return this.onSecondaryButtonStateChangedObservable;throw new Error("No B button on left hand")}get onXButtonStateChangedObservable(){if("left"===this.hand)return this.onMainButtonStateChangedObservable;throw new Error("No X button on right hand")}get onYButtonStateChangedObservable(){if("left"===this.hand)return this.onSecondaryButtonStateChangedObservable;throw new Error("No Y button on right hand")}_handleButtonChange(e,t){const i=t,s="right"===this.hand?-1:1;switch(e){case 0:return void this.onPadStateChangedObservable.notifyObservers(i);case 1:return!Es._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[3].rotation.x=.2*-i.value,this._defaultModel.getChildren()[3].position.y=.005*-i.value,this._defaultModel.getChildren()[3].position.z=.005*-i.value),void this.onTriggerStateChangedObservable.notifyObservers(i);case 2:return!Es._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[4].position.x=s*i.value*.0035),void this.onSecondaryTriggerStateChangedObservable.notifyObservers(i);case 3:return!Es._IsQuest&&this._defaultModel&&(i.pressed?this._defaultModel.getChildren()[1].position.y=-.001:this._defaultModel.getChildren()[1].position.y=0),void this.onMainButtonStateChangedObservable.notifyObservers(i);case 4:return!Es._IsQuest&&this._defaultModel&&(i.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),void this.onSecondaryButtonStateChangedObservable.notifyObservers(i);case 5:return void this.onThumbRestChangedObservable.notifyObservers(i)}}}Es.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",Es.MODEL_LEFT_FILENAME="left.babylon",Es.MODEL_RIGHT_FILENAME="right.babylon",Es.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",Es._IsQuest=!1,St.zn._ControllerFactories.push({canCreate:e=>(D.l.LastCreatedEngine&&D.l.LastCreatedEngine._vrDisplay&&"Oculus Quest"===D.l.LastCreatedEngine._vrDisplay.displayName&&(Es._IsQuest=!0),-1!==e.id.indexOf("Oculus Touch")),create:e=>new Es(e)});class Rs extends Et.T{constructor(e){super(e),this.controllerType=St.wc.VIVE,this._invertLeftStickY=!0}initControllerMesh(e,t){Ps.n.ImportMesh("",Rs.MODEL_BASE_URL,Rs.MODEL_FILENAME,e,(e=>{this._defaultModel=e[1],this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)}))}get onLeftButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onRightButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onMenuButtonStateChangedObservable(){return this.onSecondaryButtonStateChangedObservable}_handleButtonChange(e,t){const i=t;switch(e){case 0:return void this.onPadStateChangedObservable.notifyObservers(i);case 1:return this._defaultModel&&(this._defaultModel.getChildren()[6].rotation.x=.15*-i.value),void this.onTriggerStateChangedObservable.notifyObservers(i);case 2:return void this.onMainButtonStateChangedObservable.notifyObservers(i);case 3:return this._defaultModel&&(i.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),void this.onSecondaryButtonStateChangedObservable.notifyObservers(i)}}}Rs.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",Rs.MODEL_FILENAME="wand.babylon",St.zn._ControllerFactories.push({canCreate:e=>-1!==e.id.toLowerCase().indexOf("openvr"),create:e=>new Rs(e)});class Ms{constructor(){this.buttonMeshes={},this.axisMeshes={}}}class As extends Et.T{constructor(e){super(e),this._mapping={buttons:["thumbstick","trigger","grip","menu","trackpad"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onPadStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["THUMBSTICK_X","THUMBSTICK_Y","TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y"],pointingPoseMeshName:St.K4.POINTING_POSE},this.onTrackpadChangedObservable=new _.y$,this.onTrackpadValuesChangedObservable=new _.y$,this.trackpad={x:0,y:0},this.controllerType=St.wc.WINDOWS,this._loadedMeshInfo=null}get onTriggerButtonStateChangedObservable(){return this.onTriggerStateChangedObservable}get onMenuButtonStateChangedObservable(){return this.onSecondaryButtonStateChangedObservable}get onGripButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onThumbstickButtonStateChangedObservable(){return this.onPadStateChangedObservable}get onTouchpadButtonStateChangedObservable(){return this.onTrackpadChangedObservable}get onTouchpadValuesChangedObservable(){return this.onTrackpadValuesChangedObservable}_updateTrackpad(){!this.browserGamepad.axes||this.browserGamepad.axes[2]==this.trackpad.x&&this.browserGamepad.axes[3]==this.trackpad.y||(this.trackpad.x=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_X")],this.trackpad.y=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_Y")],this.onTrackpadValuesChangedObservable.notifyObservers(this.trackpad))}update(){if(super.update(),this.browserGamepad.axes&&(this._updateTrackpad(),this._loadedMeshInfo))for(let e=0;e<this._mapping.axisMeshNames.length;e++)this._lerpAxisTransform(e,this.browserGamepad.axes[e])}_handleButtonChange(e,t){const i=this._mapping.buttons[e];if(!i)return;this._updateTrackpad();const s=this[this._mapping.buttonObservableNames[i]];s&&s.notifyObservers(t),this._lerpButtonTransform(i,t.value)}_lerpButtonTransform(e,t){if(!this._loadedMeshInfo)return;const i=this._loadedMeshInfo.buttonMeshes[e];i&&i.unpressed.rotationQuaternion&&i.pressed.rotationQuaternion&&i.value.rotationQuaternion&&(m._f.SlerpToRef(i.unpressed.rotationQuaternion,i.pressed.rotationQuaternion,t,i.value.rotationQuaternion),m.P.LerpToRef(i.unpressed.position,i.pressed.position,t,i.value.position))}_lerpAxisTransform(e,t){if(!this._loadedMeshInfo)return;const i=this._loadedMeshInfo.axisMeshes[e];if(!i)return;if(!i.min.rotationQuaternion||!i.max.rotationQuaternion||!i.value.rotationQuaternion)return;const s=.5*t+.5;m._f.SlerpToRef(i.min.rotationQuaternion,i.max.rotationQuaternion,s,i.value.rotationQuaternion),m.P.LerpToRef(i.min.position,i.max.position,s,i.value.position)}initControllerMesh(e,t,i=!1){let s,r;if(Ps.n.IsPluginForExtensionAvailable(".glb")){let e="default";if(this.id&&!i){const t=this.id.match(As.GAMEPAD_ID_PATTERN);e=t&&t[0]||e}r="left"===this.hand?As.MODEL_LEFT_FILENAME:As.MODEL_RIGHT_FILENAME,s=As.MODEL_BASE_URL+e+"/"}else p.Y.Warn("You need to reference GLTF loader to load Windows Motion Controllers model. Falling back to generic models"),s=Ss.M.MODEL_BASE_URL,r=Ss.M.MODEL_FILENAME;Ps.n.ImportMesh("",s,r,e,(i=>{this._loadedMeshInfo=this._processModel(e,i),this._loadedMeshInfo&&(this._defaultModel=this._loadedMeshInfo.rootNode,this.attachToMesh(this._defaultModel),t&&t(this._defaultModel))}),null,((e,n)=>{p.Y.Log(n),p.Y.Warn("Failed to retrieve controller model from the remote server: "+s+r),i||this.initControllerMesh(e,t,!0)}))}_processModel(e,t){let i=null;const s=new Mt.Kj(this.id+" "+this.hand,e);let r=null;for(let e=0;e<t.length;e++){const i=t[e];if(!i.parent){i.isPickable=!1,r=i;break}}return r?(r.setParent(s),i=this._createMeshInfo(s)):p.Y.Warn("Could not find root node in model file."),i}_createMeshInfo(e){const t=new Ms;let i;for(t.rootNode=e,t.buttonMeshes={},t.axisMeshes={},i=0;i<this._mapping.buttons.length;i++){const n=this._mapping.buttonMeshNames[this._mapping.buttons[i]];if(!n){p.Y.Log("Skipping unknown button at index: "+i+" with mapped name: "+this._mapping.buttons[i]);continue}const o=s(e,n);if(!o){p.Y.Warn("Missing button mesh with name: "+n);continue}const a={index:i,value:r(o,"VALUE"),pressed:r(o,"PRESSED"),unpressed:r(o,"UNPRESSED")};a.value&&a.pressed&&a.unpressed?t.buttonMeshes[this._mapping.buttons[i]]=a:p.Y.Warn("Missing button submesh under mesh with name: "+n+"(VALUE: "+!!a.value+", PRESSED: "+!!a.pressed+", UNPRESSED:"+!!a.unpressed+")")}for(i=0;i<this._mapping.axisMeshNames.length;i++){const n=this._mapping.axisMeshNames[i];if(!n){p.Y.Log("Skipping unknown axis at index: "+i);continue}const o=s(e,n);if(!o){p.Y.Warn("Missing axis mesh with name: "+n);continue}const a={index:i,value:r(o,"VALUE"),min:r(o,"MIN"),max:r(o,"MAX")};a.value&&a.min&&a.max?t.axisMeshes[i]=a:p.Y.Warn("Missing axis submesh under mesh with name: "+n+"(VALUE: "+!!a.value+", MIN: "+!!a.min+", MAX:"+!!a.max+")")}return t.pointingPoseNode=s(e,this._mapping.pointingPoseMeshName),t.pointingPoseNode?this._pointingPoseNode=t.pointingPoseNode:p.Y.Warn("Missing pointing pose mesh with name: "+this._mapping.pointingPoseMeshName),t;function s(e,t){return e.getChildren((e=>e.name===t),!1)[0]}function r(e,t){return e.getChildren((e=>e.name==t),!0)[0]}}getForwardRay(e=100){if(!this._loadedMeshInfo||!this._loadedMeshInfo.pointingPoseNode)return super.getForwardRay(e);const t=this._loadedMeshInfo.pointingPoseNode.getWorldMatrix(),i=t.getTranslation(),s=new m.P(0,0,-1),r=m.P.TransformNormal(s,t),n=m.P.Normalize(r);return new At.z(i,n,e)}dispose(){super.dispose(),this.onTrackpadChangedObservable.clear(),this.onTrackpadValuesChangedObservable.clear()}}As.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",As.MODEL_LEFT_FILENAME="left.glb",As.MODEL_RIGHT_FILENAME="right.glb",As.GAMEPAD_ID_PREFIX="Spatial Controller (Spatial Interaction Source) ",As.GAMEPAD_ID_PATTERN=/([0-9a-zA-Z]+-[0-9a-zA-Z]+)$/;class Is extends As{constructor(e){super(e),this._mapping={buttons:["trigger","grip","trackpad","thumbstick","menu"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onThumbstickStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y","THUMBSTICK_X","THUMBSTICK_Y"],pointingPoseMeshName:St.K4.POINTING_POSE},this.thumbstickValues={x:0,y:0},this.onThumbstickStateChangedObservable=new _.y$,this.onThumbstickValuesChangedObservable=new _.y$,this.onTrackpadChangedObservable=this.onPadStateChangedObservable,this.onTrackpadValuesChangedObservable=this.onPadValuesChangedObservable}get onThumbstickButtonStateChangedObservable(){return this.onThumbstickStateChangedObservable}_updateTrackpad(){!this.browserGamepad.axes||this.browserGamepad.axes[2]==this.thumbstickValues.x&&this.browserGamepad.axes[3]==this.thumbstickValues.y||(this.trackpad.x=this.browserGamepad.axes[2],this.trackpad.y=this.browserGamepad.axes[3],this.onThumbstickValuesChangedObservable.notifyObservers(this.trackpad))}dispose(){super.dispose(),this.onThumbstickStateChangedObservable.clear(),this.onThumbstickValuesChangedObservable.clear()}}St.zn._ControllerFactories.push({canCreate:e=>0===e.id.indexOf(As.GAMEPAD_ID_PREFIX),create:e=>new As(e)});var Os=i(54098),ws=i(98350);class Ds extends ni.tb{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}constructor(e,t=g.Wo.Gray(),i=oi.x.DefaultUtilityLayer,s=null,r=1){var n,o,a,h,l,c,u;super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new _.y$,this.uniformScaling=!1,this.sensitivity=1,this.dragScale=1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._tmpVector=new m.P(0,0,0),this._parent=s,this._coloredMaterial=new Ot.K("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new g.Wo(.1,.1,.1)),this._hoverMaterial=new Ot.K("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=g.Wo.Yellow(),this._disableMaterial=new Ot.K("",i.utilityLayerScene),this._disableMaterial.diffuseColor=g.Wo.Gray(),this._disableMaterial.alpha=.4,this._gizmoMesh=new Mt.Kj("axis",i.utilityLayerScene);const{arrowMesh:d,arrowTail:p}=this._createGizmoMesh(this._gizmoMesh,r),f=this._createGizmoMesh(this._gizmoMesh,r+4,!0);this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,ni.tb.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3);const b=d.position.clone(),v=p.position.clone(),y=p.scaling.clone(),x=e=>{const t=e*(3/this._rootMesh.scaling.length())*6;d.position.z+=t/3.5,p.scaling.y+=t,this.dragScale=p.scaling.y,p.position.z=d.position.z/2},P=()=>{d.position.set(b.x,b.y,b.z),p.position.set(v.x,v.y,v.z),p.scaling.set(y.x,y.y,y.z),this.dragScale=p.scaling.y,this._dragging=!1};this.dragBehavior=new se.M({dragAxis:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior);let C=0;const T={snapDistance:0};this.dragBehavior.onDragObservable.add((t=>{if(this.attachedNode){this._handlePivot();const i=this.sensitivity*t.dragDistance*(3*this.scaleRatio/this._rootMesh.scaling.length()),s=this._tmpVector;let r=!1,n=0;this.uniformScaling?s.setAll(.57735):s.copyFrom(e),0==this.snapDistance?s.scaleToRef(i,s):(C+=i,Math.abs(C)>this.snapDistance?(n=Math.floor(Math.abs(C)/this.snapDistance),C<0&&(n*=-1),C%=this.snapDistance,s.scaleToRef(this.snapDistance*n,s),r=!0):s.scaleInPlace(0)),m.y3.ScalingToRef(1+s.x,1+s.y,1+s.z,m.jp.Matrix[2]),m.jp.Matrix[2].multiplyToRef(this.attachedNode.getWorldMatrix(),m.jp.Matrix[1]);const o=this.attachedNode._isMesh?this.attachedNode:void 0;m.jp.Matrix[1].decompose(m.jp.Vector3[1],void 0,void 0,ni.tb.PreserveScaling?o:void 0);const a=1e5;Math.abs(m.jp.Vector3[1].x)<a&&Math.abs(m.jp.Vector3[1].y)<a&&Math.abs(m.jp.Vector3[1].z)<a&&this.attachedNode.getWorldMatrix().copyFrom(m.jp.Matrix[1]),r&&(T.snapDistance=this.snapDistance*n,this.onSnapObservable.notifyObservers(T)),this._matrixChanged()}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragObservable.add((e=>x(e.dragDistance))),this.dragBehavior.onDragEndObservable.add(P),null===(a=null===(o=null===(n=null==s?void 0:s.uniformScaleGizmo)||void 0===n?void 0:n.dragBehavior)||void 0===o?void 0:o.onDragObservable)||void 0===a||a.add((e=>x(e.delta.y))),null===(c=null===(l=null===(h=null==s?void 0:s.uniformScaleGizmo)||void 0===h?void 0:h.dragBehavior)||void 0===l?void 0:l.onDragEndObservable)||void 0===c||c.add(P);const S={gizmoMeshes:[d,p],colliderMeshes:[f.arrowMesh,f.arrowTail],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};null===(u=this._parent)||void 0===u||u.addToAxisCache(this._gizmoMesh,S),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{var t;if(!this._customMeshSet&&(this._isHovered=!(-1==S.colliderMeshes.indexOf(null===(t=null==e?void 0:e.pickInfo)||void 0===t?void 0:t.pickedMesh)),!this._parent)){const e=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(S.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(S.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}));const E=i._getSharedGizmoLight();E.includedOnlyMeshes=E.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes())}_createGizmoMesh(e,t,i=!1){const s=(0,ui.NR)("yPosMesh",{size:.4*(1+(t-1)/4)},this.gizmoLayer.utilityLayerScene),r=(0,Ft.wf)("cylinder",{diameterTop:.005*t,height:.275,diameterBottom:.005*t,tessellation:96},this.gizmoLayer.utilityLayerScene);return s.scaling.scaleInPlace(.1),s.material=this._coloredMaterial,s.rotation.x=Math.PI/2,s.position.z+=.3,r.material=this._coloredMaterial,r.position.z+=.1375,r.rotation.x=Math.PI/2,i&&(s.visibility=0,r.visibility=0),e.addChild(s),e.addChild(r),{arrowMesh:s,arrowTail:r}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}setCustomMesh(e,t=!1){super.setCustomMesh(e),t&&(this._rootMesh.getChildMeshes().forEach((e=>{e.material=this._coloredMaterial,e.color&&(e.color=this._coloredMaterial.diffuseColor)})),this._customMeshSet=!1)}}var Bs=i(73616),Ns=i(7786);class Fs extends ni.tb{set axisFactor(e){this._axisFactor=e;const t=this._scaleBoxesParent.getChildMeshes();let i=0;for(let e=0;e<3;e++)for(let s=0;s<3;s++)for(let r=0;r<3;r++){const n=(1===e?1:0)+(1===s?1:0)+(1===r?1:0);if(1!==n&&3!==n){if(t[i]){const n=new m.P(e-1,s-1,r-1);n.multiplyInPlace(this._axisFactor),t[i].setEnabled(n.lengthSquared()>Ns.kn)}i++}}}get axisFactor(){return this._axisFactor}set scaleDragSpeed(e){this._scaleDragSpeed=e}get scaleDragSpeed(){return this._scaleDragSpeed}get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverColoredMaterial}get pointerDragBehavior(){return this._pointerDragBehavior}setColor(e){this._coloredMaterial.emissiveColor=e,this._hoverColoredMaterial.emissiveColor=e.clone().add(new g.Wo(.3,.3,.3)),this._lineBoundingBox.getChildren().forEach((t=>{t.color&&(t.color=e)}))}constructor(e=g.Wo.Gray(),t=oi.x.DefaultKeepDepthUtilityLayer){super(t),this._boundingDimensions=new m.P(1,1,1),this._renderObserver=null,this._pointerObserver=null,this._scaleDragSpeed=.2,this._tmpQuaternion=new m._f,this._tmpVector=new m.P(0,0,0),this._tmpRotationMatrix=new m.y3,this.ignoreChildren=!1,this.includeChildPredicate=null,this.rotationSphereSize=.1,this.scaleBoxSize=.1,this.fixedDragMeshScreenSize=!1,this.fixedDragMeshBoundsSize=!1,this.fixedDragMeshScreenSizeDistanceFactor=10,this.onDragStartObservable=new _.y$,this.onScaleBoxDragObservable=new _.y$,this.onScaleBoxDragEndObservable=new _.y$,this.onRotationSphereDragObservable=new _.y$,this.onRotationSphereDragEndObservable=new _.y$,this.scalePivot=null,this._axisFactor=new m.P(1,1,1),this._existingMeshScale=new m.P,this._dragMesh=null,this._pointerDragBehavior=new se.M,this.updateScale=!1,this._anchorMesh=new si.x("anchor",t.utilityLayerScene),this._coloredMaterial=new Ot.K("",t.utilityLayerScene),this._coloredMaterial.disableLighting=!0,this._hoverColoredMaterial=new Ot.K("",t.utilityLayerScene),this._hoverColoredMaterial.disableLighting=!0,this._lineBoundingBox=new si.x("",t.utilityLayerScene),this._lineBoundingBox.rotationQuaternion=new m._f;const i=[];i.push((0,bi.nL)("lines",{points:[new m.P(0,0,0),new m.P(this._boundingDimensions.x,0,0)]},t.utilityLayerScene)),i.push((0,bi.nL)("lines",{points:[new m.P(0,0,0),new m.P(0,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.push((0,bi.nL)("lines",{points:[new m.P(0,0,0),new m.P(0,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,bi.nL)("lines",{points:[new m.P(this._boundingDimensions.x,0,0),new m.P(this._boundingDimensions.x,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.push((0,bi.nL)("lines",{points:[new m.P(this._boundingDimensions.x,0,0),new m.P(this._boundingDimensions.x,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,bi.nL)("lines",{points:[new m.P(0,this._boundingDimensions.y,0),new m.P(this._boundingDimensions.x,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.push((0,bi.nL)("lines",{points:[new m.P(0,this._boundingDimensions.y,0),new m.P(0,this._boundingDimensions.y,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,bi.nL)("lines",{points:[new m.P(0,0,this._boundingDimensions.z),new m.P(this._boundingDimensions.x,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,bi.nL)("lines",{points:[new m.P(0,0,this._boundingDimensions.z),new m.P(0,this._boundingDimensions.y,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,bi.nL)("lines",{points:[new m.P(this._boundingDimensions.x,this._boundingDimensions.y,this._boundingDimensions.z),new m.P(0,this._boundingDimensions.y,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,bi.nL)("lines",{points:[new m.P(this._boundingDimensions.x,this._boundingDimensions.y,this._boundingDimensions.z),new m.P(this._boundingDimensions.x,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,bi.nL)("lines",{points:[new m.P(this._boundingDimensions.x,this._boundingDimensions.y,this._boundingDimensions.z),new m.P(this._boundingDimensions.x,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.forEach((t=>{t.color=e,t.position.addInPlace(new m.P(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),t.isPickable=!1,this._lineBoundingBox.addChild(t)})),this._rootMesh.addChild(this._lineBoundingBox),this.setColor(e),this._rotateSpheresParent=new si.x("",t.utilityLayerScene),this._rotateSpheresParent.rotationQuaternion=new m._f;for(let e=0;e<12;e++){const i=(0,di.Qk)("",{diameter:1},t.utilityLayerScene);i.rotationQuaternion=new m._f,i.material=this._coloredMaterial,i.isNearGrabbable=!0;const s=new se.M({});s.moveAttached=!1,s.updateDragPlane=!1,i.addBehavior(s);const r=new m.P(1,0,0);let n=0;s.onDragStartObservable.add((()=>{r.copyFrom(i.forward),n=0})),s.onDragObservable.add((t=>{if(this.onRotationSphereDragObservable.notifyObservers({}),this.attachedMesh){const i=this.attachedMesh.parent;if(i&&i.scaling&&i.scaling.isNonUniformWithinEpsilon(.001))return void p.Y.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");Bs.m._RemoveAndStorePivotPoint(this.attachedMesh);const s=r,o=t.dragPlaneNormal.scale(m.P.Dot(t.dragPlaneNormal,s)),a=s.subtract(o).normalizeToNew();let h=m.P.Dot(a,t.delta)<0?Math.abs(t.delta.length()):-Math.abs(t.delta.length());h=h/this._boundingDimensions.length()*this._anchorMesh.scaling.length(),this.attachedMesh.rotationQuaternion||(this.attachedMesh.rotationQuaternion=m._f.RotationYawPitchRoll(this.attachedMesh.rotation.y,this.attachedMesh.rotation.x,this.attachedMesh.rotation.z)),this._anchorMesh.rotationQuaternion||(this._anchorMesh.rotationQuaternion=m._f.RotationYawPitchRoll(this._anchorMesh.rotation.y,this._anchorMesh.rotation.x,this._anchorMesh.rotation.z)),n+=h,Math.abs(n)<=2*Math.PI&&(e>=8?m._f.RotationYawPitchRollToRef(0,0,h,this._tmpQuaternion):e>=4?m._f.RotationYawPitchRollToRef(h,0,0,this._tmpQuaternion):m._f.RotationYawPitchRollToRef(0,h,0,this._tmpQuaternion),this._anchorMesh.addChild(this.attachedMesh,ni.tb.PreserveScaling),this._anchorMesh.getScene().useRightHandedSystem&&this._tmpQuaternion.conjugateInPlace(),this._anchorMesh.rotationQuaternion.multiplyToRef(this._tmpQuaternion,this._anchorMesh.rotationQuaternion),this._anchorMesh.removeChild(this.attachedMesh,ni.tb.PreserveScaling),this.attachedMesh.setParent(i,ni.tb.PreserveScaling)),this.updateBoundingBox(),Bs.m._RestorePivotPoint(this.attachedMesh)}this._updateDummy()})),s.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({}),this._selectNode(i)})),s.onDragEndObservable.add((e=>{this.onRotationSphereDragEndObservable.notifyObservers({}),this._selectNode(null),this._updateDummy(),this._unhoverMeshOnTouchUp(e.pointerInfo,i)})),this._rotateSpheresParent.addChild(i)}this._rootMesh.addChild(this._rotateSpheresParent),this._scaleBoxesParent=new si.x("",t.utilityLayerScene),this._scaleBoxesParent.rotationQuaternion=new m._f;for(let e=0;e<3;e++)for(let i=0;i<3;i++)for(let s=0;s<3;s++){const r=(1===e?1:0)+(1===i?1:0)+(1===s?1:0);if(1===r||3===r)continue;const n=(0,ui.NR)("",{size:1},t.utilityLayerScene);n.material=this._coloredMaterial,n._internalMetadata=2===r,n.isNearGrabbable=!0;const o=new m.P(e-1,i-1,s-1).normalize(),a=new se.M({dragAxis:o});a.updateDragPlane=!1,a.moveAttached=!1,n.addBehavior(a),a.onDragObservable.add((e=>{if(this.onScaleBoxDragObservable.notifyObservers({}),this.attachedMesh){const t=this.attachedMesh.parent;if(t&&t.scaling&&t.scaling.isNonUniformWithinEpsilon(.001))return void p.Y.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");Bs.m._RemoveAndStorePivotPoint(this.attachedMesh);const i=e.dragDistance/this._boundingDimensions.length()*this._anchorMesh.scaling.length(),s=new m.P(i,i,i);2===r&&(s.x*=Math.abs(o.x),s.y*=Math.abs(o.y),s.z*=Math.abs(o.z)),s.scaleInPlace(this._scaleDragSpeed),s.multiplyInPlace(this._axisFactor),this.updateBoundingBox(),this.scalePivot?(this.attachedMesh.getWorldMatrix().getRotationMatrixToRef(this._tmpRotationMatrix),this._boundingDimensions.scaleToRef(.5,this._tmpVector),m.P.TransformCoordinatesToRef(this._tmpVector,this._tmpRotationMatrix,this._tmpVector),this._anchorMesh.position.subtractInPlace(this._tmpVector),this._boundingDimensions.multiplyToRef(this.scalePivot,this._tmpVector),m.P.TransformCoordinatesToRef(this._tmpVector,this._tmpRotationMatrix,this._tmpVector),this._anchorMesh.position.addInPlace(this._tmpVector)):(n.absolutePosition.subtractToRef(this._anchorMesh.position,this._tmpVector),this._anchorMesh.position.subtractInPlace(this._tmpVector)),this._anchorMesh.addChild(this.attachedMesh,ni.tb.PreserveScaling),this._anchorMesh.scaling.addInPlace(s),(this._anchorMesh.scaling.x<0||this._anchorMesh.scaling.y<0||this._anchorMesh.scaling.z<0)&&this._anchorMesh.scaling.subtractInPlace(s),this._anchorMesh.removeChild(this.attachedMesh,ni.tb.PreserveScaling),this.attachedMesh.setParent(t,ni.tb.PreserveScaling),Bs.m._RestorePivotPoint(this.attachedMesh)}this._updateDummy()})),a.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({}),this._selectNode(n)})),a.onDragEndObservable.add((e=>{this.onScaleBoxDragEndObservable.notifyObservers({}),this._selectNode(null),this._updateDummy(),this._unhoverMeshOnTouchUp(e.pointerInfo,n)})),this._scaleBoxesParent.addChild(n)}this._rootMesh.addChild(this._scaleBoxesParent);const s=new Array;this._pointerObserver=t.utilityLayerScene.onPointerObservable.add((e=>{s[e.event.pointerId]?e.pickInfo&&e.pickInfo.pickedMesh!=s[e.event.pointerId]&&(s[e.event.pointerId].material=this._coloredMaterial,delete s[e.event.pointerId]):this._rotateSpheresParent.getChildMeshes().concat(this._scaleBoxesParent.getChildMeshes()).forEach((t=>{e.pickInfo&&e.pickInfo.pickedMesh==t&&(s[e.event.pointerId]=t,t.material=this._hoverColoredMaterial)}))})),this._renderObserver=this.gizmoLayer.originalScene.onBeforeRenderObservable.add((()=>{this.attachedMesh&&!this._existingMeshScale.equals(this.attachedMesh.scaling)?this.updateBoundingBox():(this.fixedDragMeshScreenSize||this.fixedDragMeshBoundsSize)&&(this._updateRotationSpheres(),this._updateScaleBoxes()),this._dragMesh&&this.attachedMesh&&this._pointerDragBehavior.dragging&&(this._lineBoundingBox.position.rotateByQuaternionToRef(this._rootMesh.rotationQuaternion,this._tmpVector),this.attachedMesh.setAbsolutePosition(this._dragMesh.position.add(this._tmpVector.scale(-1))))})),this.updateBoundingBox()}_attachedNodeChanged(e){if(e){this._anchorMesh.scaling.setAll(1),Bs.m._RemoveAndStorePivotPoint(e);const t=e.parent;this._anchorMesh.addChild(e,ni.tb.PreserveScaling),this._anchorMesh.removeChild(e,ni.tb.PreserveScaling),e.setParent(t,ni.tb.PreserveScaling),Bs.m._RestorePivotPoint(e),this.updateBoundingBox(),e.getChildMeshes(!1).forEach((e=>{e.markAsDirty("scaling")})),this.gizmoLayer.utilityLayerScene.onAfterRenderObservable.addOnce((()=>{this._updateDummy()}))}}_selectNode(e){this._rotateSpheresParent.getChildMeshes().concat(this._scaleBoxesParent.getChildMeshes()).forEach((t=>{t.isVisible=!e||t==e}))}_unhoverMeshOnTouchUp(e,t){(null==e?void 0:e.event)instanceof PointerEvent&&"touch"===(null==e?void 0:e.event.pointerType)&&(t.material=this._coloredMaterial)}getScaleBoxes(){return this._scaleBoxesParent.getChildMeshes()}updateBoundingBox(){if(this.attachedMesh){Bs.m._RemoveAndStorePivotPoint(this.attachedMesh);const e=this.attachedMesh.parent;this.attachedMesh.setParent(null,ni.tb.PreserveScaling),this._update(),this.attachedMesh.rotationQuaternion||(this.attachedMesh.rotationQuaternion=m._f.RotationYawPitchRoll(this.attachedMesh.rotation.y,this.attachedMesh.rotation.x,this.attachedMesh.rotation.z)),this._anchorMesh.rotationQuaternion||(this._anchorMesh.rotationQuaternion=m._f.RotationYawPitchRoll(this._anchorMesh.rotation.y,this._anchorMesh.rotation.x,this._anchorMesh.rotation.z)),this._anchorMesh.rotationQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpVector.copyFrom(this.attachedMesh.position),this.attachedMesh.rotationQuaternion.set(0,0,0,1),this.attachedMesh.position.set(0,0,0);const t=this.attachedMesh.getHierarchyBoundingVectors(!this.ignoreChildren,this.includeChildPredicate);t.max.subtractToRef(t.min,this._boundingDimensions),this._lineBoundingBox.scaling.copyFrom(this._boundingDimensions),this._lineBoundingBox.position.set((t.max.x+t.min.x)/2,(t.max.y+t.min.y)/2,(t.max.z+t.min.z)/2),this._rotateSpheresParent.position.copyFrom(this._lineBoundingBox.position),this._scaleBoxesParent.position.copyFrom(this._lineBoundingBox.position),this._lineBoundingBox.computeWorldMatrix(),this._anchorMesh.position.copyFrom(this._lineBoundingBox.absolutePosition),this.attachedMesh.rotationQuaternion.copyFrom(this._tmpQuaternion),this.attachedMesh.position.copyFrom(this._tmpVector),this.attachedMesh.setParent(e,ni.tb.PreserveScaling)}this._updateRotationSpheres(),this._updateScaleBoxes(),this.attachedMesh&&(this._existingMeshScale.copyFrom(this.attachedMesh.scaling),Bs.m._RestorePivotPoint(this.attachedMesh))}_updateRotationSpheres(){const e=this._rotateSpheresParent.getChildMeshes();for(let t=0;t<3;t++)for(let i=0;i<2;i++)for(let s=0;s<2;s++){const r=4*t+2*i+s;if(0==t&&(e[r].position.set(this._boundingDimensions.x/2,this._boundingDimensions.y*i,this._boundingDimensions.z*s),e[r].position.addInPlace(new m.P(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[r].lookAt(m.P.Cross(e[r].position.normalizeToNew(),m.P.Right()).normalizeToNew().add(e[r].position))),1==t&&(e[r].position.set(this._boundingDimensions.x*i,this._boundingDimensions.y/2,this._boundingDimensions.z*s),e[r].position.addInPlace(new m.P(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[r].lookAt(m.P.Cross(e[r].position.normalizeToNew(),m.P.Up()).normalizeToNew().add(e[r].position))),2==t&&(e[r].position.set(this._boundingDimensions.x*i,this._boundingDimensions.y*s,this._boundingDimensions.z/2),e[r].position.addInPlace(new m.P(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),e[r].lookAt(m.P.Cross(e[r].position.normalizeToNew(),m.P.Forward()).normalizeToNew().add(e[r].position))),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[r].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);const t=this.rotationSphereSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[r].scaling.set(t,t,t)}else this.fixedDragMeshBoundsSize?e[r].scaling.set(this.rotationSphereSize*this._boundingDimensions.x,this.rotationSphereSize*this._boundingDimensions.y,this.rotationSphereSize*this._boundingDimensions.z):e[r].scaling.set(this.rotationSphereSize,this.rotationSphereSize,this.rotationSphereSize)}}_updateScaleBoxes(){const e=this._scaleBoxesParent.getChildMeshes();let t=0;for(let i=0;i<3;i++)for(let s=0;s<3;s++)for(let r=0;r<3;r++){const n=(1===i?1:0)+(1===s?1:0)+(1===r?1:0);if(1!==n&&3!==n){if(e[t])if(e[t].position.set(this._boundingDimensions.x*(i/2),this._boundingDimensions.y*(s/2),this._boundingDimensions.z*(r/2)),e[t].position.addInPlace(new m.P(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[t].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);const i=this.scaleBoxSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[t].scaling.set(i,i,i)}else this.fixedDragMeshBoundsSize?e[t].scaling.set(this.scaleBoxSize*this._boundingDimensions.x,this.scaleBoxSize*this._boundingDimensions.y,this.scaleBoxSize*this._boundingDimensions.z):e[t].scaling.set(this.scaleBoxSize,this.scaleBoxSize,this.scaleBoxSize);t++}}}setEnabledRotationAxis(e){this._rotateSpheresParent.getChildMeshes().forEach(((t,i)=>{i<4?t.setEnabled(-1!=e.indexOf("x")):i<8?t.setEnabled(-1!=e.indexOf("y")):t.setEnabled(-1!=e.indexOf("z"))}))}setEnabledScaling(e,t=!1){this._scaleBoxesParent.getChildMeshes().forEach((i=>{let s=e;t&&!0===i._internalMetadata&&(s=!1),i.setEnabled(s)}))}_updateDummy(){this._dragMesh&&(this._dragMesh.position.copyFrom(this._lineBoundingBox.getAbsolutePosition()),this._dragMesh.scaling.copyFrom(this._lineBoundingBox.scaling),this._dragMesh.rotationQuaternion.copyFrom(this._rootMesh.rotationQuaternion))}enableDragBehavior(){this._dragMesh=(0,ui.NR)("dummy",{size:1},this.gizmoLayer.utilityLayerScene),this._dragMesh.visibility=0,this._dragMesh.rotationQuaternion=new m._f,this._pointerDragBehavior.useObjectOrientationForDragging=!1,this._dragMesh.addBehavior(this._pointerDragBehavior)}dispose(){this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.gizmoLayer.originalScene.onBeforeRenderObservable.remove(this._renderObserver),this._lineBoundingBox.dispose(),this._rotateSpheresParent.dispose(),this._scaleBoxesParent.dispose(),this._dragMesh&&this._dragMesh.dispose(),super.dispose()}static MakeNotPickableAndWrapInBoundingBox(e){const t=e=>{e.isPickable=!1,e.getChildMeshes().forEach((e=>{t(e)}))};t(e),e.rotationQuaternion||(e.rotationQuaternion=m._f.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z));const i=e.position.clone(),s=e.rotationQuaternion.clone();e.rotationQuaternion.set(0,0,0,1),e.position.set(0,0,0);const r=(0,ui.NR)("box",{size:1},e.getScene()),n=e.getHierarchyBoundingVectors();return n.max.subtractToRef(n.min,r.scaling),0===r.scaling.y&&(r.scaling.y=Ns.kn),0===r.scaling.x&&(r.scaling.x=Ns.kn),0===r.scaling.z&&(r.scaling.z=Ns.kn),r.position.set((n.max.x+n.min.x)/2,(n.max.y+n.min.y)/2,(n.max.z+n.min.z)/2),e.addChild(r),e.rotationQuaternion.copyFrom(s),e.position.copyFrom(i),e.removeChild(r),r.addChild(e),r.visibility=0,r}setCustomMesh(){p.Y.Error("Custom meshes are not supported on this gizmo")}}var Ls=i(86654);class Vs extends ni.tb{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}constructor(e,t=g.Wo.Gray(),i=oi.x.DefaultUtilityLayer,s=32,r=null,n=!1,o=1){var a;super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new _.y$,this.angle=0,this.sensitivity=1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._angles=new m.P,this._parent=r,this._coloredMaterial=new Ot.K("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new g.Wo(.1,.1,.1)),this._hoverMaterial=new Ot.K("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=g.Wo.Yellow(),this._disableMaterial=new Ot.K("",i.utilityLayerScene),this._disableMaterial.diffuseColor=g.Wo.Gray(),this._disableMaterial.alpha=.4,this._gizmoMesh=new Mt.Kj("",i.utilityLayerScene);const{rotationMesh:h,collider:l}=this._createGizmoMesh(this._gizmoMesh,o,s);this._rotationDisplayPlane=(0,Ls.pT)("rotationDisplay",{size:.6,updatable:!1},this.gizmoLayer.utilityLayerScene),this._rotationDisplayPlane.rotation.z=.5*Math.PI,this._rotationDisplayPlane.parent=this._gizmoMesh,this._rotationDisplayPlane.setEnabled(!1),Pi.Q.ShadersStore.rotationGizmoVertexShader=Vs._RotationGizmoVertexShader,Pi.Q.ShadersStore.rotationGizmoFragmentShader=Vs._RotationGizmoFragmentShader,this._rotationShaderMaterial=new xi.j("shader",this.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles"]}),this._rotationShaderMaterial.backFaceCulling=!1,this._rotationDisplayPlane.material=this._rotationShaderMaterial,this._rotationDisplayPlane.visibility=.999,this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,ni.tb.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3),this.dragBehavior=new se.M({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.maxDragAngle=Vs.MaxDragAngle,this.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,this._rootMesh.addBehavior(this.dragBehavior);const c=new m.P,u=new m.y3,d=new m.P;let f=new m.P;this.dragBehavior.onDragStartObservable.add((e=>{this.attachedNode&&(c.copyFrom(e.dragPlanePoint),this._rotationDisplayPlane.setEnabled(!0),this._rotationDisplayPlane.getWorldMatrix().invertToRef(u),m.P.TransformCoordinatesToRef(e.dragPlanePoint,u,c),this._angles.x=Math.atan2(c.y,c.x)+Math.PI,this._angles.y=0,this._angles.z=this.updateGizmoRotationToMatchAttachedMesh?1:0,this._dragging=!0,c.copyFrom(e.dragPlanePoint),this._rotationShaderMaterial.setVector3("angles",this._angles),this.angle=0)})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1,this._rotationDisplayPlane.setEnabled(!1)}));const b={snapDistance:0};let v=0;const y=new m.y3,x=new m._f;this.dragBehavior.onDragObservable.add((t=>{if(this.attachedNode){const s=new m.P(1,1,1),r=new m._f(0,0,0,1),n=new m.P(0,0,0);if(this._handlePivot(),this.attachedNode.getWorldMatrix().decompose(s,r,n),!(Math.abs(Math.abs(s.x)-Math.abs(s.y))<=Ns.kn&&Math.abs(Math.abs(s.x)-Math.abs(s.z))<=Ns.kn)&&this.updateGizmoRotationToMatchAttachedMesh)return void p.Y.Warn("Unable to use a rotation gizmo matching mesh rotation with non uniform scaling. Use uniform scaling or set updateGizmoRotationToMatchAttachedMesh to false.");r.normalize();const o=this.updateGizmoPositionToMatchAttachedMesh?n:this._rootMesh.absolutePosition,a=t.dragPlanePoint.subtract(o).normalize(),h=c.subtract(o).normalize(),l=m.P.Cross(a,h),_=m.P.Dot(a,h);let g=Math.atan2(l.length(),_)*this.sensitivity;d.copyFrom(e),f.copyFrom(e),this.updateGizmoRotationToMatchAttachedMesh&&(r.toRotationMatrix(u),f=m.P.TransformCoordinates(d,u));let P=!1;if(i.utilityLayerScene.activeCamera){const e=i.utilityLayerScene.activeCamera.position.subtract(o).normalize();m.P.Dot(e,f)>0&&(d.scaleInPlace(-1),f.scaleInPlace(-1),P=!0)}m.P.Dot(f,l)>0&&(g=-g);let C=!1;if(0!=this.snapDistance)if(v+=g,Math.abs(v)>this.snapDistance){let e=Math.floor(Math.abs(v)/this.snapDistance);v<0&&(e*=-1),v%=this.snapDistance,g=this.snapDistance*e,C=!0}else g=0;const T=Math.sin(g/2);if(x.set(d.x*T,d.y*T,d.z*T,Math.cos(g/2)),y.determinant()>0){const e=new m.P;x.toEulerAnglesToRef(e),m._f.RotationYawPitchRollToRef(e.y,-e.x,-e.z,x)}if(this.updateGizmoRotationToMatchAttachedMesh)r.multiplyToRef(x,r),m.y3.ComposeToRef(s,r,n,this.attachedNode.getWorldMatrix());else{x.toRotationMatrix(m.jp.Matrix[0]);const e=this.attachedNode.getWorldMatrix().getTranslation();this.attachedNode.getWorldMatrix().multiplyToRef(m.jp.Matrix[0],this.attachedNode.getWorldMatrix()),this.attachedNode.getWorldMatrix().setTranslation(e)}c.copyFrom(t.dragPlanePoint),C&&(b.snapDistance=g,this.onSnapObservable.notifyObservers(b)),this._angles.y+=g,this.angle+=P?-g:g,this._rotationShaderMaterial.setVector3("angles",this._angles),this._matrixChanged()}}));const P=i._getSharedGizmoLight();P.includedOnlyMeshes=P.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const C={colliderMeshes:[l],gizmoMeshes:[h],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};null===(a=this._parent)||void 0===a||a.addToAxisCache(this._gizmoMesh,C),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{var t;if(!this._customMeshSet&&(this.dragBehavior.maxDragAngle=Vs.MaxDragAngle,this._isHovered=!(-1==C.colliderMeshes.indexOf(null===(t=null==e?void 0:e.pickInfo)||void 0===t?void 0:t.pickedMesh)),!this._parent)){const e=C.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(C.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(C.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}))}_createGizmoMesh(e,t,i){const s=(0,Lt.eu)("ignore",{diameter:.6,thickness:.03*t,tessellation:i},this.gizmoLayer.utilityLayerScene);s.visibility=0;const r=(0,Lt.eu)("",{diameter:.6,thickness:.005*t,tessellation:i},this.gizmoLayer.utilityLayerScene);return r.material=this._coloredMaterial,r.rotation.x=Math.PI/2,s.rotation.x=Math.PI/2,e.addChild(r,ni.tb.PreserveScaling),e.addChild(s,ni.tb.PreserveScaling),{rotationMesh:r,collider:s}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}}Vs.MaxDragAngle=9*Math.PI/20,Vs._RotationGizmoVertexShader="\n        precision highp float;\n        attribute vec3 position;\n        attribute vec2 uv;\n        uniform mat4 worldViewProjection;\n        varying vec3 vPosition;\n        varying vec2 vUV;\n        void main(void) {\n            gl_Position = worldViewProjection * vec4(position, 1.0);\n            vUV = uv;\n        }",Vs._RotationGizmoFragmentShader="\n        precision highp float;\n        varying vec2 vUV;\n        varying vec3 vPosition;\n        uniform vec3 angles;\n        #define twopi 6.283185307\n        void main(void) {\n            vec2 uv = vUV - vec2(0.5);\n            float angle = atan(uv.y, uv.x) + 3.141592;\n            float delta = gl_FrontFacing ? angles.y : -angles.y;\n            float begin = angles.x - delta * angles.z;\n            float start = (begin < (begin + delta)) ? begin : (begin + delta);\n            float end = (begin > (begin + delta)) ? begin : (begin + delta);\n            float len = sqrt(dot(uv,uv));\n            float opacity = 1. - step(0.5, len);\n\n            float base = abs(floor(start / twopi)) * twopi;\n            start += base;\n            end += base;\n\n            float intensity = 0.;\n            for (int i = 0; i < 5; i++)\n            {\n                intensity += max(step(start, angle) - step(end, angle), 0.);\n                angle += twopi;\n            }\n            gl_FragColor = vec4(1.,1.,0., min(intensity * 0.25, 0.8)) * opacity;\n        }";class ks extends ni.tb{get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null}))}_checkBillboardTransform(){this._nodeAttached&&this._nodeAttached.billboardMode&&console.log("Rotation Gizmo will not work with transforms in billboard mode.")}set sensitivity(e){this._sensitivity=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t&&(t.sensitivity=e)}))}get sensitivity(){return this._sensitivity}get isHovered(){let e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{e=e||t.isHovered})),e}constructor(e=oi.x.DefaultUtilityLayer,t=32,i=!1,s=1,r,n){super(e),this.onDragStartObservable=new _.y$,this.onDragEndObservable=new _.y$,this._observables=[],this._sensitivity=1,this._gizmoAxisCache=new Map;const o=n&&n.xOptions&&n.xOptions.color?n.xOptions.color:g.Wo.Red().scale(.5),a=n&&n.yOptions&&n.yOptions.color?n.yOptions.color:g.Wo.Green().scale(.5),h=n&&n.zOptions&&n.zOptions.color?n.zOptions.color:g.Wo.Blue().scale(.5);this.xGizmo=new Vs(new m.P(1,0,0),o,e,t,this,i,s),this.yGizmo=new Vs(new m.P(0,1,0),a,e,t,this,i,s),this.zGizmo=new Vs(new m.P(0,0,1),h,e,t,this,i,s),[this.xGizmo,this.yGizmo,this.zGizmo].forEach((e=>{n&&null!=n.updateScale&&(e.updateScale=n.updateScale),e.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),e.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,this.attachedNode=null,r?r.addToAxisCache(this._gizmoAxisCache):ni.tb.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}set updateGizmoRotationToMatchAttachedMesh(e){this.xGizmo&&(this.xGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.yGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.zGizmo.updateGizmoRotationToMatchAttachedMesh=e)}get updateGizmoRotationToMatchAttachedMesh(){return this.xGizmo.updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this.xGizmo&&(this.xGizmo.updateGizmoPositionToMatchAttachedMesh=e,this.yGizmo.updateGizmoPositionToMatchAttachedMesh=e,this.zGizmo.updateGizmoPositionToMatchAttachedMesh=e)}get updateGizmoPositionToMatchAttachedMesh(){return this.xGizmo.updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.anchorPoint=e}))}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.coordinatesMode=e}))}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}set snapDistance(e){this.xGizmo&&(this.xGizmo.snapDistance=e,this.yGizmo.snapDistance=e,this.zGizmo.snapDistance=e)}get snapDistance(){return this.xGizmo.snapDistance}set scaleRatio(e){this.xGizmo&&(this.xGizmo.scaleRatio=e,this.yGizmo.scaleRatio=e,this.zGizmo.scaleRatio=e)}get scaleRatio(){return this.xGizmo.scaleRatio}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}dispose(){this.xGizmo.dispose(),this.yGizmo.dispose(),this.zGizmo.dispose(),this.onDragStartObservable.clear(),this.onDragEndObservable.clear(),this._observables.forEach((e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)}))}setCustomMesh(){p.Y.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo)")}}class zs extends ni.tb{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}static _CreatePlane(e,t){const i=new dt.Y("plane",e),s=(0,Ls.pT)("dragPlane",{width:.1375,height:.1375,sideOrientation:2},e);return s.material=t,s.parent=i,i}constructor(e,t=g.Wo.Gray(),i=oi.x.DefaultUtilityLayer,s=null){var r;super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new _.y$,this._isEnabled=!1,this._parent=null,this._dragging=!1,this._parent=s,this._coloredMaterial=new Ot.K("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new g.Wo(.1,.1,.1)),this._hoverMaterial=new Ot.K("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=g.Wo.Yellow(),this._disableMaterial=new Ot.K("",i.utilityLayerScene),this._disableMaterial.diffuseColor=g.Wo.Gray(),this._disableMaterial.alpha=.4,this._gizmoMesh=zs._CreatePlane(i.utilityLayerScene,this._coloredMaterial),this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let n=0;const o=new m.P,a={snapDistance:0};this.dragBehavior=new se.M({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add((e=>{if(this.attachedNode){if(this._handlePivot(),0==this.snapDistance)this.attachedNode.getWorldMatrix().getTranslationToRef(m.jp.Vector3[0]),m.jp.Vector3[0].addToRef(e.delta,m.jp.Vector3[0]),this.dragBehavior.validateDrag(m.jp.Vector3[0])&&this.attachedNode.getWorldMatrix().addTranslationFromFloats(e.delta.x,e.delta.y,e.delta.z);else if(n+=e.dragDistance,Math.abs(n)>this.snapDistance){const t=Math.floor(Math.abs(n)/this.snapDistance);n%=this.snapDistance,e.delta.normalizeToRef(o),o.scaleInPlace(this.snapDistance*t),this.attachedNode.getWorldMatrix().getTranslationToRef(m.jp.Vector3[0]),m.jp.Vector3[0].addToRef(o,m.jp.Vector3[0]),this.dragBehavior.validateDrag(m.jp.Vector3[0])&&(this.attachedNode.getWorldMatrix().addTranslationFromFloats(o.x,o.y,o.z),a.snapDistance=this.snapDistance*t,this.onSnapObservable.notifyObservers(a))}this._matrixChanged()}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1}));const h=i._getSharedGizmoLight();h.includedOnlyMeshes=h.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const l={gizmoMeshes:this._gizmoMesh.getChildMeshes(),colliderMeshes:this._gizmoMesh.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};null===(r=this._parent)||void 0===r||r.addToAxisCache(this._gizmoMesh,l),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{var t;if(!this._customMeshSet&&(this._isHovered=!(-1==l.colliderMeshes.indexOf(null===(t=null==e?void 0:e.pickInfo)||void 0===t?void 0:t.pickedMesh)),!this._parent)){const e=l.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(l.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(l.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}))}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedNode=this._parent.attachedNode):this.attachedNode=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),super.dispose(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()}))}}class Gs extends ni.tb{get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null}))}get isHovered(){let e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{e=e||t.isHovered})),e}constructor(e=oi.x.DefaultUtilityLayer,t=1,i){super(e),this._meshAttached=null,this._nodeAttached=null,this._observables=[],this._gizmoAxisCache=new Map,this.onDragStartObservable=new _.y$,this.onDragEndObservable=new _.y$,this._planarGizmoEnabled=!1,this.xGizmo=new ai(new m.P(1,0,0),g.Wo.Red().scale(.5),e,this,t),this.yGizmo=new ai(new m.P(0,1,0),g.Wo.Green().scale(.5),e,this,t),this.zGizmo=new ai(new m.P(0,0,1),g.Wo.Blue().scale(.5),e,this,t),this.xPlaneGizmo=new zs(new m.P(1,0,0),g.Wo.Red().scale(.5),this.gizmoLayer,this),this.yPlaneGizmo=new zs(new m.P(0,1,0),g.Wo.Green().scale(.5),this.gizmoLayer,this),this.zPlaneGizmo=new zs(new m.P(0,0,1),g.Wo.Blue().scale(.5),this.gizmoLayer,this),[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((e=>{e.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),e.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,i?i.addToAxisCache(this._gizmoAxisCache):ni.tb.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}set planarGizmoEnabled(e){this._planarGizmoEnabled=e,[this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.isEnabled=e,e&&(t.attachedMesh?t.attachedMesh=this.attachedMesh:t.attachedNode=this.attachedNode))}),this)}get planarGizmoEnabled(){return this._planarGizmoEnabled}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.updateGizmoRotationToMatchAttachedMesh=e)}))}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.updateGizmoPositionToMatchAttachedMesh=e)}))}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.anchorPoint=e}))}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.coordinatesMode=e}))}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}set snapDistance(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.snapDistance=e)}))}get snapDistance(){return this._snapDistance}set scaleRatio(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.scaleRatio=e)}))}get scaleRatio(){return this._scaleRatio}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}dispose(){[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((e=>{e&&e.dispose()})),this._observables.forEach((e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)})),this.onDragStartObservable.clear(),this.onDragEndObservable.clear()}setCustomMesh(){p.Y.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo,gizmo.xPlaneGizmo, gizmo.yPlaneGizmo, gizmo.zPlaneGizmo)")}}var Us=i(23501);class Ws extends ni.tb{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null}))}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}get isHovered(){let e=!1;return[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{e=e||t.isHovered})),e}constructor(e=oi.x.DefaultUtilityLayer,t=1,i){super(e),this._meshAttached=null,this._nodeAttached=null,this._sensitivity=1,this._observables=[],this._gizmoAxisCache=new Map,this.onDragStartObservable=new _.y$,this.onDragEndObservable=new _.y$,this.uniformScaleGizmo=this._createUniformScaleMesh(),this.xGizmo=new Ds(new m.P(1,0,0),g.Wo.Red().scale(.5),e,this,t),this.yGizmo=new Ds(new m.P(0,1,0),g.Wo.Green().scale(.5),e,this,t),this.zGizmo=new Ds(new m.P(0,0,1),g.Wo.Blue().scale(.5),e,this,t),[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((e=>{e.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),e.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,this.attachedNode=null,i?i.addToAxisCache(this._gizmoAxisCache):ni.tb.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}_createUniformScaleMesh(){this._coloredMaterial=new Ot.K("",this.gizmoLayer.utilityLayerScene),this._coloredMaterial.diffuseColor=g.Wo.Gray(),this._hoverMaterial=new Ot.K("",this.gizmoLayer.utilityLayerScene),this._hoverMaterial.diffuseColor=g.Wo.Yellow(),this._disableMaterial=new Ot.K("",this.gizmoLayer.utilityLayerScene),this._disableMaterial.diffuseColor=g.Wo.Gray(),this._disableMaterial.alpha=.4;const e=new Ds(new m.P(0,1,0),g.Wo.Gray().scale(.5),this.gizmoLayer,this);e.updateGizmoRotationToMatchAttachedMesh=!1,e.uniformScaling=!0,this._uniformScalingMesh=(0,Us.sh)("uniform",{type:1},e.gizmoLayer.utilityLayerScene),this._uniformScalingMesh.scaling.scaleInPlace(.01),this._uniformScalingMesh.visibility=0,this._octahedron=(0,Us.sh)("",{type:1},e.gizmoLayer.utilityLayerScene),this._octahedron.scaling.scaleInPlace(.007),this._uniformScalingMesh.addChild(this._octahedron),e.setCustomMesh(this._uniformScalingMesh,!0);const t=this.gizmoLayer._getSharedGizmoLight();t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._octahedron);const i={gizmoMeshes:[this._octahedron,this._uniformScalingMesh],colliderMeshes:[this._uniformScalingMesh],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:e.dragBehavior};return this.addToAxisCache(e._rootMesh,i),e}set updateGizmoRotationToMatchAttachedMesh(e){e?(this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.updateGizmoRotationToMatchAttachedMesh=e)}))):p.Y.Warn("Setting updateGizmoRotationToMatchAttachedMesh = false on scaling gizmo is not supported.")}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.anchorPoint=e)}))}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t.coordinatesMode=e}))}set snapDistance(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.snapDistance=e)}))}get snapDistance(){return this._snapDistance}set scaleRatio(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.scaleRatio=e)}))}get scaleRatio(){return this._scaleRatio}set sensitivity(e){this._sensitivity=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.sensitivity=e)}))}get sensitivity(){return this._sensitivity}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}dispose(){[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((e=>{e&&e.dispose()})),this._observables.forEach((e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)})),this.onDragStartObservable.clear(),this.onDragEndObservable.clear(),[this._uniformScalingMesh,this._octahedron].forEach((e=>{e&&e.dispose()})),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()}))}}class Hs{get keepDepthUtilityLayer(){return this._defaultKeepDepthUtilityLayer}get utilityLayer(){return this._defaultUtilityLayer}get isHovered(){let e=!1;for(const t in this.gizmos){const i=this.gizmos[t];if(i&&i.isHovered){e=!0;break}}return e}set scaleRatio(e){this._scaleRatio=e,[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo].forEach((t=>{t&&(t.scaleRatio=e)}))}get scaleRatio(){return this._scaleRatio}set coordinatesMode(e){this._coordinatesMode=e,[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo].forEach((t=>{t&&(t.coordinatesMode=e)}))}get coordinatesMode(){return this._coordinatesMode}constructor(e,t=1,i=oi.x.DefaultUtilityLayer,s=oi.x.DefaultKeepDepthUtilityLayer){this._scene=e,this.clearGizmoOnEmptyPointerEvent=!1,this.enableAutoPicking=!0,this.onAttachedToMeshObservable=new _.y$,this.onAttachedToNodeObservable=new _.y$,this._gizmosEnabled={positionGizmo:!1,rotationGizmo:!1,scaleGizmo:!1,boundingBoxGizmo:!1},this._pointerObservers=[],this._attachedMesh=null,this._attachedNode=null,this._boundingBoxColor=g.Wo.FromHexString("#0984e3"),this._thickness=1,this._scaleRatio=1,this._coordinatesMode=ni.wF.Local,this._gizmoAxisCache=new Map,this.boundingBoxDragBehavior=new ne.K,this.attachableMeshes=null,this.attachableNodes=null,this.usePointerToAttachGizmos=!0,this._defaultUtilityLayer=i,this._defaultKeepDepthUtilityLayer=s,this._defaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,this._thickness=t,this.gizmos={positionGizmo:null,rotationGizmo:null,scaleGizmo:null,boundingBoxGizmo:null};const r=this._attachToMeshPointerObserver(e),n=ni.tb.GizmoAxisPointerObserver(this._defaultUtilityLayer,this._gizmoAxisCache);this._pointerObservers=[r,n]}_attachToMeshPointerObserver(e){const t=e.onPointerObservable.add((e=>{if(this.usePointerToAttachGizmos&&e.type==Ct.kD.POINTERDOWN)if(e.pickInfo&&e.pickInfo.pickedMesh){if(this.enableAutoPicking){let t=e.pickInfo.pickedMesh;if(null==this.attachableMeshes)for(;t&&null!=t.parent;)t=t.parent;else{let e=!1;this.attachableMeshes.forEach((i=>{t&&(t==i||t.isDescendantOf(i))&&(t=i,e=!0)})),e||(t=null)}t instanceof si.x?this._attachedMesh!=t&&this.attachToMesh(t):this.clearGizmoOnEmptyPointerEvent&&this.attachToMesh(null)}}else this.clearGizmoOnEmptyPointerEvent&&this.attachToMesh(null)}));return t}attachToMesh(e){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=e,this._attachedNode=null;for(const t in this.gizmos){const i=this.gizmos[t];i&&this._gizmosEnabled[t]&&(i.attachedMesh=e)}this.boundingBoxGizmoEnabled&&this._attachedMesh&&this._attachedMesh.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToMeshObservable.notifyObservers(e)}attachToNode(e){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=null,this._attachedNode=e;for(const t in this.gizmos){const i=this.gizmos[t];i&&this._gizmosEnabled[t]&&(i.attachedNode=e)}this.boundingBoxGizmoEnabled&&this._attachedNode&&this._attachedNode.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToNodeObservable.notifyObservers(e)}set positionGizmoEnabled(e){e?(this.gizmos.positionGizmo||(this.gizmos.positionGizmo=new Gs(this._defaultUtilityLayer,this._thickness,this)),this._attachedNode?this.gizmos.positionGizmo.attachedNode=this._attachedNode:this.gizmos.positionGizmo.attachedMesh=this._attachedMesh):this.gizmos.positionGizmo&&(this.gizmos.positionGizmo.attachedNode=null),this._gizmosEnabled.positionGizmo=e}get positionGizmoEnabled(){return this._gizmosEnabled.positionGizmo}set rotationGizmoEnabled(e){e?(this.gizmos.rotationGizmo||(this.gizmos.rotationGizmo=new ks(this._defaultUtilityLayer,32,!1,this._thickness,this)),this._attachedNode?this.gizmos.rotationGizmo.attachedNode=this._attachedNode:this.gizmos.rotationGizmo.attachedMesh=this._attachedMesh):this.gizmos.rotationGizmo&&(this.gizmos.rotationGizmo.attachedNode=null),this._gizmosEnabled.rotationGizmo=e}get rotationGizmoEnabled(){return this._gizmosEnabled.rotationGizmo}set scaleGizmoEnabled(e){e?(this.gizmos.scaleGizmo=this.gizmos.scaleGizmo||new Ws(this._defaultUtilityLayer,this._thickness,this),this._attachedNode?this.gizmos.scaleGizmo.attachedNode=this._attachedNode:this.gizmos.scaleGizmo.attachedMesh=this._attachedMesh):this.gizmos.scaleGizmo&&(this.gizmos.scaleGizmo.attachedNode=null),this._gizmosEnabled.scaleGizmo=e}get scaleGizmoEnabled(){return this._gizmosEnabled.scaleGizmo}set boundingBoxGizmoEnabled(e){e?(this.gizmos.boundingBoxGizmo=this.gizmos.boundingBoxGizmo||new Fs(this._boundingBoxColor,this._defaultKeepDepthUtilityLayer),this._attachedMesh?this.gizmos.boundingBoxGizmo.attachedMesh=this._attachedMesh:this.gizmos.boundingBoxGizmo.attachedNode=this._attachedNode,this._attachedMesh?(this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh.addBehavior(this.boundingBoxDragBehavior)):this._attachedNode&&(this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode.addBehavior(this.boundingBoxDragBehavior))):this.gizmos.boundingBoxGizmo&&(this._attachedMesh?this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior):this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this.gizmos.boundingBoxGizmo.attachedNode=null),this._gizmosEnabled.boundingBoxGizmo=e}get boundingBoxGizmoEnabled(){return this._gizmosEnabled.boundingBoxGizmo}addToAxisCache(e){e.size>0&&e.forEach(((e,t)=>{this._gizmoAxisCache.set(t,e)}))}dispose(){var e,t;this._pointerObservers.forEach((e=>{this._scene.onPointerObservable.remove(e)}));for(const e in this.gizmos){const t=this.gizmos[e];t&&t.dispose()}this._defaultKeepDepthUtilityLayer!==oi.x._DefaultKeepDepthUtilityLayer&&(null===(e=this._defaultKeepDepthUtilityLayer)||void 0===e||e.dispose()),this._defaultUtilityLayer!==oi.x._DefaultUtilityLayer&&(null===(t=this._defaultUtilityLayer)||void 0===t||t.dispose()),this.boundingBoxDragBehavior.detach(),this.onAttachedToMeshObservable.clear()}}var js=i(32758),$s=i(63789),Ys=i(8128);function Xs(e,t={},i){t.diameter||(t.diameter=1),t.segments||(t.segments=16);const s=(0,di.Qk)("",{slice:.5,diameter:t.diameter,segments:t.segments},i),r=(0,Ys.uH)("",{radius:t.diameter/2,tessellation:3*t.segments+(4-t.segments)},i);r.rotation.x=-Math.PI/2,r.parent=s;const n=Mt.Kj.MergeMeshes([r,s],!0);return n.name=e,n}const Qs={CreateHemisphere:Xs};Mt.Kj.CreateHemisphere=(e,t,i,s)=>Xs(e,{segments:t,diameter:i},s);var qs=i(94085);class Ks extends ni.tb{constructor(e=oi.x.DefaultUtilityLayer){super(e),this._cachedPosition=new m.P,this._cachedForward=new m.P(0,0,1),this._pointerObserver=null,this.onClickedObservable=new _.y$,this._light=null,this.attachedMesh=new si.x("",this.gizmoLayer.utilityLayerScene),this._attachedMeshParent=new dt.Y("parent",this.gizmoLayer.utilityLayerScene),this.attachedMesh.parent=this._attachedMeshParent,this._material=new Ot.K("light",this.gizmoLayer.utilityLayerScene),this._material.diffuseColor=new g.Wo(.5,.5,.5),this._material.specularColor=new g.Wo(.1,.1,.1),this._pointerObserver=e.utilityLayerScene.onPointerObservable.add((e=>{this._light&&(this._isHovered=!(!e.pickInfo||-1==this._rootMesh.getChildMeshes().indexOf(e.pickInfo.pickedMesh)),this._isHovered&&0===e.event.button&&this.onClickedObservable.notifyObservers(this._light))}),Ct.kD.POINTERDOWN)}get attachedNode(){return this.attachedMesh}set attachedNode(e){console.warn("Nodes cannot be attached to LightGizmo. Attach to a mesh instead.")}set light(e){if(this._light=e,e){this._lightMesh&&this._lightMesh.dispose(),e instanceof js.e?this._lightMesh=Ks._CreateHemisphericLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof $s.O?this._lightMesh=Ks._CreateDirectionalLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof qs.P?this._lightMesh=Ks._CreateSpotLightMesh(this.gizmoLayer.utilityLayerScene):this._lightMesh=Ks._CreatePointLightMesh(this.gizmoLayer.utilityLayerScene),this._lightMesh.getChildMeshes(!1).forEach((e=>{e.material=this._material})),this._lightMesh.parent=this._rootMesh;const t=this.gizmoLayer._getSharedGizmoLight();if(t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._lightMesh.getChildMeshes(!1)),this._lightMesh.rotationQuaternion=new m._f,this.attachedMesh.reservedDataStore||(this.attachedMesh.reservedDataStore={}),this.attachedMesh.reservedDataStore.lightGizmo=this,e.parent&&this._attachedMeshParent.freezeWorldMatrix(e.parent.getWorldMatrix()),e.position&&(this.attachedMesh.position.copyFrom(e.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position)),e.direction){this.attachedMesh.setDirection(e.direction),this.attachedMesh.computeWorldMatrix(!0);const t=this._getMeshForward();this._cachedForward.copyFrom(t)}this._update()}}get light(){return this._light}get material(){return this._material}_getMeshForward(){let e=this.attachedMesh.forward;return this.attachedMesh.getScene().useRightHandedSystem&&(e.negateToRef(m.jp.Vector3[0]),e=m.jp.Vector3[0]),e}_update(){if(super._update(),this._light){if(this._light.parent&&this._attachedMeshParent.freezeWorldMatrix(this._light.parent.getWorldMatrix()),this._light.position)if(this.attachedMesh.position.equals(this._cachedPosition))this.attachedMesh.position.copyFrom(this._light.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position);else{const e=this.attachedMesh.position;this._light.position=new m.P(e.x,e.y,e.z),this._cachedPosition.copyFrom(this.attachedMesh.position)}if(this._light.direction){const e=this._getMeshForward();if(m.P.DistanceSquared(e,this._cachedForward)>1e-4){const t=e;this._light.direction=new m.P(t.x,t.y,t.z),this._cachedForward.copyFrom(e)}else m.P.DistanceSquared(e,this._light.direction)>1e-4&&(this.attachedMesh.setDirection(this._light.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(e))}}}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._material.dispose(),super.dispose(),this._attachedMeshParent.dispose()}static _CreateHemisphericLightMesh(e){const t=new Mt.Kj("hemisphereLight",e),i=Xs(t.name,{segments:10,diameter:1},e);return i.position.z=-.15,i.rotation.x=Math.PI/2,i.parent=t,this._CreateLightLines(3,e).parent=t,t.scaling.scaleInPlace(Ks._Scale),t.rotation.x=Math.PI/2,t}static _CreatePointLightMesh(e){const t=new Mt.Kj("pointLight",e),i=(0,di.Qk)(t.name,{segments:10,diameter:1},e);return i.rotation.x=Math.PI/2,i.parent=t,this._CreateLightLines(5,e).parent=t,t.scaling.scaleInPlace(Ks._Scale),t.rotation.x=Math.PI/2,t}static _CreateSpotLightMesh(e){const t=new Mt.Kj("spotLight",e);(0,di.Qk)(t.name,{segments:10,diameter:1},e).parent=t;const i=Xs(t.name,{segments:10,diameter:2},e);return i.parent=t,i.rotation.x=-Math.PI/2,this._CreateLightLines(2,e).parent=t,t.scaling.scaleInPlace(Ks._Scale),t.rotation.x=Math.PI/2,t}static _CreateDirectionalLightMesh(e){const t=new Mt.Kj("directionalLight",e),i=new Mt.Kj(t.name,e);i.parent=t,(0,di.Qk)(t.name,{diameter:1.2,segments:10},e).parent=i;const s=(0,Ft.wf)(t.name,{updatable:!1,height:6,diameterTop:.3,diameterBottom:.3,tessellation:6,subdivisions:1},e);s.parent=i;let r=s.clone(t.name);r.scaling.y=.5,r.position.x+=1.25;let n=s.clone(t.name);n.scaling.y=.5,n.position.x+=-1.25;const o=(0,Ft.wf)(t.name,{updatable:!1,height:1,diameterTop:0,diameterBottom:.6,tessellation:6,subdivisions:1},e);return o.position.y+=3,o.parent=i,r=o.clone(t.name),r.position.y=1.5,r.position.x+=1.25,n=o.clone(t.name),n.position.y=1.5,n.position.x+=-1.25,i.scaling.scaleInPlace(Ks._Scale),i.rotation.z=Math.PI/2,i.rotation.y=Math.PI/2,t}}Ks._Scale=.007,Ks._CreateLightLines=(e,t)=>{const i=new Mt.Kj("root",t);i.rotation.x=Math.PI/2;const s=new Mt.Kj("linePivot",t);s.parent=i;const r=(0,Ft.wf)("line",{updatable:!1,height:2,diameterTop:.2,diameterBottom:.3,tessellation:6,subdivisions:1},t);if(r.position.y=r.scaling.y/2+1.2,r.parent=s,e<2)return s;for(let e=0;e<4;e++){const t=s.clone("lineParentClone");t.rotation.z=Math.PI/4,t.rotation.y=Math.PI/2+Math.PI/2*e,t.getChildMeshes()[0].scaling.y=.5,t.getChildMeshes()[0].scaling.x=t.getChildMeshes()[0].scaling.z=.8,t.getChildMeshes()[0].position.y=t.getChildMeshes()[0].scaling.y/2+1.2}if(e<3)return i;for(let e=0;e<4;e++){const t=s.clone("linePivotClone");t.rotation.z=Math.PI/2,t.rotation.y=Math.PI/2*e}if(e<4)return i;for(let e=0;e<4;e++){const t=s.clone("linePivotClone");t.rotation.z=Math.PI+Math.PI/4,t.rotation.y=Math.PI/2+Math.PI/2*e,t.getChildMeshes()[0].scaling.y=.5,t.getChildMeshes()[0].scaling.x=t.getChildMeshes()[0].scaling.z=.8,t.getChildMeshes()[0].position.y=t.getChildMeshes()[0].scaling.y/2+1.2}return e<5||(s.clone("linePivotClone").rotation.z=Math.PI),i};var Zs=i(7417);class Js extends ni.tb{constructor(e=oi.x.DefaultUtilityLayer){super(e),this._pointerObserver=null,this.onClickedObservable=new _.y$,this._camera=null,this._invProjection=new Zs.y3,this._material=new Ot.K("cameraGizmoMaterial",this.gizmoLayer.utilityLayerScene),this._material.diffuseColor=new g.Wo(.5,.5,.5),this._material.specularColor=new g.Wo(.1,.1,.1),this._pointerObserver=e.utilityLayerScene.onPointerObservable.add((e=>{this._camera&&(this._isHovered=!(!e.pickInfo||-1==this._rootMesh.getChildMeshes().indexOf(e.pickInfo.pickedMesh)),this._isHovered&&0===e.event.button&&this.onClickedObservable.notifyObservers(this._camera))}),Ct.kD.POINTERDOWN)}get displayFrustum(){return this._cameraLinesMesh.isEnabled()}set displayFrustum(e){this._cameraLinesMesh.setEnabled(e)}set camera(e){if(this._camera=e,this.attachedNode=e,e){this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._cameraMesh=Js._CreateCameraMesh(this.gizmoLayer.utilityLayerScene),this._cameraLinesMesh=Js._CreateCameraFrustum(this.gizmoLayer.utilityLayerScene),this._cameraMesh.getChildMeshes(!1).forEach((e=>{e.material=this._material})),this._cameraMesh.parent=this._rootMesh,this._cameraLinesMesh.parent=this._rootMesh,this.gizmoLayer.utilityLayerScene.activeCamera&&this.gizmoLayer.utilityLayerScene.activeCamera.maxZ<1.5*e.maxZ&&(this.gizmoLayer.utilityLayerScene.activeCamera.maxZ=1.5*e.maxZ),this.attachedNode.reservedDataStore||(this.attachedNode.reservedDataStore={}),this.attachedNode.reservedDataStore.cameraGizmo=this;const t=this.gizmoLayer._getSharedGizmoLight();t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._cameraMesh.getChildMeshes(!1)),this._update()}}get camera(){return this._camera}get material(){return this._material}_update(){super._update(),this._camera&&(this._camera.getProjectionMatrix().invertToRef(this._invProjection),this._cameraLinesMesh.setPivotMatrix(this._invProjection,!1),this._cameraLinesMesh.scaling.x=1/this._rootMesh.scaling.x,this._cameraLinesMesh.scaling.y=1/this._rootMesh.scaling.y,this._cameraLinesMesh.scaling.z=1/this._rootMesh.scaling.z,this._cameraMesh.parent=null,this._cameraMesh.rotation.y=.5*Math.PI*(this._camera.getScene().useRightHandedSystem?1:-1),this._cameraMesh.parent=this._rootMesh)}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._material.dispose(),super.dispose()}static _CreateCameraMesh(e){const t=new Mt.Kj("rootCameraGizmo",e),i=new Mt.Kj(t.name,e);i.parent=t,(0,ui.NR)(t.name,{width:1,height:.8,depth:.5},e).parent=i;const s=(0,Ft.wf)(t.name,{height:.5,diameterTop:.8,diameterBottom:.8},e);s.parent=i,s.position.y=.3,s.position.x=-.6,s.rotation.x=.5*Math.PI;const r=(0,Ft.wf)(t.name,{height:.5,diameterTop:.6,diameterBottom:.6},e);r.parent=i,r.position.y=.5,r.position.x=.4,r.rotation.x=.5*Math.PI;const n=(0,Ft.wf)(t.name,{height:.5,diameterTop:.5,diameterBottom:.5},e);return n.parent=i,n.position.y=0,n.position.x=.6,n.rotation.z=.5*Math.PI,t.scaling.scaleInPlace(Js._Scale),i.position.x=-.9,t}static _CreateCameraFrustum(e){const t=new Mt.Kj("rootCameraGizmo",e),i=new Mt.Kj(t.name,e);i.parent=t;for(let t=0;t<4;t+=2)for(let s=0;s<4;s+=2){let r=(0,bi.nL)("lines",{points:[new m.P(-1+s,-1+t,-1),new m.P(-1+s,-1+t,1)]},e);r.parent=i,r.alwaysSelectAsActiveMesh=!0,r.isPickable=!1,r=(0,bi.nL)("lines",{points:[new m.P(-1,-1+s,-1+t),new m.P(1,-1+s,-1+t)]},e),r.parent=i,r.alwaysSelectAsActiveMesh=!0,r.isPickable=!1,r=(0,bi.nL)("lines",{points:[new m.P(-1+s,-1,-1+t),new m.P(-1+s,1,-1+t)]},e),r.parent=i,r.alwaysSelectAsActiveMesh=!0,r.isPickable=!1}return t}}Js._Scale=.05;var er=i(81558),tr=i(97380);class ir extends tr.o{get photoTexture(){return this.texture}set photoTexture(e){this.texture=e}get imageMode(){return this.textureMode}set imageMode(e){this.textureMode=e}_initTexture(e,t,i){return new X.x(e,t,!i.generateMipMaps,!this._useDirectMapping,void 0,(()=>{this.onLoadObservable.notifyObservers()}),((e,t)=>{this.onLoadErrorObservable.notifyObservers(e||"Unknown error occured"),this.onError&&this.onError(e,t)}))}}ir.MODE_MONOSCOPIC=tr.o.MODE_MONOSCOPIC,ir.MODE_TOPBOTTOM=tr.o.MODE_TOPBOTTOM,ir.MODE_SIDEBYSIDE=tr.o.MODE_SIDEBYSIDE;var sr=i(78331),rr=i(93375),nr=i(45125);class or{constructor(){this.supportCascades=!0}canLoad(e){return e.endsWith(".dds")}loadCubeData(e,t,i,s){const r=t.getEngine();let n,o=!1,a=1e3;if(Array.isArray(e))for(let i=0;i<e.length;i++){const s=e[i];n=nr.N.GetDDSInfo(s),t.width=n.width,t.height=n.height,o=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,r._unpackFlipY(n.isCompressed),nr.N.UploadDDSLevels(r,t,s,n,o,6,-1,i),n.isFourCC||1!==n.mipmapCount?a=n.mipmapCount-1:r.generateMipMapsForCubemap(t)}else{const s=e;n=nr.N.GetDDSInfo(s),t.width=n.width,t.height=n.height,i&&(n.sphericalPolynomial=new rr.i),o=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,r._unpackFlipY(n.isCompressed),nr.N.UploadDDSLevels(r,t,s,n,o,6),n.isFourCC||1!==n.mipmapCount?a=n.mipmapCount-1:r.generateMipMapsForCubemap(t,!1)}r._setCubeMapTextureParams(t,o,a),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s({isDDS:!0,width:t.width,info:n,data:e,texture:t})}loadData(e,t,i){const s=nr.N.GetDDSInfo(e),r=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&t.generateMipMaps&&s.width>>s.mipmapCount-1==1;i(s.width,s.height,r,s.isFourCC,(()=>{nr.N.UploadDDSLevels(t.getEngine(),t,e,s,r,1)}))}}O.D._TextureLoaders.push(new or);var ar,hr,lr,cr=i(47743),ur=i(49197),dr=i(58161);function pr(e){return e?w.w1.GetAbsoluteUrl(e):null}function _r(e){null!==e.wasmUASTCToASTC&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=e.wasmUASTCToASTC),null!==e.wasmUASTCToBC7&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=e.wasmUASTCToBC7),null!==e.wasmUASTCToRGBA_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=e.wasmUASTCToRGBA_UNORM),null!==e.wasmUASTCToRGBA_SRGB&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=e.wasmUASTCToRGBA_SRGB),null!==e.wasmUASTCToR8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=e.wasmUASTCToR8_UNORM),null!==e.wasmUASTCToRG8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=e.wasmUASTCToRG8_UNORM),null!==e.jsMSCTranscoder&&(KTX2DECODER.MSCTranscoder.JSModuleURL=e.jsMSCTranscoder),null!==e.wasmMSCTranscoder&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=e.wasmMSCTranscoder),null!==e.wasmZSTDDecoder&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=e.wasmZSTDDecoder)}!function(e){e[e.ETC1S=0]="ETC1S",e[e.UASTC4x4=1]="UASTC4x4"}(ar||(ar={})),function(e){e[e.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",e[e.BC7_RGBA=1]="BC7_RGBA",e[e.BC3_RGBA=2]="BC3_RGBA",e[e.BC1_RGB=3]="BC1_RGB",e[e.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",e[e.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",e[e.ETC2_RGBA=6]="ETC2_RGBA",e[e.ETC1_RGB=7]="ETC1_RGB",e[e.RGBA32=8]="RGBA32",e[e.R8=9]="R8",e[e.RG8=10]="RG8"}(hr||(hr={})),function(e){e[e.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",e[e.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.RGBA8Format=32856]="RGBA8Format",e[e.R8Format=33321]="R8Format",e[e.RG8Format=33323]="RG8Format"}(lr||(lr={}));class gr{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[hr.BC1_RGB,hr.BC3_RGBA],yes:{transcodeFormat:hr.RGBA32,engineFormat:lr.RGBA8Format,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}}class mr{static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(e){if(mr._WorkerPoolPromise||mr._DecoderModulePromise)return;const t={jsDecoderModule:w.w1.GetAbsoluteUrl(this.URLConfig.jsDecoderModule),wasmUASTCToASTC:pr(this.URLConfig.wasmUASTCToASTC),wasmUASTCToBC7:pr(this.URLConfig.wasmUASTCToBC7),wasmUASTCToRGBA_UNORM:pr(this.URLConfig.wasmUASTCToRGBA_UNORM),wasmUASTCToRGBA_SRGB:pr(this.URLConfig.wasmUASTCToRGBA_SRGB),wasmUASTCToR8_UNORM:pr(this.URLConfig.wasmUASTCToR8_UNORM),wasmUASTCToRG8_UNORM:pr(this.URLConfig.wasmUASTCToRG8_UNORM),jsMSCTranscoder:pr(this.URLConfig.jsMSCTranscoder),wasmMSCTranscoder:pr(this.URLConfig.wasmMSCTranscoder),wasmZSTDDecoder:pr(this.URLConfig.wasmZSTDDecoder)};e&&"function"==typeof Worker&&"undefined"!=typeof URL?mr._WorkerPoolPromise=new Promise((i=>{const s=`${_r}(${fr})()`,r=URL.createObjectURL(new Blob([s],{type:"application/javascript"}));i(new dr.v(e,(()=>new Promise(((e,i)=>{const s=new Worker(r),n=e=>{s.removeEventListener("error",n),s.removeEventListener("message",o),i(e)},o=t=>{"init"===t.data.action&&(s.removeEventListener("error",n),s.removeEventListener("message",o),e(s))};s.addEventListener("error",n),s.addEventListener("message",o),s.postMessage({action:"init",urls:t})})))))})):"undefined"==typeof KTX2DECODER?mr._DecoderModulePromise=w.w1.LoadScriptAsync(t.jsDecoderModule).then((()=>(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,_r(t),new KTX2DECODER.KTX2Decoder))):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,mr._DecoderModulePromise=Promise.resolve(new KTX2DECODER.KTX2Decoder))}constructor(e,t=mr.DefaultNumWorkers){this._engine=e,mr._Initialize(t)}uploadAsync(e,t,i){const s=this._engine.getCaps(),r={astc:!!s.astc,bptc:!!s.bptc,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,etc1:!!s.etc1};if(mr._WorkerPoolPromise)return mr._WorkerPoolPromise.then((s=>new Promise(((n,o)=>{s.push(((s,a)=>{const h=e=>{s.removeEventListener("error",h),s.removeEventListener("message",l),o(e),a()},l=e=>{if("decoded"===e.data.action){if(s.removeEventListener("error",h),s.removeEventListener("message",l),e.data.success)try{this._createTexture(e.data.decodedData,t,i),n()}catch(e){o({message:e})}else o({message:e.data.msg});a()}};s.addEventListener("error",h),s.addEventListener("message",l),s.postMessage({action:"setDefaultDecoderOptions",options:mr.DefaultDecoderOptions._getKTX2DecoderOptions()});const c=new Uint8Array(e.byteLength);c.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),s.postMessage({action:"decode",data:c,caps:r,options:i},[c.buffer])}))}))));if(mr._DecoderModulePromise)return mr._DecoderModulePromise.then((i=>(mr.DefaultDecoderOptions.isDirty&&(KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=mr.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise(((r,n)=>{i.decode(e,s).then((e=>{this._createTexture(e,t),r()})).catch((e=>{n({message:e})}))})))));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let s=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,s=!1}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let i=0;i<e.mipmaps.length;++i){const r=e.mipmaps[i];if(!r||!r.data)throw new Error("KTX2 container - could not transcode one of the image");s?(t.width=r.width,t.height=r.height,this._engine._uploadDataToTextureDirectly(t,r.data,0,i,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,r.width,r.height,r.data,0,i)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}}function fr(){let e;onmessage=t=>{if(t.data)switch(t.data.action){case"init":{const i=t.data.urls;importScripts(i.jsDecoderModule),_r(i),e=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=t.data.options;break;case"decode":e.decode(t.data.data,t.data.caps,t.data.options).then((e=>{const t=[];for(let i=0;i<e.mipmaps.length;++i){const s=e.mipmaps[i];s&&s.data&&t.push(s.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:e},t)})).catch((e=>{postMessage({action:"decoded",success:!1,msg:e})}))}}}mr.URLConfig={jsDecoderModule:"https://preview.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},mr.DefaultNumWorkers=mr.GetDefaultNumWorkers(),mr.DefaultDecoderOptions=new gr;class br{constructor(){this.supportCascades=!1}canLoad(e,t){return e.endsWith(".ktx")||e.endsWith(".ktx2")||"image/ktx"===t||"image/ktx2"===t}loadCubeData(e,t,i,s){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const r=t.getEngine(),n=new ur.k(e,6),o=n.numberOfMipmapLevels>1&&t.generateMipMaps;r._unpackFlipY(!0),n.uploadLevels(t,t.generateMipMaps),t.width=n.pixelWidth,t.height=n.pixelHeight,r._setCubeMapTextureParams(t,o,n.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}loadData(e,t,i,s){if(ur.k.IsValid(e)){t._invertVScale=!t.invertY;const s=new ur.k(e,1),r=function(e){switch(e){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(s.glInternalFormat);r?(t.format=r,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=s.glInternalFormat,i(s.pixelWidth,s.pixelHeight,t.generateMipMaps,!0,(()=>{s.uploadLevels(t,t.generateMipMaps)}),s.isInvalid)}else mr.IsValid(e)?new mr(t.getEngine()).uploadAsync(e,t,s).then((()=>{i(t.width,t.height,t.generateMipMaps,!0,(()=>{}),!1)}),(e=>{p.Y.Warn(`Failed to load KTX2 texture data: ${e.message}`),i(0,0,!1,!1,(()=>{}),!0)})):(p.Y.Error("texture missing KTX identifier"),i(0,0,!1,!1,(()=>{}),!0))}}O.D._TextureLoaders.unshift(new br);var vr,yr,xr=i(64175),Pr=i(70389),Cr=i(91397),Tr=i(17249),Sr=i(36210),Er=i(93871);i(47761),function(e){e[e.DEHYDRATED=0]="DEHYDRATED",e[e.HOVER=1]="HOVER",e[e.TOUCH=2]="TOUCH"}(vr||(vr={})),function(e){e[e.DISABLED=0]="DISABLED",e[e.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",e[e.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"}(yr||(yr={}));class Rr extends Sr.F{constructor(e,t){super(e),this._options=t,this._tmpRay=new At.z(new m.P,new m.P),this._attachController=e=>{if(this._controllers[e.uniqueId])return;const{touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:s}=this._generateNewTouchPointMesh(),r=this._generateVisualCue();switch(this._controllers[e.uniqueId]={xrController:e,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:s,currentAnimationState:vr.DEHYDRATED,grabRay:new At.z(new m.P,new m.P),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,id:Rr._IdCounter++,pickedPointVisualCue:r},this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(e);case"gaze":case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new g.Wo(.8,.8,.8),this.selectionMeshPickedColor=new g.Wo(.3,.3,1),this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,void 0===this._options.nearInteractionControllerMode&&(this._options.nearInteractionControllerMode=yr.CENTERED_IN_FRONT),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return!!super.attach()&&(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._scene.constantlyUpdateMeshUnderPointer=!0,!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){var i;if(e.currentAnimationState!==t&&this._options.nearInteractionControllerMode===yr.CENTERED_IN_FRONT&&!(null===(i=e.xrController)||void 0===i?void 0:i.inputSource.hand)){if(t>e.currentAnimationState)switch(e.currentAnimationState){case vr.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===vr.HOVER)break;case vr.HOVER:if(e.touchCollisionMeshFunction(!0),t===vr.TOUCH)break}else switch(e.currentAnimationState){case vr.TOUCH:if(e.touchCollisionMeshFunction(!1),t===vr.HOVER)break;case vr.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===vr.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){var s;const r=this._controllers[e];r.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(m.jp.Vector3[0]),r.grabRay.direction.copyFrom(m.jp.Vector3[0]),this._options.nearInteractionControllerMode!==yr.CENTERED_IN_FRONT||(null===(s=r.xrController)||void 0===s?void 0:s.inputSource.hand)||(r.xrController.getWorldPointerRayToRef(this._tmpRay),r.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),r.grabRay.length=this._nearGrabLengthScale*this._hoverRadius,r.touchCollisionMesh.position.copyFrom(r.grabRay.origin)}_onXRFrame(e){Object.keys(this._controllers).forEach((t=>{var i;const s=this._controllers[t],r=null===(i=s.xrController)||void 0===i?void 0:i.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!s.xrController||!r&&(!this._options.nearInteractionControllerMode||!s.xrController.inputSource.gamepad))return void(s.pick=null);if(s.hoverInteraction=!1,s.nearInteraction=!1,!s.xrController)return;if(r){const i=r.get("index-finger-tip");if(i){const s=e.getJointPose(i,this._xrSessionManager.referenceSpace);if(s&&s.transform){const e=this._scene.useRightHandedSystem?1:-1;m.jp.Vector3[0].set(s.transform.position.x,s.transform.position.y,s.transform.position.z*e),m.jp.Quaternion[0].set(s.transform.orientation.x,s.transform.orientation.y,s.transform.orientation.z*e,s.transform.orientation.w*e),this._processTouchPoint(t,m.jp.Vector3[0],m.jp.Quaternion[0])}}}else if(s.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==yr.DISABLED){let e=s.xrController.pointer;s.xrController.grip&&this._options.nearInteractionControllerMode===yr.CENTERED_ON_CONTROLLER&&(e=s.xrController.grip),this._processTouchPoint(t,e.position,e.rotationQuaternion)}const n=(e,t)=>{let i=null;return i=t&&t.hit?e&&e.hit?t.distance<e.distance?t:e:t:e,i},o=e=>{let t=new Yt.p,i=!1;const s=e&&e.pickedPoint&&e.hit;return(null==e?void 0:e.pickedPoint)&&(i=0===e.pickedPoint.x&&0===e.pickedPoint.y&&0===e.pickedPoint.z),s&&!i&&(t=e),t};if(!s.grabInteraction){let e=null,t=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(s,this._hoverRadius,this._utilityLayerScene,(e=>this._nearInteractionPredicate(e))));const i=n(this._pickWithSphere(s,this._hoverRadius,this._scene,(e=>this._nearInteractionPredicate(e))),t);if(i&&i.hit&&(e=o(i),e.hit&&(s.hoverInteraction=!0)),s.hoverInteraction){let t=null;const i=r?this._pickRadius:this._controllerPickRadius;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(s,i,this._utilityLayerScene,(e=>this._nearPickPredicate(e))));const a=o(n(this._pickWithSphere(s,i,this._scene,(e=>this._nearPickPredicate(e))),t));a.hit&&(e=a,s.nearInteraction=!0)}s.stalePick=s.pick,s.pick=e,s.pick&&s.pick.pickedPoint&&s.pick.hit?(s.meshUnderPointer=s.pick.pickedMesh,s.pickedPointVisualCue.position.copyFrom(s.pick.pickedPoint),s.pickedPointVisualCue.isVisible=!0,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(s.id,!0)):(s.meshUnderPointer=null,s.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(s.id,!1))}let a=vr.DEHYDRATED;s.grabInteraction||s.nearInteraction?a=vr.TOUCH:s.hoverInteraction&&(a=vr.HOVER),this._handleTransitionAnimation(s,a)}))}get _utilityLayerScene(){return this._options.customUtilityLayerScene||oi.x.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||oi.x.DefaultUtilityLayer.utilityLayerScene:this._scene,t=(0,di.Qk)("nearInteraction",{diameter:.0105},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=m._f.Identity();const i=new Ot.K("targetMat",e);return i.specularColor=g.Wo.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return!this._farInteractionFeature||this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e)}_attachNearInteractionMode(e){const t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{(this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController)&&t.xrController&&(t.xrController.inputSource.hand||this._options.nearInteractionControllerMode&&t.xrController.inputSource.gamepad)&&(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.nearInteractionTargetMesh=null))}));const s=s=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),s&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i)):!s&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)):!s||this._options.enableNearInteractionOnAllControllers||this._options.disableSwitchOnClick||(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const i=e=>{t.squeezeComponent=e.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;s(t)}})):(t.selectionComponent=e.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;s(t)}})))};e.motionController?i(e.motionController):e.onMotionControllerInitObservable.add(i)}else{const e=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i))},s=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)};t.eventListeners={selectend:s,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",s)}}_detachController(e){const t=this._controllers[e];if(t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach((e=>{const i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)})),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame((()=>{const e={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new Yt.p,e)})),delete this._controllers[e],this._attachedController===e)){const e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}_generateNewTouchPointMesh(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||oi.x.DefaultUtilityLayer.utilityLayerScene:this._scene,t=(0,di.Qk)("PickSphere",{diameter:1},e);t.isVisible=!1,this._options.motionControllerOrbMaterial?t.material=this._options.motionControllerOrbMaterial:Er.O.ParseFromSnippetAsync("8RUNKL#3",e).then((e=>{t.material=e}));const i=new P.v;i.setEasingMode(P.Kp.EASINGMODE_EASEINOUT);const s=new m.P(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius),r=this._controllerPickRadius*(4/3),n=new m.P(r,r,r),o=this._controllerPickRadius*(7/6),a=new m.P(o,o,o),h=.8*this._controllerPickRadius,l=new m.P(h,h,h),c=1.5*this._controllerPickRadius,u=[{frame:0,value:s},{frame:10,value:new m.P(c,c,c)},{frame:18,value:n}],d=[{frame:0,value:n},{frame:10,value:l},{frame:18,value:s}],p=[{frame:0,value:m.P.ZeroReadOnly},{frame:12,value:a},{frame:15,value:s}],_=[{frame:0,value:s},{frame:10,value:m.P.ZeroReadOnly},{frame:15,value:m.P.ZeroReadOnly}],g=new f.f("touch","scaling",60,f.f.ANIMATIONTYPE_VECTOR3,f.f.ANIMATIONLOOPMODE_CONSTANT),b=new f.f("release","scaling",60,f.f.ANIMATIONTYPE_VECTOR3,f.f.ANIMATIONLOOPMODE_CONSTANT),v=new f.f("hydrate","scaling",60,f.f.ANIMATIONTYPE_VECTOR3,f.f.ANIMATIONLOOPMODE_CONSTANT),y=new f.f("dehydrate","scaling",60,f.f.ANIMATIONTYPE_VECTOR3,f.f.ANIMATIONLOOPMODE_CONSTANT);return g.setEasingFunction(i),b.setEasingFunction(i),v.setEasingFunction(i),y.setEasingFunction(i),g.setKeys(u),b.setKeys(d),v.setKeys(p),y.setKeys(_),{touchCollisionMesh:t,touchCollisionMeshFunction:i=>{const s=i?g:b;e.beginDirectAnimation(t,[s],0,18,!1,1)},hydrateCollisionMeshFunction:i=>{const s=i?v:y;i&&(t.isVisible=!0),e.beginDirectAnimation(t,[s],0,15,!1,1,(()=>{i||(t.isVisible=!1)}))}}}_pickWithSphere(e,t,i,s){const r=new Yt.p;if(r.distance=1/0,e.touchCollisionMesh&&e.xrController){const n=e.touchCollisionMesh.position,o=ei.K.CreateFromCenterAndRadius(n,t);for(let t=0;t<i.meshes.length;t++){const n=i.meshes[t];if(!s(n)||!this._controllerAvailablePredicate(n,e.xrController.uniqueId))continue;const a=Rr.PickMeshWithSphere(n,o);a&&a.hit&&a.distance<r.distance&&(r.hit=a.hit,r.pickedMesh=n,r.pickedPoint=a.pickedPoint,r.aimTransform=e.xrController.pointer,r.gripTransform=e.xrController.grip||null,r.originMesh=e.touchCollisionMesh,r.distance=a.distance)}}return r}static PickMeshWithSphere(e,t,i=!1){const s=e.subMeshes,r=new Yt.p,n=e.getBoundingInfo();if(!e._generatePointsArray())return r;if(!e.subMeshes||!n)return r;if(!i&&!ei.K.Intersects(n.boundingSphere,t))return r;const o=m.jp.Vector3[0],a=m.jp.Vector3[1];let h,l,c,u=1/0;const d=m.jp.Vector3[2],p=m.jp.Matrix[0];p.copyFrom(e.getWorldMatrix()),p.invert(),m.P.TransformCoordinatesToRef(t.center,p,d);for(let i=0;i<s.length;i++)s[i].projectToRef(d,e._positions,e.getIndices(),a),m.P.TransformCoordinatesToRef(a,e.getWorldMatrix(),a),h=m.P.Distance(a,t.center),c=m.P.Distance(a,e.getAbsolutePosition()),l=m.P.Distance(t.center,e.getAbsolutePosition()),-1!==l&&-1!==c&&c>l&&(h=0,a.copyFrom(t.center)),-1!==h&&h<u&&(u=h,o.copyFrom(a));return u<t.radius&&(r.hit=!0,r.distance=u,r.pickedMesh=e,r.pickedPoint=o.clone()),r}}Rr._IdCounter=200,Rr.Name=Tr.b.NEAR_INTERACTION,Rr.Version=1,Tr.d.AddWebXRFeature(Rr.Name,((e,t)=>()=>new Rr(e,t)),Rr.Version,!0);class Mr{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class Ar{}class Ir{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new _.y$,this._onSessionGranted=e=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),"undefined"!=typeof window&&window.location&&"http:"===window.location.protocol&&"localhost"!==window.location.hostname)throw w.w1.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const e=t.sessionMode||"immersive-vr",i=t.referenceSpaceType||"local-floor";let s=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+("undefined"==typeof SVGSVGElement?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";s+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const r=document.createElement("style");r.appendChild(document.createTextNode(s)),document.getElementsByTagName("head")[0].appendChild(r);const n=document.createElement("button");n.className="babylonVRicon",n.title=`${e} - ${i}`,this._buttons.push(new Mr(n,e,i)),this._buttons[this._buttons.length-1].update=function(e){this.element.style.display=null===e||e===this?"":"none",n.className="babylonVRicon"+(e===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce((()=>{this.dispose()})))}async setHelperAsync(e,t){this._helper=e,this._renderTarget=t;const i=this._buttons.map((t=>e.sessionManager.isSessionSupportedAsync(t.sessionMode)));e.onStateChangedObservable.add((e=>{e==Nt.k.NOT_IN_XR&&this._updateButtons(null)})),(await Promise.all(i)).forEach(((e,t)=>{e?(this.overlay.appendChild(this._buttons[t].element),this._buttons[t].element.onclick=this._enterXRWithButtonIndex.bind(this,t)):w.w1.Warn(`Session mode "${this._buttons[t].sessionMode}" not supported in browser`)}))}static async CreateAsync(e,t,i){const s=new Ir(e,i);return await s.setHelperAsync(t,i.renderTarget||void 0),s}async _enterXRWithButtonIndex(e=0){if(this._helper.state==Nt.k.IN_XR)await this._helper.exitXRAsync(),this._updateButtons(null);else if(this._helper.state==Nt.k.NOT_IN_XR)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);const i=this._buttons[e].element,s=i.title;i.title="Error entering XR session : "+s,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach((e=>{e.update(this._activeButton)})),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}var Or=i(83768);class wr{}class Dr{constructor(){}static CreateAsync(e,t={}){const i=new Dr;if(e.onDisposeObservable.addOnce((()=>{i.dispose()})),!t.disableDefaultUI){const s=Object.assign({renderTarget:i.renderTarget},t.uiOptions||{});t.optionalFeatures&&("boolean"==typeof t.optionalFeatures?s.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:s.optionalFeatures=t.optionalFeatures),i.enterExitUI=new Ir(e,s)}return xr.M.CreateAsync(e).then((e=>{if(i.baseExperience=e,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new Pr.t(e.sessionManager,e.camera,Object.assign({controllerOptions:{renderingGroupId:t.renderingGroupId}},t.inputOptions||{})),!t.disablePointerSelection){const e=Object.assign(Object.assign({},t.pointerSelectionOptions),{xrInput:i.input,renderingGroupId:t.renderingGroupId});i.pointerSelection=i.baseExperience.featuresManager.enableFeature(Cr.S.Name,t.useStablePlugins?"stable":"latest",e),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(Or.z.Name,t.useStablePlugins?"stable":"latest",Object.assign({floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId},t.teleportationOptions)),i.teleportation.setSelectionFeature(i.pointerSelection))}return t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(Rr.Name,t.useStablePlugins?"stable":"latest",Object.assign({xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0},t.nearInteractionOptions))),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),t.disableDefaultUI?void 0:i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)})).then((()=>i)).catch((e=>(p.Y.Error("Error initializing XR"),p.Y.Error(e),i)))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}var Br=!0;z.x.prototype.createDefaultLight=function(e=!1){if(e&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();0===this.lights.length&&new js.e("default light",m.P.Up(),this)},z.x.prototype.createDefaultCamera=function(e=!1,t=!1,i=!1){if(t&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const t=this.getWorldExtends((e=>e.isVisible&&e.isEnabled())),s=t.max.subtract(t.min),r=t.min.add(s.scale(.5));let n,o=1.5*s.length();if(isFinite(o)||(o=1,r.copyFromFloats(0,0,0)),e){const e=new $e.Y("default camera",-Math.PI/2,Math.PI/2,o,r,this);e.lowerRadiusLimit=.01*o,e.wheelPrecision=100/o,n=e}else{const e=new He.c("default camera",new m.P(r.x,r.y,-o),this);e.setTarget(r),n=e}n.minZ=.01*o,n.maxZ=1e3*o,n.speed=.2*o,this.activeCamera=n,i&&n.attachControl()}},z.x.prototype.createDefaultCameraOrLight=function(e=!1,t=!1,i=!1){this.createDefaultLight(t),this.createDefaultCamera(e,t,i)},z.x.prototype.createDefaultSkybox=function(e,t=!1,i=1e3,s=0,r=!0){if(!e)return p.Y.Warn("Can not create default skybox without environment texture."),null;r&&e&&(this.environmentTexture=e);const n=(0,ui.NR)("hdrSkyBox",{size:i},this);if(t){const t=new sr.Y("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=X.x.SKYBOX_MODE),t.microSurface=1-s,t.disableLighting=!0,t.twoSidedLighting=!0,n.material=t}else{const t=new Ot.K("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=X.x.SKYBOX_MODE),t.disableLighting=!0,n.material=t}return n.isPickable=!1,n.infiniteDistance=!0,n.ignoreCameraMaxZ=!0,n},z.x.prototype.createDefaultEnvironment=function(e){return er.g?new er.g(e,this):null},z.x.prototype.createDefaultVRExperience=function(e={}){return new Wt(this,e)},z.x.prototype.createDefaultXRExperienceAsync=function(e={}){return Dr.CreateAsync(this,e).then((e=>e))};var Nr=i(21555);class Fr extends tr.o{get videoTexture(){return this._texture}get videoMode(){return this.textureMode}set videoMode(e){this.textureMode=e}_initTexture(e,t,i){const s={loop:i.loop,autoPlay:i.autoPlay,autoUpdateTexture:!0,poster:i.poster},r=new Nr.f((this.name||"videoDome")+"_texture",e,t,i.generateMipMaps,this._useDirectMapping,X.x.TRILINEAR_SAMPLINGMODE,s);return i.clickToPlay&&(this._pointerObserver=t.onPointerObservable.add((e=>{var t;(null===(t=e.pickInfo)||void 0===t?void 0:t.pickedMesh)===this.mesh&&this._texture.video.play()}),Ct.kD.POINTERDOWN)),this._textureObserver=r.onLoadObservable.add((()=>{this.onLoadObservable.notifyObservers()})),r}dispose(e,t=!1){this._texture.onLoadObservable.remove(this._textureObserver),this._scene.onPointerObservable.remove(this._pointerObserver),super.dispose(e,t)}}Fr.MODE_MONOSCOPIC=tr.o.MODE_MONOSCOPIC,Fr.MODE_TOPBOTTOM=tr.o.MODE_TOPBOTTOM,Fr.MODE_SIDEBYSIDE=tr.o.MODE_SIDEBYSIDE;class Lr{get gpuFrameTimeCounter(){return this.engine.getGPUFrameTimeCounter()}get captureGPUFrameTime(){return this._captureGPUFrameTime}set captureGPUFrameTime(e){e!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=e,this.engine.captureGPUFrameTime(e))}get shaderCompilationTimeCounter(){return this._shaderCompilationTime}get captureShaderCompilationTime(){return this._captureShaderCompilationTime}set captureShaderCompilationTime(e){e!==this._captureShaderCompilationTime&&(this._captureShaderCompilationTime=e,e?(this._onBeforeShaderCompilationObserver=this.engine.onBeforeShaderCompilationObservable.add((()=>{this._shaderCompilationTime.fetchNewFrame(),this._shaderCompilationTime.beginMonitoring()})),this._onAfterShaderCompilationObserver=this.engine.onAfterShaderCompilationObservable.add((()=>{this._shaderCompilationTime.endMonitoring()}))):(this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null))}constructor(e){this.engine=e,this._captureGPUFrameTime=!1,this._captureShaderCompilationTime=!1,this._shaderCompilationTime=new Vi.z,this._onBeginFrameObserver=null,this._onEndFrameObserver=null,this._onBeforeShaderCompilationObserver=null,this._onAfterShaderCompilationObserver=null}dispose(){this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.engine.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null,this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null,this.engine=null}}class Vr{get activeMeshesEvaluationTimeCounter(){return this._activeMeshesEvaluationTime}get captureActiveMeshesEvaluationTime(){return this._captureActiveMeshesEvaluationTime}set captureActiveMeshesEvaluationTime(e){e!==this._captureActiveMeshesEvaluationTime&&(this._captureActiveMeshesEvaluationTime=e,e?(this._onBeforeActiveMeshesEvaluationObserver=this.scene.onBeforeActiveMeshesEvaluationObservable.add((()=>{w.w1.StartPerformanceCounter("Active meshes evaluation"),this._activeMeshesEvaluationTime.beginMonitoring()})),this._onAfterActiveMeshesEvaluationObserver=this.scene.onAfterActiveMeshesEvaluationObservable.add((()=>{w.w1.EndPerformanceCounter("Active meshes evaluation"),this._activeMeshesEvaluationTime.endMonitoring(!1)}))):(this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null))}get renderTargetsRenderTimeCounter(){return this._renderTargetsRenderTime}get captureRenderTargetsRenderTime(){return this._captureRenderTargetsRenderTime}set captureRenderTargetsRenderTime(e){e!==this._captureRenderTargetsRenderTime&&(this._captureRenderTargetsRenderTime=e,e?(this._onBeforeRenderTargetsRenderObserver=this.scene.onBeforeRenderTargetsRenderObservable.add((()=>{w.w1.StartPerformanceCounter("Render targets rendering"),this._renderTargetsRenderTime.beginMonitoring()})),this._onAfterRenderTargetsRenderObserver=this.scene.onAfterRenderTargetsRenderObservable.add((()=>{w.w1.EndPerformanceCounter("Render targets rendering"),this._renderTargetsRenderTime.endMonitoring(!1)}))):(this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null))}get particlesRenderTimeCounter(){return this._particlesRenderTime}get captureParticlesRenderTime(){return this._captureParticlesRenderTime}set captureParticlesRenderTime(e){e!==this._captureParticlesRenderTime&&(this._captureParticlesRenderTime=e,e?(this._onBeforeParticlesRenderingObserver=this.scene.onBeforeParticlesRenderingObservable.add((()=>{w.w1.StartPerformanceCounter("Particles"),this._particlesRenderTime.beginMonitoring()})),this._onAfterParticlesRenderingObserver=this.scene.onAfterParticlesRenderingObservable.add((()=>{w.w1.EndPerformanceCounter("Particles"),this._particlesRenderTime.endMonitoring(!1)}))):(this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null))}get spritesRenderTimeCounter(){return this._spritesRenderTime}get captureSpritesRenderTime(){return this._captureSpritesRenderTime}set captureSpritesRenderTime(e){e!==this._captureSpritesRenderTime&&(this._captureSpritesRenderTime=e,this.scene.spriteManagers&&(e?(this._onBeforeSpritesRenderingObserver=this.scene.onBeforeSpritesRenderingObservable.add((()=>{w.w1.StartPerformanceCounter("Sprites"),this._spritesRenderTime.beginMonitoring()})),this._onAfterSpritesRenderingObserver=this.scene.onAfterSpritesRenderingObservable.add((()=>{w.w1.EndPerformanceCounter("Sprites"),this._spritesRenderTime.endMonitoring(!1)}))):(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null,this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null)))}get physicsTimeCounter(){return this._physicsTime}get capturePhysicsTime(){return this._capturePhysicsTime}set capturePhysicsTime(e){e!==this._capturePhysicsTime&&this.scene.onBeforePhysicsObservable&&(this._capturePhysicsTime=e,e?(this._onBeforePhysicsObserver=this.scene.onBeforePhysicsObservable.add((()=>{w.w1.StartPerformanceCounter("Physics"),this._physicsTime.beginMonitoring()})),this._onAfterPhysicsObserver=this.scene.onAfterPhysicsObservable.add((()=>{w.w1.EndPerformanceCounter("Physics"),this._physicsTime.endMonitoring()}))):(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null,this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null))}get animationsTimeCounter(){return this._animationsTime}get captureAnimationsTime(){return this._captureAnimationsTime}set captureAnimationsTime(e){e!==this._captureAnimationsTime&&(this._captureAnimationsTime=e,e?this._onAfterAnimationsObserver=this.scene.onAfterAnimationsObservable.add((()=>{this._animationsTime.endMonitoring()})):(this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null))}get frameTimeCounter(){return this._frameTime}get captureFrameTime(){return this._captureFrameTime}set captureFrameTime(e){this._captureFrameTime=e}get interFrameTimeCounter(){return this._interFrameTime}get captureInterFrameTime(){return this._captureInterFrameTime}set captureInterFrameTime(e){this._captureInterFrameTime=e}get renderTimeCounter(){return this._renderTime}get captureRenderTime(){return this._captureRenderTime}set captureRenderTime(e){e!==this._captureRenderTime&&(this._captureRenderTime=e,e?(this._onBeforeDrawPhaseObserver=this.scene.onBeforeDrawPhaseObservable.add((()=>{this._renderTime.beginMonitoring(),w.w1.StartPerformanceCounter("Main render")})),this._onAfterDrawPhaseObserver=this.scene.onAfterDrawPhaseObservable.add((()=>{this._renderTime.endMonitoring(!1),w.w1.EndPerformanceCounter("Main render")}))):(this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null))}get cameraRenderTimeCounter(){return this._cameraRenderTime}get captureCameraRenderTime(){return this._captureCameraRenderTime}set captureCameraRenderTime(e){e!==this._captureCameraRenderTime&&(this._captureCameraRenderTime=e,e?(this._onBeforeCameraRenderObserver=this.scene.onBeforeCameraRenderObservable.add((e=>{this._cameraRenderTime.beginMonitoring(),w.w1.StartPerformanceCounter(`Rendering camera ${e.name}`)})),this._onAfterCameraRenderObserver=this.scene.onAfterCameraRenderObservable.add((e=>{this._cameraRenderTime.endMonitoring(!1),w.w1.EndPerformanceCounter(`Rendering camera ${e.name}`)}))):(this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null))}get drawCallsCounter(){return this.scene.getEngine()._drawCalls}constructor(e){this.scene=e,this._captureActiveMeshesEvaluationTime=!1,this._activeMeshesEvaluationTime=new Vi.z,this._captureRenderTargetsRenderTime=!1,this._renderTargetsRenderTime=new Vi.z,this._captureFrameTime=!1,this._frameTime=new Vi.z,this._captureRenderTime=!1,this._renderTime=new Vi.z,this._captureInterFrameTime=!1,this._interFrameTime=new Vi.z,this._captureParticlesRenderTime=!1,this._particlesRenderTime=new Vi.z,this._captureSpritesRenderTime=!1,this._spritesRenderTime=new Vi.z,this._capturePhysicsTime=!1,this._physicsTime=new Vi.z,this._captureAnimationsTime=!1,this._animationsTime=new Vi.z,this._captureCameraRenderTime=!1,this._cameraRenderTime=new Vi.z,this._onBeforeActiveMeshesEvaluationObserver=null,this._onAfterActiveMeshesEvaluationObserver=null,this._onBeforeRenderTargetsRenderObserver=null,this._onAfterRenderTargetsRenderObserver=null,this._onAfterRenderObserver=null,this._onBeforeDrawPhaseObserver=null,this._onAfterDrawPhaseObserver=null,this._onBeforeAnimationsObserver=null,this._onBeforeParticlesRenderingObserver=null,this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver=null,this._onAfterSpritesRenderingObserver=null,this._onBeforePhysicsObserver=null,this._onAfterPhysicsObserver=null,this._onAfterAnimationsObserver=null,this._onBeforeCameraRenderObserver=null,this._onAfterCameraRenderObserver=null,this._onBeforeAnimationsObserver=e.onBeforeAnimationsObservable.add((()=>{this._captureActiveMeshesEvaluationTime&&this._activeMeshesEvaluationTime.fetchNewFrame(),this._captureRenderTargetsRenderTime&&this._renderTargetsRenderTime.fetchNewFrame(),this._captureFrameTime&&(w.w1.StartPerformanceCounter("Scene rendering"),this._frameTime.beginMonitoring()),this._captureInterFrameTime&&this._interFrameTime.endMonitoring(),this._captureParticlesRenderTime&&this._particlesRenderTime.fetchNewFrame(),this._captureSpritesRenderTime&&this._spritesRenderTime.fetchNewFrame(),this._captureAnimationsTime&&this._animationsTime.beginMonitoring(),this._captureRenderTime&&this._renderTime.fetchNewFrame(),this._captureCameraRenderTime&&this._cameraRenderTime.fetchNewFrame(),this.scene.getEngine()._drawCalls.fetchNewFrame()})),this._onAfterRenderObserver=e.onAfterRenderObservable.add((()=>{this._captureFrameTime&&(w.w1.EndPerformanceCounter("Scene rendering"),this._frameTime.endMonitoring()),this._captureRenderTime&&this._renderTime.endMonitoring(!1),this._captureInterFrameTime&&this._interFrameTime.beginMonitoring(),this._captureActiveMeshesEvaluationTime&&this._activeMeshesEvaluationTime.endFrame(),this._captureRenderTargetsRenderTime&&this._renderTargetsRenderTime.endFrame(),this._captureParticlesRenderTime&&this._particlesRenderTime.endFrame(),this._captureSpritesRenderTime&&this._spritesRenderTime.endFrame(),this._captureRenderTime&&this._renderTime.endFrame(),this._captureCameraRenderTime&&this._cameraRenderTime.endFrame()}))}dispose(){this.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=null,this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null,this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null,this.scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null,this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver&&(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null),this._onAfterSpritesRenderingObserver&&(this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null),this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null,this._onBeforePhysicsObserver&&(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null),this._onAfterPhysicsObserver&&(this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null),this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null,this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null,this.scene=null}}var kr=i(29246),zr=i(90315),Gr=i(32696),Ur=i(83073),Wr=i(31932),Hr=i(52776),jr=i(44774);i(20858),i(51761),i(69611),s.p.prototype.getHighlightLayerByName=function(e){var t;for(let i=0;i<(null===(t=this.effectLayers)||void 0===t?void 0:t.length);i++)if(this.effectLayers[i].name===e&&this.effectLayers[i].getEffectName()===Yr.EffectName)return this.effectLayers[i];return null};class $r extends Wr.D{constructor(e,t,i,s,r,n=X.x.BILINEAR_SAMPLINGMODE,o,a){super(e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,s,r,n,o,a),this.direction=t,this.kernel=i,this.onApplyObservable.add((e=>{e.setFloat2("screenSize",this.width,this.height),e.setVector2("direction",this.direction),e.setFloat("blurWidth",this.kernel)}))}}class Yr extends kr.w{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i){super(e,t),this.name=e,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new _.y$,this.onAfterBlurObservable=new _.y$,this._instanceGlowingMeshStencilReference=Yr.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this.neutralColor=Yr.NeutralColor,this._engine.isStencilEnable||p.Y.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options=Object.assign({mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0},i),this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType}),this._shouldRender=!1}getEffectName(){return Yr.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[me.o.PositionKind],["offset"],["textureSampler"],this._options.isStroke?"#define STROKE \n":void 0)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?O.D.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?O.D.GetExponentOfTwo(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture=new Ur._("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=X.x.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=X.x.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(X.x.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],2===this._options.alphaBlendingMode?(this._downSamplePostprocess=new Hr.Q("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._horizontalBlurPostprocess=new $r("HighlightLayerHBP",new m.FM(1,0),this._options.blurHorizontalSize,1,null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._verticalBlurPostprocess=new $r("HighlightLayerVBP",new m.FM(0,1),this._options.blurVerticalSize,1,null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new jr.i("HighlightLayerHBP",new m.FM(1,0),this._options.blurHorizontalSize/2,{width:e,height:t},null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess.width=e,this._horizontalBlurPostprocess.height=t,this._horizontalBlurPostprocess.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._verticalBlurPostprocess=new jr.i("HighlightLayerVBP",new m.FM(0,1),this._options.blurVerticalSize/2,{width:e,height:t},null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add((()=>{this.onBeforeBlurObservable.notifyObservers(this);const e=this._blurTexture.renderTarget;e&&(this._scene.postProcessManager.directRender(this._postProcesses,e,!0),this._engine.unBindFramebuffer(e,!0)),this.onAfterBlurObservable.notifyObservers(this)})),this._postProcesses.map((e=>{e.autoClear=!1}))}needStencil(){return!0}isReady(e,t){const i=e.getMaterial(),s=e.getRenderingMesh();if(!i||!s||!this._meshes)return!1;let r=null;const n=this._meshes[s.uniqueId];return n&&n.glowEmissiveOnly&&i&&(r=i.emissiveTexture),super._isReady(e,t,r)}_internalRender(e,t){e.setTexture("textureSampler",this._blurTexture);const i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&0===t&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(yi.F.TriangleFillMode,0,6)),this.innerGlow&&1===t&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(yi.F.TriangleFillMode,0,6)),i.restoreStencilState()}shouldRender(){return!!super.shouldRender()&&!!this._meshes}_shouldRenderMesh(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!super.hasMesh(e))}_canRenderMesh(e,t){return!0}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}_setEmissiveTextureAndColor(e,t,i){const s=this._meshes[e.uniqueId];s?this._emissiveTextureAndColor.color.set(s.color.r,s.color.g,s.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),s&&s.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}addExcludedMesh(e){if(this._excludedMeshes&&!this._excludedMeshes[e.uniqueId]){const t={mesh:e,beforeBind:null,afterRender:null,stencilState:!1};t.beforeBind=e.onBeforeBindObservable.add((e=>{t.stencilState=e.getEngine().getStencilBuffer(),e.getEngine().setStencilBuffer(!1)})),t.afterRender=e.onAfterRenderObservable.add((e=>{e.getEngine().setStencilBuffer(t.stencilState)})),this._excludedMeshes[e.uniqueId]=t}}removeExcludedMesh(e){if(!this._excludedMeshes)return;const t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!!this._meshes&&!!super.hasMesh(e)&&void 0!==this._meshes[e.uniqueId]&&null!==this._meshes[e.uniqueId]}addMesh(e,t,i=!1){if(!this._meshes)return;const s=this._meshes[e.uniqueId];s?s.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add((e=>{this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]?this._defaultStencilReference(e):e.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))})),observerDefault:e.onAfterRenderObservable.add((e=>{this.isEnabled&&this._defaultStencilReference(e)})),glowEmissiveOnly:i},e.onDisposeObservable.add((()=>{this._disposeMesh(e)}))),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;const t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(const e in this._meshes)if(this._meshes[e]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes)for(const e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){const t=this._meshes[e];t&&this.removeMesh(t.mesh)}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(Yr.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(const e in this._meshes){const t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(const e in this._excludedMeshes){const t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){const e=j.p4.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(const t in this._meshes){const i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(const t in this._excludedMeshes){const i=this._excludedMeshes[t];i&&e.excludedMeshes.push(i.mesh.id)}return e}static Parse(e,t,i){const s=j.p4.Parse((()=>new Yr(e.name,t,e.options)),e,t,i);let r;for(r=0;r<e.excludedMeshes.length;r++){const i=t.getMeshById(e.excludedMeshes[r]);i&&s.addExcludedMesh(i)}for(r=0;r<e.meshes.length;r++){const i=e.meshes[r],n=t.getMeshById(i.meshId);n&&s.addMesh(n,g.Wo.FromArray(i.color),i.glowEmissiveOnly)}return s}}Yr.EffectName="HighlightLayer",Yr.NeutralColor=new g.HE(0,0,0,0),Yr.GlowingMeshStencilReference=2,Yr.NormalMeshStencilReference=1,(0,H.gn)([(0,j.qC)()],Yr.prototype,"innerGlow",void 0),(0,H.gn)([(0,j.qC)()],Yr.prototype,"outerGlow",void 0),(0,H.gn)([(0,j.qC)()],Yr.prototype,"blurHorizontalSize",null),(0,H.gn)([(0,j.qC)()],Yr.prototype,"blurVerticalSize",null),(0,H.gn)([(0,j.qC)("options")],Yr.prototype,"_options",void 0),(0,c.H)("BABYLON.HighlightLayer",Yr);var Xr=i(61415),Qr=i(52669),qr=i(47804),Kr=i(60348);s.p.AddParser(k.l.NAME_LENSFLARESYSTEM,((e,t,i,s)=>{if(void 0!==e.lensFlareSystems&&null!==e.lensFlareSystems){i.lensFlareSystems||(i.lensFlareSystems=new Array);for(let r=0,n=e.lensFlareSystems.length;r<n;r++){const n=e.lensFlareSystems[r],o=Kr.u.Parse(n,t,s);i.lensFlareSystems.push(o)}}})),s.p.prototype.getLensFlareSystemByName=function(e){for(let t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].name===e)return this.lensFlareSystems[t];return null},s.p.prototype.getLensFlareSystemById=function(e){for(let t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].id===e)return this.lensFlareSystems[t];return null},s.p.prototype.getLensFlareSystemByID=function(e){return this.getLensFlareSystemById(e)},s.p.prototype.removeLensFlareSystem=function(e){const t=this.lensFlareSystems.indexOf(e);return-1!==t&&this.lensFlareSystems.splice(t,1),t},s.p.prototype.addLensFlareSystem=function(e){this.lensFlareSystems.push(e)};class Zr{constructor(e){this.name=k.l.NAME_LENSFLARESYSTEM,this.scene=e,e.lensFlareSystems=new Array}register(){this.scene._afterCameraDrawStage.registerStep(k.l.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)}rebuild(){for(let e=0;e<this.scene.lensFlareSystems.length;e++)this.scene.lensFlareSystems[e].rebuild()}addFromContainer(e){e.lensFlareSystems&&e.lensFlareSystems.forEach((e=>{this.scene.addLensFlareSystem(e)}))}removeFromContainer(e,t){e.lensFlareSystems&&e.lensFlareSystems.forEach((e=>{this.scene.removeLensFlareSystem(e),t&&e.dispose()}))}serialize(e){e.lensFlareSystems=[];const t=this.scene.lensFlareSystems;for(const i of t)e.lensFlareSystems.push(i.serialize())}dispose(){const e=this.scene.lensFlareSystems;for(;e.length;)e[0].dispose()}_draw(e){if(this.scene.lensFlaresEnabled){const t=this.scene.lensFlareSystems;w.w1.StartPerformanceCounter("Lens flares",t.length>0);for(const i of t)0!=(e.layerMask&i.layerMask)&&i.render();w.w1.EndPerformanceCounter("Lens flares",t.length>0)}}}Kr.u._SceneComponentInitialization=e=>{let t=e._getComponent(k.l.NAME_LENSFLARESYSTEM);t||(t=new Zr(e),e._addComponent(t))};var Jr=i(85046),en=i(6942),tn=i(6070),sn=i(66089),rn=i(51723),nn=i(76340),on=i(56934),an=i(42254),hn=i(34428),ln=i(79714),cn=i(48959),un=i(64150),dn=i(82705),pn=i(19872),_n=i(1419),gn=i(69768),mn=!0;class fn{}fn.LoaderInjectedPhysicsEngine=void 0;let bn={},vn={};const yn=(e,t,i,s)=>{if(!t.materials)return null;for(let r=0,n=t.materials.length;r<n;r++){const n=t.materials[r];if(e(n))return{parsedMaterial:n,material:yi.F.Parse(n,i,s)}}return null},xn=(e,t,i)=>{for(const s in t)if(e.name===t[s])return i.push(e.id),!0;return void 0!==e.parentId&&-1!==i.indexOf(e.parentId)&&(i.push(e.id),!0)},Pn=(e,t)=>e+" of "+(t?t.file+" from "+t.name+" version: "+t.version+", exporter version: "+t.exporter_version:"unknown"),Cn=(e,t)=>{const i=t;if(t._waitingData.lods){if(t._waitingData.lods.ids&&t._waitingData.lods.ids.length>0){const s=t._waitingData.lods.ids,r=i.isEnabled(!1);if(t._waitingData.lods.distances){const n=t._waitingData.lods.distances;if(n.length>=s.length){const t=n.length>s.length?n[n.length-1]:0;i.setEnabled(!1);for(let t=0;t<s.length;t++){const r=s[t],o=e.getMeshById(r);null!=o&&i.addLODLevel(n[t],o)}t>0&&i.addLODLevel(t,null),!0===r&&i.setEnabled(!0)}else w.w1.Warn("Invalid level of detail distances for "+t.name)}}t._waitingData.lods=null}},Tn=(e,t,i)=>{if("number"!=typeof e){const s=i.getLastEntryById(e);return s&&null!=t?s.instances[parseInt(t)]:s}const s=bn[e];return s&&null!=t?s.instances[parseInt(t)]:s},Sn=(e,t)=>"number"!=typeof e?t.getLastMaterialById(e,!0):vn[e],En=(e,t,i,r,n=!1)=>{const o=new I.TJ(e);let h="importScene has failed JSON parse";try{var l=JSON.parse(t);h="";const r=Ps.n.loggingLevel===Ps.n.DETAILED_LOGGING;let n,u;if(void 0!==l.environmentTexture&&null!==l.environmentTexture){const t=void 0===l.isPBR||l.isPBR;if(l.environmentTextureType&&"BABYLON.HDRCubeTexture"===l.environmentTextureType){const s=l.environmentTextureSize?l.environmentTextureSize:128,r=new cn.e((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,s,!0,!t,void 0,l.environmentTexturePrefilterOnLoad);l.environmentTextureRotationY&&(r.rotationY=l.environmentTextureRotationY),e.environmentTexture=r}else if("object"==typeof l.environmentTexture){const t=ln.B.Parse(l.environmentTexture,e,i);e.environmentTexture=t}else if(l.environmentTexture.endsWith(".env")){const t=new ln.B((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,l.environmentTextureForcedExtension);l.environmentTextureRotationY&&(t.rotationY=l.environmentTextureRotationY),e.environmentTexture=t}else{const t=ln.B.CreateFromPrefilteredData((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,l.environmentTextureForcedExtension);l.environmentTextureRotationY&&(t.rotationY=l.environmentTextureRotationY),e.environmentTexture=t}if(!0===l.createDefaultSkybox){const i=void 0!==e.activeCamera&&null!==e.activeCamera?(e.activeCamera.maxZ-e.activeCamera.minZ)/2:1e3,s=l.skyboxBlurLevel||0;e.createDefaultSkybox(e.environmentTexture,t,i,s)}o.environmentTexture=e.environmentTexture}if(void 0!==l.environmentIntensity&&null!==l.environmentIntensity&&(e.environmentIntensity=l.environmentIntensity),void 0!==l.lights&&null!==l.lights)for(n=0,u=l.lights.length;n<u;n++){const t=l.lights[n],i=Jr._.Parse(t,e);i&&(bn[t.uniqueId]=i,o.lights.push(i),i._parentContainer=o,h+=0===n?"\n\tLights:":"",h+="\n\t\t"+i.toString(r))}if(void 0!==l.reflectionProbes&&null!==l.reflectionProbes)for(n=0,u=l.reflectionProbes.length;n<u;n++){const t=l.reflectionProbes[n],s=gn.x.Parse(t,e,i);s&&(o.reflectionProbes.push(s),s._parentContainer=o,h+=0===n?"\n\tReflection Probes:":"",h+="\n\t\t"+s.toString(r))}if(void 0!==l.animations&&null!==l.animations)for(n=0,u=l.animations.length;n<u;n++){const t=l.animations[n],i=(0,c.q)("BABYLON.Animation");if(i){const s=i.Parse(t);e.animations.push(s),o.animations.push(s),h+=0===n?"\n\tAnimations:":"",h+="\n\t\t"+s.toString(r)}}if(void 0!==l.materials&&null!==l.materials)for(n=0,u=l.materials.length;n<u;n++){const t=l.materials[n],s=yi.F.Parse(t,e,i);s&&(vn[t.uniqueId||t.id]=s,o.materials.push(s),s._parentContainer=o,h+=0===n?"\n\tMaterials:":"",h+="\n\t\t"+s.toString(r),s.getActiveTextures().forEach((e=>{-1==o.textures.indexOf(e)&&(o.textures.push(e),e._parentContainer=o)})))}if(void 0!==l.multiMaterials&&null!==l.multiMaterials)for(n=0,u=l.multiMaterials.length;n<u;n++){const t=l.multiMaterials[n],i=hn.G.ParseMultiMaterial(t,e);vn[t.uniqueId||t.id]=i,o.multiMaterials.push(i),i._parentContainer=o,h+=0===n?"\n\tMultiMaterials:":"",h+="\n\t\t"+i.toString(r),i.getActiveTextures().forEach((e=>{-1==o.textures.indexOf(e)&&(o.textures.push(e),e._parentContainer=o)}))}if(void 0!==l.morphTargetManagers&&null!==l.morphTargetManagers)for(const t of l.morphTargetManagers){const i=un.O.Parse(t,e);o.morphTargetManagers.push(i),i._parentContainer=o}if(void 0!==l.skeletons&&null!==l.skeletons)for(n=0,u=l.skeletons.length;n<u;n++){const t=l.skeletons[n],i=ge.O.Parse(t,e);o.skeletons.push(i),i._parentContainer=o,h+=0===n?"\n\tSkeletons:":"",h+="\n\t\t"+i.toString(r)}const d=l.geometries;if(null!=d){const t=new Array,s=d.vertexData;if(null!=s)for(n=0,u=s.length;n<u;n++){const r=s[n];t.push(an.Z.Parse(r,e,i))}t.forEach((e=>{e&&(o.geometries.push(e),e._parentContainer=o)}))}if(void 0!==l.transformNodes&&null!==l.transformNodes)for(n=0,u=l.transformNodes.length;n<u;n++){const t=l.transformNodes[n],s=dt.Y.Parse(t,e,i);bn[t.uniqueId]=s,o.transformNodes.push(s),s._parentContainer=o}if(void 0!==l.meshes&&null!==l.meshes)for(n=0,u=l.meshes.length;n<u;n++){const t=l.meshes[n],s=Mt.Kj.Parse(t,e,i);if(bn[t.uniqueId]=s,o.meshes.push(s),s._parentContainer=o,s.hasInstances)for(const e of s.instances)o.meshes.push(e),e._parentContainer=o;h+=0===n?"\n\tMeshes:":"",h+="\n\t\t"+s.toString(r)}if(void 0!==l.cameras&&null!==l.cameras)for(n=0,u=l.cameras.length;n<u;n++){const t=l.cameras[n],i=Ue.V.Parse(t,e);bn[t.uniqueId]=i,o.cameras.push(i),i._parentContainer=o,h+=0===n?"\n\tCameras:":"",h+="\n\t\t"+i.toString(r)}if(void 0!==l.postProcesses&&null!==l.postProcesses)for(n=0,u=l.postProcesses.length;n<u;n++){const t=l.postProcesses[n],s=Wr.D.Parse(t,e,i);s&&(o.postProcesses.push(s),s._parentContainer=o,h+=0===n?"\nPostprocesses:":"",h+="\n\t\t"+s.toString())}if(void 0!==l.animationGroups&&null!==l.animationGroups)for(n=0,u=l.animationGroups.length;n<u;n++){const t=l.animationGroups[n],i=S.O.Parse(t,e);o.animationGroups.push(i),i._parentContainer=o,h+=0===n?"\n\tAnimationGroups:":"",h+="\n\t\t"+i.toString(r)}for(n=0,u=e.cameras.length;n<u;n++){const t=e.cameras[n];null!==t._waitingParentId&&(t.parent=Tn(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(n=0,u=e.lights.length;n<u;n++){const t=e.lights[n];t&&null!==t._waitingParentId&&(t.parent=Tn(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(n=0,u=e.transformNodes.length;n<u;n++){const t=e.transformNodes[n];null!==t._waitingParentId&&(t.parent=Tn(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(n=0,u=e.meshes.length;n<u;n++){const t=e.meshes[n];null!==t._waitingParentId&&(t.parent=Tn(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null),t._waitingData.lods&&Cn(e,t)}for(e.multiMaterials.forEach((t=>{t._waitingSubMaterialsUniqueIds.forEach((i=>{t.subMaterials.push(Sn(i,e))})),t._waitingSubMaterialsUniqueIds=[]})),e.meshes.forEach((t=>{null!==t._waitingMaterialId&&(t.material=Sn(t._waitingMaterialId,e),t._waitingMaterialId=null)})),n=0,u=e.skeletons.length;n<u;n++){const t=e.skeletons[n];t._hasWaitingData&&(null!=t.bones&&t.bones.forEach((t=>{if(t._waitingTransformNodeId){const i=e.getLastEntryById(t._waitingTransformNodeId);i&&t.linkTransformNode(i),t._waitingTransformNodeId=null}})),t._hasWaitingData=null)}for(n=0,u=e.meshes.length;n<u;n++){const t=e.meshes[n];t._waitingData.freezeWorldMatrix?(t.freezeWorldMatrix(),t._waitingData.freezeWorldMatrix=null):t.computeWorldMatrix(!0)}for(n=0,u=e.lights.length;n<u;n++){const t=e.lights[n];if(t._excludedMeshesIds.length>0){for(let i=0;i<t._excludedMeshesIds.length;i++){const s=e.getMeshById(t._excludedMeshesIds[i]);s&&t.excludedMeshes.push(s)}t._excludedMeshesIds=[]}if(t._includedOnlyMeshesIds.length>0){for(let i=0;i<t._includedOnlyMeshesIds.length;i++){const s=e.getMeshById(t._includedOnlyMeshesIds[i]);s&&t.includedOnlyMeshes.push(s)}t._includedOnlyMeshesIds=[]}}for(e.geometries.forEach((e=>{e._loadedUniqueId=""})),s.p.Parse(l,e,o,i),n=0,u=e.meshes.length;n<u;n++){const t=e.meshes[n];t._waitingData.actions&&(a.k.Parse(t._waitingData.actions,t,e),t._waitingData.actions=null)}void 0!==l.actions&&null!==l.actions&&a.k.Parse(l.actions,null,e)}catch(e){const t=Pn("loadAssets",l?l.producer:"Unknown")+h;if(!r)throw p.Y.Log(t),e;r(t,e)}finally{bn={},vn={},n||o.removeAllFromScene(),null!==h&&Ps.n.loggingLevel!==Ps.n.NO_LOGGING&&p.Y.Log(Pn("loadAssets",l?l.producer:"Unknown")+(Ps.n.loggingLevel!==Ps.n.MINIMAL_LOGGING?h:""))}return o};Ps.n.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:e=>-1!==e.indexOf("babylon"),importMesh:(e,t,i,r,n,o,a,h)=>{var l;let c="importMesh has failed JSON parse";try{var u=JSON.parse(i);c="";const h=Ps.n.loggingLevel===Ps.n.DETAILED_LOGGING;e?Array.isArray(e)||(e=[e]):e=null;const d=new Array,_=new Map,g=[];if(void 0!==u.transformNodes&&null!==u.transformNodes)for(let e=0,i=u.transformNodes.length;e<i;e++){const i=u.transformNodes[e],s=dt.Y.Parse(i,t,r);g.push(s),_.set(s._waitingParsedUniqueId,s),s._waitingParsedUniqueId=null}if(void 0!==u.meshes&&null!==u.meshes){const i=[],s=[],o=[],m=[];for(let l=0,g=u.meshes.length;l<g;l++){const g=u.meshes[l];if(null===e||xn(g,e,d)){if(null!==e&&delete e[e.indexOf(g.name)],void 0!==g.geometryId&&null!==g.geometryId&&void 0!==u.geometries&&null!==u.geometries){let e=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach((i=>{!0!==e&&u.geometries[i]&&Array.isArray(u.geometries[i])&&u.geometries[i].forEach((s=>{s.id===g.geometryId&&("vertexData"===i&&an.Z.Parse(s,t,r),e=!0)}))})),!1===e&&p.Y.Warn("Geometry not found for mesh "+g.id)}if(g.materialUniqueId||g.materialId){const e=g.materialUniqueId?o:s;let i=-1!==e.indexOf(g.materialUniqueId||g.materialId);if(!1===i&&void 0!==u.multiMaterials&&null!==u.multiMaterials){const s=(i,s)=>{e.push(i);const n=yn(s,u,t,r);n&&n.material&&(vn[n.parsedMaterial.uniqueId||n.parsedMaterial.id]=n.material,c+="\n\tMaterial "+n.material.toString(h))};for(let r=0,n=u.multiMaterials.length;r<n;r++){const n=u.multiMaterials[r];if(g.materialUniqueId&&n.uniqueId===g.materialUniqueId||n.id===g.materialId){n.materialsUniqueIds?n.materialsUniqueIds.forEach((e=>s(e,(t=>t.uniqueId===e)))):n.materials.forEach((e=>s(e,(t=>t.id===e)))),e.push(n.uniqueId||n.id);const r=hn.G.ParseMultiMaterial(n,t);vn[n.uniqueId||n.id]=r,r&&(i=!0,c+="\n\tMulti-Material "+r.toString(h));break}}}if(!1===i){e.push(g.materialUniqueId||g.materialId);const i=yn((e=>g.materialUniqueId&&e.uniqueId===g.materialUniqueId||e.id===g.materialId),u,t,r);i&&i.material?(vn[i.parsedMaterial.uniqueId||i.parsedMaterial.id]=i.material,c+="\n\tMaterial "+i.material.toString(h)):p.Y.Warn("Material not found for mesh "+g.id)}}if(null!==g.skeletonId&&void 0!==g.skeletonId&&-1!==u.skeletonId&&void 0!==u.skeletons&&null!==u.skeletons&&!(i.indexOf(g.skeletonId)>-1))for(let e=0,s=u.skeletons.length;e<s;e++){const s=u.skeletons[e];if(s.id===g.skeletonId){const e=ge.O.Parse(s,t);a.push(e),i.push(s.id),c+="\n\tSkeleton "+e.toString(h)}}if(g.morphTargetManagerId>-1&&void 0!==u.morphTargetManagers&&null!==u.morphTargetManagers&&!(m.indexOf(g.morphTargetManagerId)>-1))for(let e=0,i=u.morphTargetManagers.length;e<i;e++){const i=u.morphTargetManagers[e];if(i.id===g.morphTargetManagerId){const e=un.O.Parse(i,t);m.push(e.uniqueId),c+="\nMorph target "+e.toString()}}const l=Mt.Kj.Parse(g,t,r);n.push(l),_.set(l._waitingParsedUniqueId,l),l._waitingParsedUniqueId=null,c+="\n\tMesh "+l.toString(h)}}t.multiMaterials.forEach((e=>{e._waitingSubMaterialsUniqueIds.forEach((i=>{e.subMaterials.push(Sn(i,t))})),e._waitingSubMaterialsUniqueIds=[]})),t.meshes.forEach((e=>{null!==e._waitingMaterialId&&(e.material=Sn(e._waitingMaterialId,t),e._waitingMaterialId=null)}));for(let e=0,i=t.transformNodes.length;e<i;e++){const i=t.transformNodes[e];if(null!==i._waitingParentId){let e=_.get(parseInt(i._waitingParentId))||null;null===e&&(e=t.getLastEntryById(i._waitingParentId));let s=e;i._waitingParentInstanceIndex&&(s=e.instances[parseInt(i._waitingParentInstanceIndex)],i._waitingParentInstanceIndex=null),i.parent=s,i._waitingParentId=null}}let f;for(let e=0,i=t.meshes.length;e<i;e++){if(f=t.meshes[e],f._waitingParentId){let e=_.get(parseInt(f._waitingParentId))||null;null===e&&(e=t.getLastEntryById(f._waitingParentId));let i=e;if(f._waitingParentInstanceIndex&&(i=e.instances[parseInt(f._waitingParentInstanceIndex)],f._waitingParentInstanceIndex=null),f.parent=i,"TransformNode"===(null===(l=f.parent)||void 0===l?void 0:l.getClassName())){const e=g.indexOf(f.parent);e>-1&&g.splice(e,1)}f._waitingParentId=null}f._waitingData.lods&&Cn(t,f)}for(const e of g)e.dispose();for(let e=0,i=t.skeletons.length;e<i;e++){const i=t.skeletons[e];i._hasWaitingData&&(null!=i.bones&&i.bones.forEach((e=>{if(e._waitingTransformNodeId){const i=t.getLastEntryById(e._waitingTransformNodeId);i&&e.linkTransformNode(i),e._waitingTransformNodeId=null}})),i._hasWaitingData=null)}for(let e=0,i=t.meshes.length;e<i;e++)f=t.meshes[e],f._waitingData.freezeWorldMatrix?(f.freezeWorldMatrix(),f._waitingData.freezeWorldMatrix=null):f.computeWorldMatrix(!0)}if(void 0!==u.particleSystems&&null!==u.particleSystems){const e=s.p.GetIndividualParser(k.l.NAME_PARTICLESYSTEM);if(e)for(let i=0,s=u.particleSystems.length;i<s;i++){const s=u.particleSystems[i];-1!==d.indexOf(s.emitterId)&&o.push(e(s,t,r))}}return t.geometries.forEach((e=>{e._loadedUniqueId=""})),!0}catch(e){const t=Pn("importMesh",u?u.producer:"Unknown")+c;if(!h)throw p.Y.Log(t),e;h(t,e)}finally{null!==c&&Ps.n.loggingLevel!==Ps.n.NO_LOGGING&&p.Y.Log(Pn("importMesh",u?u.producer:"Unknown")+(Ps.n.loggingLevel!==Ps.n.MINIMAL_LOGGING?c:"")),vn={}}return!1},load:(e,t,i,s)=>{let r="importScene has failed JSON parse";try{var n=JSON.parse(t);if(r="",void 0!==n.useDelayedTextureLoading&&null!==n.useDelayedTextureLoading&&(e.useDelayedTextureLoading=n.useDelayedTextureLoading&&!Ps.n.ForceFullSceneLoadingForIncremental),void 0!==n.autoClear&&null!==n.autoClear&&(e.autoClear=n.autoClear),void 0!==n.clearColor&&null!==n.clearColor&&(e.clearColor=g.HE.FromArray(n.clearColor)),void 0!==n.ambientColor&&null!==n.ambientColor&&(e.ambientColor=g.Wo.FromArray(n.ambientColor)),void 0!==n.gravity&&null!==n.gravity&&(e.gravity=m.P.FromArray(n.gravity)),void 0!==n.useRightHandedSystem&&(e.useRightHandedSystem=!!n.useRightHandedSystem),n.fogMode&&0!==n.fogMode)switch(e.fogMode=n.fogMode,e.fogColor=g.Wo.FromArray(n.fogColor),e.fogStart=n.fogStart,e.fogEnd=n.fogEnd,e.fogDensity=n.fogDensity,r+="\tFog mode for scene:  ",e.fogMode){case 1:r+="exp\n";break;case 2:r+="exp2\n";break;case 3:r+="linear\n"}if(n.physicsEnabled){let t;"cannon"===n.physicsEngine||n.physicsEngine===dn.s.name?t=new dn.s(void 0,void 0,fn.LoaderInjectedPhysicsEngine):"oimo"===n.physicsEngine||n.physicsEngine===pn.A.name?t=new pn.A(void 0,fn.LoaderInjectedPhysicsEngine):"ammo"!==n.physicsEngine&&n.physicsEngine!==_n.b.name||(t=new _n.b(void 0,fn.LoaderInjectedPhysicsEngine,void 0)),r="\tPhysics engine "+(n.physicsEngine?n.physicsEngine:"oimo")+" enabled\n";const i=n.physicsGravity?m.P.FromArray(n.physicsGravity):null;e.enablePhysics(i,t)}return void 0!==n.metadata&&null!==n.metadata&&(e.metadata=n.metadata),void 0!==n.collisionsEnabled&&null!==n.collisionsEnabled&&(e.collisionsEnabled=n.collisionsEnabled),!!En(e,t,i,s,!0)&&(n.autoAnimate&&e.beginAnimation(e,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1),void 0!==n.activeCameraID&&null!==n.activeCameraID&&e.setActiveCameraById(n.activeCameraID),!0)}catch(e){const t=Pn("importScene",n?n.producer:"Unknown")+r;if(!s)throw p.Y.Log(t),e;s(t,e)}finally{null!==r&&Ps.n.loggingLevel!==Ps.n.NO_LOGGING&&p.Y.Log(Pn("importScene",n?n.producer:"Unknown")+(Ps.n.loggingLevel!==Ps.n.MINIMAL_LOGGING?r:""))}return!1},loadAssetContainer:(e,t,i,s)=>En(e,t,i,s)});var Rn=i(17590),Mn=i(50412),An=i(60437),In=(i(45380),i(43092)),On=i(21369);class wn{get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,O.D.MarkAllMaterialsAsDirty(20))}constructor(e={}){this._isEnabled=!0,this.bias=void 0===e.bias?0:e.bias,this.power=void 0===e.power?1:e.power,this.leftColor=e.leftColor||g.Wo.White(),this.rightColor=e.rightColor||g.Wo.Black(),!1===e.isEnabled&&(this.isEnabled=!1)}clone(){const e=new wn;return On.j.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new wn({isEnabled:e.isEnabled,leftColor:g.Wo.FromArray(e.leftColor),rightColor:g.Wo.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}}j.p4._FresnelParametersParser=wn.Parse;var Dn=i(63478),Bn=i(28981),Nn=i(96721);i(3135),i(46789);class Fn extends xi.j{constructor(e,t){super(e,t,"color",{attributes:["position"],uniforms:["world","viewProjection","color"]}),this.disableColorWrite=!0,this.forceDepthWrite=!0,this.setColor4("color",new g.HE(0,0,0,1))}}var Ln=i(29298),Vn=i(2434),kn=i(36723),zn=i(33655),Gn=i(65231);class Un extends kn.P{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){const t=j.p4.Clone((()=>new Un(e,this.getScene())),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=j.p4.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=j.p4.Parse((()=>new Un(e.name,t)),e,t,i);return e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}(0,H.gn)([(0,j.n9)(),(0,j.wz)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],Un.prototype,"baseColor",void 0),(0,H.gn)([(0,j.oU)(),(0,j.wz)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],Un.prototype,"baseTexture",void 0),(0,H.gn)([(0,j.qC)(),(0,j.wz)("_markAllSubMeshesAsTexturesDirty")],Un.prototype,"metallic",void 0),(0,H.gn)([(0,j.qC)(),(0,j.wz)("_markAllSubMeshesAsTexturesDirty")],Un.prototype,"roughness",void 0),(0,H.gn)([(0,j.oU)(),(0,j.wz)("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],Un.prototype,"metallicRoughnessTexture",void 0),(0,c.H)("BABYLON.PBRMetallicRoughnessMaterial",Un);class Wn extends kn.P{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){const t=j.p4.Clone((()=>new Wn(e,this.getScene())),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=j.p4.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=j.p4.Parse((()=>new Wn(e.name,t)),e,t,i);return e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}(0,H.gn)([(0,j.n9)("diffuse"),(0,j.wz)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],Wn.prototype,"diffuseColor",void 0),(0,H.gn)([(0,j.oU)(),(0,j.wz)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],Wn.prototype,"diffuseTexture",void 0),(0,H.gn)([(0,j.n9)("specular"),(0,j.wz)("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],Wn.prototype,"specularColor",void 0),(0,H.gn)([(0,j.qC)(),(0,j.wz)("_markAllSubMeshesAsTexturesDirty","_microSurface")],Wn.prototype,"glossiness",void 0),(0,H.gn)([(0,j.oU)(),(0,j.wz)("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],Wn.prototype,"specularGlossinessTexture",void 0),(0,c.H)("BABYLON.PBRSpecularGlossinessMaterial",Wn);var Hn=i(7133),jn=i(73660),$n=i(80569),Yn=i(24293),Xn=i(60771);i(596);class Qn extends Xn.V{constructor(e,t,i=null){if(super(t),e)if(this._textureMatrix=m.y3.Identity(),this.name=e,this.url=e,this._onLoad=i,this._texture=this._getFromCache(e,!0),this._texture)this._triggerOnLoad();else{const e=this.getScene();e&&e.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){const e=this._getEngine();let t;t=e._features.support3DTextures?e.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):e.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=t,this._texture.isReady=!1,this.isCube=!1,this.is3D=e._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;const i=i=>{if("string"!=typeof i)return;let s,r=null,n=null;const o=i.split("\n");let a=0,h=0,l=0,c=0,u=0;for(let e=0;e<o.length;e++){if(s=o[e],!Qn._NoneEmptyLineRegex.test(s))continue;if(0===s.indexOf("#"))continue;const t=s.split(" ");if(0!==a){if(0!=a){const e=Math.max(parseInt(t[0]),0),i=Math.max(parseInt(t[1]),0),s=Math.max(parseInt(t[2]),0);u=Math.max(e,u),u=Math.max(i,u),u=Math.max(s,u);const r=4*(h+c*a+l*a*a);n&&(n[r+0]=e,n[r+1]=i,n[r+2]=s),l++,l%a==0&&(c++,l=0,c%a==0&&(h++,c=0))}}else a=t.length,r=new Uint8Array(a*a*a*4),n=new Float32Array(a*a*a*4)}if(n&&r)for(let e=0;e<n.length;e++)if(e>0&&(e+1)%4==0)r[e]=255;else{const t=n[e];r[e]=t/u*255}t.is3D?(t.updateSize(a,a,a),e.updateRawTexture3D(t,r,5,!1)):(t.updateSize(a*a,a),e.updateRawTexture(t,r,5,!1)),t.isReady=!0,this._triggerOnLoad()},s=this.getScene();return s?s._loadFile(this.url,i):e._loadFile(this.url,i),this._texture}_loadTexture(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this._load3dlTexture()}clone(){const e=new Qn(this.url,this.getScene()||this._getEngine());return e.level=this.level,e}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(e,t){let i=null;return e.name&&!e.isRenderTarget&&(i=new Qn(e.name,t),i.name=e.name,i.level=e.level),i}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e}}Qn._NoneEmptyLineRegex=/\S+/,(0,c.H)("BABYLON.ColorGradingTexture",Qn);var qn=i(30902),Kn=i(4107);class Zn extends Xn.V{constructor(e,t,i,s=!1,r=!0,n=null,o=null,a=!1){if(super(t),this._onLoad=null,this._onError=null,!e)throw new Error("Image url is not set");this._coordinatesMode=X.x.CUBIC_MODE,this.name=e,this.url=e,this._size=i,this._supersample=a,this._noMipmap=s,this.gammaSpace=r,this._onLoad=n,this._onError=o,this.hasAlpha=!1,this.isCube=!0,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?n&&(this._texture.isReady?w.w1.SetImmediate((()=>n())):this._texture.onLoadedObservable.add(n)):t.useDelayedTextureLoading?this.delayLoadState=4:this._loadImage(this._loadTexture.bind(this),this._onError)}_loadImage(e,t){const i=document.createElement("canvas");(0,Kn.r6)(this.url,(t=>{this._width=t.width,this._height=t.height,i.width=this._width,i.height=this._height;const s=i.getContext("2d");s.drawImage(t,0,0);const r=s.getImageData(0,0,t.width,t.height);this._buffer=r.data.buffer,i.remove(),e()}),((e,i)=>{t&&t(`${this.getClassName()} could not be loaded`,i)}),null)}_loadTexture(){const e=this.getScene();e&&(this._texture=e.getEngine().createRawCubeTextureFromUrl(this.url,e,this._size,4,e.getEngine().getCaps().textureFloat?1:7,this._noMipmap,(()=>{const e=this._getFloat32ArrayFromArrayBuffer(this._buffer),t=qn.B.ConvertPanoramaToCubemap(e,this._width,this._height,this._size,this._supersample),i=[];for(let e=0;e<6;e++){const s=t[Zn._FacesMapping[e]];i.push(s)}return i}),null,this._onLoad,this._onError))}_getFloat32ArrayFromArrayBuffer(e){const t=new DataView(e),i=new Float32Array(3*e.byteLength/4);let s=0;for(let r=0;r<e.byteLength;r++)(r+1)%4!=0&&(i[s++]=t.getUint8(r)/255);return i}getClassName(){return"EquiRectangularCubeTexture"}clone(){const e=this.getScene();if(!e)return this;const t=new Zn(this.url,e,this._size,this._noMipmap,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}}Zn._FacesMapping=["right","left","up","down","front","back"];var Jn=i(75665),eo=i(16751);class to extends Xn.V{constructor(e,t,i){var s,r;super(i.scene||i.engine),this.onLoadObservable=new _.y$,t&&(i.engine||i.scene)&&(i=Object.assign(Object.assign({},to._DefaultOptions),i),this._generateMipMaps=i.generateMipMaps,this._samplingMode=i.samplingMode,this._textureMatrix=m.y3.Identity(),this._format=i.format,this.name=e,this.element=t,this._isVideo=!!t.getVideoPlaybackQuality,this._externalTexture=this._isVideo&&null!==(r=null===(s=this._engine)||void 0===s?void 0:s.createExternalTexture(t))&&void 0!==r?r:null,this.anisotropicFilteringLevel=1,this._createInternalTexture())}_createInternalTexture(){let e=0,t=0;this._isVideo?(e=this.element.videoWidth,t=this.element.videoHeight):(e=this.element.width,t=this.element.height);const i=this._getEngine();i&&(this._texture=i.createDynamicTexture(e,t,this._generateMipMaps,this._samplingMode),this._texture.format=this._format),this.update()}getTextureMatrix(){return this._textureMatrix}update(e=null){const t=this._getEngine();if(null==this._texture||null==t)return;const i=this.isReady();if(this._isVideo){const i=this.element;if(i.readyState<i.HAVE_CURRENT_DATA)return;t.updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:i,null===e||e)}else{const i=this.element;t.updateDynamicTexture(this._texture,i,null===e||e,!1,this._format)}!i&&this.isReady()&&this.onLoadObservable.notifyObservers(this)}dispose(){this.onLoadObservable.clear(),super.dispose()}}to._DefaultOptions={generateMipMaps:!1,samplingMode:2,format:5,engine:null,scene:null},i(41028);const io=1,so=2,ro=3,no=9,oo=10,ao=11,ho=48,lo=4,co=0,uo=1,po=2,_o=3;function go(e){let t=0;return{id_length:e[t++],colormap_type:e[t++],image_type:e[t++],colormap_index:e[t++]|e[t++]<<8,colormap_length:e[t++]|e[t++]<<8,colormap_size:e[t++],origin:[e[t++]|e[t++]<<8,e[t++]|e[t++]<<8],width:e[t++]|e[t++]<<8,height:e[t++]|e[t++]<<8,pixel_size:e[t++],flags:e[t++]}}function mo(e,t){if(t.length<19)return void p.Y.Error("Unable to load TGA file - Not enough data to contain header");let i=18;const s=go(t);if(s.id_length+i>t.length)return void p.Y.Error("Unable to load TGA file - Not enough data");i+=s.id_length;let r,n=!1,o=!1,a=!1;switch(s.image_type){case no:n=!0;case io:o=!0;break;case oo:n=!0;case so:break;case ao:n=!0;case ro:a=!0}const h=s.pixel_size>>3,l=s.width*s.height*h;let c,u,d,_,g,m,f;if(o&&(c=t.subarray(i,i+=s.colormap_length*(s.colormap_size>>3))),n){let e,s,n;r=new Uint8Array(l);let o=0;const a=new Uint8Array(h);for(;i<l&&o<l;)if(e=t[i++],s=1+(127&e),128&e){for(n=0;n<h;++n)a[n]=t[i++];for(n=0;n<s;++n)r.set(a,o+n*h);o+=h*s}else{for(s*=h,n=0;n<s;++n)r[o+n]=t[i++];o+=s}}else r=t.subarray(i,i+=o?s.width*s.height:l);switch((s.flags&ho)>>lo){default:case po:u=0,_=1,f=s.width,d=0,g=1,m=s.height;break;case co:u=0,_=1,f=s.width,d=s.height-1,g=-1,m=-1;break;case _o:u=s.width-1,_=-1,f=-1,d=0,g=1,m=s.height;break;case uo:u=s.width-1,_=-1,f=-1,d=s.height-1,g=-1,m=-1}const b="_getImageData"+(a?"Grey":"")+s.pixel_size+"bits",v=fo[b](s,c,r,d,g,m,u,_,f);e.getEngine()._uploadDataToTextureDirectly(e,v)}const fo={GetTGAHeader:go,UploadContent:mo,_getImageData8bits:function(e,t,i,s,r,n,o,a,h){const l=i,c=t,u=e.width,d=e.height;let p,_,g,m=0;const f=new Uint8Array(u*d*4);for(g=s;g!==n;g+=r)for(_=o;_!==h;_+=a,m++)p=l[m],f[4*(_+u*g)+3]=255,f[4*(_+u*g)+2]=c[3*p+0],f[4*(_+u*g)+1]=c[3*p+1],f[4*(_+u*g)+0]=c[3*p+2];return f},_getImageData16bits:function(e,t,i,s,r,n,o,a,h){const l=i,c=e.width,u=e.height;let d,p,_,g=0;const m=new Uint8Array(c*u*4);for(_=s;_!==n;_+=r)for(p=o;p!==h;p+=a,g+=2){d=l[g+0]+(l[g+1]<<8);const e=255*((31744&d)>>10)/31|0,t=255*((992&d)>>5)/31|0,i=255*(31&d)/31|0;m[4*(p+c*_)+0]=e,m[4*(p+c*_)+1]=t,m[4*(p+c*_)+2]=i,m[4*(p+c*_)+3]=32768&d?0:255}return m},_getImageData24bits:function(e,t,i,s,r,n,o,a,h){const l=i,c=e.width,u=e.height;let d,p,_=0;const g=new Uint8Array(c*u*4);for(p=s;p!==n;p+=r)for(d=o;d!==h;d+=a,_+=3)g[4*(d+c*p)+3]=255,g[4*(d+c*p)+2]=l[_+0],g[4*(d+c*p)+1]=l[_+1],g[4*(d+c*p)+0]=l[_+2];return g},_getImageData32bits:function(e,t,i,s,r,n,o,a,h){const l=i,c=e.width,u=e.height;let d,p,_=0;const g=new Uint8Array(c*u*4);for(p=s;p!==n;p+=r)for(d=o;d!==h;d+=a,_+=4)g[4*(d+c*p)+2]=l[_+0],g[4*(d+c*p)+1]=l[_+1],g[4*(d+c*p)+0]=l[_+2],g[4*(d+c*p)+3]=l[_+3];return g},_getImageDataGrey8bits:function(e,t,i,s,r,n,o,a,h){const l=i,c=e.width,u=e.height;let d,p,_,g=0;const m=new Uint8Array(c*u*4);for(_=s;_!==n;_+=r)for(p=o;p!==h;p+=a,g++)d=l[g],m[4*(p+c*_)+0]=d,m[4*(p+c*_)+1]=d,m[4*(p+c*_)+2]=d,m[4*(p+c*_)+3]=255;return m},_getImageDataGrey16bits:function(e,t,i,s,r,n,o,a,h){const l=i,c=e.width,u=e.height;let d,p,_=0;const g=new Uint8Array(c*u*4);for(p=s;p!==n;p+=r)for(d=o;d!==h;d+=a,_+=2)g[4*(d+c*p)+0]=l[_+0],g[4*(d+c*p)+1]=l[_+0],g[4*(d+c*p)+2]=l[_+0],g[4*(d+c*p)+3]=l[_+1];return g}};class bo{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".tga")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=go(s);i(r.width,r.height,t.generateMipMaps,!1,(()=>{mo(t,s)}))}}O.D._TextureLoaders.push(new bo);var vo=i(87511);class yo{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".hdr")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=vo.s.RGBE_ReadHeader(s),n=vo.s.RGBE_ReadPixels(s,r),o=r.width*r.height,a=new Float32Array(4*o);for(let e=0;e<o;e+=1)a[4*e]=n[3*e],a[4*e+1]=n[3*e+1],a[4*e+2]=n[3*e+2],a[4*e+3]=1;i(r.width,r.height,t.generateMipMaps,!1,(()=>{const e=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,e._uploadDataToTextureDirectly(t,a)}))}}O.D._TextureLoaders.push(new yo);var xo,Po=i(31865);class Co{}!function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(xo||(xo={}));const To={JSModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.js",WasmModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.wasm"},So=(e,t)=>{let i;switch(e){case xo.cTFETC1:i=36196;break;case xo.cTFBC1:i=33776;break;case xo.cTFBC4:i=33779;break;case xo.cTFASTC_4x4:i=37808;break;case xo.cTFETC2:i=37496;break;case xo.cTFBC7:i=36492}if(void 0===i)throw"The chosen Basis transcoder format is not currently supported";return i};let Eo=null,Ro=null,Mo=0;const Ao=(e,t)=>{const i=e instanceof ArrayBuffer?new Uint8Array(e):e;return new Promise(((e,s)=>{(Eo||(Eo=new Promise(((e,t)=>{Ro?e(Ro):w.w1.LoadFileAsync(To.WasmModuleURL).then((i=>{if("function"!=typeof URL)return t("Basis transcoder requires an environment with a URL constructor");const s=URL.createObjectURL(new Blob([`(${Do})()`],{type:"application/javascript"}));Ro=new Worker(s);const r=i=>{"init"===i.data.action?(Ro.removeEventListener("message",r),e(Ro)):"error"===i.data.action&&t(i.data.error||"error initializing worker")};Ro.addEventListener("message",r),Ro.postMessage({action:"init",url:To.JSModuleURL,wasmBinary:i})})).catch(t)}))),Eo).then((()=>{const r=Mo++,n=t=>{"transcode"===t.data.action&&t.data.id===r&&(Ro.removeEventListener("message",n),t.data.success?e(t.data):s("Transcode is not supported on this device"))};Ro.addEventListener("message",n);const o=new Uint8Array(i.byteLength);o.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength)),Ro.postMessage({action:"transcode",id:r,imageData:o,config:t,ignoreSupportedFormats:!1},[o.buffer])}),(e=>{s(e)}))}))},Io=(e,t)=>{var i,s;let r=null===(i=t._gl)||void 0===i?void 0:i.TEXTURE_2D;e.isCube&&(r=null===(s=t._gl)||void 0===s?void 0:s.TEXTURE_CUBE_MAP),t._bindTextureDirectly(r,e,!0)},Oo=(e,t)=>{const i=e.getEngine();for(let s=0;s<t.fileInfo.images.length;s++){const r=t.fileInfo.images[s].levels[0];if(e._invertVScale=e.invertY,-1===t.format||t.format===xo.cTFRGB565)if(e.type=10,e.format=4,!i._features.basisNeedsPOT||Po.R.Log2(r.width)%1==0&&Po.R.Log2(r.height)%1==0)e._invertVScale=!e.invertY,e.width=r.width+3&-4,e.height=r.height+3&-4,e.samplingMode=2,Io(e,i),i._uploadDataToTextureDirectly(e,new Uint16Array(r.transcodedPixels.buffer),s,0,4,!0);else{const t=new Oi.l(i,Oi.S.Temp);e._invertVScale=e.invertY,t.type=10,t.format=4,t.width=r.width+3&-4,t.height=r.height+3&-4,Io(t,i),i._uploadDataToTextureDirectly(t,new Uint16Array(r.transcodedPixels.buffer),s,0,4,!0),i._rescaleTexture(t,e,i.scenes[0],i._getInternalFormat(4),(()=>{i._releaseTexture(t),Io(e,i)}))}else{e.width=r.width,e.height=r.height,e.generateMipMaps=t.fileInfo.images[s].levels.length>1;const n=wo.GetInternalFormatFromBasisFormat(t.format,i);e.format=n,Io(e,i),t.fileInfo.images[s].levels.forEach(((t,r)=>{i._uploadCompressedDataToTextureDirectly(e,n,t.width,t.height,t.transcodedPixels,s,r)})),!i._features.basisNeedsPOT||Po.R.Log2(e.width)%1==0&&Po.R.Log2(e.height)%1==0||(w.w1.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=X.x.CLAMP_ADDRESSMODE,e._cachedWrapV=X.x.CLAMP_ADDRESSMODE)}}},wo={JSModuleURL:To.JSModuleURL,WasmModuleURL:To.WasmModuleURL,GetInternalFormatFromBasisFormat:So,TranscodeAsync:Ao,LoadTextureFromTranscodeResult:Oo};function Do(){let e=null;function t(e,t,i,s,r){const n=e.getImageTranscodedSizeInBytes(t,i,s);let o=new Uint8Array(n);return e.transcodeImage(o,t,i,s,1,0)?(r&&(o=function(e,t,i,s){const r=new Uint16Array(4),n=new Uint16Array(i*s),o=i/4,a=s/4;for(let t=0;t<a;t++)for(let s=0;s<o;s++){const a=0+8*(t*o+s);r[0]=e[a]|e[a+1]<<8,r[1]=e[a+2]|e[a+3]<<8,r[2]=(2*(31&r[0])+1*(31&r[1]))/3|(2*(2016&r[0])+1*(2016&r[1]))/3&2016|(2*(63488&r[0])+1*(63488&r[1]))/3&63488,r[3]=(2*(31&r[1])+1*(31&r[0]))/3|(2*(2016&r[1])+1*(2016&r[0]))/3&2016|(2*(63488&r[1])+1*(63488&r[0]))/3&63488;for(let o=0;o<4;o++){const h=e[a+4+o];let l=(4*t+o)*i+4*s;n[l++]=r[3&h],n[l++]=r[h>>2&3],n[l++]=r[h>>4&3],n[l++]=r[h>>6&3]}}return n}(o,0,e.getImageWidth(t,i)+3&-4,e.getImageHeight(t,i)+3&-4)),o):null}onmessage=i=>{if("init"===i.data.action){if(!e){try{importScripts(i.data.url)}catch(e){postMessage({action:"error",error:e})}e=BASIS({wasmBinary:i.data.wasmBinary})}null!==e&&e.then((e=>{BASIS=e,e.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===i.data.action){const e=i.data.config,s=i.data.imageData,r=new BASIS.BasisFile(s),n=function(e){const t=e.getHasAlpha(),i=e.getNumImages(),s=[];for(let t=0;t<i;t++){const i={levels:[]},r=e.getNumLevels(t);for(let s=0;s<r;s++){const r={width:e.getImageWidth(t,s),height:e.getImageHeight(t,s)};i.levels.push(r)}s.push(i)}return{hasAlpha:t,images:s}}(r);let o=i.data.ignoreSupportedFormats?null:function(e,t){let i=null;return e.supportedCompressionFormats&&(i=e.supportedCompressionFormats.astc?10:e.supportedCompressionFormats.bc7?6:e.supportedCompressionFormats.s3tc?t.hasAlpha?3:2:e.supportedCompressionFormats.pvrtc?t.hasAlpha?9:8:e.supportedCompressionFormats.etc2?1:e.supportedCompressionFormats.etc1?0:14),i}(i.data.config,n),a=!1;null===o&&(a=!0,o=n.hasAlpha?3:2);let h=!0;r.startTranscoding()||(h=!1);const l=[];for(let i=0;i<n.images.length&&h;i++){const s=n.images[i];if(void 0===e.loadSingleImage||e.loadSingleImage===i){let n=s.levels.length;!1===e.loadMipmapLevels&&(n=1);for(let e=0;e<n;e++){const n=s.levels[e],c=t(r,i,e,o,a);if(!c){h=!1;break}n.transcodedPixels=c,l.push(n.transcodedPixels.buffer)}}}r.close(),r.delete(),a&&(o=-1),h?postMessage({action:"transcode",success:h,id:i.data.id,fileInfo:n,format:o},l):postMessage({action:"transcode",success:h,id:i.data.id})}}}Object.defineProperty(wo,"JSModuleURL",{get:function(){return To.JSModuleURL},set:function(e){To.JSModuleURL=e}}),Object.defineProperty(wo,"WasmModuleURL",{get:function(){return To.WasmModuleURL},set:function(e){To.WasmModuleURL=e}});class Bo{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".basis")}loadCubeData(e,t,i,s,r){if(Array.isArray(e))return;const n=t.getEngine().getCaps(),o={supportedCompressionFormats:{etc1:!!n.etc1,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,astc:!!n.astc,bc7:!!n.bptc}};Ao(e,o).then((e=>{const i=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;Oo(t,e),t.getEngine()._setCubeMapTextureParams(t,i),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()})).catch((e=>{w.w1.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,r&&r(e)}))}loadData(e,t,i){const s=t.getEngine().getCaps(),r={supportedCompressionFormats:{etc1:!!s.etc1,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,astc:!!s.astc,bc7:!!s.bptc}};Ao(e,r).then((e=>{const s=e.fileInfo.images[0].levels[0],r=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;i(s.width,s.height,r,-1!==e.format,(()=>{Oo(t,e)}))})).catch((e=>{w.w1.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),w.w1.Warn(`Failed to transcode Basis file: ${e}`),i(0,0,!1,!1,(()=>{}),!0)}))}}O.D._TextureLoaders.push(new Bo);var No=i(36406),Fo=i(5394),Lo=i(76922);class Vo{constructor(e,t,i,s){var r,n,o,a,h,l,c,u,d,p,_,m,f;return this.name=e,this.meshes=t,this.scene=s,this.options=i,this.options.map=null!==(r=this.options.map)&&void 0!==r?r:["ambientTexture","bumpTexture","diffuseTexture","emissiveTexture","lightmapTexture","opacityTexture","reflectionTexture","refractionTexture","specularTexture"],this.options.uvsIn=null!==(n=this.options.uvsIn)&&void 0!==n?n:me.o.UVKind,this.options.uvsOut=null!==(o=this.options.uvsOut)&&void 0!==o?o:me.o.UVKind,this.options.layout=null!==(a=this.options.layout)&&void 0!==a?a:Vo.LAYOUT_STRIP,this.options.layout===Vo.LAYOUT_COLNUM&&(this.options.colnum=null!==(h=this.options.colnum)&&void 0!==h?h:8),this.options.updateInputMeshes=null===(l=this.options.updateInputMeshes)||void 0===l||l,this.options.disposeSources=null===(c=this.options.disposeSources)||void 0===c||c,this._expecting=0,this.options.fillBlanks=null===(u=this.options.fillBlanks)||void 0===u||u,!0===this.options.fillBlanks&&(this.options.customFillColor=null!==(d=this.options.customFillColor)&&void 0!==d?d:"black"),this.options.frameSize=null!==(p=this.options.frameSize)&&void 0!==p?p:256,this.options.paddingRatio=null!==(_=this.options.paddingRatio)&&void 0!==_?_:.0115,this._paddingValue=Math.ceil(this.options.frameSize*this.options.paddingRatio),this._paddingValue%2!=0&&this._paddingValue++,this.options.paddingMode=null!==(m=this.options.paddingMode)&&void 0!==m?m:Vo.SUBUV_WRAP,this.options.paddingMode===Vo.SUBUV_COLOR&&(this.options.paddingColor=null!==(f=this.options.paddingColor)&&void 0!==f?f:new g.HE(0,0,0,1)),this.sets={},this.frames=[],this}_createFrames(e){const t=this._calculateSize(),i=new m.FM(1,1).divide(t);let s=0;const r=this._expecting,n=this.meshes.length,o=Object.keys(this.sets);for(let e=0;e<o.length;e++){const i=o[e],s=new wt.c(this.name+".TexturePack."+i+"Set",{width:t.x,height:t.y},this.scene,!0,X.x.TRILINEAR_SAMPLINGMODE,O.D.TEXTUREFORMAT_RGBA),r=s.getContext();r.fillStyle="rgba(0,0,0,0)",r.fillRect(0,0,t.x,t.y),s.update(!1),this.sets[i]=s}const a=this.options.frameSize||256,h=this._paddingValue,l=a+2*h,c=()=>{this._calculateMeshUVFrames(a,h,t,i,this.options.updateInputMeshes||!1)};for(let i=0;i<n;i++){const n=this.meshes[i].material;for(let u=0;u<o.length;u++){const d=new wt.c("temp",l,this.scene,!0),p=d.getContext(),_=this._getFrameOffset(i),m=()=>{s++,d.update(!1);const i=p.getImageData(0,0,l,l),n=this.sets[f];if(n.getContext().putImageData(i,t.x*_.x,t.y*_.y),d.dispose(),n.update(!1),s==r)return c(),void e()},f=o[u]||"_blank";if(n&&null!==n[f]){const e=n[f],t=new Image;e instanceof wt.c?t.src=e.getContext().canvas.toDataURL("image/png"):t.src=e.url,w.w1.SetCorsBehavior(t.src,t),t.onload=()=>{p.fillStyle="rgba(0,0,0,0)",p.fillRect(0,0,l,l),d.update(!1),p.setTransform(1,0,0,-1,0,0);const e=[0,0,1,0,1,1,0,1,-1,1,-1,0,-2,0,-1,1,-1];switch(this.options.paddingMode){case 0:for(let i=0;i<9;i++)p.drawImage(t,0,0,t.width,t.height,h+a*e[i],h+a*e[i+1]-l,a,a);break;case 1:for(let i=0;i<h;i++)p.drawImage(t,0,0,t.width,t.height,i+a*e[0],h-l,a,a),p.drawImage(t,0,0,t.width,t.height,2*h-i,h-l,a,a),p.drawImage(t,0,0,t.width,t.height,h,i-l,a,a),p.drawImage(t,0,0,t.width,t.height,h,2*h-i-l,a,a);p.drawImage(t,0,0,t.width,t.height,h+a*e[0],h+a*e[1]-l,a,a);break;case 2:p.fillStyle=(this.options.paddingColor||g.Wo.Black()).toHexString(),p.fillRect(0,0,l,-l),p.clearRect(h,h,a,a),p.drawImage(t,0,0,t.width,t.height,h+a*e[0],h+a*e[1]-l,a,a)}p.setTransform(1,0,0,1,0,0),m()}}else p.fillStyle="rgba(0,0,0,0)",this.options.fillBlanks&&(p.fillStyle=this.options.customFillColor),p.fillRect(0,0,l,l),m()}}}_calculateSize(){const e=this.meshes.length||0,t=this.options.frameSize||0,i=this._paddingValue||0;switch(this.options.layout){case 0:return new m.FM(t*e+2*i*e,t+2*i);case 1:{const s=Math.max(2,Math.ceil(Math.sqrt(e))),r=t*s+2*i*s;return new m.FM(r,r)}case 2:{const s=this.options.colnum||1,r=Math.max(1,Math.ceil(e/s));return new m.FM(t*s+2*i*s,t*r+2*i*r)}}return m.FM.Zero()}_calculateMeshUVFrames(e,t,i,s,r){const n=this.meshes.length;for(let o=0;o<n;o++){const n=this.meshes[o],a=new m.FM(e/i.x,e/i.y),h=s.clone().scale(t),l=this._getFrameOffset(o).add(h),c=new Lo.p(o,a,l);this.frames.push(c),r&&(this._updateMeshUV(n,o),this._updateTextureReferences(n))}}_getFrameOffset(e){const t=this.meshes.length;let i,s,r;switch(this.options.layout){case 0:return i=1/t,new m.FM(e*i,0);case 1:{const n=Math.max(2,Math.ceil(Math.sqrt(t)));return s=Math.floor(e/n),r=e-s*n,i=1/n,new m.FM(r*i,s*i)}case 2:{const n=this.options.colnum||1,o=Math.max(1,Math.ceil(t/n));return r=Math.floor(e/o),s=e-r*o,i=new m.FM(1/n,1/o),new m.FM(r*i.x,s*i.y)}}return m.FM.Zero()}_updateMeshUV(e,t){const i=this.frames[t],s=e.getVerticesData(this.options.uvsIn||me.o.UVKind),r=[];let n=0;s.length&&(n=s.length||0);for(let e=0;e<n;e+=2)r.push(s[e]*i.scale.x+i.offset.x,s[e+1]*i.scale.y+i.offset.y);e.setVerticesData(this.options.uvsOut||me.o.UVKind,r)}_updateTextureReferences(e,t=!1){const i=e.material,s=Object.keys(this.sets),r=e=>{e.dispose&&e.dispose()};for(let e=0;e<s.length;e++){const n=s[e];if(t)null!==i[n]&&r(i[n]),i[n]=this.sets[n];else{if(!i)return;null!==i[n]&&(r(i[n]),i[n]=this.sets[n])}}}setMeshToFrame(e,t,i=!1){this._updateMeshUV(e,t),i&&this._updateTextureReferences(e,!0)}processAsync(){return new Promise(((e,t)=>{try{if(0===this.meshes.length)return void e();let t=0;const i=i=>{if(t++,this.options.map){for(let e=0;e<this.options.map.length;e++)null!==i[this.options.map[e]]&&(this.sets[this.options.map[e]]||(this.sets[this.options.map[e]]=!0),this._expecting++);t===this.meshes.length&&this._createFrames(e)}};for(let s=0;s<this.meshes.length;s++){const r=this.meshes[s],n=r.material;if(n)n.forceCompilationAsync(r).then((()=>{i(n)}));else if(t++,t===this.meshes.length)return this._createFrames(e)}}catch(e){return t(e)}}))}dispose(){const e=Object.keys(this.sets);for(let t=0;t<e.length;t++){const i=e[t];this.sets[i].dispose()}}download(e="png",t=1){setTimeout((()=>{const i={name:this.name,sets:{},options:{},frames:[]},s=Object.keys(this.sets),r=Object.keys(this.options);try{for(let r=0;r<s.length;r++){const n=s[r],o=this.sets[n];i.sets[n]=o.getContext().canvas.toDataURL("image/"+e,t)}for(let e=0;e<r.length;e++){const t=r[e];i.options[t]=this.options[t]}for(let e=0;e<this.frames.length;e++){const t=this.frames[e];i.frames.push(t.scale.x,t.scale.y,t.offset.x,t.offset.y)}}catch(e){return void p.Y.Warn("Unable to download: "+e)}const n="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(i,null,4)),o=document.createElement("a");o.setAttribute("href",n),o.setAttribute("download",this.name+"_texurePackage.json"),document.body.appendChild(o),o.click(),o.remove()}),0)}updateFromJSON(e){try{const t=JSON.parse(e);this.name=t.name;const i=Object.keys(t.options);for(let e=0;e<i.length;e++)this.options[i[e]]=t.options[i[e]];for(let e=0;e<t.frames.length;e+=4){const i=new Lo.p(e/4,new m.FM(t.frames[e],t.frames[e+1]),new m.FM(t.frames[e+2],t.frames[e+3]));this.frames.push(i)}const s=Object.keys(t.sets);for(let e=0;e<s.length;e++){const i=new X.x(t.sets[s[e]],this.scene,!1,!1);this.sets[s[e]]=i}}catch(e){p.Y.Warn("Unable to update from JSON: "+e)}}}Vo.LAYOUT_STRIP=0,Vo.LAYOUT_POWER2=1,Vo.LAYOUT_COLNUM=2,Vo.SUBUV_WRAP=0,Vo.SUBUV_EXTEND=1,Vo.SUBUV_COLOR=2;var ko=i(45751),zo=i(22059);class Go extends ko.g{constructor(e,t,i,s,r,n,o){super(e,i,null,s,r,n),this._animate=!0,this._time=0,this._texturePath=t,o?this.setFragment(this._texturePath):this._loadJson(t),this.refreshRate=1}_loadJson(e){const t=()=>{try{this.setFragment(this._texturePath)}catch(e){p.Y.Log("No json or ShaderStore or DOM element found for CustomProceduralTexture")}},i=e+"/config.json",s=new zo.g;s.open("GET",i),s.addEventListener("load",(()=>{if(200===s.status||s.responseText&&s.responseText.length>0)try{this._config=JSON.parse(s.response),this.updateShaderUniforms(),this.updateTextures(),this.setFragment(this._texturePath+"/custom"),this._animate=this._config.animate,this.refreshRate=this._config.refreshrate}catch(e){t()}else t()}),!1),s.addEventListener("error",(()=>{t()}),!1);try{s.send()}catch(e){p.Y.Error("CustomProceduralTexture: Error on XHR send request.")}}isReady(){if(!super.isReady())return!1;for(const e in this._textures)if(!this._textures[e].isReady())return!1;return!0}render(e){const t=this.getScene();this._animate&&t&&(this._time+=.03*t.getAnimationRatio(),this.updateShaderUniforms()),super.render(e)}updateTextures(){for(let e=0;e<this._config.sampler2Ds.length;e++)this.setTexture(this._config.sampler2Ds[e].sample2Dname,new X.x(this._texturePath+"/"+this._config.sampler2Ds[e].textureRelativeUrl,this.getScene()))}updateShaderUniforms(){if(this._config)for(let e=0;e<this._config.uniforms.length;e++){const t=this._config.uniforms[e];switch(t.type){case"float":this.setFloat(t.name,t.value);break;case"color3":this.setColor3(t.name,new g.Wo(t.r,t.g,t.b));break;case"color4":this.setColor4(t.name,new g.HE(t.r,t.g,t.b,t.a));break;case"vector2":this.setVector2(t.name,new m.FM(t.x,t.y));break;case"vector3":this.setVector3(t.name,new m.P(t.x,t.y,t.z))}}this.setFloat("time",this._time)}get animate(){return this._animate}set animate(e){this._animate=e}}i(67608);class Uo extends ko.g{constructor(e,t=256,i=D.l.LastCreatedScene,s,r){super(e,t,"noise",i,s,r),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this._updateShaderUniforms()}_updateShaderUniforms(){const e=this.getScene();e&&(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}_getDefines(){return"#define OCTAVES "+(0|this.octaves)}render(e){this._updateShaderUniforms(),super.render(e)}serialize(){const e={customType:"BABYLON.NoiseProceduralTexture"};return e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e}clone(){const e=this.getSize(),t=new Uo(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t}static Parse(e,t){var i;const s=new Uo(e.name,e.size,t,void 0,e.generateMipMaps);return s.brightness=e.brightness,s.octaves=e.octaves,s.persistence=e.persistence,s.animationSpeedFactor=e.animationSpeedFactor,s.time=null!==(i=e.time)&&void 0!==i?i:0,s}}(0,c.H)("BABYLON.NoiseProceduralTexture",Uo);var Wo=i(18754),Ho=i(1011),jo=i(32022);class $o extends X.x{constructor(e,t,i,s,r,n,o=!0,a=!1,h=X.x.TRILINEAR_SAMPLINGMODE,l=0,c){super(null,n,!o,a),this.format=r,this._texture=n.getEngine().createRawTexture3D(e,t,i,s,r,o,a,h,null,l,c),this.is3D=!0}update(e){this._texture&&this._getEngine().updateRawTexture3D(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}}var Yo=i(8329);class Xo extends Ur._{constructor(e,t,i,s){super(e,t,i,s,!0),this.refractionPlane=new Yo.J(0,1,0,1),this.depth=2,this.onBeforeRenderObservable.add((()=>{this.getScene().clipPlane=this.refractionPlane})),this.onAfterRenderObservable.add((()=>{this.getScene().clipPlane=null}))}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new Xo(this.name,t.width,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.refractionPlane=this.refractionPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i.depth=this.depth,i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.refractionPlane.asArray(),e.depth=this.depth,e}}var Qo=i(34041),qo=i(26270);class Ko extends qo.g{get renderTarget(){return this._renderTarget}constructor(e,t,i){super(null),this._renderTarget=null,this._engine=e,this._renderTargetOptions=i,this.resize(t)}resize(e){var t;null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null,this._texture=null,this._size=e,this._engine&&(this._renderTarget=this._engine.createRenderTargetTexture(this._size,this._renderTargetOptions)),this._texture=this.renderTarget.texture}getInternalTexture(){return this._texture}getClassName(){return"ThinRenderTargetTexture"}dispose(e=!1){var t;null===(t=this._renderTarget)||void 0===t||t.dispose(!0),this._renderTarget=null,e||super.dispose()}}var Zo=i(33873),Jo=i(53243),ea=i(99527),ta=i(17529),ia=i(36737),sa=i(52502),ra=i(98671),na=i(27559),oa=i(47994),aa=i(11947),ha=i(17026),la=i(86251);i(1041),i(86886);class ca extends aa.k{constructor(e){super(e,ea.u.Vertex),this.registerInput("matricesIndices",ta.E.Vector4),this.registerInput("matricesWeights",ta.E.Vector4),this.registerInput("matricesIndicesExtra",ta.E.Vector4,!0),this.registerInput("matricesWeightsExtra",ta.E.Vector4,!0),this.registerInput("world",ta.E.Matrix),this.registerOutput("output",ta.E.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e,t=(()=>!0)){if(!this.matricesIndices.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesIndices"===e.name&&t(e)));i||(i=new la.S("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesWeights"===e.name&&t(e)));i||(i=new la.S("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===sa.$.World&&t(e)));i||(i=new la.S("world"),i.setAsSystemValue(sa.$.World)),i.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){Nn.G.BindBonesParameters(i,e)}prepareDefines(e,t,i){i._areAttributesDirty&&Nn.G.PrepareDefinesForBones(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const s=this._outputs[0],r=this.world;return e.compilationString+="#if NUM_BONE_INFLUENCERS>0\n",e.compilationString+=this._declareOutput(s,e)+` = ${r.associatedVariableName} * ${i};\n`,e.compilationString+="#else\n",e.compilationString+=this._declareOutput(s,e)+` = ${r.associatedVariableName};\n`,e.compilationString+="#endif\n",this}}(0,c.H)("BABYLON.BonesBlock",ca);class ua extends aa.k{constructor(e){super(e,ea.u.Vertex),this.registerInput("world0",ta.E.Vector4),this.registerInput("world1",ta.E.Vector4),this.registerInput("world2",ta.E.Vector4),this.registerInput("world3",ta.E.Vector4),this.registerInput("world",ta.E.Matrix,!0),this.registerOutput("output",ta.E.Matrix),this.registerOutput("instanceID",ta.E.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e,t=(()=>!0)){if(!this.world0.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world0"===e.name&&t(e)));i||(i=new la.S("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world1"===e.name&&t(e)));i||(i=new la.S("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world2"===e.name&&t(e)));i||(i=new la.S("world2"),i.setAsAttribute("world2")),i.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world3"===e.name&&t(e)));i||(i=new la.S("world3"),i.setAsAttribute("world3")),i.output.connectTo(this.world3)}if(!this.world.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world"===e.name&&t(e)));i||(i=new la.S("world"),i.setAsSystemValue(sa.$.World)),i.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,s=!1,r){let n=!1;i.INSTANCES!==s&&(i.setValue("INSTANCES",s),n=!0),r&&i.THIN_INSTANCES!==!!(null==r?void 0:r.getRenderingMesh().hasThinInstances)&&(i.setValue("THIN_INSTANCES",!!(null==r?void 0:r.getRenderingMesh().hasThinInstances)),n=!0),n&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],s=this._outputs[1],r=this.world0,n=this.world1,o=this.world2,a=this.world3;return e.compilationString+="#ifdef INSTANCES\n",e.compilationString+=this._declareOutput(i,e)+` = mat4(${r.associatedVariableName}, ${n.associatedVariableName}, ${o.associatedVariableName}, ${a.associatedVariableName});\n`,e.compilationString+="#ifdef THIN_INSTANCES\n",e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};\n`,e.compilationString+="#endif\n",t._caps.canUseGLInstanceID?e.compilationString+=this._declareOutput(s,e)+" = float(gl_InstanceID);\n":e.compilationString+=this._declareOutput(s,e)+" = 0.0;\n",e.compilationString+="#else\n",e.compilationString+=this._declareOutput(i,e)+` = ${this.world.associatedVariableName};\n`,e.compilationString+=this._declareOutput(s,e)+" = 0.0;\n",e.compilationString+="#endif\n",this}}(0,c.H)("BABYLON.InstancesBlock",ua);var da=i(23103);class pa extends aa.k{constructor(e){super(e,ea.u.Vertex),this.registerInput("worldPosition",ta.E.Vector4,!1,ea.u.Vertex),this.registerOutput("direction",ta.E.Vector3),this.registerOutput("color",ta.E.Color3),this.registerOutput("intensity",ta.E.Float),this.registerOutput("shadowBias",ta.E.Float),this.registerOutput("shadowNormalBias",ta.E.Float),this.registerOutput("shadowDepthScale",ta.E.Float),this.registerOutput("shadowDepthRange",ta.E.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let s=this.light;const r=t.getScene();if(!s&&r.lights.length&&(s=this.light=r.lights[0],this._forcePrepareDefines=!0),!s||!s.isEnabled)return e.setFloat3(this._lightDataUniformName,0,0,0),void e.setFloat4(this._lightColorUniformName,0,0,0,0);s.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,s.diffuse,s.intensity);const n=s.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(n?e.setFloat3(this._lightShadowUniformName,n.bias,n.normalBias,n.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(n&&r.activeCamera){const t=s;e.setFloat2(this._lightShadowExtraUniformName,t.getDepthMinZ(r.activeCamera),t.getDepthMinZ(r.activeCamera)+t.getDepthMaxZ(r.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const s=this.light;i.setValue(this._lightTypeDefineName,!!(s&&s instanceof nn.c),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,s=this.intensity,r=this.shadowBias,n=this.shadowNormalBias,o=this.shadowDepthScale,a=this.shadowDepthRange;return this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE"),e._emitUniformFromString(this._lightDataUniformName,"vec3"),e._emitUniformFromString(this._lightColorUniformName,"vec4"),e.compilationString+=`#ifdef ${this._lightTypeDefineName}\n`,e.compilationString+=this._declareOutput(t,e)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${this._lightDataUniformName});\n`,e.compilationString+="#else\n",e.compilationString+=this._declareOutput(t,e)+` = ${this._lightDataUniformName};\n`,e.compilationString+="#endif\n",e.compilationString+=this._declareOutput(i,e)+` = ${this._lightColorUniformName}.rgb;\n`,e.compilationString+=this._declareOutput(s,e)+` = ${this._lightColorUniformName}.a;\n`,(r.hasEndpoints||n.hasEndpoints||o.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,"vec3"),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = ${this._lightShadowUniformName}.x;\n`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${this._lightShadowUniformName}.y;\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${this._lightShadowUniformName}.z;\n`)),a.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,"vec2"),e.compilationString+=this._declareOutput(a,e)+` = ${this._lightShadowUniformName};\n`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}}(0,c.H)("BABYLON.LightInformationBlock",pa);var _a=i(65063),ga=i(83304);i(62339),i(47619),i(66914);class ma extends aa.k{constructor(e){super(e,ea.u.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",ta.E.AutoDetect),this.registerOutput("output",ta.E.Color4),this.registerOutput("rgb",ta.E.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(ta.E.Color3|ta.E.Color4|ta.E.Vector3|ta.E.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity")}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){i&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_buildBlock(e){var t;super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const i=this.color,s=this._outputs[0],r=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),(null===(t=i.connectedPoint)||void 0===t?void 0:t.isConnected)&&(i.connectedPoint.type===ta.E.Color4||i.connectedPoint.type===ta.E.Vector4?e.compilationString+=`${this._declareOutput(s,e)} = ${i.associatedVariableName};\n`:e.compilationString+=`${this._declareOutput(s,e)} = vec4(${i.associatedVariableName}, 1.0);\n`,e.compilationString+="#ifdef IMAGEPROCESSINGPOSTPROCESS\n",this.convertInputToLinearSpace&&(e.compilationString+=`${s.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\n`),e.compilationString+="#else\n",e.compilationString+="#ifdef IMAGEPROCESSING\n",this.convertInputToLinearSpace&&(e.compilationString+=`${s.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\n`),e.compilationString+=`${s.associatedVariableName} = applyImageProcessing(${s.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+="#endif\n",this.rgb.hasEndpoints&&(e.compilationString+=this._declareOutput(this.rgb,e)+` = ${this.output.associatedVariableName}.xyz;\n`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};\n`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.convertInputToLinearSpace=null===(s=e.convertInputToLinearSpace)||void 0===s||s}}(0,H.gn)([(0,ga.p)("Convert input to linear space",ga.U.Boolean,"ADVANCED")],ma.prototype,"convertInputToLinearSpace",void 0),(0,c.H)("BABYLON.ImageProcessingBlock",ma);var fa=i(88157);i(49486),i(88189),i(11870);class ba extends aa.k{constructor(e){super(e,ea.u.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",ta.E.Vector4,!1),this.registerInput("worldNormal",ta.E.Vector4,!1),this.registerInput("worldTangent",ta.E.Vector4,!0),this.registerInput("uv",ta.E.Vector2,!1),this.registerInput("normalMapColor",ta.E.Color3,!1),this.registerInput("strength",ta.E.Float,!1),this.registerInput("viewDirection",ta.E.Vector3,!0),this.registerInput("parallaxScale",ta.E.Float,!0),this.registerInput("parallaxHeight",ta.E.Float,!0),this.registerInput("TBN",ta.E.Object,!0,ea.u.VertexAndFragment,new na.C("TBN",this,oa.Ab.Input,fa.v,"TBNBlock")),this.registerInput("world",ta.E.Matrix,!0),this.registerOutput("output",ta.E.Vector4),this.registerOutput("uvOffset",ta.E.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}prepareDefines(e,t,i){const s=this.normalMapColor.connectedPoint._ownerBlock.samplerName,r=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&s||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",r,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e,t=(()=>!0)){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv"===e.name&&t(e)));i||(i=new la.S("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){const e=new la.S("strength");e.value=1,e.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,s=this.worldPosition,r=this.worldNormal,n=this.worldTangent;e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,"vec2"),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float"),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,"mat4");let o=null;this.normalMapColor.connectedPoint&&(o=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const a=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&o||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),h=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",l=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${e._emitFloat(this.strength.connectInputBlock.value)}`:`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${this.strength.associatedVariableName}`;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const c={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},u=this.TBN;u.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${u.associatedVariableName};\n            #endif\n            `:n.isConnected&&(e.compilationString+=`vec3 tbnNormal = normalize(${r.associatedVariableName}.xyz);\n`,e.compilationString+=`vec3 tbnTangent = normalize(${n.associatedVariableName}.xyz);\n`,e.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,e.compilationString+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\n"),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:[c,{search:/varying mat3 vTBN;/g,replace:""},{search:/uniform mat4 normalMatrix;/g,replace:""}]}),e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,replace:"#define inline\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)"},{search:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g,replace:"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)"},{search:/texture2D\(bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const d=a&&o?`texture2D(${o}, ${i.associatedVariableName} + uvOffset).xyz`:this.normalMapColor.associatedVariableName;return e.compilationString+=this._declareOutput(this.output,e)+" = vec4(0.);\n",e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:[{search:/texture2D\(bumpSampler,vBumpUV\)/g,replace:`${d}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`mat4 normalMatrix = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:/perturbNormal\(TBN,texture2D\(bumpSampler,vBumpUV\+uvOffset\).xyz,vBumpInfos.y\)/g,replace:`perturbNormal(TBN, ${d}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${a&&this.useParallaxOcclusion?o:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${a?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vTangentSpaceParams/g,replace:this._tangentSpaceParameterName},{search:/vBumpInfos.y/g,replace:l},{search:/vBumpInfos.z/g,replace:h},{search:/vBumpUV/g,replace:i.associatedVariableName},{search:/vPositionW/g,replace:s.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:r.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:a?this.viewDirection.associatedVariableName:"vec3(0.)"},c]}),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};\n`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};\n`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\n`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};\n`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}}(0,H.gn)([(0,ga.p)("Invert X axis",ga.U.Boolean,"PROPERTIES",{notifiers:{update:!1}})],ba.prototype,"invertX",void 0),(0,H.gn)([(0,ga.p)("Invert Y axis",ga.U.Boolean,"PROPERTIES",{notifiers:{update:!1}})],ba.prototype,"invertY",void 0),(0,H.gn)([(0,ga.p)("Use parallax occlusion",ga.U.Boolean)],ba.prototype,"useParallaxOcclusion",void 0),(0,H.gn)([(0,ga.p)("Object Space Mode",ga.U.Boolean,"PROPERTIES",{notifiers:{update:!1}})],ba.prototype,"useObjectSpaceNormalMap",void 0),(0,c.H)("BABYLON.PerturbNormalBlock",ba);class va extends aa.k{constructor(e){super(e,ea.u.Fragment,!0),this.registerInput("value",ta.E.Float,!0),this.registerInput("cutoff",ta.E.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,this.cutoff.isConnected&&this.value.isConnected)return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) discard;\n`,this}}(0,c.H)("BABYLON.DiscardBlock",va);class ya extends aa.k{constructor(e){super(e,ea.u.Fragment),this.registerOutput("output",ta.E.Float,ea.u.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===ea.u.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = gl_FrontFacing ? 1.0 : 0.0;\n",this}}(0,c.H)("BABYLON.FrontFacingBlock",ya);class xa extends aa.k{constructor(e){super(e,ea.u.Fragment),this.registerInput("input",ta.E.AutoDetect,!1),this.registerOutput("dx",ta.E.BasedOnInput),this.registerOutput("dy",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),t.hasEndpoints&&(e.compilationString+=this._declareOutput(t,e)+` = dFdx(${this.input.associatedVariableName});\n`),i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = dFdy(${this.input.associatedVariableName});\n`),this}}(0,c.H)("BABYLON.DerivativeBlock",xa);class Pa extends aa.k{constructor(e){super(e,ea.u.Fragment),this.registerOutput("xy",ta.E.Vector2,ea.u.Fragment),this.registerOutput("xyz",ta.E.Vector3,ea.u.Fragment),this.registerOutput("xyzw",ta.E.Vector4,ea.u.Fragment),this.registerOutput("x",ta.E.Float,ea.u.Fragment),this.registerOutput("y",ta.E.Float,ea.u.Fragment),this.registerOutput("z",ta.E.Float,ea.u.Fragment),this.registerOutput("w",ta.E.Float,ea.u.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";for(const i of this._outputs)i.hasEndpoints&&(t+=`${this._declareOutput(i,e)} = gl_FragCoord.${i.name};\n`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===ea.u.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}(0,c.H)("BABYLON.FragCoordBlock",Pa);class Ca extends aa.k{constructor(e){super(e,ea.u.Fragment),this.registerOutput("xy",ta.E.Vector2,ea.u.Fragment),this.registerOutput("x",ta.E.Float,ea.u.Fragment),this.registerOutput("y",ta.E.Float,ea.u.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const s of this._outputs)s.hasEndpoints&&(i+=`${this._declareOutput(s,e)} = ${t}.${s.name};\n`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===ea.u.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,"vec2"),e.compilationString+=this.writeOutputs(e,this._varName),this}}(0,c.H)("BABYLON.ScreenSizeBlock",Ca);class Ta extends aa.k{constructor(e){super(e,ea.u.Fragment),this.registerInput("vector",ta.E.AutoDetect),this.registerInput("worldViewProjection",ta.E.Matrix),this.registerOutput("output",ta.E.Vector2),this.registerOutput("x",ta.E.Float),this.registerOutput("y",ta.E.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(ta.E.Color3|ta.E.Vector3|ta.E.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e,t=(()=>!0)){if(!this.worldViewProjection.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===sa.$.WorldViewProjection&&t(e)));i||(i=new la.S("worldViewProjection"),i.setAsSystemValue(sa.$.WorldViewProjection)),i.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;const s=i.associatedVariableName,r=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case ta.E.Vector3:e.compilationString+=`vec4 ${r} = ${s} * vec4(${t.associatedVariableName}, 1.0);\n`;break;case ta.E.Vector4:e.compilationString+=`vec4 ${r} = ${s} * ${t.associatedVariableName};\n`}return e.compilationString+=`${r}.xy /= ${r}.w;`,e.compilationString+=`${r}.xy = ${r}.xy * 0.5 + vec2(0.5, 0.5);`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${r}.xy;\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${r}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${r}.y;\n`),this}}(0,c.H)("BABYLON.ScreenSpaceBlock",Ta);class Sa extends aa.k{constructor(e){super(e,ea.u.Fragment),this.registerInput("input",ta.E.Vector2),this.registerInput("strength",ta.E.Float),this.registerInput("center",ta.E.Vector2),this.registerInput("offset",ta.E.Vector2),this.registerOutput("output",ta.E.Vector2),this.registerOutput("x",ta.E.Float),this.registerOutput("y",ta.E.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new la.S("center");e.value=new m.FM(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new la.S("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new la.S("offset");e.value=new m.FM(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),s=e._getFreeVariableName("x"),r=e._getFreeVariableName("y"),n=e._getFreeVariableName("result");return e.compilationString+=`\n            vec2 ${t} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};\n            float ${i} = ${this.strength.associatedVariableName} * length(${t});\n            float ${s} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;\n            float ${r} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;\n            vec2 ${n} = vec2(${s} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${r} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);\n        `,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${n};\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${n}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${n}.y;\n`),this}}(0,c.H)("BABYLON.TwirlBlock",Sa);class Ea extends aa.k{constructor(e){super(e,ea.u.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",ta.E.Float),this.registerInput("worldPosition",ta.E.Vector3),this.registerInput("worldNormal",ta.E.Vector3),this.registerInput("worldTangent",ta.E.AutoDetect,!0),this.registerOutput("output",ta.E.Vector4),this.registerOutput("xyz",ta.E.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(ta.E.Color3|ta.E.Vector3|ta.E.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];this.generateInWorldSpace||this.worldTangent.isConnected||console.error(`You must connect the 'worldTangent' input of the ${this.name} block!`);const i=this.generateInWorldSpace?"":"\n            vec3 biTangent = cross(normal, tangent);\n            mat3 TBN = mat3(tangent, biTangent, normal);\n            ",s=this.generateInWorldSpace?"":"\n            result = TBN * result;\n            result = result * vec3(0.5) + vec3(0.5);\n            ",r=`\n            vec4 heightToNormal(in float height, in vec3 position, in vec3 tangent, in vec3 normal) {\n                ${i}\n                ${this.automaticNormalizationTangent?"tangent = normalize(tangent);":""}\n                ${this.automaticNormalizationNormal?"normal = normalize(normal);":""}\n                vec3 worlddX = dFdx(position);\n                vec3 worlddY = dFdy(position);\n                vec3 crossX = cross(normal, worlddX);\n                vec3 crossY = cross(normal, worlddY);\n                float d = abs(dot(crossY, worlddX));\n                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));\n                inToNormal.y *= -1.0;\n                vec3 result = normalize((d * normal) - inToNormal);\n                ${s}\n                return vec4(result, 0.);\n            }`;return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",r,"// heightToNormal"),e.compilationString+=this._declareOutput(t,e)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:"vec3(0.)"}.xyz, ${this.worldNormal.associatedVariableName});\n`,this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\n`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};\n`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};\n`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};\n`,e}serialize(){const e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}(0,H.gn)([(0,ga.p)("Generate in world space instead of tangent space",ga.U.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Ea.prototype,"generateInWorldSpace",void 0),(0,H.gn)([(0,ga.p)("Force normalization for the worldNormal input",ga.U.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Ea.prototype,"automaticNormalizationNormal",void 0),(0,H.gn)([(0,ga.p)("Force normalization for the worldTangent input",ga.U.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Ea.prototype,"automaticNormalizationTangent",void 0),(0,c.H)("BABYLON.HeightToNormalBlock",Ea);class Ra extends aa.k{constructor(e){super(e,ea.u.Fragment,!0),this.registerInput("depth",ta.E.Float,!0),this.registerInput("worldPos",ta.E.Vector4,!0),this.registerInput("viewProjection",ta.E.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){return super._buildBlock(e),this.depth.isConnected?e.compilationString+=`gl_FragDepth = ${this.depth.associatedVariableName};\n`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`\n                vec4 p = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};\n                float v = p.z / p.w;\n                #ifndef IS_NDC_HALF_ZRANGE\n                    v = v * 0.5 + 0.5;\n                #endif\n                gl_FragDepth = v;\n    \n            `:console.warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}(0,c.H)("BABYLON.FragDepthBlock",Ra);class Ma extends aa.k{constructor(e){super(e,ea.u.Fragment),this.registerInput("worldPosition",ta.E.Vector4,!1),this.registerInput("viewProjection",ta.E.Matrix,!1),this.registerInput("worldNormal",ta.E.AutoDetect,!0),this.registerOutput("depth",ta.E.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(ta.E.Color3|ta.E.Vector3|ta.E.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM")}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitUniformFromString("biasAndScaleSM","vec3"),e._emitUniformFromString("lightDataSM","vec3"),e._emitUniformFromString("depthValuesSM","vec2"),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`vec4 worldPos = ${this.worldPosition.associatedVariableName};\n`,e.compilationString+="vec3 vPositionWSM;\n",e.compilationString+="float vDepthMetricSM = 0.0;\n",e.compilationString+="float zSM;\n",this.worldNormal.isConnected&&(e.compilationString+=`vec3 vNormalW = ${this.worldNormal.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`vec4 clipPos = ${this.viewProjection.associatedVariableName} * worldPos;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]}),e.compilationString+="\n            #if SM_DEPTHTEXTURE == 1\n                #ifdef IS_NDC_HALF_ZRANGE\n                    gl_FragDepth = (clipPos.z / clipPos.w);\n                #else\n                    gl_FragDepth = (clipPos.z / clipPos.w) * 0.5 + 0.5;\n                #endif\n            #endif\n        ",e.compilationString+=`${this._declareOutput(this.depth,e)} = vec3(depthSM, 1., 1.);\n`,this}}(0,c.H)("BABYLON.ShadowMapBlock",Ma);class Aa extends aa.k{constructor(e){super(e,ea.u.Fragment,!0),this.registerInput("viewDepth",ta.E.Float,!0),this.registerInput("worldPosition",ta.E.AutoDetect,!0),this.registerInput("viewNormal",ta.E.AutoDetect,!0),this.inputs[1].addExcludedConnectionPointFromAllowedTypes(ta.E.Vector3|ta.E.Vector4),this.inputs[2].addExcludedConnectionPointFromAllowedTypes(ta.E.Vector3|ta.E.Vector4)}getClassName(){return"PrePassOutputBlock"}get viewDepth(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get viewNormal(){return this._inputs[2]}_buildBlock(e){super._buildBlock(e);const t=this.worldPosition,i=this.viewNormal,s=this.viewDepth;e.sharedData.blocksWithDefines.push(this);const r=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",r),e.compilationString+="#if defined(PREPASS)\r\n",e.compilationString+="#ifdef PREPASS_DEPTH\r\n",s.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_DEPTH_INDEX] = vec4(${s.associatedVariableName}, 0.0, 0.0, 1.0);\r\n`:e.compilationString+=" gl_FragData[PREPASS_DEPTH_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_POSITION\r\n",t.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_POSITION_INDEX] = vec4(${t.associatedVariableName}.rgb, ${t.connectedPoint.type===ta.E.Vector4?t.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_POSITION_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_NORMAL\r\n",i.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_NORMAL_INDEX] = vec4(${i.associatedVariableName}.rgb, ${i.connectedPoint.type===ta.E.Vector4?i.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_NORMAL_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#endif\r\n",this}}(0,c.H)("BABYLON.PrePassOutputBlock",Aa),i(50796);class Ia extends aa.k{constructor(e){super(e,ea.u.VertexAndFragment,!1),this.registerInput("worldPosition",ta.E.Vector4,!1,ea.u.Vertex),this.registerInput("view",ta.E.Matrix,!1,ea.u.Vertex),this.registerInput("input",ta.E.AutoDetect,!1,ea.u.Fragment),this.registerInput("fogColor",ta.E.AutoDetect,!1,ea.u.Fragment),this.registerOutput("output",ta.E.Color3,ea.u.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(ta.E.Color3|ta.E.Vector3|ta.E.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(ta.E.Color3|ta.E.Vector3|ta.E.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e,t=(()=>!0)){if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===sa.$.View&&t(e)));i||(i=new la.S("view"),i.setAsSystemValue(sa.$.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===sa.$.FogColor&&t(e)));i||(i=new la.S("fogColor",void 0,ta.E.Color3),i.setAsSystemValue(sa.$.FogColor)),i.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){const s=e.getScene();i.setValue("FOG",t.fogEnabled&&Nn.G.GetFogState(e,s))}bind(e,t,i){if(!i)return;const s=i.getScene();e.setFloat4(this._fogParameters,s.fogMode,s.fogStart,s.fogEnd,s.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===ea.u.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});const t=e._getFreeVariableName("fog"),i=this.input,s=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const r=this._outputs[0];e._emitUniformFromString(this._fogParameters,"vec4"),e.compilationString+="#ifdef FOG\n",e.compilationString+=`float ${t} = CalcFogFactor(${this._fogDistanceName}, ${this._fogParameters});\n`,e.compilationString+=this._declareOutput(r,e)+` = ${t} * ${i.associatedVariableName}.rgb + (1.0 - ${t}) * ${s.associatedVariableName}.rgb;\n`,e.compilationString+=`#else\n${this._declareOutput(r,e)} =  ${i.associatedVariableName}.rgb;\n`,e.compilationString+="#endif\n"}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,"vec3"),e.compilationString+=`${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;\n`}return this}}(0,c.H)("BABYLON.FogBlock",Ia),i(56866),i(5988),i(53433),i(38199),i(61237),i(87839),i(88445),i(76044);class Oa extends aa.k{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?ea.u.Fragment:ea.u.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?ea.u.Fragment:ea.u.Vertex}constructor(e){super(e,ea.u.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",ta.E.Vector4,!1,ea.u.Vertex),this.registerInput("worldNormal",ta.E.Vector4,!1,ea.u.Fragment),this.registerInput("cameraPosition",ta.E.Vector3,!1,ea.u.Fragment),this.registerInput("glossiness",ta.E.Float,!0,ea.u.Fragment),this.registerInput("glossPower",ta.E.Float,!0,ea.u.Fragment),this.registerInput("diffuseColor",ta.E.Color3,!0,ea.u.Fragment),this.registerInput("specularColor",ta.E.Color3,!0,ea.u.Fragment),this.registerInput("view",ta.E.Matrix,!0),this.registerOutput("diffuseOutput",ta.E.Color3,ea.u.Fragment),this.registerOutput("specularOutput",ta.E.Color3,ea.u.Fragment),this.registerOutput("shadow",ta.E.Float,ea.u.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}autoConfigure(e,t=(()=>!0)){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===sa.$.CameraPosition&&t(e)));i||(i=new la.S("cameraPosition"),i.setAsSystemValue(sa.$.CameraPosition)),i.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;const s=e.getScene();if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Nn.G.PrepareDefinesForLight(s,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else Nn.G.PrepareDefinesForLights(s,e,i,!0,t.maxSimultaneousLights)}updateUniformsAndSamples(e,t,i,s){for(let r=0;r<t.maxSimultaneousLights&&i["LIGHT"+r];r++){const t=e.uniforms.indexOf("vLightData"+r)>=0;Nn.G.PrepareUniformsAndSamplersForLight(r,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+r],s,t)}}bind(e,t,i){if(!i)return;const s=i.getScene();this.light?Nn.G.BindLight(this.light,this._lightId,s,e,!0):Nn.G.BindLights(s,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const s="v_"+t.associatedVariableName;e._emitVaryingFromString(s,"vec4")&&(e.compilationString+=`${s} = ${t.associatedVariableName};\n`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${t.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_buildBlock(e){if(super._buildBlock(e),e.target!==ea.u.Fragment)return void this._injectVertexCode(e);this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=`//${this.name}`,i=this.worldPosition;let s=i.associatedVariableName;this.generateOnlyFragmentCode?(s=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`vec3 ${s};\n`,t),e.compilationString+=`${s} = ${i.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${i.associatedVariableName}`:void 0})):s="v_"+s+".xyz",e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("lightsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:s}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:s}]}),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),0===this._lightId&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${s});\n`),e.compilationString+="lightingInfo info;\n",e.compilationString+="float shadow = 1.;\n",e.compilationString+="float aggShadow = 0.;\n",e.compilationString+="float numLights = 0.;\n",e.compilationString+=`float glossiness = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};\n`,e.compilationString+="vec3 diffuseBase = vec3(0., 0., 0.);\n",e.compilationString+="vec3 specularBase = vec3(0., 0., 0.);\n",e.compilationString+=`vec3 normalW = ${this.worldNormal.associatedVariableName}.xyz;\n`),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{repeatKey:"maxSimultaneousLights"}),0===this._lightId&&(e.compilationString+="aggShadow = aggShadow / numLights;\n");const r=this.diffuseOutput,n=this.specularOutput;return e.compilationString+=this._declareOutput(r,e)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};\n`,n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};\n`),this.shadow.hasEndpoints&&(e.compilationString+=this._declareOutput(this.shadow,e)+" = aggShadow;\n"),this}serialize(){const e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}(0,H.gn)([(0,ga.p)("Generate only fragment code",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Oa._OnGenerateOnlyFragmentCodeChanged}})],Oa.prototype,"generateOnlyFragmentCode",void 0),(0,c.H)("BABYLON.LightBlock",Oa);var wa=i(48379);class Da extends aa.k{get texture(){var e;return this.source.isConnected?(null===(e=this.source.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:D.l.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}static _IsPrePassTextureBlock(e){return"PrePassTextureBlock"===(null==e?void 0:e.getClassName())}get _isSourcePrePass(){return Da._IsPrePassTextureBlock(this._imageSource)}get samplerName(){if(this._imageSource){if(!Da._IsPrePassTextureBlock(this._imageSource))return this._imageSource.samplerName;if(this.source.connectedPoint)return this._imageSource.getSamplerName(this.source.connectedPoint)}return this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){var t;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const e=null!==(t=this.texture.getScene())&&void 0!==t?t:D.l.LastCreatedScene;null==e||e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const e=null!==(t=this.texture.getScene())&&void 0!==t?t:D.l.LastCreatedScene;null==e||e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?ea.u.Fragment:ea.u.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",ta.E.AutoDetect,!1,ea.u.VertexAndFragment),this.registerInput("source",ta.E.Object,!0,ea.u.VertexAndFragment,new na.C("source",this,oa.Ab.Input,wa.S,"ImageSourceBlock")),this.registerInput("layer",ta.E.Float,!0),this.registerInput("lod",ta.E.Float,!0),this.registerOutput("rgba",ta.E.Color4,ea.u.Neutral),this.registerOutput("rgb",ta.E.Color3,ea.u.Neutral),this.registerOutput("r",ta.E.Float,ea.u.Neutral),this.registerOutput("g",ta.E.Float,ea.u.Neutral),this.registerOutput("b",ta.E.Float,ea.u.Neutral),this.registerOutput("a",ta.E.Float,ea.u.Neutral),this.registerOutput("level",ta.E.Float,ea.u.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(ta.E.Vector2|ta.E.Vector3|ta.E.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get lod(){return this._inputs[3]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}get target(){if(this._fragmentOnly)return ea.u.Fragment;if(!this.uv.isConnected)return ea.u.VertexAndFragment;if(this.uv.sourceBlock.isInput)return ea.u.VertexAndFragment;let e=this.uv.connectedPoint;for(;e;){if(e.target===ea.u.Fragment)return ea.u.Fragment;if(e.target===ea.u.Vertex)return ea.u.VertexAndFragment;if(e.target===ea.u.Neutral||e.target===ea.u.VertexAndFragment){const t=e.ownerBlock;if(t.target===ea.u.Fragment)return ea.u.Fragment;e=null;for(const i of t.inputs)if(i.connectedPoint){e=i.connectedPoint;break}}}return ea.u.VertexAndFragment}set target(e){}autoConfigure(e,t=(()=>!0)){if(!this.uv.isConnected)if(e.mode===ra.a.PostProcess){const i=e.getBlockByPredicate((e=>"uv"===e.name&&t(e)));i&&i.connectTo(this)}else{const i=e.mode===ra.a.Particle?"particle_uv":"uv";let s=e.getInputBlockByPredicate((e=>e.isAttribute&&e.name===i&&t(e)));s||(s=new la.S("uv"),s.setAsAttribute(i)),s.output.connectTo(this.uv)}}initializeDefines(e,t,i){i._areTexturesDirty&&void 0!==this._mainUVDefineName&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix)return void(this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)));const s=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,r=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,s,!0),i.setValue(this._gammaDefineName,r,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),null==i[this._mainUVDefineName]&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return!!this._isSourcePrePass||!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this._isSourcePrePass&&e.setFloat(this._textureInfoName,1),this.texture&&(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==ea.u.Fragment}_injectVertexCode(e){const t=this.uv;if(this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.associatedVariableName.toUpperCase(),this._mainUVName="vMain"+t.associatedVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,"vec2",this._defineName),e._emitVaryingFromString(this._mainUVName,"vec2",this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,"mat4",this._defineName),e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`${this._transformedUVName} = vec2(${this._textureTransformName} * vec4(${t.associatedVariableName}.xy, 1.0, 0.0));\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`,e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,e.compilationString+="#endif\n",this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name,!0)}}_getUVW(e){var t,i,s;let r=e;return null!==(s=null===(i=null===(t=this._texture)||void 0===t?void 0:t._texture)||void 0===i?void 0:i.is2DArray)&&void 0!==s&&s&&(r=`vec3(${e}, ${this.layer.isConnected?this.layer.associatedVariableName:"0"})`),r}get _samplerFunc(){return this.lod.isConnected?"texture2DLodEXT":"texture2D"}get _samplerLodSuffix(){return this.lod.isConnected?`, ${this.lod.associatedVariableName}`:""}_generateTextureLookup(e){const t=this.samplerName;e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`vec4 ${this._tempTextureRead} = ${this._samplerFunc}(${t}, ${this._getUVW(this._transformedUVName)}${this._samplerLodSuffix});\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`,e.compilationString+=`vec4 ${this._tempTextureRead} = ${this._samplerFunc}(${t}, ${this._getUVW(this._mainUVName?this._mainUVName:this.uv.associatedVariableName)}${this._samplerLodSuffix});\n`,e.compilationString+="#endif\n"}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===ea.u.Fragment)return;this._generateTextureLookup(e)}else this.uv.ownerBlock.target!==ea.u.Fragment?this._generateTextureLookup(e):e.compilationString+=`vec4 ${this._tempTextureRead} = ${this._samplerFunc}(${this.samplerName}, ${this._getUVW(i.associatedVariableName)}${this._samplerLodSuffix});\n`}_generateConversionCode(e,t,i){"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i,s=!1){if(s){if(e.target===ea.u.Fragment)return;return e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i)}if(this.uv.ownerBlock.target===ea.u.Fragment)return e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i);let r="";this.disableLevelMultiplication||(r=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${r};\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){var t,i,s,r;if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===ea.u.Vertex||this._fragmentOnly||e.target===ea.u.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),(!this._isMixed&&e.target===ea.u.Fragment||this._isMixed&&e.target===ea.u.Vertex)&&(this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),(null===(i=null===(t=this._texture)||void 0===t?void 0:t._texture)||void 0===i?void 0:i.is2DArray)?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)),e.target!==ea.u.Fragment)return void this._injectVertexCode(e);if(!this._outputs.some((e=>e.isConnectedInFragmentShader)))return;this._isMixed&&!this._imageSource&&((null===(r=null===(s=this._texture)||void 0===s?void 0:s._texture)||void 0===r?void 0:r.is2DArray)?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName));const n=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",n),this._isMixed&&e._emitUniformFromString(this._textureInfoName,"float"),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\n`,this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!Er.O.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=X.x.Parse(e.texture,t,i))}}(0,c.H)("BABYLON.TextureBlock",Da);var Ba=i(29582);class Na extends Ba.W{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?ea.u.Fragment:ea.u.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?ea.u.Fragment:ea.u.Vertex}constructor(e){super(e),this.registerInput("position",ta.E.AutoDetect,!1,ea.u.Vertex),this.registerInput("worldPosition",ta.E.Vector4,!1,ea.u.Vertex),this.registerInput("worldNormal",ta.E.Vector4,!1,ea.u.Fragment),this.registerInput("world",ta.E.Matrix,!1,ea.u.Vertex),this.registerInput("cameraPosition",ta.E.Vector3,!1,ea.u.Fragment),this.registerInput("view",ta.E.Matrix,!1,ea.u.Fragment),this.registerOutput("rgb",ta.E.Color3,ea.u.Fragment),this.registerOutput("rgba",ta.E.Color4,ea.u.Fragment),this.registerOutput("r",ta.E.Float,ea.u.Fragment),this.registerOutput("g",ta.E.Float,ea.u.Fragment),this.registerOutput("b",ta.E.Float,ea.u.Fragment),this.registerOutput("a",ta.E.Float,ea.u.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(ta.E.Color3|ta.E.Vector3|ta.E.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e,t=(()=>!0)){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===sa.$.CameraPosition&&t(e)));i||(i=new la.S("cameraPosition"),i.setAsSystemValue(sa.$.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,"vec4(0.)"),this;if(e.target!==ea.u.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`vec4 ${t} = normalize(${this.worldNormal.associatedVariableName});\n`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}}(0,c.H)("BABYLON.ReflectionTextureBlock",Na);var Fa=i(13013);class La extends aa.k{constructor(e){super(e,ea.u.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",ta.E.AutoDetect,!1,ea.u.VertexAndFragment),this.registerOutput("depth",ta.E.Float,ea.u.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(ta.E.Vector2|ta.E.Vector3|ta.E.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?ea.u.VertexAndFragment:ea.u.Fragment:ea.u.VertexAndFragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec"+(t.type===ta.E.Vector3?"3":t.type===ta.E.Vector4?"4":"2"))),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===ea.u.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\n`}else this.uv.ownerBlock.target!==ea.u.Fragment?e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\n`:e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\n`}_writeOutput(e,t,i,s=!1){if(s){if(e.target===ea.u.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`}else this.uv.ownerBlock.target,ea.u.Fragment,e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==ea.u.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(this._outputs.some((e=>e.isConnectedInFragmentShader))){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}}(0,H.gn)([(0,ga.p)("Use non linear depth",ga.U.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let s=!1;return i.useNonLinearDepth&&(i.storeCameraSpaceZ=!1,s=!0),e&&e.disableDepthRenderer(),s}}})],La.prototype,"useNonLinearDepth",void 0),(0,H.gn)([(0,ga.p)("Store Camera space Z",ga.U.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let s=!1;return i.storeCameraSpaceZ&&(i.useNonLinearDepth=!1,s=!0),e&&e.disableDepthRenderer(),s}}})],La.prototype,"storeCameraSpaceZ",void 0),(0,H.gn)([(0,ga.p)("Force 32 bits float",ga.U.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:e=>null==e?void 0:e.disableDepthRenderer()}})],La.prototype,"force32itsFloat",void 0),(0,c.H)("BABYLON.SceneDepthBlock",La);class Va extends aa.k{constructor(e){super(e,ea.u.VertexAndFragment,!0),this.registerInput("worldPosition",ta.E.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6")}get worldPosition(){return this._inputs[0]}get target(){return ea.u.VertexAndFragment}set target(e){}prepareDefines(e,t,i){var s,r,n,o,a,h;const l=e.getScene(),c=!!(null!==(s=t.clipPlane)&&void 0!==s?s:l.clipPlane),u=!!(null!==(r=t.clipPlane2)&&void 0!==r?r:l.clipPlane2),d=!!(null!==(n=t.clipPlane3)&&void 0!==n?n:l.clipPlane3),p=!!(null!==(o=t.clipPlane4)&&void 0!==o?o:l.clipPlane4),_=!!(null!==(a=t.clipPlane5)&&void 0!==a?a:l.clipPlane5),g=!!(null!==(h=t.clipPlane6)&&void 0!==h?h:l.clipPlane6);i.setValue("CLIPPLANE",c,!0),i.setValue("CLIPPLANE2",u,!0),i.setValue("CLIPPLANE3",d,!0),i.setValue("CLIPPLANE4",p,!0),i.setValue("CLIPPLANE5",_,!0),i.setValue("CLIPPLANE6",g,!0)}bind(e,t,i){if(!i)return;const s=i.getScene();(0,Bn.an)(e,t,s)}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==ea.u.Fragment){const i=this.worldPosition;return e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane","vec4"),e._emitUniformFromString("vClipPlane2","vec4"),e._emitUniformFromString("vClipPlane3","vec4"),e._emitUniformFromString("vClipPlane4","vec4"),e._emitUniformFromString("vClipPlane5","vec4"),void e._emitUniformFromString("vClipPlane6","vec4")}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}(0,c.H)("BABYLON.ClipPlanesBlock",Va);var ka=i(59899);class za extends aa.k{get texture(){return null}set texture(e){}constructor(e,t=ea.u.VertexAndFragment){super(e,t,!1),this.registerOutput("position",ta.E.Object,ea.u.VertexAndFragment,new na.C("position",this,oa.Ab.Output,wa.S,"ImageSourceBlock")),this.registerOutput("depth",ta.E.Object,ea.u.VertexAndFragment,new na.C("depth",this,oa.Ab.Output,wa.S,"ImageSourceBlock")),this.registerOutput("normal",ta.E.Object,ea.u.VertexAndFragment,new na.C("normal",this,oa.Ab.Output,wa.S,"ImageSourceBlock"))}getSamplerName(e){return e===this._outputs[0]?this._positionSamplerName:e===this._outputs[1]?this._depthSamplerName:e===this._outputs[2]?this._normalSamplerName:""}get position(){return this._outputs[0]}get depth(){return this._outputs[1]}get normal(){return this._outputs[2]}get positionSamplerName(){return this._positionSamplerName}get normalSamplerName(){return this._normalSamplerName}get depthSamplerName(){return this._depthSamplerName}getClassName(){return"PrePassTextureBlock"}_buildBlock(e){if(super._buildBlock(e),e.target!==ea.u.Vertex)return this._positionSamplerName="prepassPositionSampler",this._depthSamplerName="prepassDepthSampler",this._normalSamplerName="prepassNormalSampler",e.sharedData.variableNames.prepassPositionSampler=0,e.sharedData.variableNames.prepassDepthSampler=0,e.sharedData.variableNames.prepassNormalSampler=0,e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this),e._emit2DSampler(this._positionSamplerName),e._emit2DSampler(this._depthSamplerName),e._emit2DSampler(this._normalSamplerName),this}bind(e,t){const i=t.getScene().enablePrePassRenderer();if(!i)return;const s=i.defaultRT;s.textures&&(this.position.isConnected&&e.setTexture(this._positionSamplerName,s.textures[i.getIndex(1)]),this.depth.isConnected&&e.setTexture(this._depthSamplerName,s.textures[i.getIndex(5)]),this.normal.isConnected&&e.setTexture(this._normalSamplerName,s.textures[i.getIndex(6)]))}}(0,c.H)("BABYLON.PrePassTextureBlock",za);class Ga extends aa.k{get endpoints(){return this._endpoints}constructor(e){super(e,ea.u.Neutral),this._endpoints=[],this.registerInput("input",ta.E.AutoDetect)}getClassName(){return"NodeMaterialTeleportInBlock"}get input(){return this._inputs[0]}isConnectedInFragmentShader(){return this.endpoints.some((e=>e.output.isConnectedInFragmentShader))}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const s of this.endpoints)-1===t.indexOf(s)&&(i+=s._dumpCode(e,t));return i}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}dispose(){super.dispose();for(const e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}}(0,c.H)("BABYLON.NodeMaterialTeleportInBlock",Ga);class Ua extends aa.k{constructor(e){super(e,ea.u.Neutral),this._entryPoint=null,this._tempEntryPointUniqueId=null,this.registerOutput("output",ta.E.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeMaterialTeleportOutBlock"}get output(){return this._outputs[0]}get target(){return this._entryPoint?this._entryPoint.target:this._target}set target(e){0==(this._target&e)&&(this._target=e)}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(e){super._buildBlock(e),this.entryPoint&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${this.entryPoint.input.associatedVariableName};\n`)}clone(e,t=""){const i=super.clone(e,t);return this.entryPoint&&this.entryPoint.attachToEndpoint(i),i}_customBuildStep(e,t){this.entryPoint&&this.entryPoint.build(e,t)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){var e,t;const i=super.serialize();return i.entryPoint=null!==(t=null===(e=this.entryPoint)||void 0===e?void 0:e.uniqueId)&&void 0!==t?t:"",i}_deserialize(e,t,i){super._deserialize(e,t,i),this._tempEntryPointUniqueId=e.entryPoint}}(0,c.H)("BABYLON.NodeMaterialTeleportOutBlock",Ua);var Wa=i(6919);class Ha extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("left",ta.E.AutoDetect),this.registerInput("right",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push(ta.E.Float),this._inputs[1].acceptedConnectionPointTypes.push(ta.E.Float)}getClassName(){return"AddBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};\n`,this}}(0,c.H)("BABYLON.AddBlock",Ha);class ja extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("input",ta.E.AutoDetect),this.registerInput("factor",ta.E.Float),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};\n`,this}}(0,c.H)("BABYLON.ScaleBlock",ja);class $a extends aa.k{constructor(e){super(e,ea.u.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = clamp(${this.value.associatedVariableName}, ${this._writeFloat(this.minimum)}, ${this._writeFloat(this.maximum)});\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};\n`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};\n`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}(0,H.gn)([(0,ga.p)("Minimum",ga.U.Float)],$a.prototype,"minimum",void 0),(0,H.gn)([(0,ga.p)("Maximum",ga.U.Float)],$a.prototype,"maximum",void 0),(0,c.H)("BABYLON.ClampBlock",$a);class Ya extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("left",ta.E.AutoDetect),this.registerInput("right",ta.E.AutoDetect),this.registerOutput("output",ta.E.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Float),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Matrix),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Vector2),this._inputs[1].excludedConnectionPointTypes.push(ta.E.Float),this._inputs[1].excludedConnectionPointTypes.push(ta.E.Matrix),this._inputs[1].excludedConnectionPointTypes.push(ta.E.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);\n`,this}}(0,c.H)("BABYLON.CrossBlock",Ya);class Xa extends aa.k{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach((s=>{const r=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),n=e._getGLType(s.type);t=t.replace(r,n),i=i.replace(r,n)})),this._outputs.forEach((s=>{const r=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),n=e._getGLType(s.type);t=t.replace(r,n),i=i.replace(r,n)})),e._emitFunction(i,t,""),this._outputs.forEach((t=>{e.compilationString+=this._declareOutput(t,e)+";\n"})),e.compilationString+=i+"(";let s=!1;return this._inputs.forEach(((t,i)=>{var r,n,o;i>0&&(e.compilationString+=", "),this._inputSamplers&&-1!==this._inputSamplers.indexOf(t.name)?e.compilationString+=null!==(o=null===(n=null===(r=t.connectedPoint)||void 0===r?void 0:r.ownerBlock)||void 0===n?void 0:n.samplerName)&&void 0!==o?o:t.associatedVariableName:e.compilationString+=t.associatedVariableName,s=!0})),this._outputs.forEach(((t,i)=>{(i>0||s)&&(e.compilationString+=", "),e.compilationString+=t.associatedVariableName})),e.compilationString+=");\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};\n`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){var t,i,s;this._options=e,this._code=e.code.join("\n")+"\n",this.name=this.name||e.name,this.target=ea.u[e.target],null===(t=e.inParameters)||void 0===t||t.forEach(((e,t)=>{const i=ta.E[e.type];"sampler2D"===e.type||"samplerCube"===e.type?(this._inputSamplers=this._inputSamplers||[],this._inputSamplers.push(e.name),this.registerInput(e.name,ta.E.Object,!0,ea.u.VertexAndFragment,new na.C(e.name,this,oa.Ab.Input,wa.S,"ImageSourceBlock"))):this.registerInput(e.name,i),Object.defineProperty(this,e.name,{get:function(){return this._inputs[t]},enumerable:!0,configurable:!0})})),null===(i=e.outParameters)||void 0===i||i.forEach(((e,t)=>{this.registerOutput(e.name,ta.E[e.type]),Object.defineProperty(this,e.name,{get:function(){return this._outputs[t]},enumerable:!0,configurable:!0}),"BasedOnInput"===e.type&&(this._outputs[t]._typeConnectionSource=this._findInputByName(e.typeFromInput)[0])})),null===(s=e.inLinkedConnectionTypes)||void 0===s||s.forEach((e=>{this._linkConnectionTypes(this._findInputByName(e.input1)[1],this._findInputByName(e.input2)[1])}))}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}(0,c.H)("BABYLON.CustomBlock",Xa);class Qa extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("left",ta.E.AutoDetect),this.registerInput("right",ta.E.AutoDetect),this.registerOutput("output",ta.E.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Float),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Matrix),this._inputs[1].excludedConnectionPointTypes.push(ta.E.Float),this._inputs[1].excludedConnectionPointTypes.push(ta.E.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.DotBlock",Qa);var qa=i(20289),Ka=i(3356);class Za extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("input",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(ta.E.Float),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(${i.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.NormalizeBlock",Za);var Ja=i(25707);class eh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",ta.E.Color3,!0),this.registerInput("r",ta.E.Float,!0),this.registerInput("g",ta.E.Float,!0),this.registerInput("b",ta.E.Float,!0),this.registerInput("a",ta.E.Float,!0),this.registerOutput("rgba",ta.E.Color4),this.registerOutput("rgb",ta.E.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return"rgb "===e?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,s=this.b,r=this.a,n=this.rgbIn,o=this._outputs[0],a=this._outputs[1];return n.isConnected?(o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec4(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${n.associatedVariableName}${this._buildSwizzle(3)};\n`)):(o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\n`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){var s,r,n,o;super._deserialize(e,t,i),this.rSwizzle=null!==(s=e.rSwizzle)&&void 0!==s?s:"r",this.gSwizzle=null!==(r=e.gSwizzle)&&void 0!==r?r:"g",this.bSwizzle=null!==(n=e.bSwizzle)&&void 0!==n?n:"b",this.aSwizzle=null!==(o=e.aSwizzle)&&void 0!==o?o:"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";\n`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";\n`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";\n`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";\n`,e}}(0,c.H)("BABYLON.ColorMergerBlock",eh);var th=i(75943),ih=i(4123);class sh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("xyzw",ta.E.Vector4,!0),this.registerInput("xyz ",ta.E.Vector3,!0),this.registerInput("xy ",ta.E.Vector2,!0),this.registerOutput("xyz",ta.E.Vector3),this.registerOutput("xy",ta.E.Vector2),this.registerOutput("zw",ta.E.Vector2),this.registerOutput("x",ta.E.Float),this.registerOutput("y",ta.E.Float),this.registerOutput("z",ta.E.Float),this.registerOutput("w",ta.E.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],s=this._outputs[1],r=this._outputs[2],n=this._outputs[3],o=this._outputs[4],a=this._outputs[5],h=this._outputs[6];return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=this._declareOutput(i,e)+` = vec3(${t.associatedVariableName}, 0.0);\n`:e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.xyz;\n`),r.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=this._declareOutput(r,e)+` = ${this.xyzw.associatedVariableName}.zw;\n`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.xy;\n`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.x;\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${t.associatedVariableName}.y;\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${t.associatedVariableName}.z;\n`),h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = ${t.associatedVariableName}.w;\n`),this}}(0,c.H)("BABYLON.VectorSplitterBlock",sh);class rh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("left",ta.E.AutoDetect),this.registerInput("right",ta.E.AutoDetect),this.registerInput("gradient",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(ta.E.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.LerpBlock",rh);class nh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("left",ta.E.AutoDetect),this.registerInput("right",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push(ta.E.Float),this._inputs[1].acceptedConnectionPointTypes.push(ta.E.Float)}getClassName(){return"DivideBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};\n`,this}}(0,c.H)("BABYLON.DivideBlock",nh);class oh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("left",ta.E.AutoDetect),this.registerInput("right",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push(ta.E.Float),this._inputs[1].acceptedConnectionPointTypes.push(ta.E.Float)}getClassName(){return"SubtractBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};\n`,this}}(0,c.H)("BABYLON.SubtractBlock",oh);class ah extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("value",ta.E.Float),this.registerInput("edge",ta.E.Float),this.registerOutput("output",ta.E.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.StepBlock",ah);class hh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("input",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(ta.E.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = 1. - ${this.input.associatedVariableName};\n`,this}}(0,c.H)("BABYLON.OneMinusBlock",hh),(0,c.H)("BABYLON.OppositeBlock",hh);var lh,ch=i(45812);i(18297);class uh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("worldNormal",ta.E.Vector4),this.registerInput("viewDirection",ta.E.Vector3),this.registerInput("bias",ta.E.Float),this.registerInput("power",ta.E.Float),this.registerOutput("fresnel",ta.E.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new ch.d("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const e=new la.S("bias");e.value=0,e.output.connectTo(this.bias)}if(!this.power.isConnected){const e=new la.S("power");e.value=1,e.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=this._declareOutput(this.fresnel,e)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.FresnelBlock",uh);class dh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("left",ta.E.AutoDetect),this.registerInput("right",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.MaxBlock",dh);class ph extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("left",ta.E.AutoDetect),this.registerInput("right",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.MinBlock",ph);class _h extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("left",ta.E.AutoDetect),this.registerInput("right",ta.E.AutoDetect),this.registerOutput("output",ta.E.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Float),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Matrix),this._inputs[1].excludedConnectionPointTypes.push(ta.E.Float),this._inputs[1].excludedConnectionPointTypes.push(ta.E.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.DistanceBlock",_h);class gh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("value",ta.E.AutoDetect),this.registerOutput("output",ta.E.Float),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Float),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = length(${this.value.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.LengthBlock",gh);class mh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("value",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = -1.0 * ${this.value.associatedVariableName};\n`,this}}(0,c.H)("BABYLON.NegateBlock",mh);class fh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("value",ta.E.AutoDetect),this.registerInput("power",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = pow(${this.value.associatedVariableName}, ${this.power.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.PowBlock",fh);class bh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("seed",ta.E.AutoDetect),this.registerOutput("output",ta.E.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(ta.E.Vector2|ta.E.Vector3|ta.E.Vector4|ta.E.Color3|ta.E.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=this._declareOutput(t,e)+` = getRand(${this.seed.associatedVariableName}.xy);\n`,this}}(0,c.H)("BABYLON.RandomNumberBlock",bh);class vh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("x",ta.E.Float),this.registerInput("y",ta.E.Float),this.registerOutput("output",ta.E.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = atan(${this.x.associatedVariableName}, ${this.y.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.ArcTan2Block",vh);class yh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("value",ta.E.AutoDetect),this.registerInput("edge0",ta.E.Float),this.registerInput("edge1",ta.E.Float),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = smoothstep(${this.edge0.associatedVariableName}, ${this.edge1.associatedVariableName}, ${this.value.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.SmoothStepBlock",yh);class xh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("input",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return this.input.type===ta.E.Matrix?e.compilationString+=this._declareOutput(t,e)+` = inverse(${this.input.associatedVariableName});\n`:e.compilationString+=this._declareOutput(t,e)+` = 1. / ${this.input.associatedVariableName};\n`,this}}(0,c.H)("BABYLON.ReciprocalBlock",xh);class Ph extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("value",ta.E.AutoDetect),this.registerInput("reference",ta.E.AutoDetect),this.registerInput("distance",ta.E.Float),this.registerInput("replacement",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Float),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Matrix),this._inputs[1].excludedConnectionPointTypes.push(ta.E.Float),this._inputs[1].excludedConnectionPointTypes.push(ta.E.Matrix),this._inputs[3].excludedConnectionPointTypes.push(ta.E.Float),this._inputs[3].excludedConnectionPointTypes.push(ta.E.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+";\n",e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {\n`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};\n`,e.compilationString+="} else {\n",e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};\n`,e.compilationString+="}\n",this}}(0,c.H)("BABYLON.ReplaceColorBlock",Ph);class Ch extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("value",ta.E.AutoDetect),this.registerInput("steps",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Matrix),this._inputs[1].excludedConnectionPointTypes.push(ta.E.Matrix)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.PosterizeBlock",Ch),function(e){e[e.SawTooth=0]="SawTooth",e[e.Square=1]="Square",e[e.Triangle=2]="Triangle"}(lh||(lh={}));class Th extends aa.k{constructor(e){super(e,ea.u.Neutral),this.kind=lh.SawTooth,this.registerInput("input",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(ta.E.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case lh.SawTooth:e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});\n`;break;case lh.Square:e.compilationString+=this._declareOutput(t,e)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));\n`;break;case lh.Triangle:e.compilationString+=this._declareOutput(t,e)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;\n`}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}}(0,c.H)("BABYLON.WaveBlock",Th);class Sh{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}class Eh extends aa.k{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,ea.u.Neutral),this.colorSteps=[new Sh(0,g.Wo.Black()),new Sh(1,g.Wo.White())],this.onValueChangedObservable=new _.y$,this.registerInput("gradient",ta.E.AutoDetect),this.registerOutput("output",ta.E.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(ta.E.Float|ta.E.Vector2|ta.E.Vector3|ta.E.Vector4|ta.E.Color3|ta.E.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e){const t=this.colorSteps[e];return`vec3(${t.color.r}, ${t.color.g}, ${t.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];if(!this.colorSteps.length||!this.gradient.connectedPoint)return void(e.compilationString+=this._declareOutput(t,e)+" = vec3(0., 0., 0.);\n");const i=e._getFreeVariableName("gradientTempColor"),s=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`vec3 ${i} = ${this._writeColorConstant(0)};\n`,e.compilationString+=`float ${s};\n`;let r=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==ta.E.Float&&(r+=".x");for(let t=1;t<this.colorSteps.length;t++){const n=this.colorSteps[t],o=this.colorSteps[t-1];e.compilationString+=`${s} = clamp((${r} - ${e._emitFloat(o.step)}) / (${e._emitFloat(n.step)} -  ${e._emitFloat(o.step)}), 0.0, 1.0) * step(${e._emitFloat(t)}, ${e._emitFloat(this.colorSteps.length-1)});\n`,e.compilationString+=`${i} = mix(${i}, ${this._writeColorConstant(t)}, ${s});\n`}return e.compilationString+=this._declareOutput(t,e)+` = ${i};\n`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const t of e.colorSteps)this.colorSteps.push(new Sh(t.step,new g.Wo(t.color.r,t.color.g,t.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];\n`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));\n`;return e}}(0,c.H)("BABYLON.GradientBlock",Eh);class Rh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("left",ta.E.AutoDetect),this.registerInput("right",ta.E.AutoDetect),this.registerInput("gradient",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(ta.E.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));\n`,this}}(0,c.H)("BABYLON.NLerpBlock",Rh);class Mh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.manhattanDistance=!1,this.registerInput("seed",ta.E.Vector3),this.registerInput("jitter",ta.E.Float),this.registerOutput("output",ta.E.Vector2),this.registerOutput("x",ta.E.Float),this.registerOutput("y",ta.E.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t="vec3 permute(vec3 x){\n";t+="    return mod((34.0 * x + 1.0) * x, 289.0);\n",t+="}\n\n",t+="vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\n",t+="    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\n",t+="}\n\n",t+="vec2 worley(vec3 P, float jitter, bool manhattanDistance){\n",t+="    float K = 0.142857142857; // 1/7\n",t+="    float Ko = 0.428571428571; // 1/2-K/2\n",t+="    float  K2 = 0.020408163265306; // 1/(7*7)\n",t+="    float Kz = 0.166666666667; // 1/6\n",t+="    float Kzo = 0.416666666667; // 1/2-1/6*2\n",t+="\n",t+="    vec3 Pi = mod(floor(P), 289.0);\n",t+="    vec3 Pf = fract(P) - 0.5;\n",t+="\n",t+="    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\n",t+="\n",t+="    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\n",t+="    vec3 p1 = permute(p + Pi.y - 1.0);\n",t+="    vec3 p2 = permute(p + Pi.y);\n",t+="    vec3 p3 = permute(p + Pi.y + 1.0);\n",t+="\n",t+="    vec3 p11 = permute(p1 + Pi.z - 1.0);\n",t+="    vec3 p12 = permute(p1 + Pi.z);\n",t+="    vec3 p13 = permute(p1 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p21 = permute(p2 + Pi.z - 1.0);\n",t+="    vec3 p22 = permute(p2 + Pi.z);\n",t+="    vec3 p23 = permute(p2 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p31 = permute(p3 + Pi.z - 1.0);\n",t+="    vec3 p32 = permute(p3 + Pi.z);\n",t+="    vec3 p33 = permute(p3 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 ox11 = fract(p11*K) - Ko;\n",t+="    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\n",t+="    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\n",t+="\n",t+="    vec3 ox12 = fract(p12*K) - Ko;\n",t+="    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\n",t+="    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox13 = fract(p13*K) - Ko;\n",t+="    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\n",t+="    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox21 = fract(p21*K) - Ko;\n",t+="    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\n",t+="    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox22 = fract(p22*K) - Ko;\n",t+="    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\n",t+="    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox23 = fract(p23*K) - Ko;\n",t+="    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\n",t+="    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox31 = fract(p31*K) - Ko;\n",t+="    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\n",t+="    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox32 = fract(p32*K) - Ko;\n",t+="    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\n",t+="    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox33 = fract(p33*K) - Ko;\n",t+="    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\n",t+="    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 dx11 = Pfx + jitter*ox11;\n",t+="    vec3 dy11 = Pfy.x + jitter*oy11;\n",t+="    vec3 dz11 = Pfz.x + jitter*oz11;\n",t+="\n",t+="    vec3 dx12 = Pfx + jitter*ox12;\n",t+="    vec3 dy12 = Pfy.x + jitter*oy12;\n",t+="    vec3 dz12 = Pfz.y + jitter*oz12;\n",t+="\n",t+="    vec3 dx13 = Pfx + jitter*ox13;\n",t+="    vec3 dy13 = Pfy.x + jitter*oy13;\n",t+="    vec3 dz13 = Pfz.z + jitter*oz13;\n",t+="\n",t+="    vec3 dx21 = Pfx + jitter*ox21;\n",t+="    vec3 dy21 = Pfy.y + jitter*oy21;\n",t+="    vec3 dz21 = Pfz.x + jitter*oz21;\n",t+="\n",t+="    vec3 dx22 = Pfx + jitter*ox22;\n",t+="    vec3 dy22 = Pfy.y + jitter*oy22;\n",t+="    vec3 dz22 = Pfz.y + jitter*oz22;\n",t+="\n",t+="    vec3 dx23 = Pfx + jitter*ox23;\n",t+="    vec3 dy23 = Pfy.y + jitter*oy23;\n",t+="    vec3 dz23 = Pfz.z + jitter*oz23;\n",t+="\n",t+="    vec3 dx31 = Pfx + jitter*ox31;\n",t+="    vec3 dy31 = Pfy.z + jitter*oy31;\n",t+="    vec3 dz31 = Pfz.x + jitter*oz31;\n",t+="\n",t+="    vec3 dx32 = Pfx + jitter*ox32;\n",t+="    vec3 dy32 = Pfy.z + jitter*oy32;\n",t+="    vec3 dz32 = Pfz.y + jitter*oz32;\n",t+="\n",t+="    vec3 dx33 = Pfx + jitter*ox33;\n",t+="    vec3 dy33 = Pfy.z + jitter*oy33;\n",t+="    vec3 dz33 = Pfz.z + jitter*oz33;\n",t+="\n",t+="    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\n",t+="    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\n",t+="    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\n",t+="    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\n",t+="    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\n",t+="    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\n",t+="    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\n",t+="    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\n",t+="    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\n",t+="\n",t+="    vec3 d1a = min(d11, d12);\n",t+="    d12 = max(d11, d12);\n",t+="    d11 = min(d1a, d13); // Smallest now not in d12 or d13\n",t+="    d13 = max(d1a, d13);\n",t+="    d12 = min(d12, d13); // 2nd smallest now not in d13\n",t+="    vec3 d2a = min(d21, d22);\n",t+="    d22 = max(d21, d22);\n",t+="    d21 = min(d2a, d23); // Smallest now not in d22 or d23\n",t+="    d23 = max(d2a, d23);\n",t+="    d22 = min(d22, d23); // 2nd smallest now not in d23\n",t+="    vec3 d3a = min(d31, d32);\n",t+="    d32 = max(d31, d32);\n",t+="    d31 = min(d3a, d33); // Smallest now not in d32 or d33\n",t+="    d33 = max(d3a, d33);\n",t+="    d32 = min(d32, d33); // 2nd smallest now not in d33\n",t+="    vec3 da = min(d11, d21);\n",t+="    d21 = max(d11, d21);\n",t+="    d11 = min(da, d31); // Smallest now in d11\n",t+="    d31 = max(da, d31); // 2nd smallest now not in d31\n",t+="    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\n",t+="    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\n",t+="    d12 = min(d12, d21); // 2nd smallest now not in d21\n",t+="    d12 = min(d12, d22); // nor in d22\n",t+="    d12 = min(d12, d31); // nor in d31\n",t+="    d12 = min(d12, d32); // nor in d32\n",t+="    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\n",t+="    d11.y = min(d11.y,d12.z); // Only two more to go\n",t+="    d11.y = min(d11.y,d11.z); // Done! (Phew!)\n",t+="    return sqrt(d11.xy); // F1, F2\n",t+="}\n\n",e._emitFunction("worley3D","vec3 permute(vec3 x){\n    return mod((34.0 * x + 1.0) * x, 289.0);\n}\n\nvec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\n    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\n}\n\nvec2 worley(vec3 P, float jitter, bool manhattanDistance){\n    float K = 0.142857142857; // 1/7\n    float Ko = 0.428571428571; // 1/2-K/2\n    float  K2 = 0.020408163265306; // 1/(7*7)\n    float Kz = 0.166666666667; // 1/6\n    float Kzo = 0.416666666667; // 1/2-1/6*2\n\n    vec3 Pi = mod(floor(P), 289.0);\n    vec3 Pf = fract(P) - 0.5;\n\n    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\n    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\n    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\n\n    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\n    vec3 p1 = permute(p + Pi.y - 1.0);\n    vec3 p2 = permute(p + Pi.y);\n    vec3 p3 = permute(p + Pi.y + 1.0);\n\n    vec3 p11 = permute(p1 + Pi.z - 1.0);\n    vec3 p12 = permute(p1 + Pi.z);\n    vec3 p13 = permute(p1 + Pi.z + 1.0);\n\n    vec3 p21 = permute(p2 + Pi.z - 1.0);\n    vec3 p22 = permute(p2 + Pi.z);\n    vec3 p23 = permute(p2 + Pi.z + 1.0);\n\n    vec3 p31 = permute(p3 + Pi.z - 1.0);\n    vec3 p32 = permute(p3 + Pi.z);\n    vec3 p33 = permute(p3 + Pi.z + 1.0);\n\n    vec3 ox11 = fract(p11*K) - Ko;\n    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\n    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\n\n    vec3 ox12 = fract(p12*K) - Ko;\n    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\n    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\n\n    vec3 ox13 = fract(p13*K) - Ko;\n    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\n    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\n\n    vec3 ox21 = fract(p21*K) - Ko;\n    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\n    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\n\n    vec3 ox22 = fract(p22*K) - Ko;\n    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\n    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\n\n    vec3 ox23 = fract(p23*K) - Ko;\n    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\n    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\n\n    vec3 ox31 = fract(p31*K) - Ko;\n    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\n    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\n\n    vec3 ox32 = fract(p32*K) - Ko;\n    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\n    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\n\n    vec3 ox33 = fract(p33*K) - Ko;\n    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\n    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\n\n    vec3 dx11 = Pfx + jitter*ox11;\n    vec3 dy11 = Pfy.x + jitter*oy11;\n    vec3 dz11 = Pfz.x + jitter*oz11;\n\n    vec3 dx12 = Pfx + jitter*ox12;\n    vec3 dy12 = Pfy.x + jitter*oy12;\n    vec3 dz12 = Pfz.y + jitter*oz12;\n\n    vec3 dx13 = Pfx + jitter*ox13;\n    vec3 dy13 = Pfy.x + jitter*oy13;\n    vec3 dz13 = Pfz.z + jitter*oz13;\n\n    vec3 dx21 = Pfx + jitter*ox21;\n    vec3 dy21 = Pfy.y + jitter*oy21;\n    vec3 dz21 = Pfz.x + jitter*oz21;\n\n    vec3 dx22 = Pfx + jitter*ox22;\n    vec3 dy22 = Pfy.y + jitter*oy22;\n    vec3 dz22 = Pfz.y + jitter*oz22;\n\n    vec3 dx23 = Pfx + jitter*ox23;\n    vec3 dy23 = Pfy.y + jitter*oy23;\n    vec3 dz23 = Pfz.z + jitter*oz23;\n\n    vec3 dx31 = Pfx + jitter*ox31;\n    vec3 dy31 = Pfy.z + jitter*oy31;\n    vec3 dz31 = Pfz.x + jitter*oz31;\n\n    vec3 dx32 = Pfx + jitter*ox32;\n    vec3 dy32 = Pfy.z + jitter*oy32;\n    vec3 dz32 = Pfz.y + jitter*oz32;\n\n    vec3 dx33 = Pfx + jitter*ox33;\n    vec3 dy33 = Pfy.z + jitter*oy33;\n    vec3 dz33 = Pfz.z + jitter*oz33;\n\n    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\n    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\n    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\n    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\n    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\n    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\n    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\n    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\n    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\n\n    vec3 d1a = min(d11, d12);\n    d12 = max(d11, d12);\n    d11 = min(d1a, d13); // Smallest now not in d12 or d13\n    d13 = max(d1a, d13);\n    d12 = min(d12, d13); // 2nd smallest now not in d13\n    vec3 d2a = min(d21, d22);\n    d22 = max(d21, d22);\n    d21 = min(d2a, d23); // Smallest now not in d22 or d23\n    d23 = max(d2a, d23);\n    d22 = min(d22, d23); // 2nd smallest now not in d23\n    vec3 d3a = min(d31, d32);\n    d32 = max(d31, d32);\n    d31 = min(d3a, d33); // Smallest now not in d32 or d33\n    d33 = max(d3a, d33);\n    d32 = min(d32, d33); // 2nd smallest now not in d33\n    vec3 da = min(d11, d21);\n    d21 = max(d11, d21);\n    d11 = min(da, d31); // Smallest now in d11\n    d31 = max(da, d31); // 2nd smallest now not in d31\n    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\n    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\n    d12 = min(d12, d21); // 2nd smallest now not in d21\n    d12 = min(d12, d22); // nor in d22\n    d12 = min(d12, d31); // nor in d31\n    d12 = min(d12, d32); // nor in d32\n    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\n    d11.y = min(d11.y,d12.z); // Only two more to go\n    d11.y = min(d11.y,d11.z); // Done! (Phew!)\n    return sqrt(d11.xy); // F1, F2\n}\n\n","// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`vec2 ${i} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});\n`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${i}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${i}.y;\n`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};\n`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}(0,H.gn)([(0,ga.p)("Use Manhattan Distance",ga.U.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Mh.prototype,"manhattanDistance",void 0),(0,c.H)("BABYLON.WorleyNoise3DBlock",Mh);class Ah extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("seed",ta.E.Vector3),this.registerOutput("output",ta.E.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;let t="const float SKEWFACTOR = 1.0/3.0;\n";return t+="const float UNSKEWFACTOR = 1.0/6.0;\n",t+="const float SIMPLEX_CORNER_POS = 0.5;\n",t+="const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\n",t+="float SimplexPerlin3D( vec3 P ){\n",t+="    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\n",t+="    P *= SIMPLEX_TETRAHADRON_HEIGHT;\n",t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+="    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\n",t+="    vec3 g = step(x0.yzx, x0.xyz);\n",t+="    vec3 l = 1.0 - g;\n",t+="    vec3 Pi_1 = min( g.xyz, l.zxy );\n",t+="    vec3 Pi_2 = max( g.xyz, l.zxy );\n",t+="    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\n",t+="    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\n",t+="    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\n",t+="    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\n",t+="    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\n",t+="    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\n",t+="    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\n",t+="    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\n",t+="    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\n",t+="    Pt *= Pt;\n",t+="    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\n",t+="    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\n",t+="    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\n",t+="    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\n",t+="    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\n",t+="    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\n",t+="    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\n",t+="    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\n",t+="    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\n",t+="    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\n",t+="    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\n",t+="    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\n",t+="    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\n",t+="    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\n",t+="    kernel_weights = max(0.5 - kernel_weights, 0.0);\n",t+="    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\n",t+="    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\n",t+="}\n",e._emitFunction("SimplexPerlin3D","const float SKEWFACTOR = 1.0/3.0;\nconst float UNSKEWFACTOR = 1.0/6.0;\nconst float SIMPLEX_CORNER_POS = 0.5;\nconst float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\nfloat SimplexPerlin3D( vec3 P ){\n    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\n    P *= SIMPLEX_TETRAHADRON_HEIGHT;\n    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\n    vec3 g = step(x0.yzx, x0.xyz);\n    vec3 l = 1.0 - g;\n    vec3 Pi_1 = min( g.xyz, l.zxy );\n    vec3 Pi_2 = max( g.xyz, l.zxy );\n    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\n    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\n    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\n    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\n    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\n    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\n    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\n    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\n    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\n    Pt *= Pt;\n    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\n    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\n    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\n    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\n    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\n    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\n    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\n    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\n    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\n    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\n    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\n    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\n    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\n    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\n    kernel_weights = max(0.5 - kernel_weights, 0.0);\n    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\n    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\n}\n","// SimplexPerlin3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = SimplexPerlin3D(${this.seed.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.SimplexPerlin3DBlock",Ah);class Ih extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("normalMap0",ta.E.AutoDetect),this.registerInput("normalMap1",ta.E.AutoDetect),this.registerOutput("output",ta.E.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(ta.E.Color3|ta.E.Color4|ta.E.Vector3|ta.E.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(ta.E.Color3|ta.E.Color4|ta.E.Vector3|ta.E.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],s=this._inputs[1],r=e._getFreeVariableName("stepR"),n=e._getFreeVariableName("stepG");return e.compilationString+=`float ${r} = step(0.5, ${i.associatedVariableName}.r);\n`,e.compilationString+=`float ${n} = step(0.5, ${i.associatedVariableName}.g);\n`,e.compilationString+=this._declareOutput(t,e)+";\n",e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${r}) * ${i.associatedVariableName}.r * ${s.associatedVariableName}.r * 2.0 + ${r} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${s.associatedVariableName}.r) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${n}) * ${i.associatedVariableName}.g * ${s.associatedVariableName}.g * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${s.associatedVariableName}.g) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${s.associatedVariableName}.b;\n`,this}}(0,c.H)("BABYLON.NormalBlendBlock",Ih);class Oh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("input",ta.E.Vector2),this.registerInput("angle",ta.E.Float),this.registerOutput("output",ta.E.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new la.S("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.angle,s=this.input;return e.compilationString+=this._declareOutput(t,e)+` = vec2(cos(${i.associatedVariableName}) * ${s.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${s.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${s.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${s.associatedVariableName}.y);\n`,this}}(0,c.H)("BABYLON.Rotate2dBlock",Oh);class wh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("incident",ta.E.AutoDetect),this.registerInput("normal",ta.E.AutoDetect),this.registerOutput("output",ta.E.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(ta.E.Vector3|ta.E.Vector4|ta.E.Color3|ta.E.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(ta.E.Vector3|ta.E.Vector4|ta.E.Color3|ta.E.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);\n`,this}}(0,c.H)("BABYLON.ReflectBlock",wh);class Dh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("incident",ta.E.AutoDetect),this.registerInput("normal",ta.E.AutoDetect),this.registerInput("ior",ta.E.Float),this.registerOutput("output",ta.E.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(ta.E.Vector3|ta.E.Vector4|ta.E.Color3|ta.E.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(ta.E.Vector3|ta.E.Vector4|ta.E.Color3|ta.E.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.RefractBlock",Dh);class Bh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("color",ta.E.Color3),this.registerInput("level",ta.E.Float),this.registerOutput("output",ta.E.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.color.associatedVariableName,s=e._getFreeVariableName("colorMin"),r=e._getFreeVariableName("colorMax"),n=e._getFreeVariableName("colorMerge");return e.compilationString+=`float ${s} = min(min(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`float ${r} = max(max(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`float ${n} = 0.5 * (${s} + ${r});\n`,e.compilationString+=this._declareOutput(t,e)+` = mix(${i}, vec3(${n}, ${n}, ${n}), ${this.level.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.DesaturateBlock",Bh);var Nh=i(84732),Fh=i(61033),Lh=i(55312),Vh=i(87245),kh=i(23878),zh=i(69761),Gh=i(17937);const Uh={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["aggShadow",""],alpha:["alpha",""]};class Wh extends aa.k{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?ea.u.Fragment:ea.u.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?ea.u.Fragment:ea.u.Vertex}constructor(e){super(e,ea.u.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=g.Wo.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",ta.E.Vector4,!1,ea.u.Vertex),this.registerInput("worldNormal",ta.E.Vector4,!1,ea.u.Fragment),this.registerInput("view",ta.E.Matrix,!1),this.registerInput("cameraPosition",ta.E.Vector3,!1,ea.u.Fragment),this.registerInput("perturbedNormal",ta.E.Vector4,!0,ea.u.Fragment),this.registerInput("baseColor",ta.E.Color3,!0,ea.u.Fragment),this.registerInput("metallic",ta.E.Float,!1,ea.u.Fragment),this.registerInput("roughness",ta.E.Float,!1,ea.u.Fragment),this.registerInput("ambientOcc",ta.E.Float,!0,ea.u.Fragment),this.registerInput("opacity",ta.E.Float,!0,ea.u.Fragment),this.registerInput("indexOfRefraction",ta.E.Float,!0,ea.u.Fragment),this.registerInput("ambientColor",ta.E.Color3,!0,ea.u.Fragment),this.registerInput("reflection",ta.E.Object,!0,ea.u.Fragment,new na.C("reflection",this,oa.Ab.Input,Vh.J,"ReflectionBlock")),this.registerInput("clearcoat",ta.E.Object,!0,ea.u.Fragment,new na.C("clearcoat",this,oa.Ab.Input,kh.N,"ClearCoatBlock")),this.registerInput("sheen",ta.E.Object,!0,ea.u.Fragment,new na.C("sheen",this,oa.Ab.Input,Nh.g,"SheenBlock")),this.registerInput("subsurface",ta.E.Object,!0,ea.u.Fragment,new na.C("subsurface",this,oa.Ab.Input,Gh.l,"SubSurfaceBlock")),this.registerInput("anisotropy",ta.E.Object,!0,ea.u.Fragment,new na.C("anisotropy",this,oa.Ab.Input,Lh.p,"AnisotropyBlock")),this.registerInput("iridescence",ta.E.Object,!0,ea.u.Fragment,new na.C("iridescence",this,oa.Ab.Input,zh.$,"IridescenceBlock")),this.registerOutput("ambientClr",ta.E.Color3,ea.u.Fragment),this.registerOutput("diffuseDir",ta.E.Color3,ea.u.Fragment),this.registerOutput("specularDir",ta.E.Color3,ea.u.Fragment),this.registerOutput("clearcoatDir",ta.E.Color3,ea.u.Fragment),this.registerOutput("sheenDir",ta.E.Color3,ea.u.Fragment),this.registerOutput("diffuseInd",ta.E.Color3,ea.u.Fragment),this.registerOutput("specularInd",ta.E.Color3,ea.u.Fragment),this.registerOutput("clearcoatInd",ta.E.Color3,ea.u.Fragment),this.registerOutput("sheenInd",ta.E.Color3,ea.u.Fragment),this.registerOutput("refraction",ta.E.Color3,ea.u.Fragment),this.registerOutput("lighting",ta.E.Color3,ea.u.Fragment),this.registerOutput("shadow",ta.E.Float,ea.u.Fragment),this.registerOutput("alpha",ta.E.Float,ea.u.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e,t=(()=>!0)){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===sa.$.CameraPosition&&t(e)));i||(i=new la.S("cameraPosition"),i.setAsSystemValue(sa.$.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===sa.$.View&&t(e)));i||(i=new la.S("view"),i.setAsSystemValue(sa.$.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===Vn.m.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===Vn.m.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));const s=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",s.indexOf(".")<0?s+".":s,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const r=e.getScene();if(r.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&Jo.k.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),i._areLightsDirty)if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Nn.G.PrepareDefinesForLight(r,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else Nn.G.PrepareDefinesForLights(r,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,Nn.G.PrepareDefinesForMultiview(r,i)}updateUniformsAndSamples(e,t,i,s){for(let r=0;r<t.maxSimultaneousLights&&i["LIGHT"+r];r++){const t=e.uniforms.indexOf("vLightData"+r)>=0;Nn.G.PrepareUniformsAndSamplersForLight(r,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+r],s,t)}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){var s,r;if(!i)return;const n=i.getScene();this.light?Nn.G.BindLight(this.light,this._lightId,n,e,!0):Nn.G.BindLights(n,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const o=this._scene.ambientColor;o&&e.setColor3("ambientFromScene",o);const a=n.useRightHandedSystem===(null!=n._mirroredCameraPosition);e.setFloat(this._invertNormalName,a?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const h=null!==(r=null===(s=this.indexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==r?r:1.5,l=Math.pow((h-1)/(h+1),2);this._metallicReflectanceColor.scaleToRef(l*this._metallicF0Factor,g.zZ.Color3[0]);const c=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,g.zZ.Color3[0],c),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){var t,i;const s=this.worldPosition,r=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const n="v_"+s.associatedVariableName;e._emitVaryingFromString(n,"vec4")&&(e.compilationString+=`${n} = ${s.associatedVariableName};\n`);const o=this.reflection.isConnected?null===(t=this.reflection.connectedPoint)||void 0===t?void 0:t.ownerBlock:null;o&&(o.viewConnectionPoint=this.view),e.compilationString+=null!==(i=null==o?void 0:o.handleVertexSide(e))&&void 0!==i?i:"",e._emitVaryingFromString("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+="#if DEBUGMODE > 0\n",e._injectAtEnd+="vClipSpacePosition = gl_Position;\n",e._injectAtEnd+="#endif\n"),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:s.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${s.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(){let e="albedoOpacityOutParams albedoOpacityOut;\n";return e+=`albedoOpacityBlock(\n                vec4(${this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)"}, 1.),\n            #ifdef ALBEDO\n                vec4(1.),\n                vec2(1., 1.),\n            #endif\n            #ifdef OPACITY\n                vec4(${this.opacity.isConnected?this.opacity.associatedVariableName:"1."}),\n                vec2(1., 1.),\n            #endif\n                albedoOpacityOut\n            );\n\n            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;\n            float alpha = albedoOpacityOut.alpha;\n`,e}_getAmbientOcclusionCode(){let e="ambientOcclusionOutParams aoOut;\n";return e+=`ambientOcclusionBlock(\n            #ifdef AMBIENT\n                vec3(${this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1."}),\n                vec4(0., 1.0, 1.0, 0.),\n            #endif\n                aoOut\n            );\n`,e}_getReflectivityCode(e){let t="reflectivityOutParams reflectivityOut;\n";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,"vec4"),t+=`vec3 baseColor = surfaceAlbedo;\n\n            reflectivityBlock(\n                vec4(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.),\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo,\n                ${this._vMetallicReflectanceFactorsName},\n            #endif\n            #ifdef REFLECTIVITY\n                vec3(0., 0., 1.),\n                vec4(1.),\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor,\n            #endif\n            #ifdef MICROSURFACEMAP\n                microSurfaceTexel, <== not handled!\n            #endif\n                reflectivityOut\n            );\n\n            float microSurface = reflectivityOut.microSurface;\n            float roughness = reflectivityOut.roughness;\n\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo = reflectivityOut.surfaceAlbedo;\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;\n            #endif\n`,t}_buildBlock(e){var t,i,s,r,n,o,a,h,l,c,u,d,p,_,g,m,f,b,v,y,x,P,C,T,S,E,R,M,A,I,O,w,D,B,N,F,L,V,k,z,G;super._buildBlock(e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=(0,Fh.$)(this._scene));const U=this.reflection.isConnected?null===(t=this.reflection.connectedPoint)||void 0===t?void 0:t.ownerBlock:null;if(U&&(U.worldPositionConnectionPoint=this.worldPosition,U.cameraPositionConnectionPoint=this.cameraPosition,U.worldNormalConnectionPoint=this.worldNormal,U.viewConnectionPoint=this.view),e.target!==ea.u.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const W=`//${this.name}`,H=this.perturbedNormal;let j=this.worldPosition.associatedVariableName;this.generateOnlyFragmentCode?(j=e._getFreeVariableName("globalWorldPos"),e._emitFunction("pbr_globalworldpos",`vec3 ${j};\n`,W),e.compilationString+=`${j} = ${this.worldPosition.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",W,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+="#if DEBUGMODE > 0\n",e.compilationString+="vec4 vClipSpacePosition = vec4((vec2(gl_FragCoord.xy) / vec2(1.0)) * 2.0 - 1.0, 0.0, 1.0);\n",e.compilationString+="#endif\n"):j="v_"+j,this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene","vec3"),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",W,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",W,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",W),e._emitFunctionFromInclude("importanceSampling",W),e._emitFunctionFromInclude("pbrHelperFunctions",W),e._emitFunctionFromInclude("imageProcessingDeclaration",W),e._emitFunctionFromInclude("imageProcessingFunctions",W),e._emitFunctionFromInclude("shadowsFragmentFunctions",W,{replaceStrings:[{search:/vPositionW/g,replace:j+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",W,{replaceStrings:[{search:/vPositionW/g,replace:j+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",W),e._emitFunctionFromInclude("pbrBRDFFunctions",W,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(i=null==U?void 0:U._defineSkyboxName)&&void 0!==i?i:"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",W),e._emitFunctionFromInclude("pbrDirectLightingFunctions",W,{replaceStrings:[{search:/vPositionW/g,replace:j+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",W),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",W),e._emitFunctionFromInclude("pbrBlockReflectivity",W),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",W),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",W),e._emitFunctionFromInclude("pbrBlockAnisotropic",W),e._emitUniformFromString("vLightingIntensity","vec4"),(null==U?void 0:U.generateOnlyFragmentCode)&&(e.compilationString+=U.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`vec4 ${this._vNormalWName} = normalize(${this.worldNormal.associatedVariableName});\n`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${j}.xyz);\n`),e.compilationString+=`vec3 geometricNormalW = ${this._vNormalWName}.xyz;\n`,e.compilationString+=`vec3 normalW = ${H.isConnected?"normalize("+H.associatedVariableName+".xyz)":"geometricNormalW"};\n`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,"float"),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",W,{replaceStrings:[{search:/vPositionW/g,replace:j+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",W),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",W),e.compilationString+="#ifdef UNLIT\n                vec3 diffuseBase = vec3(1., 1., 1.);\n            #else\n",e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",W,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(s=null==U?void 0:U._defineSkyboxName)&&void 0!==s?s:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(r=null==U?void 0:U._define3DName)&&void 0!==r?r:"REFLECTIONMAP_3D"}]});const $=this.anisotropy.isConnected?null===(n=this.anisotropy.connectedPoint)||void 0===n?void 0:n.ownerBlock:null;$&&($.worldPositionConnectionPoint=this.worldPosition,$.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=$.getCode(e,!this.perturbedNormal.isConnected)),U&&U.hasTexture&&(e.compilationString+=U.getCode(e,$?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",W,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(o=null==U?void 0:U._define3DName)&&void 0!==o?o:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(a=null==U?void 0:U._defineOppositeZ)&&void 0!==a?a:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(h=null==U?void 0:U._defineProjectionName)&&void 0!==h?h:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(l=null==U?void 0:U._defineSkyboxName)&&void 0!==l?l:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(c=null==U?void 0:U._defineLODReflectionAlpha)&&void 0!==c?c:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(u=null==U?void 0:U._defineLinearSpecularReflection)&&void 0!==u?u:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:null!==(d=null==U?void 0:U._vReflectionFilteringInfoName)&&void 0!==d?d:"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",W,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});const Y=this.sheen.isConnected?null===(p=this.sheen.connectedPoint)||void 0===p?void 0:p.ownerBlock:null;Y&&(e.compilationString+=Y.getCode(U)),e._emitFunctionFromInclude("pbrBlockSheen",W,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(_=null==U?void 0:U._define3DName)&&void 0!==_?_:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(g=null==U?void 0:U._defineSkyboxName)&&void 0!==g?g:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(m=null==U?void 0:U._defineLODReflectionAlpha)&&void 0!==m?m:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(f=null==U?void 0:U._defineLinearSpecularReflection)&&void 0!==f?f:"LINEARSPECULARREFLECTION"}]});const X=this.iridescence.isConnected?null===(b=this.iridescence.connectedPoint)||void 0===b?void 0:b.ownerBlock:null;e.compilationString+=zh.$.GetCode(X),e._emitFunctionFromInclude("pbrBlockIridescence",W,{replaceStrings:[]});const Q=this.clearcoat.isConnected?null===(v=this.clearcoat.connectedPoint)||void 0===v?void 0:v.ownerBlock:null,q=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,K=this.perturbedNormal.isConnected&&(null===(x=(null===(y=this.perturbedNormal.connectedPoint)||void 0===y?void 0:y.ownerBlock).worldTangent)||void 0===x?void 0:x.isConnected),Z=this.anisotropy.isConnected&&(null===(P=this.anisotropy.connectedPoint)||void 0===P?void 0:P.ownerBlock).worldTangent.isConnected;let J=K||!this.perturbedNormal.isConnected&&Z;e.compilationString+=kh.N.GetCode(e,Q,U,j,q,J,this.worldNormal.associatedVariableName),q&&(J=null!==(C=null==Q?void 0:Q.worldTangent.isConnected)&&void 0!==C&&C),e._emitFunctionFromInclude("pbrBlockClearcoat",W,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(T=null==U?void 0:U._define3DName)&&void 0!==T?T:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(S=null==U?void 0:U._defineOppositeZ)&&void 0!==S?S:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(E=null==U?void 0:U._defineProjectionName)&&void 0!==E?E:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(R=null==U?void 0:U._defineSkyboxName)&&void 0!==R?R:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(M=null==U?void 0:U._defineLODReflectionAlpha)&&void 0!==M?M:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(A=null==U?void 0:U._defineLinearSpecularReflection)&&void 0!==A?A:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:J?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",W,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(I=null==U?void 0:U._defineSkyboxName)&&void 0!==I?I:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(O=null==U?void 0:U._define3DName)&&void 0!==O?O:"REFLECTIONMAP_3D"}]});const ee=this.subsurface.isConnected?null===(w=this.subsurface.connectedPoint)||void 0===w?void 0:w.ownerBlock:null,te=this.subsurface.isConnected?null===(B=(null===(D=this.subsurface.connectedPoint)||void 0===D?void 0:D.ownerBlock).refraction.connectedPoint)||void 0===B?void 0:B.ownerBlock:null;te&&(te.viewConnectionPoint=this.view,te.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=Gh.l.GetCode(e,ee,U,j),e._emitFunctionFromInclude("pbrBlockSubSurface",W,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(N=null==U?void 0:U._define3DName)&&void 0!==N?N:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(F=null==U?void 0:U._defineOppositeZ)&&void 0!==F?F:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(L=null==U?void 0:U._defineProjectionName)&&void 0!==L?L:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:null!==(V=null==te?void 0:te._define3DName)&&void 0!==V?V:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:null!==(k=null==te?void 0:te._defineLODRefractionAlpha)&&void 0!==k?k:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:null!==(z=null==te?void 0:te._defineLinearSpecularRefraction)&&void 0!==z?z:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:null!==(G=null==te?void 0:te._defineOppositeZ)&&void 0!==G?G:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",W),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",W,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",W,{repeatKey:"maxSimultaneousLights"}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",W),e.compilationString+="#endif\n";const ie=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)";let se=Vn.m.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();-1===se.indexOf(".")&&(se+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",W,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:ie+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:se}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",W,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",W,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",W,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:j},{search:/albedoTexture\.rgb;/g,replace:"vec3(1.);\ngl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\n"}]});for(const t of this._outputs)if(t.hasEndpoints){const i=Uh[t.name];if(i){const[s,r]=i;r&&(e.compilationString+=`#if ${r}\n`),e.compilationString+=`${this._declareOutput(t,e)} = ${s};\n`,r&&(e.compilationString+="#else\n",e.compilationString+=`${this._declareOutput(t,e)} = vec3(0.);\n`,e.compilationString+="#endif\n")}else console.error(`There's no remapping for the ${t.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};\n`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};\n`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};\n`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};\n`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};\n`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};\n`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};\n`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};\n`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};\n`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};\n`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};\n`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};\n`,e+=`${this._codeVariableName}.unlit = ${this.unlit};\n`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};\n`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};\n`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};\n`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};\n`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){var s,r;super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=null!==(s=e.lightFalloff)&&void 0!==s?s:0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=null!==(r=e.realTimeFilteringQuality)&&void 0!==r?r:8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}(0,H.gn)([(0,ga.p)("Direct lights",ga.U.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Wh.prototype,"directIntensity",void 0),(0,H.gn)([(0,ga.p)("Environment lights",ga.U.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Wh.prototype,"environmentIntensity",void 0),(0,H.gn)([(0,ga.p)("Specular highlights",ga.U.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Wh.prototype,"specularIntensity",void 0),(0,H.gn)([(0,ga.p)("Light falloff",ga.U.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:Vn.m.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:Vn.m.LIGHTFALLOFF_GLTF},{label:"Standard",value:Vn.m.LIGHTFALLOFF_STANDARD}]})],Wh.prototype,"lightFalloff",void 0),(0,H.gn)([(0,ga.p)("Alpha Testing",ga.U.Boolean,"OPACITY")],Wh.prototype,"useAlphaTest",void 0),(0,H.gn)([(0,ga.p)("Alpha CutOff",ga.U.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],Wh.prototype,"alphaTestCutoff",void 0),(0,H.gn)([(0,ga.p)("Alpha blending",ga.U.Boolean,"OPACITY")],Wh.prototype,"useAlphaBlending",void 0),(0,H.gn)([(0,ga.p)("Radiance over alpha",ga.U.Boolean,"RENDERING",{notifiers:{update:!0}})],Wh.prototype,"useRadianceOverAlpha",void 0),(0,H.gn)([(0,ga.p)("Specular over alpha",ga.U.Boolean,"RENDERING",{notifiers:{update:!0}})],Wh.prototype,"useSpecularOverAlpha",void 0),(0,H.gn)([(0,ga.p)("Specular anti-aliasing",ga.U.Boolean,"RENDERING",{notifiers:{update:!0}})],Wh.prototype,"enableSpecularAntiAliasing",void 0),(0,H.gn)([(0,ga.p)("Realtime filtering",ga.U.Boolean,"RENDERING",{notifiers:{update:!0}})],Wh.prototype,"realTimeFiltering",void 0),(0,H.gn)([(0,ga.p)("Realtime filtering quality",ga.U.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],Wh.prototype,"realTimeFilteringQuality",void 0),(0,H.gn)([(0,ga.p)("Energy Conservation",ga.U.Boolean,"ADVANCED",{notifiers:{update:!0}})],Wh.prototype,"useEnergyConservation",void 0),(0,H.gn)([(0,ga.p)("Radiance occlusion",ga.U.Boolean,"ADVANCED",{notifiers:{update:!0}})],Wh.prototype,"useRadianceOcclusion",void 0),(0,H.gn)([(0,ga.p)("Horizon occlusion",ga.U.Boolean,"ADVANCED",{notifiers:{update:!0}})],Wh.prototype,"useHorizonOcclusion",void 0),(0,H.gn)([(0,ga.p)("Unlit",ga.U.Boolean,"ADVANCED",{notifiers:{update:!0}})],Wh.prototype,"unlit",void 0),(0,H.gn)([(0,ga.p)("Force normal forward",ga.U.Boolean,"ADVANCED",{notifiers:{update:!0}})],Wh.prototype,"forceNormalForward",void 0),(0,H.gn)([(0,ga.p)("Generate only fragment code",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Wh._OnGenerateOnlyFragmentCodeChanged}})],Wh.prototype,"generateOnlyFragmentCode",void 0),(0,H.gn)([(0,ga.p)("Debug mode",ga.U.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],Wh.prototype,"debugMode",void 0),(0,H.gn)([(0,ga.p)("Split position",ga.U.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],Wh.prototype,"debugLimit",void 0),(0,H.gn)([(0,ga.p)("Output factor",ga.U.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],Wh.prototype,"debugFactor",void 0),(0,c.H)("BABYLON.PBRMetallicRoughnessBlock",Wh);var Hh,jh=i(47964),$h=i(23758),Yh=i(79190),Xh=i(99240);class Qh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("left",ta.E.AutoDetect),this.registerInput("right",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.ModBlock",Qh);class qh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("row0",ta.E.Vector4),this.registerInput("row1",ta.E.Vector4),this.registerInput("row2",ta.E.Vector4),this.registerInput("row3",ta.E.Vector4),this.registerOutput("output",ta.E.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new la.S("row0");e.value=new m.Lt(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new la.S("row1");e.value=new m.Lt(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new la.S("row2");e.value=new m.Lt(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new la.S("row3");e.value=new m.Lt(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.row0,s=this.row1,r=this.row2,n=this.row3;return e.compilationString+=this._declareOutput(t,e)+` = mat4(${i.associatedVariableName}, ${s.associatedVariableName}, ${r.associatedVariableName}, ${n.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.MatrixBuilder",qh),function(e){e[e.Equal=0]="Equal",e[e.NotEqual=1]="NotEqual",e[e.LessThan=2]="LessThan",e[e.GreaterThan=3]="GreaterThan",e[e.LessOrEqual=4]="LessOrEqual",e[e.GreaterOrEqual=5]="GreaterOrEqual",e[e.Xor=6]="Xor",e[e.Or=7]="Or",e[e.And=8]="And"}(Hh||(Hh={}));class Kh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.condition=Hh.LessThan,this.registerInput("a",ta.E.Float),this.registerInput("b",ta.E.Float),this.registerInput("true",ta.E.AutoDetect,!0),this.registerInput("false",ta.E.AutoDetect,!0),this.registerOutput("output",ta.E.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=ta.E.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",s=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case Hh.Equal:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} == ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case Hh.NotEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} != ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case Hh.LessThan:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} < ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case Hh.LessOrEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} <= ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case Hh.GreaterThan:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} > ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case Hh.GreaterOrEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} >= ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case Hh.Xor:e.compilationString+=this._declareOutput(t,e)+` = (mod(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 2.0) > 0.0) ? ${i} : ${s};\n`;break;case Hh.Or:e.compilationString+=this._declareOutput(t,e)+` = (min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0) ? ${i} : ${s};\n`;break;case Hh.And:e.compilationString+=this._declareOutput(t,e)+` = (${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)  ? ${i} : ${s};\n`}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${Hh[this.condition]};\n`}}(0,c.H)("BABYLON.ConditionalBlock",Kh);class Zh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.octaves=6,this.registerInput("seed",ta.E.AutoDetect),this.registerInput("chaos",ta.E.AutoDetect,!0),this.registerInput("offsetX",ta.E.Float,!0),this.registerInput("offsetY",ta.E.Float,!0),this.registerInput("offsetZ",ta.E.Float,!0),this.registerOutput("output",ta.E.Float),this._inputs[0].acceptedConnectionPointTypes.push(ta.E.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(ta.E.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){var t,i;if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;const s=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode","\n\n        float cloudRandom(in float p) { p = fract(p * 0.011); p *= p + 7.5; p *= p + p; return fract(p); }\n\n        // Based on Morgan McGuire @morgan3d\n        // https://www.shadertoy.com/view/4dS3Wd\n        float cloudNoise(in vec2 x, in vec2 chaos) {\n            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);\n\n            vec2 i = floor(x);\n            vec2 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec2 u = f * f * (3.0 - 2.0 * f);\n            return mix(\n                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),\n                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),\n                    u.y\n                );\n        }\n\n        float cloudNoise(in vec3 x, in vec3 chaos) {\n            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);\n\n            vec3 i = floor(x);\n            vec3 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec3 u = f * f * (3.0 - 2.0 * f);\n            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),\n                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);\n        }","// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,"\n        float fbm(in vec2 st, in vec2 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = .5;\n            float frequency = 0.;\n\n            // Loop of octaves\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise(st, chaos);\n                st *= 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }\n\n        float fbm(in vec3 x, in vec3 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = 0.5;\n            for (int i = 0; i < OCTAVES; ++i) {\n                value += amplitude * cloudNoise(x, chaos);\n                x = x * 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }".replace(/fbm/gi,s).replace(/OCTAVES/gi,(0|this.octaves).toString()),"// CloudBlockCode FBM");const r=e._getFreeVariableName("st"),n=(null===(t=this.seed.connectedPoint)||void 0===t?void 0:t.type)===ta.E.Vector2?"vec2":"vec3";e.compilationString+=`${n} ${r} = ${this.seed.associatedVariableName};\n`,this.offsetX.isConnected&&(e.compilationString+=`${r}.x += 0.1 * ${this.offsetX.associatedVariableName};\n`),this.offsetY.isConnected&&(e.compilationString+=`${r}.y += 0.1 * ${this.offsetY.associatedVariableName};\n`),this.offsetZ.isConnected&&"vec3"===n&&(e.compilationString+=`${r}.z += 0.1 * ${this.offsetZ.associatedVariableName};\n`);let o="";return o=this.chaos.isConnected?this.chaos.associatedVariableName:(null===(i=this.seed.connectedPoint)||void 0===i?void 0:i.type)===ta.E.Vector2?"vec2(0., 0.)":"vec3(0., 0., 0.)",e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${s}(${r}, ${o});\n`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};\n`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}(0,H.gn)([(0,ga.p)("Octaves",ga.U.Int)],Zh.prototype,"octaves",void 0),(0,c.H)("BABYLON.CloudBlock",Zh);class Jh extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("seed",ta.E.Vector2),this.registerInput("offset",ta.E.Float),this.registerInput("density",ta.E.Float),this.registerOutput("output",ta.E.Float),this.registerOutput("cells",ta.E.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t="vec2 voronoiRandom(vec2 seed, float offset){\n            mat2 m = mat2(15.27, 47.63, 99.41, 89.98);\n            vec2 uv = fract(sin(m * seed) * 46839.32);\n            return vec2(sin(uv.y * offset) * 0.5 + 0.5, cos(uv.x * offset) * 0.5 + 0.5);\n        }\n        ";e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t="void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){\n            vec2 g = floor(seed * density);\n            vec2 f = fract(seed * density);\n            float t = 8.0;\n            vec3 res = vec3(8.0, 0.0, 0.0);\n\n            for(int y=-1; y<=1; y++)\n            {\n                for(int x=-1; x<=1; x++)\n                {\n                    vec2 lattice = vec2(x,y);\n                    vec2 randomOffset = voronoiRandom(lattice + g, offset);\n                    float d = distance(lattice + randomOffset, f);\n                    if(d < res.x)\n                    {\n                        res = vec3(d, randomOffset.x, randomOffset.y);\n                        outValue = res.x;\n                        cells = res.y;\n                    }\n                }\n            }\n        }\n        ",e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),s=e._getFreeVariableName("tempCells");return e.compilationString+=`float ${i} = 0.0;\n`,e.compilationString+=`float ${s} = 0.0;\n`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${i}, ${s});\n`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\n`),this.cells.hasEndpoints&&(e.compilationString+=this._declareOutput(this.cells,e)+` = ${s};\n`),this}}(0,c.H)("BABYLON.VoronoiNoiseBlock",Jh);class el extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("input",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==ea.u.VertexAndFragment)return t.target;if(e.connectedPoint.target!==ea.u.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){0==(this._target&e)&&(this._target=e)}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${i.associatedVariableName};\n`,this}}(0,c.H)("BABYLON.ElbowBlock",el);var tl,il,sl=i(81059);class rl extends sl.H{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_generateTextureLookup(e){var t;const i=this.samplerName,s=null!==(t=this.samplerYName)&&void 0!==t?t:this.samplerName,r=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",n=e._getFreeVariableName("dpdx"),o=e._getFreeVariableName("dpdy"),a=e._getFreeVariableName("n"),h=e._getFreeVariableName("ma"),l=e._getFreeVariableName("mi"),c=e._getFreeVariableName("me"),u=e._getFreeVariableName("x"),d=e._getFreeVariableName("y"),p=e._getFreeVariableName("y");e.compilationString+=`\n            // grab coord derivatives for texturing\n            vec3 ${n} = dFdx(${this.position.associatedVariableName}.xyz);\n            vec3 ${o} = dFdy(${this.position.associatedVariableName}.xyz);\n            vec3 ${a} = abs(${this.normal.associatedVariableName}.xyz);\n        \n            // determine major axis (in x; yz are following axis)\n            ivec3 ${h} = (${a}.x>${a}.y && ${a}.x>${a}.z) ? ivec3(0,1,2) :\n                    (${a}.y>${a}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine minor axis (in x; yz are following axis)\n            ivec3 ${l} = (${a}.x<${a}.y && ${a}.x<${a}.z) ? ivec3(0,1,2) :\n                    (${a}.y<${a}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine median axis (in x;  yz are following axis)\n            ivec3 ${c} = ivec3(3) - ${l} - ${h};\n            \n            // project+fetch\n            vec4 ${u} = textureGrad( ${i}, vec2(   ${this.position.associatedVariableName}[${h}.y],   ${this.position.associatedVariableName}[${h}.z]), \n                                    vec2(${n}[${h}.y],${n}[${h}.z]), \n                                    vec2(${o}[${h}.y],${o}[${h}.z]) );\n            vec4 ${d} = textureGrad( ${s}, vec2(   ${this.position.associatedVariableName}[${c}.y],   ${this.position.associatedVariableName}[${c}.z]), \n                                    vec2(${n}[${c}.y],${n}[${c}.z]),\n                                    vec2(${o}[${c}.y],${o}[${c}.z]) );\n            \n            // blend factors\n            vec2 ${p} = vec2(${a}[${h}.x],${a}[${c}.x]);\n            // make local support\n            ${p} = clamp( (${p}-0.5773)/(1.0-0.5773), 0.0, 1.0 );\n            // shape transition\n            ${p} = pow( ${p}, vec2(${r}/8.0) );\n            // blend and return\n            vec4 ${this._tempTextureRead} = (${u}*${p}.x + ${d}*${p}.y) / (${p}.x + ${p}.y);\n        `}}(0,c.H)("BABYLON.BiPlanarBlock",rl);class nl extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("input",ta.E.Matrix),this.registerOutput("output",ta.E.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = determinant(${i.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.MatrixDeterminantBlock",nl);class ol extends aa.k{constructor(e){super(e,ea.u.Neutral),this.registerInput("input",ta.E.Matrix),this.registerOutput("output",ta.E.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = transpose(${i.associatedVariableName});\n`,this}}(0,c.H)("BABYLON.MatrixTransposeBlock",ol),function(e){e[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Tangent=2]="Tangent",e[e.VertexColor=3]="VertexColor",e[e.UV1=4]="UV1",e[e.UV2=5]="UV2",e[e.UV3=6]="UV3",e[e.UV4=7]="UV4",e[e.UV5=8]="UV5",e[e.UV6=9]="UV6"}(tl||(tl={}));class al extends aa.k{constructor(e){super(e,ea.u.Neutral),this.attributeType=tl.None,this.registerInput("input",ta.E.AutoDetect),this.registerInput("fallback",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].onConnectionObservable.add((e=>{var t;if(this.attributeType)return;const i=e.ownerBlock;if(i instanceof la.S&&i.isAttribute)switch(i.name){case"color":this.attributeType=tl.VertexColor;break;case"normal":this.attributeType=tl.Normal;break;case"tangent":this.attributeType=tl.Tangent;break;case"uv":this.attributeType=tl.UV1;break;case"uv2":this.attributeType=tl.UV2;break;case"uv3":this.attributeType=tl.UV3;break;case"uv4":this.attributeType=tl.UV4;break;case"uv5":this.attributeType=tl.UV5;break;case"uv6":this.attributeType=tl.UV6}else if(i instanceof da.U)switch(null===(t=this.input.connectedPoint)||void 0===t?void 0:t.name){case"normalOutput":this.attributeType=tl.Normal;break;case"tangentOutput":this.attributeType=tl.Tangent;break;case"uvOutput":this.attributeType=tl.UV1}}))}getClassName(){return"MeshAttributeExistsBlock"}get input(){return this._inputs[0]}get fallback(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.attributeType){case tl.VertexColor:t="VERTEXCOLOR_NME";break;case tl.Normal:t="NORMAL";break;case tl.Tangent:t="TANGENT";break;case tl.UV1:t="UV1";break;case tl.UV2:t="UV2";break;case tl.UV3:t="UV3";break;case tl.UV4:t="UV4";break;case tl.UV5:t="UV5";break;case tl.UV6:t="UV6"}const i=this._declareOutput(this.output,e);return t&&(e.compilationString+=`#ifdef ${t}\n`),e.compilationString+=`${i} = ${this.input.associatedVariableName};\n`,t&&(e.compilationString+="#else\n",e.compilationString+=`${i} = ${this.fallback.associatedVariableName};\n`,e.compilationString+="#endif\n"),this}serialize(){const e=super.serialize();return e.attributeType=this.attributeType,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.attributeType=null!==(s=e.attributeType)&&void 0!==s?s:tl.None}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.attributeType = ${this.attributeType};\n`,e}}(0,H.gn)([(0,ga.p)("Attribute lookup",ga.U.List,void 0,{notifiers:{update:!0},options:[{label:"(None)",value:tl.None},{label:"Normal",value:tl.Normal},{label:"Tangent",value:tl.Tangent},{label:"Vertex Color",value:tl.VertexColor},{label:"UV1",value:tl.UV1},{label:"UV2",value:tl.UV2},{label:"UV3",value:tl.UV3},{label:"UV4",value:tl.UV4},{label:"UV5",value:tl.UV5},{label:"UV6",value:tl.UV6}]})],al.prototype,"attributeType",void 0),(0,c.H)("BABYLON.MeshAttributeExistsBlock",al),function(e){e[e.EaseInSine=0]="EaseInSine",e[e.EaseOutSine=1]="EaseOutSine",e[e.EaseInOutSine=2]="EaseInOutSine",e[e.EaseInQuad=3]="EaseInQuad",e[e.EaseOutQuad=4]="EaseOutQuad",e[e.EaseInOutQuad=5]="EaseInOutQuad",e[e.EaseInCubic=6]="EaseInCubic",e[e.EaseOutCubic=7]="EaseOutCubic",e[e.EaseInOutCubic=8]="EaseInOutCubic",e[e.EaseInQuart=9]="EaseInQuart",e[e.EaseOutQuart=10]="EaseOutQuart",e[e.EaseInOutQuart=11]="EaseInOutQuart",e[e.EaseInQuint=12]="EaseInQuint",e[e.EaseOutQuint=13]="EaseOutQuint",e[e.EaseInOutQuint=14]="EaseInOutQuint",e[e.EaseInExpo=15]="EaseInExpo",e[e.EaseOutExpo=16]="EaseOutExpo",e[e.EaseInOutExpo=17]="EaseInOutExpo",e[e.EaseInCirc=18]="EaseInCirc",e[e.EaseOutCirc=19]="EaseOutCirc",e[e.EaseInOutCirc=20]="EaseInOutCirc",e[e.EaseInBack=21]="EaseInBack",e[e.EaseOutBack=22]="EaseOutBack",e[e.EaseInOutBack=23]="EaseInOutBack",e[e.EaseInElastic=24]="EaseInElastic",e[e.EaseOutElastic=25]="EaseOutElastic",e[e.EaseInOutElastic=26]="EaseInOutElastic"}(il||(il={}));class hl extends aa.k{constructor(e){super(e,ea.u.Neutral),this.type=il.EaseInOutSine,this.registerInput("input",ta.E.AutoDetect),this.registerOutput("output",ta.E.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(ta.E.Matrix),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Object),this._inputs[0].excludedConnectionPointTypes.push(ta.E.Int)}getClassName(){return"CurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_duplicateEntry(e,t){return`ret.${t} = ${e.replace(/VAL/g,"v."+t)}`}_duplicateEntryDirect(e){return`return ${e.replace(/VAL/g,"v")}`}_duplicateVector(e,t){if("float"===t)return this._duplicateEntryDirect(e);const i=parseInt(t.replace("vec",""));let s=`\n            vec${i} ret = vec${i}(0.0);\n        `;for(let t=1;t<=i;t++)s+=this._duplicateEntry(e,1===t?"x":2===t?"y":3===t?"z":"w")+";\n";return s+="return ret;\n",s}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="",s="",r="";switch(this.input.type){case ta.E.Float:r="float";break;case ta.E.Vector2:r="vec2";break;case ta.E.Vector3:case ta.E.Color3:r="vec3";break;case ta.E.Vector4:case ta.E.Color4:r="vec4"}switch(s=il[this.type]+"_"+r,this.type){case il.EaseInSine:i="return 1.0 - cos((v * 3.1415) / 2.0)";break;case il.EaseOutSine:i="return sin((v * 3.1415) / 2.0)";break;case il.EaseInOutSine:i="return -(cos(v * 3.1415) - 1.0) / 2.0";break;case il.EaseInQuad:i="return v * v";break;case il.EaseOutQuad:i="return (1.0 - v) * (1.0 - v)";break;case il.EaseInOutQuad:{const e="VAL < 0.5 ? 2.0 * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 2.0) / 2.0";i=this._duplicateVector(e,r);break}case il.EaseInCubic:i="return v * v * v";break;case il.EaseOutCubic:{const e="1.0 - pow(1.0 - VAL, 3.0)";i=this._duplicateVector(e,r);break}case il.EaseInOutCubic:{const e="VAL < 0.5 ? 4.0 * VAL * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 3.0) / 2.0";i=this._duplicateVector(e,r);break}case il.EaseInQuart:i="return v * v * v * v";break;case il.EaseOutQuart:{const e="1.0 - pow(1.0 - VAL, 4.0)";i=this._duplicateVector(e,r);break}case il.EaseInOutQuart:{const e="VAL < 0.5 ? 8.0 * VAL * VAL * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 4.0) / 2.0";i=this._duplicateVector(e,r);break}case il.EaseInQuint:i="return v * v * v * v * v";break;case il.EaseOutQuint:{const e="1.0 - pow(1.0 - VAL, 5.0)";i=this._duplicateVector(e,r);break}case il.EaseInOutQuint:{const e="VAL < 0.5 ? 16.0 * VAL * VAL * VAL * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 5.0) / 2.0";i=this._duplicateVector(e,r);break}case il.EaseInExpo:{const e="VAL == 0.0 ? 0.0 : pow(2.0, 10.0 * VAL - 10.0)";i=this._duplicateVector(e,r);break}case il.EaseOutExpo:{const e="VAL == 1.0 ? 1.0 : 1.0 - pow(2.0, -10.0 * VAL)";i=this._duplicateVector(e,r);break}case il.EaseInOutExpo:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : VAL < 0.5 ? pow(2.0, 20.0 * VAL - 10.0) / 2.0 : (2.0 - pow(2.0, -20.0 * VAL + 10.0)) / 2.0";i=this._duplicateVector(e,r);break}case il.EaseInCirc:{const e="1.0 - sqrt(1.0 - pow(VAL, 2.0))";i=this._duplicateVector(e,r);break}case il.EaseOutCirc:{const e="sqrt(1.0 - pow(VAL - 1.0, 2.0))";i=this._duplicateVector(e,r);break}case il.EaseInOutCirc:{const e="VAL < 0.5 ? (1.0 - sqrt(1.0 - pow(2.0 * VAL, 2.0))) / 2.0 : (sqrt(1.0 - pow(-2.0 * VAL + 2.0, 2.0)) + 1.0) / 2.0";i=this._duplicateVector(e,r);break}case il.EaseInBack:i="return 2.70158 * v * v * v - 1.70158 * v * v";break;case il.EaseOutBack:{const e="2.70158 * pow(VAL - 1.0, 3.0) + 1.70158 * pow(VAL - 1.0, 2.0)";i=this._duplicateVector(e,r);break}case il.EaseInOutBack:{const e="VAL < 0.5 ? (pow(2.0 * VAL, 2.0) * ((3.5949095) * 2.0 * VAL - 2.5949095)) / 2.0 : (pow(2.0 * VAL - 2.0, 2.0) * (3.5949095 * (VAL * 2.0 - 2.0) + 3.5949095) + 2.0) / 2.0";i=this._duplicateVector(e,r);break}case il.EaseInElastic:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : -pow(2.0, 10.0 * VAL - 10.0) * sin((VAL * 10.0 - 10.75) * ((2.0 * 3.1415) / 3.0))";i=this._duplicateVector(e,r);break}case il.EaseOutElastic:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : pow(2.0, -10.0 * VAL) * sin((VAL * 10.0 - 0.75) * ((2.0 * 3.1415) / 3.0)) + 1.0";i=this._duplicateVector(e,r);break}case il.EaseInOutElastic:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : VAL < 0.5 ? -(pow(2.0, 20.0 * VAL - 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 : (pow(2.0, -20.0 * VAL + 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 + 1.0";i=this._duplicateVector(e,r);break}}return e._emitFunction(s,`${r} ${s}(${r} v) {${i};}\n`,""),e.compilationString+=this._declareOutput(t,e)+` = ${s}(${this.input.associatedVariableName});\n`,this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.CurveBlockTypes.${il[this.type]};\n`}}(0,c.H)("BABYLON.CurveBlock",hl);class ll{optimize(e,t){}}var cl=i(7084),ul=i(41762);class dl{constructor(){this.mm=new Map}get(e,t){const i=this.mm.get(e);if(void 0!==i)return i.get(t)}set(e,t,i){let s=this.mm.get(e);void 0===s&&this.mm.set(e,s=new Map),s.set(t,i)}}class pl{get standalone(){var e,t;return null!==(t=null===(e=this._options)||void 0===e?void 0:e.standalone)&&void 0!==t&&t}get baseMaterial(){return this._baseMaterial}get doNotInjectCode(){var e,t;return null!==(t=null===(e=this._options)||void 0===e?void 0:e.doNotInjectCode)&&void 0!==t&&t}constructor(e,t,i){this._baseMaterial=e,this._scene=null!=t?t:D.l.LastCreatedScene,this._options=i,this._subMeshToEffect=new Map,this._subMeshToDepthWrapper=new dl,this._meshes=new Map,this._onEffectCreatedObserver=this._baseMaterial.onEffectCreatedObservable.add((e=>{var t;const i=null===(t=e.subMesh)||void 0===t?void 0:t.getMesh();i&&!this._meshes.has(i)&&this._meshes.set(i,i.onDisposeObservable.add((e=>{const t=this._subMeshToEffect.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value;(null==t?void 0:t.getMesh())===e&&(this._subMeshToEffect.delete(t),this._subMeshToDepthWrapper.mm.delete(t))}}))),this._subMeshToEffect.set(e.subMesh,[e.effect,this._scene.getEngine().currentRenderPassId]),this._subMeshToDepthWrapper.mm.delete(e.subMesh)}))}getEffect(e,t,i){var s;const r=null===(s=this._subMeshToDepthWrapper.mm.get(e))||void 0===s?void 0:s.get(t);if(!r)return null;let n=r.drawWrapper[i];return n||(n=r.drawWrapper[i]=new Di.q(this._scene.getEngine()),n.setEffect(r.mainDrawWrapper.effect,r.mainDrawWrapper.defines)),n}isReadyForSubMesh(e,t,i,s,r){var n,o;return!(this.standalone&&!this._baseMaterial.isReadyForSubMesh(e.getMesh(),e,s))&&null!==(o=null===(n=this._makeEffect(e,t,i,r))||void 0===n?void 0:n.isReady())&&void 0!==o&&o}dispose(){this._baseMaterial.onEffectCreatedObservable.remove(this._onEffectCreatedObserver),this._onEffectCreatedObserver=null;const e=this._meshes.entries();for(let t=e.next();!0!==t.done;t=e.next()){const[e,i]=t.value;e.onDisposeObservable.remove(i)}}_makeEffect(e,t,i,s){var r,n,o;const a=this._scene.getEngine(),h=this._subMeshToEffect.get(e);if(!h)return null;const[l,c]=h;let u=this._subMeshToDepthWrapper.get(e,i);if(!u){const t=new Di.q(a);t.defines=null!==(n=null===(r=e._getDrawWrapper(c))||void 0===r?void 0:r.defines)&&void 0!==n?n:null,u={drawWrapper:[],mainDrawWrapper:t,depthDefines:"",token:(0,ul.f)()},u.drawWrapper[s]=t,this._subMeshToDepthWrapper.set(e,i,u)}const d=t.join("\n");if(u.mainDrawWrapper.effect&&d===u.depthDefines)return u.mainDrawWrapper.effect;u.depthDefines=d;const p=l.getUniformNames().slice();let _=l.vertexSourceCodeBeforeMigration,g=l.fragmentSourceCodeBeforeMigration;if(!this.doNotInjectCode){const e=this._options&&this._options.remappedVariables?`#include<shadowMapVertexNormalBias>(${this._options.remappedVariables.join(",")})`:Pi.Q.IncludesShadersStore.shadowMapVertexNormalBias,t=this._options&&this._options.remappedVariables?`#include<shadowMapVertexMetric>(${this._options.remappedVariables.join(",")})`:Pi.Q.IncludesShadersStore.shadowMapVertexMetric,i=this._options&&this._options.remappedVariables?`#include<shadowMapFragmentSoftTransparentShadow>(${this._options.remappedVariables.join(",")})`:Pi.Q.IncludesShadersStore.shadowMapFragmentSoftTransparentShadow,s=Pi.Q.IncludesShadersStore.shadowMapFragment;_=_.replace(/void\s+?main/g,Pi.Q.IncludesShadersStore.shadowMapVertexExtraDeclaration+"\nvoid main"),_=_.replace(/#define SHADOWDEPTH_NORMALBIAS|#define CUSTOM_VERTEX_UPDATE_WORLDPOS/g,e),_=-1!==_.indexOf("#define SHADOWDEPTH_METRIC")?_.replace(/#define SHADOWDEPTH_METRIC/g,t):_.replace(/}\s*$/g,t+"\n}"),_=_.replace(/#define SHADER_NAME.*?\n|out vec4 glFragColor;\n/g,"");const r=g.indexOf("#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW")>=0||g.indexOf("#define CUSTOM_FRAGMENT_BEFORE_FOG")>=0,n=-1!==g.indexOf("#define SHADOWDEPTH_FRAGMENT");let o="";r?g=g.replace(/#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW|#define CUSTOM_FRAGMENT_BEFORE_FOG/g,i):o=i+"\n",g=g.replace(/void\s+?main/g,Pi.Q.IncludesShadersStore.shadowMapFragmentExtraDeclaration+"\nvoid main"),n?g=g.replace(/#define SHADOWDEPTH_FRAGMENT/g,s):o+=s+"\n",o&&(g=g.replace(/}\s*$/g,o+"}")),p.push("biasAndScaleSM","depthValuesSM","lightDataSM","softTransparentShadowSM")}u.mainDrawWrapper.effect=a.createEffect({vertexSource:_,fragmentSource:g,vertexToken:u.token,fragmentToken:u.token},{attributes:l.getAttributesNames(),uniformsNames:p,uniformBuffersNames:l.getUniformBuffersNames(),samplers:l.getSamplers(),defines:d+"\n"+l.defines.replace("#define SHADOWS","").replace(/#define SHADOW\d/g,""),indexParameters:l.getIndexParameters()},a);for(let e=0;e<u.drawWrapper.length;++e)e!==s&&(null===(o=u.drawWrapper[e])||void 0===o||o.setEffect(u.mainDrawWrapper.effect,u.mainDrawWrapper.defines));return u.mainDrawWrapper.effect}}var _l=i(66794),gl=i(29894),ml=i(36261),fl=i(47192),bl=i(46867),vl=i(12162);function yl(e){return e instanceof Vn.m?new Ln.u(e):null}function xl(e){return e instanceof Vn.m?new vl.d(e):null}function Pl(e){return e instanceof Vn.m?new zn.Y(e):null}function Cl(e){return e instanceof Vn.m?new Gn.B(e):null}function Tl(e){return e instanceof Vn.m?new Hn.B(e):null}function Sl(e){return e instanceof Vn.m?new jn.u(e):null}function El(e){return e instanceof Vn.m||e instanceof Ot.K?new fl.p(e):null}var Rl=i(47409);const Ml=[new Zs.Wo(.98,.26,.38),new Zs.Wo(.47,.75,.3),new Zs.Wo(0,.26,.77),new Zs.Wo(.97,.6,.76),new Zs.Wo(.19,.63,.78),new Zs.Wo(.98,.8,.6),new Zs.Wo(.65,.43,.15),new Zs.Wo(.15,.47,.22),new Zs.Wo(.67,.71,.86),new Zs.Wo(.09,.46,.56),new Zs.Wo(.8,.98,.02),new Zs.Wo(.39,.29,.13),new Zs.Wo(.53,.63,.06),new Zs.Wo(.95,.96,.41),new Zs.Wo(1,.72,.94),new Zs.Wo(.63,.08,.31),new Zs.Wo(.66,.96,.95),new Zs.Wo(.22,.14,.19),new Zs.Wo(.14,.65,.59),new Zs.Wo(.93,1,.68),new Zs.Wo(.93,.14,.44),new Zs.Wo(.47,.86,.67),new Zs.Wo(.85,.07,.78),new Zs.Wo(.53,.64,.98),new Zs.Wo(.43,.37,.56),new Zs.Wo(.71,.65,.25),new Zs.Wo(.66,.19,.01),new Zs.Wo(.94,.53,.12),new Zs.Wo(.41,.44,.44),new Zs.Wo(.24,.71,.96),new Zs.Wo(.57,.28,.56),new Zs.Wo(.44,.98,.42)];var Al;!function(e){e[e.NONE=0]="NONE",e[e.TRIANGLES=1]="TRIANGLES",e[e.VERTICES=2]="VERTICES",e[e.TRIANGLES_VERTICES=3]="TRIANGLES_VERTICES",e[e.UV0=4]="UV0",e[e.UV1=5]="UV1",e[e.VERTEXCOLORS=6]="VERTEXCOLORS",e[e.MATERIALIDS=7]="MATERIALIDS"}(Al||(Al={}));class Il extends Dn.H{constructor(){super(...arguments),this.DBG_MODE=Al.NONE,this.DBG_MULTIPLY=!0,this.DBG_ENABLED=!0}}class Ol extends _l.n{_markAllDefinesAsDirty(){this._enable(this._isEnabled),this.markAllDefinesAsDirty()}constructor(e,t={}){var i,s,r,n,o,a,h,l,c,u,d,p,_;const g=new Il;g.DBG_MODE=null!==(i=t.mode)&&void 0!==i?i:g.DBG_MODE,g.DBG_MULTIPLY=null!==(s=t.multiply)&&void 0!==s?s:g.DBG_MULTIPLY,super(e,"MeshDebug",200,g,!0,!0),this._mode=g.DBG_MODE,this._multiply=g.DBG_MULTIPLY,this.shadedDiffuseColor=null!==(r=t.shadedDiffuseColor)&&void 0!==r?r:new Zs.Wo(1,1,1),this.shadedSpecularColor=null!==(n=t.shadedSpecularColor)&&void 0!==n?n:new Zs.Wo(.8,.8,.8),this.shadedSpecularPower=null!==(o=t.shadedSpecularPower)&&void 0!==o?o:10,this.wireframeThickness=null!==(a=t.wireframeThickness)&&void 0!==a?a:.7,this.wireframeTrianglesColor=null!==(h=t.wireframeTrianglesColor)&&void 0!==h?h:new Zs.Wo(0,0,0),this.wireframeVerticesColor=null!==(l=t.wireframeVerticesColor)&&void 0!==l?l:new Zs.Wo(.8,.8,.8),this.vertexColor=null!==(c=t.vertexColor)&&void 0!==c?c:new Zs.Wo(0,0,0),this.vertexRadius=null!==(u=t.vertexRadius)&&void 0!==u?u:1.2,this.uvScale=null!==(d=t.uvScale)&&void 0!==d?d:20,this.uvPrimaryColor=null!==(p=t.uvPrimaryColor)&&void 0!==p?p:new Zs.Wo(1,1,1),this.uvSecondaryColor=null!==(_=t.uvSecondaryColor)&&void 0!==_?_:new Zs.Wo(.5,.5,.5),this._materialColor=Ol.MaterialColors[Ol._PluginCount++%Ol.MaterialColors.length],this.isEnabled=!0}getClassName(){return"MeshDebugPluginMaterial"}get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled!==e){if(1==this._material.getScene().getEngine().webGLVersion)return p.Y.Error("MeshDebugPluginMaterial is not supported on WebGL 1.0."),void(this._isEnabled=!1);this._isEnabled=e,this._markAllDefinesAsDirty()}}prepareDefines(e,t,i){this._mode!=Al.VERTICES&&this._mode!=Al.TRIANGLES&&this._mode!=Al.TRIANGLES_VERTICES||i.isVerticesDataPresent("dbg_initialPass")||p.Y.Warn("For best results with TRIANGLES, TRIANGLES_VERTICES, or VERTICES modes, please use MeshDebugPluginMaterial.PrepareMeshForTrianglesAndVerticesMode() on mesh.",1),e.DBG_MODE=this._mode,e.DBG_MULTIPLY=this._multiply,e.DBG_ENABLED=this._isEnabled}getAttributes(e){e.push("dbg_initialPass")}getUniforms(){return{ubo:[{name:"dbg_shadedDiffuseColor",size:3,type:"vec3"},{name:"dbg_shadedSpecularColorPower",size:4,type:"vec4"},{name:"dbg_thicknessRadiusScale",size:3,type:"vec3"},{name:"dbg_wireframeTrianglesColor",size:3,type:"vec3"},{name:"dbg_wireframeVerticesColor",size:3,type:"vec3"},{name:"dbg_vertexColor",size:3,type:"vec3"},{name:"dbg_uvPrimaryColor",size:3,type:"vec3"},{name:"dbg_uvSecondaryColor",size:3,type:"vec3"},{name:"dbg_materialColor",size:3,type:"vec3"}],fragment:"#if defined(DBG_ENABLED)\nuniform vec3 dbg_shadedDiffuseColor;\nuniform vec4 dbg_shadedSpecularColorPower;\nuniform vec3 dbg_thicknessRadiusScale;\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    uniform vec3 dbg_vertexColor;\n#endif\n\n#if DBG_MODE == 1\n    uniform vec3 dbg_wireframeTrianglesColor;\n#elif DBG_MODE == 3\n    uniform vec3 dbg_wireframeVerticesColor;\n#elif DBG_MODE == 4 || DBG_MODE == 5\n    uniform vec3 dbg_uvPrimaryColor;\n    uniform vec3 dbg_uvSecondaryColor;\n#elif DBG_MODE == 7\n    uniform vec3 dbg_materialColor;\n#endif\n#endif"}}bindForSubMesh(e){this._isEnabled&&(e.updateFloat3("dbg_shadedDiffuseColor",this.shadedDiffuseColor.r,this.shadedDiffuseColor.g,this.shadedDiffuseColor.b),e.updateFloat4("dbg_shadedSpecularColorPower",this.shadedSpecularColor.r,this.shadedSpecularColor.g,this.shadedSpecularColor.b,this.shadedSpecularPower),e.updateFloat3("dbg_thicknessRadiusScale",this.wireframeThickness,this.vertexRadius,this.uvScale),e.updateColor3("dbg_wireframeTrianglesColor",this.wireframeTrianglesColor),e.updateColor3("dbg_wireframeVerticesColor",this.wireframeVerticesColor),e.updateColor3("dbg_vertexColor",this.vertexColor),e.updateColor3("dbg_uvPrimaryColor",this.uvPrimaryColor),e.updateColor3("dbg_uvSecondaryColor",this.uvSecondaryColor),e.updateColor3("dbg_materialColor",this._materialColor))}getCustomCode(e){return"vertex"===e?{CUSTOM_VERTEX_DEFINITIONS:"#if defined(DBG_ENABLED)\nattribute float dbg_initialPass;\nvarying vec3 dbg_vBarycentric;\nflat varying vec3 dbg_vVertexWorldPos;\nflat varying float dbg_vPass;\n#endif",CUSTOM_VERTEX_MAIN_END:"#if defined(DBG_ENABLED)\nfloat dbg_vertexIndex = mod(float(gl_VertexID), 3.);\nif (dbg_vertexIndex == 0.0) { \n    dbg_vBarycentric = vec3(1.,0.,0.); \n}\nelse if (dbg_vertexIndex == 1.0) { \n    dbg_vBarycentric = vec3(0.,1.,0.); \n}\nelse { \n    dbg_vBarycentric = vec3(0.,0.,1.); \n}\n\ndbg_vVertexWorldPos = vPositionW;\ndbg_vPass = dbg_initialPass;\n#endif"}:{CUSTOM_FRAGMENT_DEFINITIONS:"#if defined(DBG_ENABLED)\nvarying vec3 dbg_vBarycentric;\nflat varying vec3 dbg_vVertexWorldPos;\nflat varying float dbg_vPass;\n\n#if !defined(DBG_MULTIPLY)\n    vec3 dbg_applyShading(vec3 color) {\n        vec3 N = vNormalW.xyz;\n        vec3 L = normalize(vEyePosition.xyz - vPositionW.xyz);\n        vec3 H = normalize(L + L);\n        float LdotN = clamp(dot(L,N), 0., 1.);\n        float HdotN = clamp(dot(H,N), 0., 1.);\n        float specTerm = pow(HdotN, dbg_shadedSpecularColorPower.w);\n        color *= (LdotN / PI);\n        color += dbg_shadedSpecularColorPower.rgb * (specTerm / PI);\n        return color;\n    }\n#endif\n\n#if DBG_MODE == 1 || DBG_MODE == 3\n    float dbg_edgeFactor() {\n        vec3 d = fwidth(dbg_vBarycentric);\n        vec3 a3 = smoothstep(vec3(0.), d * dbg_thicknessRadiusScale.x, dbg_vBarycentric);\n        return min(min(a3.x, a3.y), a3.z);\n    }\n#endif\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    float dbg_cornerFactor() {\n        vec3 worldPos = vPositionW;\n        float dist = length(worldPos - dbg_vVertexWorldPos);\n        float camDist = length(worldPos - vEyePosition.xyz);\n        float d = sqrt(camDist) * .001;\n        return smoothstep((dbg_thicknessRadiusScale.y * d), ((dbg_thicknessRadiusScale.y * 1.01) * d), dist);\n    }\n#endif\n\n#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))\n    float dbg_checkerboardFactor(vec2 uv) {\n        vec2 f = fract(uv * dbg_thicknessRadiusScale.z);\n        f -= .5;\n        return (f.x * f.y) > 0. ? 1. : 0.;\n    }\n#endif\n#endif",CUSTOM_FRAGMENT_MAIN_END:"#if defined(DBG_ENABLED)\nvec3 dbg_color = vec3(1.);\n#if DBG_MODE == 1\n    dbg_color = mix(dbg_wireframeTrianglesColor, vec3(1.), dbg_edgeFactor());\n#elif DBG_MODE == 2 || DBG_MODE == 3\n    float dbg_cornerFactor = dbg_cornerFactor();\n    if (dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;\n    dbg_color = mix(dbg_vertexColor, vec3(1.), dbg_cornerFactor);\n    #if DBG_MODE == 3\n        dbg_color *= mix(dbg_wireframeVerticesColor, vec3(1.), dbg_edgeFactor());\n    #endif\n#elif DBG_MODE == 4 && defined(UV1)\n    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV1));\n#elif DBG_MODE == 5 && defined(UV2)\n    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV2));\n#elif DBG_MODE == 6 && defined(VERTEXCOLOR)\n    dbg_color = vColor.rgb;\n#elif DBG_MODE == 7\n    dbg_color = dbg_materialColor;\n#endif\n\n#if defined(DBG_MULTIPLY)\n    gl_FragColor *= vec4(dbg_color, 1.);\n#else\n    #if DBG_MODE != 6\n        gl_FragColor = vec4(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);\n    #else\n        gl_FragColor = vec4(dbg_color, 1.);\n    #endif\n#endif\n#endif"}}static Reset(){this._PluginCount=0,this.MaterialColors=Ml}static PrepareMeshForTrianglesAndVerticesMode(e,t=!1){let i=()=>{};if(0==e.getTotalIndices())return i;if(t){const t=e.getVerticesDataKinds(),s=e.getIndices(),r={};for(const i of t)r[i]=e.getVerticesData(i);i=function(){e.setIndices(s);for(const i of t){const t=e.getVertexBuffer(i).getStrideSize();e.setVerticesData(i,r[i],void 0,t)}e.removeVerticesData("dbg_initialPass")}}let s=Array.from(e.getIndices());const r=[];for(let e=0;e<s.length;e+=3)r.push(s[e+1],s[e+2],s[e+0]);e.setIndices(s.concat(r)),e.convertToUnIndexedMesh(),e.isUnIndexed=!1,s=Array.from(e.getIndices());const n=[];for(let e=s.length/2;e<s.length;e+=3)n.push(s[e+1],s[e+2],s[e+0]);e.setIndices(s.concat(n));const o=e.getTotalVertices(),a=o/2,h=new Array(o).fill(1,0,a).fill(0,a,o);return e.setVerticesData("dbg_initialPass",h,!1,1),i}}Ol._PluginCount=0,Ol.MaterialColors=Ml,(0,H.gn)([(0,j.n9)()],Ol.prototype,"_materialColor",void 0),(0,H.gn)([(0,j.qC)()],Ol.prototype,"_isEnabled",void 0),(0,H.gn)([(0,j.qC)(),(0,j.wz)("_markAllDefinesAsDirty")],Ol.prototype,"mode",void 0),(0,H.gn)([(0,j.qC)(),(0,j.wz)("_markAllDefinesAsDirty")],Ol.prototype,"multiply",void 0),(0,H.gn)([(0,j.n9)()],Ol.prototype,"shadedDiffuseColor",void 0),(0,H.gn)([(0,j.n9)()],Ol.prototype,"shadedSpecularColor",void 0),(0,H.gn)([(0,j.qC)()],Ol.prototype,"shadedSpecularPower",void 0),(0,H.gn)([(0,j.qC)()],Ol.prototype,"wireframeThickness",void 0),(0,H.gn)([(0,j.n9)()],Ol.prototype,"wireframeTrianglesColor",void 0),(0,H.gn)([(0,j.n9)()],Ol.prototype,"wireframeVerticesColor",void 0),(0,H.gn)([(0,j.n9)()],Ol.prototype,"vertexColor",void 0),(0,H.gn)([(0,j.qC)()],Ol.prototype,"vertexRadius",void 0),(0,H.gn)([(0,j.qC)()],Ol.prototype,"uvScale",void 0),(0,H.gn)([(0,j.n9)()],Ol.prototype,"uvPrimaryColor",void 0),(0,H.gn)([(0,j.n9)()],Ol.prototype,"uvSecondaryColor",void 0),(0,c.H)("BABYLON.MeshDebugPluginMaterial",Ol),i(34848);var wl=i(56229);class Dl{constructor(e,t){this.radius=e,this.theta=t}getClassName(){return"Polar"}toString(){return JSON.stringify(this)}asArray(){return[this.radius,this.theta]}addToRef(e,t){return t.radius=this.radius+e.radius,t.theta=this.theta+e.theta,t}add(e){const t=new Dl(0,0);return this.addToRef(e,t),t}addInPlace(e){return this.addToRef(e,this),this}addInPlaceFromFloats(e,t){return this.radius+=e,this.theta+=t,this}subtractToRef(e,t){return t.radius=this.radius-e.radius,t.theta=this.theta-e.theta,t}subtract(e){const t=new Dl(0,0);return this.subtractToRef(e,t),t}subtractInPlace(e){return this.subtractToRef(e,this),this}subtractFromFloatsToRef(e,t,i){return i.radius=this.radius-e,i.theta=this.theta-t,i}subtractFromFloats(e,t){const i=new Dl(0,0);return this.subtractFromFloatsToRef(e,t,i),i}multiplyToRef(e,t){return t.radius=this.radius*e.radius,t.theta=this.theta*e.theta,t}multiply(e){const t=new Dl(0,0);return this.multiplyToRef(e,t),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}divideToRef(e,t){return t.radius=this.radius/e.radius,t.theta=this.theta/e.theta,t}divide(e){const t=new Dl(0,0);return this.divideToRef(e,t),t}divideInPlace(e){return this.divideToRef(e,this),this}clone(){return new Dl(this.radius,this.theta)}copyFrom(e){return this.radius=e.radius,this.theta=e.theta,this}copyFromFloats(e,t){return this.radius=e,this.theta=t,this}scaleToRef(e,t){return t.radius=this.radius*e,t.theta=this.theta*e,t}scale(e){const t=new Dl(0,0);return this.scaleToRef(e,t),t}scaleInPlace(e){return this.scaleToRef(e,this),this}set(e,t){return this.radius=e,this.theta=t,this}setAll(e){return this.set(e,e),this}toVector2ToRef(e){const t=this.radius*Math.cos(this.theta),i=this.radius*Math.sin(this.theta);return e.set(t,i),e}toVector2(){const e=new m.FM(0,0);return this.toVector2ToRef(e)}static FromVector2ToRef(e,t){const i=Math.sign(e.y)*Math.acos(e.x/e.length());return t.radius=e.length(),t.theta=i,t}static FromVector2(e){const t=new Dl(0,0);return Dl.FromVector2ToRef(e,t),t}static FromArray(e){return new Dl(e[0],e[1])}}class Bl{constructor(e,t,i){this.radius=e,this.theta=t,this.phi=i}getClassName(){return"Spherical"}toString(){return JSON.stringify(this)}asArray(){return[this.radius,this.theta,this.phi]}addToRef(e,t){return t.radius=this.radius+e.radius,t.theta=this.theta+e.theta,t.phi=this.phi+e.phi,t}add(e){const t=new Bl(0,0,0);return this.addToRef(e,t),t}addInPlace(e){return this.addToRef(e,this),this}addInPlaceFromFloats(e,t,i){return this.radius+=e,this.theta+=t,this.phi+=i,this}subtractToRef(e,t){return t.radius=this.radius-e.radius,t.theta=this.theta-e.theta,t.phi=this.phi-e.phi,t}subtract(e){const t=new Bl(0,0,0);return this.subtractToRef(e,t),t}subtractInPlace(e){return this.subtractToRef(e,this),this}subtractFromFloatsToRef(e,t,i,s){return s.radius=this.radius-e,s.theta=this.theta-t,s.phi=this.phi-i,s}subtractFromFloats(e,t,i){const s=new Bl(0,0,0);return this.subtractFromFloatsToRef(e,t,i,s),s}multiplyToRef(e,t){return t.radius=this.radius*e.radius,t.theta=this.theta*e.theta,t.phi=this.phi*e.phi,t}multiply(e){const t=new Bl(0,0,0);return this.multiplyToRef(e,t),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}divideToRef(e,t){return t.radius=this.radius/e.radius,t.theta=this.theta/e.theta,t.phi=this.phi/e.phi,t}divide(e){const t=new Bl(0,0,0);return this.divideToRef(e,t),t}divideInPlace(e){return this.divideToRef(e,this),this}clone(){return new Bl(this.radius,this.theta,this.phi)}copyFrom(e){return this.radius=e.radius,this.theta=e.theta,this.phi=e.phi,this}copyFromFloats(e,t,i){return this.radius=e,this.theta=t,this.phi=i,this}scaleToRef(e,t){return t.radius=this.radius*e,t.theta=this.theta*e,t.phi=this.phi*e,t}scale(e){const t=new Bl(0,0,0);return this.scaleToRef(e,t),t}scaleInPlace(e){return this.scaleToRef(e,this),this}set(e,t,i){return this.radius=e,this.theta=t,this.phi=i,this}setAll(e){return this.set(e,e,e),this}toVector3ToRef(e){const t=this.radius*Math.sin(this.theta)*Math.cos(this.phi),i=this.radius*Math.cos(this.theta),s=this.radius*Math.sin(this.theta)*Math.sin(this.phi);return e.set(t,i,s),e}toVector3(){const e=new m.P(0,0,0);return this.toVector3ToRef(e)}static FromVector3ToRef(e,t){return t.radius=e.length(),t.theta=Math.acos(e.y/t.radius),t.phi=Math.atan2(e.z,e.x),t}static FromVector3(e){const t=new Bl(0,0,0);return Bl.FromVector3ToRef(e,t),t}static FromArray(e){return new Bl(e[0],e[1],e[2])}}i(15979);var Nl=i(97181),Fl=i(23908),Ll=i(48777);let Vl=0;class kl{constructor(e,t,i,s){this.pos=e,this.normal=t,this.uv=i,this.vertColor=s}clone(){var e,t;return new kl(this.pos.clone(),this.normal.clone(),null===(e=this.uv)||void 0===e?void 0:e.clone(),null===(t=this.vertColor)||void 0===t?void 0:t.clone())}flip(){this.normal=this.normal.scale(-1)}interpolate(e,t){return new kl(m.P.Lerp(this.pos,e.pos,t),m.P.Lerp(this.normal,e.normal,t),this.uv&&e.uv?m.FM.Lerp(this.uv,e.uv,t):void 0,this.vertColor&&e.vertColor?g.HE.Lerp(this.vertColor,e.vertColor,t):void 0)}}class zl{constructor(e,t){this.normal=e,this.w=t}static FromPoints(e,t,i){const s=i.subtract(e),r=t.subtract(e);if(0===s.lengthSquared()||0===r.lengthSquared())return null;const n=m.P.Normalize(m.P.Cross(s,r));return new zl(n,m.P.Dot(n,e))}clone(){return new zl(this.normal.clone(),this.w)}flip(){this.normal.scaleInPlace(-1),this.w=-this.w}splitPolygon(e,t,i,s,r){let n=0;const o=[];let a,h;for(a=0;a<e.vertices.length;a++){h=m.P.Dot(this.normal,e.vertices[a].pos)-this.w;const t=h<-zl.EPSILON?2:h>zl.EPSILON?1:0;n|=t,o.push(t)}switch(n){case 0:(m.P.Dot(this.normal,e.plane.normal)>0?t:i).push(e);break;case 1:s.push(e);break;case 2:r.push(e);break;case 3:{const t=[],i=[];for(a=0;a<e.vertices.length;a++){const s=(a+1)%e.vertices.length,r=o[a],n=o[s],l=e.vertices[a],c=e.vertices[s];if(2!==r&&t.push(l),1!==r&&i.push(2!==r?l.clone():l),3==(r|n)){h=(this.w-m.P.Dot(this.normal,l.pos))/m.P.Dot(this.normal,c.pos.subtract(l.pos));const e=l.interpolate(c,h);t.push(e),i.push(e.clone())}}let n;t.length>=3&&(n=new Gl(t,e.shared),n.plane&&s.push(n)),i.length>=3&&(n=new Gl(i,e.shared),n.plane&&r.push(n));break}}}}zl.EPSILON=1e-5;class Gl{constructor(e,t){this.vertices=e,this.shared=t,this.plane=zl.FromPoints(e[0].pos,e[1].pos,e[2].pos)}clone(){const e=this.vertices.map((e=>e.clone()));return new Gl(e,this.shared)}flip(){this.vertices.reverse().map((e=>{e.flip()})),this.plane.flip()}}class Ul{constructor(e){this._plane=null,this._front=null,this._back=null,this._polygons=new Array,e&&this.build(e)}clone(){const e=new Ul;return e._plane=this._plane&&this._plane.clone(),e._front=this._front&&this._front.clone(),e._back=this._back&&this._back.clone(),e._polygons=this._polygons.map((e=>e.clone())),e}invert(){for(let e=0;e<this._polygons.length;e++)this._polygons[e].flip();this._plane&&this._plane.flip(),this._front&&this._front.invert(),this._back&&this._back.invert();const e=this._front;this._front=this._back,this._back=e}clipPolygons(e){if(!this._plane)return e.slice();let t=new Array,i=new Array;for(let s=0;s<e.length;s++)this._plane.splitPolygon(e[s],t,i,t,i);return this._front&&(t=this._front.clipPolygons(t)),i=this._back?this._back.clipPolygons(i):[],t.concat(i)}clipTo(e){this._polygons=e.clipPolygons(this._polygons),this._front&&this._front.clipTo(e),this._back&&this._back.clipTo(e)}allPolygons(){let e=this._polygons.slice();return this._front&&(e=e.concat(this._front.allPolygons())),this._back&&(e=e.concat(this._back.allPolygons())),e}build(e){if(!e.length)return;this._plane||(this._plane=e[0].plane.clone());const t=new Array,i=new Array;for(let s=0;s<e.length;s++)this._plane.splitPolygon(e[s],this._polygons,this._polygons,t,i);t.length&&(this._front||(this._front=new Ul),this._front.build(t)),i.length&&(this._back||(this._back=new Ul),this._back.build(i))}}class Wl{constructor(){this._polygons=new Array}static FromMesh(e,t=!1){let i,s,r,n,o,a,h;const l=new Array;let c,u,d,p,_=null,f=!1;if(!(e instanceof Mt.Kj))throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";e.computeWorldMatrix(!0),c=e.getWorldMatrix(),u=e.position.clone(),d=e.rotation.clone(),e.rotationQuaternion&&(_=e.rotationQuaternion.clone()),p=e.scaling.clone(),e.material&&t&&(f=0===e.material.sideOrientation);const b=e.getIndices(),v=e.getVerticesData(me.o.PositionKind),y=e.getVerticesData(me.o.NormalKind),x=e.getVerticesData(me.o.UVKind),P=e.getVerticesData(me.o.ColorKind),C=e.subMeshes;for(let e=0,t=C.length;e<t;e++)for(let t=C[e].indexStart,u=C[e].indexCount+C[e].indexStart;t<u;t+=3){h=[];for(let e=0;e<3;e++){const a=0===e?t+e:f?t+3-e:t+e,l=new m.P(y[3*b[a]],y[3*b[a]+1],y[3*b[a]+2]);x&&(r=new m.FM(x[2*b[a]],x[2*b[a]+1])),P&&(o=new g.HE(P[4*b[a]],P[4*b[a]+1],P[4*b[a]+2],P[4*b[a]+3]));const u=new m.P(v[3*b[a]],v[3*b[a]+1],v[3*b[a]+2]);n=m.P.TransformCoordinates(u,c),s=m.P.TransformNormal(l,c),i=new kl(n,s,r,o),h.push(i)}a=new Gl(h,{subMeshId:e,meshId:Vl,materialIndex:C[e].materialIndex}),a.plane&&l.push(a)}const T=Wl._FromPolygons(l);return T.matrix=t?m.y3.Identity():c,T.position=t?m.P.Zero():u,T.rotation=t?m.P.Zero():d,T.scaling=t?m.P.One():p,T.rotationQuaternion=t&&_?m._f.Identity():_,Vl++,T}static _FromPolygons(e){const t=new Wl;return t._polygons=e,t}clone(){const e=new Wl;return e._polygons=this._polygons.map((e=>e.clone())),e.copyTransformAttributes(this),e}union(e){const t=new Ul(this.clone()._polygons),i=new Ul(e.clone()._polygons);return t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),Wl._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}unionInPlace(e){const t=new Ul(this._polygons),i=new Ul(e._polygons);t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),this._polygons=t.allPolygons()}subtract(e){const t=new Ul(this.clone()._polygons),i=new Ul(e.clone()._polygons);return t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),Wl._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}subtractInPlace(e){const t=new Ul(this._polygons),i=new Ul(e._polygons);t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}intersect(e){const t=new Ul(this.clone()._polygons),i=new Ul(e.clone()._polygons);return t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),Wl._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}intersectInPlace(e){const t=new Ul(this._polygons),i=new Ul(e._polygons);t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}inverse(){const e=this.clone();return e.inverseInPlace(),e}inverseInPlace(){this._polygons.map((e=>{e.flip()}))}copyTransformAttributes(e){return this.matrix=e.matrix,this.position=e.position,this.rotation=e.rotation,this.scaling=e.scaling,this.rotationQuaternion=e.rotationQuaternion,this}buildMeshGeometry(e,t,i){const s=this.matrix.clone();s.invert();const r=new Mt.Kj(e,t),n=[],o=[],a=[];let h=null,l=null;const c=m.P.Zero(),u=m.P.Zero(),d=m.FM.Zero(),p=new g.HE(0,0,0,0),_=this._polygons,f=[0,0,0];let b;const v={};let y,x=0;const P={};let C;i&&_.sort(((e,t)=>e.shared.meshId===t.shared.meshId?e.shared.subMeshId-t.shared.subMeshId:e.shared.meshId-t.shared.meshId));for(let e=0,t=_.length;e<t;e++){b=_[e],P[b.shared.meshId]||(P[b.shared.meshId]={}),P[b.shared.meshId][b.shared.subMeshId]||(P[b.shared.meshId][b.shared.subMeshId]={indexStart:1/0,indexEnd:-1/0,materialIndex:b.shared.materialIndex}),C=P[b.shared.meshId][b.shared.subMeshId];for(let e=2,t=b.vertices.length;e<t;e++){f[0]=0,f[1]=e-1,f[2]=e;for(let e=0;e<3;e++){c.copyFrom(b.vertices[f[e]].pos),u.copyFrom(b.vertices[f[e]].normal),b.vertices[f[e]].uv&&(h||(h=[]),d.copyFrom(b.vertices[f[e]].uv)),b.vertices[f[e]].vertColor&&(l||(l=[]),p.copyFrom(b.vertices[f[e]].vertColor));const t=m.P.TransformCoordinates(c,s),i=m.P.TransformNormal(u,s);y=v[t.x+","+t.y+","+t.z];let r=!1;h&&h[2*y]!==d.x&&h[2*y+1]!==d.y&&(r=!0);let _=!1;l&&l[4*y]!==p.r&&l[4*y+1]!==p.g&&l[4*y+2]!==p.b&&l[4*y+3]!==p.a&&(_=!0),(void 0===y||a[3*y]!==i.x||a[3*y+1]!==i.y||a[3*y+2]!==i.z||r||_)&&(n.push(t.x,t.y,t.z),h&&h.push(d.x,d.y),a.push(u.x,u.y,u.z),l&&l.push(p.r,p.g,p.b,p.a),y=v[t.x+","+t.y+","+t.z]=n.length/3-1),o.push(y),C.indexStart=Math.min(x,C.indexStart),C.indexEnd=Math.max(x,C.indexEnd),x++}}}if(r.setVerticesData(me.o.PositionKind,n),r.setVerticesData(me.o.NormalKind,a),h&&r.setVerticesData(me.o.UVKind,h),l&&r.setVerticesData(me.o.ColorKind,l),r.setIndices(o,null),i){let e,t=0;r.subMeshes=new Array;for(const i in P){e=-1;for(const s in P[i])C=P[i][s],Ll.P.CreateFromIndices(C.materialIndex+t,C.indexStart,C.indexEnd-C.indexStart+1,r),e=Math.max(C.materialIndex,e);t+=++e}}return r}toMesh(e,t=null,i,s){const r=this.buildMeshGeometry(e,i,s);return r.material=t,r.position.copyFrom(this.position),r.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(r.rotationQuaternion=this.rotationQuaternion.clone()),r.scaling.copyFrom(this.scaling),r.computeWorldMatrix(!0),r}}i(1467),i(58064);class Hl{static _GetShader(e){if(!e._meshUVSpaceRendererShader){const t=new xi.j("meshUVSpaceRendererShader",e,{vertex:"meshUVSpaceRenderer",fragment:"meshUVSpaceRenderer"},{attributes:["position","normal","uv"],uniforms:["world","projMatrix"],samplers:["textureSampler"],needAlphaBlending:!0});t.backFaceCulling=!1,t.alphaMode=2,e.onDisposeObservable.add((()=>{var t;null===(t=e._meshUVSpaceRendererShader)||void 0===t||t.dispose(),e._meshUVSpaceRendererShader=null})),e._meshUVSpaceRendererShader=t}return e._meshUVSpaceRendererShader}static _IsRenderTargetTexture(e){return void 0!==e.renderList}constructor(e,t,i){this._textureCreatedInternally=!1,this.clearColor=new g.HE(0,0,0,0),this._mesh=e,this._scene=t,this._options=Object.assign({width:1024,height:1024,textureType:0,generateMipMaps:!0,optimizeUVAllocation:!0},i)}isReady(){return this.texture||this._createDiffuseRTT(),Hl._IsRenderTargetTexture(this.texture)?this.texture.isReadyForRendering():this.texture.isReady()}renderTexture(e,t,i,s,r=0){if(this.texture||this._createDiffuseRTT(),Hl._IsRenderTargetTexture(this.texture)){const n=this._createProjectionMatrix(t,i,s,r),o=Hl._GetShader(this._scene);o.setTexture("textureSampler",e),o.setMatrix("projMatrix",n),this.texture.render()}}clear(){if(Hl._IsRenderTargetTexture(this.texture)&&this.texture.renderTarget){const e=this._scene.getEngine();e.bindFramebuffer(this.texture.renderTarget),e.clear(this.clearColor,!0,!0,!0),e.unBindFramebuffer(this.texture.renderTarget)}}dispose(){this._textureCreatedInternally&&(this.texture.dispose(),this._textureCreatedInternally=!1)}_createDiffuseRTT(){this._textureCreatedInternally=!0;const e=this._createRenderTargetTexture(this._options.width,this._options.height);e.setMaterialForRendering(this._mesh,Hl._GetShader(this._scene)),this.texture=e}_createRenderTargetTexture(e,t){const i=new Ur._(this._mesh.name+"_uvspaceTexture",{width:e,height:t},this._scene,this._options.generateMipMaps,!0,this._options.textureType,!1,this._options.generateMipMaps?3:2,!1,!1,!1,5);return i.renderParticles=!1,i.optimizeUVAllocation=!!this._options.optimizeUVAllocation,i.onClearObservable.addOnce((()=>{this._scene.getEngine().clear(this.clearColor,!0,!0,!0),i.onClearObservable.add((()=>{}))})),i.renderList=[this._mesh],i}_createProjectionMatrix(e,t,i,s=0){const r=-Math.atan2(t.z,t.x)-Math.PI/2,n=Math.sqrt(t.x*t.x+t.z*t.z),o=Math.atan2(t.y,n),a=e.add(t.scale(.5*i.z)),h=m.y3.RotationYawPitchRoll(r,o,s).multiply(m.y3.Translation(a.x,a.y,a.z)),l=m.y3.Invert(h),c=m.y3.FromArray([2/i.x,0,0,0,0,2/i.y,0,0,0,0,1/i.z,0,0,0,0,1]),u=m.y3.FromArray([.5,0,0,0,0,.5,0,0,0,0,1,0,.5,.5,0,1]);return l.multiply(c).multiply(u)}}var jl=i(36994),$l=i(19044);Mt.Kj._TrailMeshParser=(e,t)=>Yl.Parse(e,t);class Yl extends Mt.Kj{constructor(e,t,i,s=1,r=60,n=!0){super(e,i),this._sectionPolygonPointsCount=4,this._running=!1,this._autoStart=n,this._generator=t,this.diameter=s,this._length=r,this._sectionVectors=[],this._sectionNormalVectors=[];for(let e=0;e<this._sectionPolygonPointsCount;e++)this._sectionVectors[e]=m.P.Zero(),this._sectionNormalVectors[e]=m.P.Zero();this._createMesh()}getClassName(){return"TrailMesh"}_createMesh(){const e=new gi.x,t=[],i=[],s=[];let r=m.P.Zero();r=this._generator instanceof si.x&&this._generator.hasBoundingInfo?this._generator.getBoundingInfo().boundingBox.centerWorld:this._generator.position;const n=2*Math.PI/this._sectionPolygonPointsCount;for(let e=0;e<this._sectionPolygonPointsCount;e++)t.push(r.x+Math.cos(e*n)*this.diameter,r.y+Math.sin(e*n)*this.diameter,r.z);for(let e=1;e<=this._length;e++){for(let e=0;e<this._sectionPolygonPointsCount;e++)t.push(r.x+Math.cos(e*n)*this.diameter,r.y+Math.sin(e*n)*this.diameter,r.z);const e=t.length/3-2*this._sectionPolygonPointsCount;for(let t=0;t<this._sectionPolygonPointsCount-1;t++)s.push(e+t,e+t+this._sectionPolygonPointsCount,e+t+this._sectionPolygonPointsCount+1),s.push(e+t,e+t+this._sectionPolygonPointsCount+1,e+t+1);s.push(e+this._sectionPolygonPointsCount-1,e+this._sectionPolygonPointsCount-1+this._sectionPolygonPointsCount,e+this._sectionPolygonPointsCount),s.push(e+this._sectionPolygonPointsCount-1,e+this._sectionPolygonPointsCount,e)}gi.x.ComputeNormals(t,s,i),e.positions=t,e.normals=i,e.indices=s,e.applyToMesh(this,!0),this._autoStart&&this.start()}start(){this._running||(this._running=!0,this._beforeRenderObserver=this.getScene().onBeforeRenderObservable.add((()=>{this.update()})))}stop(){this._beforeRenderObserver&&this._running&&(this._running=!1,this.getScene().onBeforeRenderObservable.remove(this._beforeRenderObserver))}update(){const e=this.getVerticesData(me.o.PositionKind),t=this.getVerticesData(me.o.NormalKind),i=this._generator.getWorldMatrix();if(e&&t){for(let i=3*this._sectionPolygonPointsCount;i<e.length;i++)e[i-3*this._sectionPolygonPointsCount]=e[i]-t[i]/this._length*this.diameter;for(let e=3*this._sectionPolygonPointsCount;e<t.length;e++)t[e-3*this._sectionPolygonPointsCount]=t[e];const s=e.length-3*this._sectionPolygonPointsCount,r=2*Math.PI/this._sectionPolygonPointsCount;for(let e=0;e<this._sectionPolygonPointsCount;e++)this._sectionVectors[e].copyFromFloats(Math.cos(e*r)*this.diameter,Math.sin(e*r)*this.diameter,0),this._sectionNormalVectors[e].copyFromFloats(Math.cos(e*r),Math.sin(e*r),0),m.P.TransformCoordinatesToRef(this._sectionVectors[e],i,this._sectionVectors[e]),m.P.TransformNormalToRef(this._sectionNormalVectors[e],i,this._sectionNormalVectors[e]);for(let i=0;i<this._sectionPolygonPointsCount;i++)e[s+3*i]=this._sectionVectors[i].x,e[s+3*i+1]=this._sectionVectors[i].y,e[s+3*i+2]=this._sectionVectors[i].z,t[s+3*i]=this._sectionNormalVectors[i].x,t[s+3*i+1]=this._sectionNormalVectors[i].y,t[s+3*i+2]=this._sectionNormalVectors[i].z;this.updateVerticesData(me.o.PositionKind,e,!0,!1),this.updateVerticesData(me.o.NormalKind,t,!0,!1)}}clone(e="",t){return new Yl(e,void 0===t?this._generator:t,this.getScene(),this.diameter,this._length,this._autoStart)}serialize(e){super.serialize(e),e.generatorId=this._generator.id}static Parse(e,t){var i,s;const r=null!==(i=t.getLastMeshById(e.generatorId))&&void 0!==i?i:t.getLastTransformNodeById(e.generatorId);if(!r)throw new Error("TrailMesh: generator not found with ID "+e.generatorId);return new Yl(e.name,r,t,null!==(s=e.diameter)&&void 0!==s?s:e._diameter,e._length,e._autoStart)}}var Xl,Ql=i(56906),ql=i(22078);class Kl{constructor(e,t,i){this.quality=e,this.distance=t,this.optimizeMesh=i}}class Zl{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){const e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)e.settings.forEach((t=>{this._getSimplifier(e).simplify(t,(i=>{void 0!==t.distance&&e.mesh.addLODLevel(t.distance,i),i.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()}))}));else{const t=this._getSimplifier(e),i=(i,s)=>{t.simplify(i,(t=>{void 0!==i.distance&&e.mesh.addLODLevel(i.distance,t),t.isVisible=!0,s()}))};w.$g.Run(e.settings.length,(t=>{i(e.settings[t.index],(()=>{t.executeNext()}))}),(()=>{e.successCallback&&e.successCallback(),this.executeNext()}))}}_getSimplifier(e){return e.simplificationType,Xl.QUADRATIC,new sc(e.mesh)}}!function(e){e[e.QUADRATIC=0]="QUADRATIC"}(Xl||(Xl={}));class Jl{constructor(e){this._vertices=e,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class ec{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new tc,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}}class tc{constructor(e){this.data=new Array(10);for(let t=0;t<10;++t)e&&e[t]?this.data[t]=e[t]:this.data[t]=0}det(e,t,i,s,r,n,o,a,h){return this.data[e]*this.data[r]*this.data[h]+this.data[i]*this.data[s]*this.data[a]+this.data[t]*this.data[n]*this.data[o]-this.data[i]*this.data[r]*this.data[o]-this.data[e]*this.data[n]*this.data[a]-this.data[t]*this.data[s]*this.data[h]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){const t=new tc;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,s){return new tc(tc.DataFromNumbers(e,t,i,s))}static DataFromNumbers(e,t,i,s){return[e*e,e*t,e*i,e*s,t*t,t*i,t*s,i*i,i*s,s*s]}}class ic{constructor(e,t){this.vertexId=e,this.triangleId=t}}class sc{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=Ns.kn}simplify(e,t){this._initDecimatedMesh(),w.$g.Run(this._mesh.subMeshes.length,(t=>{this._initWithMesh(t.index,(()=>{this._runDecimation(e,t.index,(()=>{t.executeNext()}))}),e.optimizeMesh)}),(()=>{setTimeout((()=>{t(this._reconstructedMesh)}),0)}))}_runDecimation(e,t,i){const s=~~(this._triangles.length*e.quality);let r=0;const n=this._triangles.length,o=(e,t)=>{setTimeout((()=>{e%5==0&&this._updateMesh(0===e);for(let e=0;e<this._triangles.length;++e)this._triangles[e].isDirty=!1;const i=1e-9*Math.pow(e+3,this.aggressiveness);w.$g.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=~~((this._triangles.length/2+e)%this._triangles.length),s=this._triangles[t];if(s&&!(s.error[3]>i||s.deleted||s.isDirty))for(let e=0;e<3;++e)if(s.error[e]<i){const t=[],i=[],n=s._vertices[e],o=s._vertices[(e+1)%3];if(n.isBorder||o.isBorder)continue;const a=m.P.Zero();this._calculateError(n,o,a);const h=new Array;if(this._isFlipped(n,o,a,t,h))continue;if(this._isFlipped(o,n,a,i,h))continue;if(t.indexOf(!0)<0||i.indexOf(!0)<0)continue;const l=new Array;if(h.forEach((e=>{-1===l.indexOf(e)&&(e.deletePending=!0,l.push(e))})),l.length%2!=0)continue;n.q=o.q.add(n.q),n.updatePosition(a);const c=this._references.length;r=this._updateTriangles(n,n,t,r),r=this._updateTriangles(n,o,i,r);const u=this._references.length-c;if(u<=n.triangleCount){if(u)for(let e=0;e<u;e++)this._references[n.triangleStart+e]=this._references[c+e]}else n.triangleStart=c;n.triangleCount=u;break}}),t,(()=>n-r<=s))}),0)};w.$g.Run(this.decimationIterations,(e=>{n-r<=s?e.breakLoop():o(e.index,(()=>{e.executeNext()}))}),(()=>{setTimeout((()=>{this._reconstructMesh(t),i()}),0)}))}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];const s=this._mesh.getVerticesData(me.o.PositionKind),r=this._mesh.getIndices(),n=this._mesh.subMeshes[e],o=e=>{if(i)for(let t=0;t<this._vertices.length;++t)if(this._vertices[t].position.equalsWithEpsilon(e,1e-4))return this._vertices[t];return null},a=[],h=n.verticesCount;w.$g.SyncAsyncForLoop(h,this.syncIterations/4>>0,(e=>{if(!s)return;const t=e+n.verticesStart,i=m.P.FromArray(s,3*t),r=o(i)||new ec(i,this._vertices.length);r.originalOffsets.push(t),r.id===this._vertices.length&&this._vertices.push(r),a.push(r.id)}),(()=>{w.$g.SyncAsyncForLoop(n.indexCount/3,this.syncIterations,(e=>{if(!r)return;const t=3*(n.indexStart/3+e),i=r[t+0],s=r[t+1],o=r[t+2],h=this._vertices[a[i-n.verticesStart]],l=this._vertices[a[s-n.verticesStart]],c=this._vertices[a[o-n.verticesStart]],u=new Jl([h,l,c]);u.originalOffset=t,this._triangles.push(u)}),(()=>{this._init(t)}))}))}_init(e){w.$g.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=this._triangles[e];t.normal=m.P.Cross(t._vertices[1].position.subtract(t._vertices[0].position),t._vertices[2].position.subtract(t._vertices[0].position)).normalize();for(let e=0;e<3;e++)t._vertices[e].q.addArrayInPlace(tc.DataFromNumbers(t.normal.x,t.normal.y,t.normal.z,-m.P.Dot(t.normal,t._vertices[0].position)))}),(()=>{w.$g.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=this._triangles[e];for(let e=0;e<3;++e)t.error[e]=this._calculateError(t._vertices[e],t._vertices[(e+1)%3]);t.error[3]=Math.min(t.error[0],t.error[1],t.error[2])}),(()=>{e()}))}))}_reconstructMesh(e){const t=[];let i,s,r;for(i=0;i<this._vertices.length;++i)this._vertices[i].triangleCount=0;for(i=0;i<this._triangles.length;++i)if(!this._triangles[i].deleted){for(s=this._triangles[i],r=0;r<3;++r)s._vertices[r].triangleCount=1;t.push(s)}const n=this._reconstructedMesh.getVerticesData(me.o.PositionKind)||[],o=this._reconstructedMesh.getVerticesData(me.o.NormalKind)||[],a=this._reconstructedMesh.getVerticesData(me.o.UVKind)||[],h=this._reconstructedMesh.getVerticesData(me.o.ColorKind)||[],l=this._mesh.getVerticesData(me.o.NormalKind),c=this._mesh.getVerticesData(me.o.UVKind),u=this._mesh.getVerticesData(me.o.ColorKind);let d=0;for(i=0;i<this._vertices.length;++i){const e=this._vertices[i];e.id=d,e.triangleCount&&e.originalOffsets.forEach((t=>{n.push(e.position.x),n.push(e.position.y),n.push(e.position.z),l&&l.length&&(o.push(l[3*t]),o.push(l[3*t+1]),o.push(l[3*t+2])),c&&c.length&&(a.push(c[2*t]),a.push(c[2*t+1])),u&&u.length&&(h.push(u[4*t]),h.push(u[4*t+1]),h.push(u[4*t+2]),h.push(u[4*t+3])),++d}))}const p=this._reconstructedMesh.getTotalIndices(),_=this._reconstructedMesh.getTotalVertices(),g=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];const m=this._reconstructedMesh.getIndices(),f=this._mesh.getIndices();for(i=0;i<t.length;++i)s=t[i],[0,1,2].forEach((e=>{const t=f[s.originalOffset+e];let i=s._vertices[e].originalOffsets.indexOf(t);i<0&&(i=0),m.push(s._vertices[e].id+i+_)}));this._reconstructedMesh.setIndices(m),this._reconstructedMesh.setVerticesData(me.o.PositionKind,n),o.length>0&&this._reconstructedMesh.setVerticesData(me.o.NormalKind,o),a.length>0&&this._reconstructedMesh.setVerticesData(me.o.UVKind,a),h.length>0&&this._reconstructedMesh.setVerticesData(me.o.ColorKind,h);const b=this._mesh.subMeshes[e];e>0&&(this._reconstructedMesh.subMeshes=[],g.forEach((e=>{Ll.P.AddToMesh(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,e.getMesh())})),Ll.P.AddToMesh(b.materialIndex,_,d,p,3*t.length,this._reconstructedMesh))}_initDecimatedMesh(){this._reconstructedMesh=new Mt.Kj(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,s,r){for(let n=0;n<e.triangleCount;++n){const o=this._triangles[this._references[e.triangleStart+n].triangleId];if(o.deleted)continue;const a=this._references[e.triangleStart+n].vertexId,h=o._vertices[(a+1)%3],l=o._vertices[(a+2)%3];if(h===t||l===t){s[n]=!0,r.push(o);continue}let c=h.position.subtract(i);c=c.normalize();let u=l.position.subtract(i);if(u=u.normalize(),Math.abs(m.P.Dot(c,u))>.999)return!0;const d=m.P.Cross(c,u).normalize();if(s[n]=!1,m.P.Dot(d,o.normal)<.2)return!0}return!1}_updateTriangles(e,t,i,s){let r=s;for(let s=0;s<t.triangleCount;++s){const n=this._references[t.triangleStart+s],o=this._triangles[n.triangleId];o.deleted||(i[s]&&o.deletePending?(o.deleted=!0,r++):(o._vertices[n.vertexId]=e,o.isDirty=!0,o.error[0]=this._calculateError(o._vertices[0],o._vertices[1])+o.borderFactor/2,o.error[1]=this._calculateError(o._vertices[1],o._vertices[2])+o.borderFactor/2,o.error[2]=this._calculateError(o._vertices[2],o._vertices[0])+o.borderFactor/2,o.error[3]=Math.min(o.error[0],o.error[1],o.error[2]),this._references.push(n)))}return r}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){const t=[],i=[],s=this._vertices[e];let r;for(r=0;r<s.triangleCount;++r){const e=this._triangles[this._references[s.triangleStart+r].triangleId];for(let s=0;s<3;s++){let r=0;const n=e._vertices[s];for(;r<t.length&&i[r]!==n.id;)++r;r===t.length?(t.push(1),i.push(n.id)):t[r]++}}for(r=0;r<t.length;++r)1===t[r]?this._vertices[i[r]].isBorder=!0:this._vertices[i[r]].isBorder=!1}}_updateMesh(e=!1){let t,i,s,r;if(!e){const e=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||e.push(this._triangles[t]);this._triangles=e}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],s=0;s<3;++s)r=i._vertices[s],r.triangleCount++;let n=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=n,n+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;const o=new Array(3*this._triangles.length);for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],s=0;s<3;++s)r=i._vertices[s],o[r.triangleStart+r.triangleCount]=new ic(s,t),r.triangleCount++;this._references=o,e&&this._identifyBorder()}_vertexError(e,t){const i=t.x,s=t.y,r=t.z;return e.data[0]*i*i+2*e.data[1]*i*s+2*e.data[2]*i*r+2*e.data[3]*i+e.data[4]*s*s+2*e.data[5]*s*r+2*e.data[6]*s+e.data[7]*r*r+2*e.data[8]*r+e.data[9]}_calculateError(e,t,i){const s=e.q.add(t.q),r=e.isBorder&&t.isBorder;let n=0;const o=s.det(0,1,2,1,4,5,2,5,7);if(0===o||r){const r=e.position.add(t.position).divide(new m.P(2,2,2)),o=this._vertexError(s,e.position),a=this._vertexError(s,t.position),h=this._vertexError(s,r);n=Math.min(o,a,h),n===o?i&&i.copyFrom(e.position):n===a?i&&i.copyFrom(t.position):i&&i.copyFrom(r)}else i||(i=m.P.Zero()),i.x=-1/o*s.det(1,2,3,4,5,6,5,7,8),i.y=1/o*s.det(0,2,3,1,5,6,2,7,8),i.z=-1/o*s.det(0,1,3,1,4,6,2,5,8),n=this._vertexError(s,i);return n}}Object.defineProperty(z.x.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new Zl;let e=this._getComponent(k.l.NAME_SIMPLIFICATIONQUEUE);e||(e=new rc(this),this._addComponent(e))}return this._simplificationQueue},set:function(e){this._simplificationQueue=e},enumerable:!0,configurable:!0}),Mt.Kj.prototype.simplify=function(e,t=!0,i=Xl.QUADRATIC,s){return this.getScene().simplificationQueue.addTask({settings:e,parallelProcessing:t,mesh:this,simplificationType:i,successCallback:s}),this};class rc{constructor(e){this.name=k.l.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(k.l.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}}var nc,oc,ac=i(50540),hc=i(81755),lc=i(68623),cc=i(86435),uc=i(27079),dc=i(19945),pc=i(57700),_c=i(56755),gc=i(91694),mc=i(66540),fc=i(69609),bc=i(93546),vc=i(21724),yc=i(66377),xc=i(80133),Pc=i(59849),Cc=i(47370);Mt.Kj._GreasedLineMeshParser=(e,t)=>Tc.Parse(e,t);class Tc extends Mt.Kj{constructor(e,t,i){var s,r,n,o;super(e,t,null,null,!1,!1),this.name=e,this._options=i,this._lazy=!1,this._updatable=!1,this.intersectionThreshold=.1,this._lazy=null!==(s=i.lazy)&&void 0!==s&&s,this._updatable=null!==(r=i.updatable)&&void 0!==r&&r,this._vertexPositions=[],this._indices=[],this._uvs=[],this._points=[],this._colorPointers=null!==(n=i.colorPointers)&&void 0!==n?n:[],this._widths=null!==(o=i.widths)&&void 0!==o?o:new Array(i.points.length).fill(1),this._previousAndSide=[],this._nextAndCounters=[],i.points&&this.addPoints(Tc.ConvertPoints(i.points))}getClassName(){return"GreasedLineMesh"}static ConvertPoints(e){if(e.length&&Array.isArray(e)&&"number"==typeof e[0])return[e];if(e.length&&Array.isArray(e[0])&&"number"==typeof e[0][0])return e;if(e.length&&!Array.isArray(e[0])&&e[0]instanceof m.P){const t=[];for(let i=0;i<e.length;i++){const s=e[i];t.push(s.x,s.y,s.z)}return[t]}if(e.length>0&&Array.isArray(e[0])&&e[0].length>0&&e[0][0]instanceof m.P){const t=[];return e.forEach((e=>{t.push(e.flatMap((e=>[e.x,e.y,e.z])))})),t}if(e instanceof Float32Array)return[Array.from(e)];if(e.length&&e[0]instanceof Float32Array){const t=[];return e.forEach((e=>{t.push(Array.from(e))})),t}return[]}updateLazy(){var e;this._setPoints(this._points),this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(),this.refreshBoundingInfo(),null===(e=this.greasedLineMaterial)||void 0===e||e.updateLazy()}dispose(){super.dispose()}isLazy(){return this._lazy}get offsets(){return this._offsets}set offsets(e){this._offsets=e,this._offsetsBuffer?this._offsetsBuffer&&this._offsetsBuffer.update(e):this._createOffsetsBuffer(e)}get widths(){return this._widths}set widths(e){this._widths=e,this._lazy||this._widthsBuffer&&this._widthsBuffer.update(e)}get colorPointers(){return this._colorPointers}set colorPointers(e){this._colorPointers=e,this._lazy||this._colorPointersBuffer&&this._colorPointersBuffer.update(e)}get greasedLineMaterial(){var e,t;if(this.material&&this.material instanceof Cc.o)return this.material;return(null===(t=null===(e=this.material)||void 0===e?void 0:e.pluginManager)||void 0===t?void 0:t.getPlugin(Rl.mZ.GREASED_LINE_MATERIAL_NAME))||void 0}get points(){const e=[];return On.j.DeepCopy(this._points,e),e}addPoints(e){for(const t of e)this._points.push(t);this._lazy||this.setPoints(this._points)}_updateColorPointers(){let e=0;this._colorPointers=[],this._points.forEach((t=>{for(let i=0;i<t.length;i+=3)this._colorPointers.push(e),this._colorPointers.push(e++)}))}_updateWidths(){let e=0;for(const t of this._points)e+=t.length;const t=e/3*2-this._widths.length;for(let e=0;e<t;e++)this._widths.push(1)}setPoints(e){this._points=e,this._updateWidths(),this._updateColorPointers(),this._setPoints(e)}_setPoints(e){this._points=e,this._options.points=e,this._initGreasedLine();let t=0;e.forEach((e=>{var i;const s=[],r=[],n=[],o=Pc.u.GetLineLength(e);for(let i=0,a=0;a<e.length;i++,a+=3){const h=e.slice(0,a+3),l=Pc.u.GetLineLength(h)/o;if(r.push(e[a],e[a+1],e[a+2]),r.push(e[a],e[a+1],e[a+2]),s.push(l),s.push(l),a<e.length-3){const e=2*i+t;n.push(e,e+1,e+2),n.push(e+2,e+1,e+3)}}t+=e.length/3*2;const a=[],h=[],l=[];let c=[];this._preprocess(r,a,h,l,c);for(const e of r)this._vertexPositions.push(e);for(const e of n)this._indices.push(e);for(let e=0;e<l.length;e++)this._previousAndSide.push(a[3*e],a[3*e+1],a[3*e+2],l[e]),this._nextAndCounters.push(h[3*e],h[3*e+1],h[3*e+2],s[e]);c=null!==(i=this._options.uvs)&&void 0!==i?i:c;for(const e of c)this._uvs.push(e)})),this._lazy||(this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(),this.refreshBoundingInfo())}_createLineOptions(){return{points:this._points,colorPointers:this._colorPointers,lazy:this._lazy,updatable:this._updatable,uvs:this._uvs,widths:this._widths}}clone(e=`${this.name}-cloned`,t){const i=this._createLineOptions(),s={};On.j.DeepCopy(i,s,["instance"]);const r=new Tc(e,this._scene,s);return t&&(r.parent=t),r.material=this.material,r}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}static Parse(e,t){const i=e.lineOptions,s=e.name;return new Tc(s,t,i)}intersects(e,t,i,s=!1,r,n=!1){const o=new Yt.p,a=this.findAllIntersections(e,t,i,s,r,n,!0);if(1===(null==a?void 0:a.length)){const t=a[0];o.hit=!0,o.distance=t.distance,o.ray=e,o.pickedMesh=this,o.pickedPoint=t.point}return o}findAllIntersections(e,t,i,s=!1,r,n=!1,o=!1){var a,h;if(s&&!n&&!1===e.intersectsSphere(this._boundingSphere,this.intersectionThreshold))return;const l=this.getIndices(),c=this.getVerticesData(me.o.PositionKind),u=this._widths,d=null!==(h=null===(a=this.greasedLineMaterial)||void 0===a?void 0:a.width)&&void 0!==h?h:1,p=[];if(l&&c&&u){let t=0,i=0;for(t=0,i=l.length-1;t<i;t+=3){const i=l[t],s=l[t+1];Tc._V_START.fromArray(c,3*i),Tc._V_END.fromArray(c,3*s),this._offsets&&(Tc._V_OFFSET_START.fromArray(this._offsets,3*i),Tc._V_OFFSET_END.fromArray(this._offsets,3*s),Tc._V_START.addInPlace(Tc._V_OFFSET_START),Tc._V_END.addInPlace(Tc._V_OFFSET_END));const r=Math.floor(t/3),n=void 0!==u[r]?u[r]:1,a=this.intersectionThreshold*(d*n)/2,h=e.intersectionSegment(Tc._V_START,Tc._V_END,a);if(-1!==h&&(p.push({distance:h,point:e.direction.normalize().multiplyByFloats(h,h,h).add(e.origin)}),o))return p}t=i}return p}_initGreasedLine(){this._vertexPositions=[],this._previousAndSide=[],this._nextAndCounters=[],this._indices=[],this._uvs=[]}get _boundingSphere(){return this.getBoundingInfo().boundingSphere}static _CompareV3(e,t,i){const s=6*e,r=6*t;return i[s]===i[r]&&i[s+1]===i[r+1]&&i[s+2]===i[r+2]}static _CopyV3(e,t){const i=6*e;return[t[i],t[i+1],t[i+2]]}_preprocess(e,t,i,s,r){const n=e.length/6;let o=[];o=Tc._CompareV3(0,n-1,e)?Tc._CopyV3(n-2,e):Tc._CopyV3(0,e),t.push(o[0],o[1],o[2]),t.push(o[0],o[1],o[2]);for(let a=0;a<n;a++)s.push(1),s.push(-1),this._options.uvs||(r.push(a/(n-1),0),r.push(a/(n-1),1)),a<n-1&&(o=Tc._CopyV3(a,e),t.push(o[0],o[1],o[2]),t.push(o[0],o[1],o[2])),a>0&&(o=Tc._CopyV3(a,e),i.push(o[0],o[1],o[2]),i.push(o[0],o[1],o[2]));return o=Tc._CompareV3(n-1,0,e)?Tc._CopyV3(1,e):Tc._CopyV3(n-1,e),i.push(o[0],o[1],o[2]),i.push(o[0],o[1],o[2]),{previous:t,next:i,uvs:r,side:s}}_createVertexBuffers(){const e=new gi.x;e.positions=this._vertexPositions,e.indices=this._indices,e.uvs=this._uvs,e.applyToMesh(this,this._options.updatable);const t=this._scene.getEngine(),i=new me.l(t,this._previousAndSide,!1,4);this.setVerticesBuffer(i.createVertexBuffer("grl_previousAndSide",0,4));const s=new me.l(t,this._nextAndCounters,!1,4);this.setVerticesBuffer(s.createVertexBuffer("grl_nextAndCounters",0,4));const r=new me.l(t,this._widths,this._updatable,1);this.setVerticesBuffer(r.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=r;const n=new me.l(t,this._colorPointers,this._updatable,1);this.setVerticesBuffer(n.createVertexBuffer("grl_colorPointers",0,1)),this._colorPointersBuffer=n}_createOffsetsBuffer(e){const t=this._scene.getEngine(),i=new me.l(t,e,this._updatable,3);this.setVerticesBuffer(i.createVertexBuffer("grl_offsets",0,3)),this._offsetsBuffer=i}}function Sc(e,t,i){let s;switch(i=null!=i?i:D.l.LastCreatedScene,t.materialType){case Rl.Vw.MATERIAL_TYPE_PBR:s=new sr.Y(e,i),new Rl.mZ(s,i,t);break;case Rl.Vw.MATERIAL_TYPE_SIMPLE:s=new Cc.o(e,i,t);break;default:s=new Ot.K(e,i),new Rl.mZ(s,i,t)}return s}function Ec(e,t,i,s){var r,n,o,a,h,l;let c;s=null!=s?s:D.l.LastCreatedScene;const u=Tc.ConvertPoints(t.points);let d=0;Array.isArray(u[0])&&u.forEach((e=>{d+=e.length/3})),t.widthDistribution=null!==(r=t.widthDistribution)&&void 0!==r?r:oc.WIDTH_DISTRIBUTION_START,(i=null!=i?i:{color:Rl.mZ.DEFAULT_COLOR}).createAndAssignMaterial=null===(n=i.createAndAssignMaterial)||void 0===n||n,i.colorDistribution=null!==(o=null==i?void 0:i.colorDistribution)&&void 0!==o?o:nc.COLOR_DISTRIBUTION_START,i.materialType=null!==(a=i.materialType)&&void 0!==a?a:Rl.Vw.MATERIAL_TYPE_STANDARD;const p=Rc(d,null!==(h=t.widths)&&void 0!==h?h:[],t.widthDistribution),_=(null==i?void 0:i.colors)?Mc(d,i.colors,i.colorDistribution,null!==(l=i.color)&&void 0!==l?l:Rl.mZ.DEFAULT_COLOR):void 0;if(t.instance){c=t.instance;const e=c.widths;if(e){const t=e.slice();for(const e of p)t.push(e);c.widths=t}else c.widths=p;c.addPoints(u)}else{const r={points:u,updatable:t.updatable,widths:p,lazy:t.lazy};if(c=new Tc(e,s,r),i){const t={materialType:i.materialType,dashCount:i.dashCount,dashOffset:i.dashOffset,dashRatio:i.dashRatio,resolution:i.resolution,sizeAttenuation:i.sizeAttenuation,useColors:i.useColors,useDash:i.useDash,visibility:i.visibility,width:i.width,color:i.color,colorMode:i.colorMode,colorsSampling:i.colorsSampling,colorDistributionType:i.colorDistributionType,colors:_};if(i.createAndAssignMaterial){const i=Sc(e,t,s);c.material=i}}}if(_&&t.instance&&t.instance.greasedLineMaterial){const e=t.instance.greasedLineMaterial.colors;if(e){const i=e.concat(_);t.instance.greasedLineMaterial.setColors(i,c.isLazy())}}return c}function Rc(e,t,i,s=1,r=1){const n=e-t.length/2,o=[];if(n<0)return t.slice(0,2*e);if(n>0){if(i===oc.WIDTH_DISTRIBUTION_START_END){const e=Math.floor(t.length/2);for(let i=0,s=0;i<e-1;i++)o.push(t[s++]),o.push(t[s++]);const i=t[e/2],s=t[e/2+1];for(let e=0;e<n;e++)o.push(s),o.push(i);for(let i=e;i<t.length;i+=2)o.push(t[i]),o.push(t[i+1])}else if(i===oc.WIDTH_DISTRIBUTION_START){for(let e=0;e<t.length;e+=2)o.push(t[e]),o.push(t[e+1]);for(let e=0;e<n;e++)o.push(s),o.push(r)}else if(i===oc.WIDTH_DISTRIBUTION_END){for(let e=0;e<n;e++)o.push(s),o.push(r);for(let e=0;e<t.length;e+=2)o.push(t[e]),o.push(t[e+1])}else if(i===oc.WIDTH_DISTRIBUTION_REPEAT){let i=0;for(let s=0;s<e;s++)o.push(t[i++]),o.push(t[i++]),i===t.length&&(i=0)}else if(i===oc.WIDTH_DISTRIBUTION_EVEN){let i=0;const s=t.length/(2*(e-1));for(let r=0;r<e;r++){const e=Math.floor(i);o.push(t[e]),o.push(t[e+1]),i+=s}}}else for(let e=0;e<t.length;e++)o.push(t[e]);return o}function Mc(e,t,i,s){const r=(e=Math.max(t.length,e))-t.length;if(r<0)return t.slice(0,e);const n=[];if(r>0){if(i===nc.COLOR_DISTRIBUTION_START_END){const e=Math.floor(t.length/2);for(let i=0;i<e;i++)n.push(t[i]);for(let e=0;e<r-1;e++)n.push(s);for(let i=e;i<t.length;i++)n.push(t[i])}else if(i===nc.COLOR_DISTRIBUTION_START){for(let e=0;e<t.length;e++)n.push(t[e]);for(let e=0;e<r;e++)n.push(s)}else if(i===nc.COLOR_DISTRIBUTION_END){for(let e=0;e<r-1;e++)n.push(s);for(let e=0;e<t.length;e++)n.push(t[e])}else if(i===nc.COLOR_DISTRIBUTION_REPEAT){let i=0;for(let s=0;s<e;s++)n.push(t[i]),i++,i===t.length&&(i=0)}else if(i===nc.COLOR_DISTRIBUTION_EVEN){let i=0;const s=t.length/(e-1);for(let r=0;r<e-1;r++){const e=Math.floor(i);n.push(t[e]),i+=s}}else if(i===nc.COLOR_DISTRIBUTION_NONE)for(let e=0;e<t.length;e++)n.push(t[e])}else for(let i=0;i<e;i++)n.push(t[i]);return n}Tc._V_START=new m.P,Tc._V_END=new m.P,Tc._V_OFFSET_START=new m.P,Tc._V_OFFSET_END=new m.P,function(e){e[e.COLOR_DISTRIBUTION_NONE=0]="COLOR_DISTRIBUTION_NONE",e[e.COLOR_DISTRIBUTION_REPEAT=1]="COLOR_DISTRIBUTION_REPEAT",e[e.COLOR_DISTRIBUTION_EVEN=2]="COLOR_DISTRIBUTION_EVEN",e[e.COLOR_DISTRIBUTION_START=3]="COLOR_DISTRIBUTION_START",e[e.COLOR_DISTRIBUTION_END=4]="COLOR_DISTRIBUTION_END",e[e.COLOR_DISTRIBUTION_START_END=5]="COLOR_DISTRIBUTION_START_END"}(nc||(nc={})),function(e){e[e.WIDTH_DISTRIBUTION_NONE=0]="WIDTH_DISTRIBUTION_NONE",e[e.WIDTH_DISTRIBUTION_REPEAT=1]="WIDTH_DISTRIBUTION_REPEAT",e[e.WIDTH_DISTRIBUTION_EVEN=2]="WIDTH_DISTRIBUTION_EVEN",e[e.WIDTH_DISTRIBUTION_START=3]="WIDTH_DISTRIBUTION_START",e[e.WIDTH_DISTRIBUTION_END=4]="WIDTH_DISTRIBUTION_END",e[e.WIDTH_DISTRIBUTION_START_END=5]="WIDTH_DISTRIBUTION_START_END"}(oc||(oc={}));var Ac=i(97626),Ic=i(37612),Oc=(i(77709),i(29815)),wc=i(40389),Dc=i(77766);class Bc{_getGlobalNodeGeometryEditor(){return"undefined"!=typeof NODEGEOMETRYEDITOR?NODEGEOMETRYEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeGeometryEditor?BABYLON:void 0}get buildExecutionTime(){return this._buildExecutionTime}constructor(e){this._buildId=Bc._BuildIdGenerator++,this._buildWasSuccessful=!1,this._vertexData=null,this._buildExecutionTime=0,this.BJSNODEGEOMETRYEDITOR=this._getGlobalNodeGeometryEditor(),this.editorData=null,this.attachedBlocks=new Array,this.onBuildObservable=new _.y$,this.outputBlock=null,this.name=e}getClassName(){return"NodeGeometry"}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return w.w1.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}edit(e){return new Promise((t=>{if(this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),void 0===this.BJSNODEGEOMETRYEDITOR){const i=e&&e.editorURL?e.editorURL:Bc.EditorURL;w.w1.LoadScript(i,(()=>{this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),this._createNodeEditor(null==e?void 0:e.nodeGeometryEditorConfig),t()}))}else this._createNodeEditor(null==e?void 0:e.nodeGeometryEditorConfig),t()}))}_createNodeEditor(e){const t=Object.assign({nodeGeometry:this},e);this.BJSNODEGEOMETRYEDITOR.NodeGeometryEditor.Show(t)}build(e=!1,t=!0,i=!1){if(this._buildWasSuccessful=!1,!this.outputBlock)throw"You must define the outputBlock property before building the geometry";const s=G.F.Now;this._initializeBlock(this.outputBlock,i);const r=new wc.f;r.buildId=this._buildId,r.verbose=e,this.outputBlock.build(r),t&&(this._buildId=Bc._BuildIdGenerator++),this._buildExecutionTime=G.F.Now-s,r.emitErrors(),this._buildWasSuccessful=!0,this._vertexData=r.vertexData,this.onBuildObservable.notifyObservers(this)}createMesh(e,t=null){if(this._buildWasSuccessful||this.build(),!this._vertexData)return null;const i=new Mt.Kj(e,t);return this._vertexData.applyToMesh(i),i._internalMetadata=i._internalMetadata||{},i._internalMetadata.nodeGeometry=this,i}updateMesh(e){return this._buildWasSuccessful||this.build(),!!this._vertexData&&(this._vertexData.applyToMesh(e),e._internalMetadata=e._internalMetadata||{},e._internalMetadata.nodeGeometry=this,e)}_initializeBlock(e,t=!0){e.initialize(),t&&e.autoConfigure(),e._preparationId=this._buildId,-1===this.attachedBlocks.indexOf(e)&&this.attachedBlocks.push(e);for(const i of e.inputs){const s=i.connectedPoint;if(s){const i=s.ownerBlock;i!==e&&this._initializeBlock(i,t)}}}clear(){this.outputBlock=null,this.attachedBlocks.length=0}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e===this.outputBlock&&(this.outputBlock=null)}parseSerializedObject(e,t=!1){t||this.clear();const i={};for(const t of e.blocks){const e=(0,c.q)(t.customType);if(e){const s=new e;s._deserialize(t),i[t.id]=s,this.attachedBlocks.push(s)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,s=t._tempEntryPointUniqueId;s&&i[s].attachToEndpoint(t)}for(let s=0;s<e.blocks.length;s++){const r=e.blocks[s],n=i[r.id];n&&(n.inputs.length&&r.inputs.some((e=>e.targetConnectionName))&&!t||this._restoreConnections(n,e,i))}if(e.outputNodeId&&(this.outputBlock=i[e.outputNodeId]),e.locations||e.editorData&&e.editorData.locations){const s=e.locations||e.editorData.locations;for(const e of s)i[e.blockId]&&(e.blockId=i[e.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&s.concat(this.editorData.locations),e.locations?this.editorData={locations:s}:(this.editorData=e.editorData,this.editorData.locations=s);const r=[];for(const e in i)r[e]=i[e].uniqueId;this.editorData.map=r}this.comment=e.comment}_restoreConnections(e,t,i){for(const s of e.outputs)for(const r of t.blocks){const n=i[r.id];if(n)for(const o of r.inputs)if(i[o.targetBlockId]!==e||o.targetConnectionName!==s.name);else{const e=n.getInputByName(o.inputName);if(!e||e.isConnected)continue;s.connectTo(e,!0),this._restoreConnections(n,t,i)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];this.outputBlock&&this._gatherBlocks(this.outputBlock,t);let s=`let nodeGeometry = new BABYLON.NodeGeometry("${this.name||"node geometry"}");\n`;for(const r of t)r.isInput&&-1===e.indexOf(r)&&(s+=r._dumpCode(i,e));return this.outputBlock&&(e=[],s+="\n`;// Connections\n`;",s+=this.outputBlock._dumpCodeForOutputConnections(e),s+="\n`;// Output nodes\n`;",s+=`nodeGeometry.outputBlock = ${this.outputBlock._codeVariableName};\n`,s+="nodeGeometry.build();\n"),s}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const s=i.connectedPoint;if(s){const i=s.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}setToDefault(){this.clear(),this.editorData=null;const e=new Dc.l("Box");e.autoConfigure();const t=new Oc.O("Geometry Output");e.geometry.connectTo(t.geometry),this.outputBlock=t}clone(e){const t=this.serialize(),i=j.p4.Clone((()=>new Bc(e)),this);return i.name=e,i.parseSerializedObject(t),i._buildId=this._buildId,i.build(!1),i}serialize(e,t){const i=t?{}:j.p4.Serialize(this);i.editorData=JSON.parse(JSON.stringify(this.editorData));let s=[];t?s=t:(i.customType="BABYLON.NodeGeometry",this.outputBlock&&(i.outputNodeId=this.outputBlock.uniqueId)),i.blocks=[];for(const t of s)i.blocks.push(t.serialize(e));if(!t)for(const t of this.attachedBlocks)-1===s.indexOf(t)&&i.blocks.push(t.serialize(e));return i}dispose(){for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this.onBuildObservable.clear()}static CreateDefault(e){const t=new Bc(e);return t.setToDefault(),t.build(),t}static Parse(e){const t=j.p4.Parse((()=>new Bc(e.name)),e,null);return t.parseSerializedObject(e),t.build(),t}static ParseFromSnippetAsync(e,t,i=!1){return"_BLANK"===e?Promise.resolve(Bc.CreateDefault("blank")):new Promise(((s,r)=>{const n=new zo.g;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){const o=JSON.parse(JSON.parse(n.responseText).jsonPayload),a=JSON.parse(o.nodeGeometry);t||(t=j.p4.Parse((()=>new Bc(e)),a,null)),t.parseSerializedObject(a),t.snippetId=e;try{i||t.build(),s(t)}catch(e){r(e)}}else r("Unable to load the snippet "+e)})),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()}))}}Bc._BuildIdGenerator=0,Bc.EditorURL=`https://unpkg.com/babylonjs-node-geometry-editor@${O.D.Version}/babylon.nodeGeometryEditor.js`,Bc.SnippetUrl="https://snippet.babylonjs.com",(0,H.gn)([(0,j.qC)()],Bc.prototype,"name",void 0),(0,H.gn)([(0,j.qC)("comment")],Bc.prototype,"comment",void 0);var Nc=i(8630),Fc=i(97330),Lc=(i(51530),i(99258)),Vc=i(15221);class kc extends Nc.s{constructor(e){super(e),this.evaluateContext=!1,this.epsilon=Ns.kn,this.registerInput("geometry",Lc.g.Geometry),this.registerOutput("output",Lc.g.Geometry)}getClassName(){return"GeometryOptimizeBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e),i=[],s={};for(let e=0;e<t.positions.length;e+=3){const r=t.positions[e],n=t.positions[e+1],o=t.positions[e+2];let a=!1;for(let t=0;t<i.length;t+=3)Po.R.WithinEpsilon(r,i[t],this.epsilon)&&Po.R.WithinEpsilon(n,i[t+1],this.epsilon)&&Po.R.WithinEpsilon(o,i[t+2],this.epsilon)&&(s[e/3]=t/3,a=!0);a||(s[e/3]=i.length/3,i.push(r,n,o))}const r=new gi.x;return r.positions=i,r.indices=t.indices.map((e=>s[e])),r};this.evaluateContext?this.output._storedFunction=t:this.output._storedValue=t(e)}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.epsilon = ${this.epsilon};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.epsilon=this.epsilon,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,this.epsilon=e.epsilon}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],kc.prototype,"evaluateContext",void 0),(0,H.gn)([(0,ga.p)("Epsilon",ga.U.Float,"ADVANCED",{notifiers:{rebuild:!0}})],kc.prototype,"epsilon",void 0),(0,c.H)("BABYLON.GeometryOptimizeBlock",kc);var zc,Gc,Uc,Wc,Hc=i(20729);class jc extends Nc.s{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("size",Lc.g.Float,!0,1),this.registerInput("width",Lc.g.Float,!0,0),this.registerInput("height",Lc.g.Float,!0,0),this.registerOutput("geometry",Lc.g.Geometry)}getClassName(){return"PlaneBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected){const e=new Hc.p("Size");return e.value=1,void e.output.connectTo(this.size)}if(!this.width.isConnected){const e=new Hc.p("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new Hc.p("Height");e.value=1,e.output.connectTo(this.height)}}}_buildBlock(e){const t={},i=e=>(t.size=this.size.getConnectedValue(e),t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e),(0,Ls.Hq)(t));this.evaluateContext?this.geometry._storedFunction=i:this.geometry._storedValue=i(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],jc.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.PlaneBlock",jc);class $c extends Nc.s{get mesh(){return this._mesh}set mesh(e){this._mesh=e}constructor(e){super(e),this._cachedVertexData=null,this.registerOutput("geometry",Lc.g.Geometry)}getClassName(){return"MeshBlock"}get isUsingCachedData(){return!this.mesh&&!!this._cachedVertexData}get geometry(){return this._outputs[0]}_buildBlock(){this._mesh?(this.geometry._storedValue=gi.x.ExtractFromMesh(this._mesh,!1,!0),this._cachedVertexData=null):this._cachedVertexData?this.geometry._storedValue=this._cachedVertexData.clone():this.geometry._storedValue=null}serialize(e){const t=super.serialize();return e&&(this._mesh?t.cachedVertexData=gi.x.ExtractFromMesh(this._mesh,!1,!0).serialize():this._cachedVertexData&&(t.cachedVertexData=this._cachedVertexData.serialize())),t}_deserialize(e){super._deserialize(e),e.cachedVertexData&&(this._cachedVertexData=gi.x.Parse(e.cachedVertexData))}}(0,c.H)("BABYLON.MeshBlock",$c);class Yc extends Nc.s{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",Lc.g.Float,!0,1),this.registerInput("radiusX",Lc.g.Float,!0,0),this.registerInput("radiusY",Lc.g.Float,!0,0),this.registerInput("radiusZ",Lc.g.Float,!0,0),this.registerInput("subdivisions",Lc.g.Int,!0,4),this.registerOutput("geometry",Lc.g.Geometry)}getClassName(){return"IcoSphereBlock"}get radius(){return this._inputs[0]}get radiusX(){return this._inputs[1]}get radiusY(){return this._inputs[2]}get radiusZ(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new Hc.p("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.radius=this.radius.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.radiusX=this.radiusX.getConnectedValue(e),t.radiusY=this.radiusY.getConnectedValue(e),t.radiusZ=this.radiusZ.getConnectedValue(e),(0,yc.GQ)(t));this.evaluateContext?this.geometry._storedFunction=i:this.geometry._storedValue=i(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Yc.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.IcoSphereBlock",Yc);class Xc extends Nc.s{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("segments",Lc.g.Int,!0,32),this.registerInput("diameter",Lc.g.Float,!0,1),this.registerInput("diameterX",Lc.g.Float,!0,0),this.registerInput("diameterY",Lc.g.Float,!0,0),this.registerInput("diameterZ",Lc.g.Float,!0,0),this.registerInput("arc",Lc.g.Float,!0,1),this.registerInput("slice",Lc.g.Float,!0,1),this.registerOutput("geometry",Lc.g.Geometry)}getClassName(){return"SphereBlock"}get segments(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterX(){return this._inputs[2]}get diameterY(){return this._inputs[3]}get diameterZ(){return this._inputs[4]}get arc(){return this._inputs[5]}get slice(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new Hc.p("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=e=>(t.segments=this.segments.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.diameterX=this.diameterX.getConnectedValue(e),t.diameterY=this.diameterY.getConnectedValue(e),t.diameterZ=this.diameterZ.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),t.slice=this.slice.getConnectedValue(e),(0,di.jY)(t));this.evaluateContext?this.geometry._storedFunction=i:this.geometry._storedValue=i(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Xc.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.SphereBlock",Xc);class Qc extends Nc.s{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("width",Lc.g.Float,!0,1),this.registerInput("height",Lc.g.Float,!0,1),this.registerInput("subdivisions",Lc.g.Int,!0,1),this.registerInput("subdivisionsX",Lc.g.Int,!0,0),this.registerInput("subdivisionsY",Lc.g.Int,!0,0),this.registerOutput("geometry",Lc.g.Geometry)}getClassName(){return"GridBlock"}get width(){return this._inputs[0]}get height(){return this._inputs[1]}get subdivisions(){return this._inputs[2]}get subdivisionsX(){return this._inputs[3]}get subdivisionsY(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.width.isConnected){const e=new Hc.p("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new Hc.p("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=e=>(t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.subdivisionsX=this.subdivisionsX.getConnectedValue(e),t.subdivisionsY=this.subdivisionsY.getConnectedValue(e),(0,Vt.kt)(t));this.evaluateContext?this.geometry._storedFunction=i:this.geometry._storedValue=i(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Qc.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.GridBlock",Qc);class qc extends Nc.s{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("diameter",Lc.g.Float,!0,1),this.registerInput("thickness",Lc.g.Float,!0,.5),this.registerInput("tessellation",Lc.g.Int,!0,16),this.registerOutput("geometry",Lc.g.Geometry)}getClassName(){return"TorusBlock"}get diameter(){return this._inputs[0]}get thickness(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new Hc.p("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=e=>(t.thickness=this.thickness.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),(0,Lt.h5)(t));this.evaluateContext?this.geometry._storedFunction=i:this.geometry._storedValue=i(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],qc.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.TorusBlock",qc);class Kc extends Nc.s{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",Lc.g.Float,!0,25),this.registerInput("diameter",Lc.g.Float,!0,1),this.registerInput("diameterTop",Lc.g.Float,!0,-1),this.registerInput("diameterBottom",Lc.g.Float,!0,-1),this.registerInput("subdivisions",Lc.g.Int,!0,1),this.registerInput("tessellation",Lc.g.Int,!0,24),this.registerInput("arc",Lc.g.Float,!0,1),this.registerOutput("geometry",Lc.g.Geometry)}getClassName(){return"CylinderBlock"}get height(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterTop(){return this._inputs[2]}get diameterBottom(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get tessellation(){return this._inputs[5]}get arc(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new Hc.p("Diameter");e.value=1,e.output.connectTo(this.diameter)}if(!this.height.isConnected){const e=new Hc.p("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=e=>(t.height=this.height.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.diameterTop=this.diameterTop.getConnectedValue(e),t.diameterBottom=this.diameterBottom.getConnectedValue(e),-1===t.diameterTop&&(t.diameterTop=t.diameter),-1===t.diameterBottom&&(t.diameterBottom=t.diameter),t.tessellation=this.tessellation.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),(0,Ft.zD)(t));this.evaluateContext?this.geometry._storedFunction=i:this.geometry._storedValue=i(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Kc.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.CylinderBlock",Kc);class Zc extends Nc.s{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",Lc.g.Float,!0,1),this.registerInput("radius",Lc.g.Float,!0,.25),this.registerInput("tessellation",Lc.g.Int,!0,16),this.registerInput("subdivisions",Lc.g.Int,!0,2),this.registerOutput("geometry",Lc.g.Geometry)}getClassName(){return"CapsuleBlock"}get height(){return this._inputs[0]}get radius(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.height.isConnected){const e=new Hc.p("Height");e.value=1,e.output.connectTo(this.height)}if(!this.radius.isConnected){const e=new Hc.p("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.height=this.height.getConnectedValue(e),t.radius=this.radius.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),(0,_i.VF)(t));this.evaluateContext?this.geometry._storedFunction=i:this.geometry._storedValue=i(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Zc.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.CapsuleBlock",Zc);class Jc extends Nc.s{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",Lc.g.Float,!0,.5),this.registerInput("tessellation",Lc.g.Int,!0,64),this.registerInput("arc",Lc.g.Float,!0,1),this.registerOutput("geometry",Lc.g.Geometry)}getClassName(){return"DiscBlock"}get radius(){return this._inputs[0]}get tessellation(){return this._inputs[1]}get arc(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new Hc.p("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.radius=this.radius.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),(0,Ys.vM)(t));this.evaluateContext?this.geometry._storedFunction=i:this.geometry._storedValue=i(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Jc.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.DiscBlock",Jc);class eu extends Nc.s{constructor(e){super(e),this.registerOutput("geometry",Lc.g.Geometry)}getClassName(){return"NullBlock"}get geometry(){return this._outputs[0]}_buildBlock(){this.geometry._storedValue=null}}(0,c.H)("BABYLON.NullBlock",eu);class tu extends Nc.s{constructor(e){super(e),this.registerInput("geometry",Lc.g.Geometry),this.registerInput("positions",Lc.g.Vector3),this.registerOutput("output",Lc.g.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetPositionsBlock"}get geometry(){return this._inputs[0]}get positions(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(e.executionContext=this,this._vertexData=this.geometry.getConnectedValue(e),e.geometryContext=this._vertexData,!this._vertexData||!this._vertexData.positions||!this.positions.isConnected)return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=null);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.positions.getConnectedValue(e);t&&t.toArray(this._vertexData.positions,3*this._currentIndex)}this.output._storedValue=this._vertexData,e.executionContext=null,e.geometryContext=null}}(0,c.H)("BABYLON.SetPositionsBlock",tu);class iu extends Nc.s{constructor(e){super(e),this.registerInput("geometry",Lc.g.Geometry),this.registerInput("normals",Lc.g.Vector3),this.registerOutput("output",Lc.g.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetNormalsBlock"}get geometry(){return this._inputs[0]}get normals(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(e.executionContext=this,this._vertexData=this.geometry.getConnectedValue(e),e.geometryContext=this._vertexData,!this._vertexData||!this._vertexData.positions)return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=null);if(!this.normals.isConnected)return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=this._vertexData);this._vertexData.normals||(this._vertexData.normals=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.normals.getConnectedValue(e);t&&t.toArray(this._vertexData.normals,3*this._currentIndex)}this.output._storedValue=this._vertexData,e.executionContext=null,e.geometryContext=null}}(0,c.H)("BABYLON.SetNormalsBlock",iu);class su extends Nc.s{constructor(e){super(e),this.textureCoordinateIndex=0,this.registerInput("geometry",Lc.g.Geometry),this.registerInput("uvs",Lc.g.Vector2),this.registerOutput("output",Lc.g.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetUVsBlock"}get geometry(){return this._inputs[0]}get uvs(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(e.executionContext=this,this._vertexData=this.geometry.getConnectedValue(e),e.geometryContext=this._vertexData,!this._vertexData||!this._vertexData.positions)return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=null);if(!this.uvs.isConnected)return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=this._vertexData);const t=[],i=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<i;this._currentIndex++){const i=this.uvs.getConnectedValue(e);i&&i.toArray(t,2*this._currentIndex)}switch(this.textureCoordinateIndex){case 0:this._vertexData.uvs=t;break;case 1:this._vertexData.uvs2=t;break;case 2:this._vertexData.uvs3=t;break;case 3:this._vertexData.uvs4=t;break;case 4:this._vertexData.uvs5=t;break;case 5:this._vertexData.uvs6=t}this.output._storedValue=this._vertexData,e.executionContext=null,e.geometryContext=null}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.textureCoordinateIndex};\n`}serialize(){const e=super.serialize();return e.textureCoordinateIndex=this.textureCoordinateIndex,e}_deserialize(e){super._deserialize(e),this.textureCoordinateIndex=e.textureCoordinateIndex}}(0,H.gn)([(0,ga.p)("Texture coordinates index",ga.U.List,"ADVANCED",{notifiers:{update:!0},options:[{label:"UV1",value:0},{label:"UV2",value:1},{label:"UV3",value:2},{label:"UV4",value:3},{label:"UV5",value:4},{label:"UV6",value:5}]})],su.prototype,"textureCoordinateIndex",void 0),(0,c.H)("BABYLON.SetUVsBlock",su);class ru extends Nc.s{constructor(e){super(e),this.registerInput("geometry",Lc.g.Geometry),this.registerInput("colors",Lc.g.Vector4),this.registerOutput("output",Lc.g.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetColorsBlock"}get geometry(){return this._inputs[0]}get colors(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(e.executionContext=this,this._vertexData=this.geometry.getConnectedValue(e),e.geometryContext=this._vertexData,!this._vertexData||!this._vertexData.positions)return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=null);if(!this.colors.isConnected)return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=this._vertexData);this._vertexData.colors||(this._vertexData.colors=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.colors.getConnectedValue(e);t&&t.toArray(this._vertexData.colors,4*this._currentIndex)}this.output._storedValue=this._vertexData,e.executionContext=null,e.geometryContext=null}}(0,c.H)("BABYLON.SetColorsBlock",ru);class nu extends Nc.s{constructor(e){super(e),this.registerInput("geometry",Lc.g.Geometry),this.registerInput("tangents",Lc.g.Vector4),this.registerOutput("output",Lc.g.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetTangentsBlock"}get geometry(){return this._inputs[0]}get tangents(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(e.executionContext=this,this._vertexData=this.geometry.getConnectedValue(e),e.geometryContext=this._vertexData,!this._vertexData||!this._vertexData.positions)return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=null);if(!this.tangents.isConnected)return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=this._vertexData);this._vertexData.tangents||(this._vertexData.tangents=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.tangents.getConnectedValue(e);t&&t.toArray(this._vertexData.tangents,4*this._currentIndex)}this.output._storedValue=this._vertexData,e.executionContext=null,e.geometryContext=null}}(0,c.H)("BABYLON.SetTangentsBlock",nu),function(e){e[e.Add=0]="Add",e[e.Subtract=1]="Subtract",e[e.Multiply=2]="Multiply",e[e.Divide=3]="Divide",e[e.Max=4]="Max",e[e.Min=5]="Min"}(zc||(zc={}));class ou extends Nc.s{constructor(e){super(e),this.operation=zc.Add,this.registerInput("left",Lc.g.AutoDetect),this.registerInput("right",Lc.g.AutoDetect),this.registerOutput("output",Lc.g.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Geometry),this._inputs[1].excludedConnectionPointTypes.push(Lc.g.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Lc.g.Geometry),this._linkConnectionTypes(0,1)}getClassName(){return"MathBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){let e;const t=this.left,i=this.right;if(!t.isConnected||!i.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const s=t.type===Lc.g.Float||t.type===Lc.g.Int;switch(this.operation){case zc.Add:e=s?e=>t.getConnectedValue(e)+i.getConnectedValue(e):e=>t.getConnectedValue(e).add(e.adapt(i,t.type));break;case zc.Subtract:e=s?e=>t.getConnectedValue(e)-i.getConnectedValue(e):e=>t.getConnectedValue(e).subtract(e.adapt(i,t.type));break;case zc.Multiply:e=s?e=>t.getConnectedValue(e)*i.getConnectedValue(e):e=>t.getConnectedValue(e).multiply(e.adapt(i,t.type));break;case zc.Divide:e=s?e=>t.getConnectedValue(e)/i.getConnectedValue(e):e=>t.getConnectedValue(e).divide(e.adapt(i,t.type));break;case zc.Min:if(s)e=e=>Math.min(t.getConnectedValue(e),i.getConnectedValue(e));else switch(t.type){case Lc.g.Vector2:e=e=>m.FM.Minimize(t.getConnectedValue(e),e.adapt(i,t.type));break;case Lc.g.Vector3:e=e=>m.P.Minimize(t.getConnectedValue(e),e.adapt(i,t.type));break;case Lc.g.Vector4:e=e=>m.Lt.Minimize(t.getConnectedValue(e),e.adapt(i,t.type))}break;case zc.Max:if(!s){switch(t.type){case Lc.g.Vector2:e=e=>m.FM.Maximize(t.getConnectedValue(e),e.adapt(i,t.type));break;case Lc.g.Vector3:e=e=>m.P.Maximize(t.getConnectedValue(e),e.adapt(i,t.type));break;case Lc.g.Vector4:e=e=>m.Lt.Maximize(t.getConnectedValue(e),e.adapt(i,t.type))}break}e=e=>Math.max(t.getConnectedValue(e),i.getConnectedValue(e))}this.output._storedFunction=i=>t.type===Lc.g.Int?0|e(i):e(i)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.MathBlockOperations.${zc[this.operation]};\n`}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}}(0,H.gn)([(0,ga.p)("Operation",ga.U.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Add",value:zc.Add},{label:"Subtract",value:zc.Subtract},{label:"Multiply",value:zc.Multiply},{label:"Divide",value:zc.Divide},{label:"Max",value:zc.Max},{label:"Min",value:zc.Min}]})],ou.prototype,"operation",void 0),(0,c.H)("BABYLON.MathBlock",ou);class au extends Nc.s{constructor(e){super(e),this.registerInput("value",Lc.g.AutoDetect),this.registerInput("fromMin",Lc.g.Float,!0,0),this.registerInput("fromMax",Lc.g.Float,!0,1),this.registerInput("toMin",Lc.g.Float,!0,0),this.registerInput("toMax",Lc.g.Float,!0,1),this.registerOutput("output",Lc.g.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"MapRangeBlock"}get value(){return this._inputs[0]}get fromMin(){return this._inputs[1]}get fromMax(){return this._inputs[2]}get toMin(){return this._inputs[3]}get toMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.fromMin.getConnectedValue(e),s=this.fromMax.getConnectedValue(e),r=this.toMin.getConnectedValue(e);return(t-i)/(s-i)*(this.toMax.getConnectedValue(e)-r)+r}}}(0,c.H)("BABYLON.MapRangeBlock",au),function(e){e[e.Equal=0]="Equal",e[e.NotEqual=1]="NotEqual",e[e.LessThan=2]="LessThan",e[e.GreaterThan=3]="GreaterThan",e[e.LessOrEqual=4]="LessOrEqual",e[e.GreaterOrEqual=5]="GreaterOrEqual",e[e.Xor=6]="Xor",e[e.Or=7]="Or",e[e.And=8]="And"}(Gc||(Gc={}));class hu extends Nc.s{constructor(e){super(e),this.test=Gc.Equal,this.registerInput("left",Lc.g.Float),this.registerInput("right",Lc.g.Float,!0,0),this.registerInput("ifTrue",Lc.g.AutoDetect,!0,1),this.registerInput("ifFalse",Lc.g.AutoDetect,!0,0),this.registerOutput("output",Lc.g.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=Lc.g.Float,this._inputs[0].acceptedConnectionPointTypes.push(Lc.g.Int),this._inputs[1].acceptedConnectionPointTypes.push(Lc.g.Int),this._linkConnectionTypes(2,3)}getClassName(){return"ConditionBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get ifTrue(){return this._inputs[2]}get ifFalse(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);let s=!1;switch(this.test){case Gc.Equal:s=Po.R.WithinEpsilon(t,i,Ns.kn);break;case Gc.NotEqual:s=t!==i;break;case Gc.LessThan:s=t<i;break;case Gc.GreaterThan:s=t>i;break;case Gc.LessOrEqual:s=t<=i;break;case Gc.GreaterOrEqual:s=t>=i;break;case Gc.Xor:s=!!t&&!i||!t&&!!i;break;case Gc.Or:s=!!t||!!i;break;case Gc.And:s=!!t&&!!i}return s};this.output._storedFunction=t=>e(t)?this.ifTrue.getConnectedValue(t):this.ifFalse.getConnectedValue(t)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.test = BABYLON.ConditionBlockTests.${Gc[this.test]};\n`}serialize(){const e=super.serialize();return e.test=this.test,e}_deserialize(e){super._deserialize(e),this.test=e.test}}(0,H.gn)([(0,ga.p)("Test",ga.U.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Equal",value:Gc.Equal},{label:"NotEqual",value:Gc.NotEqual},{label:"LessThan",value:Gc.LessThan},{label:"GreaterThan",value:Gc.GreaterThan},{label:"LessOrEqual",value:Gc.LessOrEqual},{label:"GreaterOrEqual",value:Gc.GreaterOrEqual},{label:"Xor",value:Gc.Xor},{label:"Or",value:Gc.Or},{label:"And",value:Gc.And}]})],hu.prototype,"test",void 0),(0,c.H)("BABYLON.ConditionBlock",hu);class lu extends Nc.s{constructor(e){super(e),this.registerInput("min",Lc.g.AutoDetect),this.registerInput("max",Lc.g.AutoDetect),this.registerOutput("output",Lc.g.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Geometry),this._inputs[1].excludedConnectionPointTypes.push(Lc.g.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Lc.g.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"RandomBlock"}get min(){return this._inputs[0]}get max(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.min.isConnected){const e=new Hc.p("Min");e.value=0,e.output.connectTo(this.min)}if(!this.max.isConnected){const e=new Hc.p("Max");e.value=1,e.output.connectTo(this.max)}}_buildBlock(){let e=null;switch(this.min.type){case Lc.g.Int:case Lc.g.Float:e=e=>{const t=this.min.getConnectedValue(e)||0,i=this.max.getConnectedValue(e)||0;return t+Math.random()*(i-t)};break;case Lc.g.Vector2:e=e=>{const t=this.min.getConnectedValue(e)||m.FM.Zero(),i=this.max.getConnectedValue(e)||m.FM.Zero();return new m.FM(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y))};break;case Lc.g.Vector3:e=e=>{const t=this.min.getConnectedValue(e)||m.P.Zero(),i=this.max.getConnectedValue(e)||m.P.Zero();return new m.P(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y),t.z+Math.random()*(i.z-t.z))};break;case Lc.g.Vector4:e=e=>{const t=this.min.getConnectedValue(e)||m.Lt.Zero(),i=this.max.getConnectedValue(e)||m.Lt.Zero();return new m.Lt(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y),t.z+Math.random()*(i.z-t.z),t.w+Math.random()*(i.w-t.w))}}this.output._storedFunction=e}}(0,c.H)("BABYLON.RandomBlock",lu);class cu extends Nc.s{constructor(e){super(e),this.registerInput("offset",Lc.g.Vector3,!0,m.P.Zero()),this.registerInput("scale",Lc.g.Float,!0,1),this.registerInput("octaves",Lc.g.Float,!0,2,0,16),this.registerInput("roughness",Lc.g.Float,!0,.5,0,1),this.registerOutput("output",Lc.g.Float)}getClassName(){return"NoiseBlock"}get offset(){return this._inputs[0]}get scale(){return this._inputs[1]}get octaves(){return this._inputs[2]}get roughness(){return this._inputs[3]}get output(){return this._outputs[0]}_negateIf(e,t){return 0!==t?-e:e}_noiseGrad(e,t,i,s){const r=15&e,n=r<8?t:i,o=r<4?i:12===r||14==r?t:s;return this._negateIf(n,r&n)+this._negateIf(o,2&r)}_fade(e){return e*e*e*(e*(6*e-15)+10)}_hashBitRotate(e,t){return e<<t|e>>32-t}_hash(e,t,i){let s,r,n;return s=r=n=3735928584,n+=i,r+=t,s+=e,n^=r,n-=this._hashBitRotate(r,14),s^=n,s-=this._hashBitRotate(n,11),r^=s,r-=this._hashBitRotate(s,25),n^=r,n-=this._hashBitRotate(r,16),s^=n,s-=this._hashBitRotate(n,4),r^=s,r-=this._hashBitRotate(s,14),n^=r,n-=this._hashBitRotate(r,24),n}_mix(e,t,i,s,r,n,o,a,h,l,c){const u=1-h,d=1-l;return(1-c)*(d*(e*u+t*h)+l*(i*u+s*h))+c*(d*(r*u+n*h)+l*(o*u+a*h))}_perlinNoise(e){const t=(0|e.x)-(e.x<0?1:0),i=(0|e.y)-(e.y<0?1:0),s=(0|e.z)-(e.z<0?1:0),r=e.x-t,n=e.y-i,o=e.z-s,a=this._fade(r),h=this._fade(n),l=this._fade(o);return this._mix(this._noiseGrad(this._hash(t,i,s),r,n,o),this._noiseGrad(this._hash(t+1,i,s),r-1,n,o),this._noiseGrad(this._hash(t,i+1,s),r,n-1,o),this._noiseGrad(this._hash(t+1,i+1,s),r-1,n-1,o),this._noiseGrad(this._hash(t,i,s+1),r,n,o-1),this._noiseGrad(this._hash(t+1,i,s+1),r-1,n,o-1),this._noiseGrad(this._hash(t,i+1,s+1),r,n-1,o-1),this._noiseGrad(this._hash(t+1,i+1,s+1),r-1,n-1,o-1),a,h,l)}_perlinSigned(e){return.982*this._perlinNoise(e)}_perlin(e){return this._perlinSigned(e)/2+.5}noise(e,t,i,s,r){const n=new m.P(i.x+s.x*r,i.y+s.y*r,i.z+s.z*r);let o=1,a=1,h=0,l=0;const c=0|(e=Po.R.Clamp(e,0,15));for(let e=0;e<=c;e++)l+=this._perlin(n.scale(o))*a,h+=a,a*=Po.R.Clamp(t,0,1),o*=2;const u=e-Math.floor(e);if(0==u)return l/h;let d=l+this._perlin(n.scale(o))*a;return l/=h,d/=h+a,(1-u)*l+u*d}_buildBlock(){this.output._storedFunction=e=>{const t=e.getContextualValue(Vc.a.Positions),i=this.octaves.getConnectedValue(e),s=this.roughness.getConnectedValue(e),r=this.offset.getConnectedValue(e),n=this.scale.getConnectedValue(e);return this.noise(i,s,t,r,n)}}}(0,c.H)("BABYLON.NoiseBlock",cu);class uu extends Nc.s{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("geometry0",Lc.g.Geometry),this.registerInput("geometry1",Lc.g.Geometry,!0),this.registerInput("geometry2",Lc.g.Geometry,!0),this.registerInput("geometry3",Lc.g.Geometry,!0),this.registerInput("geometry4",Lc.g.Geometry,!0),this.registerOutput("output",Lc.g.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MergeGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{let t=this.geometry0.getConnectedValue(e);const i=[];return this.geometry1.isConnected&&i.push(this.geometry1.getConnectedValue(e)),this.geometry2.isConnected&&i.push(this.geometry2.getConnectedValue(e)),this.geometry3.isConnected&&i.push(this.geometry3.getConnectedValue(e)),this.geometry4.isConnected&&i.push(this.geometry4.getConnectedValue(e)),i.length&&t&&(t=t.merge(i,!0,!1,!0,!0)),t};this.evaluateContext?this.output._storedFunction=t:this.output._storedValue=t(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],uu.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.MergeGeometryBlock",uu);class du extends Nc.s{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry0",Lc.g.Geometry,!0),this.registerInput("geometry1",Lc.g.Geometry,!0),this.registerInput("geometry2",Lc.g.Geometry,!0),this.registerInput("geometry3",Lc.g.Geometry,!0),this.registerInput("geometry4",Lc.g.Geometry,!0),this.registerInput("geometry5",Lc.g.Geometry,!0),this.registerInput("geometry6",Lc.g.Geometry,!0),this.registerInput("geometry7",Lc.g.Geometry,!0),this.registerInput("geometry8",Lc.g.Geometry,!0),this.registerInput("geometry9",Lc.g.Geometry,!0),this.registerOutput("output",Lc.g.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"GeometryCollectionBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get geometry5(){return this._inputs[5]}get geometry6(){return this._inputs[6]}get geometry7(){return this._inputs[7]}get geometry8(){return this._inputs[8]}get geometry9(){return this._inputs[9]}get output(){return this._outputs[0]}_storeGeometry(e,t,i,s){if(e.isConnected){const r=e.getConnectedValue(t);r.metadata=r.metadata||{},r.metadata.collectionId=i,s.push(r)}}_buildBlock(e){const t=e=>{const t=[];return this._storeGeometry(this.geometry0,e,0,t),this._storeGeometry(this.geometry1,e,1,t),this._storeGeometry(this.geometry2,e,2,t),this._storeGeometry(this.geometry3,e,3,t),this._storeGeometry(this.geometry4,e,4,t),this._storeGeometry(this.geometry5,e,5,t),this._storeGeometry(this.geometry6,e,6,t),this._storeGeometry(this.geometry7,e,7,t),this._storeGeometry(this.geometry8,e,8,t),this._storeGeometry(this.geometry9,e,9,t),t.length?t[Math.round(Math.random()*(t.length-1))]:null};this.evaluateContext?this.output._storedFunction=t:this.output._storedValue=t(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],du.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.GeometryCollectionBlock",du);class pu extends Nc.s{constructor(e){super(e),this.registerInput("input",Lc.g.AutoDetect),this.registerOutput("output",Lc.g.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return 0}getClassName(){return"GeometryElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];t._storedFunction=e=>i.getConnectedValue(e)}}(0,c.H)("BABYLON.GeometryElbowBlock",pu);class _u extends Nc.s{constructor(e){super(e),this.registerInput("geometry",Lc.g.Geometry),this.registerOutput("output",Lc.g.Geometry)}getClassName(){return"ComputeNormalsBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e);return t.normals||(t.normals=[]),gi.x.ComputeNormals(t.positions,t.indices,t.normals),t}}}(0,c.H)("BABYLON.ComputeNormalsBlock",_u);class gu extends Nc.s{constructor(e){super(e),this.registerInput("xyzw ",Lc.g.Vector4,!0),this.registerInput("xyz ",Lc.g.Vector3,!0),this.registerInput("xy ",Lc.g.Vector2,!0),this.registerInput("zw ",Lc.g.Vector2,!0),this.registerInput("x ",Lc.g.Float,!0),this.registerInput("y ",Lc.g.Float,!0),this.registerInput("z ",Lc.g.Float,!0),this.registerInput("w ",Lc.g.Float,!0),this.registerOutput("xyzw",Lc.g.Vector4),this.registerOutput("xyz",Lc.g.Vector3),this.registerOutput("xy",Lc.g.Vector2),this.registerOutput("zw",Lc.g.Vector2),this.registerOutput("x",Lc.g.Float),this.registerOutput("y",Lc.g.Float),this.registerOutput("z",Lc.g.Float),this.registerOutput("w",Lc.g.Float)}getClassName(){return"VectorConverterBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get xIn(){return this._inputs[4]}get yIn(){return this._inputs[5]}get zIn(){return this._inputs[6]}get wIn(){return this._inputs[7]}get xyzwOut(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xOut(){return this._outputs[4]}get yOut(){return this._outputs[5]}get zOut(){return this._outputs[6]}get wOut(){return this._outputs[7]}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":"x "===e?"xIn":"y "===e?"yIn":"z "===e?"zIn":"w "===e?"wIn":e}_outputRename(e){switch(e){case"x":return"xOut";case"y":return"yOut";case"z":return"zOut";case"w":return"wOut";case"xy":return"xyOut";case"zw":return"zwOut";case"xyz":return"xyzOut";case"xyzw":return"xyzwOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xIn,i=this.yIn,s=this.zIn,r=this.wIn,n=this.xyIn,o=this.zwIn,a=this.xyzIn,h=this.xyzwIn,l=this.xyzwOut,c=this.xyzOut,u=this.xyOut,d=this.zwOut,p=this.xOut,_=this.yOut,g=this.zOut,f=this.wOut,b=e=>{if(h.isConnected)return h.getConnectedValue(e);let l=0,c=0,u=0,d=0;if(t.isConnected&&(l=t.getConnectedValue(e)),i.isConnected&&(c=i.getConnectedValue(e)),s.isConnected&&(u=s.getConnectedValue(e)),r.isConnected&&(d=r.getConnectedValue(e)),n.isConnected){const t=n.getConnectedValue(e);t&&(l=t.x,c=t.y)}if(o.isConnected){const t=o.getConnectedValue(e);t&&(u=t.x,d=t.y)}if(a.isConnected){const t=a.getConnectedValue(e);t&&(l=t.x,c=t.y,u=t.z)}return new m.Lt(l,c,u,d)};l._storedFunction=e=>b(e),c._storedFunction=e=>{const t=b(e);return new m.P(t.x,t.y,t.z)},u._storedFunction=e=>{const t=b(e);return new m.FM(t.x,t.y)},d._storedFunction=e=>{const t=b(e);return new m.FM(t.z,t.w)},p._storedFunction=e=>b(e).x,_._storedFunction=e=>b(e).y,g._storedFunction=e=>b(e).z,f._storedFunction=e=>b(e).w}}(0,c.H)("BABYLON.VectorConverterBlock",gu);class mu extends Nc.s{constructor(e){super(e),this.registerInput("input",Lc.g.AutoDetect),this.registerOutput("output",Lc.g.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Float),this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NormalizeVectorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.output._storedFunction=null,this.input.isConnected?this.output._storedFunction=e=>this.input.getConnectedValue(e).normalize():this.output._storedValue=null}}(0,c.H)("BABYLON.NormalizeVectorBlock",mu);class fu extends Nc.s{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Lc.g.Geometry),this.registerInput("id",Lc.g.Int,!0,0),this.registerOutput("output",Lc.g.Geometry),this.id.acceptedConnectionPointTypes.push(Lc.g.Float)}getClassName(){return"SetMaterialIDBlock"}get geometry(){return this._inputs[0]}get id(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.geometry.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const t=e=>{const t=this.geometry.getConnectedValue(e);if(!t||!t.indices||!t.positions)return t;const i=new gi.D;return i.materialIndex=0|this.id.getConnectedValue(e),i.indexStart=0,i.indexCount=t.indices.length,i.verticesStart=0,i.verticesCount=t.positions.length/3,t.materialInfos=[i],t};this.evaluateContext?this.output._storedFunction=t:this.output._storedValue=t(e)}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],fu.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.SetMaterialIDBlock",fu),function(e){e[e.Cos=0]="Cos",e[e.Sin=1]="Sin",e[e.Abs=2]="Abs",e[e.Exp=3]="Exp",e[e.Round=4]="Round",e[e.Floor=5]="Floor",e[e.Ceiling=6]="Ceiling",e[e.Sqrt=7]="Sqrt",e[e.Log=8]="Log",e[e.Tan=9]="Tan",e[e.ArcTan=10]="ArcTan",e[e.ArcCos=11]="ArcCos",e[e.ArcSin=12]="ArcSin",e[e.Sign=13]="Sign",e[e.Negate=14]="Negate",e[e.OneMinus=15]="OneMinus",e[e.Reciprocal=16]="Reciprocal",e[e.ToDegrees=17]="ToDegrees",e[e.ToRadians=18]="ToRadians"}(Uc||(Uc={}));class bu extends Nc.s{constructor(e){super(e),this.operation=Uc.Cos,this.registerInput("input",Lc.g.AutoDetect),this.registerOutput("output",Lc.g.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Geometry)}getClassName(){return"GeometryTrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.operation){case Uc.Cos:t=e=>Math.cos(e);break;case Uc.Sin:t=e=>Math.sin(e);break;case Uc.Abs:t=e=>Math.abs(e);break;case Uc.Exp:t=e=>Math.exp(e);break;case Uc.Round:t=e=>Math.round(e);break;case Uc.Floor:t=e=>Math.floor(e);break;case Uc.Ceiling:t=e=>Math.ceil(e);break;case Uc.Sqrt:t=e=>Math.sqrt(e);break;case Uc.Log:t=e=>Math.log(e);break;case Uc.Tan:t=e=>Math.tan(e);break;case Uc.ArcTan:t=e=>Math.atan(e);break;case Uc.ArcCos:t=e=>Math.acos(e);break;case Uc.ArcSin:t=e=>Math.asin(e);break;case Uc.Sign:t=e=>Math.sign(e);break;case Uc.Negate:t=e=>-e;break;case Uc.OneMinus:t=e=>1-e;break;case Uc.Reciprocal:t=e=>1/e;break;case Uc.ToRadians:t=e=>e*Math.PI/180;break;case Uc.ToDegrees:t=e=>180*e/Math.PI}if(!t)return this.input._storedFunction=null,void(this.input._storedValue=null);switch(this.input.type){case Lc.g.Int:case Lc.g.Float:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return t(i)};break;case Lc.g.Vector2:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new m.FM(t(i.x),t(i.y))};break;case Lc.g.Vector3:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new m.P(t(i.x),t(i.y),t(i.z))};break;case Lc.g.Vector4:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new m.Lt(t(i.x),t(i.y),t(i.z),t(i.w))}}return this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.GeometryTrigonometryBlockOperations.${Uc[this.operation]};\n`}}(0,H.gn)([(0,ga.p)("Operation",ga.U.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Cos",value:Uc.Cos},{label:"Sin",value:Uc.Sin},{label:"Abs",value:Uc.Abs},{label:"Exp",value:Uc.Exp},{label:"Round",value:Uc.Round},{label:"Floor",value:Uc.Floor},{label:"Ceiling",value:Uc.Ceiling},{label:"Sqrt",value:Uc.Sqrt},{label:"Log",value:Uc.Log},{label:"Tan",value:Uc.Tan},{label:"ArcTan",value:Uc.ArcTan},{label:"ArcCos",value:Uc.ArcCos},{label:"ArcSin",value:Uc.ArcSin},{label:"Sign",value:Uc.Sign},{label:"Negate",value:Uc.Negate},{label:"OneMinus",value:Uc.OneMinus},{label:"Reciprocal",value:Uc.Reciprocal},{label:"ToDegrees",value:Uc.ToDegrees},{label:"ToRadians",value:Uc.ToRadians}]})],bu.prototype,"operation",void 0),(0,c.H)("BABYLON.GeometryTrigonometryBlock",bu);class vu extends Nc.s{constructor(e){super(e),this._rotationMatrix=new m.y3,this._scalingMatrix=new m.y3,this._translationMatrix=new m.y3,this._scalingRotationMatrix=new m.y3,this._transformMatrix=new m.y3,this.evaluateContext=!0,this.registerInput("value",Lc.g.AutoDetect),this.registerInput("matrix",Lc.g.Matrix,!0),this.registerInput("translation",Lc.g.Vector3,!0,m.P.Zero()),this.registerInput("rotation",Lc.g.Vector3,!0,m.P.Zero()),this.registerInput("scaling",Lc.g.Vector3,!0,m.P.One()),this.registerOutput("output",Lc.g.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Float),this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Matrix)}getClassName(){return"GeometryTransformBlock"}get value(){return this._inputs[0]}get matrix(){return this._inputs[1]}get translation(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const t=e=>{const t=this.value.getConnectedValue(e);if(!t)return null;let i;if(this.matrix.isConnected)i=this.matrix.getConnectedValue(e);else{const t=this.scaling.getConnectedValue(e),s=this.rotation.getConnectedValue(e),r=this.translation.getConnectedValue(e);m.y3.ScalingToRef(t.x,t.y,t.z,this._scalingMatrix),m.y3.RotationYawPitchRollToRef(s.y,s.x,s.z,this._rotationMatrix),m.y3.TranslationToRef(r.x,r.y,r.z,this._translationMatrix),this._scalingMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._translationMatrix,this._transformMatrix),i=this._transformMatrix}switch(this.value.type){case Lc.g.Geometry:{const e=t.clone();return e.transform(i),e}case Lc.g.Vector2:return m.FM.Transform(t,i);case Lc.g.Vector3:return m.P.TransformCoordinates(t,i);case Lc.g.Vector4:return m.Lt.TransformCoordinates(t,i)}return null};this.evaluateContext?this.output._storedFunction=t:this.output._storedValue=t(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],vu.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.GeometryTransformBlock",vu);class yu extends Nc.s{constructor(e){super(e),this.registerInput("angle",Lc.g.Float,!1,0),this.registerOutput("matrix",Lc.g.Matrix)}getClassName(){return"RotationXBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new Hc.p("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>m.y3.RotationX(this.angle.getConnectedValue(e))}}(0,c.H)("BABYLON.RotationXBlock",yu);class xu extends Nc.s{constructor(e){super(e),this.registerInput("angle",Lc.g.Float,!1,0),this.registerOutput("matrix",Lc.g.Matrix)}getClassName(){return"RotationYBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new Hc.p("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>m.y3.RotationY(this.angle.getConnectedValue(e))}}(0,c.H)("BABYLON.RotationYBlock",xu);class Pu extends Nc.s{constructor(e){super(e),this.registerInput("angle",Lc.g.Float,!1,0),this.registerOutput("matrix",Lc.g.Matrix)}getClassName(){return"RotationZBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new Hc.p("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>m.y3.RotationZ(this.angle.getConnectedValue(e))}}(0,c.H)("BABYLON.RotationZBlock",Pu);class Cu extends Nc.s{constructor(e){super(e),this.registerInput("scale",Lc.g.Vector3,!1,m.P.One()),this.registerOutput("matrix",Lc.g.Matrix)}getClassName(){return"ScalingBlock"}get scale(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.scale.isConnected){const e=new Hc.p("Scale");e.value=new m.P(1,1,1),e.output.connectTo(this.scale)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.scale.getConnectedValue(e);return m.y3.Scaling(t.x,t.y,t.z)}}}(0,c.H)("BABYLON.ScalingBlock",Cu);class Tu extends Nc.s{constructor(e){super(e),this.registerInput("source",Lc.g.Vector3,!0,m.P.Up()),this.registerInput("target",Lc.g.Vector3,!0,m.P.Left()),this.registerOutput("matrix",Lc.g.Matrix)}getClassName(){return"AlignBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.source.getConnectedValue(e).clone(),i=this.target.getConnectedValue(e).clone(),s=new m.y3;return t.normalize(),i.normalize(),m.y3.RotationAlignToRef(t,i,s),s}}}(0,c.H)("BABYLON.AlignBlock",Tu);class Su extends Nc.s{constructor(e){super(e),this.registerInput("translation",Lc.g.Vector3,!1,m.P.Zero()),this.registerOutput("matrix",Lc.g.Matrix)}getClassName(){return"TranslationBlock"}get translation(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.translation.isConnected){const e=new Hc.p("Translation");e.value=new m.P(0,0,0),e.output.connectTo(this.translation)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.translation.getConnectedValue(e);return m.y3.Translation(t.x,t.y,t.z)}}}(0,c.H)("BABYLON.TranslationBlock",Su);class Eu extends Nc.s{constructor(e){super(e),this._indexTranslation=null,this.evaluateContext=!0,this.removeDuplicatedPositions=!0,this.registerInput("geometry",Lc.g.Geometry),this.registerInput("instance",Lc.g.Geometry,!0),this.registerInput("rotation",Lc.g.Vector3,!0,m.P.Zero()),this.registerInput("scaling",Lc.g.Vector3,!0,m.P.One()),this.registerInput("matrix",Lc.g.Matrix,!0),this.registerInput("density",Lc.g.Float,!0,1,0,1),this.scaling.acceptedConnectionPointTypes.push(Lc.g.Float),this.registerOutput("output",Lc.g.Geometry)}getExecutionIndex(){return this._indexTranslation?this._indexTranslation[this._currentIndex]:this._currentIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateOnVerticesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get rotation(){return this._inputs[2]}get scaling(){return this._inputs[3]}get matrix(){return this._inputs[4]}get density(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.executionContext=this,this._vertexData=this.geometry.getConnectedValue(e),e.geometryContext=this._vertexData,!this._vertexData||!this._vertexData.positions||!this.instance.isConnected)return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=null);let t=this._vertexData.positions.length/3;const i=[],s=new m.P,r=new Array;let n=this._vertexData.positions;if(this._currentLoopIndex=0,this.removeDuplicatedPositions){for(this._indexTranslation={},this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const e=n[3*this._currentIndex],t=n[3*this._currentIndex+1],i=n[3*this._currentIndex+2];let s=!1;for(let n=0;n<r.length;n+=3)if(Math.abs(r[n]-e)<Ns.kn&&Math.abs(r[n+1]-t)<Ns.kn&&Math.abs(r[n+2]-i)<Ns.kn){s=!0;break}s||(this._indexTranslation[r.length/3]=this._currentIndex,r.push(e,t,i))}n=r,t=n.length/3}else this._indexTranslation=null;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;const r=this.density.getConnectedValue(e);if(r<1&&Math.random()>r)continue;s.fromArray(n,3*this._currentIndex);const o=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithMatrix(o,t,i)}else{const t=e.adaptInput(this.scaling,Lc.g.Vector3,m.P.OneReadOnly),r=this.rotation.getConnectedValue(e)||m.P.ZeroReadOnly;e._instantiate(o,s,r,t,i)}this._currentLoopIndex++}if(i.length)if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return this._vertexData};this.evaluateContext?this.output._storedFunction=t:this.output._storedValue=t(e)}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.removeDuplicatedPositions = ${this.removeDuplicatedPositions?"true":"false"};\n`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.removeDuplicatedPositions=this.removeDuplicatedPositions,e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.removeDuplicatedPositions=e.removeDuplicatedPositions,void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Eu.prototype,"evaluateContext",void 0),(0,H.gn)([(0,ga.p)("Remove duplicated positions",ga.U.Boolean,"ADVANCED",{notifiers:{update:!0}})],Eu.prototype,"removeDuplicatedPositions",void 0),(0,c.H)("BABYLON.InstantiateOnVerticesBlock",Eu);class Ru extends Nc.s{constructor(e){super(e),this._currentPosition=new m.P,this._vertex0=new m.P,this._vertex1=new m.P,this._vertex2=new m.P,this._tempVector0=new m.P,this._tempVector1=new m.P,this.evaluateContext=!0,this.registerInput("geometry",Lc.g.Geometry),this.registerInput("instance",Lc.g.Geometry,!0),this.registerInput("rotation",Lc.g.Vector3,!0,m.P.Zero()),this.registerInput("scaling",Lc.g.Vector3,!0,m.P.One()),this.registerInput("matrix",Lc.g.Matrix,!0),this.registerInput("count",Lc.g.Int,!0,256),this.scaling.acceptedConnectionPointTypes.push(Lc.g.Float),this.registerOutput("output",Lc.g.Geometry)}getExecutionIndex(){return 0}getExecutionFaceIndex(){return this._currentFaceIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getOverrideNormalsContextualValue(){return this._vertex1.subtractToRef(this._vertex0,this._tempVector0),this._vertex2.subtractToRef(this._vertex1,this._tempVector1),this._tempVector0.normalize(),this._tempVector1.normalize(),m.P.Cross(this._tempVector1,this._tempVector0)}getClassName(){return"InstantiateOnFacesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get rotation(){return this._inputs[2]}get scaling(){return this._inputs[3]}get matrix(){return this._inputs[4]}get count(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.executionContext=this,this._vertexData=this.geometry.getConnectedValue(e),e.geometryContext=this._vertexData,!(this._vertexData&&this._vertexData.positions&&this._vertexData.indices&&this.instance.isConnected))return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=null);let t=null;const i=this.count.getConnectedValue(e),s=this._vertexData.indices.length/3,r=i/s;let n=0;const o=[];let a=0;for(this._currentLoopIndex=0,this._currentFaceIndex=0;this._currentFaceIndex<s;this._currentFaceIndex++){this._vertex0.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*this._currentFaceIndex]),this._vertex1.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*this._currentFaceIndex+1]),this._vertex2.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*this._currentFaceIndex+2]),n+=r;const s=(0|n)-a;if(!(s<1))for(let r=0;r<s&&!(a>=i);r++){let i=Math.random(),s=Math.random();if(i>s){const e=i;i=s,s=e}const r=i,n=s-i,h=1-r-n;if(this._currentPosition.set(r*this._vertex0.x+n*this._vertex1.x+h*this._vertex2.x,r*this._vertex0.y+n*this._vertex1.y+h*this._vertex2.y,r*this._vertex0.z+n*this._vertex1.z+h*this._vertex2.z),t=this.instance.getConnectedValue(e),!t||!t.positions||0===t.positions.length)continue;const l=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithMatrix(l,t,o)}else{const t=e.adaptInput(this.scaling,Lc.g.Vector3,m.P.OneReadOnly),i=this.rotation.getConnectedValue(e)||m.P.ZeroReadOnly;e._instantiate(l,this._currentPosition,i,t,o)}a++,this._currentLoopIndex++}}if(o.length)if(1===o.length)this._vertexData=o[0];else{const e=o.splice(0,1)[0];this._vertexData=e.merge(o,!0,!1,!0,!0)}return this._vertexData};this.evaluateContext?this.output._storedFunction=t:this.output._storedValue=t(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Ru.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.InstantiateOnFacesBlock",Ru);class Mu extends Nc.s{constructor(e){super(e),this._currentPosition=new m.P,this._vertex0=new m.P,this._vertex1=new m.P,this._vertex2=new m.P,this.evaluateContext=!0,this.registerInput("geometry",Lc.g.Geometry),this.registerInput("instance",Lc.g.Geometry,!0),this.registerInput("rotation",Lc.g.Vector3,!0,m.P.Zero()),this.registerInput("scaling",Lc.g.Vector3,!0,m.P.One()),this.registerInput("matrix",Lc.g.Matrix,!0),this.registerInput("count",Lc.g.Int,!0,256),this.scaling.acceptedConnectionPointTypes.push(Lc.g.Float),this.registerOutput("output",Lc.g.Geometry)}getExecutionIndex(){return 0}getExecutionFaceIndex(){return 0}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getClassName(){return"InstantiateOnVolumeBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get rotation(){return this._inputs[2]}get scaling(){return this._inputs[3]}get matrix(){return this._inputs[4]}get count(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.executionContext=this,this._vertexData=this.geometry.getConnectedValue(e),e.geometryContext=this._vertexData,!(this._vertexData&&this._vertexData.positions&&this._vertexData.indices&&this.instance.isConnected))return e.executionContext=null,e.geometryContext=null,void(this.output._storedValue=null);let t=null;const i=this.count.getConnectedValue(e),s=[],r=(0,wl.k)(this._vertexData.positions,0,this._vertexData.positions.length/3),n=r.minimum,o=r.maximum,a=new m.P(1,0,0),h=this._vertexData.indices.length/3;this._currentLoopIndex=0;for(let r=0;r<i;r++){this._currentPosition.set(Math.random()*(o.x-n.x)+n.x,Math.random()*(o.y-n.y)+n.y,Math.random()*(o.z-n.z)+n.z);const i=new At.z(this._currentPosition,a);let l=0;for(let e=0;e<h;e++){this._vertex0.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e]),this._vertex1.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e+1]),this._vertex2.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e+2]);const t=i.intersectsTriangle(this._vertex0,this._vertex1,this._vertex2);t&&t.distance>0&&l++}if(l%2==0){r--;continue}if(t=this.instance.getConnectedValue(e),!t||!t.positions||0===t.positions.length)continue;const c=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithMatrix(c,t,s)}else{const t=e.adaptInput(this.scaling,Lc.g.Vector3,m.P.OneReadOnly),i=this.rotation.getConnectedValue(e)||m.P.ZeroReadOnly;e._instantiate(c,this._currentPosition,i,t,s)}this._currentLoopIndex++}if(s.length)if(1===s.length)this._vertexData=s[0];else{const e=s.splice(0,1)[0];this._vertexData=e.merge(s,!0,!1,!0,!0)}return this._vertexData};this.evaluateContext?this.output._storedFunction=t:this.output._storedValue=t(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Mu.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.InstantiateOnVolumeBlock",Mu);class Au extends Nc.s{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("instance",Lc.g.Geometry,!0),this.registerInput("count",Lc.g.Int,!0,1),this.registerInput("position",Lc.g.Vector3,!0,m.P.Zero()),this.registerInput("rotation",Lc.g.Vector3,!0,m.P.Zero()),this.registerInput("scaling",Lc.g.Vector3,!0,m.P.One()),this.registerInput("matrix",Lc.g.Matrix,!0),this.scaling.acceptedConnectionPointTypes.push(Lc.g.Float),this.registerOutput("output",Lc.g.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBlock"}get instance(){return this._inputs[0]}get count(){return this._inputs[1]}get position(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}get matrix(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{e.executionContext=this;const t=this.count.getConnectedValue(e),i=[];for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;const s=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithMatrix(s,t,i)}else{const t=this.position.getConnectedValue(e)||m.P.ZeroReadOnly,r=e.adaptInput(this.scaling,Lc.g.Vector3,m.P.OneReadOnly),n=this.rotation.getConnectedValue(e)||m.P.ZeroReadOnly;e._instantiate(s,t,n,r,i)}}if(i.length)if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return this._vertexData};this.evaluateContext?this.output._storedFunction=t:this.output._storedValue=t(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,H.gn)([(0,ga.p)("Evaluate context",ga.U.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Au.prototype,"evaluateContext",void 0),(0,c.H)("BABYLON.InstantiateBlock",Au);class Iu extends Nc.s{constructor(e){super(e),this.registerInput("float ",Lc.g.Float,!0),this.registerInput("int ",Lc.g.Int,!0),this.registerOutput("float",Lc.g.Float),this.registerOutput("int",Lc.g.Int)}getClassName(){return"IntFloatConverterBlock"}get floatIn(){return this._inputs[0]}get intIn(){return this._inputs[1]}get floatOut(){return this._outputs[0]}get intOut(){return this._outputs[1]}_inputRename(e){return"float "===e?"floatIn":"int "===e?"intIn":e}_buildBlock(){this.floatOut._storedFunction=e=>this.floatIn.isConnected?this.floatIn.getConnectedValue(e):this.intIn.isConnected?this.intIn.getConnectedValue(e):0,this.intOut._storedFunction=e=>this.floatIn.isConnected?0|this.floatIn.getConnectedValue(e):this.intIn.isConnected?0|this.intIn.getConnectedValue(e):0}}(0,c.H)("BABYLON.IntFloatConverterBlock",Iu);class Ou extends Nc.s{constructor(e){super(e),this.log=[],this.registerInput("input",Lc.g.AutoDetect),this.registerOutput("output",Lc.g.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Lc.g.Geometry)}get buildExecutionTime(){return 0}getClassName(){return"DebugBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.input.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);this.log=[],this.output._storedFunction=e=>{const t=this.input.getConnectedValue(e);return this.log.push(null!=t?t.toString():"null"),t}}}(0,c.H)("BABYLON.DebugBlock",Ou);class wu extends Nc.s{constructor(e){super(e),this.registerInput("geometry",Lc.g.Geometry),this.registerOutput("output",Lc.g.Geometry),this.registerOutput("id",Lc.g.Int),this.registerOutput("collectionId",Lc.g.Int),this.registerOutput("verticesCount",Lc.g.Int),this.registerOutput("facesCount",Lc.g.Int)}getClassName(){return"GeometryInfoBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}get id(){return this._outputs[1]}get collectionId(){return this._outputs[2]}get verticesCount(){return this._outputs[3]}get facesCount(){return this._outputs[4]}_buildBlock(){if(!this.geometry.isConnected)return this.id._storedValue=0,this.collectionId._storedValue=0,this.verticesCount._storedValue=0,this.facesCount._storedValue=0,this.output._storedValue=0,this.id._storedFunction=null,this.collectionId._storedFunction=null,this.verticesCount._storedFunction=null,this.facesCount._storedFunction=null,void(this.output._storedFunction=null);this.output._storedFunction=e=>this._currentVertexData||this.geometry.getConnectedValue(e),this.id._storedFunction=e=>(this._currentVertexData=this.geometry.getConnectedValue(e),this._currentVertexData.uniqueId),this.collectionId._storedFunction=e=>(this._currentVertexData=this.geometry.getConnectedValue(e),this._currentVertexData.metadata?this._currentVertexData.metadata.collectionId:0),this.verticesCount._storedFunction=e=>(this._currentVertexData=this.geometry.getConnectedValue(e),this._currentVertexData.positions?this._currentVertexData.positions.length/3:0),this.facesCount._storedFunction=e=>(this._currentVertexData=this.geometry.getConnectedValue(e),this._currentVertexData.indices?this._currentVertexData.indices.length/3:0)}}(0,c.H)("BABYLON.GeometryInfoBlock",wu),function(e){e[e.Spherical=0]="Spherical",e[e.Cylindrical=1]="Cylindrical",e[e.Cubic=2]="Cubic"}(Wc||(Wc={}));class Du extends Nc.s{constructor(e){super(e),this.mapping=Wc.Spherical,this.registerInput("position",Lc.g.Vector3),this.registerInput("center",Lc.g.Vector3,!0,m.P.Zero()),this.registerOutput("uv",Lc.g.Vector2)}getClassName(){return"MappingBlock"}get position(){return this._inputs[0]}get center(){return this._inputs[1]}get uv(){return this._outputs[0]}_buildBlock(){if(!this.position.isConnected)return this.uv._storedFunction=null,void(this.uv._storedValue=null);const e=m.P.Zero(),t=t=>{const i=this.position.getConnectedValue(t),s=this.center.getConnectedValue(t),r=m.FM.Zero();switch(this.mapping){case Wc.Spherical:{i.subtractToRef(s,e);const t=e.length();t>0&&(r.x=Math.acos(e.y/t)/Math.PI,0===e.x&&0===e.z||(r.y=Math.atan2(e.x,e.z)/(2*Math.PI)));break}case Wc.Cylindrical:{i.subtractToRef(s,e);const t=e.length();t>0&&(r.x=Math.atan2(e.x/t,e.z/t)/(2*Math.PI),r.y=(e.y+1)/2);break}case Wc.Cubic:{const e=Math.abs(i.x),t=Math.abs(i.y),n=Math.abs(i.z);let o=0,a=0;e>=t&&e>=n?(o=i.y-s.y,a=i.z-s.z):t>=e&&t>=n?(o=i.x-s.x,a=i.z-s.z):(o=i.x-s.x,a=i.y-s.y),r.x=.5*o+.5,r.y=.5*a+.5;break}}return r};this.uv._storedFunction=e=>t(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.mapping = BABYLON.MappingTypes.${Wc[this.mapping]};\n`}serialize(){const e=super.serialize();return e.mapping=this.mapping,e}_deserialize(e){super._deserialize(e),this.mapping=e.mapping}}(0,H.gn)([(0,ga.p)("Mapping",ga.U.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Spherical",value:Wc.Spherical},{label:"Cylindrical",value:Wc.Cylindrical},{label:"Cubic",value:Wc.Cubic}]})],Du.prototype,"mapping",void 0),(0,c.H)("BABYLON.MappingBlock",Du);class Bu extends Nc.s{get endpoints(){return this._endpoints}constructor(e){super(e),this._endpoints=[],this.registerInput("input",Lc.g.AutoDetect)}getClassName(){return"TeleportInBlock"}get input(){return this._inputs[0]}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const s of this.endpoints)-1===t.indexOf(s)&&(i+=s._dumpCode(e,t));return i}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}_buildBlock(){for(const e of this._endpoints)e.output._storedFunction=e=>this.input.getConnectedValue(e)}}(0,c.H)("BABYLON.TeleportInBlock",Bu);class Nu extends Nc.s{constructor(e){super(e),this._entryPoint=null,this._tempEntryPointUniqueId=null,this.registerOutput("output",Lc.g.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"TeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}clone(){const e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){var e,t;const i=super.serialize();return i.entryPoint=null!==(t=null===(e=this.entryPoint)||void 0===e?void 0:e.uniqueId)&&void 0!==t?t:"",i}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}}(0,c.H)("BABYLON.TeleportOutBlock",Nu);var Fu=i(22590),Lu=(i(94733),i(33852));O.D.OfflineProviderFactory=(e,t,i=!1)=>new Vu(e,t,i);class Vu{get enableSceneOffline(){return this._enableSceneOffline}get enableTexturesOffline(){return this._enableTexturesOffline}constructor(e,t,i=!1){this._idbFactory="undefined"!=typeof indexedDB?indexedDB:void 0,this._currentSceneUrl=Vu._ReturnFullUrlLocation(e),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,Vu.IDBStorageEnabled?i?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,w.w1.SetImmediate((()=>{t(!0)}))):this._checkManifestFile(t):t(!0)}_checkManifestFile(e){const t=()=>{this._enableSceneOffline=!1,this._enableTexturesOffline=!1,e(!1)},i=()=>{try{if("function"==typeof URL&&0===this._currentSceneUrl.indexOf("http")){const e=new URL(this._currentSceneUrl);return e.pathname+=".manifest",e.toString()}}catch(e){}return`${this._currentSceneUrl}.manifest`};let s=!1,r=i();const n=new zo.g;navigator.onLine&&(s=!0,r=r+(null==r.match(/\?/)?"?":"&")+Date.now()),n.open("GET",r),n.addEventListener("load",(()=>{if(200===n.status||Vu._ValidateXHRData(n,1))try{const t=JSON.parse(n.response);this._enableSceneOffline=t.enableSceneOffline,this._enableTexturesOffline=t.enableTexturesOffline&&Vu._IsUASupportingBlobStorage,t.version&&!isNaN(parseInt(t.version))&&(this._manifestVersionFound=t.version),e(!0)}catch(e){t()}else t()}),!1),n.addEventListener("error",(()=>{if(s){s=!1;const e=i();n.open("GET",e),n.send()}else t()}),!1);try{n.send()}catch(t){p.Y.Error("Error on XHR send request."),e(!1)}}open(e,t){const i=()=>{this._isSupported=!1,t&&t()};if(this._idbFactory&&(this._enableSceneOffline||this._enableTexturesOffline))if(this._db)e&&e();else{this._hasReachedQuota=!1,this._isSupported=!0;const t=this._idbFactory.open("babylonjs",1);t.onerror=()=>{i()},t.onblocked=()=>{p.Y.Error("IDB request blocked. Please reload the page."),i()},t.onsuccess=()=>{this._db=t.result,e()},t.onupgradeneeded=e=>{if(this._db=e.target.result,this._db)try{this._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),this._db.createObjectStore("versions",{keyPath:"sceneUrl"}),this._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(e){p.Y.Error("Error while creating object stores. Exception: "+e.message),i()}}}else this._isSupported=!1,t&&t()}loadImage(e,t){const i=Vu._ReturnFullUrlLocation(e),s=()=>{this._hasReachedQuota||null===this._db?t.src=e:this._saveImageIntoDBAsync(i,t)};this._mustUpdateRessources?s():this._loadImageFromDBAsync(i,t,s)}_loadImageFromDBAsync(e,t,i){if(this._isSupported&&null!==this._db){let s;const r=this._db.transaction(["textures"]);r.onabort=()=>{t.src=e},r.oncomplete=()=>{let r;s&&"function"==typeof URL?(r=URL.createObjectURL(s.data),t.onerror=()=>{p.Y.Error("Error loading image from blob URL: "+r+" switching back to web url: "+e),t.src=e},t.src=r):i()};const n=r.objectStore("textures").get(e);n.onsuccess=e=>{s=e.target.result},n.onerror=()=>{p.Y.Error("Error loading texture "+e+" from DB."),t.src=e}}else p.Y.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e}_saveImageIntoDBAsync(e,t){let i;if(this._isSupported){const s=()=>{let e;if(i&&"function"==typeof URL)try{e=URL.createObjectURL(i)}catch(t){e=URL.createObjectURL(i)}e&&(t.src=e)};if(Vu._IsUASupportingBlobStorage){const r=new zo.g;r.open("GET",e),r.responseType="blob",r.addEventListener("load",(()=>{if(200===r.status&&this._db){i=r.response;const n=this._db.transaction(["textures"],"readwrite");n.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}s()},n.oncomplete=()=>{s()};const o={textureUrl:e,data:i};try{const e=n.objectStore("textures").put(o);e.onsuccess=()=>{},e.onerror=()=>{s()}}catch(i){25===i.code&&(Vu._IsUASupportingBlobStorage=!1,this._enableTexturesOffline=!1),t.src=e}}else t.src=e}),!1),r.addEventListener("error",(()=>{p.Y.Error("Error in XHR request in BABYLON.Database."),t.src=e}),!1),r.send()}else t.src=e}else p.Y.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t.src=e}_checkVersionFromDB(e,t){this._loadVersionFromDBAsync(e,t,(()=>{this._saveVersionIntoDBAsync(e,t)}))}_loadVersionFromDBAsync(e,t,i){if(this._isSupported&&this._db){let s;try{const r=this._db.transaction(["versions"]);r.oncomplete=()=>{s?this._manifestVersionFound!==s.data?(this._mustUpdateRessources=!0,i()):t(s.data):(this._mustUpdateRessources=!0,i())},r.onabort=()=>{t(-1)};const n=r.objectStore("versions").get(e);n.onsuccess=e=>{s=e.target.result},n.onerror=()=>{p.Y.Error("Error loading version for scene "+e+" from DB."),t(-1)}}catch(e){p.Y.Error("Error while accessing 'versions' object store (READ OP). Exception: "+e.message),t(-1)}}else p.Y.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t(-1)}_saveVersionIntoDBAsync(e,t){if(this._isSupported&&!this._hasReachedQuota&&this._db)try{const i=this._db.transaction(["versions"],"readwrite");i.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}t(-1)},i.oncomplete=()=>{t(this._manifestVersionFound)};const s={sceneUrl:e,data:this._manifestVersionFound},r=i.objectStore("versions").put(s);r.onsuccess=()=>{},r.onerror=()=>{p.Y.Error("Error in DB add version request in BABYLON.Database.")}}catch(e){p.Y.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+e.message),t(-1)}else t(-1)}loadFile(e,t,i,s,r){const n=Vu._ReturnFullUrlLocation(e),o=()=>{this._saveFileAsync(n,t,i,r,s)};this._checkVersionFromDB(n,(e=>{-1!==e?this._mustUpdateRessources?this._saveFileAsync(n,t,i,r,s):this._loadFileAsync(n,t,o):s&&s()}))}_loadFileAsync(e,t,i){if(this._isSupported&&this._db){let s,r;s=-1!==e.indexOf(".babylon")?"scenes":"textures";const n=this._db.transaction([s]);n.oncomplete=()=>{r?t(r.data):i()},n.onabort=()=>{i()};const o=n.objectStore(s).get(e);o.onsuccess=e=>{r=e.target.result},o.onerror=()=>{p.Y.Error("Error loading file "+e+" from DB."),i()}}else p.Y.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()}_saveFileAsync(e,t,i,s,r){if(this._isSupported){let n;n=-1!==e.indexOf(".babylon")?"scenes":"textures";const o=new zo.g;let a;o.open("GET",e+(null==e.match(/\?/)?"?":"&")+Date.now()),s&&(o.responseType="arraybuffer"),i&&(o.onprogress=i),o.addEventListener("load",(()=>{if(200===o.status||o.status<400&&Vu._ValidateXHRData(o,s?6:1))if(a=s?o.response:o.responseText,!this._hasReachedQuota&&this._db){const i=this._db.transaction([n],"readwrite");let s;i.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}t(a)},i.oncomplete=()=>{t(a)},s="scenes"===n?{sceneUrl:e,data:a,version:this._manifestVersionFound}:{textureUrl:e,data:a};try{const e=i.objectStore(n).put(s);e.onsuccess=()=>{},e.onerror=()=>{p.Y.Error("Error in DB add file request in BABYLON.Database.")}}catch(e){t(a)}}else t(a);else o.status>=400&&r?r(o):t()}),!1),o.addEventListener("error",(()=>{p.Y.Error("error on XHR request."),r&&r()}),!1),o.send()}else p.Y.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),r&&r()}static _ValidateXHRData(e,t=7){try{if(1&t){if(e.responseText&&e.responseText.length>0)return!0;if(1===t)return!1}if(2&t){const i=go(e.response);if(i.width&&i.height&&i.width>0&&i.height>0)return!0;if(2===t)return!1}if(4&t){const t=new Uint8Array(e.response,0,3);return 68===t[0]&&68===t[1]&&83===t[2]}}catch(e){}return!1}}Vu._IsUASupportingBlobStorage=!0,Vu.IDBStorageEnabled=!1,Vu._ParseURL=e=>{document.createElement("a").href=e;const t=e.substring(0,e.lastIndexOf("#")),i=e.substring(t.lastIndexOf("/")+1,e.length);return e.substring(0,e.indexOf(i,0))},Vu._ReturnFullUrlLocation=e=>-1===e.indexOf("http:/")&&-1===e.indexOf("https:/")&&"undefined"!=typeof window?Vu._ParseURL(window.location.href)+e:e,i(37734);var ku=i(62508),zu=i(3003),Gu=i(38813),Uu=i(41314);i(18167),i(53606);class Wu{constructor(e,t){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=e,this._engine=t,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}contextLost(){this._updateEffect=void 0,this._renderVAO.length=0,this._updateVAO.length=0}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){var e,t;return null!==(t=null===(e=this._updateEffect)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}createUpdateBuffer(e){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof Gu.E&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=e,this._updateEffect=new Pi.Q("gpuUpdateParticles",this._updateEffectOptions,this._engine),new Uu.c(this._updateEffect)}createVertexBuffers(e,t){this._updateVAO.push(this._createUpdateVAO(e)),this._renderVAO.push(this._engine.recordVertexArrayObject(t,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null),this._renderVertexBuffers=t}createParticleBuffer(e){return e}bindDrawBuffers(e,t,i){i?this._engine.bindBuffers(this._renderVertexBuffers,i,t):this._engine.bindVertexArrayObject(this._renderVAO[e],null)}preUpdateParticleBuffer(){const e=this._engine;if(this._engine.enableEffect(this._updateEffect),!e.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(e,t,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[e],null);const s=this._engine;s.bindTransformFeedbackBuffer(t.getBuffer()),s.setRasterizerState(!1),s.beginTransformFeedback(!0),s.drawArraysType(3,0,i),s.endTransformFeedback(),s.setRasterizerState(!0),s.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO.length=0;for(let e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO.length=0}_createUpdateVAO(e){const t={};t.position=e.createVertexBuffer("position",0,3);let i=3;t.age=e.createVertexBuffer("age",i,1),i+=1,t.size=e.createVertexBuffer("size",i,3),i+=3,t.life=e.createVertexBuffer("life",i,1),i+=1,t.seed=e.createVertexBuffer("seed",i,4),i+=4,t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof Gu.E&&(t.initialPosition=e.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1));const s=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),s}}(0,c.H)("BABYLON.WebGL2ParticleSystem",Wu),i(91129);class Hu{constructor(e,t){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=e,this._engine=t}contextLost(){this._updateComputeShader=void 0,this._bufferComputeShader.length=0,this._renderVertexBuffers.length=0}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){var e,t;return null!==(t=null===(e=this._updateComputeShader)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}createUpdateBuffer(e){var t;const i={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(i.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(i.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(i.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(i.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(i.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(i.noiseTexture={group:1,binding:11}),this._updateComputeShader=new Kt.U("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:i,defines:e.split("\n")}),null===(t=this._simParamsComputeShader)||void 0===t||t.dispose(),this._simParamsComputeShader=new Zo.M(this._engine),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new Uu.c(this._simParamsComputeShader)}createVertexBuffers(e,t){this._renderVertexBuffers.push(t)}createParticleBuffer(e){const t=new be.N(this._engine,4*e.length,11);return t.update(e),this._bufferComputeShader.push(t),t.getBuffer()}bindDrawBuffers(e,t,i){this._engine.bindBuffers(this._renderVertexBuffers[e],i,t)}preUpdateParticleBuffer(){}updateParticleBuffer(e,t,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[e]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[1^e]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){var e;for(let e=0;e<this._bufferComputeShader.length;++e)this._bufferComputeShader[e].dispose();this._bufferComputeShader.length=0,null===(e=this._simParamsComputeShader)||void 0===e||e.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}}(0,c.H)("BABYLON.ComputeShaderParticleSystem",Hu);var ju,$u=i(56472),Yu=(i(913),i(50020)),Xu=i(49792),Qu=i(8172);class qu{static CreateDefault(e,t=500,i,s=!1){let r;return r=s?new $u.h("default system",{capacity:t},i):new Qu.p("default system",t,i),r.emitter=e,r.particleTexture=new X.x("https://assets.babylonjs.com/textures/flare.png",r.getScene()),r.createConeEmitter(.1,Math.PI/4),r.color1=new g.HE(1,1,1,1),r.color2=new g.HE(1,1,1,1),r.colorDead=new g.HE(1,1,1,0),r.minSize=.1,r.maxSize=.1,r.minEmitPower=2,r.maxEmitPower=2,r.updateSpeed=1/60,r.emitRate=30,r}static CreateAsync(e,t,i=!1,s){t||(t=D.l.LastCreatedScene);const r={};return t.addPendingData(r),new Promise(((n,o)=>{if(i&&!$u.h.IsSupported)return t.removePendingData(r),o("Particle system with GPU is not supported.");w.w1.LoadFile(`${qu.BaseAssetsUrl}/systems/${e}.json`,(e=>{t.removePendingData(r);const o=JSON.parse(e.toString());return n(Xu.D.Parse(o,t,i,s))}),void 0,void 0,void 0,(()=>(t.removePendingData(r),o(`An error occurred with the creation of your particle system. Check if your type '${e}' exists.`))))}))}static ExportSet(e){const t=new Xu.D;for(const i of e)t.systems.push(i);return t}static ParseFromFileAsync(e,t,i,s=!1,r="",n){return new Promise(((o,a)=>{const h=new zo.g;h.addEventListener("readystatechange",(()=>{if(4==h.readyState)if(200==h.status){const t=JSON.parse(h.responseText);let a;a=s?$u.h.Parse(t,i,r,!1,n):Qu.p.Parse(t,i,r,!1,n),e&&(a.name=e),o(a)}else a("Unable to load the particle system")})),h.open("GET",t),h.send()}))}static ParseFromSnippetAsync(e,t,i=!1,s="",r){if("_BLANK"===e){const e=this.CreateDefault(null);return e.start(),Promise.resolve(e)}return new Promise(((n,o)=>{const a=new zo.g;a.addEventListener("readystatechange",(()=>{if(4==a.readyState)if(200==a.status){const o=JSON.parse(JSON.parse(a.responseText).jsonPayload),h=JSON.parse(o.particleSystem);let l;l=i?$u.h.Parse(h,t,s,!1,r):Qu.p.Parse(h,t,s,!1,r),l.snippetId=e,n(l)}else o("Unable to load the snippet "+e)})),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()}))}}qu.BaseAssetsUrl=Xu.D.BaseAssetsUrl,qu.SnippetUrl="https://snippet.babylonjs.com",qu.CreateFromSnippetAsync=qu.ParseFromSnippetAsync,i(60155);class Ku{getBoundingInfo(){return this._boundingInfo}get hasBoundingInfo(){return null!==this._boundingInfo}constructor(e,t,i,s,r,n,o,a,h=null,l=null){this.idx=0,this.id=0,this.color=new g.HE(1,1,1,1),this.position=m.P.Zero(),this.rotation=m.P.Zero(),this.scaling=m.P.One(),this.uvs=new m.Lt(0,0,1,1),this.velocity=m.P.Zero(),this.pivot=m.P.Zero(),this.translateFromPivot=!1,this.alive=!0,this.isVisible=!0,this._pos=0,this._ind=0,this.shapeId=0,this.idxInShape=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this.materialIndex=null,this.props=null,this.cullingStrategy=si.x.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this._globalPosition=m.P.Zero(),this.idx=e,this.id=t,this._pos=i,this._ind=s,this._model=r,this.shapeId=n,this.idxInShape=o,this._sps=a,h&&(this._modelBoundingInfo=h,this._boundingInfo=new Jt.j(h.minimum,h.maximum)),null!==l&&(this.materialIndex=l)}copyToRef(e){return e.position.copyFrom(this.position),e.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(e.rotationQuaternion?e.rotationQuaternion.copyFrom(this.rotationQuaternion):e.rotationQuaternion=this.rotationQuaternion.clone()),e.scaling.copyFrom(this.scaling),this.color&&(e.color?e.color.copyFrom(this.color):e.color=this.color.clone()),e.uvs.copyFrom(this.uvs),e.velocity.copyFrom(this.velocity),e.pivot.copyFrom(this.pivot),e.translateFromPivot=this.translateFromPivot,e.alive=this.alive,e.isVisible=this.isVisible,e.parentId=this.parentId,e.cullingStrategy=this.cullingStrategy,null!==this.materialIndex&&(e.materialIndex=this.materialIndex),this}get scale(){return this.scaling}set scale(e){this.scaling=e}get quaternion(){return this.rotationQuaternion}set quaternion(e){this.rotationQuaternion=e}intersectsMesh(e){return!(!this._boundingInfo||!e.hasBoundingInfo)&&(this._sps._bSphereOnly?ei.K.Intersects(this._boundingInfo.boundingSphere,e.getBoundingInfo().boundingSphere):this._boundingInfo.intersects(e.getBoundingInfo(),!1))}isInFrustum(e){return null!==this._boundingInfo&&this._boundingInfo.isInFrustum(e,this.cullingStrategy)}getRotationMatrix(e){let t;if(this.rotationQuaternion)t=this.rotationQuaternion;else{t=m.jp.Quaternion[0];const e=this.rotation;m._f.RotationYawPitchRollToRef(e.y,e.x,e.z,t)}t.toRotationMatrix(e)}}class Zu{get shapeID(){return this.shapeId}set shapeID(e){this.shapeId=e}constructor(e,t,i,s,r,n,o,a,h){this._indicesLength=0,this.shapeId=e,this._shape=t,this._indices=i,this._indicesLength=i.length,this._shapeUV=n,this._shapeColors=r,this._normals=s,this._positionFunction=o,this._vertexFunction=a,this._material=h}}class Ju{constructor(e,t,i,s){this.idx=0,this.ind=0,this.indicesLength=0,this.sqDistance=0,this.materialIndex=0,this.idx=e,this.ind=t,this.indicesLength=i,this.materialIndex=s}}class ed{constructor(){this.position=m.P.Zero(),this.color=new g.HE(1,1,1,1),this.uv=m.FM.Zero()}get x(){return this.position.x}set x(e){this.position.x=e}get y(){return this.position.y}set y(e){this.position.y=e}get z(){return this.position.z}set z(e){this.position.z=e}}class td{constructor(e,t,i){this.particles=new Array,this.nbParticles=0,this.billboard=!1,this.recomputeNormals=!1,this.counter=0,this.vars={},this._bSphereOnly=!1,this._bSphereRadiusFactor=1,this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._index=0,this._updatable=!0,this._pickable=!1,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._depthSort=!1,this._expandable=!1,this._shapeCounter=0,this._copy=new Ku(0,0,0,0,null,0,0,this),this._color=new g.HE(0,0,0,0),this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeParticleVertex=!1,this._computeBoundingBox=!1,this._autoFixFaceOrientation=!1,this._depthSortParticles=!0,this._mustUnrotateFixedNormals=!1,this._particlesIntersect=!1,this._needs32Bits=!1,this._isNotBuilt=!0,this._lastParticleId=0,this._idxOfId=[],this._multimaterialEnabled=!1,this._useModelMaterial=!1,this._depthSortFunction=(e,t)=>t.sqDistance-e.sqDistance,this._materialSortFunction=(e,t)=>e.materialIndex-t.materialIndex,this._autoUpdateSubMeshes=!1,this._recomputeInvisibles=!1,this.name=e,this._scene=t||D.l.LastCreatedScene,this._camera=t.activeCamera,this._pickable=!!i&&i.isPickable,this._depthSort=!!i&&i.enableDepthSort,this._multimaterialEnabled=!!i&&i.enableMultiMaterial,this._useModelMaterial=!!i&&i.useModelMaterial,this._multimaterialEnabled=!!this._useModelMaterial||this._multimaterialEnabled,this._expandable=!!i&&i.expandable,this._particlesIntersect=!!i&&i.particleIntersection,this._bSphereOnly=!!i&&i.boundingSphereOnly,this._bSphereRadiusFactor=i&&i.bSphereRadiusFactor?i.bSphereRadiusFactor:1,this._computeBoundingBox=!!(null==i?void 0:i.computeBoundingBox)&&i.computeBoundingBox,this._autoFixFaceOrientation=!!(null==i?void 0:i.autoFixFaceOrientation)&&i.autoFixFaceOrientation,i&&void 0!==i.updatable?this._updatable=i.updatable:this._updatable=!0,this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]),(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]),this._multimaterialEnabled&&(this._multimaterial=new hn.G(this.name+"MultiMaterial",this._scene),this._materials=[],this._materialIndexesById={}),this._tmpVertex=new ed}buildMesh(){if(!this._isNotBuilt&&this.mesh)return this.mesh;if(0===this.nbParticles&&!this.mesh){const e=(0,Ys.uH)("",{radius:1,tessellation:3},this._scene);this.addShape(e,1),e.dispose()}if(this._indices32=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),!this.mesh){const e=new Mt.Kj(this.name,this._scene);this.mesh=e}!this._updatable&&this._multimaterialEnabled&&this._sortParticlesByMaterial(),this.recomputeNormals&&gi.x.ComputeNormals(this._positions32,this._indices32,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals),this._mustUnrotateFixedNormals&&this._unrotateFixedNormals();const e=new gi.x;if(e.indices=this._depthSort?this._indices:this._indices32,e.set(this._positions32,me.o.PositionKind),e.set(this._normals32,me.o.NormalKind),this._uvs32.length>0&&e.set(this._uvs32,me.o.UVKind),this._colors32.length>0&&e.set(this._colors32,me.o.ColorKind),e.applyToMesh(this.mesh,this._updatable),this.mesh.isPickable=this._pickable,this._pickable){let e=0;for(let t=0;t<this.nbParticles;t++){const i=this.particles[t],s=i._model._indicesLength;for(let t=0;t<s;t++)if(0==t%3){const t={idx:i.idx,faceId:e};this.pickedParticles[e]=t,e++}}}return this._multimaterialEnabled&&this.setMultiMaterial(this._materials),this._expandable||(this._depthSort||this._multimaterialEnabled||this._autoFixFaceOrientation||(this._indices=null),this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0)),this._isNotBuilt=!1,this.recomputeNormals=!1,this._recomputeInvisibles=!0,this.mesh}_getUVKind(e,t){var i,s;return-1===t&&((null===(i=e.material)||void 0===i?void 0:i.diffuseTexture)?t=e.material.diffuseTexture.coordinatesIndex:(null===(s=e.material)||void 0===s?void 0:s.albedoTexture)&&(t=e.material.albedoTexture.coordinatesIndex)),"uv"+(t?t+1:"")}digest(e,t){var i;let s=t&&t.facetNb||1,r=t&&t.number||0,n=t&&t.delta||0;const o=e.getVerticesData(me.o.PositionKind),a=e.getIndices(),h=e.getVerticesData(this._getUVKind(e,null!==(i=null==t?void 0:t.uvKind)&&void 0!==i?i:0)),l=e.getVerticesData(me.o.ColorKind),c=e.getVerticesData(me.o.NormalKind),u=t&&t.storage?t.storage:null;let d=0;const p=a.length/3;r?(r=r>p?p:r,s=Math.round(p/r),n=0):s=s>p?p:s;const _=[],g=[],f=[],b=[],v=[],y=m.P.Zero(),x=s;for(;d<p;){s=x+Math.floor((1+n)*Math.random()),d>p-s&&(s=p-d),_.length=0,g.length=0,f.length=0,b.length=0,v.length=0;let t=0;for(let e=3*d;e<3*(d+s);e++){f.push(t);const i=a[e],s=3*i;if(_.push(o[s],o[s+1],o[s+2]),g.push(c[s],c[s+1],c[s+2]),h){const e=2*i;b.push(h[e],h[e+1])}if(l){const e=4*i;v.push(l[e],l[e+1],l[e+2],l[e+3])}t++}let i=this.nbParticles;const r=this._posToShape(_),P=this._uvsToShapeUV(b),C=f.slice(),T=v.slice(),S=g.slice();let E;for(y.copyFromFloats(0,0,0),E=0;E<r.length;E++)y.addInPlace(r[E]);y.scaleInPlace(1/r.length);const R=new m.P(1/0,1/0,1/0),M=new m.P(-1/0,-1/0,-1/0);for(E=0;E<r.length;E++)r[E].subtractInPlace(y),R.minimizeInPlaceFromFloats(r[E].x,r[E].y,r[E].z),M.maximizeInPlaceFromFloats(r[E].x,r[E].y,r[E].z);let A;this._particlesIntersect&&(A=new Jt.j(R,M));let I=null;this._useModelMaterial&&(I=e.material?e.material:this._setDefaultMaterial());const O=new Zu(this._shapeCounter,r,C,S,T,P,null,null,I),w=this._positions.length,D=this._indices.length;this._meshBuilder(this._index,D,r,this._positions,C,this._indices,b,this._uvs,T,this._colors,S,this._normals,i,0,null,O),this._addParticle(i,this._lastParticleId,w,D,O,this._shapeCounter,0,A,u),this.particles[this.nbParticles].position.addInPlace(y),u||(this._index+=r.length,i++,this.nbParticles++,this._lastParticleId++),this._shapeCounter++,d+=s}return this._isNotBuilt=!0,this}_unrotateFixedNormals(){let e=0,t=0;const i=m.jp.Vector3[0],s=m.jp.Quaternion[0],r=m.jp.Matrix[0];for(let n=0;n<this.particles.length;n++){const o=this.particles[n],a=o._model._shape;if(o.rotationQuaternion)o.rotationQuaternion.conjugateToRef(s);else{const e=o.rotation;m._f.RotationYawPitchRollToRef(e.y,e.x,e.z,s),s.conjugateInPlace()}s.toRotationMatrix(r);for(let s=0;s<a.length;s++)t=e+3*s,m.P.TransformNormalFromFloatsToRef(this._normals32[t],this._normals32[t+1],this._normals32[t+2],r,i),i.toArray(this._fixedNormal32,t);e=t+3}}_resetCopy(){const e=this._copy;e.position.setAll(0),e.rotation.setAll(0),e.rotationQuaternion=null,e.scaling.setAll(1),e.uvs.copyFromFloats(0,0,1,1),e.color=null,e.translateFromPivot=!1,e.shapeId=0,e.materialIndex=null}_meshBuilder(e,t,i,s,r,n,o,a,h,l,c,u,d,p,_,g){let f,b=0,v=0,y=0;this._resetCopy();const x=this._copy,P=!(!_||!_.storage);if(x.idx=d,x.idxInShape=p,x.shapeId=g.shapeId,this._useModelMaterial){const e=g._material.uniqueId,t=this._materialIndexesById;Object.prototype.hasOwnProperty.call(t,e)||(t[e]=this._materials.length,this._materials.push(g._material));const i=t[e];x.materialIndex=i}if(_&&_.positionFunction&&(_.positionFunction(x,d,p),this._mustUnrotateFixedNormals=!0),P)return x;const C=m.jp.Matrix[0],T=this._tmpVertex,S=T.position,E=T.color,R=T.uv,M=m.jp.Vector3[1],A=m.jp.Vector3[2],I=m.jp.Vector3[3];m.y3.IdentityToRef(C),x.getRotationMatrix(C),x.pivot.multiplyToRef(x.scaling,I),x.translateFromPivot?A.setAll(0):A.copyFrom(I);const O=_&&_.vertexFunction;for(f=0;f<i.length;f++){if(S.copyFrom(i[f]),x.color&&E.copyFrom(x.color),o&&R.copyFromFloats(o[b],o[b+1]),O&&_.vertexFunction(x,T,f),S.multiplyInPlace(x.scaling).subtractInPlace(I),m.P.TransformCoordinatesToRef(S,C,M),M.addInPlace(A).addInPlace(x.position),s.push(M.x,M.y,M.z),o){const e=x.uvs;a.push((e.z-e.x)*R.x+e.x,(e.w-e.y)*R.y+e.y),b+=2}if(x.color)this._color.copyFrom(E);else{const e=this._color;h&&void 0!==h[v]?(e.r=h[v],e.g=h[v+1],e.b=h[v+2],e.a=h[v+3]):(e.r=1,e.g=1,e.b=1,e.a=1)}l.push(this._color.r,this._color.g,this._color.b,this._color.a),v+=4,!this.recomputeNormals&&c&&(m.P.TransformNormalFromFloatsToRef(c[y],c[y+1],c[y+2],C,S),u.push(S.x,S.y,S.z),y+=3)}for(f=0;f<r.length;f++){const t=e+r[f];n.push(t),t>65535&&(this._needs32Bits=!0)}if(this._depthSort||this._multimaterialEnabled){const e=null!==x.materialIndex?x.materialIndex:0;this.depthSortedParticles.push(new Ju(d,t,r.length,e))}return x}_posToShape(e){const t=[];for(let i=0;i<e.length;i+=3)t.push(m.P.FromArray(e,i));return t}_uvsToShapeUV(e){const t=[];if(e)for(let i=0;i<e.length;i++)t.push(e[i]);return t}_addParticle(e,t,i,s,r,n,o,a=null,h=null){const l=new Ku(e,t,i,s,r,n,o,this,a);return(h||this.particles).push(l),l}addShape(e,t,i){const s=e.getVerticesData(me.o.PositionKind),r=e.getIndices(),n=e.getVerticesData(me.o.UVKind),o=e.getVerticesData(me.o.ColorKind),a=e.getVerticesData(me.o.NormalKind);this.recomputeNormals=!a;const h=Array.from(r),l=Array.from(a),c=o?Array.from(o):[],u=i&&i.storage?i.storage:null;let d=null;this._particlesIntersect&&(d=e.getBoundingInfo());const p=this._posToShape(s),_=this._uvsToShapeUV(n),g=i?i.positionFunction:null,m=i?i.vertexFunction:null;let f=null;this._useModelMaterial&&(f=e.material?e.material:this._setDefaultMaterial());const b=new Zu(this._shapeCounter,p,h,l,c,_,g,m,f);for(let e=0;e<t;e++)this._insertNewParticle(this.nbParticles,e,b,p,r,n,o,a,d,u,i);return this._shapeCounter++,this._isNotBuilt=!0,this._shapeCounter-1}_rebuildParticle(e,t=!1){this._resetCopy();const i=this._copy;e._model._positionFunction&&e._model._positionFunction(i,e.idx,e.idxInShape);const s=m.jp.Matrix[0],r=m.jp.Vector3[0],n=m.jp.Vector3[1],o=m.jp.Vector3[2],a=m.jp.Vector3[3];i.getRotationMatrix(s),e.pivot.multiplyToRef(e.scaling,a),i.translateFromPivot?o.copyFromFloats(0,0,0):o.copyFrom(a);const h=e._model._shape;for(let t=0;t<h.length;t++)r.copyFrom(h[t]),e._model._vertexFunction&&e._model._vertexFunction(i,r,t),r.multiplyInPlace(i.scaling).subtractInPlace(a),m.P.TransformCoordinatesToRef(r,s,n),n.addInPlace(o).addInPlace(i.position).toArray(this._positions32,e._pos+3*t);t&&(e.position.setAll(0),e.rotation.setAll(0),e.rotationQuaternion=null,e.scaling.setAll(1),e.uvs.setAll(0),e.pivot.setAll(0),e.translateFromPivot=!1,e.parentId=null)}rebuildMesh(e=!1){for(let t=0;t<this.particles.length;t++)this._rebuildParticle(this.particles[t],e);return this.mesh.updateVerticesData(me.o.PositionKind,this._positions32,!1,!1),this}removeParticles(e,t){const i=t-e+1;if(!this._expandable||i<=0||i>=this.nbParticles||!this._updatable)return[];const s=this.particles,r=this.nbParticles;if(t<r-1){const i=t+1,n=s[i]._pos-s[e]._pos,o=s[i]._ind-s[e]._ind;for(let e=i;e<r;e++){const t=s[e];t._pos-=n,t._ind-=o}}const n=s.splice(e,i);this._positions.length=0,this._indices.length=0,this._colors.length=0,this._uvs.length=0,this._normals.length=0,this._index=0,this._idxOfId.length=0,(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]);let o=0;const a=s.length;for(let e=0;e<a;e++){const t=s[e],i=t._model,r=i._shape,n=i._indices,a=i._normals,h=i._shapeColors,l=i._shapeUV;t.idx=e,this._idxOfId[t.id]=e,this._meshBuilder(this._index,o,r,this._positions,n,this._indices,l,this._uvs,h,this._colors,a,this._normals,t.idx,t.idxInShape,null,i),this._index+=r.length,o+=n.length}return this.nbParticles-=i,this._isNotBuilt=!0,n}insertParticlesFromArray(e){if(!this._expandable)return this;let t=0,i=e[0].shapeId;const s=e.length;for(let r=0;r<s;r++){const s=e[r],n=s._model,o=n._shape,a=n._indices,h=n._shapeUV,l=n._shapeColors,c=n._normals,u=!c;this.recomputeNormals=u||this.recomputeNormals;const d=s.getBoundingInfo(),p=this._insertNewParticle(this.nbParticles,t,n,o,a,h,l,c,d,null,null);s.copyToRef(p),t++,i!=s.shapeId&&(i=s.shapeId,t=0)}return this._isNotBuilt=!0,this}_insertNewParticle(e,t,i,s,r,n,o,a,h,l,c){const u=this._positions.length,d=this._indices.length,p=this._meshBuilder(this._index,d,s,this._positions,r,this._indices,n,this._uvs,o,this._colors,a,this._normals,e,t,c,i);let _=null;return this._updatable&&(_=this._addParticle(this.nbParticles,this._lastParticleId,u,d,i,this._shapeCounter,t,h,l),_.position.copyFrom(p.position),_.rotation.copyFrom(p.rotation),p.rotationQuaternion&&(_.rotationQuaternion?_.rotationQuaternion.copyFrom(p.rotationQuaternion):_.rotationQuaternion=p.rotationQuaternion.clone()),p.color&&(_.color?_.color.copyFrom(p.color):_.color=p.color.clone()),_.scaling.copyFrom(p.scaling),_.uvs.copyFrom(p.uvs),null!==p.materialIndex&&(_.materialIndex=p.materialIndex),this.expandable&&(this._idxOfId[_.id]=_.idx)),l||(this._index+=s.length,this.nbParticles++,this._lastParticleId++),_}setParticles(e=0,t=this.nbParticles-1,i=!0){if(!this._updatable||this._isNotBuilt)return this;this.beforeUpdateParticles(e,t,i);const s=m.jp.Matrix[0],r=m.jp.Matrix[1],n=this.mesh,o=this._colors32,a=this._positions32,h=this._normals32,l=this._uvs32,c=this._indices32,u=this._indices,d=this._fixedNormal32,p=this._depthSort&&this._depthSortParticles,_=m.jp.Vector3,g=_[5].copyFromFloats(1,0,0),f=_[6].copyFromFloats(0,1,0),b=_[7].copyFromFloats(0,0,1),v=_[8].setAll(Number.MAX_VALUE),y=_[9].setAll(-Number.MAX_VALUE),x=_[10].setAll(0),P=this._tmpVertex,C=P.position,T=P.color,S=P.uv;if((this.billboard||this._depthSort)&&(this.mesh.computeWorldMatrix(!0),this.mesh._worldMatrix.invertToRef(r)),this.billboard){const e=_[0];this._camera.getDirectionToRef(ue.RD.Z,e),m.P.TransformNormalToRef(e,r,b),b.normalize();const t=this._camera.getViewMatrix(!0);m.P.TransformNormalFromFloatsToRef(t.m[1],t.m[5],t.m[9],r,f),m.P.CrossToRef(f,b,g),f.normalize(),g.normalize()}this._depthSort&&m.P.TransformCoordinatesToRef(this._camera.globalPosition,r,x),m.y3.IdentityToRef(s);let E=0,R=0,M=0,A=0,I=0,O=0,w=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(0!=e||t!=this.nbParticles-1)){const e=this.mesh.getBoundingInfo();e&&(v.copyFrom(e.minimum),y.copyFrom(e.maximum))}R=this.particles[e]._pos;const D=R/3|0;A=4*D,O=2*D;for(let i=e;i<=t;i++){const e=this.particles[i];this.updateParticle(e);const t=e._model._shape,r=e._model._shapeUV,c=e._rotationMatrix,u=e.position,D=e.rotation,B=e.scaling,N=e._globalPosition;if(p){const t=this.depthSortedParticles[i];t.idx=e.idx,t.ind=e._ind,t.indicesLength=e._model._indicesLength,t.sqDistance=m.P.DistanceSquared(e.position,x)}if(e.alive&&(!e._stillInvisible||e.isVisible||this._recomputeInvisibles)){if(e.isVisible){e._stillInvisible=!1;const i=_[12];if(e.pivot.multiplyToRef(B,i),this.billboard&&(D.x=0,D.y=0),(this._computeParticleRotation||this.billboard)&&e.getRotationMatrix(s),null!==e.parentId){const t=this.getParticleById(e.parentId);if(t){const e=t._rotationMatrix,i=t._globalPosition,r=u.x*e[1]+u.y*e[4]+u.z*e[7],n=u.x*e[0]+u.y*e[3]+u.z*e[6],o=u.x*e[2]+u.y*e[5]+u.z*e[8];if(N.x=i.x+n,N.y=i.y+r,N.z=i.z+o,this._computeParticleRotation||this.billboard){const t=s.m;c[0]=t[0]*e[0]+t[1]*e[3]+t[2]*e[6],c[1]=t[0]*e[1]+t[1]*e[4]+t[2]*e[7],c[2]=t[0]*e[2]+t[1]*e[5]+t[2]*e[8],c[3]=t[4]*e[0]+t[5]*e[3]+t[6]*e[6],c[4]=t[4]*e[1]+t[5]*e[4]+t[6]*e[7],c[5]=t[4]*e[2]+t[5]*e[5]+t[6]*e[8],c[6]=t[8]*e[0]+t[9]*e[3]+t[10]*e[6],c[7]=t[8]*e[1]+t[9]*e[4]+t[10]*e[7],c[8]=t[8]*e[2]+t[9]*e[5]+t[10]*e[8]}}else e.parentId=null}else if(N.x=u.x,N.y=u.y,N.z=u.z,this._computeParticleRotation||this.billboard){const e=s.m;c[0]=e[0],c[1]=e[1],c[2]=e[2],c[3]=e[4],c[4]=e[5],c[5]=e[6],c[6]=e[8],c[7]=e[9],c[8]=e[10]}const n=_[11];for(e.translateFromPivot?n.setAll(0):n.copyFrom(i),w=0;w<t.length;w++){E=R+3*w,M=A+4*w,I=O+2*w;const s=2*w,o=s+1;C.copyFrom(t[w]),this._computeParticleColor&&e.color&&T.copyFrom(e.color),this._computeParticleTexture&&S.copyFromFloats(r[s],r[o]),this._computeParticleVertex&&this.updateParticleVertex(e,P,w);const u=C.x*B.x-i.x,p=C.y*B.y-i.y,_=C.z*B.z-i.z;let m=u*c[0]+p*c[3]+_*c[6],x=u*c[1]+p*c[4]+_*c[7],D=u*c[2]+p*c[5]+_*c[8];m+=n.x,x+=n.y,D+=n.z;const F=a[E]=N.x+g.x*m+f.x*x+b.x*D,L=a[E+1]=N.y+g.y*m+f.y*x+b.y*D,V=a[E+2]=N.z+g.z*m+f.z*x+b.z*D;if(this._computeBoundingBox&&(v.minimizeInPlaceFromFloats(F,L,V),y.maximizeInPlaceFromFloats(F,L,V)),!this._computeParticleVertex){const e=d[E],t=d[E+1],i=d[E+2],s=e*c[0]+t*c[3]+i*c[6],r=e*c[1]+t*c[4]+i*c[7],n=e*c[2]+t*c[5]+i*c[8];h[E]=g.x*s+f.x*r+b.x*n,h[E+1]=g.y*s+f.y*r+b.y*n,h[E+2]=g.z*s+f.z*r+b.z*n}if(this._computeParticleColor&&e.color){const e=this._colors32;e[M]=T.r,e[M+1]=T.g,e[M+2]=T.b,e[M+3]=T.a}if(this._computeParticleTexture){const t=e.uvs;l[I]=S.x*(t.z-t.x)+t.x,l[I+1]=S.y*(t.w-t.y)+t.y}}}else for(e._stillInvisible=!0,w=0;w<t.length;w++){if(E=R+3*w,M=A+4*w,I=O+2*w,a[E]=a[E+1]=a[E+2]=0,h[E]=h[E+1]=h[E+2]=0,this._computeParticleColor&&e.color){const t=e.color;o[M]=t.r,o[M+1]=t.g,o[M+2]=t.b,o[M+3]=t.a}if(this._computeParticleTexture){const t=e.uvs;l[I]=r[2*w]*(t.z-t.x)+t.x,l[I+1]=r[2*w+1]*(t.w-t.y)+t.y}}if(this._particlesIntersect){const t=e.getBoundingInfo(),i=t.boundingBox,s=t.boundingSphere,r=e._modelBoundingInfo;if(!this._bSphereOnly){const e=r.boundingBox.vectors,t=_[1],s=_[2];t.setAll(Number.MAX_VALUE),s.setAll(-Number.MAX_VALUE);for(let i=0;i<8;i++){const r=e[i].x*B.x,n=e[i].y*B.y,o=e[i].z*B.z,a=r*c[0]+n*c[3]+o*c[6],h=r*c[1]+n*c[4]+o*c[7],l=r*c[2]+n*c[5]+o*c[8],d=u.x+g.x*a+f.x*h+b.x*l,p=u.y+g.y*a+f.y*h+b.y*l,_=u.z+g.z*a+f.z*h+b.z*l;t.minimizeInPlaceFromFloats(d,p,_),s.maximizeInPlaceFromFloats(d,p,_)}i.reConstruct(t,s,n._worldMatrix)}const o=r.minimum.multiplyToRef(B,_[1]),a=r.maximum.multiplyToRef(B,_[2]),h=a.addToRef(o,_[3]).scaleInPlace(.5).addInPlace(N),l=a.subtractToRef(o,_[4]).scaleInPlace(.5*this._bSphereRadiusFactor),d=h.subtractToRef(l,_[1]),p=h.addToRef(l,_[2]);s.reConstruct(d,p,n._worldMatrix)}R=E+3,A=M+4,O=I+2}else w=t.length,R+=3*w,A+=4*w,O+=2*w}if(i){if(this._computeParticleColor){const e=n.getVertexBuffer(me.o.ColorKind);e&&!n.isPickable?e.updateDirectly(o,0):n.updateVerticesData(me.o.ColorKind,o,!1,!1)}if(this._computeParticleTexture){const e=n.getVertexBuffer(me.o.UVKind);e&&!n.isPickable?e.updateDirectly(l,0):n.updateVerticesData(me.o.UVKind,l,!1,!1)}const e=n.getVertexBuffer(me.o.PositionKind);if(e&&!n.isPickable?e.updateDirectly(a,0):n.updateVerticesData(me.o.PositionKind,a,!1,!1),!n.areNormalsFrozen||n.isFacetDataEnabled){if(this._computeParticleVertex||n.isFacetDataEnabled){const e=n.isFacetDataEnabled?n.getFacetDataParameters():null;gi.x.ComputeNormals(a,c,h,e);for(let e=0;e<h.length;e++)d[e]=h[e]}if(!n.areNormalsFrozen){const e=n.getVertexBuffer(me.o.NormalKind);e&&!n.isPickable?e.updateDirectly(h,0):n.updateVerticesData(me.o.NormalKind,h,!1,!1)}}if(p){const e=this.depthSortedParticles;e.sort(this._depthSortFunction);const t=e.length;let i=0,s=0;for(let r=0;r<t;r++){const t=e[r],n=t.indicesLength,o=t.ind;for(let e=0;e<n;e++)if(c[i]=u[o+e],i++,this._pickable&&0==e%3){const e=this.pickedParticles[s];e.idx=t.idx,e.faceId=s,s++}}}if(this._autoFixFaceOrientation){let e=0;for(let t=0;t<this.particles.length;t++){const i=p?this.particles[this.depthSortedParticles[t].idx]:this.particles[t];if(i.scale.x*i.scale.y*i.scale.z<0)for(let t=0;t<i._model._indicesLength;t+=3){const s=u[i._ind+t];c[e+t]=u[i._ind+t+1],c[e+t+1]=s}e+=i._model._indicesLength}}(p||this._autoFixFaceOrientation)&&n.updateIndices(c)}return this._computeBoundingBox&&(n.hasBoundingInfo?n.getBoundingInfo().reConstruct(v,y,n._worldMatrix):n.buildBoundingInfo(v,y,n._worldMatrix)),this._autoUpdateSubMeshes&&this.computeSubMeshes(),this._recomputeInvisibles=!1,this.afterUpdateParticles(e,t,i),this}dispose(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._normals32=null,this._fixedNormal32=null,this._uvs32=null,this._colors32=null,this.pickedParticles=null,this.pickedBySubMesh=null,this._materials=null,this._materialIndexes=null,this._indicesByMaterial=null,this._idxOfId=null}pickedParticle(e){if(e.hit){const t=e.subMeshId,i=e.faceId-this.mesh.subMeshes[t].indexStart/3,s=this.pickedBySubMesh;if(s[t]&&s[t][i])return s[t][i]}return null}getParticleById(e){const t=this.particles[e];if(t&&t.id==e)return t;const i=this.particles,s=this._idxOfId[e];if(void 0!==s)return i[s];let r=0;const n=this.nbParticles;for(;r<n;){const t=i[r];if(t.id==e)return t;r++}return null}getParticlesByShapeId(e){const t=[];return this.getParticlesByShapeIdToRef(e,t),t}getParticlesByShapeIdToRef(e,t){t.length=0;for(let i=0;i<this.nbParticles;i++){const s=this.particles[i];s.shapeId==e&&t.push(s)}return this}computeSubMeshes(){if(!this.mesh||!this._multimaterialEnabled)return this;const e=this.depthSortedParticles;if(this.particles.length>0)for(let t=0;t<this.particles.length;t++){const i=this.particles[t];i.materialIndex||(i.materialIndex=0);const s=e[t];s.materialIndex=i.materialIndex,s.ind=i._ind,s.indicesLength=i._model._indicesLength,s.idx=i.idx}this._sortParticlesByMaterial();const t=this._indicesByMaterial,i=this._materialIndexes,s=this.mesh;s.subMeshes=[];const r=s.getTotalVertices();for(let e=0;e<i.length;e++){const n=t[e],o=t[e+1]-n,a=i[e];new Ll.P(a,0,r,n,o,s)}return this}_sortParticlesByMaterial(){const e=[0];this._indicesByMaterial=e;const t=[];this._materialIndexes=t;const i=this.depthSortedParticles;i.sort(this._materialSortFunction);const s=i.length,r=this._indices32,n=this._indices;let o=0,a=0,h=0,l=i[0].materialIndex;t.push(l),this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]);for(let c=0;c<s;c++){const s=i[c],u=s.indicesLength,d=s.ind;s.materialIndex!==l&&(l=s.materialIndex,e.push(h),t.push(l),this._pickable&&(o++,this.pickedBySubMesh[o]=[],a=0));let p=0;for(let e=0;e<u;e++){if(r[h]=n[d+e],this._pickable&&0==e%3){const e=this.pickedBySubMesh[o][a];e?(e.idx=s.idx,e.faceId=p):this.pickedBySubMesh[o][a]={idx:s.idx,faceId:p},a++,p++}h++}}return e.push(r.length),this._updatable&&this.mesh.updateIndices(r),this}_setMaterialIndexesById(){this._materialIndexesById={};for(let e=0;e<this._materials.length;e++){const t=this._materials[e].uniqueId;this._materialIndexesById[t]=e}}_filterUniqueMaterialId(e){return e.filter((function(e,t,i){return i.indexOf(e)===t}))}_setDefaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=new Ot.K(this.name+"DefaultMaterial",this._scene)),this._defaultMaterial}refreshVisibleSize(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this}setVisibilityBox(e){const t=e/2;this.mesh.buildBoundingInfo(new m.P(-t,-t,-t),new m.P(t,t,t))}get isAlwaysVisible(){return this._alwaysVisible}set isAlwaysVisible(e){this._alwaysVisible=e,this.mesh.alwaysSelectAsActiveMesh=e}set isVisibilityBoxLocked(e){this._isVisibilityBoxLocked=e,this.mesh.getBoundingInfo().isLocked=e}get isVisibilityBoxLocked(){return this._isVisibilityBoxLocked}set computeParticleRotation(e){this._computeParticleRotation=e}set computeParticleColor(e){this._computeParticleColor=e}set computeParticleTexture(e){this._computeParticleTexture=e}set computeParticleVertex(e){this._computeParticleVertex=e}set computeBoundingBox(e){this._computeBoundingBox=e}set depthSortParticles(e){this._depthSortParticles=e}get computeParticleRotation(){return this._computeParticleRotation}get computeParticleColor(){return this._computeParticleColor}get computeParticleTexture(){return this._computeParticleTexture}get computeParticleVertex(){return this._computeParticleVertex}get computeBoundingBox(){return this._computeBoundingBox}get depthSortParticles(){return this._depthSortParticles}get expandable(){return this._expandable}get multimaterialEnabled(){return this._multimaterialEnabled}get useModelMaterial(){return this._useModelMaterial}get materials(){return this._materials}setMultiMaterial(e){this._materials=this._filterUniqueMaterialId(e),this._setMaterialIndexesById(),this._multimaterial&&this._multimaterial.dispose(),this._multimaterial=new hn.G(this.name+"MultiMaterial",this._scene);for(let e=0;e<this._materials.length;e++)this._multimaterial.subMaterials.push(this._materials[e]);this.computeSubMeshes(),this.mesh.material=this._multimaterial}get multimaterial(){return this._multimaterial}set multimaterial(e){this._multimaterial=e}get autoUpdateSubMeshes(){return this._autoUpdateSubMeshes}set autoUpdateSubMeshes(e){this._autoUpdateSubMeshes=e}initParticles(){}recycleParticle(e){return e}updateParticle(e){return e}updateParticleVertex(e,t,i){return this}beforeUpdateParticles(e,t,i){}afterUpdateParticles(e,t,i){}}class id{constructor(e,t,i,s,r){this.idx=0,this.color=new Zs.HE(1,1,1,1),this.position=Zs.P.Zero(),this.rotation=Zs.P.Zero(),this.uv=new Zs.FM(0,0),this.velocity=Zs.P.Zero(),this.pivot=Zs.P.Zero(),this.translateFromPivot=!1,this._pos=0,this._ind=0,this.groupId=0,this.idxInGroup=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=Zs.P.Zero(),this.idx=e,this._group=t,this.groupId=i,this.idxInGroup=s,this._pcs=r}get size(){return this.size}set size(e){this.size=e}get quaternion(){return this.rotationQuaternion}set quaternion(e){this.rotationQuaternion=e}intersectsMesh(e,t){if(!e.hasBoundingInfo)return!1;if(!this._pcs.mesh)throw new Error("Point Cloud System doesnt contain the Mesh");if(t)return e.getBoundingInfo().boundingSphere.intersectsPoint(this.position.add(this._pcs.mesh.position));const i=e.getBoundingInfo().boundingBox,s=i.maximumWorld.x,r=i.minimumWorld.x,n=i.maximumWorld.y,o=i.minimumWorld.y,a=i.maximumWorld.z,h=i.minimumWorld.z,l=this.position.x+this._pcs.mesh.position.x,c=this.position.y+this._pcs.mesh.position.y,u=this.position.z+this._pcs.mesh.position.z;return r<=l&&l<=s&&o<=c&&c<=n&&h<=u&&u<=a}getRotationMatrix(e){let t;if(this.rotationQuaternion)t=this.rotationQuaternion;else{t=Zs.jp.Quaternion[0];const e=this.rotation;Zs._f.RotationYawPitchRollToRef(e.y,e.x,e.z,t)}t.toRotationMatrix(e)}}class sd{get groupID(){return this.groupId}set groupID(e){this.groupId=e}constructor(e,t){this.groupId=e,this._positionFunction=t}}!function(e){e[e.Color=2]="Color",e[e.UV=1]="UV",e[e.Random=0]="Random",e[e.Stated=3]="Stated"}(ju||(ju={}));class rd{get positions(){return this._positions32}get colors(){return this._colors32}get uvs(){return this._uvs32}constructor(e,t,i,s){this.particles=new Array,this.nbParticles=0,this.counter=0,this.vars={},this._promises=[],this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._updatable=!0,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._groups=new Array,this._groupCounter=0,this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeBoundingBox=!1,this._isReady=!1,this.name=e,this._size=t,this._scene=i||D.l.LastCreatedScene,s&&void 0!==s.updatable?this._updatable=s.updatable:this._updatable=!0}buildMeshAsync(e){return Promise.all(this._promises).then((()=>(this._isReady=!0,this._buildMesh(e))))}_buildMesh(e){0===this.nbParticles&&this.addPoints(1),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors);const t=new gi.x;t.set(this._positions32,me.o.PositionKind),this._uvs32.length>0&&t.set(this._uvs32,me.o.UVKind);let i=0;this._colors32.length>0&&(i=1,t.set(this._colors32,me.o.ColorKind));const s=new Mt.Kj(this.name,this._scene);t.applyToMesh(s,this._updatable),this.mesh=s,this._positions=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0);let r=e;return r||(r=new Ot.K("point cloud material",this._scene),r.emissiveColor=new Zs.Wo(i,i,i),r.disableLighting=!0,r.pointsCloud=!0,r.pointSize=this._size),s.material=r,new Promise((e=>e(s)))}_addParticle(e,t,i,s){const r=new id(e,t,i,s,this);return this.particles.push(r),r}_randomUnitVector(e){e.position=new m.P(Math.random(),Math.random(),Math.random()),e.color=new Zs.HE(1,1,1,1)}_getColorIndicesForCoord(e,t,i,s){const r=e._groupImageData,n=i*(4*s)+4*t,o=[n,n+1,n+2,n+3],a=o[1],h=o[2],l=o[3],c=r[o[0]],u=r[a],d=r[h],p=r[l];return new Zs.HE(c/255,u/255,d/255,p)}_setPointsColorOrUV(e,t,i,s,r,n,o,a){a=null!=a?a:0,i&&e.updateFacetData();const h=2*e.getBoundingInfo().boundingSphere.radius;let l=e.getVerticesData(me.o.PositionKind);const c=e.getIndices(),u=e.getVerticesData(me.o.UVKind+(a?a+1:"")),d=e.getVerticesData(me.o.ColorKind),p=m.P.Zero();e.computeWorldMatrix();const _=e.getWorldMatrix();if(!_.isIdentity()){l=l.slice(0);for(let e=0;e<l.length/3;e++)m.P.TransformCoordinatesFromFloatsToRef(l[3*e],l[3*e+1],l[3*e+2],_,p),l[3*e]=p.x,l[3*e+1]=p.y,l[3*e+2]=p.z}let g=0,f=0,b=0,v=0,y=0,x=0,P=0,C=0,T=0,S=0,E=0,R=0,M=0;const A=m.P.Zero(),I=m.P.Zero(),O=m.P.Zero(),w=m.P.Zero(),D=m.P.Zero();let B=0,N=0,F=0,L=0,V=0,k=0;const z=m.FM.Zero(),G=m.FM.Zero(),U=m.FM.Zero(),W=m.FM.Zero(),H=m.FM.Zero();let j=0,$=0,Y=0,X=0,Q=0,q=0,K=0,Z=0,J=0,ee=0,te=0,ie=0;const se=m.Lt.Zero(),re=m.Lt.Zero(),ne=m.Lt.Zero(),oe=m.Lt.Zero(),ae=m.Lt.Zero();let he,le,ce=0,ue=0;o=o||0;let de=new m.Lt(0,0,0,0),pe=m.P.Zero(),_e=m.P.Zero(),ge=m.P.Zero(),fe=0,be=m.P.Zero(),ve=0,ye=0;const xe=new At.z(m.P.Zero(),new m.P(1,0,0));let Pe,Ce=m.P.Zero();for(let a=0;a<c.length/3;a++){let p,_,me,Te,Se,Ee,Re,Me;f=c[3*a],b=c[3*a+1],v=c[3*a+2],y=l[3*f],x=l[3*f+1],P=l[3*f+2],C=l[3*b],T=l[3*b+1],S=l[3*b+2],E=l[3*v],R=l[3*v+1],M=l[3*v+2],A.set(y,x,P),I.set(C,T,S),O.set(E,R,M),I.subtractToRef(A,w),O.subtractToRef(I,D),u&&(B=u[2*f],N=u[2*f+1],F=u[2*b],L=u[2*b+1],V=u[2*v],k=u[2*v+1],z.set(B,N),G.set(F,L),U.set(V,k),G.subtractToRef(z,W),U.subtractToRef(G,H)),d&&s&&(j=d[4*f],$=d[4*f+1],Y=d[4*f+2],X=d[4*f+3],Q=d[4*b],q=d[4*b+1],K=d[4*b+2],Z=d[4*b+3],J=d[4*v],ee=d[4*v+1],te=d[4*v+2],ie=d[4*v+3],se.set(j,$,Y,X),re.set(Q,q,K,Z),ne.set(J,ee,te,ie),re.subtractToRef(se,oe),ne.subtractToRef(re,ae));const Ae=new Zs.Wo(0,0,0),Ie=new Zs.Wo(0,0,0);let Oe,we;for(let l=0;l<t._groupDensity[a];l++)g=this.particles.length,this._addParticle(g,t,this._groupCounter,a+l),we=this.particles[g],ce=Po.R.RandomRange(0,1),ue=Po.R.RandomRange(0,1),he=A.add(w.scale(ce)).add(D.scale(ce*ue)),i&&(pe=e.getFacetNormal(a).normalize().scale(-1),_e=w.clone().normalize(),ge=m.P.Cross(pe,_e),fe=Po.R.RandomRange(0,2*Math.PI),be=_e.scale(Math.cos(fe)).add(ge.scale(Math.sin(fe))),fe=Po.R.RandomRange(.1,Math.PI/2),Ce=be.scale(Math.cos(fe)).add(pe.scale(Math.sin(fe))),xe.origin=he.add(Ce.scale(1e-5)),xe.direction=Ce,xe.length=h,Pe=xe.intersectsMesh(e),Pe.hit&&(ye=Pe.pickedPoint.subtract(he).length(),ve=Po.R.RandomRange(0,1)*ye,he.addInPlace(Ce.scale(ve)))),we.position=he.clone(),this._positions.push(we.position.x,we.position.y,we.position.z),void 0!==s?u&&(le=z.add(W.scale(ce)).add(H.scale(ce*ue)),s?r&&null!==t._groupImageData?(p=t._groupImgWidth,_=t._groupImgHeight,Oe=this._getColorIndicesForCoord(t,Math.round(le.x*p),Math.round(le.y*_),p),we.color=Oe,this._colors.push(Oe.r,Oe.g,Oe.b,Oe.a)):d?(de=se.add(oe.scale(ce)).add(ae.scale(ce*ue)),we.color=new Zs.HE(de.x,de.y,de.z,de.w),this._colors.push(de.x,de.y,de.z,de.w)):(de=se.set(Math.random(),Math.random(),Math.random(),1),we.color=new Zs.HE(de.x,de.y,de.z,de.w),this._colors.push(de.x,de.y,de.z,de.w)):(we.uv=le.clone(),this._uvs.push(we.uv.x,we.uv.y))):(n?(Ae.set(n.r,n.g,n.b),me=Po.R.RandomRange(-o,o),Te=Po.R.RandomRange(-o,o),Me=Ae.toHSV(),Se=Me.r,Ee=Me.g+me,Re=Me.b+Te,Ee<0&&(Ee=0),Ee>1&&(Ee=1),Re<0&&(Re=0),Re>1&&(Re=1),Zs.Wo.HSVtoRGBToRef(Se,Ee,Re,Ie),de.set(Ie.r,Ie.g,Ie.b,1)):de=se.set(Math.random(),Math.random(),Math.random(),1),we.color=new Zs.HE(de.x,de.y,de.z,de.w),this._colors.push(de.x,de.y,de.z,de.w))}}_colorFromTexture(e,t,i){if(null===e.material)return p.Y.Warn(e.name+"has no material."),t._groupImageData=null,void this._setPointsColorOrUV(e,t,i,!0,!1);const s=e.material.getActiveTextures();if(0===s.length)return p.Y.Warn(e.name+"has no usable texture."),t._groupImageData=null,void this._setPointsColorOrUV(e,t,i,!0,!1);const r=e.clone();r.setEnabled(!1),this._promises.push(new Promise((e=>{Xn.V.WhenAllReady(s,(()=>{let n=t._textureNb;n<0&&(n=0),n>s.length-1&&(n=s.length-1);const o=()=>{t._groupImgWidth=s[n].getSize().width,t._groupImgHeight=s[n].getSize().height,this._setPointsColorOrUV(r,t,i,!0,!0,void 0,void 0,s[n].coordinatesIndex),r.dispose(),e()};t._groupImageData=null;const a=s[n].readPixels();a?a.then((e=>{t._groupImageData=e,o()})):o()}))})))}_calculateDensity(e,t,i){let s,r,n,o,a,h,l,c,u,d,p,_,g=new Array;const f=m.P.Zero(),b=m.P.Zero(),v=m.P.Zero(),y=m.P.Zero(),x=m.P.Zero(),P=m.P.Zero();let C,T,S,E,R;const M=new Array;let A=0;const I=i.length/3;for(let e=0;e<I;e++)s=i[3*e],r=i[3*e+1],n=i[3*e+2],o=t[3*s],a=t[3*s+1],h=t[3*s+2],l=t[3*r],c=t[3*r+1],u=t[3*r+2],d=t[3*n],p=t[3*n+1],_=t[3*n+2],f.set(o,a,h),b.set(l,c,u),v.set(d,p,_),b.subtractToRef(f,y),v.subtractToRef(b,x),v.subtractToRef(f,P),C=y.length(),T=x.length(),S=P.length(),E=(C+T+S)/2,R=Math.sqrt(E*(E-C)*(E-T)*(E-S)),A+=R,M[e]=R;let O=0;for(let t=0;t<I;t++)g[t]=Math.floor(e*M[t]/A),O+=g[t];const w=e-O,D=Math.floor(w/I),B=w%I;D>0&&(g=g.map((e=>e+D)));for(let e=0;e<B;e++)g[e]+=1;return g}addPoints(e,t=this._randomUnitVector){const i=new sd(this._groupCounter,t);let s,r=this.nbParticles;for(let t=0;t<e;t++)s=this._addParticle(r,i,this._groupCounter,t),i&&i._positionFunction&&i._positionFunction(s,r,t),this._positions.push(s.position.x,s.position.y,s.position.z),s.color&&this._colors.push(s.color.r,s.color.g,s.color.b,s.color.a),s.uv&&this._uvs.push(s.uv.x,s.uv.y),r++;return this.nbParticles+=e,this._groupCounter++,this._groupCounter}addSurfacePoints(e,t,i,s,r){let n=i||ju.Random;(isNaN(n)||n<0||n>3)&&(n=ju.Random);const o=e.getVerticesData(me.o.PositionKind),a=e.getIndices();this._groups.push(this._groupCounter);const h=new sd(this._groupCounter,null);switch(h._groupDensity=this._calculateDensity(t,o,a),n===ju.Color?h._textureNb=s||0:s=s||new Zs.HE(1,1,1,1),n){case ju.Color:this._colorFromTexture(e,h,!1);break;case ju.UV:this._setPointsColorOrUV(e,h,!1,!1,!1);break;case ju.Random:this._setPointsColorOrUV(e,h,!1);break;case ju.Stated:this._setPointsColorOrUV(e,h,!1,void 0,void 0,s,r)}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}addVolumePoints(e,t,i,s,r){let n=i||ju.Random;(isNaN(n)||n<0||n>3)&&(n=ju.Random);const o=e.getVerticesData(me.o.PositionKind),a=e.getIndices();this._groups.push(this._groupCounter);const h=new sd(this._groupCounter,null);switch(h._groupDensity=this._calculateDensity(t,o,a),n===ju.Color?h._textureNb=s||0:s=s||new Zs.HE(1,1,1,1),n){case ju.Color:this._colorFromTexture(e,h,!0);break;case ju.UV:this._setPointsColorOrUV(e,h,!0,!1,!1);break;case ju.Random:this._setPointsColorOrUV(e,h,!0);break;case ju.Stated:this._setPointsColorOrUV(e,h,!0,void 0,void 0,s,r)}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}setParticles(e=0,t=this.nbParticles-1,i=!0){var s,r;if(!this._updatable||!this._isReady)return this;this.beforeUpdateParticles(e,t,i);const n=m.jp.Matrix[0],o=this.mesh,a=this._colors32,h=this._positions32,l=this._uvs32,c=m.jp.Vector3,u=c[5].copyFromFloats(1,0,0),d=c[6].copyFromFloats(0,1,0),p=c[7].copyFromFloats(0,0,1),_=c[8].setAll(Number.MAX_VALUE),g=c[9].setAll(-Number.MAX_VALUE);m.y3.IdentityToRef(n);let f=0;if((null===(s=this.mesh)||void 0===s?void 0:s.isFacetDataEnabled)&&(this._computeBoundingBox=!0),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(0!=e||t!=this.nbParticles-1)){const e=null===(r=this.mesh)||void 0===r?void 0:r.getBoundingInfo();e&&(_.copyFrom(e.minimum),g.copyFrom(e.maximum))}f=0;let b=0,v=0,y=0;for(let i=e;i<=t;i++){const e=this.particles[i];f=e.idx,b=3*f,v=4*f,y=2*f,this.updateParticle(e);const t=e._rotationMatrix,s=e.position,r=e._globalPosition;if(this._computeParticleRotation&&e.getRotationMatrix(n),null!==e.parentId){const i=this.particles[e.parentId],o=i._rotationMatrix,a=i._globalPosition,h=s.x*o[1]+s.y*o[4]+s.z*o[7],l=s.x*o[0]+s.y*o[3]+s.z*o[6],c=s.x*o[2]+s.y*o[5]+s.z*o[8];if(r.x=a.x+l,r.y=a.y+h,r.z=a.z+c,this._computeParticleRotation){const e=n.m;t[0]=e[0]*o[0]+e[1]*o[3]+e[2]*o[6],t[1]=e[0]*o[1]+e[1]*o[4]+e[2]*o[7],t[2]=e[0]*o[2]+e[1]*o[5]+e[2]*o[8],t[3]=e[4]*o[0]+e[5]*o[3]+e[6]*o[6],t[4]=e[4]*o[1]+e[5]*o[4]+e[6]*o[7],t[5]=e[4]*o[2]+e[5]*o[5]+e[6]*o[8],t[6]=e[8]*o[0]+e[9]*o[3]+e[10]*o[6],t[7]=e[8]*o[1]+e[9]*o[4]+e[10]*o[7],t[8]=e[8]*o[2]+e[9]*o[5]+e[10]*o[8]}}else if(r.x=0,r.y=0,r.z=0,this._computeParticleRotation){const e=n.m;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10]}const o=c[11];e.translateFromPivot?o.setAll(0):o.copyFrom(e.pivot);const a=c[0];a.copyFrom(e.position);const l=a.x-e.pivot.x,m=a.y-e.pivot.y,x=a.z-e.pivot.z;let P=l*t[0]+m*t[3]+x*t[6],C=l*t[1]+m*t[4]+x*t[7],T=l*t[2]+m*t[5]+x*t[8];P+=o.x,C+=o.y,T+=o.z;const S=h[b]=r.x+u.x*P+d.x*C+p.x*T,E=h[b+1]=r.y+u.y*P+d.y*C+p.y*T,R=h[b+2]=r.z+u.z*P+d.z*C+p.z*T;if(this._computeBoundingBox&&(_.minimizeInPlaceFromFloats(S,E,R),g.maximizeInPlaceFromFloats(S,E,R)),this._computeParticleColor&&e.color){const t=e.color,i=this._colors32;i[v]=t.r,i[v+1]=t.g,i[v+2]=t.b,i[v+3]=t.a}if(this._computeParticleTexture&&e.uv){const t=e.uv,i=this._uvs32;i[y]=t.x,i[y+1]=t.y}}return o&&(i&&(this._computeParticleColor&&o.updateVerticesData(me.o.ColorKind,a,!1,!1),this._computeParticleTexture&&o.updateVerticesData(me.o.UVKind,l,!1,!1),o.updateVerticesData(me.o.PositionKind,h,!1,!1)),this._computeBoundingBox&&(o.hasBoundingInfo?o.getBoundingInfo().reConstruct(_,g,o._worldMatrix):o.buildBoundingInfo(_,g,o._worldMatrix))),this.afterUpdateParticles(e,t,i),this}dispose(){var e;null===(e=this.mesh)||void 0===e||e.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._uvs32=null,this._colors32=null}refreshVisibleSize(){var e;return this._isVisibilityBoxLocked||null===(e=this.mesh)||void 0===e||e.refreshBoundingInfo(),this}setVisibilityBox(e){if(!this.mesh)return;const t=e/2;this.mesh.buildBoundingInfo(new m.P(-t,-t,-t),new m.P(t,t,t))}get isAlwaysVisible(){return this._alwaysVisible}set isAlwaysVisible(e){this.mesh&&(this._alwaysVisible=e,this.mesh.alwaysSelectAsActiveMesh=e)}set computeParticleRotation(e){this._computeParticleRotation=e}set computeParticleColor(e){this._computeParticleColor=e}set computeParticleTexture(e){this._computeParticleTexture=e}get computeParticleColor(){return this._computeParticleColor}get computeParticleTexture(){return this._computeParticleTexture}set computeBoundingBox(e){this._computeBoundingBox=e}get computeBoundingBox(){return this._computeBoundingBox}initParticles(){}recycleParticle(e){return e}updateParticle(e){return e}beforeUpdateParticles(e,t,i){}afterUpdateParticles(e,t,i){}}var nd=i(14029),od=(i(19205),i(93463)),ad=(i(92289),i(17582)),hd=i(98560),ld=i(98830),cd=i(63239),ud=i(91503);class dd{constructor(e,t,i){if(this._pluginData=void 0,!i)throw new Error("Missing scene parameter for constraint constructor.");const s=i.getPhysicsEngine();if(!s)throw new Error("No Physics Engine available.");if(2!=s.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const r=s.getPhysicsPlugin();if(!r)throw new Error("No Physics Plugin available.");this._physicsPlugin=r,this._options=t,this._type=e}get type(){return this._type}get options(){return this._options}set isEnabled(e){this._physicsPlugin.setEnabled(this,e)}get isEnabled(){return this._physicsPlugin.getEnabled(this)}set isCollisionsEnabled(e){this._physicsPlugin.setCollisionsEnabled(this,e)}get isCollisionsEnabled(){return this._physicsPlugin.getCollisionsEnabled(this)}dispose(){this._physicsPlugin.disposeConstraint(this)}}class pd{}class _d extends dd{constructor(e,t,i){super(ud.hd.SIX_DOF,e,i),this.limits=t}setAxisFriction(e,t){this._physicsPlugin.setAxisFriction(this,e,t)}getAxisFriction(e){return this._physicsPlugin.getAxisFriction(this,e)}setAxisMode(e,t){this._physicsPlugin.setAxisMode(this,e,t)}getAxisMode(e){return this._physicsPlugin.getAxisMode(this,e)}setAxisMinLimit(e,t){this._physicsPlugin.setAxisMinLimit(this,e,t)}getAxisMinLimit(e){return this._physicsPlugin.getAxisMinLimit(this,e)}setAxisMaxLimit(e,t){this._physicsPlugin.setAxisMaxLimit(this,e,t)}getAxisMaxLimit(e){return this._physicsPlugin.getAxisMaxLimit(this,e)}setAxisMotorType(e,t){this._physicsPlugin.setAxisMotorType(this,e,t)}getAxisMotorType(e){return this._physicsPlugin.getAxisMotorType(this,e)}setAxisMotorTarget(e,t){this._physicsPlugin.setAxisMotorTarget(this,e,t)}getAxisMotorTarget(e){return this._physicsPlugin.getAxisMotorTarget(this,e)}setAxisMotorMaxForce(e,t){this._physicsPlugin.setAxisMotorMaxForce(this,e,t)}getAxisMotorMaxForce(e){return this._physicsPlugin.getAxisMotorMaxForce(this,e)}}class gd extends dd{constructor(e,t,i,s,r){super(ud.hd.BALL_AND_SOCKET,{pivotA:e,pivotB:t,axisA:i,axisB:s},r)}}class md extends dd{constructor(e,t){super(ud.hd.DISTANCE,{maxDistance:e},t)}}class fd extends dd{constructor(e,t,i,s,r){super(ud.hd.HINGE,{pivotA:e,pivotB:t,axisA:i,axisB:s},r)}}class bd extends dd{constructor(e,t,i,s,r){super(ud.hd.SLIDER,{pivotA:e,pivotB:t,axisA:i,axisB:s},r)}}class vd extends dd{constructor(e,t,i,s,r){super(ud.hd.LOCK,{pivotA:e,pivotB:t,axisA:i,axisB:s},r)}}class yd extends dd{constructor(e,t,i,s,r){super(ud.hd.PRISMATIC,{pivotA:e,pivotB:t,axisA:i,axisB:s},r)}}class xd extends _d{constructor(e,t,i,s,r,n,o,a,h){super({pivotA:e,pivotB:t,axisA:i,axisB:s},[{axis:ud.cK.LINEAR_DISTANCE,minLimit:r,maxLimit:n,stiffness:o,damping:a}],h)}}var Pd=i(37670);class Cd{constructor(e,t,i={mass:0},s){var r;if(this.transformNode=e,this.type=t,this._options=i,this._scene=s,this._disposeShapeWhenDisposed=!0,!this.transformNode)return void p.Y.Error("No object was provided. A physics object is obligatory");const n=e;if(this.transformNode.parent&&0!==this._options.mass&&n.hasThinInstances&&p.Y.Warn("A physics body has been created for an object which has a parent and thin instances. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),!this._scene)return;this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution;const o=0===this._options.mass?ud.c4.STATIC:ud.c4.DYNAMIC,a=null!==(r=this._options.startAsleep)&&void 0!==r&&r;this.body=new ld.Q(e,o,a,this._scene),this._addSizeOptions(),t.getClassName&&"PhysicsShape"===t.getClassName()?(this.shape=t,this._disposeShapeWhenDisposed=!1):this.shape=new cd.$n({type:t,parameters:this._options},this._scene),this._options.isTriggerShape&&(this.shape.isTrigger=!0),this.material={friction:this._options.friction,restitution:this._options.restitution},this.body.shape=this.shape,this.shape.material=this.material,this.body.setMassProperties({mass:this._options.mass}),this._nodeDisposeObserver=this.transformNode.onDisposeObservable.add((()=>{this.dispose()}))}_getObjectBoundingBox(){return this.transformNode.getRawBoundingInfo?this.transformNode.getRawBoundingInfo().boundingBox:new Zt.k(new m.P(-.5,-.5,-.5),new m.P(.5,.5,.5))}_hasVertices(e){return(null==e?void 0:e.getTotalVertices())>0}_addSizeOptions(){var e,t,i,s,r,n,o,a;this.transformNode.computeWorldMatrix(!0);const h=this._getObjectBoundingBox(),l=m.jp.Vector3[0];l.copyFrom(h.extendSize),l.scaleInPlace(2),l.multiplyInPlace(this.transformNode.scaling),l.x=Math.abs(l.x),l.y=Math.abs(l.y),l.z=Math.abs(l.z);const c=m.jp.Vector3[1];if(c.copyFrom(h.minimum),c.multiplyInPlace(this.transformNode.scaling),!this._options.center){const e=new m.P;e.copyFrom(h.center),e.multiplyInPlace(this.transformNode.scaling),this._options.center=e}switch(this.type){case ud.Bq.SPHERE:!this._options.radius&&Po.R.WithinEpsilon(l.x,l.y,1e-4)&&Po.R.WithinEpsilon(l.x,l.z,1e-4)?this._options.radius=l.x/2:this._options.radius||(p.Y.Warn("Non uniform scaling is unsupported for sphere shapes. Setting the radius to the biggest bounding box extent."),this._options.radius=Math.max(l.x,l.y,l.z)/2);break;case ud.Bq.CAPSULE:{const s=l.x/2;this._options.radius=null!==(e=this._options.radius)&&void 0!==e?e:s,this._options.pointA=null!==(t=this._options.pointA)&&void 0!==t?t:new m.P(0,c.y+s,0),this._options.pointB=null!==(i=this._options.pointB)&&void 0!==i?i:new m.P(0,c.y+l.y-s,0)}break;case ud.Bq.CYLINDER:{const e=l.x/2;this._options.radius=null!==(s=this._options.radius)&&void 0!==s?s:e,this._options.pointA=null!==(r=this._options.pointA)&&void 0!==r?r:new m.P(0,c.y,0),this._options.pointB=null!==(n=this._options.pointB)&&void 0!==n?n:new m.P(0,c.y+l.y,0)}break;case ud.Bq.MESH:case ud.Bq.CONVEX_HULL:if(!this._options.mesh&&this._hasVertices(this.transformNode))this._options.mesh=this.transformNode;else if(!this._options.mesh||!this._hasVertices(this._options.mesh))throw new Error("No valid mesh was provided for mesh or convex hull shape parameter. Please provide a mesh with valid geometry (number of vertices greater than 0).");break;case ud.Bq.BOX:this._options.extents=null!==(o=this._options.extents)&&void 0!==o?o:new m.P(l.x,l.y,l.z),this._options.rotation=null!==(a=this._options.rotation)&&void 0!==a?a:m._f.Identity()}}dispose(){this._nodeDisposeObserver&&(this.body.transformNode.onDisposeObservable.remove(this._nodeDisposeObserver),this._nodeDisposeObserver=null),this.body.dispose(),this._disposeShapeWhenDisposed&&this.shape.dispose()}}var Td,Sd,Ed=i(30766);i(68522);class Rd{static GetContactPointToRef(e,t,i,s,r){const n=e.getScene().getPhysicsEngine(),o=null==n?void 0:n.getPluginVersion();if(1===o){const r=new At.z(t,i).intersectsMesh(e);if(r.hit&&r.pickedPoint)return s.copyFrom(r.pickedPoint),!0}else if(2===o)return e.physicsBody.getObjectCenterWorldToRef(s,r),!0;return!1}static HasAppliedForces(e,t){var i,s,r;return e.getMotionType(t)===ud.c4.STATIC||0===(null!==(s=null===(i=e.getMassProperties(t))||void 0===i?void 0:i.mass)&&void 0!==s?s:0)||0===(null===(r=e.transformNode)||void 0===r?void 0:r.getTotalVertices())}static IsInsideCylinder(e,t,i,s){const r=m.jp.Vector3[0];return e.subtractToRef(t,r),Math.abs(r.x)<=i&&Math.abs(r.z)<=i&&r.y>=0&&r.y<=s}}class Md{constructor(e){this._hitData={force:new m.P,contactPoint:new m.P,distanceFromOrigin:0},this._scene=e,this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine||p.Y.Warn("Physics engine not enabled. Please enable the physics before you can use the methods.")}applyRadialExplosionImpulse(e,t,i,s){if(!this._physicsEngine)return p.Y.Warn("Physics engine not enabled. Please enable the physics before you call this method."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;let r=!1;if("number"==typeof t){const e=t;(t=new Dd).radius=e,t.strength=null!=i?i:t.strength,t.falloff=null!=s?s:t.falloff}else r=!(!t.affectedImpostorsCallback&&!t.affectedBodiesCallback);const n=new Ad(this._scene,t),o=this._hitData;if(1===this._physicsEngine.getPluginVersion()){const t=Array();this._physicsEngine.getImpostors().forEach((i=>{n.getImpostorHitData(i,e,o)&&(i.applyImpulse(o.force,o.contactPoint),r&&t.push({impostor:i,hitData:this._copyPhysicsHitData(o)}))})),n.triggerAffectedImpostorsCallback(t)}else this._applicationForBodies(n,e,o,r,((e,t)=>{e.applyImpulse(t.force,t.contactPoint,t.instanceIndex)}));return n.dispose(!1),n}applyRadialExplosionForce(e,t,i,s){if(!this._physicsEngine)return p.Y.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;let r=!1;if("number"==typeof t){const e=t;(t=new Dd).radius=e,t.strength=null!=i?i:t.strength,t.falloff=null!=s?s:t.falloff}else r=!(!t.affectedImpostorsCallback&&!t.affectedBodiesCallback);const n=new Ad(this._scene,t),o=this._hitData;if(1===this._physicsEngine.getPluginVersion()){const t=Array();this._physicsEngine.getImpostors().forEach((i=>{n.getImpostorHitData(i,e,o)&&(i.applyForce(o.force,o.contactPoint),r&&t.push({impostor:i,hitData:this._copyPhysicsHitData(o)}))})),n.triggerAffectedImpostorsCallback(t)}else this._applicationForBodies(n,e,o,r,((e,t)=>{e.applyForce(t.force,t.contactPoint,t.instanceIndex)}));return n.dispose(!1),n}_applicationForBodies(e,t,i,s,r){const n=Array(),o=this._physicsEngine.getBodies();for(const a of o)a.iterateOverAllInstances(((o,a)=>{e.getBodyHitData(o,t,i,a)&&(r(o,i),s&&n.push({body:o,hitData:this._copyPhysicsHitData(i)}))}));e.triggerAffectedBodiesCallback(n)}gravitationalField(e,t,i,s){if(!this._physicsEngine)return p.Y.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;if("number"==typeof t){const e=t;(t=new Dd).radius=e,t.strength=null!=i?i:t.strength,t.falloff=null!=s?s:t.falloff}const r=new Id(this,this._scene,e,t);return r.dispose(!1),r}updraft(e,t,i,s,r){if(!this._physicsEngine)return p.Y.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;if("number"==typeof t){const e=t;(t=new Bd).radius=e,t.strength=null!=i?i:t.strength,t.height=null!=s?s:t.height,t.updraftMode=null!=r?r:t.updraftMode}const n=new Od(this._scene,e,t);return n.dispose(!1),n}vortex(e,t,i,s){if(!this._physicsEngine)return p.Y.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;if("number"==typeof t){const e=t;(t=new Nd).radius=e,t.strength=null!=i?i:t.strength,t.height=null!=s?s:t.height}const r=new wd(this._scene,e,t);return r.dispose(!1),r}_copyPhysicsHitData(e){return{force:e.force.clone(),contactPoint:e.contactPoint.clone(),distanceFromOrigin:e.distanceFromOrigin,instanceIndex:e.instanceIndex}}}class Ad{constructor(e,t){this._scene=e,this._options=t,this._dataFetched=!1,this._options=Object.assign(Object.assign({},new Dd),this._options)}getData(){return this._dataFetched=!0,{sphere:this._sphere}}_getHitData(e,t,i,s){const r=m.jp.Vector3[0];r.copyFrom(t).subtractInPlace(i);const n=m.jp.Vector3[1];if(!Rd.GetContactPointToRef(e,i,r,n,s.instanceIndex))return!1;const o=m.P.Distance(i,n);if(o>this._options.radius)return!1;const a=this._options.falloff===Td.Constant?this._options.strength:this._options.strength*(1-o/this._options.radius);return r.scaleInPlace(a),s.force.copyFrom(r),s.contactPoint.copyFrom(n),s.distanceFromOrigin=o,!0}getBodyHitData(e,t,i,s){if(Rd.HasAppliedForces(e,s))return!1;const r=e.transformNode,n=e.getObjectCenterWorld(s);return i.instanceIndex=s,this._getHitData(r,n,t,i)}getImpostorHitData(e,t,i){if(0===e.mass)return!1;if("Mesh"!==e.object.getClassName()&&"InstancedMesh"!==e.object.getClassName())return!1;const s=e.object;if(!this._intersectsWithSphere(s,t,this._options.radius))return!1;const r=e.getObjectCenter();return this._getHitData(s,r,t,i),!0}triggerAffectedImpostorsCallback(e){this._options.affectedImpostorsCallback&&this._options.affectedImpostorsCallback(e)}triggerAffectedBodiesCallback(e){this._options.affectedBodiesCallback&&this._options.affectedBodiesCallback(e)}dispose(e=!0){this._sphere&&(e?this._sphere.dispose():setTimeout((()=>{this._dataFetched||this._sphere.dispose()}),0))}_prepareSphere(){this._sphere||(this._sphere=(0,di.Qk)("radialExplosionEventSphere",this._options.sphere,this._scene),this._sphere.isVisible=!1)}_intersectsWithSphere(e,t,i){return this._prepareSphere(),this._sphere.position=t,this._sphere.scaling.setAll(2*i),this._sphere._updateBoundingInfo(),this._sphere.computeWorldMatrix(!0),this._sphere.intersectsMesh(e,!0)}}class Id{constructor(e,t,i,s){this._physicsHelper=e,this._scene=t,this._origin=i,this._options=s,this._dataFetched=!1,this._options=Object.assign(Object.assign({},new Dd),this._options),this._tickCallback=this._tick.bind(this),this._options.strength=-1*this._options.strength}getData(){return this._dataFetched=!0,{sphere:this._sphere}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._sphere&&(e?this._sphere.dispose():setTimeout((()=>{this._dataFetched||this._sphere.dispose()}),0))}_tick(){var e;if(this._sphere)this._physicsHelper.applyRadialExplosionForce(this._origin,this._options);else{const t=this._physicsHelper.applyRadialExplosionForce(this._origin,this._options);t&&(this._sphere=null===(e=t.getData().sphere)||void 0===e?void 0:e.clone("radialExplosionEventSphereClone"))}}}class Od{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=m.P.Zero(),this._originDirection=m.P.Zero(),this._cylinderPosition=m.P.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options=Object.assign(Object.assign({},new Bd),this._options),this._origin.addToRef(new m.P(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new m.P(0,this._options.height,0),this._originTop),this._options.updraftMode===Sd.Perpendicular&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=this._tick.bind(this),1===this._physicsEngine.getPluginVersion()&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?(this._cylinder.dispose(),this._cylinder=void 0):setTimeout((()=>{!this._dataFetched&&this._cylinder&&(this._cylinder.dispose(),this._cylinder=void 0)}),0))}_getHitData(e,t){let i;i=this._options.updraftMode===Sd.Perpendicular?this._originDirection:e.subtract(this._originTop);const s=m.P.Distance(this._origin,e),r=-1*this._options.strength,n=i.multiplyByFloats(r,r,r);t.force.copyFrom(n),t.contactPoint.copyFrom(e),t.distanceFromOrigin=s}_getBodyHitData(e,t,i){if(Rd.HasAppliedForces(e))return!1;const s=e.getObjectCenterWorld(i);return!!Rd.IsInsideCylinder(s,this._origin,this._options.radius,this._options.height)&&(t.instanceIndex=i,this._getHitData(s,t),!0)}_getImpostorHitData(e,t){if(0===e.mass)return!1;const i=e.object;if(!this._intersectsWithCylinder(i))return!1;const s=e.getObjectCenter();return this._getHitData(s,t),!0}_tick(){const e=Od._HitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach((t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)})):this._physicsEngine.getBodies().forEach((t=>{t.iterateOverAllInstances(((t,i)=>{this._getBodyHitData(t,e,i)&&t.applyForce(e.force,e.contactPoint,e.instanceIndex)}))}))}_prepareCylinder(){this._cylinder||(this._cylinder=(0,Ft.wf)("updraftEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return!!this._cylinder&&(this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0))}}Od._HitData={force:new m.P,contactPoint:new m.P,distanceFromOrigin:0};class wd{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=m.P.Zero(),this._cylinderPosition=m.P.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options=Object.assign(Object.assign({},new Nd),this._options),this._origin.addToRef(new m.P(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new m.P(0,this._options.height,0),this._originTop),this._tickCallback=this._tick.bind(this),1===this._physicsEngine.getPluginVersion()&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?this._cylinder.dispose():setTimeout((()=>{this._dataFetched||this._cylinder.dispose()}),0))}_getHitData(e,t,i){const s=wd.originOnPlane;s.set(this._origin.x,t.y,this._origin.z);const r=m.jp.Vector3[0];t.subtractToRef(s,r);const n=m.jp.Vector3[1];if(!Rd.GetContactPointToRef(e,s,r,n,i.instanceIndex))return!1;const o=m.P.Distance(n,s)/this._options.radius,a=m.jp.Vector3[2];let h,l,c;if(n.normalizeToRef(a),o>this._options.centripetalForceThreshold&&a.negateInPlace(),o>this._options.centripetalForceThreshold)h=a.x*this._options.centripetalForceMultiplier,l=a.y*this._options.updraftForceMultiplier,c=a.z*this._options.centripetalForceMultiplier;else{const e=m.P.Cross(s,t).normalize();h=(e.x+a.x)*this._options.centrifugalForceMultiplier,l=this._originTop.y*this._options.updraftForceMultiplier,c=(e.z+a.z)*this._options.centrifugalForceMultiplier}const u=m.jp.Vector3[3];return u.set(h,l,c),u.scaleInPlace(this._options.strength),i.force.copyFrom(u),i.contactPoint.copyFrom(t),i.distanceFromOrigin=o,!0}_getBodyHitData(e,t,i){if(Rd.HasAppliedForces(e,i))return!1;const s=e.transformNode,r=e.getObjectCenterWorld(i);return!!Rd.IsInsideCylinder(r,this._origin,this._options.radius,this._options.height)&&(t.instanceIndex=i,this._getHitData(s,r,t))}_getImpostorHitData(e,t){if(0===e.mass)return!1;if("Mesh"!==e.object.getClassName()&&"InstancedMesh"!==e.object.getClassName())return!1;const i=e.object;if(!this._intersectsWithCylinder(i))return!1;const s=e.getObjectCenter();return this._getHitData(i,s,t),!0}_tick(){const e=wd.hitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach((t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)})):this._physicsEngine.getBodies().forEach((t=>{t.iterateOverAllInstances(((t,i)=>{this._getBodyHitData(t,e,i)&&t.applyForce(e.force,e.contactPoint,e.instanceIndex)}))}))}_prepareCylinder(){this._cylinder||(this._cylinder=(0,Ft.wf)("vortexEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)}}wd.originOnPlane=m.P.Zero(),wd.hitData={force:new m.P,contactPoint:new m.P,distanceFromOrigin:0};class Dd{constructor(){this.radius=5,this.strength=10,this.falloff=Td.Constant,this.sphere={segments:32,diameter:1}}}class Bd{constructor(){this.radius=5,this.strength=10,this.height=10,this.updraftMode=Sd.Center}}class Nd{constructor(){this.radius=5,this.strength=10,this.height=10,this.centripetalForceThreshold=.7,this.centripetalForceMultiplier=5,this.centrifugalForceMultiplier=.5,this.updraftForceMultiplier=.02}}!function(e){e[e.Constant=0]="Constant",e[e.Linear=1]="Linear"}(Td||(Td={})),function(e){e[e.Center=0]="Center",e[e.Perpendicular=1]="Perpendicular"}(Sd||(Sd={}));var Fd=i(85388),Ld=i(13899);i(97077);class Vd extends Wr.D{getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,i,s,r,n){super(e,"blackAndWhite",["degree"],null,t,i,s,r,n),this.degree=1,this.onApplyObservable.add((e=>{e.setFloat("degree",this.degree)}))}static _Parse(e,t,i,s){return j.p4.Parse((()=>new Vd(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,H.gn)([(0,j.qC)()],Vd.prototype,"degree",void 0),(0,c.H)("BABYLON.BlackAndWhitePostProcess",Vd);var kd=i(7136),zd=i(52399),Gd=i(70298),Ud=i(15586);i(89772);class Wd extends Wr.D{getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,i,s,r,n,o){super(e,"colorCorrection",null,["colorTable"],i,s,r,n,o);const a=(null==s?void 0:s.getScene())||null;this._colorTableTexture=new X.x(t,a,!0,!1,X.x.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=X.x.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=X.x.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=e=>{e.setTexture("colorTable",this._colorTableTexture)}}static _Parse(e,t,i,s){return j.p4.Parse((()=>new Wd(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,H.gn)([(0,j.qC)()],Wd.prototype,"colorTableUrl",void 0),(0,c.H)("BABYLON.ColorCorrectionPostProcess",Wd),i(57366);class Hd extends Wr.D{getClassName(){return"ConvolutionPostProcess"}constructor(e,t,i,s,r,n,o,a=0){super(e,"convolution",["kernel","screenSize"],null,i,s,r,n,o,null,a),this.kernel=t,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setArray("kernel",this.kernel)}}static _Parse(e,t,i,s){return j.p4.Parse((()=>new Hd(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType)),e,i,s)}}Hd.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],Hd.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],Hd.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],Hd.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],Hd.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],Hd.GaussianKernel=[0,1,0,1,1,1,0,1,0],(0,H.gn)([(0,j.qC)()],Hd.prototype,"kernel",void 0),(0,c.H)("BABYLON.ConvolutionPostProcess",Hd);var jd=i(3491),$d=i(61686),Yd=i(13500);i(36956);class Xd extends Wr.D{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,s,r,n){super(e,"displayPass",["passSampler"],["passSampler"],t,i,s,r,n)}static _Parse(e,t,i,s){return j.p4.Parse((()=>new Xd(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,c.H)("BABYLON.DisplayPassPostProcess",Xd);var Qd=i(98044);i(6271);class qd extends Wr.D{getClassName(){return"FilterPostProcess"}constructor(e,t,i,s,r,n,o){super(e,"filter",["kernelMatrix"],null,i,s,r,n,o),this.kernelMatrix=t,this.onApply=e=>{e.setMatrix("kernelMatrix",this.kernelMatrix)}}static _Parse(e,t,i,s){return j.p4.Parse((()=>new qd(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,H.gn)([(0,j.oQ)()],qd.prototype,"kernelMatrix",void 0),(0,c.H)("BABYLON.FilterPostProcess",qd);var Kd=i(59995),Zd=i(98652);i(52725);class Jd extends Wr.D{getClassName(){return"HighlightsPostProcess"}constructor(e,t,i,s,r,n,o=0){super(e,"highlights",null,null,t,i,s,r,n,null,o)}}var ep=i(56703),tp=i(3114);i(75117);class ip extends Wr.D{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,i,s,r,n,o,a,h,l){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],n,o,a,h,l),this._ownRefractionTexture=!0,this.color=i,this.depth=s,this.colorLevel=r,this.refractionTextureUrl=t,this.onActivateObservable.add((e=>{this._refTexture=this._refTexture||new X.x(t,e.getScene())})),this.onApplyObservable.add((e=>{e.setColor3("baseColor",this.color),e.setFloat("depth",this.depth),e.setFloat("colorLevel",this.colorLevel),e.setTexture("refractionSampler",this._refTexture)}))}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,s){return j.p4.Parse((()=>new ip(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,H.gn)([(0,j.qC)()],ip.prototype,"color",void 0),(0,H.gn)([(0,j.qC)()],ip.prototype,"depth",void 0),(0,H.gn)([(0,j.qC)()],ip.prototype,"colorLevel",void 0),(0,H.gn)([(0,j.qC)()],ip.prototype,"refractionTextureUrl",void 0),(0,c.H)("BABYLON.RefractionPostProcess",ip);var sp=i(77036),rp=i(11333),np=i(87149),op=i(74785);Object.defineProperty(z.x.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let e=this._getComponent(k.l.NAME_POSTPROCESSRENDERPIPELINEMANAGER);e||(e=new ap(this),this._addComponent(e)),this._postProcessRenderPipelineManager=new op.a}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class ap{constructor(e){this.name=k.l.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(k.l.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}class hp extends rp.${get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){const e=this.bloom;this.bloom=new kd.r(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;const t=this.depthOfField;this.depthOfField=new $d.J(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let e=0;e<this._cameras.length;e++)t.disposeEffects(this._cameras[e]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new Gr.c("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return null!=this._glowLayer}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",t=!0,i=D.l.LastCreatedScene,s,r=!0){super(i.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=$d.z.Low,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new _.y$,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=s||i.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=r,this._scene=i;const n=this._scene.getEngine().getCaps();this._hdr=t&&(n.textureHalfFloatRender||n.textureFloatRender),this._hdr?n.textureHalfFloatRender?this._defaultPipelineTextureType=2:n.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,i.postProcessRenderPipelineManager.addPipeline(this);const o=this._scene.getEngine();this.sharpen=new sp.V("sharpen",1,null,X.x.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new np.L(o,this.SharpenPostProcessId,(()=>this.sharpen),!0),this.depthOfField=new $d.J(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=o.getHardwareScalingLevel(),this._resizeObserver=o.onResizeObservable.add((()=>{this._hardwareScaleLevel=o.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel})),this.bloom=new kd.r(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new Gd.n("ChromaticAberration",o.getRenderWidth(),o.getRenderHeight(),1,null,X.x.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new np.L(o,this.ChromaticAberrationPostProcessId,(()=>this.chromaticAberration),!0),this.grain=new Zd.p("Grain",1,null,X.x.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new np.L(o,this.GrainPostProcessId,(()=>this.grain),!0),this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add((()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,w.w1.SetImmediate((()=>{this._buildPipeline()})))})),this._buildPipeline()}getClassName(){return"DefaultRenderingPipeline"}prepare(){const e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;const e=this._scene.getEngine();if(this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(const e of this._cameras)this._scene.enableDepthRenderer(e).useOnlyInActiveCamera=!0;this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add((e=>{this._cameras.indexOf(e.activeCamera)>-1&&(this.depthOfField.depthTexture=e.enableDepthRenderer(e.activeCamera).getDepthMap())}))}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);const e=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=e.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new Dt.z("imageProcessing",1,null,X.x.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new np.L(e,this.ImageProcessingPostProcessId,(()=>this.imageProcessing),!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._cameras&&0!==this._cameras.length||(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new Kd.P("fxaa",1,null,X.x.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new np.L(e,this.FxaaPostProcessId,(()=>this.fxaa),!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera))&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add((()=>{this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera)&&(this._scene.autoClear=!0)}))),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add((()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)}))),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&p.Y.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene._postProcessRenderPipelineManager.removePipeline(this.name),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){const e=j.p4.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return j.p4.Parse((()=>new hp(e._name,e._name._hdr,t)),e,t,i)}}(0,H.gn)([(0,j.qC)()],hp.prototype,"sharpenEnabled",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"bloomKernel",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"_bloomWeight",void 0),(0,H.gn)([(0,j.qC)()],hp.prototype,"_bloomThreshold",void 0),(0,H.gn)([(0,j.qC)()],hp.prototype,"_hdr",void 0),(0,H.gn)([(0,j.qC)()],hp.prototype,"bloomWeight",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"bloomThreshold",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"bloomScale",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"bloomEnabled",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"depthOfFieldEnabled",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"depthOfFieldBlurLevel",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"fxaaEnabled",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"samples",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"imageProcessingEnabled",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"glowLayerEnabled",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"chromaticAberrationEnabled",null),(0,H.gn)([(0,j.qC)()],hp.prototype,"grainEnabled",null),(0,c.H)("BABYLON.DefaultRenderingPipeline",hp),i(90826),i(74975),i(16284);class lp extends rp.${constructor(e,t,i,s=1,r){super(i.getEngine(),e),this.LensChromaticAberrationEffect="LensChromaticAberrationEffect",this.HighlightsEnhancingEffect="HighlightsEnhancingEffect",this.LensDepthOfFieldEffect="LensDepthOfFieldEffect",this._pentagonBokehIsEnabled=!1,this._scene=i,this._depthTexture=i.enableDepthRenderer().getDepthMap(),t.grain_texture?this._grainTexture=t.grain_texture:this._createGrainTexture(),this._edgeBlur=t.edge_blur?t.edge_blur:0,this._grainAmount=t.grain_amount?t.grain_amount:0,this._chromaticAberration=t.chromatic_aberration?t.chromatic_aberration:0,this._distortion=t.distortion?t.distortion:0,this._highlightsGain=void 0!==t.dof_gain?t.dof_gain:-1,this._highlightsThreshold=t.dof_threshold?t.dof_threshold:1,this._dofDistance=void 0!==t.dof_focus_distance?t.dof_focus_distance:-1,this._dofAperture=t.dof_aperture?t.dof_aperture:1,this._dofDarken=t.dof_darken?t.dof_darken:0,this._dofPentagon=void 0===t.dof_pentagon||t.dof_pentagon,this._blurNoise=void 0===t.blur_noise||t.blur_noise,this._createChromaticAberrationPostProcess(s),this._createHighlightsPostProcess(s),this._createDepthOfFieldPostProcess(s/4),this.addEffect(new np.L(i.getEngine(),this.LensChromaticAberrationEffect,(()=>this._chromaticAberrationPostProcess),!0)),this.addEffect(new np.L(i.getEngine(),this.HighlightsEnhancingEffect,(()=>this._highlightsPostProcess),!0)),this.addEffect(new np.L(i.getEngine(),this.LensDepthOfFieldEffect,(()=>this._depthOfFieldPostProcess),!0)),-1===this._highlightsGain&&this._disableEffect(this.HighlightsEnhancingEffect,null),i.postProcessRenderPipelineManager.addPipeline(this),r&&i.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}getClassName(){return"LensRenderingPipeline"}get scene(){return this._scene}get edgeBlur(){return this._edgeBlur}set edgeBlur(e){this.setEdgeBlur(e)}get grainAmount(){return this._grainAmount}set grainAmount(e){this.setGrainAmount(e)}get chromaticAberration(){return this._chromaticAberration}set chromaticAberration(e){this.setChromaticAberration(e)}get dofAperture(){return this._dofAperture}set dofAperture(e){this.setAperture(e)}get edgeDistortion(){return this._distortion}set edgeDistortion(e){this.setEdgeDistortion(e)}get dofDistortion(){return this._dofDistance}set dofDistortion(e){this.setFocusDistance(e)}get darkenOutOfFocus(){return this._dofDarken}set darkenOutOfFocus(e){this.setDarkenOutOfFocus(e)}get blurNoise(){return this._blurNoise}set blurNoise(e){this._blurNoise=e}get pentagonBokeh(){return this._pentagonBokehIsEnabled}set pentagonBokeh(e){e?this.enablePentagonBokeh():this.disablePentagonBokeh()}get highlightsGain(){return this._highlightsGain}set highlightsGain(e){this.setHighlightsGain(e)}get highlightsThreshold(){return this._highlightsThreshold}set highlightsThreshold(e){this.setHighlightsThreshold(e)}setEdgeBlur(e){this._edgeBlur=e}disableEdgeBlur(){this._edgeBlur=0}setGrainAmount(e){this._grainAmount=e}disableGrain(){this._grainAmount=0}setChromaticAberration(e){this._chromaticAberration=e}disableChromaticAberration(){this._chromaticAberration=0}setEdgeDistortion(e){this._distortion=e}disableEdgeDistortion(){this._distortion=0}setFocusDistance(e){this._dofDistance=e}disableDepthOfField(){this._dofDistance=-1}setAperture(e){this._dofAperture=e}setDarkenOutOfFocus(e){this._dofDarken=e}enablePentagonBokeh(){this._highlightsPostProcess.updateEffect("#define PENTAGON\n"),this._pentagonBokehIsEnabled=!0}disablePentagonBokeh(){this._pentagonBokehIsEnabled=!1,this._highlightsPostProcess.updateEffect()}enableNoiseBlur(){this._blurNoise=!0}disableNoiseBlur(){this._blurNoise=!1}setHighlightsGain(e){this._highlightsGain=e}setHighlightsThreshold(e){-1===this._highlightsGain&&(this._highlightsGain=1),this._highlightsThreshold=e}disableHighlights(){this._highlightsGain=-1}dispose(e=!1){this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._chromaticAberrationPostProcess=null,this._highlightsPostProcess=null,this._depthOfFieldPostProcess=null,this._grainTexture.dispose(),e&&this._scene.disableDepthRenderer()}_createChromaticAberrationPostProcess(e){this._chromaticAberrationPostProcess=new Wr.D("LensChromaticAberration","chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],e,null,X.x.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._chromaticAberrationPostProcess.onApply=e=>{e.setFloat("chromatic_aberration",this._chromaticAberration),e.setFloat("screen_width",this._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",this._scene.getEngine().getRenderHeight()),e.setFloat("radialIntensity",1),e.setFloat2("direction",17,17),e.setFloat2("centerPosition",.5,.5)}}_createHighlightsPostProcess(e){this._highlightsPostProcess=new Wr.D("LensHighlights","lensHighlights",["gain","threshold","screen_width","screen_height"],[],e,null,X.x.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,this._dofPentagon?"#define PENTAGON\n":""),this._highlightsPostProcess.externalTextureSamplerBinding=!0,this._highlightsPostProcess.onApply=e=>{e.setFloat("gain",this._highlightsGain),e.setFloat("threshold",this._highlightsThreshold),e.setTextureFromPostProcess("textureSampler",this._chromaticAberrationPostProcess),e.setFloat("screen_width",this._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",this._scene.getEngine().getRenderHeight())}}_createDepthOfFieldPostProcess(e){this._depthOfFieldPostProcess=new Wr.D("LensDepthOfField","depthOfField",["grain_amount","blur_noise","screen_width","screen_height","distortion","dof_enabled","screen_distance","aperture","darken","edge_blur","highlights","near","far"],["depthSampler","grainSampler","highlightsSampler"],e,null,X.x.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._depthOfFieldPostProcess.externalTextureSamplerBinding=!0,this._depthOfFieldPostProcess.onApply=e=>{e.setTexture("depthSampler",this._depthTexture),e.setTexture("grainSampler",this._grainTexture),e.setTextureFromPostProcess("textureSampler",this._highlightsPostProcess),e.setTextureFromPostProcess("highlightsSampler",this._depthOfFieldPostProcess),e.setFloat("grain_amount",this._grainAmount),e.setBool("blur_noise",this._blurNoise),e.setFloat("screen_width",this._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",this._scene.getEngine().getRenderHeight()),e.setFloat("distortion",this._distortion),e.setBool("dof_enabled",-1!==this._dofDistance),e.setFloat("screen_distance",1/(.1-1/this._dofDistance)),e.setFloat("aperture",this._dofAperture),e.setFloat("darken",this._dofDarken),e.setFloat("edge_blur",this._edgeBlur),e.setBool("highlights",-1!==this._highlightsGain),this._scene.activeCamera&&(e.setFloat("near",this._scene.activeCamera.minZ),e.setFloat("far",this._scene.activeCamera.maxZ))}}_createGrainTexture(){this._grainTexture=new wt.c("LensNoiseTexture",512,this._scene,!1,X.x.BILINEAR_SAMPLINGMODE),this._grainTexture.wrapU=X.x.WRAP_ADDRESSMODE,this._grainTexture.wrapV=X.x.WRAP_ADDRESSMODE;const e=this._grainTexture.getContext();let t;for(let i=0;i<512;i++)for(let s=0;s<512;s++)t=Math.floor(255*(.42,.58,Math.random()*(.58-.42)+.42)),e.fillStyle="rgb("+t+", "+t+", "+t+")",e.fillRect(i,s,1,1);this._grainTexture.update(!1)}}var cp=i(46590);i(38032),i(328);class up extends rp.${set epsilon(e){this._epsilon=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO())}get epsilon(){return this._epsilon}set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set bypassBlur(e){const t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this._blurHPostProcess.updateEffect(t.h,null,i),this._blurVPostProcess.updateEffect(t.v,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){const t=this._getDefinesForBlur(e,this._bypassBlur);this._blurHPostProcess.updateEffect(t.h),this._blurVPostProcess.updateEffect(t.v),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){const e=D.l.LastCreatedEngine;return!!e&&e._features.supportSSAO2}get scene(){return this._scene}constructor(e,t,i,s,r=!1,n=0){if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._epsilon=.02,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this.radius=2,this.base=0,this._bypassBlur=!1,this._expensiveBlur=!0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._textureType=n,this._forceGeometryBuffer=r,!this.isSupported)return void p.Y.Error("The current engine does not support SSAO 2.");const o=this._ratio.ssaoRatio||i,a=this._ratio.blurRatio||i;this._forceGeometryBuffer?t.enableGeometryBufferRenderer():t.enablePrePassRenderer(),this._createRandomTexture(),this._originalColorPostProcess=new Hr.Q("SSAOOriginalSceneColor",1,null,X.x.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,n),this._createBlurPostProcess(o,a,this._textureType),this._createSSAOCombinePostProcess(a,this._textureType),this.addEffect(new np.L(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new np.L(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new np.L(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new np.L(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new np.L(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_rebuild(){super._rebuild()}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i="#define BLUR\n";return t&&(i+="#define BLUR_BYPASS\n"),e||(i+="#define BLUR_LEGACY\n"),{h:i+"#define BLUR_H\n",v:i}}_createBlurPostProcess(e,t,i){const s=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),r=this._getSamplersForBlur(this.bypassBlur);this._blurHPostProcess=this._createBlurFilter("BlurH",r,e,s.h,i,!0),this._blurVPostProcess=this._createBlurFilter("BlurV",r,t,s.v,i,!1)}_createBlurFilter(e,t,i,s,r,n){const o=new Wr.D(e,"ssao2",["outSize","samples","soften","tolerance"],t,i,null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s,r);return o.onApply=e=>{if(!this._scene.activeCamera)return;const t=n?this._ssaoCombinePostProcess.width:this._ssaoCombinePostProcess.height,i=n?this._originalColorPostProcess.width:this._originalColorPostProcess.height;e.setFloat("outSize",t>0?t:i),e.setInt("samples",this.bilateralSamples),e.setFloat("soften",this.bilateralSoften),e.setFloat("tolerance",this.bilateralTolerance),this._geometryBufferRenderer?e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)])},o.samples=this.textureSamples,o}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(1431655765&this._bits[0])<<1|(2863311530&this._bits[0])>>>1>>>0,this._bits[0]=(858993459&this._bits[0])<<2|(3435973836&this._bits[0])>>>2>>>0,this._bits[0]=(252645135&this._bits[0])<<4|(4042322160&this._bits[0])>>>4>>>0,this._bits[0]=(16711935&this._bits[0])<<8|(4278255360&this._bits[0])>>>8>>>0,2.3283064365386963e-10*this._bits[0]}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){const i=2*t*Math.PI,s=1-.85*e,r=Math.sqrt(1-s*s);return new m.P(Math.cos(i)*r,Math.sin(i)*r,s)}_generateHemisphere(){const e=this.samples,t=[];let i,s=0;for(;s<e;){if(e<16)i=this._hemisphereSample_uniform(Math.random(),Math.random());else{const t=this._hammersley(s,e);i=this._hemisphereSample_uniform(t[0],t[1])}t.push(i.x,i.y,i.z),s++}return t}_getDefinesForSSAO(){return`#define SSAO\n#define SAMPLES ${this.samples}\n#define EPSILON ${this.epsilon.toFixed(4)}`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();const i=this._getDefinesForSSAO();this._ssaoPostProcess=new Wr.D("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],["randomSampler","depthSampler","normalSampler"],e,null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i,t),this._ssaoPostProcess.onApply=e=>{var t,i,s,r;if(this._scene.activeCamera){if(e.setArray3("sampleSphere",this._sampleSphere),e.setFloat("randTextureTiles",32),e.setFloat("samplesFactor",1/this.samples),e.setFloat("totalStrength",this.totalStrength),e.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),e.setFloat("radius",this.radius),e.setFloat("maxZ",this.maxZ),e.setFloat("minZAspect",this.minZAspect),e.setFloat("base",this.base),e.setFloat("near",this._scene.activeCamera.minZ),this._scene.activeCamera.mode===Ue.V.PERSPECTIVE_CAMERA)e.setMatrix3x3("depthProjection",up.PERSPECTIVE_DEPTH_PROJECTION),e.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),e.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{const n=this._scene.getEngine().getRenderWidth()/2,o=this._scene.getEngine().getRenderHeight()/2,a=null!==(t=this._scene.activeCamera.orthoLeft)&&void 0!==t?t:-n,h=null!==(i=this._scene.activeCamera.orthoRight)&&void 0!==i?i:n,l=null!==(s=this._scene.activeCamera.orthoBottom)&&void 0!==s?s:-o,c=null!==(r=this._scene.activeCamera.orthoTop)&&void 0!==r?r:o;e.setMatrix3x3("depthProjection",up.ORTHO_DEPTH_PROJECTION),e.setFloat("xViewport",.5*(h-a)),e.setFloat("yViewport",.5*(c-l))}e.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),e.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),e.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),e.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new cp.M)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new Wr.D("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t),this._ssaoCombinePostProcess.onApply=e=>{const t=this._scene.activeCamera.viewport;e.setVector4("viewport",m.jp.Vector4[0].copyFromFloats(t.x,t.y,t.width,t.height)),e.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){this._randomTexture=new wt.c("SSAORandomTexture",128,this._scene,!1,X.x.BILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=X.x.WRAP_ADDRESSMODE,this._randomTexture.wrapV=X.x.WRAP_ADDRESSMODE;const e=this._randomTexture.getContext(),t=(e,t)=>Math.random()*(t-e)+e,i=m.P.Zero();for(let s=0;s<128;s++)for(let r=0;r<128;r++)i.x=t(0,1),i.y=t(0,1),i.z=0,i.normalize(),i.scaleInPlace(255),i.x=Math.floor(i.x),i.y=Math.floor(i.y),e.fillStyle="rgb("+i.x+", "+i.y+", "+i.z+")",e.fillRect(s,r,1,1);this._randomTexture.update(!1)}serialize(){const e=j.p4.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return j.p4.Parse((()=>new up(e._name,t,e._ratio,void 0,e._forceGeometryBuffer,e._textureType)),e,t,i)}}up.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],up.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],(0,H.gn)([(0,j.qC)()],up.prototype,"totalStrength",void 0),(0,H.gn)([(0,j.qC)()],up.prototype,"maxZ",void 0),(0,H.gn)([(0,j.qC)()],up.prototype,"minZAspect",void 0),(0,H.gn)([(0,j.qC)("epsilon")],up.prototype,"_epsilon",void 0),(0,H.gn)([(0,j.qC)("samples")],up.prototype,"_samples",void 0),(0,H.gn)([(0,j.qC)("textureSamples")],up.prototype,"_textureSamples",void 0),(0,H.gn)([(0,j.qC)()],up.prototype,"_forceGeometryBuffer",void 0),(0,H.gn)([(0,j.qC)()],up.prototype,"_ratio",void 0),(0,H.gn)([(0,j.qC)()],up.prototype,"_textureType",void 0),(0,H.gn)([(0,j.qC)()],up.prototype,"radius",void 0),(0,H.gn)([(0,j.qC)()],up.prototype,"base",void 0),(0,H.gn)([(0,j.qC)("bypassBlur")],up.prototype,"_bypassBlur",void 0),(0,H.gn)([(0,j.qC)("expensiveBlur")],up.prototype,"_expensiveBlur",void 0),(0,H.gn)([(0,j.qC)()],up.prototype,"bilateralSamples",void 0),(0,H.gn)([(0,j.qC)()],up.prototype,"bilateralSoften",void 0),(0,H.gn)([(0,j.qC)()],up.prototype,"bilateralTolerance",void 0),(0,c.H)("BABYLON.SSAO2RenderingPipeline",up),i(93446);class dp extends rp.${get scene(){return this._scene}constructor(e,t,i,s){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();const r=i.ssaoRatio||i,n=i.combineRatio||i;this._originalColorPostProcess=new Hr.Q("SSAOOriginalSceneColor",n,null,X.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(r),this._createBlurPostProcess(r),this._createSSAOCombinePostProcess(n),this.addEffect(new np.L(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new np.L(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new np.L(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new np.L(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new np.L(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}_attachCameras(e,t){super._attachCameras(e,t);for(const e of this._cameras)this._scene.enableDepthRenderer(e).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new jr.i("BlurH",new m.FM(1,0),16,e,null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new jr.i("BlurV",new m.FM(0,1),16,e,null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add((()=>{const e=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*e})),this._blurVPostProcess.onActivateObservable.add((()=>{const e=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*e}))}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){const t=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this._ssaoPostProcess=new Wr.D("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES 16\n#define SSAO"),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=e=>{this._firstUpdate&&(e.setArray3("sampleSphere",t),e.setFloat("samplesFactor",.0625),e.setFloat("randTextureTiles",4)),e.setFloat("totalStrength",this.totalStrength),e.setFloat("radius",this.radius),e.setFloat("area",this.area),e.setFloat("fallOff",this.fallOff),e.setFloat("base",this.base),e.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),e.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new Wr.D("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,X.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=e=>{e.setVector4("viewport",m.jp.Vector4[0].copyFromFloats(0,0,1,1)),e.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){this._randomTexture=new wt.c("SSAORandomTexture",512,this._scene,!1,X.x.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=X.x.WRAP_ADDRESSMODE,this._randomTexture.wrapV=X.x.WRAP_ADDRESSMODE;const e=this._randomTexture.getContext(),t=(e,t)=>Math.random()*(t-e)+e,i=m.P.Zero();for(let s=0;s<512;s++)for(let r=0;r<512;r++)i.x=Math.floor(255*Math.max(0,t(-1,1))),i.y=Math.floor(255*Math.max(0,t(-1,1))),i.z=Math.floor(255*Math.max(0,t(-1,1))),e.fillStyle="rgb("+i.x+", "+i.y+", "+i.z+")",e.fillRect(s,r,1,1);this._randomTexture.update(!1)}}(0,H.gn)([(0,j.qC)()],dp.prototype,"totalStrength",void 0),(0,H.gn)([(0,j.qC)()],dp.prototype,"radius",void 0),(0,H.gn)([(0,j.qC)()],dp.prototype,"area",void 0),(0,H.gn)([(0,j.qC)()],dp.prototype,"fallOff",void 0),(0,H.gn)([(0,j.qC)()],dp.prototype,"base",void 0);var pp=i(51248);i(30395);class _p extends rp.${get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){const t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join("\n"))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){const t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer())return void p.Y.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,i,s=null,r){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=r||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=s,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){const e=this._ratio,t=this._scene;this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new pp.G("HDRPass",t,e,null,X.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess})),this.addEffect(new np.L(t.getEngine(),"HDRScreenSpaceReflections",(()=>this.screenSpaceReflectionPostProcess),!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new Wr.D("HDRPass","standard",[],[],e,null,X.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.originalPostProcess})),this.addEffect(new np.L(t.getEngine(),"HDRPassPostProcess",(()=>this.originalPostProcess),!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new Wr.D("HDRDepthOfFieldSource","standard",[],[],e,null,X.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new np.L(t.getEngine(),"HDRBaseDepthOfFieldSource",(()=>this.textureAdderFinalPostProcess),!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new Wr.D("HDRVLSFinal","standard",[],[],e,null,X.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new np.L(t.getEngine(),"HDRVLSFinal",(()=>this.volumetricLightFinalPostProcess),!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new Wr.D("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,X.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new np.L(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",(()=>this.lensFlareFinalPostProcess),!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new Wr.D("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,X.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new np.L(t.getEngine(),"HDRPostHDReDepthOfFieldSource",(()=>this.hdrFinalPostProcess),!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new Kd.P("fxaa",1,null,X.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new np.L(t.getEngine(),"HDRFxaa",(()=>this.fxaaPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&p.Y.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){const i=new Array(32);this.downSampleX4PostProcess=new Wr.D("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=e=>{let t=0;const s=this.downSampleX4PostProcess.width,r=this.downSampleX4PostProcess.height;for(let e=-2;e<2;e++)for(let n=-2;n<2;n++)i[t]=(e+.5)*(1/s),i[t+1]=(n+.5)*(1/r),t+=2;e.setArray2("dsOffsets",i)},this.addEffect(new np.L(e.getEngine(),"HDRDownSampleX4",(()=>this.downSampleX4PostProcess),!0))}_createBrightPassPostProcess(e,t){const i=new Array(8);this.brightPassPostProcess=new Wr.D("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=e=>{const t=1/this.brightPassPostProcess.width,s=1/this.brightPassPostProcess.height;i[0]=-.5*t,i[1]=.5*s,i[2]=.5*t,i[3]=.5*s,i[4]=-.5*t,i[5]=-.5*s,i[6]=.5*t,i[7]=-.5*s,e.setArray2("dsOffsets",i),e.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new np.L(e.getEngine(),"HDRBrightPass",(()=>this.brightPassPostProcess),!0))}_createBlurPostProcesses(e,t,i,s="blurWidth"){const r=e.getEngine(),n=new jr.i("HDRBlurH_"+i,new m.FM(1,0),this[s],t,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),o=new jr.i("HDRBlurV_"+i,new m.FM(0,1),this[s],t,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);n.onActivateObservable.add((()=>{const e=n.width/r.getRenderWidth();n.kernel=this[s]*e})),o.onActivateObservable.add((()=>{const e=o.height/r.getRenderHeight();o.kernel=this.horizontalBlur?64*e:this[s]*e})),this.addEffect(new np.L(e.getEngine(),"HDRBlurH"+i,(()=>n),!0)),this.addEffect(new np.L(e.getEngine(),"HDRBlurV"+i,(()=>o),!0)),this.blurHPostProcesses.push(n),this.blurVPostProcesses.push(o)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new Wr.D("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),e.setTexture("lensSampler",this.lensTexture),e.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new np.L(e.getEngine(),"HDRTextureAdder",(()=>this.textureAdderPostProcess),!0))}_createVolumetricLightPostProcess(e,t){const i=e.enableGeometryBufferRenderer();i.enablePosition=!0;const s=i.getGBuffer();this.volumetricLightPostProcess=new Wr.D("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));const r=m.FM.Zero();this.volumetricLightPostProcess.onApply=e=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){const t=this.sourceLight.getShadowGenerator();e.setTexture("shadowMapSampler",t.getShadowMap()),e.setTexture("positionSampler",s.textures[2]),e.setColor3("sunColor",this.sourceLight.diffuse),e.setVector3("sunDirection",this.sourceLight.getShadowDirection()),e.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),e.setMatrix("shadowViewProjection",t.getTransformMatrix()),e.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),e.setFloat("scatteringPower",this.volumetricLightPower),r.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),r.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),e.setVector2("depthValues",r)}},this.addEffect(new np.L(e.getEngine(),"HDRVLS",(()=>this.volumetricLightPostProcess),!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new Wr.D("HDRVLSMerge","standard",[],["originalSampler"],t,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=e=>{e.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new np.L(e.getEngine(),"HDRVLSMerge",(()=>this.volumetricLightMergePostProces),!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,_p.LuminanceSteps);this.luminancePostProcess=new Wr.D("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);const s=[];this.luminancePostProcess.onApply=e=>{const t=1/this.luminancePostProcess.width,i=1/this.luminancePostProcess.height;s[0]=-.5*t,s[1]=.5*i,s[2]=.5*t,s[3]=.5*i,s[4]=-.5*t,s[5]=-.5*i,s[6]=.5*t,s[7]=-.5*i,e.setArray2("lumOffsets",s)},this.addEffect(new np.L(e.getEngine(),"HDRLuminance",(()=>this.luminancePostProcess),!0));for(let s=_p.LuminanceSteps-1;s>=0;s--){i=Math.pow(3,s);let r="#define LUMINANCE_DOWN_SAMPLE\n";0===s&&(r+="#define FINAL_DOWN_SAMPLER");const n=new Wr.D("HDRLuminanceDownSample"+s,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,t);this.luminanceDownSamplePostProcesses.push(n)}let r=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(((t,i)=>{const s=new Array(18);t.onApply=e=>{if(!r)return;let n=0;for(let e=-1;e<2;e++)for(let t=-1;t<2;t++)s[n]=e/r.width,s[n+1]=t/r.height,n+=2;e.setArray2("dsOffsets",s),e.setFloat("halfDestPixelSize",.5/r.width),r=i===this.luminanceDownSamplePostProcesses.length-1?this.luminancePostProcess:t},i===this.luminanceDownSamplePostProcesses.length-1&&(t.onAfterRender=()=>{const t=e.getEngine().readPixels(0,0,1,1),i=new m.Lt(1/16581375,1/65025,1/255,1);t.then((e=>{const t=new Uint8Array(e.buffer);this._hdrCurrentLuminance=(t[0]*i.x+t[1]*i.y+t[2]*i.z+t[3]*i.w)/100}))}),this.addEffect(new np.L(e.getEngine(),"HDRLuminanceDownSample"+i,(()=>t),!0))}))}_createHdrPostProcess(e,t){const i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new Wr.D("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join("\n"),0);let s=1,r=0,n=0;this.hdrPostProcess.onApply=t=>{if(t.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),r+=e.getEngine().getDeltaTime(),s<0)s=this._hdrCurrentLuminance;else{const e=(n-r)/1e3;this._hdrCurrentLuminance<s+this.hdrDecreaseRate*e?s+=this.hdrDecreaseRate*e:this._hdrCurrentLuminance>s-this.hdrIncreaseRate*e?s-=this.hdrIncreaseRate*e:s=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/s:(s=Po.R.Clamp(s,this.hdrMinimumLuminance,1e20),t.setFloat("averageLuminance",s)),n=r,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new np.L(e.getEngine(),"HDR",(()=>this.hdrPostProcess),!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new Wr.D("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new np.L(e.getEngine(),"HDRLensFlare",(()=>this.lensFlarePostProcess),!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new Wr.D("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new np.L(e.getEngine(),"HDRLensFlareCompose",(()=>this.lensFlareComposePostProcess),!0));const i=new m.FM(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=e=>{e.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),e.setTexture("lensColorSampler",this.lensColorTexture),e.setFloat("strength",this.lensFlareStrength),e.setFloat("ghostDispersal",this.lensFlareGhostDispersal),e.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,e.setVector2("resolution",i),e.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const s=m.y3.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),r=m.y3.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=e=>{if(!this._scene.activeCamera)return;e.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),e.setTexture("lensDirtSampler",this.lensFlareDirtTexture),e.setTexture("lensStarSampler",this.lensStarTexture);const t=this._scene.activeCamera.getViewMatrix().getRow(0),i=this._scene.activeCamera.getViewMatrix().getRow(2);let n=m.P.Dot(t.toVector3(),new m.P(1,0,0))+m.P.Dot(i.toVector3(),new m.P(0,0,1));n*=4;const o=m.y3.FromValues(.5*Math.cos(n),-Math.sin(n),0,0,Math.sin(n),.5*Math.cos(n),0,0,0,0,1,0,0,0,0,1),a=r.multiply(o).multiply(s);e.setMatrix("lensStarMatrix",a),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new Wr.D("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),e.setTexture("depthSampler",this._getDepthTexture()),e.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new np.L(e.getEngine(),"HDRDepthOfField",(()=>this.depthOfFieldPostProcess),!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){const i=new ep.b("HDRMotionBlur",e,t,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new Wr.D("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,X.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),0);let i=0,s=m.y3.Identity();const r=m.y3.Identity();let n=m.y3.Identity();const o=m.FM.Zero();this.motionBlurPostProcess.onApply=t=>{n=e.getProjectionMatrix().multiply(e.getViewMatrix()),n.invertToRef(r),t.setMatrix("inverseViewProjection",r),t.setMatrix("prevViewProjection",s),s=n,o.x=this.motionBlurPostProcess.width,o.y=this.motionBlurPostProcess.height,t.setVector2("screenSize",o),i=e.getEngine().getFps()/60,t.setFloat("motionScale",i),t.setFloat("motionStrength",this.motionStrength),t.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new np.L(e.getEngine(),"HDRMotionBlur",(()=>this.motionBlurPostProcess),!0))}_getDepthTexture(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let e=0;e<this.luminanceDownSamplePostProcesses.length;e++)this.luminanceDownSamplePostProcesses[e].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let e=0;e<this.blurHPostProcesses.length;e++)this.blurHPostProcesses[e].dispose(t);for(let e=0;e<this.blurVPostProcesses.length;e++)this.blurVPostProcesses[e].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){const e=j.p4.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=j.p4.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){const s=j.p4.Parse((()=>new _p(e._name,t,e._ratio)),e,t,i);return e.sourceLightId&&(s.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&j.p4.Parse((()=>s.screenSpaceReflectionPostProcess),e.screenSpaceReflectionPostProcess,t,i),s}}_p.LuminanceSteps=6,(0,H.gn)([(0,j.qC)()],_p.prototype,"brightThreshold",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"blurWidth",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"horizontalBlur",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"exposure",null),(0,H.gn)([(0,j.oU)("lensTexture")],_p.prototype,"lensTexture",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"volumetricLightCoefficient",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"volumetricLightPower",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"volumetricLightBlurScale",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"hdrMinimumLuminance",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"hdrDecreaseRate",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"hdrIncreaseRate",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"hdrAutoExposure",null),(0,H.gn)([(0,j.oU)("lensColorTexture")],_p.prototype,"lensColorTexture",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"lensFlareStrength",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"lensFlareGhostDispersal",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"lensFlareHaloWidth",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"lensFlareDistortionStrength",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"lensFlareBlurWidth",void 0),(0,H.gn)([(0,j.oU)("lensStarTexture")],_p.prototype,"lensStarTexture",void 0),(0,H.gn)([(0,j.oU)("lensFlareDirtTexture")],_p.prototype,"lensFlareDirtTexture",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"depthOfFieldDistance",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"depthOfFieldBlurWidth",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"motionStrength",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"objectBasedMotionBlur",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"_ratio",void 0),(0,H.gn)([(0,j.qC)()],_p.prototype,"BloomEnabled",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"DepthOfFieldEnabled",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"LensFlareEnabled",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"HDREnabled",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"VLSEnabled",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"MotionBlurEnabled",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"fxaaEnabled",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"screenSpaceReflectionsEnabled",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"volumetricLightStepsCount",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"motionBlurSamples",null),(0,H.gn)([(0,j.qC)()],_p.prototype,"samples",null),(0,c.H)("BABYLON.StandardRenderingPipeline",_p);var gp=i(1936),mp=i(90065),fp=i(21984);i(2057),i(67769),i(35368);const bp=m.y3.Compose(new m.P(.5,.5,.5),m._f.Identity(),new m.P(.5,.5,.5)),vp=m.y3.Compose(new m.P(.5,.5,1),m._f.Identity(),new m.P(.5,.5,0));class yp extends rp.${set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(0===e&&0!==this._reflectivityThreshold||0!==e&&0===this._reflectivityThreshold?(this._reflectivityThreshold=e,this._buildPipeline()):this._reflectivityThreshold=e)}get ssrDownsample(){return this._ssrDownsample}set ssrDownsample(e){e!==this._ssrDownsample&&(this._ssrDownsample=e,this._buildPipeline())}get blurDispersionStrength(){return this._blurDispersionStrength}set blurDispersionStrength(e){if(e===this._blurDispersionStrength)return;const t=0===e&&0!==this._blurDispersionStrength||0!==e&&0===this._blurDispersionStrength;this._blurDispersionStrength=e,t&&this._buildPipeline()}_useBlur(){return this._blurDispersionStrength>0}get blurDownsample(){return this._blurDownsample}set blurDownsample(e){e!==this._blurDownsample&&(this._blurDownsample=e,this._buildPipeline())}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateIntersectionIterations(){return this._attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._attenuateIntersectionIterations!==e&&(this._attenuateIntersectionIterations=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._buildPipeline())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._buildPipeline())}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureDownsample(){return this._backfaceDepthTextureDownsample}set backfaceDepthTextureDownsample(e){this._backfaceDepthTextureDownsample!==e&&(this._backfaceDepthTextureDownsample=e,this._resizeDepthRenderer())}get backfaceForceDepthWriteTransparentMeshes(){return this._backfaceForceDepthWriteTransparentMeshes}set backfaceForceDepthWriteTransparentMeshes(e){this._backfaceForceDepthWriteTransparentMeshes!==e&&(this._backfaceForceDepthWriteTransparentMeshes=e,this._depthRenderer&&(this._depthRenderer.forceDepthWriteTransparentMeshes=e))}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._buildPipeline())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._buildPipeline())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._buildPipeline())}getScene(){return this._scene}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}get isSupported(){const e=this._scene.getEngine().getCaps();return e.drawBuffersExtension&&e.texelFetch}constructor(e,t,i,s=!1,r=0){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._reflectivityThreshold=.04,this._ssrDownsample=0,this._blurDispersionStrength=.03,this._blurDownsample=0,this._enableSmoothReflections=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateIntersectionIterations=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._useFresnel=!1,this._enableAutomaticThicknessComputation=!1,this._backfaceDepthTextureDownsample=0,this._backfaceForceDepthWriteTransparentMeshes=!0,this._isEnabled=!0,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=r,this._forceGeometryBuffer=s,this.isSupported){if(t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&(e.enableReflectivity=!0,e.useSpecificClearForDepthTexture=!0)}else{const e=t.enablePrePassRenderer();e&&(e.useSpecificClearForDepthTexture=!0,e.markAsDirty())}this._buildPipeline()}}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposePostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}_getTextureSize(){var e,t;const i=this._scene.getEngine(),s=this._prePassRenderer;let r={width:i.getRenderWidth(),height:i.getRenderHeight()};if(s&&(null===(e=this._scene.activeCamera)||void 0===e?void 0:e._getFirstPostProcess())===this._ssrPostProcess){const e=s.getRenderTarget();e&&e.textures&&(r=e.textures[s.getIndex(4)].getSize())}else(null===(t=this._ssrPostProcess)||void 0===t?void 0:t.inputTexture)&&(r.width=this._ssrPostProcess.inputTexture.width,r.height=this._ssrPostProcess.inputTexture.height);return r}_updateEffectDefines(){var e;const t=[];(this._geometryBufferRenderer||this._prePassRenderer)&&t.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&t.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&t.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._environmentTexture&&(t.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&t.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC"),this._environmentTexture.gammaSpace&&t.push("#define SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE")),this._environmentTextureIsProbe&&t.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&t.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&t.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&t.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateIntersectionIterations&&t.push("#define SSR_ATTENUATE_INTERSECTION_NUMITERATIONS"),this._attenuateFacingCamera&&t.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&t.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&t.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this._useBlur()&&t.push("#define SSR_USE_BLUR"),this._debug&&t.push("#define SSRAYTRACE_DEBUG"),this._inputTextureColorIsInGammaSpace&&t.push("#define SSR_INPUT_IS_GAMMA_SPACE"),this._generateOutputInGammaSpace&&t.push("#define SSR_OUTPUT_IS_GAMMA_SPACE"),this._useFresnel&&t.push("#define SSR_BLEND_WITH_FRESNEL"),0===this._reflectivityThreshold&&t.push("#define SSR_DISABLE_REFLECTIVITY_TEST"),null===(e=this._ssrPostProcess)||void 0===e||e.updateEffect(t.join("\n"))}_buildPipeline(){var e;if(!this.isSupported)return;if(!this._isEnabled)return void(this._isDirty=!0);this._isDirty=!1;const t=this._scene.getEngine();if(this._disposeDepthRenderer(),this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._enableAutomaticThicknessComputation){const t=null===(e=this._cameras)||void 0===e?void 0:e[0];t&&(this._depthRendererCamera=t,this._depthRenderer=new fp.g(this._scene,void 0,void 0,void 0,1,!0,"SSRBackDepth"),this._depthRenderer.clearColor.r=1e8,this._depthRenderer.reverseCulling=!0,this._depthRenderer.forceDepthWriteTransparentMeshes=this._backfaceForceDepthWriteTransparentMeshes,this._resizeDepthRenderer(),t.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this._createSSRPostProcess(),this.addEffect(new np.L(t,this.SSRRenderEffect,(()=>this._ssrPostProcess),!0)),this._useBlur()&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new np.L(t,this.SSRBlurRenderEffect,(()=>[this._blurPostProcessX,this._blurPostProcessY]),!0)),this.addEffect(new np.L(t,this.SSRCombineRenderEffect,(()=>this._blurCombinerPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;const e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),i=Math.floor(e.width/(this._backfaceDepthTextureDownsample+1)),s=Math.floor(e.height/(this._backfaceDepthTextureDownsample+1));t.width===i&&t.height===s||this._depthRenderer.getDepthMap().resize({width:i,height:s})}_disposeDepthRenderer(){var e;if(this._depthRenderer){if(this._depthRendererCamera){const t=null!==(e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap()))&&void 0!==e?e:-1;-1!==t&&this._depthRendererCamera.customRenderTargets.splice(t,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposePostProcesses(){var e,t,i,s;for(let r=0;r<this._cameras.length;r++){const n=this._cameras[r];null===(e=this._ssrPostProcess)||void 0===e||e.dispose(n),null===(t=this._blurPostProcessX)||void 0===t||t.dispose(n),null===(i=this._blurPostProcessY)||void 0===i||i.dispose(n),null===(s=this._blurCombinerPostProcess)||void 0===s||s.dispose(n)}this._ssrPostProcess=null,this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new Wr.D("ssr","screenSpaceReflection2",["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor","reflectivityThreshold"],["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"],1,null,this._textureType,this._scene.getEngine(),!1,"",this._textureType),this._updateEffectDefines(),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!t)return;if(t){const i=t.getTextureIndex(mp.m.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",t.getGBuffer().textures[1]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[i]),e.setTexture("depthSampler",t.getGBuffer().textures[0])}else if(i){const t=i.getIndex(5),s=i.getIndex(3),r=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[r]),e.setTexture("depthSampler",i.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[s])}this._enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this._backfaceDepthTextureDownsample+1));const s=this._scene.activeCamera;if(!s)return;const r=s.getViewMatrix(!0),n=s.getProjectionMatrix(!0);n.invertToRef(m.jp.Matrix[0]),r.invertToRef(m.jp.Matrix[1]),e.setMatrix("projection",n),e.setMatrix("view",r),e.setMatrix("invView",m.jp.Matrix[1]),e.setMatrix("invProjectionMatrix",m.jp.Matrix[0]),e.setFloat("thickness",this.thickness),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("maxSteps",this.maxSteps),e.setFloat("roughnessFactor",this.roughnessFactor),e.setFloat("nearPlaneZ",s.minZ),e.setFloat("maxDistance",this.maxDistance),e.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip),e.setFloat("reflectivityThreshold",this._reflectivityThreshold);const o=this._getTextureSize();m.y3.ScalingToRef(o.width,o.height,1,m.jp.Matrix[2]),n.multiplyToRef(this._scene.getEngine().isWebGPU?vp:bp,m.jp.Matrix[3]),m.jp.Matrix[3].multiplyToRef(m.jp.Matrix[2],m.jp.Matrix[4]),e.setMatrix("projectionPixel",m.jp.Matrix[4]),this._environmentTexture&&(e.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(e.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),e.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new gp.g)}_createBlurAndCombinerPostProcesses(){const e=this._scene.getEngine();this._blurPostProcessX=new Wr.D("SSRblurX","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._ssrDownsample+1):1,null,2,e,!1,"",this._textureType),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add((e=>{var t,i;const s=null!==(i=null===(t=this._blurPostProcessX)||void 0===t?void 0:t.inputTexture.width)&&void 0!==i?i:this._scene.getEngine().getRenderWidth();e.setFloat2("texelOffsetScale",this._blurDispersionStrength/s,0)})),this._blurPostProcessY=new Wr.D("SSRblurY","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._blurDownsample+1):1,null,2,e,!1,"",this._textureType),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add((e=>{var t,i;const s=null!==(i=null===(t=this._blurPostProcessY)||void 0===t?void 0:t.inputTexture.height)&&void 0!==i?i:this._scene.getEngine().getRenderHeight();e.setFloat2("texelOffsetScale",0,this._blurDispersionStrength/s)}));const t=["strength","reflectionSpecularFalloffExponent","reflectivityThreshold"],i=["textureSampler","mainSampler","reflectivitySampler"];let s="";this._debug&&(s+="#define SSRAYTRACE_DEBUG\n"),this._inputTextureColorIsInGammaSpace&&(s+="#define SSR_INPUT_IS_GAMMA_SPACE\n"),this._generateOutputInGammaSpace&&(s+="#define SSR_OUTPUT_IS_GAMMA_SPACE\n"),this.useFresnel&&(s+="#define SSR_BLEND_WITH_FRESNEL\n",t.push("projection","invProjectionMatrix"),i.push("depthSampler","normalSampler")),0===this._reflectivityThreshold&&(s+="#define SSR_DISABLE_REFLECTIVITY_TEST"),this._blurCombinerPostProcess=new Wr.D("SSRblurCombiner","screenSpaceReflection2BlurCombiner",t,i,this._useBlur()?1/(this._blurDownsample+1):1,null,1,e,!1,s,this._textureType),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add((e=>{var t;const i=this._geometryBufferRenderer,s=this._prePassRenderer;if(s||i){if(s&&(null===(t=this._scene.activeCamera)||void 0===t?void 0:t._getFirstPostProcess())===this._ssrPostProcess){const t=s.getRenderTarget();t&&t.textures&&e.setTexture("mainSampler",t.textures[s.getIndex(4)])}else e.setTextureFromPostProcess("mainSampler",this._ssrPostProcess);if(i){const t=i.getTextureIndex(mp.m.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("reflectivitySampler",i.getGBuffer().textures[t]),this.useFresnel&&(e.setTexture("normalSampler",i.getGBuffer().textures[1]),e.setTexture("depthSampler",i.getGBuffer().textures[0]))}else if(s){const t=s.getIndex(3);if(e.setTexture("reflectivitySampler",s.getRenderTarget().textures[t]),this.useFresnel){const t=s.getIndex(5),i=s.getIndex(6);e.setTexture("normalSampler",s.getRenderTarget().textures[i]),e.setTexture("depthSampler",s.getRenderTarget().textures[t])}}if(e.setFloat("strength",this.strength),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("reflectivityThreshold",this._reflectivityThreshold),this.useFresnel){const t=this._scene.activeCamera;if(t){const i=t.getProjectionMatrix();i.invertToRef(m.jp.Matrix[0]),e.setMatrix("projection",i),e.setMatrix("invProjectionMatrix",m.jp.Matrix[0])}}}}))}serialize(){const e=j.p4.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,i){return j.p4.Parse((()=>new yp(e._name,t,e._ratio)),e,t,i)}}(0,H.gn)([(0,j.qC)()],yp.prototype,"samples",null),(0,H.gn)([(0,j.qC)()],yp.prototype,"maxDistance",void 0),(0,H.gn)([(0,j.qC)()],yp.prototype,"step",void 0),(0,H.gn)([(0,j.qC)()],yp.prototype,"thickness",void 0),(0,H.gn)([(0,j.qC)()],yp.prototype,"strength",void 0),(0,H.gn)([(0,j.qC)()],yp.prototype,"reflectionSpecularFalloffExponent",void 0),(0,H.gn)([(0,j.qC)()],yp.prototype,"maxSteps",void 0),(0,H.gn)([(0,j.qC)()],yp.prototype,"roughnessFactor",void 0),(0,H.gn)([(0,j.qC)()],yp.prototype,"selfCollisionNumSkip",void 0),(0,H.gn)([(0,j.qC)()],yp.prototype,"_reflectivityThreshold",void 0),(0,H.gn)([(0,j.qC)("_ssrDownsample")],yp.prototype,"_ssrDownsample",void 0),(0,H.gn)([(0,j.qC)()],yp.prototype,"ssrDownsample",null),(0,H.gn)([(0,j.qC)("blurDispersionStrength")],yp.prototype,"_blurDispersionStrength",void 0),(0,H.gn)([(0,j.qC)("blurDownsample")],yp.prototype,"_blurDownsample",void 0),(0,H.gn)([(0,j.qC)("enableSmoothReflections")],yp.prototype,"_enableSmoothReflections",void 0),(0,H.gn)([(0,j.qC)("environmentTexture")],yp.prototype,"_environmentTexture",void 0),(0,H.gn)([(0,j.qC)("environmentTextureIsProbe")],yp.prototype,"_environmentTextureIsProbe",void 0),(0,H.gn)([(0,j.qC)("attenuateScreenBorders")],yp.prototype,"_attenuateScreenBorders",void 0),(0,H.gn)([(0,j.qC)("attenuateIntersectionDistance")],yp.prototype,"_attenuateIntersectionDistance",void 0),(0,H.gn)([(0,j.qC)("attenuateIntersectionIterations")],yp.prototype,"_attenuateIntersectionIterations",void 0),(0,H.gn)([(0,j.qC)("attenuateFacingCamera")],yp.prototype,"_attenuateFacingCamera",void 0),(0,H.gn)([(0,j.qC)("attenuateBackfaceReflection")],yp.prototype,"_attenuateBackfaceReflection",void 0),(0,H.gn)([(0,j.qC)("clipToFrustum")],yp.prototype,"_clipToFrustum",void 0),(0,H.gn)([(0,j.qC)("useFresnel")],yp.prototype,"_useFresnel",void 0),(0,H.gn)([(0,j.qC)("enableAutomaticThicknessComputation")],yp.prototype,"_enableAutomaticThicknessComputation",void 0),(0,H.gn)([(0,j.qC)("backfaceDepthTextureDownsample")],yp.prototype,"_backfaceDepthTextureDownsample",void 0),(0,H.gn)([(0,j.qC)("backfaceForceDepthWriteTransparentMeshes")],yp.prototype,"_backfaceForceDepthWriteTransparentMeshes",void 0),(0,H.gn)([(0,j.qC)("isEnabled")],yp.prototype,"_isEnabled",void 0),(0,H.gn)([(0,j.qC)("inputTextureColorIsInGammaSpace")],yp.prototype,"_inputTextureColorIsInGammaSpace",void 0),(0,H.gn)([(0,j.qC)("generateOutputInGammaSpace")],yp.prototype,"_generateOutputInGammaSpace",void 0),(0,H.gn)([(0,j.qC)("debug")],yp.prototype,"_debug",void 0),(0,c.H)("BABYLON.SSRRenderingPipeline",yp);var xp,Pp=i(64200);i(19679),function(e){e[e.Hable=0]="Hable",e[e.Reinhard=1]="Reinhard",e[e.HejiDawson=2]="HejiDawson",e[e.Photographic=3]="Photographic"}(xp||(xp={}));class Cp extends Wr.D{getClassName(){return"TonemapPostProcess"}constructor(e,t,i,s,r=2,n,o=0,a){super(e,"tonemap",["_ExposureAdjustment"],null,1,s,r,n,a,null,o),this._operator=t,this.exposureAdjustment=i;let h="#define ";this._operator===xp.Hable?h+="HABLE_TONEMAPPING":this._operator===xp.Reinhard?h+="REINHARD_TONEMAPPING":this._operator===xp.HejiDawson?h+="OPTIMIZED_HEJIDAWSON_TONEMAPPING":this._operator===xp.Photographic&&(h+="PHOTOGRAPHIC_TONEMAPPING"),this.updateEffect(h),this.onApply=e=>{e.setFloat("_ExposureAdjustment",this.exposureAdjustment)}}}i(97992),i(31975),i(90898),i(10917);class Tp extends Wr.D{get useDiffuseColor(){return p.Y.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){p.Y.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,s,r=100,n=X.x.BILINEAR_SAMPLINGMODE,o,a,h){var l,c;super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,n,o,a,"#define NUM_SAMPLES "+r),this._screenCoordinates=m.FM.Zero(),this.customMeshPosition=m.P.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=new Array,this.includedMeshes=new Array,this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,o=(h=null!==(c=null!==(l=null==i?void 0:i.getScene())&&void 0!==l?l:h)&&void 0!==c?c:this._scene).getEngine(),this._viewPort=new pt.l(0,0,1,1).toGlobal(o.getRenderWidth(),o.getRenderHeight()),this.mesh=null!=s?s:Tp.CreateDefaultMesh("VolumetricLightScatteringMesh",h),this._createPass(h,t.passRatio||t),this.onActivate=e=>{this.isSupported||this.dispose(e),this.onActivate=null},this.onApplyObservable.add((e=>{this._updateMeshScreenCoordinates(h),e.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),e.setFloat("exposure",this.exposure),e.setFloat("decay",this.decay),e.setFloat("weight",this.weight),e.setFloat("density",this.density),e.setVector2("meshPositionOnScreen",this._screenCoordinates)}))}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){var i;const s=e.getMesh();if(s===this.mesh&&s.material)return s.material.isReady(s);const r=null===(i=s._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===i?void 0:i[this._scene.getEngine().currentRenderPassId];if(r)return r.isReadyForSubMesh(s,e,t);const n=[],o=[me.o.PositionKind],a=e.getMaterial();a&&(a.needAlphaTesting()&&n.push("#define ALPHATEST"),s.isVerticesDataPresent(me.o.UVKind)&&(o.push(me.o.UVKind),n.push("#define UV1")),s.isVerticesDataPresent(me.o.UV2Kind)&&(o.push(me.o.UV2Kind),n.push("#define UV2"))),s.useBones&&s.computeBonesUsingShaders?(o.push(me.o.MatricesIndicesKind),o.push(me.o.MatricesWeightsKind),n.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),n.push("#define BonesPerMesh "+(s.skeleton?s.skeleton.bones.length+1:0))):n.push("#define NUM_BONE_INFLUENCERS 0"),t&&(n.push("#define INSTANCES"),Nn.G.PushAttributesForInstances(o),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES"));const h=e._getDrawWrapper(void 0,!0),l=h.defines,c=n.join("\n");return l!==c&&h.setEffect(s.getScene().getEngine().createEffect("volumetricLightScatteringPass",o,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],c,void 0,void 0,void 0,{maxSimultaneousMorphTargets:s.numBoneInfluencers}),c),h.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);-1!==t&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&-1===this.includedMeshes.indexOf(e)||this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)}_createPass(e,t){const i=e.getEngine();this._volumetricLightScatteringRTT=new Ur._("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=X.x.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=X.x.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const s=this.getCamera();s?s.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const r=e=>{var t;const i=e.getRenderingMesh(),s=e.getEffectiveMesh();if(this._meshExcluded(i))return;s._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const r=e.getMaterial();if(!r)return;const n=i.getScene(),o=n.getEngine();o.setState(r.backFaceCulling,void 0,void 0,void 0,r.cullBackFaces);const a=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(a.mustReturn)return;const h=o.getCaps().instancedArrays&&(null!==a.visibleInstances[e._id]||i.hasThinInstances);if(this._isReady(e,h)){const l=null===(t=s._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===t?void 0:t[o.currentRenderPassId];let c=e._getDrawWrapper();if(i!==this.mesh||c||(c=r._getDrawWrapper()),!c)return;const u=c.effect;if(o.enableEffect(c),h||i._bind(e,u,r.fillMode),i===this.mesh)r.bind(s.getWorldMatrix(),i);else if(l)l.bindForSubMesh(s.getWorldMatrix(),s,e);else{if(u.setMatrix("viewProjection",n.getTransformMatrix()),r&&r.needAlphaTesting()){const e=r.getAlphaTestTexture();u.setTexture("diffuseSampler",e),e&&u.setMatrix("diffuseMatrix",e.getTextureMatrix())}i.useBones&&i.computeBonesUsingShaders&&i.skeleton&&u.setMatrices("mBones",i.skeleton.getTransformMatrices(i))}h&&i.hasThinInstances&&u.setMatrix("world",s.getWorldMatrix()),i._processRendering(s,e,u,yi.F.TriangleFillMode,a,h,((e,t)=>{e||u.setMatrix("world",t)}))}};let n;const o=new g.HE(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add((()=>{n=e.clearColor,e.clearColor=o})),this._volumetricLightScatteringRTT.onAfterRenderObservable.add((()=>{e.clearColor=n})),this._volumetricLightScatteringRTT.customIsReadyFunction=(e,t,s)=>{if((s||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const s=e.subMeshes[t],r=s.getMaterial(),n=s.getRenderingMesh();if(!r)continue;const o=n._getInstancesRenderList(s._id,!!s.getReplacementMesh()),a=i.getCaps().instancedArrays&&(null!==o.visibleInstances[s._id]||n.hasThinInstances);if(!this._isReady(s,a))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(t,i,s,n)=>{const o=e.getEngine();let a;if(n.length){for(o.setColorWrite(!1),a=0;a<n.length;a++)r(n.data[a]);o.setColorWrite(!0)}for(a=0;a<t.length;a++)r(t.data[a]);for(a=0;a<i.length;a++)r(i.data[a]);if(s.length){for(a=0;a<s.length;a++){const t=s.data[a],i=t.getBoundingInfo();i&&e.activeCamera&&(t._alphaIndex=t.getMesh().alphaIndex,t._distanceToCamera=i.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const t=s.data.slice(0,s.length);for(t.sort(((e,t)=>e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0)),o.setAlphaMode(2),a=0;a<t.length;a++)r(t[a]);o.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let i;i=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const s=m.P.Project(i,m.y3.Identity(),t,this._viewPort);this._screenCoordinates.x=s.x/this._viewPort.width,this._screenCoordinates.y=s.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const i=(0,Ls.pT)(e,{size:1},t);i.billboardMode=si.x.BILLBOARDMODE_ALL;const s=new Ot.K(e+"Material",t);return s.emissiveColor=new g.Wo(1,1,1),i.material=s,i}}(0,H.gn)([(0,j.hd)()],Tp.prototype,"customMeshPosition",void 0),(0,H.gn)([(0,j.qC)()],Tp.prototype,"useCustomMeshPosition",void 0),(0,H.gn)([(0,j.qC)()],Tp.prototype,"invert",void 0),(0,H.gn)([(0,j.RR)()],Tp.prototype,"mesh",void 0),(0,H.gn)([(0,j.qC)()],Tp.prototype,"excludedMeshes",void 0),(0,H.gn)([(0,j.qC)()],Tp.prototype,"includedMeshes",void 0),(0,H.gn)([(0,j.qC)()],Tp.prototype,"exposure",void 0),(0,H.gn)([(0,j.qC)()],Tp.prototype,"decay",void 0),(0,H.gn)([(0,j.qC)()],Tp.prototype,"weight",void 0),(0,H.gn)([(0,j.qC)()],Tp.prototype,"density",void 0),(0,c.H)("BABYLON.VolumetricLightScatteringPostProcess",Tp);var Sp=i(1600),Ep=i(73527),Rp=i(78091);i(27649);class Mp extends Wr.D{getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,i,s,r,n,o,a=0,h=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],i,s,r,n,o,void 0,a,void 0,null,h),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?this.onApply=e=>{e.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),e.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));const t=this._geometryBufferRenderer.getGBuffer().textures[1];e.setTexture("normalSampler",t)}:p.Y.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){const e=D.l.LastCreatedEngine;return!!e&&e.getCaps().drawBuffersExtension}static _Parse(e,t,i,s){return j.p4.Parse((()=>new Mp(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,s)}}(0,H.gn)([(0,j.qC)()],Mp.prototype,"ridge",void 0),(0,H.gn)([(0,j.qC)()],Mp.prototype,"valley",void 0),(0,c.H)("BABYLON.ScreenSpaceCurvaturePostProcess",Mp);var Ap=i(42091);i(97189),i(28678),Object.defineProperty(z.x.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(e){this._forceShowBoundingBoxes=e,e&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0}),z.x.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new Ip(this)),this._boundingBoxRenderer},Object.defineProperty(si.x.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(e){this._showBoundingBox=e,e&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});class Ip{constructor(e){this.name=k.l.NAME_BOUNDINGBOXRENDERER,this.frontColor=new g.Wo(1,1,1),this.backColor=new g.Wo(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new _.y$,this.onAfterBoxRenderingObservable=new _.y$,this.onResourcesReadyObservable=new _.y$,this.enabled=!0,this.renderList=new Ap.t(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=e,e._addComponent(this),this._uniformBufferFront=new Zo.M(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new Zo.M(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(k.l.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(k.l.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(k.l.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(k.l.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){const i=t.getBoundingInfo();null!=i&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){const t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new xi.j("colorShader",this.scene,"boundingBoxRenderer",{attributes:[me.o.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!1),this._colorShader.doNotSerialize=!0,this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new xi.j("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[me.o.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!0),this._colorShaderForOcclusionQuery.doNotSerialize=!0,this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};const e=this.scene.getEngine(),t=(0,ui.aR)({size:1});this._vertexBuffers[me.o.PositionKind]=new me.o(e,t.positions,me.o.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){const e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){const e=this._vertexBuffers[me.o.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}reset(){this.renderList.reset()}render(e){var t,i;if(0===this.renderList.length||!this.enabled)return;if(this._prepareResources(),!this._colorShader.isReady())return;const s=this.scene.getEngine();s.setDepthWrite(!1);const r=this.scene.getTransformMatrix();for(let n=0;n<this.renderList.length;n++){const o=this.renderList.data[n];if(o._tag!==e)continue;this._createWrappersForBoundingBox(o),this.onBeforeBoxRenderingObservable.notifyObservers(o);const a=o.minimum,h=o.maximum.subtract(a),l=a.add(h.scale(.5)),c=m.y3.Scaling(h.x,h.y,h.z).multiply(m.y3.Translation(l.x,l.y,l.z)).multiply(o.getWorldMatrix()),u=s.useReverseDepthBuffer;if(this.showBackLines){const e=null!==(t=o._drawWrapperBack)&&void 0!==t?t:this._colorShader._getDrawWrapper();this._colorShader._preBind(e),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),u?s.setDepthFunctionToLessOrEqual():s.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(e.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateColor4("color",this.backColor,1),this._uniformBufferBack.updateMatrix("world",c),this._uniformBufferBack.updateMatrix("viewProjection",r),this._uniformBufferBack.update(),s.drawElementsType(yi.F.LineListDrawMode,0,24)}const d=null!==(i=o._drawWrapperFront)&&void 0!==i?i:this._colorShader._getDrawWrapper();this._colorShader._preBind(d),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),u?s.setDepthFunctionToGreater():s.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateColor4("color",this.frontColor,1),this._uniformBufferFront.updateMatrix("world",c),this._uniformBufferFront.updateMatrix("viewProjection",r),this._uniformBufferFront.update(),s.drawElementsType(yi.F.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(o)}this._colorShader.unbind(),s.setDepthFunctionToLessOrEqual(),s.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){const t=this.scene.getEngine();e._drawWrapperFront=new Di.q(t),e._drawWrapperBack=new Di.q(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){const t=this.scene.getEngine();void 0===this._renderPassIdForOcclusionQuery&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));const i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();const s=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,s)||!e.hasBoundingInfo)return void(t.currentRenderPassId=i);this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));const r=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);const n=e.getBoundingInfo().boundingBox,o=n.minimum,a=n.maximum.subtract(o),h=o.add(a.scale(.5)),l=m.y3.Scaling(a.x,a.y,a.z).multiply(m.y3.Translation(h.x,h.y,h.z)).multiply(n.getWorldMatrix()),c=s._drawWrapper;this._colorShaderForOcclusionQuery._preBind(c),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,c.effect),r?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(c.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",l),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(yi.F.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}dispose(){if(void 0!==this._renderPassIdForOcclusionQuery&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();const e=this._vertexBuffers[me.o.PositionKind];e&&(e.dispose(),this._vertexBuffers[me.o.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}}z.x.prototype.enableDepthRenderer=function(e,t=!1,i=!1,s=3,r=!1){if(!(e=e||this.activeCamera))throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[e.id]){const n=!!this.getEngine().getCaps().textureFloatRender;let o=0;o=!this.getEngine().getCaps().textureHalfFloatRender||i&&n?n?1:0:2,this._depthRenderer[e.id]=new fp.g(this,o,e,t,s,r)}return this._depthRenderer[e.id]},z.x.prototype.disableDepthRenderer=function(e){(e=e||this.activeCamera)&&this._depthRenderer&&this._depthRenderer[e.id]&&this._depthRenderer[e.id].dispose()};class Op{constructor(e){this.name=k.l.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(k.l.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(k.l.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(const e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}fp.g._SceneComponentInitialization=e=>{let t=e._getComponent(k.l.NAME_DEPTHRENDERER);t||(t=new Op(e),e._addComponent(t))};var wp=i(33836);Object.defineProperty(z.x.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){let e=this._getComponent(k.l.NAME_DEPTHPEELINGRENDERER);e||(e=new Dp(this),this._addComponent(e))}return this._depthPeelingRenderer},set:function(e){this._depthPeelingRenderer=e},enumerable:!0,configurable:!0}),Object.defineProperty(z.x.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(e){var t;this._useOrderIndependentTransparency!==e&&(this._useOrderIndependentTransparency=e,this.markAllMaterialsAsDirty(63),null===(t=this.prePassRenderer)||void 0===t||t.markAsDirty())},enumerable:!0,configurable:!0});class Dp{constructor(e){this.name=k.l.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new wp.P(e)}register(){}rebuild(){}dispose(){var e;null===(e=this.scene.depthPeelingRenderer)||void 0===e||e.dispose(),this.scene.depthPeelingRenderer=null}}i(65537),i(42400),si.x.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this},si.x.prototype.enableEdgesRendering=function(e=.95,t=!1,i){return this.disableEdgesRendering(),this._edgesRenderer=new Np(this,e,t,!0,i),this},Object.defineProperty(si.x.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0}),ql._.prototype.enableEdgesRendering=function(e=.95,t=!1){return this.disableEdgesRendering(),this._edgesRenderer=new Fp(this,e,t),this},ql.E.prototype.enableEdgesRendering=function(e=.95,t=!1){return ql._.prototype.enableEdgesRendering.apply(this,arguments),this};class Bp{constructor(){this.edges=new Array,this.edgesConnectedCount=0}}class Np{get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e){if(!e._edgeRenderLineShader){const t=new xi.j("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"]},!1);t.disableDepthWrite=!0,t.backFaceCulling=!1,t.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=t}return e._edgeRenderLineShader}constructor(e,t=.95,i=!1,s=!0,r){var n;this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new Ap.t(32),this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=null!=r?r:null,this._epsilon=t,this._source.getScene().getEngine().isWebGPU&&(this._drawWrapper=new Di.q(e.getEngine())),this._prepareRessources(),s&&(null===(n=null==r?void 0:r.useAlternateEdgeFinder)||void 0===n||n?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add((()=>{this._rebuild()})),this._meshDisposeObserver=this._source.onDisposeObservable.add((()=>{this.dispose()}))}_prepareRessources(){this._lineShader||(this._lineShader=Np._GetShader(this._source.getScene()))}_rebuild(){let e=this._buffers[me.o.PositionKind];e&&e._rebuild(),e=this._buffers[me.o.NormalKind],e&&e._rebuild();const t=this._source.getScene().getEngine();this._ib=t.createIndexBuffer(this._linesIndices)}dispose(){var e;this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let t=this._buffers[me.o.PositionKind];t&&(t.dispose(),this._buffers[me.o.PositionKind]=null),t=this._buffers[me.o.NormalKind],t&&(t.dispose(),this._buffers[me.o.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose(),null===(e=this._drawWrapper)||void 0===e||e.dispose()}_processEdgeForAdjacencies(e,t,i,s,r){return e===i&&t===s||e===s&&t===i?0:e===s&&t===r||e===r&&t===s?1:e===r&&t===i||e===i&&t===r?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,s,r){const n=1e-10;return e.equalsWithEpsilon(i,n)&&t.equalsWithEpsilon(s,n)||e.equalsWithEpsilon(s,n)&&t.equalsWithEpsilon(i,n)?0:e.equalsWithEpsilon(s,n)&&t.equalsWithEpsilon(r,n)||e.equalsWithEpsilon(r,n)&&t.equalsWithEpsilon(s,n)?1:e.equalsWithEpsilon(r,n)&&t.equalsWithEpsilon(i,n)||e.equalsWithEpsilon(i,n)&&t.equalsWithEpsilon(r,n)?2:-1}_checkEdge(e,t,i,s,r){let n;n=void 0===t||m.P.Dot(i[e],i[t])<this._epsilon,n&&this.createLine(s,r,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,s){const r=(e,t,i)=>{i>=0&&t.push(i);for(let i=0;i<e.length;++i)t.push(e[i][0])};let n=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?n=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(n=2);for(let t=0;t<3;++t)t===n?e[t].sort(((e,t)=>e[1]<t[1]?-1:e[1]>t[1]?1:0)):e[t].sort(((e,t)=>e[1]>t[1]?-1:e[1]<t[1]?1:0));const o=[],a=[];r(e[n],o,-1);const h=o.length;for(let o=n+2;o>=n+1;--o)r(e[o%3],a,o!==n+2?s[i[t+(o+1)%3]]:-1);const l=a.length;i.push(s[i[t+n]],o[0],a[0]),i.push(s[i[t+(n+1)%3]],a[l-1],o[h-1]);const c=h<=l,u=c?h:l,d=c?l:h,p=c?h-1:l-1,_=c?0:1;let g=h+l-2,m=0,f=0;const b=c?o:a,v=c?a:o;let y=0;for(;g-- >0;){let e;_?i.push(b[m],v[f]):i.push(v[f],b[m]),y+=u,y>=d&&m<p?(e=b[++m],y-=d):e=v[++f],i.push(e)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){var e,t,i,s,r,n,o,a,h,l;const c=this._source.getVerticesData(me.o.PositionKind);let u=this._source.getIndices();if(!u||!c)return;Array.isArray(u)||(u=Array.from(u));const d=null===(t=null===(e=this._options)||void 0===e?void 0:e.useFastVertexMerger)||void 0===t||t,p=d?Math.round(-Math.log(null!==(s=null===(i=this._options)||void 0===i?void 0:i.epsilonVertexMerge)&&void 0!==s?s:1e-6)/Math.log(10)):null!==(n=null===(r=this._options)||void 0===r?void 0:r.epsilonVertexMerge)&&void 0!==n?n:1e-6,_=[],g=[];if(d){const e={};for(let t=0;t<c.length;t+=3){const i=c[t+0],s=c[t+1],r=c[t+2],n=i.toFixed(p)+"|"+s.toFixed(p)+"|"+r.toFixed(p);if(void 0!==e[n])_.push(e[n]);else{const i=t/3;e[n]=i,_.push(i),g.push(i)}}}else for(let e=0;e<c.length;e+=3){const t=c[e+0],i=c[e+1],s=c[e+2];let r=!1;for(let n=0;n<e&&!r;n+=3){const e=c[n+0],o=c[n+1],a=c[n+2];if(Math.abs(t-e)<p&&Math.abs(i-o)<p&&Math.abs(s-a)<p){_.push(n/3),r=!0;break}}r||(_.push(e/3),g.push(e/3))}if(null===(o=this._options)||void 0===o?void 0:o.applyTessellation){const e=null!==(h=null===(a=this._options)||void 0===a?void 0:a.epsilonVertexAligned)&&void 0!==h?h:1e-6,t=[];for(let i=0;i<u.length;i+=3){let s;for(let r=0;r<3;++r){const n=_[u[i+r]],o=_[u[i+(r+1)%3]],a=_[u[i+(r+2)%3]];if(n===o)continue;const h=c[3*n+0],l=c[3*n+1],d=c[3*n+2],p=c[3*o+0],m=c[3*o+1],f=c[3*o+2],b=Math.sqrt((p-h)*(p-h)+(m-l)*(m-l)+(f-d)*(f-d));for(let u=0;u<g.length-1;u++){const _=g[u];if(_===n||_===o||_===a)continue;const v=c[3*_+0],y=c[3*_+1],x=c[3*_+2],P=Math.sqrt((v-h)*(v-h)+(y-l)*(y-l)+(x-d)*(x-d)),C=Math.sqrt((v-p)*(v-p)+(y-m)*(y-m)+(x-f)*(x-f));Math.abs(P+C-b)<e&&(s||(s={index:i,edgesPoints:[[],[],[]]},t.push(s)),s.edgesPoints[r].push([_,P]))}}}for(let e=0;e<t.length;++e){const i=t[e];this._tessellateTriangle(i.edgesPoints,i.index,u,_)}t.length=0}const f={};for(let e=0;e<u.length;e+=3){let t;for(let i=0;i<3;++i){let s=_[u[e+i]],r=_[u[e+(i+1)%3]];const n=_[u[e+(i+2)%3]];if(s===r||(s===n||r===n)&&(null===(l=this._options)||void 0===l?void 0:l.removeDegeneratedTriangles))continue;if(m.jp.Vector3[0].copyFromFloats(c[3*s+0],c[3*s+1],c[3*s+2]),m.jp.Vector3[1].copyFromFloats(c[3*r+0],c[3*r+1],c[3*r+2]),m.jp.Vector3[2].copyFromFloats(c[3*n+0],c[3*n+1],c[3*n+2]),t||(m.jp.Vector3[1].subtractToRef(m.jp.Vector3[0],m.jp.Vector3[3]),m.jp.Vector3[2].subtractToRef(m.jp.Vector3[1],m.jp.Vector3[4]),t=m.P.Cross(m.jp.Vector3[3],m.jp.Vector3[4]),t.normalize()),s>r){const e=s;s=r,r=e}const o=s+"_"+r,a=f[o];a?a.done||(m.P.Dot(t,a.normal)<this._epsilon&&this.createLine(m.jp.Vector3[0],m.jp.Vector3[1],this._linesPositions.length/3),a.done=!0):f[o]={normal:t,done:!1,index:e,i}}}for(const e in f){const t=f[e];if(!t.done){const e=_[u[t.index+t.i]],i=_[u[t.index+(t.i+1)%3]];m.jp.Vector3[0].copyFromFloats(c[3*e+0],c[3*e+1],c[3*e+2]),m.jp.Vector3[1].copyFromFloats(c[3*i+0],c[3*i+1],c[3*i+2]),this.createLine(m.jp.Vector3[0],m.jp.Vector3[1],this._linesPositions.length/3)}}const b=this._source.getScene().getEngine();this._buffers[me.o.PositionKind]=new me.o(b,this._linesPositions,me.o.PositionKind,!1),this._buffers[me.o.NormalKind]=new me.o(b,this._linesNormals,me.o.NormalKind,!1,!1,4),this._buffersForInstances[me.o.PositionKind]=this._buffers[me.o.PositionKind],this._buffersForInstances[me.o.NormalKind]=this._buffers[me.o.NormalKind],this._ib=b.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){const e=this._source.getVerticesData(me.o.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=new Array,s=new Array;let r,n;for(r=0;r<t.length;r+=3){n=new Bp;const o=t[r],a=t[r+1],h=t[r+2];n.p0=new m.P(e[3*o],e[3*o+1],e[3*o+2]),n.p1=new m.P(e[3*a],e[3*a+1],e[3*a+2]),n.p2=new m.P(e[3*h],e[3*h+1],e[3*h+2]);const l=m.P.Cross(n.p1.subtract(n.p0),n.p2.subtract(n.p1));l.normalize(),s.push(l),i.push(n)}for(r=0;r<i.length;r++){n=i[r];for(let e=r+1;e<i.length;e++){const s=i[e];if(3===n.edgesConnectedCount)break;if(3===s.edgesConnectedCount)continue;const o=t[3*e],a=t[3*e+1],h=t[3*e+2];for(let i=0;i<3;i++){let l=0;if(void 0===n.edges[i]){switch(i){case 0:l=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(n.p0,n.p1,s.p0,s.p1,s.p2):this._processEdgeForAdjacencies(t[3*r],t[3*r+1],o,a,h);break;case 1:l=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(n.p1,n.p2,s.p0,s.p1,s.p2):this._processEdgeForAdjacencies(t[3*r+1],t[3*r+2],o,a,h);break;case 2:l=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(n.p2,n.p0,s.p0,s.p1,s.p2):this._processEdgeForAdjacencies(t[3*r+2],t[3*r],o,a,h)}if(-1!==l&&(n.edges[i]=e,s.edges[l]=r,n.edgesConnectedCount++,s.edgesConnectedCount++,3===n.edgesConnectedCount))break}}}}for(r=0;r<i.length;r++){const e=i[r];this._checkEdge(r,e.edges[0],s,e.p0,e.p1),this._checkEdge(r,e.edges[1],s,e.p1,e.p2),this._checkEdge(r,e.edges[2],s,e.p2,e.p0)}const o=this._source.getScene().getEngine();this._buffers[me.o.PositionKind]=new me.o(o,this._linesPositions,me.o.PositionKind,!1),this._buffers[me.o.NormalKind]=new me.o(o,this._linesNormals,me.o.NormalKind,!1,!1,4),this._buffersForInstances[me.o.PositionKind]=this._buffers[me.o.PositionKind],this._buffersForInstances[me.o.NormalKind]=this._buffers[me.o.NormalKind],this._ib=o.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){const e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera)return void this._lineShader._setDrawWrapper(t);const i=this._source.hasInstances&&this.customInstances.length>0,s=i||this._source.hasThinInstances;let r=0;if(s)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){const e=this._source._instanceDataStorage;if(r=this.customInstances.length,!e.instancesData)return void(this._source.getScene()._activeMeshesFrozen||this.customInstances.reset());if(!e.isFrozen){let t=0;for(let i=0;i<r;++i)this.customInstances.data[i].copyToArray(e.instancesData,t),t+=16;e.instancesBuffer.updateDirectly(e.instancesData,0,r)}}else r=this._source.thinInstanceCount;const n=e.getEngine();this._lineShader._preBind(),1!==this._source.edgesColor.a?n.setAlphaMode(2):n.setAlphaMode(0),n.bindBuffers(s?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===Ue.V.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",n.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix()),n.drawElementsType(yi.F.TriangleFillMode,0,this._indicesCount,r),this._lineShader.unbind(),s&&n.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)}}class Fp extends Np{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){const e=this._source.getVerticesData(me.o.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=m.jp.Vector3[0],s=m.jp.Vector3[1],r=t.length-1;for(let n=0,o=0;n<r;n+=2,o+=4)m.P.FromArrayToRef(e,3*t[n],i),m.P.FromArrayToRef(e,3*t[n+1],s),this.createLine(i,s,o);const n=this._source.getScene().getEngine();this._buffers[me.o.PositionKind]=new me.o(n,this._linesPositions,me.o.PositionKind,!1),this._buffers[me.o.NormalKind]=new me.o(n,this._linesNormals,me.o.NormalKind,!1,!1,4),this._ib=n.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}}var Lp=i(18932);Object.defineProperty(z.x.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(e){e&&e.isSupported&&(this._prePassRenderer=e)},enumerable:!0,configurable:!0}),z.x.prototype.enablePrePassRenderer=function(){return this._prePassRenderer||(this._prePassRenderer=new Lp.F(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,p.Y.Error("PrePassRenderer needs WebGL 2 support.\nMaybe you tried to use the following features that need the PrePassRenderer :\n + Subsurface Scattering"))),this._prePassRenderer},z.x.prototype.disablePrePassRenderer=function(){this._prePassRenderer&&(this._prePassRenderer.dispose(),this._prePassRenderer=null)};class Vp{constructor(e){this.name=k.l.NAME_PREPASSRENDERER,this.scene=e}register(){this.scene._beforeCameraDrawStage.registerStep(k.l.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(k.l.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(k.l.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(k.l.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(k.l.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(k.l.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(k.l.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(k.l.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)}_beforeRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))}_afterRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())}_beforeRenderingMeshStage(e,t,i,s){if(!s)return;const r=e.getScene();r.prePassRenderer&&r.prePassRenderer.bindAttachmentsForEffect(s,t)}_afterRenderingMeshStage(e){const t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()}rebuild(){this.scene.disablePrePassRenderer(),this.scene.enablePrePassRenderer()}dispose(){this.scene.disablePrePassRenderer()}}Lp.F._SceneComponentInitialization=e=>{let t=e._getComponent(k.l.NAME_PREPASSRENDERER);t||(t=new Vp(e),e._addComponent(t))};var kp=i(79601);s.p.AddParser(k.l.NAME_SUBSURFACE,((e,t)=>{if(void 0!==e.ssDiffusionProfileColors&&null!==e.ssDiffusionProfileColors&&(t.enableSubSurfaceForPrePass(),t.subSurfaceConfiguration))for(let i=0,s=e.ssDiffusionProfileColors.length;i<s;i++){const s=e.ssDiffusionProfileColors[i];t.subSurfaceConfiguration.addDiffusionProfile(new g.Wo(s.r,s.g,s.b))}})),Object.defineProperty(z.x.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(e){e&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=e)},enumerable:!0,configurable:!0}),z.x.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;const e=this.enablePrePassRenderer();return e?(this._subSurfaceConfiguration=new kp.u(this),e.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null},z.x.prototype.disableSubSurfaceForPrePass=function(){this._subSurfaceConfiguration&&(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};class zp{constructor(e){this.name=k.l.NAME_PREPASSRENDERER,this.scene=e}register(){}serialize(e){if(!this.scene.subSurfaceConfiguration)return;const t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(let i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}addFromContainer(){}removeFromContainer(){this.scene.prePassRenderer&&this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}}kp.u._SceneComponentInitialization=e=>{let t=e._getComponent(k.l.NAME_SUBSURFACE);t||(t=new zp(e),e._addComponent(t))},i(55419),i(81667),z.x.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new Gp(this)),this._outlineRenderer},Object.defineProperty(Mt.Kj.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(e){e&&this.getScene().getOutlineRenderer(),this._renderOutline=e},enumerable:!0,configurable:!0}),Object.defineProperty(Mt.Kj.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(e){e&&this.getScene().getOutlineRenderer(),this._renderOverlay=e},enumerable:!0,configurable:!0});class Gp{constructor(e){this.name=k.l.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let e=0;e<4;++e)this._passIdForDrawWrapper[e]=this._engine.createRenderPassId(`Outline Renderer (${e})`)}register(){this.scene._beforeRenderingMeshStage.registerStep(k.l.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(k.l.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,i=!1,s){s=null!=s?s:this._passIdForDrawWrapper[0];const r=this.scene,n=r.getEngine(),o=n.getCaps().instancedArrays&&(null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id]||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,o,s))return;const a=e.getMesh(),h=a._internalAbstractMeshDataInfo._actAsRegularMesh?a:null,l=e.getRenderingMesh(),c=h||l,u=e.getMaterial();if(!u||!r.activeCamera)return;const d=e._getDrawWrapper(s),p=Di.q.GetEffect(d);if(n.enableEffect(d),u.useLogarithmicDepth&&p.setFloat("logarithmicDepthConstant",2/(Math.log(r.activeCamera.maxZ+1)/Math.LN2)),p.setFloat("offset",i?0:l.outlineWidth),p.setColor4("color",i?l.overlayColor:l.outlineColor,i?l.overlayAlpha:u.alpha),p.setMatrix("viewProjection",r.getTransformMatrix()),p.setMatrix("world",c.getWorldMatrix()),l.useBones&&l.computeBonesUsingShaders&&l.skeleton&&p.setMatrices("mBones",l.skeleton.getTransformMatrices(l)),l.morphTargetManager&&l.morphTargetManager.isUsingTextureForTargets&&l.morphTargetManager._bind(p),Nn.G.BindMorphTargetParameters(l,p),o||l._bind(e,p,u.fillMode),u&&u.needAlphaTesting()){const e=u.getAlphaTestTexture();e&&(p.setTexture("diffuseSampler",e),p.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,Bn.an)(p,u,r),n.setZOffset(-this.zOffset),n.setZOffsetUnits(-this.zOffsetUnits),l._processRendering(c,e,p,u.fillMode,t,o,((e,t)=>{p.setMatrix("world",t)})),n.setZOffset(0),n.setZOffsetUnits(0)}isReady(e,t,i){i=null!=i?i:this._passIdForDrawWrapper[0];const s=[],r=[me.o.PositionKind,me.o.NormalKind],n=e.getMesh(),o=e.getMaterial();if(!o)return!1;const a=n.getScene();o.needAlphaTesting()&&(s.push("#define ALPHATEST"),n.isVerticesDataPresent(me.o.UVKind)&&(r.push(me.o.UVKind),s.push("#define UV1")),n.isVerticesDataPresent(me.o.UV2Kind)&&(r.push(me.o.UV2Kind),s.push("#define UV2"))),o.useLogarithmicDepth&&s.push("#define LOGARITHMICDEPTH"),(0,Bn.lK)(o,a,s),n.useBones&&n.computeBonesUsingShaders?(r.push(me.o.MatricesIndicesKind),r.push(me.o.MatricesWeightsKind),n.numBoneInfluencers>4&&(r.push(me.o.MatricesIndicesExtraKind),r.push(me.o.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),s.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0))):s.push("#define NUM_BONE_INFLUENCERS 0");const h=n.morphTargetManager;let l=0;h&&h.numInfluencers>0&&(l=h.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+l),h.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),Nn.G.PrepareAttributesForMorphTargetsInfluencers(r,n,l)),t&&(s.push("#define INSTANCES"),Nn.G.PushAttributesForInstances(r),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES"));const c=e._getDrawWrapper(i,!0),u=c.defines,d=s.join("\n");if(u!==d){const e=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];(0,Bn.qx)(e),c.setEffect(this.scene.getEngine().createEffect("outline",r,e,["diffuseSampler","morphTargets"],d,void 0,void 0,void 0,{maxSimultaneousMorphTargets:l}),d)}return c.effect.isReady()}_beforeRenderingMesh(e,t,i){if(this._savedDepthWrite=this._engine.getDepthWrite(),e.renderOutline){const s=t.getMaterial();s&&s.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(Gp._StencilReference),this._engine.setStencilFunctionReference(Gp._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,i,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),s&&s.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,i){if(e.renderOverlay){const e=this._engine.getAlphaMode(),s=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(t,i,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(e),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=s}e.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}}Gp._StencilReference=4;var Up,Wp=i(53906),Hp=i(17800),jp=i(61089),$p=i(52545);!function(e){e[e.DepthTexture=0]="DepthTexture",e[e.DepthBlurredTexture=1]="DepthBlurredTexture",e[e.ThicknessTexture=2]="ThicknessTexture",e[e.ThicknessBlurredTexture=3]="ThicknessBlurredTexture",e[e.DiffuseTexture=4]="DiffuseTexture",e[e.Normals=5]="Normals",e[e.DiffuseRendering=6]="DiffuseRendering"}(Up||(Up={}));class Yp{get needInitialization(){return this._needInitialization}get generateDiffuseTexture(){return this._generateDiffuseTexture}set generateDiffuseTexture(e){this._generateDiffuseTexture!==e&&(this._generateDiffuseTexture=e,this._needInitialization=!0)}get debugFeature(){return this._debugFeature}set debugFeature(e){this._debugFeature!==e&&(this._needInitialization=!0,this._debugFeature=e)}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._needInitialization=!0)}get environmentMap(){return this._environmentMap}set environmentMap(e){this._environmentMap!==e&&(this._needInitialization=!0,this._environmentMap=e)}get enableBlurDepth(){return this._enableBlurDepth}set enableBlurDepth(e){this._enableBlurDepth!==e&&(this._enableBlurDepth=e,this._needInitialization=!0)}get blurDepthSizeDivisor(){return this._blurDepthSizeDivisor}set blurDepthSizeDivisor(e){this._blurDepthSizeDivisor!==e&&(this._blurDepthSizeDivisor=e,this._needInitialization=!0)}get blurDepthFilterSize(){return this._blurDepthFilterSize}set blurDepthFilterSize(e){this._blurDepthFilterSize!==e&&(this._blurDepthFilterSize=e,this._setBlurParameters())}get blurDepthNumIterations(){return this._blurDepthNumIterations}set blurDepthNumIterations(e){this._blurDepthNumIterations!==e&&(this._blurDepthNumIterations=e,this._setBlurParameters())}get blurDepthMaxFilterSize(){return this._blurDepthMaxFilterSize}set blurDepthMaxFilterSize(e){this._blurDepthMaxFilterSize!==e&&(this._blurDepthMaxFilterSize=e,this._setBlurParameters())}get blurDepthDepthScale(){return this._blurDepthDepthScale}set blurDepthDepthScale(e){this._blurDepthDepthScale!==e&&(this._blurDepthDepthScale=e,this._setBlurParameters())}get enableBlurThickness(){return this._enableBlurThickness}set enableBlurThickness(e){this._enableBlurThickness!==e&&(this._enableBlurThickness=e,this._needInitialization=!0)}get blurThicknessSizeDivisor(){return this._blurThicknessSizeDivisor}set blurThicknessSizeDivisor(e){this._blurThicknessSizeDivisor!==e&&(this._blurThicknessSizeDivisor=e,this._needInitialization=!0)}get blurThicknessFilterSize(){return this._blurThicknessFilterSize}set blurThicknessFilterSize(e){this._blurThicknessFilterSize!==e&&(this._blurThicknessFilterSize=e,this._setBlurParameters())}get blurThicknessNumIterations(){return this._blurThicknessNumIterations}set blurThicknessNumIterations(e){this._blurThicknessNumIterations!==e&&(this._blurThicknessNumIterations=e,this._setBlurParameters())}get useFixedThickness(){return this._useFixedThickness}set useFixedThickness(e){this._useFixedThickness!==e&&(this._useFixedThickness=e,this._needInitialization=!0)}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&(this._useVelocity=e,this._needInitialization=!0,this._onUseVelocityChanged.notifyObservers(this))}get depthMapSize(){return this._depthMapSize}set depthMapSize(e){this._depthMapSize!==e&&(this._depthMapSize=e,this._needInitialization=!0)}get thicknessMapSize(){return this._thicknessMapSize}set thicknessMapSize(e){this._thicknessMapSize!==e&&(this._thicknessMapSize=e,this._needInitialization=!0)}get diffuseMapSize(){return this._diffuseMapSize}set diffuseMapSize(e){this._diffuseMapSize!==e&&(this._diffuseMapSize=e,this._needInitialization=!0)}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._needInitialization=!0)}get camera(){return this._camera}constructor(e,t){this._generateDiffuseTexture=!1,this.fluidColor=new g.Wo(.085,.6375,.765),this.density=2,this.refractionStrength=.1,this.fresnelClamp=1,this.specularPower=250,this.minimumThickness=0,this.dirLight=new m.P(-2,-1,1).normalize(),this._debugFeature=Up.DepthBlurredTexture,this._debug=!1,this._enableBlurDepth=!0,this._blurDepthSizeDivisor=1,this._blurDepthFilterSize=7,this._blurDepthNumIterations=3,this._blurDepthMaxFilterSize=100,this._blurDepthDepthScale=10,this._enableBlurThickness=!0,this._blurThicknessSizeDivisor=1,this._blurThicknessFilterSize=5,this._blurThicknessNumIterations=1,this._useFixedThickness=!1,this._onUseVelocityChanged=new _.y$,this._useVelocity=!1,this._depthMapSize=null,this._thicknessMapSize=null,this._diffuseMapSize=null,this._samples=1,this._scene=e,this._engine=e.getEngine(),this._camera=null!=t?t:e.activeCamera,this._needInitialization=!0,this._bgDepthTexture=null,this._invProjectionMatrix=new m.y3,this._depthClearColor=new g.HE(1e6,1e6,1e6,1),this._thicknessClearColor=new g.HE(0,0,0,1),this._depthRenderTarget=null,this._diffuseRenderTarget=null,this._thicknessRenderTarget=null,this._renderPostProcess=null}_initialize(){var e,t,i;this.dispose(),this._needInitialization=!1;const s=null!==(e=this._depthMapSize)&&void 0!==e?e:this._engine.getRenderWidth(),r=null!==this._depthMapSize?Math.round(this._depthMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();if(this._depthRenderTarget=new $p.a("Depth",this._scene,s,r,s,r,1,7,1,7,!1,this._camera,!0,this._samples),this._initializeRenderTarget(this._depthRenderTarget),this.generateDiffuseTexture){const e=null!==(t=this._diffuseMapSize)&&void 0!==t?t:this._engine.getRenderWidth(),i=null!==this._diffuseMapSize?Math.round(this._diffuseMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._diffuseRenderTarget=new $p.a("Diffuse",this._scene,e,i,0,0,0,5,0,5,!0,this._camera,!0,this._samples),this._initializeRenderTarget(this._diffuseRenderTarget)}const n=null!==(i=this._thicknessMapSize)&&void 0!==i?i:this._engine.getRenderWidth(),o=null!==this._thicknessMapSize?Math.round(this._thicknessMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._useFixedThickness||(this._thicknessRenderTarget=new $p.a("Thickness",this._scene,n,o,n,o,2,6,2,6,!0,this._camera,!1,this._samples),this._initializeRenderTarget(this._thicknessRenderTarget)),this._createLiquidRenderingPostProcess()}_setBlurParameters(e=null){null!==e&&e!==this._depthRenderTarget||this._setBlurDepthParameters(),null!==e&&e!==this._thicknessRenderTarget||this._setBlurThicknessParameters()}_setBlurDepthParameters(){this._depthRenderTarget&&(this._depthRenderTarget.blurFilterSize=this.blurDepthFilterSize,this._depthRenderTarget.blurMaxFilterSize=this.blurDepthMaxFilterSize,this._depthRenderTarget.blurNumIterations=this.blurDepthNumIterations,this._depthRenderTarget.blurDepthScale=this.blurDepthDepthScale)}_setBlurThicknessParameters(){this._thicknessRenderTarget&&(this._thicknessRenderTarget.blurFilterSize=this.blurThicknessFilterSize,this._thicknessRenderTarget.blurNumIterations=this.blurThicknessNumIterations)}_initializeRenderTarget(e){e!==this._diffuseRenderTarget&&(e.enableBlur=e===this._depthRenderTarget?this.enableBlurDepth:this.enableBlurThickness,e.blurSizeDivisor=e===this._depthRenderTarget?this.blurDepthSizeDivisor:this.blurThicknessSizeDivisor),this._setBlurParameters(e),e.initialize()}_createLiquidRenderingPostProcess(){var e;const t=this._scene.getEngine(),i=["viewMatrix","projectionMatrix","invProjectionMatrix","texelSize","dirLight","cameraFar","density","refractionStrength","fresnelClamp","specularPower"],s=["depthSampler"],r=[];if(this.dispose(!0),!this._camera)return;const n=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture,o=new m.FM(1/n.getSize().width,1/n.getSize().height);this._scene.useRightHandedSystem&&r.push("#define FLUIDRENDERING_RHS"),null!==this._environmentMap&&(null!==(e=this._environmentMap)&&void 0!==e?e:this._scene.environmentTexture)&&(s.push("reflectionSampler"),r.push("#define FLUIDRENDERING_ENVIRONMENT")),this._diffuseRenderTarget?(s.push("diffuseSampler"),r.push("#define FLUIDRENDERING_DIFFUSETEXTURE")):i.push("diffuseColor"),this._useVelocity&&(s.push("velocitySampler"),r.push("#define FLUIDRENDERING_VELOCITY")),this._useFixedThickness?(i.push("thickness"),s.push("bgDepthSampler"),r.push("#define FLUIDRENDERING_FIXED_THICKNESS")):(i.push("minimumThickness"),s.push("thicknessSampler")),this._debug&&(r.push("#define FLUIDRENDERING_DEBUG"),this._debugFeature===Up.Normals?r.push("#define FLUIDRENDERING_DEBUG_SHOWNORMAL"):this._debugFeature===Up.DiffuseRendering?r.push("#define FLUIDRENDERING_DEBUG_DIFFUSERENDERING"):(r.push("#define FLUIDRENDERING_DEBUG_TEXTURE"),s.push("debugSampler"),this._debugFeature!==Up.DepthTexture&&this._debugFeature!==Up.DepthBlurredTexture||r.push("#define FLUIDRENDERING_DEBUG_DEPTH"))),this._renderPostProcess=new Wr.D("FluidRendering","fluidRenderingRender",i,s,1,null,2,t,!1,null,0,void 0,void 0,!0,void 0),this._renderPostProcess.updateEffect(r.join("\n")),this._renderPostProcess.samples=this._samples,this._renderPostProcess.onApplyObservable.add((e=>{var i,s,r,n,a,h,l,c,u,d,p,_,g,m,f,b,v,y,x,P,C,T,S;if(this._invProjectionMatrix.copyFrom(this._scene.getProjectionMatrix()),this._invProjectionMatrix.invert(),t.isWebGPU&&e.setTextureSampler("textureSamplerSampler",this._renderPostProcess.inputTexture.texture),this._depthRenderTarget.enableBlur?(e.setTexture("depthSampler",this._depthRenderTarget.textureBlur),t.isWebGPU&&e.setTextureSampler("depthSamplerSampler",null!==(n=null===(r=this._depthRenderTarget.textureBlur)||void 0===r?void 0:r.getInternalTexture())&&void 0!==n?n:null)):(e.setTexture("depthSampler",this._depthRenderTarget.texture),t.isWebGPU&&e.setTextureSampler("depthSamplerSampler",null!==(s=null===(i=this._depthRenderTarget.texture)||void 0===i?void 0:i.getInternalTexture())&&void 0!==s?s:null)),this._diffuseRenderTarget?this._diffuseRenderTarget.enableBlur?(e.setTexture("diffuseSampler",this._diffuseRenderTarget.textureBlur),t.isWebGPU&&e.setTextureSampler("diffuseSamplerSampler",null!==(c=null===(l=this._diffuseRenderTarget.textureBlur)||void 0===l?void 0:l.getInternalTexture())&&void 0!==c?c:null)):(e.setTexture("diffuseSampler",this._diffuseRenderTarget.texture),t.isWebGPU&&e.setTextureSampler("diffuseSamplerSampler",null!==(h=null===(a=this._diffuseRenderTarget.texture)||void 0===a?void 0:a.getInternalTexture())&&void 0!==h?h:null)):e.setColor3("diffuseColor",this.fluidColor),this._useFixedThickness?(e.setFloat("thickness",this.minimumThickness),e._bindTexture("bgDepthSampler",this._bgDepthTexture),t.isWebGPU&&e.setTextureSampler("bgDepthSamplerSampler",null!==(u=this._bgDepthTexture)&&void 0!==u?u:null)):(this._thicknessRenderTarget.enableBlur?(e.setTexture("thicknessSampler",this._thicknessRenderTarget.textureBlur),t.isWebGPU&&e.setTextureSampler("thicknessSamplerSampler",null!==(g=null===(_=this._thicknessRenderTarget.textureBlur)||void 0===_?void 0:_.getInternalTexture())&&void 0!==g?g:null)):(e.setTexture("thicknessSampler",this._thicknessRenderTarget.texture),t.isWebGPU&&e.setTextureSampler("thicknessSamplerSampler",null!==(p=null===(d=this._thicknessRenderTarget.texture)||void 0===d?void 0:d.getInternalTexture())&&void 0!==p?p:null)),e.setFloat("minimumThickness",this.minimumThickness)),null!==this._environmentMap){const i=null!==(m=this._environmentMap)&&void 0!==m?m:this._scene.environmentTexture;i&&(e.setTexture("reflectionSampler",i),t.isWebGPU&&e.setTextureSampler("reflectionSamplerSampler",null!==(f=null==i?void 0:i.getInternalTexture())&&void 0!==f?f:null))}if(e.setMatrix("viewMatrix",this._scene.getViewMatrix()),e.setMatrix("invProjectionMatrix",this._invProjectionMatrix),e.setMatrix("projectionMatrix",this._scene.getProjectionMatrix()),e.setVector2("texelSize",o),e.setFloat("density",this.density),e.setFloat("refractionStrength",this.refractionStrength),e.setFloat("fresnelClamp",this.fresnelClamp),e.setFloat("specularPower",this.specularPower),e.setVector3("dirLight",this.dirLight),e.setFloat("cameraFar",this._camera.maxZ),this._debug){let i=null;switch(this._debugFeature){case Up.DepthTexture:i=this._depthRenderTarget.texture;break;case Up.DepthBlurredTexture:i=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture;break;case Up.ThicknessTexture:i=null!==(v=null===(b=this._thicknessRenderTarget)||void 0===b?void 0:b.texture)&&void 0!==v?v:null;break;case Up.ThicknessBlurredTexture:i=(null===(y=this._thicknessRenderTarget)||void 0===y?void 0:y.enableBlur)?null!==(P=null===(x=this._thicknessRenderTarget)||void 0===x?void 0:x.textureBlur)&&void 0!==P?P:null:null!==(T=null===(C=this._thicknessRenderTarget)||void 0===C?void 0:C.texture)&&void 0!==T?T:null;break;case Up.DiffuseTexture:this._diffuseRenderTarget&&(i=this._diffuseRenderTarget.texture)}this._debugFeature!==Up.Normals&&(e.setTexture("debugSampler",i),t.isWebGPU&&e.setTextureSampler("debugSamplerSampler",null!==(S=null==i?void 0:i.getInternalTexture())&&void 0!==S?S:null))}}))}_clearTargets(){var e,t,i;(null===(e=this._depthRenderTarget)||void 0===e?void 0:e.renderTarget)&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),this._engine.clear(this._depthClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),(null===(t=this._diffuseRenderTarget)||void 0===t?void 0:t.renderTarget)&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),(null===(i=this._thicknessRenderTarget)||void 0===i?void 0:i.renderTarget)&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget))}_render(e){var t,i,s,r,n,o;if(this._needInitialization||!e.isReady())return;const a=this._engine._currentRenderTarget;this._engine.setState(!1,void 0,void 0,void 0,!0),this._engine.setDepthBuffer(!0),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0),(null===(t=this._depthRenderTarget)||void 0===t?void 0:t.renderTarget)&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),e.renderDepthTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),(null===(i=this._diffuseRenderTarget)||void 0===i?void 0:i.renderTarget)&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),e.renderDiffuseTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),(null===(s=this._thicknessRenderTarget)||void 0===s?void 0:s.renderTarget)&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),e.renderThicknessTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget)),null===(r=this._depthRenderTarget)||void 0===r||r.applyBlurPostProcesses(),null===(n=this._diffuseRenderTarget)||void 0===n||n.applyBlurPostProcesses(),null===(o=this._thicknessRenderTarget)||void 0===o||o.applyBlurPostProcesses(),a&&this._engine.bindFramebuffer(a)}dispose(e=!1){var t,i,s,r;e||(null===(t=this._depthRenderTarget)||void 0===t||t.dispose(),this._depthRenderTarget=null,null===(i=this._diffuseRenderTarget)||void 0===i||i.dispose(),this._diffuseRenderTarget=null,null===(s=this._thicknessRenderTarget)||void 0===s||s.dispose(),this._thicknessRenderTarget=null),this._renderPostProcess&&this._camera&&this._camera.detachPostProcess(this._renderPostProcess),null===(r=this._renderPostProcess)||void 0===r||r.dispose(),this._renderPostProcess=null,this._needInitialization=!1}}var Xp=i(55785),Qp=i(94032);function qp(e){return!!e.particleSystem}i(78073),i(79388),i(97923),i(64775),i(19918),i(6445),i(34455),i(64293),i(86037),Object.defineProperty(z.x.prototype,"fluidRenderer",{get:function(){return this._fluidRenderer},set:function(e){this._fluidRenderer=e},enumerable:!0,configurable:!0}),z.x.prototype.enableFluidRenderer=function(){return this._fluidRenderer||(this._fluidRenderer=new Zp(this)),this._fluidRenderer},z.x.prototype.disableFluidRenderer=function(){var e;null===(e=this._fluidRenderer)||void 0===e||e.dispose(),this._fluidRenderer=null};class Kp{constructor(e){this.name=k.l.NAME_FLUIDRENDERER,this.scene=e}register(){this.scene._gatherActiveCameraRenderTargetsStage.registerStep(k.l.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER,this,this._gatherActiveCameraRenderTargets),this.scene._afterCameraDrawStage.registerStep(k.l.STEP_AFTERCAMERADRAW_FLUIDRENDERER,this,this._afterCameraDraw)}_gatherActiveCameraRenderTargets(e){var t;null===(t=this.scene.fluidRenderer)||void 0===t||t._prepareRendering()}_afterCameraDraw(e){var t;null===(t=this.scene.fluidRenderer)||void 0===t||t._render(e)}rebuild(){this.scene._fluidRenderer&&(this.scene.disableFluidRenderer(),this.scene.enableFluidRenderer())}dispose(){this.scene.disableFluidRenderer()}}class Zp{static _SceneComponentInitialization(e){let t=e._getComponent(k.l.NAME_FLUIDRENDERER);t||(t=new Kp(e),e._addComponent(t))}constructor(e){this._scene=e,this._engine=e.getEngine(),this._onEngineResizeObserver=null,this.renderObjects=[],this.targetRenderers=[],this._cameras=new Map,Zp._SceneComponentInitialization(this._scene),this._onEngineResizeObserver=this._engine.onResizeObservable.add((()=>{this._initialize()}))}recreate(){this._sortRenderingObjects(),this._initialize()}getRenderObjectFromParticleSystem(e){const t=this._getParticleSystemIndex(e);return-1!==t?this.renderObjects[t]:null}addParticleSystem(e,t,i,s){const r=new jp.F(this._scene,e);r.onParticleSizeChanged.add(this._setParticleSizeForRenderTargets.bind(this)),i||(i=new Yp(this._scene,s),this.targetRenderers.push(i)),i._onUseVelocityChanged.hasObservers()||i._onUseVelocityChanged.add(this._setUseVelocityForRenderObject.bind(this)),void 0!==t&&(i.generateDiffuseTexture=t);const n={object:r,targetRenderer:i};return this.renderObjects.push(n),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),n}addCustomParticles(e,t,i,s,r){const n=new Xp.H(this._scene,e,t);n.onParticleSizeChanged.add(this._setParticleSizeForRenderTargets.bind(this)),s||(s=new Yp(this._scene,r),this.targetRenderers.push(s)),s._onUseVelocityChanged.hasObservers()||s._onUseVelocityChanged.add(this._setUseVelocityForRenderObject.bind(this)),void 0!==i&&(s.generateDiffuseTexture=i);const o={object:n,targetRenderer:s};return this.renderObjects.push(o),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),o}removeRenderObject(e,t=!0){const i=this.renderObjects.indexOf(e);return-1!==i&&(e.object.dispose(),this.renderObjects.splice(i,1),t&&this._removeUnusedTargetRenderers()?this._initialize():this._setParticleSizeForRenderTargets(),!0)}_sortRenderingObjects(){this.renderObjects.sort(((e,t)=>e.object.priority<t.object.priority?-1:e.object.priority>t.object.priority?1:0))}_removeUnusedTargetRenderers(){const e={};for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].targetRenderer;e[this.targetRenderers.indexOf(i)]=!0}let t=!1;const i=[];for(let s=0;s<this.targetRenderers.length;++s)e[s]?i.push(this.targetRenderers[s]):(this.targetRenderers[s].dispose(),t=!0);return t&&(this.targetRenderers.length=0,this.targetRenderers.push(...i)),t}_getParticleSystemIndex(e){for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].object;if(qp(i)&&i.particleSystem===e)return t}return-1}_initialize(){for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();const e=new Map;for(let t=0;t<this.targetRenderers.length;++t){const i=this.targetRenderers[t];if(i._initialize(),i.camera&&i._renderPostProcess){let s=e.get(i.camera);s||(s=[[],{}],e.set(i.camera,s)),s[0].push(i),i.camera.attachPostProcess(i._renderPostProcess,t)}}let t=e.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value,s=e.get(t),r=t._getFirstPostProcess();if(!r)continue;const[n,o]=s;r.onSizeChangedObservable.add((()=>{var e;r.inputTexture.depthStencilTexture||r.inputTexture.createDepthStencilTexture(0,!0,this._engine.isStencilEnable,n[0].samples,this._engine.isStencilEnable?13:14,`PostProcessRTTDepthStencil-${r.name}`);for(const t of n){const i=null===(e=t._thicknessRenderTarget)||void 0===e?void 0:e.renderTarget,s=null==i?void 0:i.texture;if(i&&s){const e=s.width+"_"+s.height;let t=o[e];t||(t=o[e]=new Qp.B(this._engine,s.width,s.height)),t.depthRTWrapper._shareDepth(i)}}}))}t=this._cameras.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value,s=this._cameras.get(t)[1],r=e.get(t);if(r)for(const e in s)r[1][e]||s[e].dispose();else for(const e in s)s[e].dispose()}this._cameras.clear(),this._cameras=e,this._setParticleSizeForRenderTargets()}_setParticleSizeForRenderTargets(){const e=new Map;for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];let s=e.get(i.targetRenderer);void 0===s&&(s=0),e.set(i.targetRenderer,Math.max(s,i.object.particleSize))}e.forEach(((e,t)=>{t._depthRenderTarget&&(t._depthRenderTarget.particleSize=e)}))}_setUseVelocityForRenderObject(){for(const e of this.renderObjects)e.object.useVelocity=e.targetRenderer.useVelocity}_prepareRendering(){for(const e of this.targetRenderers)if(e.needInitialization)return void this._initialize()}_render(e){var t;for(let t=0;t<this.targetRenderers.length;++t)e&&this.targetRenderers[t].camera!==e||this.targetRenderers[t]._clearTargets();const i=this._cameras.keys();for(let s=i.next();!0!==s.done;s=i.next()){const i=s.value,r=this._cameras.get(i);if(e&&i!==e)continue;const n=i._getFirstPostProcess();if(!n)continue;const o=null===(t=n.inputTexture)||void 0===t?void 0:t.depthStencilTexture;if(o){const[e,t]=r;for(const t of e)t._bgDepthTexture=o;for(const e in t)t[e].copy(o)}}for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];e&&i.targetRenderer.camera!==e||i.targetRenderer._render(i.object)}}dispose(){this._engine.onResizeObservable.remove(this._onEngineResizeObserver),this._onEngineResizeObserver=null;for(let e=0;e<this.renderObjects.length;++e)this.renderObjects[e].object.dispose();for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();this._cameras.forEach((e=>{const t=e[1];for(const e in t)t[e].dispose()})),this.renderObjects=[],this.targetRenderers=[],this._cameras.clear()}}var Jp=i(26361),e_=i(25463),t_=(i(72959),i(55113)),i_=i(98870);class s_{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get children(){return this.sprites}get scene(){return this._scene}get capacity(){return this._spriteRenderer.capacity}get texture(){return this._spriteRenderer.texture}set texture(e){e.wrapU=X.x.CLAMP_ADDRESSMODE,e.wrapV=X.x.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=e,this._textureContent=null}get cellWidth(){return this._spriteRenderer.cellWidth}set cellWidth(e){this._spriteRenderer.cellWidth=e}get cellHeight(){return this._spriteRenderer.cellHeight}set cellHeight(e){this._spriteRenderer.cellHeight=e}get fogEnabled(){return this._spriteRenderer.fogEnabled}set fogEnabled(e){this._spriteRenderer.fogEnabled=e}get blendMode(){return this._spriteRenderer.blendMode}set blendMode(e){this._spriteRenderer.blendMode=e}get disableDepthWrite(){return this._disableDepthWrite}set disableDepthWrite(e){this._disableDepthWrite=e,this._spriteRenderer.disableDepthWrite=e}get pixelPerfect(){return this._spriteRenderer.pixelPerfect}set pixelPerfect(e){this._spriteRenderer.pixelPerfect=e,e&&3!==this.texture.samplingMode&&this.texture.updateSamplingMode(3)}constructor(e,t,i,s,r,n=.01,o=X.x.TRILINEAR_SAMPLINGMODE,a=!1,h=null){this.name=e,this.sprites=new Array,this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.metadata=null,this._wasDispatched=!1,this.onDisposeObservable=new _.y$,this._disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=(e,t)=>{e.cellRef||(e.cellIndex=0);const i=e.cellIndex;"number"==typeof i&&isFinite(i)&&Math.floor(i)===i&&(e.cellRef=this._spriteMap[e.cellIndex]),e._xOffset=this._cellData[e.cellRef].frame.x/t.width,e._yOffset=this._cellData[e.cellRef].frame.y/t.height,e._xSize=this._cellData[e.cellRef].frame.w,e._ySize=this._cellData[e.cellRef].frame.h},r||(r=D.l.LastCreatedScene),r._getComponent(k.l.NAME_SPRITE)||r._addComponent(new t_.O(r)),this._fromPacked=a,this._scene=r;const l=this._scene.getEngine();if(this._spriteRenderer=new i_.T(l,i,n,r),s.width&&s.height)this.cellWidth=s.width,this.cellHeight=s.height;else{if(void 0===s)return void(this._spriteRenderer=null);this.cellWidth=s,this.cellHeight=s}this._scene.spriteManagers&&this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),t&&(this.texture=new X.x(t,r,!0,!1,o)),this._fromPacked&&this._makePacked(t,h)}getClassName(){return"SpriteManager"}_makePacked(e,t){if(null!==t)try{let e;if(e="string"==typeof t?JSON.parse(t):t,e.frames.length){const t={};for(let i=0;i<e.frames.length;i++){const s=e.frames[i];if("string"!=typeof Object.keys(s)[0])throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");t[s[Object.keys(s)[0]]]=s}e.frames=t}const i=Reflect.ownKeys(e.frames);this._spriteMap=i,this._packedAndReady=!0,this._cellData=e.frames}catch(e){throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{const t=/\./g;let i;do{i=t.lastIndex,t.test(e)}while(t.lastIndex>0);const s=e.substring(0,i-1)+".json",r=()=>{p.Y.Error("JSON ERROR: Unable to load JSON file."),this._fromPacked=!1,this._packedAndReady=!1},n=e=>{try{const t=JSON.parse(e),i=Reflect.ownKeys(t.frames);this._spriteMap=i,this._packedAndReady=!0,this._cellData=t.frames}catch(e){throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}};w.w1.LoadFile(s,n,void 0,void 0,!1,r)}}_checkTextureAlpha(e,t,i,s,r){if(!e.useAlphaForPicking||!this.texture)return!0;const n=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(n.width*n.height*4),this.texture.readPixels(0,0,this._textureContent));const o=m.jp.Vector3[0];o.copyFrom(t.direction),o.normalize(),o.scaleInPlace(i),o.addInPlace(t.origin);const a=(o.x-s.x)/(r.x-s.x),h=1-(o.y-s.y)/(r.y-s.y),l=e._xOffset*n.width+a*e._xSize|0,c=e._yOffset*n.height+h*e._ySize|0;return this._textureContent[4*(l+c*n.width)+3]>.5}intersects(e,t,i,s){const r=Math.min(this.capacity,this.sprites.length),n=m.P.Zero(),o=m.P.Zero();let a=Number.MAX_VALUE,h=null;const l=m.jp.Vector3[0],c=m.jp.Vector3[1],u=t.getViewMatrix();let d=e,p=e;for(let t=0;t<r;t++){const r=this.sprites[t];if(r){if(i){if(!i(r))continue}else if(!r.isPickable)continue;if(m.P.TransformCoordinatesToRef(r.position,u,c),r.angle?(m.y3.TranslationToRef(-c.x,-c.y,0,m.jp.Matrix[1]),m.y3.TranslationToRef(c.x,c.y,0,m.jp.Matrix[2]),m.y3.RotationZToRef(-r.angle,m.jp.Matrix[3]),m.jp.Matrix[1].multiplyToRef(m.jp.Matrix[3],m.jp.Matrix[4]),m.jp.Matrix[4].multiplyToRef(m.jp.Matrix[2],m.jp.Matrix[0]),d=e.clone(),m.P.TransformCoordinatesToRef(e.origin,m.jp.Matrix[0],d.origin),m.P.TransformNormalToRef(e.direction,m.jp.Matrix[0],d.direction)):d=e,n.copyFromFloats(c.x-r.width/2,c.y-r.height/2,c.z),o.copyFromFloats(c.x+r.width/2,c.y+r.height/2,c.z),d.intersectsBoxMinMax(n,o)){const e=m.P.Distance(c,d.origin);if(a>e){if(!this._checkTextureAlpha(r,d,e,n,o))continue;if(p=d,a=e,h=r,s)break}}}}if(h){const e=new Yt.p;u.invertToRef(m.jp.Matrix[0]),e.hit=!0,e.pickedSprite=h,e.distance=a;const t=m.jp.Vector3[2];return t.copyFrom(p.direction),t.normalize(),t.scaleInPlace(a),p.origin.addToRef(t,l),e.pickedPoint=m.P.TransformCoordinates(l,m.jp.Matrix[0]),e}return null}multiIntersects(e,t,i){const s=Math.min(this.capacity,this.sprites.length),r=m.P.Zero(),n=m.P.Zero();let o;const a=[],h=m.jp.Vector3[0].copyFromFloats(0,0,0),l=m.jp.Vector3[1].copyFromFloats(0,0,0),c=t.getViewMatrix();for(let t=0;t<s;t++){const s=this.sprites[t];if(s){if(i){if(!i(s))continue}else if(!s.isPickable)continue;if(m.P.TransformCoordinatesToRef(s.position,c,l),r.copyFromFloats(l.x-s.width/2,l.y-s.height/2,l.z),n.copyFromFloats(l.x+s.width/2,l.y+s.height/2,l.z),e.intersectsBoxMinMax(r,n)){if(o=m.P.Distance(l,e.origin),!this._checkTextureAlpha(s,e,o,r,n))continue;const t=new Yt.p;a.push(t),c.invertToRef(m.jp.Matrix[0]),t.hit=!0,t.pickedSprite=s,t.distance=o;const i=m.jp.Vector3[2];i.copyFrom(e.direction),i.normalize(),i.scaleInPlace(o),e.origin.addToRef(i,h),t.pickedPoint=m.P.TransformCoordinates(h,m.jp.Matrix[0])}}}return a}render(){if(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))return;const e=this._scene.getEngine().getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}rebuild(){var e;null===(e=this._spriteRenderer)||void 0===e||e.rebuild()}dispose(){if(this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null,this._scene.spriteManagers){const e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1)}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null}serialize(e=!1){const t={};t.name=this.name,t.capacity=this.capacity,t.cellWidth=this.cellWidth,t.cellHeight=this.cellHeight,t.fogEnabled=this.fogEnabled,t.blendMode=this.blendMode,t.disableDepthWrite=this.disableDepthWrite,t.pixelPerfect=this.pixelPerfect,this.texture&&(e?t.texture=this.texture.serialize():(t.textureUrl=this.texture.name,t.invertY=this.texture._invertY)),t.sprites=[];for(const e of this.sprites)t.sprites.push(e.serialize());return t.metadata=this.metadata,t}static Parse(e,t,i){const s=new s_(e.name,"",e.capacity,{width:e.cellWidth,height:e.cellHeight},t);void 0!==e.fogEnabled&&(s.fogEnabled=e.fogEnabled),void 0!==e.blendMode&&(s.blendMode=e.blendMode),void 0!==e.disableDepthWrite&&(s.disableDepthWrite=e.disableDepthWrite),void 0!==e.pixelPerfect&&(s.pixelPerfect=e.pixelPerfect),void 0!==e.metadata&&(s.metadata=e.metadata),e.texture?s.texture=X.x.Parse(e.texture,t,i):e.textureName&&(s.texture=new X.x(i+e.textureUrl,t,!1,void 0===e.invertY||e.invertY));for(const t of e.sprites)e_.j.Parse(t,s);return s}static ParseFromFileAsync(e,t,i,s=""){return new Promise(((r,n)=>{const o=new zo.g;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const t=JSON.parse(o.responseText),n=s_.Parse(t,i||D.l.LastCreatedScene,s);e&&(n.name=e),r(n)}else n("Unable to load the sprite manager")})),o.open("GET",t),o.send()}))}static ParseFromSnippetAsync(e,t,i=""){return"_BLANK"===e?Promise.resolve(new s_("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,t)):new Promise(((s,r)=>{const n=new zo.g;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){const r=JSON.parse(JSON.parse(n.responseText).jsonPayload),o=JSON.parse(r.spriteManager),a=s_.Parse(o,t||D.l.LastCreatedScene,i);a.snippetId=e,s(a)}else r("Unable to load the snippet "+e)})),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()}))}}s_.SnippetUrl="https://snippet.babylonjs.com",s_.CreateFromSnippetAsync=s_.ParseFromSnippetAsync,i(45675),i(76692);class r_{get spriteCount(){return this.sprites.length}get position(){return this._output.position}set position(e){this._output.position=e}get rotation(){return this._output.rotation}set rotation(e){this._output.rotation=e}get animationMap(){return this._animationMap}set animationMap(e){const t=e._texture._bufferView,i=this._createTileAnimationBuffer(t);this._animationMap.dispose(),this._animationMap=i,this._material.setTexture("animationMap",this._animationMap)}constructor(e,t,i,s,r){this.name=e,this.sprites=[],this.atlasJSON=t,this.sprites=this.atlasJSON.frames,this.spriteSheet=i,this.options=s,s.stageSize=s.stageSize||new m.FM(1,1),s.outputSize=s.outputSize||s.stageSize,s.outputPosition=s.outputPosition||m.P.Zero(),s.outputRotation=s.outputRotation||m.P.Zero(),s.layerCount=s.layerCount||1,s.maxAnimationFrames=s.maxAnimationFrames||0,s.baseTile=s.baseTile||0,s.flipU=s.flipU||!1,s.colorMultiply=s.colorMultiply||new m.P(1,1,1),this._scene=r,this._frameMap=this._createFrameBuffer(),this._tileMaps=new Array;for(let e=0;e<s.layerCount;e++)this._tileMaps.push(this._createTileBuffer(null,e));this._animationMap=this._createTileAnimationBuffer(null);const n=[];n.push("#define LAYERS "+s.layerCount),s.flipU&&n.push("#define FLIPU"),n.push(`#define MAX_ANIMATION_FRAMES ${s.maxAnimationFrames}.0`);const o=Pi.Q.ShadersStore.spriteMapPixelShader;let a;if(r.getEngine()._features.supportSwitchCaseInShader){a="switch(i) {";for(let e=0;e<s.layerCount;e++)a+="case "+e+" : frameID = texture(tileMaps["+e+"], (tileID + 0.5) / stageSize, 0.).x;",a+="break;";a+="}"}else{a="";for(let e=0;e<s.layerCount;e++)a+=`if (${e} == i) { frameID = texture2D(tileMaps[${e}], (tileID + 0.5) / stageSize, 0.).x; }`}Pi.Q.ShadersStore["spriteMap"+this.name+"PixelShader"]=o.replace("#define LAYER_ID_SWITCH",a),this._material=new xi.j("spriteMap:"+this.name,this._scene,{vertex:"spriteMap",fragment:"spriteMap"+this.name},{defines:n,attributes:["position","normal","uv"],uniforms:["worldViewProjection","time","stageSize","outputSize","spriteMapSize","spriteCount","time","colorMul","mousePosition","curTile","flipU"],samplers:["spriteSheet","frameMap","tileMaps","animationMap"],needAlphaBlending:!0}),this._time=0,this._material.setFloat("spriteCount",this.spriteCount),this._material.setVector2("stageSize",s.stageSize),this._material.setVector2("outputSize",s.outputSize),this._material.setTexture("spriteSheet",this.spriteSheet),this._material.setVector2("spriteMapSize",new m.FM(1,1)),this._material.setVector3("colorMul",s.colorMultiply);let h=0;const l=()=>{this.spriteSheet&&this.spriteSheet.isReady()&&this.spriteSheet._texture?this._material.setVector2("spriteMapSize",new m.FM(this.spriteSheet._texture.baseWidth||1,this.spriteSheet._texture.baseHeight||1)):h<100&&setTimeout((()=>{h++,l()}),100)};l(),this._material.setVector3("colorMul",s.colorMultiply),this._material.setTexture("frameMap",this._frameMap),this._material.setTextureArray("tileMaps",this._tileMaps),this._material.setTexture("animationMap",this._animationMap),this._material.setFloat("time",this._time),this._output=(0,Ls.pT)(e+":output",{size:1,updatable:!0},r),this._output.scaling.x=s.outputSize.x,this._output.scaling.y=s.outputSize.y,this.position=s.outputPosition,this.rotation=s.outputRotation,this._scene.onBeforeRenderObservable.add((()=>{this._time+=this._scene.getEngine().getDeltaTime(),this._material.setFloat("time",this._time)})),this._output.material=this._material}getTileID(){const e=this.getMousePosition();return e.multiplyInPlace(this.options.stageSize||m.FM.Zero()),e.x=Math.floor(e.x),e.y=Math.floor(e.y),e}getMousePosition(){const e=this._output,t=this._scene.pick(this._scene.pointerX,this._scene.pointerY,(t=>t===e));if(!t||!t.hit||!t.getTextureCoordinates)return new m.FM(-1,-1);return t.getTextureCoordinates()||new m.FM(-1,-1)}_createFrameBuffer(){const e=new Array;for(let t=0;t<this.spriteCount;t++)e.push(0,0,0,0),e.push(0,0,0,0),e.push(0,0,0,0),e.push(0,0,0,0);for(let t=0;t<this.spriteCount;t++){const i=this.sprites[t].frame,s=this.sprites[t].spriteSourceSize,r=this.sprites[t].sourceSize,n=this.sprites[t].rotated?1:0,o=this.sprites[t].trimmed?1:0;e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.w,e[4*t+3]=i.h,e[4*t+4*this.spriteCount]=s.x,e[4*t+1+4*this.spriteCount]=s.y,e[4*t+3+4*this.spriteCount]=s.h,e[4*t+8*this.spriteCount]=r.w,e[4*t+1+8*this.spriteCount]=r.h,e[4*t+2+8*this.spriteCount]=n,e[4*t+3+8*this.spriteCount]=o}const t=new Float32Array(e);return Y.l.CreateRGBATexture(t,this.spriteCount,4,this._scene,!1,!1,X.x.NEAREST_NEAREST,O.D.TEXTURETYPE_FLOAT)}_createTileBuffer(e,t=0){let i=new Array;const s=this.options.stageSize.y||0,r=this.options.stageSize.x||0;if(e)i=e;else{let e=this.options.baseTile;0!=t&&(e=0);for(let t=0;t<s;t++)for(let t=0;t<4*r;t+=4)i.push(e,0,0,0)}const n=new Float32Array(i);return Y.l.CreateRGBATexture(n,r,s,this._scene,!1,!1,X.x.NEAREST_NEAREST,O.D.TEXTURETYPE_FLOAT)}changeTiles(e=0,t,i=0){const s=this._tileMaps[e]._texture._bufferView;if(null===s)return;let r=new Array;t instanceof m.FM?r.push(t):r=t;const n=this.options.stageSize.x||0;for(let e=0;e<r.length;e++){const t=r[e];t.x=Math.floor(t.x),t.y=Math.floor(t.y),s[4*t.x+t.y*(4*n)]=i}const o=this._createTileBuffer(s);this._tileMaps[e].dispose(),this._tileMaps[e]=o,this._material.setTextureArray("tileMap",this._tileMaps)}_createTileAnimationBuffer(e){const t=new Array;let i;if(e)i=e;else{for(let e=0;e<this.spriteCount;e++){t.push(0,0,0,0);let e=1;for(;e<(this.options.maxAnimationFrames||4);)t.push(0,0,0,0),e++}i=new Float32Array(t)}return Y.l.CreateRGBATexture(i,this.spriteCount,this.options.maxAnimationFrames||4,this._scene,!1,!1,X.x.NEAREST_NEAREST,O.D.TEXTURETYPE_FLOAT)}addAnimationToTile(e=0,t=0,i=0,s=0,r=1){const n=this._animationMap._texture._bufferView,o=4*e+4*this.spriteCount*t;if(!n)return;n[o]=i,n[o+1]=s,n[o+2]=r;const a=this._createTileAnimationBuffer(n);this._animationMap.dispose(),this._animationMap=a,this._material.setTexture("animationMap",this._animationMap)}saveTileMaps(){let e="";for(let t=0;t<this._tileMaps.length;t++)t>0&&(e+="\n\r"),e+=this._tileMaps[t]._texture._bufferView.toString();const t=document.createElement("a");t.href="data:octet/stream;charset=utf-8,"+encodeURI(e),t.target="_blank",t.download=this.name+".tilemaps",t.click(),t.remove()}loadTileMaps(e){const t=new XMLHttpRequest;t.open("GET",e);const i=this.options.layerCount||0;t.onload=()=>{const e=t.response.split("\n\r");for(let t=0;t<i;t++){const i=e[t].split(",").map(Number),s=this._createTileBuffer(i);this._tileMaps[t].dispose(),this._tileMaps[t]=s}this._material.setTextureArray("tileMap",this._tileMaps)},t.send()}dispose(){this._output.dispose(),this._material.dispose(),this._animationMap.dispose(),this._tileMaps.forEach((e=>{e.dispose()})),this._frameMap.dispose()}}class n_ extends s_{constructor(e,t,i,s,r=null,n=.01,o=X.x.TRILINEAR_SAMPLINGMODE){super(e,t,i,64,s,n,o,!0,r),this.name=e}}var o_,a_=i(5253),h_=i(70461),l_=i(59522),c_=i(91773),u_=i(66781);!function(e){e[e.INIT=0]="INIT",e[e.RUNNING=1]="RUNNING",e[e.DONE=2]="DONE",e[e.ERROR=3]="ERROR"}(o_||(o_={}));class d_{constructor(e){this.name=e,this._isCompleted=!1,this._taskState=o_.INIT}get isCompleted(){return this._isCompleted}get taskState(){return this._taskState}get errorObject(){return this._errorObject}_setErrorObject(e,t){this._errorObject||(this._errorObject={message:e,exception:t})}run(e,t,i){this._taskState=o_.RUNNING,this.runTask(e,(()=>{this._onDoneCallback(t,i)}),((e,t)=>{this._onErrorCallback(i,e,t)}))}runTask(e,t,i){throw new Error("runTask is not implemented")}reset(){this._taskState=o_.INIT}_onErrorCallback(e,t,i){this._taskState=o_.ERROR,this._errorObject={message:t,exception:i},this.onError&&this.onError(this,t,i),e()}_onDoneCallback(e,t){try{this._taskState=o_.DONE,this._isCompleted=!0,this.onSuccess&&this.onSuccess(this),e()}catch(e){this._onErrorCallback(t,"Task is done, error executing success callback(s)",e)}}}class p_{constructor(e,t,i){this.remainingCount=e,this.totalCount=t,this.task=i}}class __ extends d_{constructor(e,t,i,s,r){super(e),this.name=e,this.meshesNames=t,this.rootUrl=i,this.sceneFilename=s,this.extension=r}runTask(e,t,i){Ps.n.LoadAssetContainer(this.rootUrl,this.sceneFilename,e,(e=>{this.loadedContainer=e,this.loadedMeshes=e.meshes,this.loadedTransformNodes=e.transformNodes,this.loadedParticleSystems=e.particleSystems,this.loadedSkeletons=e.skeletons,this.loadedAnimationGroups=e.animationGroups,t()}),null,((e,t,s)=>{i(t,s)}),this.extension)}}class g_ extends d_{constructor(e,t,i,s,r){super(e),this.name=e,this.meshesNames=t,this.rootUrl=i,this.sceneFilename=s,this.extension=r}runTask(e,t,i){Ps.n.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,e,((e,i,s,r,n)=>{this.loadedMeshes=e,this.loadedTransformNodes=n,this.loadedParticleSystems=i,this.loadedSkeletons=s,this.loadedAnimationGroups=r,t()}),null,((e,t,s)=>{i(t,s)}),this.extension)}}class m_ extends d_{constructor(e,t,i,s,r){super(e),this.name=e,this.rootUrl=t,this.filename=i,this.targetConverter=s,this.extension=r}runTask(e,t,i){const s=e.animatables.length,r=e.animationGroups.length;this.loadedAnimatables=[],this.loadedAnimationGroups=[],Ps.n.ImportAnimations(this.rootUrl,this.filename,e,!1,Ps.O.NoSync,this.targetConverter,(()=>{this.loadedAnimatables=e.animatables.slice(s),this.loadedAnimationGroups=e.animationGroups.slice(r),t()}),null,((e,t,s)=>{i(t,s)}),this.extension)}}class f_ extends d_{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){e._loadFile(this.url,(e=>{this.text=e,t()}),void 0,!1,!1,((e,t)=>{e&&i(e.status+" "+e.statusText,t)}))}}class b_ extends d_{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){e._loadFile(this.url,(e=>{this.data=e,t()}),void 0,!0,!0,((e,t)=>{e&&i(e.status+" "+e.statusText,t)}))}}class v_ extends d_{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){const s=new Image;w.w1.SetCorsBehavior(this.url,s),s.onload=()=>{this.image=s,t()},s.onerror=e=>{i("Error loading image",e)},s.src=this.url}}class y_ extends d_{constructor(e,t,i,s=!0,r=X.x.TRILINEAR_SAMPLINGMODE){super(e),this.name=e,this.url=t,this.noMipmap=i,this.invertY=s,this.samplingMode=r}runTask(e,t,i){this.texture=new X.x(this.url,e,this.noMipmap,this.invertY,this.samplingMode,(()=>{t()}),((e,t)=>{i(e,t)}))}}class x_ extends d_{constructor(e,t,i,s,r,n){super(e),this.name=e,this.url=t,this.extensions=i,this.noMipmap=s,this.files=r,this.prefiltered=n}runTask(e,t,i){this.texture=new ln.B(this.url,e,this.extensions,this.noMipmap,this.files,(()=>{t()}),((e,t)=>{i(e,t)}),void 0,this.prefiltered)}}class P_ extends d_{constructor(e,t,i,s=!1,r=!0,n=!1,o=!1){super(e),this.name=e,this.url=t,this.size=i,this.noMipmap=s,this.generateHarmonics=r,this.gammaSpace=n,this.reserved=o}runTask(e,t,i){this.texture=new cn.e(this.url,e,this.size,this.noMipmap,this.generateHarmonics,this.gammaSpace,this.reserved,(()=>{t()}),((e,t)=>{i(e,t)}))}}class C_ extends d_{constructor(e,t,i,s=!1,r=!0){super(e),this.name=e,this.url=t,this.size=i,this.noMipmap=s,this.gammaSpace=r}runTask(e,t,i){this.texture=new Zn(this.url,e,this.size,this.noMipmap,this.gammaSpace,(()=>{t()}),((e,t)=>{i(e,t)}))}}class T_{constructor(e){this._isLoading=!1,this._tasks=new Array,this._waitingTasksCount=0,this._totalTasksCount=0,this.onTaskSuccessObservable=new _.y$,this.onTaskErrorObservable=new _.y$,this.onTasksDoneObservable=new _.y$,this.onProgressObservable=new _.y$,this.useDefaultLoadingScreen=!0,this.autoHideLoadingUI=!0,this._scene=e||D.l.LastCreatedScene}addContainerTask(e,t,i,s,r){const n=new __(e,t,i,s,r);return this._tasks.push(n),n}addMeshTask(e,t,i,s,r){const n=new g_(e,t,i,s,r);return this._tasks.push(n),n}addTextFileTask(e,t){const i=new f_(e,t);return this._tasks.push(i),i}addBinaryFileTask(e,t){const i=new b_(e,t);return this._tasks.push(i),i}addImageTask(e,t){const i=new v_(e,t);return this._tasks.push(i),i}addTextureTask(e,t,i,s,r=X.x.TRILINEAR_SAMPLINGMODE){const n=new y_(e,t,i,s,r);return this._tasks.push(n),n}addCubeTextureTask(e,t,i,s,r,n){const o=new x_(e,t,i,s,r,n);return this._tasks.push(o),o}addHDRCubeTextureTask(e,t,i,s=!1,r=!0,n=!1,o=!1){const a=new P_(e,t,i,s,r,n,o);return this._tasks.push(a),a}addEquiRectangularCubeTextureAssetTask(e,t,i,s=!1,r=!0){const n=new C_(e,t,i,s,r);return this._tasks.push(n),n}removeTask(e){const t=this._tasks.indexOf(e);t>-1&&this._tasks.splice(t,1)}_decreaseWaitingTasksCount(e){this._waitingTasksCount--;try{this.onProgress&&this.onProgress(this._waitingTasksCount,this._totalTasksCount,e),this.onProgressObservable.notifyObservers(new p_(this._waitingTasksCount,this._totalTasksCount,e))}catch(e){p.Y.Error("Error running progress callbacks."),console.log(e)}if(0===this._waitingTasksCount){try{const e=this._tasks.slice();this.onFinish&&this.onFinish(e);for(const t of e)if(t.taskState===o_.DONE){const e=this._tasks.indexOf(t);e>-1&&this._tasks.splice(e,1)}this.onTasksDoneObservable.notifyObservers(this._tasks)}catch(e){p.Y.Error("Error running tasks-done callbacks."),console.log(e)}this._isLoading=!1,this.autoHideLoadingUI&&this._scene.getEngine().hideLoadingUI()}}_runTask(e){const t=(t,i)=>{e._setErrorObject(t,i),this.onTaskError?this.onTaskError(e):e.onError||p.Y.Error(this._formatTaskErrorMessage(e)),this.onTaskErrorObservable.notifyObservers(e),this._decreaseWaitingTasksCount(e)};e.run(this._scene,(()=>{try{this.onTaskSuccess&&this.onTaskSuccess(e),this.onTaskSuccessObservable.notifyObservers(e),this._decreaseWaitingTasksCount(e)}catch(e){t("Error executing task success callbacks",e)}}),t)}_formatTaskErrorMessage(e){let t="Unable to complete task "+e.name;return e.errorObject.message&&(t+=`: ${e.errorObject.message}`),e.errorObject.exception&&(t+=`: ${e.errorObject.exception}`),t}reset(){return this._isLoading=!1,this._tasks=new Array,this}load(){if(this._isLoading)return this;if(this._isLoading=!0,this._waitingTasksCount=this._tasks.length,this._totalTasksCount=this._tasks.length,0===this._waitingTasksCount)return this._isLoading=!1,this.onFinish&&this.onFinish(this._tasks),this.onTasksDoneObservable.notifyObservers(this._tasks),this;this.useDefaultLoadingScreen&&this._scene.getEngine().displayLoadingUI();for(let e=0;e<this._tasks.length;e++){const t=this._tasks[e];t.taskState===o_.INIT&&this._runTask(t)}return this}loadAsync(){return new Promise(((e,t)=>{this._isLoading?e():(this.onTasksDoneObservable.addOnce((i=>{i&&i.length?t(i):e()})),this.load())}))}}var S_=i(75414);class E_{constructor(e,t){this._meshesOrigins=[],this._toCenterVectors=[],this._scaledDirection=new m.P(1,1,1),this._newPosition=m.P.Zero(),this._centerPosition=m.P.Zero(),this._meshes=e.slice(),t?this._centerMesh=t:this._setCenterMesh(),this._centerMesh.computeWorldMatrix(!0);const i=this._meshes.indexOf(this._centerMesh);i>=0&&this._meshes.splice(i,1),this._centerPosition=this._centerMesh.getAbsolutePosition().clone();for(let e=0;e<this._meshes.length;e++)if(this._meshes[e]){const t=this._meshes[e];this._meshesOrigins[e]=t.getAbsolutePosition().clone(),this._toCenterVectors[e]=m.P.Zero(),t.hasBoundingInfo&&this._centerMesh.hasBoundingInfo&&(t.computeWorldMatrix(!0),t.getBoundingInfo().boundingBox.centerWorld.subtractToRef(this._centerMesh.getBoundingInfo().boundingBox.centerWorld,this._toCenterVectors[e]))}}_setCenterMesh(){let e=m.P.Zero();const t=m.P.Zero();let i=Number.MAX_VALUE;for(let e=0;e<this._meshes.length;e++)if(this._meshes[e]){const i=this._meshes[e].getBoundingInfo();i&&t.addInPlace(i.boundingBox.centerWorld)}e=t.scale(1/this._meshes.length);for(let t=0;t<this._meshes.length;t++)if(this._meshes[t]){const s=this._meshes[t],r=s.getBoundingInfo();if(r){const t=r.boundingBox.centerWorld.subtract(e).lengthSquared();t<i&&(this._centerMesh=s,i=t)}}}getClassName(){return"MeshExploder"}getMeshes(){const e=this._meshes.slice();return e.unshift(this._centerMesh),e}explode(e=1){for(let t=0;t<this._meshes.length;t++)this._meshes[t]&&this._meshesOrigins[t]&&this._toCenterVectors[t]&&(this._toCenterVectors[t].scaleToRef(e,this._scaledDirection),this._meshesOrigins[t].addToRef(this._scaledDirection,this._newPosition),this._meshes[t].setAbsolutePosition(this._newPosition));this._centerMesh.setAbsolutePosition(this._centerPosition)}}var R_=i(87087);class M_{static get FilesToLoad(){return R_.X.FilesToLoad}constructor(e,t,i,s,r,n,o,a,h,l=!1){this.useAppend=l,this.onProcessFileCallback=()=>!0,this.displayLoadingUI=!0,this.loadAsync=(e,t)=>this.useAppend?Ps.n.AppendAsync("file:",e,this._currentScene,t):Ps.n.LoadAsync("file:",e,this._engine,t),this._engine=e,this._currentScene=t,this._sceneLoadedCallback=i,this._progressCallback=s,this._additionalRenderLoopLogicCallback=r,this._textureLoadingCallback=n,this._startingProcessingFilesCallback=o,this._onReloadCallback=a,this._errorCallback=h}monitorElementForDragNDrop(e){e&&(this._elementToMonitor=e,this._dragEnterHandler=e=>{this._drag(e)},this._dragOverHandler=e=>{this._drag(e)},this._dropHandler=e=>{this._drop(e)},this._elementToMonitor.addEventListener("dragenter",this._dragEnterHandler,!1),this._elementToMonitor.addEventListener("dragover",this._dragOverHandler,!1),this._elementToMonitor.addEventListener("drop",this._dropHandler,!1))}get filesToLoad(){return this._filesToLoad}dispose(){this._elementToMonitor&&(this._elementToMonitor.removeEventListener("dragenter",this._dragEnterHandler),this._elementToMonitor.removeEventListener("dragover",this._dragOverHandler),this._elementToMonitor.removeEventListener("drop",this._dropHandler))}_renderFunction(){if(this._additionalRenderLoopLogicCallback&&this._additionalRenderLoopLogicCallback(),this._currentScene){if(this._textureLoadingCallback){const e=this._currentScene.getWaitingItemsCount();e>0&&this._textureLoadingCallback(e)}this._currentScene.render()}}_drag(e){e.stopPropagation(),e.preventDefault()}_drop(e){e.stopPropagation(),e.preventDefault(),this.loadFiles(e)}_traverseFolder(e,t,i,s){const r=e.createReader(),n=e.fullPath.replace(/^\//,"").replace(/(.+?)\/?$/,"$1/");r.readEntries((e=>{i.count+=e.length;for(const r of e)r.isFile?r.file((e=>{e.correctName=n+e.name,t.push(e),0==--i.count&&s()})):r.isDirectory&&this._traverseFolder(r,t,i,s);0==--i.count&&s()}))}_processFiles(e){for(let t=0;t<e.length;t++){const i=e[t].correctName.toLowerCase(),s=i.split(".").pop();this.onProcessFileCallback(e[t],i,s,(e=>this._sceneFileToLoad=e))&&(Ps.n.IsPluginForExtensionAvailable("."+s)&&(this._sceneFileToLoad=e[t]),M_.FilesToLoad[i]=e[t])}}loadFiles(e){if(e&&e.dataTransfer&&e.dataTransfer.files&&(this._filesToLoad=e.dataTransfer.files),e&&e.target&&e.target.files&&(this._filesToLoad=e.target.files),this._filesToLoad&&0!==this._filesToLoad.length&&(this._startingProcessingFilesCallback&&this._startingProcessingFilesCallback(this._filesToLoad),this._filesToLoad&&this._filesToLoad.length>0)){const t=new Array,i=[],s=e.dataTransfer?e.dataTransfer.items:null;for(let e=0;e<this._filesToLoad.length;e++){const r=this._filesToLoad[e],n=r.name.toLowerCase();let o;if(r.correctName=n,s){const t=s[e];t.getAsEntry?o=t.getAsEntry():t.webkitGetAsEntry&&(o=t.webkitGetAsEntry())}o&&o.isDirectory?i.push(o):t.push(r)}if(0===i.length)this._processFiles(t),this._processReload();else{const e={count:i.length};for(const s of i)this._traverseFolder(s,t,e,(()=>{this._processFiles(t),0===e.count&&this._processReload()}))}}}_processReload(){this._onReloadCallback?this._onReloadCallback(this._sceneFileToLoad):this.reload()}reload(){this._sceneFileToLoad?(this.useAppend||this._currentScene&&(p.Y.errorsCount>0&&p.Y.ClearLogCache(),this._engine.stopRenderLoop()),Ps.n.ShowLoadingScreen=!1,this.displayLoadingUI&&this._engine.displayLoadingUI(),this.loadAsync(this._sceneFileToLoad,this._progressCallback).then((e=>{this.useAppend?this.displayLoadingUI&&this._engine.hideLoadingUI():(this._currentScene&&this._currentScene.dispose(),this._currentScene=e,this._currentScene.executeWhenReady((()=>{this.displayLoadingUI&&this._engine.hideLoadingUI(),this._engine.runRenderLoop((()=>{this._renderFunction()}))}))),this._sceneLoadedCallback&&this._currentScene&&this._sceneLoadedCallback(this._sceneFileToLoad,this._currentScene)})).catch((e=>{this.displayLoadingUI&&this._engine.hideLoadingUI(),this._errorCallback&&this._errorCallback(this._sceneFileToLoad,this._currentScene,e.message)}))):p.Y.Error("Please provide a valid .babylon file.")}}var A_=i(49156);class I_{dispose(){if(this._observers&&this._observables)for(let e=0;e<this._observers.length;e++)this._observables[e].remove(this._observers[e]);this._observers=null,this._observables=null}static Watch(e,t,i=-1,s=null){const r=new I_;r._observers=new Array,r._observables=e;for(const n of e){const e=n.add(t,i,!1,s);e&&r._observers.push(e)}return r}}_.y$.prototype.notifyObserversWithPromise=async function(e,t=-1,i,s,r){let n=Promise.resolve(e);if(!this.observers.length)return n;const o=this._eventState;return o.mask=t,o.target=i,o.currentTarget=s,o.skipNextObservers=!1,o.userInfo=r,this.observers.forEach((i=>{o.skipNextObservers||i._willBeUnregistered||i.mask&t&&(n=i.scope?n.then((t=>(o.lastReturnValue=t,i.callback.apply(i.scope,[e,o])))):n.then((t=>(o.lastReturnValue=t,i.callback(e,o)))),i.unregisterOnNextCall&&this._deferUnregister(i))})),await n,e};var O_=i(56743);class w_{getDescription(){return""}apply(e,t){return!0}constructor(e=0){this.priority=e}}class D_ extends w_{getDescription(){return"Reducing render target texture size to "+this.maximumSize}constructor(e=0,t=1024,i=.5){super(e),this.priority=e,this.maximumSize=t,this.step=i}apply(e,t){let i=!0;for(let t=0;t<e.textures.length;t++){const s=e.textures[t];if(!s.canRescale||s.getContext)continue;const r=s.getSize();Math.max(r.width,r.height)>this.maximumSize&&(s.scale(this.step),i=!1)}return i}}class B_ extends w_{getDescription(){return"Setting hardware scaling level to "+this._currentScale}constructor(e=0,t=2,i=.25){super(e),this.priority=e,this.maximumScale=t,this.step=i,this._currentScale=-1,this._directionOffset=1}apply(e,t){return-1===this._currentScale&&(this._currentScale=e.getEngine().getHardwareScalingLevel(),this._currentScale>this.maximumScale&&(this._directionOffset=-1)),this._currentScale+=this._directionOffset*this.step,e.getEngine().setHardwareScalingLevel(this._currentScale),1===this._directionOffset?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale}}class N_ extends w_{getDescription(){return"Turning shadows on/off"}apply(e,t){return e.shadowsEnabled=t.isInImprovementMode,!0}}class F_ extends w_{getDescription(){return"Turning post-processes on/off"}apply(e,t){return e.postProcessesEnabled=t.isInImprovementMode,!0}}class L_ extends w_{getDescription(){return"Turning lens flares on/off"}apply(e,t){return e.lensFlaresEnabled=t.isInImprovementMode,!0}}class V_ extends w_{getDescription(){return this.onGetDescription?this.onGetDescription():"Running user defined callback"}apply(e,t){return!this.onApply||this.onApply(e,t)}}class k_ extends w_{getDescription(){return"Turning particles on/off"}apply(e,t){return e.particlesEnabled=t.isInImprovementMode,!0}}class z_ extends w_{getDescription(){return"Turning render targets off"}apply(e,t){return e.renderTargetsEnabled=t.isInImprovementMode,!0}}class G_ extends w_{constructor(){super(...arguments),this._canBeMerged=e=>{if(!(e instanceof Mt.Kj))return!1;const t=e;return!(t.isDisposed()||!t.isVisible||!t.isEnabled()||t.instances.length>0||t.skeleton||t.hasLODLevels||0===t.getTotalVertices())}}static get UpdateSelectionTree(){return G_._UpdateSelectionTree}static set UpdateSelectionTree(e){G_._UpdateSelectionTree=e}getDescription(){return"Merging similar meshes together"}apply(e,t,i){const s=e.meshes.slice(0);let r=s.length;for(let e=0;e<r;e++){const t=new Array,i=s[e];if(this._canBeMerged(i)){t.push(i);for(let n=e+1;n<r;n++){const e=s[n];this._canBeMerged(e)&&e.material===i.material&&e.checkCollisions===i.checkCollisions&&(t.push(e),r--,s.splice(n,1),n--)}t.length<2||Mt.Kj.MergeMeshes(t,void 0,!0)}}const n=e;return n.createOrUpdateSelectionOctree&&(null!=i?i&&n.createOrUpdateSelectionOctree():G_.UpdateSelectionTree&&n.createOrUpdateSelectionOctree()),!0}}G_._UpdateSelectionTree=!1;class U_{constructor(e=60,t=2e3){this.targetFrameRate=e,this.trackerDuration=t,this.optimizations=new Array}addOptimization(e){return this.optimizations.push(e),this}addCustomOptimization(e,t,i=0){const s=new V_(i);return s.onApply=e,s.onGetDescription=t,this.optimizations.push(s),this}static LowDegradationAllowed(e){const t=new U_(e);let i=0;return t.addOptimization(new G_(i)),t.addOptimization(new N_(i)),t.addOptimization(new L_(i)),i++,t.addOptimization(new F_(i)),t.addOptimization(new k_(i)),i++,t.addOptimization(new D_(i,1024)),t}static ModerateDegradationAllowed(e){const t=new U_(e);let i=0;return t.addOptimization(new G_(i)),t.addOptimization(new N_(i)),t.addOptimization(new L_(i)),i++,t.addOptimization(new F_(i)),t.addOptimization(new k_(i)),i++,t.addOptimization(new D_(i,512)),i++,t.addOptimization(new z_(i)),i++,t.addOptimization(new B_(i,2)),t}static HighDegradationAllowed(e){const t=new U_(e);let i=0;return t.addOptimization(new G_(i)),t.addOptimization(new N_(i)),t.addOptimization(new L_(i)),i++,t.addOptimization(new F_(i)),t.addOptimization(new k_(i)),i++,t.addOptimization(new D_(i,256)),i++,t.addOptimization(new z_(i)),i++,t.addOptimization(new B_(i,4)),t}}class W_{get isInImprovementMode(){return this._improvementMode}set isInImprovementMode(e){this._improvementMode=e}get currentPriorityLevel(){return this._currentPriorityLevel}get currentFrameRate(){return this._currentFrameRate}get targetFrameRate(){return this._targetFrameRate}set targetFrameRate(e){this._targetFrameRate=e}get trackerDuration(){return this._trackerDuration}set trackerDuration(e){this._trackerDuration=e}get optimizations(){return this._options.optimizations}constructor(e,t,i=!0,s=!1){if(this._isRunning=!1,this._currentPriorityLevel=0,this._targetFrameRate=60,this._trackerDuration=2e3,this._currentFrameRate=0,this._improvementMode=!1,this.onSuccessObservable=new _.y$,this.onNewOptimizationAppliedObservable=new _.y$,this.onFailureObservable=new _.y$,this._options=t||new U_,this._options.targetFrameRate&&(this._targetFrameRate=this._options.targetFrameRate),this._options.trackerDuration&&(this._trackerDuration=this._options.trackerDuration),i){let e=0;for(const t of this._options.optimizations)t.priority=e++}this._improvementMode=s,this._scene=e||D.l.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add((()=>{this._sceneDisposeObserver=null,this.dispose()}))}stop(){this._isRunning=!1}reset(){this._currentPriorityLevel=0}start(){this._isRunning||(this._isRunning=!0,this._scene.executeWhenReady((()=>{setTimeout((()=>{this._checkCurrentState()}),this._trackerDuration)})))}_checkCurrentState(){if(!this._isRunning)return;const e=this._scene,t=this._options;if(this._currentFrameRate=Math.round(e.getEngine().getFps()),this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate)return this._isRunning=!1,void this.onSuccessObservable.notifyObservers(this);let i=!0,s=!0;for(let r=0;r<t.optimizations.length;r++){const n=t.optimizations[r];n.priority===this._currentPriorityLevel&&(s=!1,i=i&&n.apply(e,this),this.onNewOptimizationAppliedObservable.notifyObservers(n))}if(s)return this._isRunning=!1,void this.onFailureObservable.notifyObservers(this);i&&this._currentPriorityLevel++,e.executeWhenReady((()=>{setTimeout((()=>{this._checkCurrentState()}),this._trackerDuration)}))}dispose(){this.stop(),this.onSuccessObservable.clear(),this.onFailureObservable.clear(),this.onNewOptimizationAppliedObservable.clear(),this._sceneDisposeObserver&&this._scene.onDisposeObservable.remove(this._sceneDisposeObserver)}static OptimizeAsync(e,t,i,s){const r=new W_(e,t||U_.ModerateDegradationAllowed(),!1);return i&&r.onSuccessObservable.add((()=>{i()})),s&&r.onFailureObservable.add((()=>{s()})),r.start(),r}}var H_=i(6350),j_=i(30750),$_=i(29026),Y_=i(14873);class X_{static IsSupported(e){const t=e.getRenderingCanvas();return!!t&&"function"==typeof t.captureStream}get isRecording(){return!!this._canvas&&this._canvas.isRecording}constructor(e,t={}){if(!X_.IsSupported(e))throw"Your browser does not support recording so far.";const i=e.getRenderingCanvas();if(!i)throw"The babylon engine must have a canvas to be recorded";this._canvas=i,this._canvas.isRecording=!1,this._options=Object.assign(Object.assign({},X_._DefaultOptions),t);const s=this._canvas.captureStream(this._options.fps);if(this._options.audioTracks)for(const e of this._options.audioTracks)s.addTrack(e);this._mediaRecorder=new MediaRecorder(s,{mimeType:this._options.mimeType}),this._mediaRecorder.ondataavailable=this._handleDataAvailable.bind(this),this._mediaRecorder.onerror=this._handleError.bind(this),this._mediaRecorder.onstop=this._handleStop.bind(this)}stopRecording(){this._canvas&&this._mediaRecorder&&this.isRecording&&(this._canvas.isRecording=!1,this._mediaRecorder.stop())}startRecording(e="babylonjs.webm",t=7){if(!this._canvas||!this._mediaRecorder)throw"Recorder has already been disposed";if(this.isRecording)throw"Recording already in progress";return t>0&&setTimeout((()=>{this.stopRecording()}),1e3*t),this._fileName=e,this._recordedChunks=[],this._resolve=null,this._reject=null,this._canvas.isRecording=!0,this._mediaRecorder.start(this._options.recordChunckSize),new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}dispose(){this._canvas=null,this._mediaRecorder=null,this._recordedChunks=[],this._fileName=null,this._resolve=null,this._reject=null}_handleDataAvailable(e){e.data.size>0&&this._recordedChunks.push(e.data)}_handleError(e){if(this.stopRecording(),!this._reject)throw new e.error;this._reject(e.error)}_handleStop(){this.stopRecording();const e=new Blob(this._recordedChunks);this._resolve&&this._resolve(e),window.URL.createObjectURL(e),this._fileName&&w.w1.Download(e,this._fileName)}}X_._DefaultOptions={mimeType:"video/webm",fps:25,recordChunckSize:3e3};var Q_=i(7796);let q_=null;function K_(e,t,i,s,r="image/png",n=!1,o){const{height:a,width:h}=ig(e,t,i);if(!a||!h)return void p.Y.Error("Invalid 'size' parameter !");q_||(q_=document.createElement("canvas")),q_.width=h,q_.height=a;const l=q_.getContext("2d"),c=e.getRenderWidth()/e.getRenderHeight();let u=h,d=u/c;d>a&&(d=a,u=d*c);const _=Math.max(0,h-u)/2,g=Math.max(0,a-d)/2;t.getScene().activeCamera!==t?eg(e,t,i,(e=>{if(n){const t=new Blob([e]);w.w1.DownloadBlob(t),s&&s("")}else s&&s(e)}),r,1,e.getCreationOptions().antialias,void 0,void 0,void 0,void 0,o):e.onEndFrameObservable.addOnce((()=>{const t=e.getRenderingCanvas();l&&t&&l.drawImage(t,_,g,u,d),q_&&(n?(w.w1.EncodeScreenshotCanvasData(q_,void 0,r,void 0,o),s&&s("")):w.w1.EncodeScreenshotCanvasData(q_,s,r,void 0,o))}))}function Z_(e,t,i,s="image/png",r){return new Promise(((n,o)=>{K_(e,t,i,(e=>{void 0!==e?n(e):o(new Error("Data is undefined"))}),s,void 0,r)}))}function J_(e,t,i,s,r="image/png",n){return new Promise((o=>{K_(e,t,{width:i,height:s},(()=>{o()}),r,!0,n)}))}function eg(e,t,i,s,r="image/png",n=1,o=!1,a,h=!1,l=!1,c=!0,u){const{height:d,width:_,finalWidth:g,finalHeight:m}=ig(e,t,i),f={width:_,height:d};if(!d||!_)return void p.Y.Error("Invalid 'size' parameter !");const b={width:e.getRenderWidth(),height:e.getRenderHeight()};e.setSize(_,d);const v=t.getScene(),y=new Ur._("screenShot",f,v,!1,!1,0,!1,X.x.BILINEAR_SAMPLINGMODE,void 0,l,void 0,void 0,void 0,n);y.renderList=v.meshes.slice(),y.samples=n,y.renderSprites=h,y.activeCamera=t,y.forceLayerMaskCheck=c;const x=()=>{e.onEndFrameObservable.addOnce((()=>{g===_&&m===d?y.readPixels(void 0,void 0,void 0,!1).then((e=>{Q_.B.DumpData(_,d,e,s,r,a,!0,void 0,u),y.dispose()})):(0,Y_.$0)("pass",y.getInternalTexture(),v,void 0,void 0,void 0,g,m).then((t=>{e._readTexturePixels(t,g,m,-1,0,null,!0,!1,0,0).then((e=>{Q_.B.DumpData(g,m,e,s,r,a,!0,void 0,u),t.dispose()}))}))})),v.incrementRenderId(),v.resetCachedMaterial(),y.render(!0),v.incrementRenderId(),v.resetCachedMaterial(),e.setSize(b.width,b.height),t.getProjectionMatrix(!0),v.render()};if(o){const e=new Kd.P("antialiasing",1,v.activeCamera);y.addPostProcess(e),e.getEffect().isReady()?x():e.getEffect().onCompiled=()=>{x()}}else x()}function tg(e,t,i,s="image/png",r=1,n=!1,o,a=!1,h=!1,l=!0,c){return new Promise(((u,d)=>{eg(e,t,i,(e=>{void 0!==e?u(e):d(new Error("Data is undefined"))}),s,r,n,o,a,h,l,c)}))}function ig(e,t,i){let s=0,r=0,n=0,o=0;if("object"==typeof i){const a=i.precision?Math.abs(i.precision):1;i.width&&i.height?(s=i.height*a,r=i.width*a):i.width&&!i.height?(r=i.width*a,s=Math.round(r/e.getAspectRatio(t))):i.height&&!i.width?(s=i.height*a,r=Math.round(s*e.getAspectRatio(t))):(r=Math.round(e.getRenderWidth()*a),s=Math.round(r/e.getAspectRatio(t))),i.finalWidth&&i.finalHeight?(o=i.finalHeight,n=i.finalWidth):i.finalWidth&&!i.finalHeight?(n=i.finalWidth,o=Math.round(n/e.getAspectRatio(t))):i.finalHeight&&!i.finalWidth?(o=i.finalHeight,n=Math.round(o*e.getAspectRatio(t))):(n=r,o=s)}else isNaN(i)||(s=i,r=i,n=i,o=i);return r&&(r=Math.floor(r)),s&&(s=Math.floor(s)),n&&(n=Math.floor(n)),o&&(o=Math.floor(o)),{height:0|s,width:0|r,finalWidth:0|n,finalHeight:0|o}}const sg={CreateScreenshot:K_,CreateScreenshotAsync:Z_,CreateScreenshotWithResizeAsync:J_,CreateScreenshotUsingRenderTarget:eg,CreateScreenshotUsingRenderTargetAsync:tg};var rg;w.w1.CreateScreenshot=K_,w.w1.CreateScreenshotAsync=Z_,w.w1.CreateScreenshotUsingRenderTarget=eg,w.w1.CreateScreenshotUsingRenderTargetAsync=tg,function(e){e[e.Checkbox=0]="Checkbox",e[e.Slider=1]="Slider",e[e.Vector3=2]="Vector3",e[e.Quaternion=3]="Quaternion",e[e.Color3=4]="Color3",e[e.String=5]="String",e[e.Button=6]="Button",e[e.Options=7]="Options",e[e.Tab=8]="Tab",e[e.FileButton=9]="FileButton",e[e.Vector2=10]="Vector2"}(rg||(rg={}));var ng,og=i(18563),ag=i(83723),hg=(i(86480),i(42246),i(48044)),lg=(i(80696),i(38994),i(12830)),cg=i(28740),ug=i(30889);class dg{static _GetStorage(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch(e){const t={};return{getItem:e=>{const i=t[e];return void 0===i?null:i},setItem:(e,i)=>{t[e]=i}}}}static ReadString(e,t){const i=this._Storage.getItem(e);return null!==i?i:t}static WriteString(e,t){this._Storage.setItem(e,t)}static ReadBoolean(e,t){const i=this._Storage.getItem(e);return null!==i?"true"===i:t}static WriteBoolean(e,t){this._Storage.setItem(e,t?"true":"false")}static ReadNumber(e,t){const i=this._Storage.getItem(e);return null!==i?parseFloat(i):t}static WriteNumber(e,t){this._Storage.setItem(e,t.toString())}}dg._Storage=dg._GetStorage();class pg{constructor(){this._trackedScene=null}track(e){this._trackedScene=e,j.p4.AllowLoadingUniqueId=!0,this._savedJSON=H_.K.Serialize(e),j.p4.AllowLoadingUniqueId=!1}getDelta(){if(!this._trackedScene)return null;const e=X.x.ForceSerializeBuffers;X.x.ForceSerializeBuffers=!1,j.p4.AllowLoadingUniqueId=!0;const t=H_.K.Serialize(this._trackedScene);j.p4.AllowLoadingUniqueId=!1;const i={};for(const e in t)this._compareCollections(e,this._savedJSON[e],t[e],i);return X.x.ForceSerializeBuffers=e,i}_compareArray(e,t,i,s){if(0===t.length&&0===i.length)return!0;if(t.length&&!isNaN(t[0])||i.length&&!isNaN(i[0])){if(t.length!==i.length)return!1;if(0===t.length)return!0;for(let r=0;r<t.length;r++)if(t[r]!==i[r])return s[e]=i,!1;return!0}const r=[];for(let n=0;n<t.length;n++){const o=t[n],a=o.uniqueId;r.push(a);const h=i.filter((e=>e.uniqueId===a));if(h.length){const t=h[0],i={};this._compareObjects(o,t,i)||(s[e]||(s[e]=[]),i.__state={id:t.id||t.name},s[e].push(i))}else{const t={__state:{deleteId:o.id||o.name}};s[e]||(s[e]=[]),s[e].push(t)}}for(let t=0;t<i.length;t++){const n=i[t],o=n.uniqueId;-1===r.indexOf(o)&&(s[e]||(s[e]=[]),s[e].push(n))}return!0}_compareObjects(e,t,i){let s=!1;for(const r in e){if(!Object.prototype.hasOwnProperty.call(e,r))continue;const n=e[r],o=t[r];let a=!1;if(Array.isArray(n))a=JSON.stringify(n)!==JSON.stringify(o);else if(isNaN(n)&&"[object String]"!=Object.prototype.toString.call(n)){if("object"==typeof n&&"object"==typeof o){const e={};this._compareObjects(n,o,e)||(i[r]=e,s=!0)}}else a=n!==o;a&&(s=!0,i[r]=o)}return!s}_compareCollections(e,t,i,s){if(t!==i&&t&&i)if(Array.isArray(t)&&Array.isArray(i)){if(this._compareArray(e,t,i,s))return}else if("object"==typeof t&&"object"==typeof i){const r={};return void(this._compareObjects(t,i,r)||(s[e]=r))}}static GetShadowGeneratorById(e,t){const i=e.lights.map((e=>e.getShadowGenerators()));for(const e of i)if(e){const i=e.values();for(let e=i.next();!0!==e.done;e=i.next()){const i=e.value;if(i&&i.id===t)return i}}return null}static ApplyDelta(e,t){"string"==typeof e&&(e=JSON.parse(e));const i=t;for(const s in e){const r=e[s],n=i[s];if(Array.isArray(n)||"shadowGenerators"===s)switch(s){case"cameras":this._ApplyDeltaForEntity(r,t,t.getCameraById.bind(t),(e=>Ue.V.Parse(e,t)));break;case"lights":this._ApplyDeltaForEntity(r,t,t.getLightById.bind(t),(e=>Jr._.Parse(e,t)));break;case"shadowGenerators":this._ApplyDeltaForEntity(r,t,(e=>this.GetShadowGeneratorById(t,e)),(e=>tn.u.Parse(e,t)));break;case"meshes":this._ApplyDeltaForEntity(r,t,t.getMeshById.bind(t),(e=>Mt.Kj.Parse(e,t,"")));break;case"skeletons":this._ApplyDeltaForEntity(r,t,t.getSkeletonById.bind(t),(e=>ge.O.Parse(e,t)));break;case"materials":this._ApplyDeltaForEntity(r,t,t.getMaterialById.bind(t),(e=>yi.F.Parse(e,t,"")));break;case"multiMaterials":this._ApplyDeltaForEntity(r,t,t.getMaterialById.bind(t),(e=>hn.G.Parse(e,t,"")));break;case"transformNodes":this._ApplyDeltaForEntity(r,t,t.getTransformNodeById.bind(t),(e=>dt.Y.Parse(e,t,"")));break;case"particleSystems":this._ApplyDeltaForEntity(r,t,t.getParticleSystemById.bind(t),(e=>Qu.p.Parse(e,t,"")));break;case"morphTargetManagers":this._ApplyDeltaForEntity(r,t,t.getMorphTargetById.bind(t),(e=>un.O.Parse(e,t)));break;case"postProcesses":this._ApplyDeltaForEntity(r,t,t.getPostProcessByName.bind(t),(e=>Wr.D.Parse(e,t,"")))}else isNaN(n)?n.fromArray&&n.fromArray(r):i[s]=r}}static _ApplyPropertiesToEntity(e,t){for(const i in e){const s=e[i],r=t[i];void 0!==r&&(!isNaN(r)||Array.isArray(r)?t[i]=s:r.fromArray?r.fromArray(s):"object"==typeof r&&null!==r&&this._ApplyPropertiesToEntity(s,r))}}static _ApplyDeltaForEntity(e,t,i,s){for(const r of e)if(r.__state&&void 0!==r.__state.id){const e=i(r.__state.id);e&&(this._ApplyPropertiesToEntity(r,e),j.p4.ParseProperties(r,e,t,null))}else if(r.__state&&void 0!==r.__state.deleteId){const e=i(r.__state.deleteId);null==e||e.dispose()}else s(r)}}!function(e){class t{serialize(){const e={},t=new Array(this._characterToIdx.size);return this._characterToIdx.forEach(((e,i)=>{t[e]=i})),e.characters=t,e.insertionCosts=this._insertionCosts,e.deletionCosts=this._deletionCosts,e.substitutionCosts=this._substitutionCosts,JSON.stringify(e)}static Deserialize(e){const i=JSON.parse(e),s=new t(i.characters);return s._insertionCosts=i.insertionCosts,s._deletionCosts=i.deletionCosts,s._substitutionCosts=i.substitutionCosts,s}constructor(e,t=null,i=null,s=null){let r;t=null!=t?t:()=>1,i=null!=i?i:()=>1,s=null!=s?s:(e,t)=>e===t?0:1,this._characterToIdx=new Map,this._insertionCosts=new Array(e.length),this._deletionCosts=new Array(e.length),this._substitutionCosts=new Array(e.length);for(let n=0;n<e.length;++n){r=e[n],this._characterToIdx.set(r,n),this._insertionCosts[n]=t(r),this._deletionCosts[n]=i(r),this._substitutionCosts[n]=new Array(e.length);for(let t=n;t<e.length;++t)this._substitutionCosts[n][t]=s(r,e[t])}}getCharacterIdx(e){return this._characterToIdx.get(e)}getInsertionCost(e){return this._insertionCosts[e]}getDeletionCost(e){return this._deletionCosts[e]}getSubstitutionCost(e,t){const i=Math.min(e,t),s=Math.max(e,t);return this._substitutionCosts[i][s]}}e.Alphabet=t;class i{serialize(){return JSON.stringify(this._characters)}static Deserialize(e,t){const s=new i([],t);return s._characters=JSON.parse(e),s}constructor(e,t){if(e.length>i._MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+i._MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=t,this._characters=e.map((e=>this._alphabet.getCharacterIdx(e)))}distance(e){return i._Distance(this,e)}static _Distance(e,t){const s=e._alphabet;if(s!==t._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");const r=e._characters,n=t._characters,o=r.length,a=n.length,h=i._CostMatrix;h[0][0]=0;for(let e=0;e<o;++e)h[e+1][0]=h[e][0]+s.getInsertionCost(r[e]);for(let e=0;e<a;++e)h[0][e+1]=h[0][e]+s.getInsertionCost(n[e]);for(let e=0;e<o;++e)for(let t=0;t<a;++t)i._InsertionCost=h[e+1][t]+s.getInsertionCost(n[t]),i._DeletionCost=h[e][t+1]+s.getDeletionCost(r[e]),i._SubstitutionCost=h[e][t]+s.getSubstitutionCost(r[e],n[t]),h[e+1][t+1]=Math.min(i._InsertionCost,i._DeletionCost,i._SubstitutionCost);return h[o][a]}}i._MAX_SEQUENCE_LENGTH=256,i._CostMatrix=[...Array(i._MAX_SEQUENCE_LENGTH+1)].map((()=>new Array(i._MAX_SEQUENCE_LENGTH+1))),e.Sequence=i}(ng||(ng={}));class _g{serialize(){return JSON.stringify(this)}static Deserialize(e){const t=JSON.parse(e),i=new _g(t._segmentLength);return i._points=t._points.map((e=>new m.P(e._x,e._y,e._z))),i}constructor(e=.01){this._points=[],this._segmentLength=e}getLength(){return this._points.length*this._segmentLength}add(e){let t=this._points.length;if(0===t)this._points.push(e.clone());else{const i=()=>this._segmentLength/m.P.Distance(this._points[t-1],e);for(let s=i();s<=1;s=i()){const i=this._points[t-1].scale(1-s);e.scaleAndAddToRef(s,i),this._points.push(i),++t}}}resampleAtTargetResolution(e){const t=new _g(this.getLength()/e);return this._points.forEach((e=>{t.add(e)})),t}tokenize(e){const t=[],i=new m.P;for(let s=2;s<this._points.length;++s)_g._TransformSegmentDirToRef(this._points[s-2],this._points[s-1],this._points[s],i)&&t.push(_g._TokenizeSegment(i,e));return t}static _TransformSegmentDirToRef(e,t,i,s){return t.subtractToRef(e,_g._ForwardDir),_g._ForwardDir.normalize(),t.scaleToRef(-1,_g._InverseFromVec),_g._InverseFromVec.normalize(),!(Math.abs(m.P.Dot(_g._ForwardDir,_g._InverseFromVec))>.98||(m.P.CrossToRef(_g._ForwardDir,_g._InverseFromVec,_g._UpDir),_g._UpDir.normalize(),m.y3.LookAtLHToRef(e,t,_g._UpDir,_g._LookMatrix),i.subtractToRef(t,_g._FromToVec),_g._FromToVec.normalize(),m.P.TransformNormalToRef(_g._FromToVec,_g._LookMatrix,s),0))}static _TokenizeSegment(e,t){_g._BestMatch=0,_g._Score=m.P.Dot(e,t[0]),_g._BestScore=_g._Score;for(let i=1;i<t.length;++i)_g._Score=m.P.Dot(e,t[i]),_g._Score>_g._BestScore&&(_g._BestMatch=i,_g._BestScore=_g._Score);return _g._BestMatch}}_g._ForwardDir=new m.P,_g._InverseFromVec=new m.P,_g._UpDir=new m.P,_g._FromToVec=new m.P,_g._LookMatrix=new m.y3;class gg{static Generate(e=64,t=256,i=.1,s=.001,r=[]){const n=new gg(e);for(let t=0;t<e;++t)n.chars[t]=new m.P(Math.random()-.5,Math.random()-.5,Math.random()-.5),n.chars[t].normalize();for(let e=0;e<r.length;++e)n.chars[e].copyFrom(r[e]);let o,a;const h=new m.P,l=new m.P;for(let e=0;e<t;++e){o=(1-(c=e/(t-1)))*i+c*s;for(let e=r.length;e<n.chars.length;++e)h.copyFromFloats(0,0,0),n.chars.forEach((t=>{n.chars[e].subtractToRef(t,l),a=l.lengthSquared(),a>1e-6&&l.scaleAndAddToRef(1/(l.lengthSquared()*a),h)})),h.scaleInPlace(o),n.chars[e].addInPlace(h),n.chars[e].normalize()}var c;return n}serialize(){return JSON.stringify(this.chars)}static Deserialize(e){const t=JSON.parse(e),i=new gg(t.length);for(let e=0;e<t.length;++e)i.chars[e]=new m.P(t[e]._x,t[e]._y,t[e]._z);return i}constructor(e){this.chars=new Array(e)}}class mg{serialize(){return JSON.stringify(this._sequences.map((e=>e.serialize())))}static Deserialize(e,t){const i=new mg;return i._sequences=JSON.parse(e).map((e=>ng.Sequence.Deserialize(e,t))),i}static CreateFromTrajectory(e,t,i){return mg.CreateFromTokenizationPyramid(mg._GetTokenizationPyramid(e,t),i)}static CreateFromTokenizationPyramid(e,t){const i=new mg;return i._sequences=e.map((e=>new ng.Sequence(e,t))),i}constructor(){this._sequences=[]}static _GetTokenizationPyramid(e,t,i=mg._FINEST_DESCRIPTOR_RESOLUTION){const s=[];for(let r=i;r>4;r=Math.floor(r/2))s.push(e.resampleAtTargetResolution(r).tokenize(t.chars));return s}distance(e){let t,i=0;for(let s=0;s<this._sequences.length;++s)t=Math.pow(2,s),i+=t*this._sequences[s].distance(e._sequences[s]);return i}}mg._FINEST_DESCRIPTOR_RESOLUTION=32;class fg{serialize(){const e={};return e.descriptors=this._descriptors.map((e=>e.serialize())),e.centroidIdx=this._centroidIdx,e.averageDistance=this._averageDistance,JSON.stringify(e)}static Deserialize(e,t){const i=JSON.parse(e),s=new fg;return s._descriptors=i.descriptors.map((e=>mg.Deserialize(e,t))),s._centroidIdx=i.centroidIdx,s._averageDistance=i.averageDistance,s}constructor(e=[]){this._descriptors=e,this._centroidIdx=-1,this._averageDistance=0,this._refreshDescription()}add(e){this._descriptors.push(e),this._refreshDescription()}getMatchCost(e){return e.distance(this._descriptors[this._centroidIdx])/this._averageDistance}getMatchMinimumDistance(e){return Math.min(...this._descriptors.map((t=>t.distance(e))))}_refreshDescription(){let e;this._centroidIdx=-1;const t=this._descriptors.map((t=>(e=0,this._descriptors.forEach((i=>{e+=t.distance(i)})),e)));for(let e=0;e<t.length;++e)(this._centroidIdx<0||t[e]<t[this._centroidIdx])&&(this._centroidIdx=e);this._averageDistance=0,this._descriptors.forEach((e=>{this._averageDistance+=e.distance(this._descriptors[this._centroidIdx])})),this._descriptors.length>0&&(this._averageDistance=Math.max(this._averageDistance/this._descriptors.length,fg._MIN_AVERAGE_DISTANCE))}}fg._MIN_AVERAGE_DISTANCE=1;class bg{serialize(){const e={};return e.maximumAllowableMatchCost=this._maximumAllowableMatchCost,e.vector3Alphabet=this._vector3Alphabet.serialize(),e.levenshteinAlphabet=this._levenshteinAlphabet.serialize(),e.nameToDescribedTrajectory=[],this._nameToDescribedTrajectory.forEach(((t,i)=>{e.nameToDescribedTrajectory.push(i),e.nameToDescribedTrajectory.push(t.serialize())})),JSON.stringify(e)}static Deserialize(e){const t=JSON.parse(e),i=new bg;i._maximumAllowableMatchCost=t.maximumAllowableMatchCost,i._vector3Alphabet=gg.Deserialize(t.vector3Alphabet),i._levenshteinAlphabet=ng.Alphabet.Deserialize(t.levenshteinAlphabet);for(let e=0;e<t.nameToDescribedTrajectory.length;e+=2)i._nameToDescribedTrajectory.set(t.nameToDescribedTrajectory[e],fg.Deserialize(t.nameToDescribedTrajectory[e+1],i._levenshteinAlphabet));return i}static Generate(){const e=gg.Generate(64,256,.1,.001,[m.P.Forward()]),t=new Array(e.chars.length);for(let e=0;e<t.length;++e)t[e]=e;const i=new ng.Alphabet(t,(e=>0===e?0:1),(e=>0===e?0:1),((t,i)=>Math.min(1-m.P.Dot(e.chars[t],e.chars[i]),1))),s=new bg;return s._vector3Alphabet=e,s._levenshteinAlphabet=i,s}constructor(){this._maximumAllowableMatchCost=4,this._nameToDescribedTrajectory=new Map}addTrajectoryToClassification(e,t){this._nameToDescribedTrajectory.has(t)||this._nameToDescribedTrajectory.set(t,new fg),this._nameToDescribedTrajectory.get(t).add(mg.CreateFromTrajectory(e,this._vector3Alphabet,this._levenshteinAlphabet))}deleteClassification(e){return this._nameToDescribedTrajectory.delete(e)}classifyTrajectory(e){const t=mg.CreateFromTrajectory(e,this._vector3Alphabet,this._levenshteinAlphabet),i=[];if(this._nameToDescribedTrajectory.forEach(((e,s)=>{e.getMatchCost(t)<this._maximumAllowableMatchCost&&i.push(s)})),0===i.length)return null;let s,r=0,n=this._nameToDescribedTrajectory.get(i[r]).getMatchMinimumDistance(t);for(let e=0;e<i.length;++e)s=this._nameToDescribedTrajectory.get(i[e]).getMatchMinimumDistance(t),s<n&&(n=s,r=e);return i[r]}}var vg=i(60689),yg=i(56711);class xg{constructor(e,t,i){this._scene=e,p.Y.Log(`[Reflector] Connecting to ws://${t}:${i}`),this._webSocket=new WebSocket(`ws://${t}:${i}`),this._webSocket.onmessage=e=>{const t=e.data;if(t.startsWith(xg._SERVER_PREFIX)){const e=t.substr(xg._SERVER_PREFIX.length);return p.Y.Log(`[Reflector] Received server message: ${e.substr(0,64)}`),void this._handleServerMessage(e)}p.Y.Log(`[Reflector] Received client message: ${t.substr(0,64)}`),this._handleClientMessage()},this._webSocket.onclose=e=>{p.Y.Log(`[Reflector] Disconnected ${e.code} ${e.reason}`)}}close(){this._webSocket.close()}_handleServerMessage(e){"connected"===e&&H_.K.SerializeAsync(this._scene).then((e=>{this._webSocket.send(`load|${JSON.stringify(e)}`)}))}_handleClientMessage(){}}xg._SERVER_PREFIX="$$";class Pg{constructor(e){this._observer=null,this._currentState=[],this.onPressureChanged=new _.y$,Pg.IsAvailable&&(this._observer=new PressureObserver((e=>{this._currentState=e,this.onPressureChanged.notifyObservers(e)}),e))}static get IsAvailable(){return"undefined"!=typeof PressureObserver&&PressureObserver.supportedSources.includes("cpu")}observe(e){var t;try{null===(t=this._observer)||void 0===t||t.observe(e),this.onPressureChanged.notifyObservers(this._currentState)}catch(e){}}unobserve(e){var t;try{null===(t=this._observer)||void 0===t||t.unobserve(e)}catch(e){}}dispose(){var e;null===(e=this._observer)||void 0===e||e.disconnect(),this._observer=null,this.onPressureChanged.clear()}}var Cg=i(83593);const Tg=()=>{};class Sg{static FpsStrategy(){return e=>{const t=e.getEngine();return{id:"FPS",getData:()=>t.getFps(),dispose:Tg}}}static ThermalStrategy(){return this._PressureStrategy("Thermal utilization","thermal")}static PowerSupplyStrategy(){return this._PressureStrategy("Power supply utilization","power-supply")}static PressureStrategy(){return this._PressureStrategy("Pressure")}static _PressureStrategy(e,t=null){return()=>{let i=0;const s=new Pg;return s.observe("cpu"),s.onPressureChanged.add((e=>{for(const s of e)if(t&&s.factors.includes(t)||!t&&0===s.factors.length)switch(s.state){case"nominal":i=0;break;case"fair":i=.25;break;case"serious":i=.5;break;case"critical":i=1}})),{id:e,getData:()=>i,dispose:()=>s.dispose()}}}static TotalMeshesStrategy(){return e=>({id:"Total meshes",getData:()=>e.meshes.length,dispose:Tg})}static ActiveMeshesStrategy(){return e=>({id:"Active meshes",getData:()=>e.getActiveMeshes().length,dispose:Tg})}static ActiveIndicesStrategy(){return e=>({id:"Active indices",getData:()=>e.getActiveIndices(),dispose:Tg})}static ActiveFacesStrategy(){return e=>({id:"Active faces",getData:()=>e.getActiveIndices()/3,dispose:Tg})}static ActiveBonesStrategy(){return e=>({id:"Active bones",getData:()=>e.getActiveBones(),dispose:Tg})}static ActiveParticlesStrategy(){return e=>({id:"Active particles",getData:()=>e.getActiveParticles(),dispose:Tg})}static DrawCallsStrategy(){return e=>{let t=0;const i=e.onBeforeAnimationsObservable.add((()=>{e.getEngine()._drawCalls.fetchNewFrame()})),s=e.onAfterRenderObservable.add((()=>{t=e.getEngine()._drawCalls.current}));return{id:"Draw calls",getData:()=>t,dispose:()=>{e.onBeforeAnimationsObservable.remove(i),e.onAfterRenderObservable.remove(s)}}}}static TotalLightsStrategy(){return e=>({id:"Total lights",getData:()=>e.lights.length,dispose:Tg})}static TotalVerticesStrategy(){return e=>({id:"Total vertices",getData:()=>e.getTotalVertices(),dispose:Tg})}static TotalMaterialsStrategy(){return e=>({id:"Total materials",getData:()=>e.materials.length,dispose:Tg})}static TotalTexturesStrategy(){return e=>({id:"Total textures",getData:()=>e.textures.length,dispose:Tg})}static AbsoluteFpsStrategy(){return e=>{const t=new Vr(e);return t.captureFrameTime=!0,{id:"Absolute FPS",getData:()=>1e3/t.frameTimeCounter.lastSecAverage,dispose:Tg}}}static MeshesSelectionStrategy(){return e=>{let t=G.F.Now,i=0;const s=e.onBeforeActiveMeshesEvaluationObservable.add((()=>{t=G.F.Now})),r=e.onAfterActiveMeshesEvaluationObservable.add((()=>{i=G.F.Now-t}));return{id:"Meshes Selection",getData:()=>i,dispose:()=>{e.onBeforeActiveMeshesEvaluationObservable.remove(s),e.onAfterActiveMeshesEvaluationObservable.remove(r)}}}}static RenderTargetsStrategy(){return e=>{let t=G.F.Now,i=0;const s=e.onBeforeRenderTargetsRenderObservable.add((()=>{t=G.F.Now})),r=e.onAfterRenderTargetsRenderObservable.add((()=>{i=G.F.Now-t}));return{id:"Render Targets",getData:()=>i,dispose:()=>{e.onBeforeRenderTargetsRenderObservable.remove(s),e.onAfterRenderTargetsRenderObservable.remove(r)}}}}static ParticlesStrategy(){return e=>{let t=G.F.Now,i=0;const s=e.onBeforeParticlesRenderingObservable.add((()=>{t=G.F.Now})),r=e.onAfterParticlesRenderingObservable.add((()=>{i=G.F.Now-t}));return{id:"Particles",getData:()=>i,dispose:()=>{e.onBeforeParticlesRenderingObservable.remove(s),e.onAfterParticlesRenderingObservable.remove(r)}}}}static SpritesStrategy(){return e=>{var t,i;let s=G.F.Now,r=0;const n=null===(t=e.onBeforeSpritesRenderingObservable)||void 0===t?void 0:t.add((()=>{s=G.F.Now})),o=null===(i=e.onAfterSpritesRenderingObservable)||void 0===i?void 0:i.add((()=>{r=G.F.Now-s}));return{id:"Sprites",getData:()=>r,dispose:()=>{var t,i;null===(t=e.onBeforeSpritesRenderingObservable)||void 0===t||t.remove(n),null===(i=e.onAfterSpritesRenderingObservable)||void 0===i||i.remove(o)}}}}static AnimationsStrategy(){return e=>{let t=G.F.Now,i=0;const s=e.onBeforeAnimationsObservable.add((()=>{t=G.F.Now})),r=e.onAfterAnimationsObservable.add((()=>{i=G.F.Now-t}));return{id:"Animations",getData:()=>i,dispose:()=>{e.onBeforeAnimationsObservable.remove(s),e.onAfterAnimationsObservable.remove(r)}}}}static PhysicsStrategy(){return e=>{var t,i;let s=G.F.Now,r=0;const n=null===(t=e.onBeforePhysicsObservable)||void 0===t?void 0:t.add((()=>{s=G.F.Now})),o=null===(i=e.onAfterPhysicsObservable)||void 0===i?void 0:i.add((()=>{r=G.F.Now-s}));return{id:"Physics",getData:()=>r,dispose:()=>{var t,i;null===(t=e.onBeforePhysicsObservable)||void 0===t||t.remove(n),null===(i=e.onAfterPhysicsObservable)||void 0===i||i.remove(o)}}}}static RenderStrategy(){return e=>{let t=G.F.Now,i=0;const s=e.onBeforeDrawPhaseObservable.add((()=>{t=G.F.Now})),r=e.onAfterDrawPhaseObservable.add((()=>{i=G.F.Now-t}));return{id:"Render",getData:()=>i,dispose:()=>{e.onBeforeDrawPhaseObservable.remove(s),e.onAfterDrawPhaseObservable.remove(r)}}}}static FrameTotalStrategy(){return e=>{let t=G.F.Now,i=0;const s=e.onBeforeAnimationsObservable.add((()=>{t=G.F.Now})),r=e.onAfterRenderObservable.add((()=>{i=G.F.Now-t}));return{id:"Frame Total",getData:()=>i,dispose:()=>{e.onBeforeAnimationsObservable.remove(s),e.onAfterRenderObservable.remove(r)}}}}static InterFrameStrategy(){return e=>{let t=G.F.Now,i=0;const s=e.onBeforeAnimationsObservable.add((()=>{i=G.F.Now-t})),r=e.onAfterRenderObservable.add((()=>{t=G.F.Now}));return{id:"Inter-frame",getData:()=>i,dispose:()=>{e.onBeforeAnimationsObservable.remove(s),e.onAfterRenderObservable.remove(r)}}}}static GpuFrameTimeStrategy(){return e=>{const t=new Lr(e.getEngine());return t.captureGPUFrameTime=!0,{id:"GPU frame time",getData:()=>Math.max(1e-6*t.gpuFrameTimeCounter.current,0),dispose:()=>{t.dispose()}}}}}var Eg=i(77307),Rg=(i(1302),i(51902)),Mg=(i(28778),i(13295)),Ag=i(33005),Ig=i(93924),Og=i(63217);class wg extends Sr.F{constructor(e,t={}){super(e),this.options=t,this._direction=new m.P(0,0,-1),this._mat=new m.y3,this._onSelectEnabled=!1,this._origin=new m.P(0,0,0),this.lastNativeXRHitResults=[],this.onHitTestResultObservable=new _.y$,this._onHitTestResults=e=>{const t=e.map((e=>{const t=m.y3.FromArray(e.hitMatrix);return this._xrSessionManager.scene.useRightHandedSystem||t.toggleModelMatrixHandInPlace(),this.options.worldParentNode&&t.multiplyToRef(this.options.worldParentNode.getWorldMatrix(),t),{xrHitResult:e,transformationMatrix:t}}));this.lastNativeXRHitResults=e,this.onHitTestResultObservable.notifyObservers(t)},this._onSelect=e=>{this._onSelectEnabled&&wg.XRHitTestWithSelectEvent(e,this._xrSessionManager.referenceSpace)},this.xrNativeFeatureName="hit-test",w.w1.Warn("A newer version of this plugin is available")}static XRHitTestWithRay(e,t,i,s){return e.requestHitTest(t,i).then((e=>{const t=s||(e=>!!e.hitMatrix);return e.filter(t)}))}static XRHitTestWithSelectEvent(e,t){const i=e.frame.getPose(e.inputSource.targetRaySpace,t);if(!i)return Promise.resolve([]);const s=new XRRay(i.transform);return this.XRHitTestWithRay(e.frame.session,s,t)}attach(){return!!super.attach()&&(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0)}detach(){return!!super.detach()&&(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!this.attached||this.options.testOnPointerDownOnly)return;const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;m.y3.FromArrayToRef(t.transform.matrix,0,this._mat),m.P.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),m.P.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();const i=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});wg.XRHitTestWithRay(this._xrSessionManager.session,i,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}}wg.Name=Tr.b.HIT_TEST,wg.Version=1,Tr.d.AddWebXRFeature(wg.Name,((e,t)=>()=>new wg(e,t)),wg.Version,!1);let Dg=0;class Bg extends Sr.F{set referenceSpaceForFrameAnchors(e){this._referenceSpaceForFrameAnchors=e}constructor(e,t={}){super(e),this._options=t,this._lastFrameDetected=new Set,this._trackedAnchors=[],this._futureAnchors=[],this.onAnchorAddedObservable=new _.y$,this.onAnchorRemovedObservable=new _.y$,this.onAnchorUpdatedObservable=new _.y$,this._tmpVector=new m.P,this._tmpQuaternion=new m._f,this.xrNativeFeatureName="anchors"}_populateTmpTransformation(e,t){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(t),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}}async addAnchorPointUsingHitTestResultAsync(e,t=new m.P,i=new m._f){this._populateTmpTransformation(t,i);const s=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w});if(!e.xrHitResult.createAnchor)throw this.detach(),new Error("Anchors not enabled in this environment/browser");try{const t=await e.xrHitResult.createAnchor(s);return new Promise(((e,i)=>{this._futureAnchors.push({nativeAnchor:t,resolved:!1,submitted:!0,xrTransformation:s,resolve:e,reject:i})}))}catch(e){throw new Error(e)}}async addAnchorAtPositionAndRotationAsync(e,t=new m._f,i=!1){this._populateTmpTransformation(e,t);const s=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),r=i&&this.attached&&this._xrSessionManager.currentFrame?await this._createAnchorAtTransformation(s,this._xrSessionManager.currentFrame):void 0;return new Promise(((e,t)=>{this._futureAnchors.push({nativeAnchor:r,resolved:!1,submitted:!1,xrTransformation:s,resolve:e,reject:t})}))}get anchors(){return this._trackedAnchors}detach(){if(!super.detach())return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){const e=this._trackedAnchors.pop();if(e){try{e.remove()}catch(e){}this.onAnchorRemovedObservable.notifyObservers(e)}}return!0}dispose(){this._futureAnchors.length=0,super.dispose(),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()}_onXRFrame(e){if(!this.attached||!e)return;const t=e.trackedAnchors;if(t){const i=this._trackedAnchors.filter((e=>!t.has(e.xrAnchor))).map((e=>this._trackedAnchors.indexOf(e)));let s=0;i.forEach((e=>{const t=this._trackedAnchors.splice(e-s,1)[0];this.onAnchorRemovedObservable.notifyObservers(t),s++})),t.forEach((t=>{if(this._lastFrameDetected.has(t)){const i=this._findIndexInAnchorArray(t),s=this._trackedAnchors[i];try{this._updateAnchorWithXRFrame(t,s,e),s.attachedNode&&(s.attachedNode.rotationQuaternion=s.attachedNode.rotationQuaternion||new m._f,s.transformationMatrix.decompose(s.attachedNode.scaling,s.attachedNode.rotationQuaternion,s.attachedNode.position)),this.onAnchorUpdatedObservable.notifyObservers(s)}catch(e){w.w1.Warn("Anchor could not be updated")}}else{const i={id:Dg++,xrAnchor:t,remove:()=>t.delete()},s=this._updateAnchorWithXRFrame(t,i,e);this._trackedAnchors.push(s),this.onAnchorAddedObservable.notifyObservers(s);const r=this._futureAnchors.filter((e=>e.nativeAnchor===t))[0];r&&(r.resolve(s),r.resolved=!0)}})),this._lastFrameDetected=t}this._futureAnchors.forEach((t=>{t.resolved||t.submitted||(this._createAnchorAtTransformation(t.xrTransformation,e).then((e=>{t.nativeAnchor=e}),(e=>{t.resolved=!0,t.reject(e)})),t.submitted=!0)}))}_findIndexInAnchorArray(e){for(let t=0;t<this._trackedAnchors.length;++t)if(this._trackedAnchors[t].xrAnchor===e)return t;return-1}_updateAnchorWithXRFrame(e,t,i){const s=i.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(s){const e=t.transformationMatrix||new m.y3;m.y3.FromArrayToRef(s.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}return t}async _createAnchorAtTransformation(e,t){var i;if(!t.createAnchor)throw this.detach(),new Error("Anchors are not enabled in your browser");try{return t.createAnchor(e,null!==(i=this._referenceSpaceForFrameAnchors)&&void 0!==i?i:this._xrSessionManager.referenceSpace)}catch(e){throw new Error(e)}}}Bg.Name=Tr.b.ANCHOR_SYSTEM,Bg.Version=1,Tr.d.AddWebXRFeature(Bg.Name,((e,t)=>()=>new Bg(e,t)),Bg.Version);let Ng=0;class Fg extends Sr.F{constructor(e,t={}){super(e),this._options=t,this._detectedPlanes=[],this._enabled=!1,this._lastFrameDetected=new Set,this.onPlaneAddedObservable=new _.y$,this.onPlaneRemovedObservable=new _.y$,this.onPlaneUpdatedObservable=new _.y$,this.xrNativeFeatureName="plane-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){if(!super.detach())return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){const e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0}dispose(){super.dispose(),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()}isCompatible(){return"undefined"!=typeof XRPlane}_onXRFrame(e){var t;if(!this.attached||!this._enabled||!e)return;const i=e.detectedPlanes||(null===(t=e.worldInformation)||void 0===t?void 0:t.detectedPlanes);if(i){for(let e=0;e<this._detectedPlanes.length;e++){const t=this._detectedPlanes[e];i.has(t.xrPlane)||(this._detectedPlanes.splice(e--,1),this.onPlaneRemovedObservable.notifyObservers(t))}i.forEach((t=>{if(this._lastFrameDetected.has(t)){if(t.lastChangedTime===this._xrSessionManager.currentTimestamp){const i=this._findIndexInPlaneArray(t),s=this._detectedPlanes[i];this._updatePlaneWithXRPlane(t,s,e),this.onPlaneUpdatedObservable.notifyObservers(s)}}else{const i={id:Ng++,xrPlane:t,polygonDefinition:[]},s=this._updatePlaneWithXRPlane(t,i,e);this._detectedPlanes.push(s),this.onPlaneAddedObservable.notifyObservers(s)}})),this._lastFrameDetected=i}}_init(){const e=()=>{this._enabled=!0,this._detectedPlanes.length&&(this._detectedPlanes.length=0)};this._xrSessionManager.isNative&&this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),this._xrSessionManager.session.updateWorldTrackingState?(this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),e()):e()}_updatePlaneWithXRPlane(e,t,i){t.polygonDefinition=e.polygon.map((e=>{const t=this._xrSessionManager.scene.useRightHandedSystem?1:-1;return new m.P(e.x,e.y,e.z*t)}));const s=i.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(s){const e=t.transformationMatrix||new m.y3;m.y3.FromArrayToRef(s.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}return t}_findIndexInPlaneArray(e){for(let t=0;t<this._detectedPlanes.length;++t)if(this._detectedPlanes[t].xrPlane===e)return t;return-1}}Fg.Name=Tr.b.PLANE_DETECTION,Fg.Version=1,Tr.d.AddWebXRFeature(Fg.Name,((e,t)=>()=>new Fg(e,t)),Fg.Version);class Lg extends Sr.F{constructor(e,t={}){super(e),this.options=t,this.onBackgroundStateChangedObservable=new _.y$}attach(){return this._setBackgroundState(!1),super.attach()}detach(){return this._setBackgroundState(!0),super.detach()}dispose(){super.dispose(),this.onBackgroundStateChangedObservable.clear()}_onXRFrame(e){}_setBackgroundState(e){const t=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){const i=t.getMeshByName("BackgroundSkybox");i&&i.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){const i=t.getMeshByName("BackgroundPlane");i&&i.setEnabled(e)}}else{const i=t.getMeshByName("BackgroundHelper");i&&i.setEnabled(e)}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach((t=>t.setEnabled(e))),this.onBackgroundStateChangedObservable.notifyObservers(e)}}Lg.Name=Tr.b.BACKGROUND_REMOVER,Lg.Version=1,Tr.d.AddWebXRFeature(Lg.Name,((e,t)=>()=>new Lg(e,t)),Lg.Version,!0);class Vg{}class kg extends Sr.F{_createPhysicsImpostor(e){const t=this._options.physicsProperties.impostorType||pi.Q.SphereImpostor,i=this._options.physicsProperties.impostorSize||.1,s=(0,di.Qk)("impostor-mesh-"+e.uniqueId,{diameterX:"number"==typeof i?i:i.width,diameterY:"number"==typeof i?i:i.height,diameterZ:"number"==typeof i?i:i.depth});s.isVisible=this._debugMode,s.isPickable=!1,s.rotationQuaternion=new m._f;const r=e.grip||e.pointer;s.position.copyFrom(r.position),s.rotationQuaternion.copyFrom(r.rotationQuaternion);const n=new pi.Q(s,t,Object.assign({mass:0},this._options.physicsProperties));this._controllers[e.uniqueId]={xrController:e,impostor:n,impostorMesh:s}}constructor(e,t){super(e),this._options=t,this._attachController=e=>{this._controllers[e.uniqueId]||(this._xrSessionManager.scene.isPhysicsEnabled()||p.Y.Warn("physics engine not enabled, skipped. Please add this controller manually."),this._options.physicsProperties.useControllerMesh&&e.inputSource.gamepad?e.onMotionControllerInitObservable.addOnce((t=>{t._doNotLoadControllerMesh?this._createPhysicsImpostor(e):t.onModelLoadedObservable.addOnce((()=>{const i=new pi.Q(t.rootMesh,pi.Q.MeshImpostor,Object.assign({mass:0},this._options.physicsProperties)),s=e.grip||e.pointer;this._controllers[e.uniqueId]={xrController:e,impostor:i,oldPos:s.position.clone(),oldRotation:s.rotationQuaternion.clone()}}))})):this._createPhysicsImpostor(e))},this._controllers={},this._debugMode=!1,this._delta=0,this._lastTimestamp=0,this._tmpQuaternion=new m._f,this._tmpVector=new m.P,this._options.physicsProperties||(this._options.physicsProperties={})}_enablePhysicsDebug(){this._debugMode=!0,Object.keys(this._controllers).forEach((e=>{const t=this._controllers[e];t.impostorMesh&&(t.impostorMesh.isVisible=!0)}))}addController(e){this._attachController(e)}attach(){if(!super.attach())return!1;if(!this._options.xrInput)return!0;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._options.enableHeadsetImpostor){const e=this._options.headsetImpostorParams||{impostorType:pi.Q.SphereImpostor,restitution:.8,impostorSize:.3},t=e.impostorSize||.3;this._headsetMesh=(0,di.Qk)("headset-mesh",{diameterX:"number"==typeof t?t:t.width,diameterY:"number"==typeof t?t:t.height,diameterZ:"number"==typeof t?t:t.depth}),this._headsetMesh.rotationQuaternion=new m._f,this._headsetMesh.isVisible=!1,this._headsetImpostor=new pi.Q(this._headsetMesh,e.impostorType,Object.assign({mass:0},e))}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._headsetMesh&&this._headsetMesh.dispose(),!0)}getHeadsetImpostor(){return this._headsetImpostor}getImpostorForController(e){const t="string"==typeof e?e:e.uniqueId;return this._controllers[t]?this._controllers[t].impostor:null}setPhysicsProperties(e){this._options.physicsProperties=Object.assign(Object.assign({},this._options.physicsProperties),e)}_onXRFrame(e){var t,i;if(this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&this._headsetImpostor){if(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.globalPosition),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.absoluteRotation),null===(t=this._options.xrInput.xrCamera._lastXRViewerPose)||void 0===t?void 0:t.linearVelocity){const e=this._options.xrInput.xrCamera._lastXRViewerPose.linearVelocity;this._tmpVector.set(e.x,e.y,e.z),this._headsetImpostor.setLinearVelocity(this._tmpVector)}if(null===(i=this._options.xrInput.xrCamera._lastXRViewerPose)||void 0===i?void 0:i.angularVelocity){const e=this._options.xrInput.xrCamera._lastXRViewerPose.angularVelocity;this._tmpVector.set(e.x,e.y,e.z),this._headsetImpostor.setAngularVelocity(this._tmpVector)}}Object.keys(this._controllers).forEach((e=>{var t,i;const s=this._controllers[e],r=s.xrController.grip||s.xrController.pointer,n=s.oldPos||s.impostorMesh.position;if(null===(t=s.xrController._lastXRPose)||void 0===t?void 0:t.linearVelocity){const e=s.xrController._lastXRPose.linearVelocity;this._tmpVector.set(e.x,e.y,e.z),s.impostor.setLinearVelocity(this._tmpVector)}else r.position.subtractToRef(n,this._tmpVector),this._tmpVector.scaleInPlace(1e3/this._delta),s.impostor.setLinearVelocity(this._tmpVector);n.copyFrom(r.position),this._debugMode&&console.log(this._tmpVector,"linear");const o=s.oldRotation||s.impostorMesh.rotationQuaternion;if(null===(i=s.xrController._lastXRPose)||void 0===i?void 0:i.angularVelocity){const e=s.xrController._lastXRPose.angularVelocity;this._tmpVector.set(e.x,e.y,e.z),s.impostor.setAngularVelocity(this._tmpVector)}else if(!o.equalsWithEpsilon(r.rotationQuaternion)){o.conjugateInPlace().multiplyToRef(r.rotationQuaternion,this._tmpQuaternion);const e=Math.sqrt(this._tmpQuaternion.x*this._tmpQuaternion.x+this._tmpQuaternion.y*this._tmpQuaternion.y+this._tmpQuaternion.z*this._tmpQuaternion.z);if(this._tmpVector.set(this._tmpQuaternion.x,this._tmpQuaternion.y,this._tmpQuaternion.z),e<.001)this._tmpVector.scaleInPlace(2);else{const t=2*Math.atan2(e,this._tmpQuaternion.w);this._tmpVector.scaleInPlace(t/(e*(this._delta/1e3)))}s.impostor.setAngularVelocity(this._tmpVector)}o.copyFrom(r.rotationQuaternion),this._debugMode&&console.log(this._tmpVector,this._tmpQuaternion,"angular")}))}_detachController(e){const t=this._controllers[e];t&&(t.impostorMesh&&t.impostorMesh.dispose(),delete this._controllers[e])}}kg.Name=Tr.b.PHYSICS_CONTROLLERS,kg.Version=1,Tr.d.AddWebXRFeature(kg.Name,((e,t)=>()=>new kg(e,t)),kg.Version,!0);class zg extends Sr.F{constructor(e,t={}){super(e),this.options=t,this._tmpMat=new m.y3,this._tmpPos=new m.P,this._tmpQuat=new m._f,this._initHitTestSource=e=>{if(!e)return;const t=new XRRay(this.options.offsetRay||{}),i={space:this.options.useReferenceSpace?e:this._xrSessionManager.viewerReferenceSpace,offsetRay:t};this.options.entityTypes&&(i.entityTypes=this.options.entityTypes),i.space?this._xrSessionManager.session.requestHitTestSource(i).then((e=>{this._xrHitTestSource&&this._xrHitTestSource.cancel(),this._xrHitTestSource=e})):w.w1.Warn("waiting for viewer reference space to initialize")},this.autoCloneTransformation=!1,this.onHitTestResultObservable=new _.y$,this.paused=!1,this.xrNativeFeatureName="hit-test",w.w1.Warn("Hit test is an experimental and unstable feature.")}attach(){if(!super.attach())return!1;if(!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this._initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this._initHitTestSource)),this.options.enableTransientHitTest){const e=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:this.options.transientHitTestProfile||"generic-touchscreen",offsetRay:e,entityTypes:this.options.entityTypes}).then((e=>{this._transientXrHitTestSource=e}))}return!0}detach(){return!!super.detach()&&(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this._initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(this.attached&&!this.paused){if(this._xrHitTestSource){const t=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(t)}this._transientXrHitTestSource&&e.getHitTestResultsForTransientInput(this._transientXrHitTestSource).forEach((e=>{this._processWebXRHitTestResult(e.results,e.inputSource)}))}}_processWebXRHitTestResult(e,t){const i=[];e.forEach((e=>{const s=e.getPose(this._xrSessionManager.referenceSpace);if(!s)return;const r=s.transform.position,n=s.transform.orientation;this._tmpPos.set(r.x,r.y,r.z),this._tmpQuat.set(n.x,n.y,n.z,n.w),m.y3.FromFloat32ArrayToRefScaled(s.transform.matrix,0,1,this._tmpMat),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpPos.z*=-1,this._tmpQuat.z*=-1,this._tmpQuat.w*=-1,this._tmpMat.toggleModelMatrixHandInPlace());const o={position:this.autoCloneTransformation?this._tmpPos.clone():this._tmpPos,rotationQuaternion:this.autoCloneTransformation?this._tmpQuat.clone():this._tmpQuat,transformationMatrix:this.autoCloneTransformation?this._tmpMat.clone():this._tmpMat,inputSource:t,isTransient:!!t,xrHitResult:e};i.push(o)})),this.onHitTestResultObservable.notifyObservers(i)}}zg.Name=Tr.b.HIT_TEST,zg.Version=2,Tr.d.AddWebXRFeature(zg.Name,((e,t)=>()=>new zg(e,t)),zg.Version,!1);class Gg extends Sr.F{get featurePointCloud(){return this._featurePointCloud}constructor(e){super(e),this._enabled=!1,this._featurePointCloud=[],this.onFeaturePointsAddedObservable=new _.y$,this.onFeaturePointsUpdatedObservable=new _.y$,this.xrNativeFeatureName="bjsfeature-points",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){return!!super.detach()&&(this.featurePointCloud.length=0,!0)}dispose(){super.dispose(),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;const t=e.featurePointCloud;if(t&&0!==t.length){if(t.length%5!=0)throw new Error("Received malformed feature point cloud of length: "+t.length);const e=t.length/5,i=new Array,s=new Array;for(let r=0;r<e;r++){const e=5*r,n=t[e+4];this._featurePointCloud[n]?i.push(n):(this._featurePointCloud[n]={position:new m.P,confidenceValue:0},s.push(n)),this._featurePointCloud[n].position.x=t[e],this._featurePointCloud[n].position.y=t[e+1],this._featurePointCloud[n].position.z=t[e+2],this._featurePointCloud[n].confidenceValue=t[e+3]}s.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(s),i.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(i)}}_init(){this._xrSessionManager.session.trySetFeaturePointCloudEnabled&&this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)&&(this._enabled=!0)}}Gg.Name=Tr.b.FEATURE_POINTS,Gg.Version=1,Tr.d.AddWebXRFeature(Gg.Name,(e=>()=>new Gg(e)),Gg.Version);var Ug=i(96985);let Wg=0;class Hg extends Sr.F{constructor(e,t={}){super(e),this._options=t,this._detectedMeshes=new Map,this.onMeshAddedObservable=new _.y$,this.onMeshRemovedObservable=new _.y$,this.onMeshUpdatedObservable=new _.y$,this.xrNativeFeatureName="mesh-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){return!!super.detach()&&(this._xrSessionManager.isNative&&this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach((e=>{this.onMeshRemovedObservable.notifyObservers(e)})),this._detectedMeshes.clear()),!0)}dispose(){super.dispose(),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()}_onXRFrame(e){var t;try{if(!this.attached||!e)return;const i=null===(t=e.worldInformation)||void 0===t?void 0:t.detectedMeshes;if(i){const t=new Set;this._detectedMeshes.forEach(((e,s)=>{i.has(s)||t.add(s)})),t.forEach((e=>{const t=this._detectedMeshes.get(e);t&&(this.onMeshRemovedObservable.notifyObservers(t),this._detectedMeshes.delete(e))})),i.forEach((t=>{if(this._detectedMeshes.has(t)){if(t.lastChangedTime===this._xrSessionManager.currentTimestamp){const i=this._detectedMeshes.get(t);i&&(this._updateVertexDataWithXRMesh(t,i,e),this.onMeshUpdatedObservable.notifyObservers(i))}}else{const i={id:Wg++,xrMesh:t},s=this._updateVertexDataWithXRMesh(t,i,e);this._detectedMeshes.set(t,s),this.onMeshAddedObservable.notifyObservers(s)}}))}}catch(e){console.log(e.stack)}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))}_updateVertexDataWithXRMesh(e,t,i){if(t.xrMesh=e,t.worldParentNode=this._options.worldParentNode,this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)t.positions=e.positions,t.normals=e.normals;else{t.positions=new Float32Array(e.positions.length);for(let i=0;i<e.positions.length;i+=3)t.positions[i]=e.positions[i],t.positions[i+1]=e.positions[i+1],t.positions[i+2]=-1*e.positions[i+2];if(e.normals){t.normals=new Float32Array(e.normals.length);for(let i=0;i<e.normals.length;i+=3)t.normals[i]=e.normals[i],t.normals[i+1]=e.normals[i+1],t.normals[i+2]=-1*e.normals[i+2]}}t.indices=e.indices;const s=i.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(s){const e=t.transformationMatrix||new Zs.y3;Zs.y3.FromArrayToRef(s.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}}return t}}var jg;Hg.Name=Tr.b.MESH_DETECTION,Hg.Version=1,Tr.d.AddWebXRFeature(Hg.Name,((e,t)=>()=>new Hg(e,t)),Hg.Version,!1),function(e){e[e.NotReceived=0]="NotReceived",e[e.Waiting=1]="Waiting",e[e.Received=2]="Received"}(jg||(jg={}));class $g extends Sr.F{constructor(e,t){super(e),this.options=t,this.onUntrackableImageFoundObservable=new _.y$,this.onTrackableImageFoundObservable=new _.y$,this.onTrackedImageUpdatedObservable=new _.y$,this._trackableScoreStatus=jg.NotReceived,this._trackedImages=[],this.xrNativeFeatureName="image-tracking"}attach(){return super.attach()}detach(){return super.detach()}getTrackedImageById(e){return this._trackedImages[e]||null}dispose(){super.dispose(),this._trackedImages.forEach((e=>{e.originalBitmap.close()})),this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()}async getXRSessionInitExtension(){if(!this.options.images||!this.options.images.length)return{};const e=this.options.images.map((e=>"string"==typeof e.src?this._xrSessionManager.scene.getEngine()._createImageBitmapFromSource(e.src):Promise.resolve(e.src)));try{const t=await Promise.all(e);return this._originalTrackingRequest=t.map(((e,t)=>({image:e,widthInMeters:this.options.images[t].estimatedRealWorldWidth}))),{trackedImages:this._originalTrackingRequest}}catch(e){return w.w1.Error("Error loading images for tracking, WebXRImageTracking disabled for this session."),{}}}_onXRFrame(e){if(!e.getImageTrackingResults||this._trackableScoreStatus===jg.Waiting)return;if(this._trackableScoreStatus===jg.NotReceived)return void this._checkScoresAsync();const t=e.getImageTrackingResults();for(const i of t){let t=!1;const s=i.index,r=this._trackedImages[s];if(!r)continue;r.xrTrackingResult=i,r.realWorldWidth!==i.measuredWidthInMeters&&(r.realWorldWidth=i.measuredWidthInMeters,t=!0);const n=e.getPose(i.imageSpace,this._xrSessionManager.referenceSpace);if(n){const e=r.transformationMatrix;m.y3.FromArrayToRef(n.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t=!0}const o="emulated"===i.trackingState;r.emulated!==o&&(r.emulated=o,t=!0),t&&this.onTrackedImageUpdatedObservable.notifyObservers(r)}}async _checkScoresAsync(){if(!this._xrSessionManager.session.getTrackedImageScores||this._trackableScoreStatus!==jg.NotReceived)return;this._trackableScoreStatus=jg.Waiting;const e=await this._xrSessionManager.session.getTrackedImageScores();if(e&&0!==e.length){for(let t=0;t<e.length;++t)if("untrackable"==e[t])this.onUntrackableImageFoundObservable.notifyObservers(t);else{const e=this._originalTrackingRequest[t].image,i={id:t,originalBitmap:e,transformationMatrix:new m.y3,ratio:e.width/e.height};this._trackedImages[t]=i,this.onTrackableImageFoundObservable.notifyObservers(i)}this._trackableScoreStatus=e.length>0?jg.Received:jg.NotReceived}else this._trackableScoreStatus=jg.NotReceived}}$g.Name=Tr.b.IMAGE_TRACKING,$g.Version=1,Tr.d.AddWebXRFeature($g.Name,((e,t)=>()=>new $g(e,t)),$g.Version,!1);class Yg extends Sr.F{constructor(e,t){super(e),this.options=t,this._domOverlayType=null,this._beforeXRSelectListener=null,this._element=null,this.xrNativeFeatureName="dom-overlay",w.w1.Warn("dom-overlay is an experimental and unstable feature.")}attach(){return!(!super.attach()||!this._xrSessionManager.session.domOverlayState||null===this._xrSessionManager.session.domOverlayState.type||(this._domOverlayType=this._xrSessionManager.session.domOverlayState.type,null!==this._element&&!0===this.options.supressXRSelectEvents&&(this._beforeXRSelectListener=e=>{e.preventDefault()},this._element.addEventListener("beforexrselect",this._beforeXRSelectListener)),0))}get domOverlayType(){return this._domOverlayType}dispose(){super.dispose(),null!==this._element&&this._beforeXRSelectListener&&this._element.removeEventListener("beforexrselect",this._beforeXRSelectListener)}_onXRFrame(e){}async getXRSessionInitExtension(){if(void 0===this.options.element)return w.w1.Warn('"element" option must be provided to attach xr-dom-overlay feature.'),{};if("string"==typeof this.options.element){const e=document.querySelector(this.options.element);if(null===e)return w.w1.Warn(`element not found '${this.options.element}' (not requesting xr-dom-overlay)`),{};this._element=e}else this._element=this.options.element;return{domOverlay:{root:this._element}}}}Yg.Name=Tr.b.DOM_OVERLAY,Yg.Version=1,Tr.d.AddWebXRFeature(Yg.Name,((e,t)=>()=>new Yg(e,t)),Yg.Version,!1);var Xg=i(48715);class Qg extends Sr.F{get movementDirection(){return this._movementDirection}get movementEnabled(){return this._featureContext.movementEnabled}set movementEnabled(e){this._featureContext.movementEnabled=e}get movementOrientationFollowsViewerPose(){return this._featureContext.movementOrientationFollowsViewerPose}set movementOrientationFollowsViewerPose(e){this._featureContext.movementOrientationFollowsViewerPose=e}get movementSpeed(){return this._featureContext.movementSpeed}set movementSpeed(e){this._featureContext.movementSpeed=e}get movementThreshold(){return this._featureContext.movementThreshold}set movementThreshold(e){this._featureContext.movementThreshold=e}get rotationEnabled(){return this._featureContext.rotationEnabled}set rotationEnabled(e){this._featureContext.rotationEnabled=e}get rotationSpeed(){return this._featureContext.rotationSpeed}set rotationSpeed(e){this._featureContext.rotationSpeed=e}get rotationThreshold(){return this._featureContext.rotationThreshold}set rotationThreshold(e){this._featureContext.rotationThreshold=e}constructor(e,t){var i,s,r,n,o,a;super(e),this._controllers={},this._currentRegistrationConfigurations=[],this._movementDirection=new m._f,this._tmpRotationMatrix=m.y3.Identity(),this._tmpTranslationDirection=new m.P,this._tmpMovementTranslation=new m.P,this._tempCacheQuaternion=new m._f,this._attachController=e=>{if(this._controllers[e.uniqueId])return;this._controllers[e.uniqueId]={xrController:e,registeredComponents:[]};const t=this._controllers[e.uniqueId];if("tracked-pointer"===t.xrController.inputSource.targetRayMode&&t.xrController.inputSource.gamepad){const i=()=>{if(e.motionController)for(const i of this._currentRegistrationConfigurations){let s=null;if(i.allowedComponentTypes)for(const t of i.allowedComponentTypes){const i=e.motionController.getComponentOfType(t);if(null!==i){s=i;break}}if(i.mainComponentOnly){const t=e.motionController.getMainComponent();if(null===t)continue;s=t}if("function"==typeof i.componentSelectionPredicate&&(s=i.componentSelectionPredicate(e)),s&&i.forceHandedness&&e.inputSource.handedness!==i.forceHandedness)continue;if(null===s)continue;const r={registrationConfiguration:i,component:s};t.registeredComponents.push(r),"axisChangedHandler"in i&&(r.onAxisChangedObserver=s.onAxisValueChangedObservable.add((e=>{i.axisChangedHandler(e,this._movementState,this._featureContext,this._xrInput)}))),"buttonChangedhandler"in i&&(r.onButtonChangedObserver=s.onButtonStateChangedObservable.add((()=>{s.changes.pressed&&i.buttonChangedhandler(s.changes.pressed,this._movementState,this._featureContext,this._xrInput)})))}};e.motionController?i():e.onMotionControllerInitObservable.addOnce((()=>{i()}))}},t&&void 0!==t.xrInput?(Array.isArray(t.customRegistrationConfigurations)?this._currentRegistrationConfigurations=t.customRegistrationConfigurations:this._currentRegistrationConfigurations=Qg.REGISTRATIONS.default,this._featureContext={movementEnabled:t.movementEnabled||!0,movementOrientationFollowsViewerPose:null===(i=t.movementOrientationFollowsViewerPose)||void 0===i||i,movementSpeed:null!==(s=t.movementSpeed)&&void 0!==s?s:1,movementThreshold:null!==(r=t.movementThreshold)&&void 0!==r?r:.25,rotationEnabled:null===(n=t.rotationEnabled)||void 0===n||n,rotationSpeed:null!==(o=t.rotationSpeed)&&void 0!==o?o:1,rotationThreshold:null!==(a=t.rotationThreshold)&&void 0!==a?a:.25},this._movementState={moveX:0,moveY:0,rotateX:0,rotateY:0},this._xrInput=t.xrInput):w.w1.Error('WebXRControllerMovement feature requires "xrInput" option.')}attach(){return!!super.attach()&&(this._xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._controllers={},!0)}_onXRFrame(e){if(this.attached){if(0!==this._movementState.rotateX&&this._featureContext.rotationEnabled){const e=.001*this._xrSessionManager.scene.getEngine().getDeltaTime()*this._featureContext.rotationSpeed*this._movementState.rotateX*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this._featureContext.movementOrientationFollowsViewerPose?(this._xrInput.xrCamera.cameraRotation.y+=e,m._f.RotationYawPitchRollToRef(e,0,0,this._tempCacheQuaternion),this._xrInput.xrCamera.rotationQuaternion.multiplyToRef(this._tempCacheQuaternion,this._movementDirection)):(m._f.RotationYawPitchRollToRef(3*e,0,0,this._tempCacheQuaternion),this._movementDirection.multiplyInPlace(this._tempCacheQuaternion))}else this._featureContext.movementOrientationFollowsViewerPose&&this._movementDirection.copyFrom(this._xrInput.xrCamera.rotationQuaternion);(this._movementState.moveX||this._movementState.moveY)&&this._featureContext.movementEnabled&&(m.y3.FromQuaternionToRef(this._movementDirection,this._tmpRotationMatrix),this._tmpTranslationDirection.set(this._movementState.moveX,0,this._movementState.moveY*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),m.P.TransformCoordinatesToRef(this._tmpTranslationDirection,this._tmpRotationMatrix,this._tmpMovementTranslation),this._tmpMovementTranslation.scaleInPlace(this._xrInput.xrCamera._computeLocalCameraSpeed()*this._featureContext.movementSpeed),this._xrInput.xrCamera.cameraDirection.addInPlace(this._tmpMovementTranslation))}}_detachController(e){const t=this._controllers[e];if(t){for(const e of t.registeredComponents)e.onAxisChangedObserver&&e.component.onAxisValueChangedObservable.remove(e.onAxisChangedObserver),e.onButtonChangedObserver&&e.component.onButtonStateChangedObservable.remove(e.onButtonChangedObserver);delete this._controllers[e]}}}Qg.Name=Tr.b.MOVEMENT,Qg.REGISTRATIONS={default:[{allowedComponentTypes:[Xg.n.THUMBSTICK_TYPE,Xg.n.TOUCHPAD_TYPE],forceHandedness:"left",axisChangedHandler:(e,t,i)=>{t.rotateX=Math.abs(e.x)>i.rotationThreshold?e.x:0,t.rotateY=Math.abs(e.y)>i.rotationThreshold?e.y:0}},{allowedComponentTypes:[Xg.n.THUMBSTICK_TYPE,Xg.n.TOUCHPAD_TYPE],forceHandedness:"right",axisChangedHandler:(e,t,i)=>{t.moveX=Math.abs(e.x)>i.movementThreshold?e.x:0,t.moveY=Math.abs(e.y)>i.movementThreshold?e.y:0}}]},Qg.Version=1,Tr.d.AddWebXRFeature(Qg.Name,((e,t)=>()=>new Qg(e,t)),Qg.Version,!0);var qg=i(87026);class Kg extends Sr.F{constructor(e,t){super(e),this.options=t,this._canvasContext=null,this._reflectionCubeMap=null,this._xrLightEstimate=null,this._xrLightProbe=null,this._xrWebGLBinding=null,this._lightDirection=m.P.Up().negateInPlace(),this._lightColor=g.Wo.White(),this._intensity=1,this._sphericalHarmonics=new rr._,this._cubeMapPollTime=Date.now(),this._lightEstimationPollTime=Date.now(),this._reflectionCubeMapTextureSize=16,this.directionalLight=null,this.onReflectionCubeMapUpdatedObservable=new _.y$,this._updateReflectionCubeMap=()=>{var e;if(!this._xrLightProbe)return;if(this.options.cubeMapPollInterval){const e=Date.now();if(e-this._cubeMapPollTime<this.options.cubeMapPollInterval)return;this._cubeMapPollTime=e}const t=this._getXRGLBinding().getReflectionCubeMap(this._xrLightProbe);if(t&&this._reflectionCubeMap){if(this._reflectionCubeMap._texture)null===(e=this._reflectionCubeMap._texture._hardwareTexture)||void 0===e||e.set(t),this._reflectionCubeMap._texture.getEngine().resetTextureCache();else{const e=new Oi.l(this._xrSessionManager.scene.getEngine(),Oi.S.Unknown);e.isCube=!0,e.invertY=!1,e._useSRGBBuffer="srgba8"===this.options.reflectionFormat,e.format=5,e.generateMipMaps=!0,e.type="srgba8"!==this.options.reflectionFormat?2:0,e.samplingMode=3,e.width=this._reflectionCubeMapTextureSize,e.height=this._reflectionCubeMapTextureSize,e._cachedWrapU=1,e._cachedWrapV=1,e._hardwareTexture=new hs.B(t,this._getCanvasContext()),this._reflectionCubeMap._texture=e}this._reflectionCubeMap._texture.isReady=!0,this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap)}},this.xrNativeFeatureName="light-estimation",this.options.createDirectionalLightSource&&(this.directionalLight=new $s.O("light estimation directional",this._lightDirection,this._xrSessionManager.scene),this.directionalLight.position=new m.P(0,8,0),this.directionalLight.intensity=0,this.directionalLight.falloffType=qg.m.FALLOFF_GLTF),w.w1.Warn("light-estimation is an experimental and unstable feature.")}get reflectionCubeMapTexture(){return this._reflectionCubeMap}get xrLightingEstimate(){return this._xrLightEstimate?{lightColor:this._lightColor,lightDirection:this._lightDirection,lightIntensity:this._intensity,sphericalHarmonics:this._sphericalHarmonics}:this._xrLightEstimate}_getCanvasContext(){return null===this._canvasContext&&(this._canvasContext=this._xrSessionManager.scene.getEngine()._gl),this._canvasContext}_getXRGLBinding(){if(null===this._xrWebGLBinding){const e=this._getCanvasContext();this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,e)}return this._xrWebGLBinding}attach(){var e;if(!super.attach())return!1;const t=null!==(e=this.options.reflectionFormat)&&void 0!==e?e:this._xrSessionManager.session.preferredReflectionFormat||"srgba8";return this.options.reflectionFormat=t,this._xrSessionManager.session.requestLightProbe({reflectionFormat:t}).then((e=>{this._xrLightProbe=e,this.options.disableCubeMapReflection||(this._reflectionCubeMap||(this._reflectionCubeMap=new Xn.V(this._xrSessionManager.scene),this._reflectionCubeMap._isCube=!0,this._reflectionCubeMap.coordinatesMode=3,this.options.setSceneEnvironmentTexture&&(this._xrSessionManager.scene.environmentTexture=this._reflectionCubeMap)),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap))})),!0}detach(){const e=super.detach();return null===this._xrLightProbe||this.options.disableCubeMapReflection||(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._xrLightProbe=null),this._canvasContext=null,this._xrLightEstimate=null,this._xrWebGLBinding=null,e}dispose(){super.dispose(),this.onReflectionCubeMapUpdatedObservable.clear(),this.directionalLight&&(this.directionalLight.dispose(),this.directionalLight=null),null!==this._reflectionCubeMap&&(this._reflectionCubeMap._texture&&this._reflectionCubeMap._texture.dispose(),this._reflectionCubeMap.dispose(),this._reflectionCubeMap=null)}_onXRFrame(e){var t;if(null!==this._xrLightProbe){if(this.options.lightEstimationPollInterval){const e=Date.now();if(e-this._lightEstimationPollTime<this.options.lightEstimationPollInterval)return;this._lightEstimationPollTime=e}if(this._xrLightEstimate=e.getLightEstimate(this._xrLightProbe),this._xrLightEstimate){this._intensity=Math.max(1,this._xrLightEstimate.primaryLightIntensity.x,this._xrLightEstimate.primaryLightIntensity.y,this._xrLightEstimate.primaryLightIntensity.z);const e=this._xrSessionManager.scene.useRightHandedSystem?1:-1;this.options.disableVectorReuse&&(this._lightDirection=new m.P,this._lightColor=new g.Wo,this.directionalLight&&(this.directionalLight.direction=this._lightDirection,this.directionalLight.diffuse=this._lightColor)),this._lightDirection.copyFromFloats(this._xrLightEstimate.primaryLightDirection.x,this._xrLightEstimate.primaryLightDirection.y,this._xrLightEstimate.primaryLightDirection.z*e),this._lightColor.copyFromFloats(this._xrLightEstimate.primaryLightIntensity.x/this._intensity,this._xrLightEstimate.primaryLightIntensity.y/this._intensity,this._xrLightEstimate.primaryLightIntensity.z/this._intensity),this._sphericalHarmonics.updateFromFloatsArray(this._xrLightEstimate.sphericalHarmonicsCoefficients),this._reflectionCubeMap&&!this.options.disableSphericalPolynomial&&(this._reflectionCubeMap.sphericalPolynomial=this._reflectionCubeMap.sphericalPolynomial||new rr.i,null===(t=this._reflectionCubeMap.sphericalPolynomial)||void 0===t||t.updateFromHarmonics(this._sphericalHarmonics)),this._lightDirection.negateInPlace(),this.directionalLight&&(this.directionalLight.direction.copyFrom(this._lightDirection),this.directionalLight.intensity=Math.min(this._intensity,1),this.directionalLight.diffuse.copyFrom(this._lightColor))}}}}Kg.Name=Tr.b.LIGHT_ESTIMATION,Kg.Version=1,Tr.d.AddWebXRFeature(Kg.Name,((e,t)=>()=>new Kg(e,t)),Kg.Version,!1);class Zg extends Sr.F{constructor(e){super(e),this.onEyeTrackingStartedObservable=new _.y$,this.onEyeTrackingEndedObservable=new _.y$,this.onEyeTrackingFrameUpdateObservable=new _.y$,this._eyeTrackingStartListener=e=>{this._latestEyeSpace=e.gazeSpace,this._gazeRay=new At.z(m.P.Zero(),m.P.Forward()),this.onEyeTrackingStartedObservable.notifyObservers(this._gazeRay)},this._eyeTrackingEndListener=()=>{this._latestEyeSpace=null,this._gazeRay=null,this.onEyeTrackingEndedObservable.notifyObservers()},this.xrNativeFeatureName="eye-tracking",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}dispose(){super.dispose(),this._xrSessionManager.session.removeEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.removeEventListener("eyetrackingend",this._eyeTrackingEndListener),this.onEyeTrackingStartedObservable.clear(),this.onEyeTrackingEndedObservable.clear(),this.onEyeTrackingFrameUpdateObservable.clear()}get isEyeGazeValid(){return!!this._gazeRay}getEyeGaze(){return this._gazeRay}_onXRFrame(e){if(this.attached&&e&&this._latestEyeSpace&&this._gazeRay){const t=e.getPose(this._latestEyeSpace,this._xrSessionManager.referenceSpace);if(t){this._gazeRay.origin.set(t.transform.position.x,t.transform.position.y,t.transform.position.z);const e=t.transform.orientation;m.jp.Quaternion[0].set(e.x,e.y,e.z,e.w),this._xrSessionManager.scene.useRightHandedSystem?m.P.RightHandedForwardReadOnly.rotateByQuaternionToRef(m.jp.Quaternion[0],this._gazeRay.direction):(this._gazeRay.origin.z*=-1,m.jp.Quaternion[0].z*=-1,m.jp.Quaternion[0].w*=-1,m.P.LeftHandedForwardReadOnly.rotateByQuaternionToRef(m.jp.Quaternion[0],this._gazeRay.direction)),this.onEyeTrackingFrameUpdateObservable.notifyObservers(this._gazeRay)}}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.addEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.addEventListener("eyetrackingend",this._eyeTrackingEndListener))}}Zg.Name=Tr.b.EYE_TRACKING,Zg.Version=1,Tr.d.AddWebXRFeature(Zg.Name,(e=>()=>new Zg(e)),Zg.Version,!1);class Jg{constructor(e,t){this._samples=[],this._idx=0;for(let i=0;i<e;++i)this._samples.push(t?t():m.FM.Zero())}get length(){return this._samples.length}push(e,t){this._idx=(this._idx+this._samples.length-1)%this._samples.length,this.at(0).copyFromFloats(e,t)}at(e){if(e>=this._samples.length)throw new Error("Index out of bounds");return this._samples[(this._idx+e)%this._samples.length]}}class em{constructor(){this._samples=new Jg(20),this._entropy=0,this.onFirstStepDetected=new _.y$}update(e,t,i,s){this._samples.push(e,t);const r=this._samples.at(0);if(this._entropy*=this._entropyDecayFactor,this._entropy+=m.FM.Distance(r,this._samples.at(1)),this._entropy>this._entropyThreshold)return;let n;for(n=this._samePointCheckStartIdx;n<this._samples.length&&!(m.FM.DistanceSquared(r,this._samples.at(n))<this._samePointSquaredDistanceThreshold);++n);if(n===this._samples.length)return;let o=-1,a=0;for(let e,t=1;t<n;++t)e=m.FM.DistanceSquared(r,this._samples.at(t)),e>o&&(a=t,o=e);if(o<this._apexSquaredDistanceThreshold)return;const h=this._samples.at(a),l=h.subtract(r);l.normalize();const c=m.jp.Vector2[0];let u,d,p=0;for(let e=1;e<n;++e)d=this._samples.at(e),d.subtractToRef(r,c),u=m.FM.Dot(l,c),p+=c.lengthSquared()-u*u;if(p>n*this._squaredProjectionDistanceThreshold)return;const _=m.jp.Vector3[0];_.set(i,s,0);const g=m.jp.Vector3[1];g.set(l.x,l.y,0);const f=m.P.Cross(_,g).z>0,b=r.clone(),v=r.clone();h.subtractToRef(r,l),f?(l.scaleAndAddToRef(this._axisToApexShrinkFactor,b),l.scaleAndAddToRef(this._axisToApexExtendFactor,v)):(l.scaleAndAddToRef(this._axisToApexExtendFactor,b),l.scaleAndAddToRef(this._axisToApexShrinkFactor,v)),this.onFirstStepDetected.notifyObservers({leftApex:b,rightApex:v,currentPosition:r,currentStepDirection:f?"right":"left"})}reset(){for(let e=0;e<this._samples.length;++e)this._samples.at(e).copyFromFloats(0,0)}get _samePointCheckStartIdx(){return Math.floor(this._samples.length/3)}get _samePointSquaredDistanceThreshold(){return 9e-4}get _apexSquaredDistanceThreshold(){return.0081}get _squaredProjectionDistanceThreshold(){return 9e-4}get _axisToApexShrinkFactor(){return.8}get _axisToApexExtendFactor(){return-1.6}get _entropyDecayFactor(){return.93}get _entropyThreshold(){return.4}}class tm{constructor(e,t,i,s){this._leftApex=new m.FM,this._rightApex=new m.FM,this._currentPosition=new m.FM,this._axis=new m.FM,this._axisLength=-1,this._forward=new m.FM,this._steppingLeft=!1,this._t=-1,this._maxT=-1,this._maxTPosition=new m.FM,this._vitality=0,this.onMovement=new _.y$,this.onFootfall=new _.y$,this._reset(e,t,i,"left"===s)}_reset(e,t,i,s){this._leftApex.copyFrom(e),this._rightApex.copyFrom(t),this._steppingLeft=s,this._steppingLeft?(this._leftApex.subtractToRef(this._rightApex,this._axis),this._forward.copyFromFloats(-this._axis.y,this._axis.x)):(this._rightApex.subtractToRef(this._leftApex,this._axis),this._forward.copyFromFloats(this._axis.y,-this._axis.x)),this._axisLength=this._axis.length(),this._forward.scaleInPlace(1/this._axisLength),this._updateTAndVitality(i.x,i.y),this._maxT=this._t,this._maxTPosition.copyFrom(i),this._vitality=1}_updateTAndVitality(e,t){this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._currentPosition.subtractInPlace(this._rightApex):this._currentPosition.subtractInPlace(this._leftApex);const i=this._t,s=m.FM.Dot(this._currentPosition,this._axis);this._t=s/(this._axisLength*this._axisLength);const r=this._currentPosition.lengthSquared()-s/this._axisLength*(s/this._axisLength);this._vitality*=.92-100*Math.max(r-.0016,0)+Math.max(this._t-i,0)}update(e,t){if(this._vitality<this._vitalityThreshold)return!1;const i=this._t;return this._updateTAndVitality(e,t),this._t>this._maxT&&(this._maxT=this._t,this._maxTPosition.copyFromFloats(e,t)),!(this._vitality<this._vitalityThreshold||(this._t>i&&(this.onMovement.notifyObservers({deltaT:this._t-i}),i<.5&&this._t>=.5&&this.onFootfall.notifyObservers({foot:this._steppingLeft?"left":"right"})),this._t<.95*this._maxT&&(this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._leftApex.copyFrom(this._maxTPosition):this._rightApex.copyFrom(this._maxTPosition),this._reset(this._leftApex,this._rightApex,this._currentPosition,!this._steppingLeft)),this._axisLength<.03))}get _vitalityThreshold(){return.1}get forward(){return this._forward}}class im{static get _MillisecondsPerUpdate(){return 1e3/15}constructor(e){this._detector=new em,this._walker=null,this._movement=new m.FM,this._millisecondsSinceLastUpdate=im._MillisecondsPerUpdate,this.movementThisFrame=m.P.Zero(),this._engine=e,this._detector.onFirstStepDetected.add((e=>{this._walker||(this._walker=new tm(e.leftApex,e.rightApex,e.currentPosition,e.currentStepDirection),this._walker.onFootfall.add((()=>{console.log("Footfall!")})),this._walker.onMovement.add((e=>{this._walker.forward.scaleAndAddToRef(.024*e.deltaT,this._movement)})))}))}update(e,t){t.y=0,t.normalize(),this._millisecondsSinceLastUpdate+=this._engine.getDeltaTime(),this._millisecondsSinceLastUpdate>=im._MillisecondsPerUpdate&&(this._millisecondsSinceLastUpdate-=im._MillisecondsPerUpdate,this._detector.update(e.x,e.z,t.x,t.z),this._walker&&(this._walker.update(e.x,e.z)||(this._walker=null)),this._movement.scaleInPlace(.85)),this.movementThisFrame.set(this._movement.x,0,this._movement.y)}}class sm extends Sr.F{static get Name(){return Tr.b.WALKING_LOCOMOTION}static get Version(){return 1}get locomotionTarget(){return this._locomotionTarget}set locomotionTarget(e){this._locomotionTarget=e,this._isLocomotionTargetWebXRCamera="WebXRCamera"===this._locomotionTarget.getClassName()}constructor(e,t){super(e),this._up=new m.P,this._forward=new m.P,this._position=new m.P,this._movement=new m.P,this._sessionManager=e,this.locomotionTarget=t.locomotionTarget,this._isLocomotionTargetWebXRCamera&&p.Y.Warn("Using walking locomotion directly on a WebXRCamera may have unintended interactions with other XR techniques. Using an XR space parent is highly recommended")}isCompatible(){return void 0===this._sessionManager.sessionMode||"immersive-vr"===this._sessionManager.sessionMode}attach(){return!(!this.isCompatible||!super.attach()||(this._walker=new im(this._sessionManager.scene.getEngine()),0))}detach(){return!!super.detach()&&(this._walker=null,!0)}_onXRFrame(e){const t=e.getViewerPose(this._sessionManager.baseReferenceSpace);if(!t)return;const i=this.locomotionTarget.getScene().useRightHandedSystem?1:-1,s=t.transform.matrix;this._up.copyFromFloats(s[4],s[5],i*s[6]),this._forward.copyFromFloats(s[8],s[9],i*s[10]),this._position.copyFromFloats(s[12],s[13],i*s[14]),this._forward.scaleAndAddToRef(.05,this._position),this._up.scaleAndAddToRef(-.05,this._position),this._walker.update(this._position,this._forward),this._movement.copyFrom(this._walker.movementThisFrame),this._isLocomotionTargetWebXRCamera||m.P.TransformNormalToRef(this._movement,this.locomotionTarget.getWorldMatrix(),this._movement),this.locomotionTarget.position.addInPlace(this._movement)}}Tr.d.AddWebXRFeature(sm.Name,((e,t)=>()=>new sm(e,t)),sm.Version,!1);var rm=i(79259),nm=i(33330),om=i(25893);class am extends nm.s{constructor(e,t,i,s,r,n){super(e,t,i,s,n),this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=s,this.isMultiview=r,this.createRTTProvider=n}}class hm extends rm.y{constructor(e,t,i){super(e.scene,i),this._xrSessionManager=e,this._xrWebGLBinding=t,this.layerWrapper=i,this._lastSubImages=new Map,this._compositionLayer=i.layer}_getRenderTargetForSubImage(e,t){var i,s,r,n;const o=this._lastSubImages.get(t),a="left"==t?0:1,h=null!==(i=e.colorTextureWidth)&&void 0!==i?i:e.textureWidth,l=null!==(s=e.colorTextureHeight)&&void 0!==s?s:e.textureHeight;if(!this._renderTargetTextures[a]||(null==o?void 0:o.textureWidth)!==h||(null==o?void 0:o.textureHeight)!==l){let t;const i=null!==(r=e.depthStencilTextureWidth)&&void 0!==r?r:h,s=null!==(n=e.depthStencilTextureHeight)&&void 0!==n?n:l;h!==i&&l!==s||(t=e.depthStencilTexture),this._renderTargetTextures[a]=this._createRenderTargetTexture(h,l,null,e.colorTexture,t,this.layerWrapper.isMultiview),this._framebufferDimensions={framebufferWidth:h,framebufferHeight:l}}return this._lastSubImages.set(t,e),this._renderTargetTextures[a]}_getSubImageForEye(e){const t=this._xrSessionManager.currentFrame;return t?this._xrWebGLBinding.getSubImage(this._compositionLayer,t,e):null}getRenderTargetTextureForEye(e){const t=this._getSubImageForEye(e);return t?this._getRenderTargetForSubImage(t,e):null}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}_setViewportForSubImage(e,t){var i,s;const r=null!==(i=t.colorTextureWidth)&&void 0!==i?i:t.textureWidth,n=null!==(s=t.colorTextureWidth)&&void 0!==s?s:t.textureHeight,o=t.viewport;e.x=o.x/r,e.y=o.y/n,e.width=o.width/r,e.height=o.height/n}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForEye(t.eye);return!!i&&(this._setViewportForSubImage(e,i),!0)}}class lm extends am{constructor(e,t,i){super((()=>e.textureWidth),(()=>e.textureHeight),e,"XRProjectionLayer",t,(e=>new cm(e,i,this))),this.layer=e}}class cm extends hm{constructor(e,t,i){super(e,t,i),this.layerWrapper=i,this._projectionLayer=i.layer}_getSubImageForView(e){return this._xrWebGLBinding.getViewSubImage(this._projectionLayer,e)}getRenderTargetTextureForView(e){return this._getRenderTargetForSubImage(this._getSubImageForView(e),e.eye)}getRenderTargetTextureForEye(e){const t=this._lastSubImages.get(e);return t?this._getRenderTargetForSubImage(t,e):null}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}}const um={},dm={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1};class pm extends Sr.F{constructor(e,t={}){super(e),this._options=t,this._existingLayers=[],this.xrNativeFeatureName="layers"}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this._existingLayers.length=0;const t=Object.assign({},dm),i=this._options.preferMultiviewOnInit&&e.getCaps().multiview;return i&&(t.textureType="texture-array"),this.addXRSessionLayer(this.createProjectionLayer(t,i)),!0}detach(){return!!super.detach()&&(this._existingLayers.length=0,!0)}createXRWebGLLayer(e=um){const t=new XRWebGLLayer(this._xrSessionManager.session,this._glContext,e);return new om.J(t)}createProjectionLayer(e=dm,t=!1){if(t&&"texture-array"!==e.textureType)throw new Error("Projection layers can only be made multiview if they use texture arrays. Set the textureType parameter to 'texture-array'.");if(!t&&"texture-array"===e.textureType)throw new Error("We currently only support multiview rendering when the textureType parameter is set to 'texture-array'.");const i=this._xrWebGLBinding.createProjectionLayer(e);return new lm(i,t,this._xrWebGLBinding)}addXRSessionLayer(e){this.setXRSessionLayers([...this._existingLayers,e])}setXRSessionLayers(e){this._existingLayers=e;const t=Object.assign({},this._xrSessionManager.session.renderState);t.baseLayer=void 0,t.layers=e.map((e=>e.layer)),this._xrSessionManager.updateRenderState(t),this._xrSessionManager._setBaseLayerWrapper(e.length>0?e[0]:null)}isCompatible(){return!this._xrSessionManager.isNative&&"undefined"!=typeof XRWebGLBinding&&!!XRWebGLBinding.prototype.createProjectionLayer}dispose(){super.dispose()}_onXRFrame(e){}}pm.Name=Tr.b.LAYERS,pm.Version=1,Tr.d.AddWebXRFeature(pm.Name,((e,t)=>()=>new pm(e,t)),pm.Version,!1);class _m extends Sr.F{get width(){return this._width}get height(){return this._height}get rawValueToMeters(){return this._rawValueToMeters}get normDepthBufferFromNormView(){return this._normDepthBufferFromNormView}get depthUsage(){switch(this._xrSessionManager.session.depthUsage){case"cpu-optimized":return"cpu";case"gpu-optimized":return"gpu"}}get depthDataFormat(){switch(this._xrSessionManager.session.depthDataFormat){case"luminance-alpha":return"ushort";case"float32":return"float"}}get latestInternalTexture(){var e,t;if(!this._cachedWebGLTexture)return null;const i=this._xrSessionManager.scene.getEngine(),s=new Oi.l(i,Oi.S.Unknown);return s.isCube=!1,s.invertY=!1,s._useSRGBBuffer=!1,s.format="ushort"===this.depthDataFormat?2:5,s.generateMipMaps=!1,s.type="ushort"===this.depthDataFormat?5:1,s.samplingMode=7,s.width=null!==(e=this.width)&&void 0!==e?e:0,s.height=null!==(t=this.height)&&void 0!==t?t:0,s._cachedWrapU=1,s._cachedWrapV=1,s._hardwareTexture=new hs.B(this._cachedWebGLTexture,i._gl),s}get latestDepthBuffer(){return this._cachedDepthBuffer?"ushort"===this.depthDataFormat?new Uint16Array(this._cachedDepthBuffer):new Float32Array(this._cachedDepthBuffer):null}get latestDepthImageTexture(){return this._cachedDepthImageTexture}constructor(e,t){super(e),this.options=t,this._width=null,this._height=null,this._rawValueToMeters=null,this._normDepthBufferFromNormView=null,this._cachedDepthBuffer=null,this._cachedWebGLTexture=null,this._cachedDepthImageTexture=null,this.onGetDepthInMetersAvailable=new _.y$,this.xrNativeFeatureName="depth-sensing",w.w1.Warn("depth-sensing is an experimental and unstable feature.")}attach(e){return!!super.attach(e)&&(null!=this._xrSessionManager.session.depthDataFormat&&null!=this._xrSessionManager.session.depthUsage&&(this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._xrSessionManager.scene.getEngine()._gl),!0))}dispose(){var e;null===(e=this._cachedDepthImageTexture)||void 0===e||e.dispose()}_onXRFrame(e){const t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(null!=i)for(const t of i.views)switch(this.depthUsage){case"cpu":this._updateDepthInformationAndTextureCPUDepthUsage(e,t,this.depthDataFormat);break;case"gpu":if(!this._glBinding)break;this._updateDepthInformationAndTextureWebGLDepthUsage(this._glBinding,t,this.depthDataFormat);break;default:w.w1.Error("Unknown depth usage"),this.detach()}}_updateDepthInformationAndTextureCPUDepthUsage(e,t,i){const s=e.getDepthInformation(t);if(null===s)return;const{data:r,width:n,height:o,rawValueToMeters:a,getDepthInMeters:h}=s;switch(this._width=n,this._height=o,this._rawValueToMeters=a,this._cachedDepthBuffer=r,this.onGetDepthInMetersAvailable.notifyObservers(h.bind(s)),this._cachedDepthImageTexture||(this._cachedDepthImageTexture=Y.l.CreateRTexture(null,n,o,this._xrSessionManager.scene,!1,!0,X.x.NEAREST_SAMPLINGMODE,O.D.TEXTURETYPE_FLOAT)),i){case"ushort":this._cachedDepthImageTexture.update(Float32Array.from(new Uint16Array(r)).map((e=>e*a)));break;case"float":this._cachedDepthImageTexture.update(new Float32Array(r).map((e=>e*a)))}}_updateDepthInformationAndTextureWebGLDepthUsage(e,t,i){const s=e.getDepthInformation(t);if(null===s)return;const{texture:r,width:n,height:o}=s;this._width=n,this._height=o,this._cachedWebGLTexture=r;const a=this._xrSessionManager.scene,h=a.getEngine().wrapWebGLTexture(r);this._cachedDepthImageTexture||(this._cachedDepthImageTexture=Y.l.CreateRTexture(null,n,o,a,!1,!0,X.x.NEAREST_SAMPLINGMODE,"ushort"===i?O.D.TEXTURETYPE_UNSIGNED_BYTE:O.D.TEXTURETYPE_FLOAT)),this._cachedDepthImageTexture._texture=h}getXRSessionInitExtension(){const e=null!=this.options.usagePreference&&0!==this.options.usagePreference.length,t=null!=this.options.dataFormatPreference&&0!==this.options.dataFormatPreference.length;return new Promise((i=>{i(e&&t?{depthSensing:{usagePreference:this.options.usagePreference.map((e=>{switch(e){case"cpu":return"cpu-optimized";case"gpu":return"gpu-optimized"}})),dataFormatPreference:this.options.dataFormatPreference.map((e=>{switch(e){case"ushort":return"luminance-alpha";case"float":return"float32"}}))}}:{})}))}}_m.Name=Tr.b.DEPTH_SENSING,_m.Version=1,Tr.d.AddWebXRFeature(_m.Name,((e,t)=>()=>new _m(e,t)),_m.Version,!1),i(30240),i(45406);class gm extends Ur._{constructor(e,t,i,s=512){super("spacewarp rtt",s,i,!1,!0,2,!1,void 0,!1,!1,!0,void 0,!0),this._originalPairing=[],this._previousWorldMatrices=[],this._previousTransforms=[m.y3.Identity(),m.y3.Identity()],this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight(),e,t),this._renderTarget._disposeOnlyFramebuffers=!0,this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,i&&(this._velocityMaterial=new xi.j("velocity shader material",i,{vertex:"velocity",fragment:"velocity"},{uniforms:["world","previousWorld","viewProjection","viewProjectionR","previousViewProjection","previousViewProjectionR"]}),this._velocityMaterial._materialHelperNeedsPreviousMatrices=!0,this._velocityMaterial.onBindObservable.add((e=>{this._previousWorldMatrices[e.uniqueId]=this._previousWorldMatrices[e.uniqueId]||e.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousWorld",this._previousWorldMatrices[e.uniqueId]),this._previousWorldMatrices[e.uniqueId]=e.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousViewProjection",this._previousTransforms[0]),this._velocityMaterial.getEffect().setMatrix("previousViewProjectionR",this._previousTransforms[1]),this._previousTransforms[0].copyFrom(i.getTransformMatrix()),this._previousTransforms[1].copyFrom(i._transformMatrixR)})),this._velocityMaterial.freeze())}render(e=!1,t=!1){this._originalPairing.length=0;const i=this.getScene();i&&this._velocityMaterial&&i.getActiveMeshes().forEach((e=>{this._originalPairing.push([e,e.material]),e.material=this._velocityMaterial})),super.render(e,t),this._originalPairing.forEach((e=>{e[0].material=e[1]}))}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindSpaceWarpFramebuffer(this._renderTarget)}getViewCount(){return 2}dispose(){super.dispose(),this._velocityMaterial.dispose(),this._previousTransforms.length=0,this._previousWorldMatrices.length=0,this._originalPairing.length=0}}class mm{constructor(e,t,i){this._scene=e,this._xrSessionManager=t,this._xrWebGLBinding=i,this._lastSubImages=new Map,this._renderTargetTextures=new Map,this._engine=e.getEngine()}_getSubImageForView(e){const t=this._xrSessionManager._getBaseLayerWrapper();if(!t)throw new Error("For Space Warp, the base layer should be a WebXR Projection Layer.");if("XRProjectionLayer"!==t.layerType)throw new Error('For Space Warp, the base layer type should "XRProjectionLayer".');const i=t.layer;return this._xrWebGLBinding.getViewSubImage(i,e)}_setViewportForSubImage(e,t){e.x=0,e.y=0,e.width=t.motionVectorTextureWidth,e.height=t.motionVectorTextureHeight}_createRenderTargetTexture(e,t,i,s,r){if(!this._engine)throw new Error("Engine is disposed");const n={width:e,height:t},o=new gm(s,r,this._scene,n),a=o.renderTarget;return i&&(a._framebuffer=i),a._colorTextureArray=s,a._depthStencilTextureArray=r,o.disableRescaling(),o.renderListPredicate=()=>!0,o}_getRenderTargetForSubImage(e,t){const i=this._lastSubImages.get(t);let s=this._renderTargetTextures.get(t.eye);const r=e.motionVectorTextureWidth,n=e.motionVectorTextureHeight;return s&&(null==i?void 0:i.textureWidth)===r&&(null==i?void 0:i.textureHeight)==n||(s=this._createRenderTargetTexture(r,n,null,e.motionVectorTexture,e.depthStencilTexture),this._renderTargetTextures.set(t.eye,s),this._framebufferDimensions={framebufferWidth:r,framebufferHeight:n}),this._lastSubImages.set(t,e),s}trySetViewportForView(e,t){const i=this._lastSubImages.get(t)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}accessMotionVector(e){const t=this._getSubImageForView(e);t&&(t.motionVectorTexture,t.depthStencilTexture)}getRenderTargetTextureForEye(e){return null}getRenderTargetTextureForView(e){const t=this._getSubImageForView(e);return t?this._getRenderTargetForSubImage(t,e):null}dispose(){this._renderTargetTextures.forEach((e=>e.dispose())),this._renderTargetTextures.clear()}}class fm extends Sr.F{constructor(e){super(e),this.dependsOn=[Tr.b.LAYERS],this.xrNativeFeatureName="space-warp",this._xrSessionManager.scene.needsPreviousWorldMatrices=!0}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();return this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this.spaceWarpRTTProvider=new mm(this._xrSessionManager.scene,this._xrSessionManager,this._xrWebGLBinding),this._xrSessionManager.scene.onAfterRenderObservable.add(this._onAfterRender.bind(this)),!0}_onAfterRender(){this.attached&&this._renderTargetTexture&&this._renderTargetTexture.render(!1,!1)}isCompatible(){return this._xrSessionManager.scene.getEngine().getCaps().colorBufferHalfFloat||!1}dispose(){super.dispose()}_onXRFrame(e){const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;const i=t.views[0];this._renderTargetTexture=this._renderTargetTexture||this.spaceWarpRTTProvider.getRenderTargetTextureForView(i),this.spaceWarpRTTProvider.accessMotionVector(i)}}fm.Name=Tr.b.SPACE_WARP,fm.Version=1,Tr.d.AddWebXRFeature(fm.Name,(e=>()=>new fm(e)),fm.Version,!1);var bm=i(52494),vm=i(97540);class ym extends bm.d{constructor(e,t,i){super(e,xm[i],t,i,!0),this.profileId="generic-hand-select-grasp"}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){}_updateModel(){}}vm.V.RegisterController("generic-hand-select-grasp",((e,t)=>new ym(t,e.gamepad,e.handedness)));const xm={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-none",assetPath:"none.glb"}};var Pm=i(93007);class Cm extends bm.d{constructor(e,t,i){super(e,Tm["left-right"],t,i),this._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},this.profileId="microsoft-mixed-reality"}_getFilenameAndPath(){let e="";return e="left"===this.handedness?Cm.MODEL_LEFT_FILENAME:Cm.MODEL_RIGHT_FILENAME,{filename:e,path:Cm.MODEL_BASE_URL+"default/"}}_getModelLoadingConstraints(){const e=Ps.n.IsPluginForExtensionAvailable(".glb");return e||p.Y.Warn("glTF / glb loaded was not registered, using generic controller instead"),e}_processLoadedModel(e){this.rootMesh&&(this.getComponentIds().forEach(((e,t)=>{if(!this.disableAnimation&&e&&this.rootMesh){const i=this._mapping.buttons[e],s=i.rootNodeName;if(!s)return void p.Y.Log("Skipping unknown button at index: "+t+" with mapped name: "+e);const r=this._getChildByName(this.rootMesh,s);if(!r)return void p.Y.Warn("Missing button mesh with name: "+s);if(i.valueMesh=this._getImmediateChildByName(r,this._mapping.defaultButton.valueNodeName),i.pressedMesh=this._getImmediateChildByName(r,this._mapping.defaultButton.pressedNodeName),i.unpressedMesh=this._getImmediateChildByName(r,this._mapping.defaultButton.unpressedNodeName),i.valueMesh&&i.pressedMesh&&i.unpressedMesh){const t=this.getComponent(e);t&&t.onButtonStateChangedObservable.add((e=>{this._lerpTransform(i,e.value)}),void 0,!0)}else p.Y.Warn("Missing button submesh under mesh with name: "+s)}})),this.getComponentIds().forEach((e=>{const t=this.getComponent(e);t.isAxes()&&["x-axis","y-axis"].forEach((i=>{if(!this.rootMesh)return;const s=this._mapping.axes[e][i],r=this._getChildByName(this.rootMesh,s.rootNodeName);r?(s.valueMesh=this._getImmediateChildByName(r,this._mapping.defaultAxis.valueNodeName),s.minMesh=this._getImmediateChildByName(r,this._mapping.defaultAxis.minNodeName),s.maxMesh=this._getImmediateChildByName(r,this._mapping.defaultAxis.maxNodeName),s.valueMesh&&s.minMesh&&s.maxMesh?t&&t.onAxisValueChangedObservable.add((e=>{const t="x-axis"===i?e.x:e.y;this._lerpTransform(s,t,!0)}),void 0,!0):p.Y.Warn("Missing axis submesh under mesh with name: "+s.rootNodeName)):p.Y.Warn("Missing axis mesh with name: "+s.rootNodeName)}))})))}_setRootMesh(e){let t;this.rootMesh=new Mt.Kj(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){const s=e[i];s.isPickable=!1,s.parent||(t=s)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=m._f.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}Cm.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",Cm.MODEL_LEFT_FILENAME="left.glb",Cm.MODEL_RIGHT_FILENAME="right.glb",vm.V.RegisterController("windows-mixed-reality",((e,t)=>new Cm(t,e.gamepad,e.handedness)));const Tm={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}};class Sm extends bm.d{constructor(e,t,i,s=!1,r=!1){super(e,Em[i],t,i),this._forceLegacyControllers=r,this.profileId="oculus-touch"}_getFilenameAndPath(){let e="";return e="left"===this.handedness?Sm.MODEL_LEFT_FILENAME:Sm.MODEL_RIGHT_FILENAME,{filename:e,path:this._isQuest()?Sm.QUEST_MODEL_BASE_URL:Sm.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){const t=this._isQuest(),i="right"===this.handedness?-1:1;this.getComponentIds().forEach((e=>{const s=e&&this.getComponent(e);s&&s.onButtonStateChangedObservable.add((s=>{if(this.rootMesh&&!this.disableAnimation)switch(e){case"xr-standard-trigger":return void(t||(this._modelRootNode.getChildren()[3].rotation.x=.2*-s.value,this._modelRootNode.getChildren()[3].position.y=.005*-s.value,this._modelRootNode.getChildren()[3].position.z=.005*-s.value));case"xr-standard-squeeze":return void(t||(this._modelRootNode.getChildren()[4].position.x=i*s.value*.0035));case"xr-standard-thumbstick":return;case"a-button":case"x-button":return void(t||(s.pressed?this._modelRootNode.getChildren()[1].position.y=-.001:this._modelRootNode.getChildren()[1].position.y=0));case"b-button":case"y-button":return void(t||(s.pressed?this._modelRootNode.getChildren()[2].position.y=-.001:this._modelRootNode.getChildren()[2].position.y=0))}}),void 0,!0)}))}_setRootMesh(e){this.rootMesh=new Mt.Kj(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=m._f.FromEulerAngles(0,Math.PI,0)),e.forEach((e=>{e.isPickable=!1})),this._isQuest()?this._modelRootNode=e[0]:(this._modelRootNode=e[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh}_updateModel(){}_isQuest(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers}}Sm.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",Sm.MODEL_LEFT_FILENAME="left.babylon",Sm.MODEL_RIGHT_FILENAME="right.babylon",Sm.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",vm.V.RegisterController("oculus-touch",((e,t)=>new Sm(t,e.gamepad,e.handedness))),vm.V.RegisterController("oculus-touch-legacy",((e,t)=>new Sm(t,e.gamepad,e.handedness,!0)));const Em={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}};class Rm extends bm.d{constructor(e,t,i){super(e,Mm[i],t,i),this.profileId="htc-vive"}_getFilenameAndPath(){return{filename:Rm.MODEL_FILENAME,path:Rm.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){this.getComponentIds().forEach((e=>{const t=e&&this.getComponent(e);t&&t.onButtonStateChangedObservable.add((t=>{if(this.rootMesh&&!this.disableAnimation)switch(e){case"xr-standard-trigger":return void(this._modelRootNode.getChildren()[6].rotation.x=.15*-t.value);case"xr-standard-touchpad":case"xr-standard-squeeze":return}}),void 0,!0)}))}_setRootMesh(e){this.rootMesh=new Mt.Kj(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.isPickable=!1})),this._modelRootNode=e[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=m._f.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}Rm.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",Rm.MODEL_FILENAME="wand.babylon",vm.V.RegisterController("htc-vive",((e,t)=>new Rm(t,e.gamepad,e.handedness)));const Mm={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}};var Am=i(21994),Im=i(53608);class Om{get session(){return this._nativeImpl.session}constructor(e){this._nativeImpl=e,this._xrTransform=new XRRigidTransform,this._xrPose={transform:this._xrTransform,emulatedPosition:!1},this._xrPoseVectorData=new Float32Array(8),this.fillPoses=this._nativeImpl.fillPoses.bind(this._nativeImpl),this.getViewerPose=this._nativeImpl.getViewerPose.bind(this._nativeImpl),this.getHitTestResults=this._nativeImpl.getHitTestResults.bind(this._nativeImpl),this.getHitTestResultsForTransientInput=()=>{throw new Error("XRFrame.getHitTestResultsForTransientInput not supported on native.")},this.createAnchor=this._nativeImpl.createAnchor.bind(this._nativeImpl),this.getJointPose=this._nativeImpl.getJointPose.bind(this._nativeImpl),this.fillJointRadii=this._nativeImpl.fillJointRadii.bind(this._nativeImpl),this.getLightEstimate=()=>{throw new Error("XRFrame.getLightEstimate not supported on native.")},this.getImageTrackingResults=()=>{var e;return null!==(e=this._nativeImpl._imageTrackingResults)&&void 0!==e?e:[]}}getPose(e,t){if(!this._nativeImpl.getPoseData(e,t,this._xrPoseVectorData.buffer,this._xrTransform.matrix.buffer))return;const i=this._xrTransform.position;i.x=this._xrPoseVectorData[0],i.y=this._xrPoseVectorData[1],i.z=this._xrPoseVectorData[2],i.w=this._xrPoseVectorData[3];const s=this._xrTransform.orientation;return s.x=this._xrPoseVectorData[4],s.y=this._xrPoseVectorData[5],s.z=this._xrPoseVectorData[6],s.w=this._xrPoseVectorData[7],this._xrPose}get trackedAnchors(){return this._nativeImpl.trackedAnchors}get worldInformation(){return this._nativeImpl.worldInformation}get detectedPlanes(){return this._nativeImpl.detectedPlanes}get featurePointCloud(){return this._nativeImpl.featurePointCloud}getDepthInformation(e){throw new Error("This function is not available in Babylon Native")}}is("NativeXRFrame",Om),i(29776);var wm,Dm=i(53027);!function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(wm||(wm={}));class Bm{constructor(e,t,i){this.name=e,this._type=t,this._ownerBlock=i,this._connectedPoint=null}get type(){return this._type}connectTo(e){if(this._type===e._type)throw new Error(`Cannot connect two points of type ${this.type}`);this._connectedPoint=e,e._connectedPoint=this}}class Nm extends Bm{constructor(e,t,i,s){super(e,t,i),this._value=s}set value(e){this._value=e}get value(){return this.type===wm.Output?(this._ownerBlock._updateOutputs(),this._value):this._connectedPoint?this._connectedPoint.value:this._value}}class Fm{constructor(e){this.dataInputs=[],this.dataOutputs=[],this._graph=e,this._graph._addBlock(this)}_updateOutputs(){}_registerDataInput(e,t){const i=new Nm(e,wm.Input,this,t);return this.dataInputs.push(i),i}_registerDataOutput(e,t){const i=new Nm(e,wm.Output,this,t);return this.dataOutputs.push(i),i}}class Lm extends Bm{_activateSignal(){var e;this.type===wm.Input?this._ownerBlock._execute():null===(e=this._connectedPoint)||void 0===e||e._activateSignal()}}class Vm extends Fm{constructor(e){super(e),this._signalInputs=[],this._signalOutputs=[],this.onStart=this._registerSignalInput("onStart")}_registerSignalInput(e){const t=new Lm(e,wm.Input,this);return this._signalInputs.push(t),t}_registerSignalOutput(e){const t=new Lm(e,wm.Output,this);return this._signalOutputs.push(t),t}}class km extends Vm{constructor(e){super(e),this.onDone=this._registerSignalOutput("onDone")}}class zm extends km{_execute(){this.onDone._activateSignal()}}class Gm{constructor(e){this._scene=e,this._blocks=[],this._sceneDisposeObserver=this._scene.onDisposeObservable.add(this.dispose.bind(this))}_addBlock(e){this._blocks.push(e)}findBlockByName(e){return this._blocks.find((t=>t.name===e))}start(){for(const e of this._blocks)e instanceof zm&&e._startListening()}dispose(){for(const e of this._blocks)e instanceof zm&&e._stopListening();this._blocks.length=0,this._scene.onDisposeObservable.remove(this._sceneDisposeObserver),this._sceneDisposeObserver=null}}class Um extends km{constructor(e){super(e),this._currentIndex=0,this._cachedEndIndex=0,this._cachedStep=0,this.startIndex=this._registerDataInput("startIndex",0),this.endIndex=this._registerDataInput("endIndex",0),this.step=this._registerDataInput("step",1),this.index=this._registerDataOutput("index",0),this.onLoop=this._registerSignalOutput("onLoop"),this.onDone=this._registerSignalOutput("onDone")}_executeLoop(){this._currentIndex<this._cachedEndIndex?(this.index.value=this._currentIndex,this.onLoop._activateSignal(),this._currentIndex+=this._cachedStep,this._executeLoop()):this.onDone._activateSignal()}_execute(){this._currentIndex=this.startIndex.value,this._cachedEndIndex=this.endIndex.value,this._cachedStep=this.step.value,this._executeLoop()}}class Wm extends km{constructor(e){super(e),this.message=this._registerDataInput("message","Hello world")}_execute(){const e=this.message.value;console.log(e),this.onDone._activateSignal()}}class Hm extends Fm{constructor(e,t,i,s){super(e),this._binOp=s,this.left=this._registerDataInput("left",t),this.right=this._registerDataInput("right",i),this.output=this._registerDataOutput("output",s(t,i))}_updateOutputs(){this.output.value=this._binOp(this.left.value,this.right.value)}}class jm extends Hm{constructor(e){super(e,0,0,((e,t)=>e+t))}}class $m extends zm{constructor(e,t){super(e),this._meshToPick=t}set meshToPick(e){if(this._meshToPick!==e){const t=!!this._meshPickObserver;t&&this._stopListening(),this._meshToPick=e,t&&this._startListening()}}get meshToPick(){return this._meshToPick}_startListening(){this._meshPickObserver||(this._meshPickObserver=this._meshToPick.getScene().onPointerObservable.add((e=>{var t;e.type===Ct.kD.POINTERPICK&&(null===(t=e.pickInfo)||void 0===t?void 0:t.pickedMesh)===this._meshToPick&&this._execute()})),this._meshDisposeObserver=this._meshToPick.onDisposeObservable.add((()=>this._stopListening())))}_stopListening(){this._meshToPick.getScene().onPointerObservable.remove(this._meshPickObserver),this._meshPickObserver=null,this._meshToPick.onDisposeObservable.remove(this._meshDisposeObserver),this._meshDisposeObserver=null}}class Ym extends zm{constructor(e,t){super(e),this._scene=t}_startListening(){this._sceneReadyObserver||(this._sceneReadyObserver=this._scene.onReadyObservable.add((()=>{this._execute()})))}_stopListening(){this._scene.onReadyObservable.remove(this._sceneReadyObserver),this._sceneReadyObserver=null}}}}]);
//# sourceMappingURL=354.babylonBundle.js.map